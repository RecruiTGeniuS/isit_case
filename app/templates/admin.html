<!DOCTYPE html>
<html lang="ru" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–¢–û–† - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <script>
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º–µ—Ä—Ü–∞–Ω–∏—è (FOUC)
        (function() {
            const savedTheme = localStorage.getItem('theme');
            let theme = savedTheme;
            
            if (!theme) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = 'dark';
                } else {
                    theme = 'light';
                }
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å —Ç–µ–º—ã —Å—Ä–∞–∑—É
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-theme');
            } else {
                document.documentElement.classList.add('light-theme');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞
            const style = document.createElement('style');
            style.textContent = `
                html.dark-theme, html.dark-theme body {
                    background-color: #1b1b1c !important;
                    color: #e0e0e0 !important;
                }
                html.dark-theme .admin-container {
                    background-color: #1b1b1c !important;
                }
            `;
            document.head.appendChild(style);
        })();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="admin-page">
    <div class="admin-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="logo">–£–¢–û–†</h1>
            </div>
            <div class="header-right">
                <div class="user-menu" id="userMenu">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="avatar-container">
                            {% if user.avatar_path %}
                                <img src="{{ url_for('static', filename=user.avatar_path) }}" alt="Avatar" class="user-avatar" id="userAvatar">
                            {% else %}
                                <div class="user-avatar-empty" id="userAvatar">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                        <span class="user-name">{{ user.last_name }} {{ user.first_name[0] }}.{{ user.patronymic[0] }}.</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-avatar-container">
                            {% if user.avatar_path %}
                                <img src="{{ url_for('static', filename=user.avatar_path) }}" alt="Avatar" class="dropdown-avatar" id="dropdownAvatar" onclick="document.getElementById('avatarInput').click()">
                            {% else %}
                                <div class="dropdown-avatar-empty" id="dropdownAvatar" onclick="document.getElementById('avatarInput').click()">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                    <span class="avatar-hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span>
                                </div>
                            {% endif %}
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                        </div>
                        <div class="user-full-name">
                            {{ user.last_name }} {{ user.first_name }} {{ user.patronymic or '' }}
                        </div>
                        <div class="user-details">
                            <div class="detail-item">
                                <span class="detail-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</span>
                                <span class="detail-value">{{ user.post }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">–†–æ–ª—å:</span>
                                <span class="detail-value">{{ get_role_translation(user.role) }}</span>
                            </div>
                        </div>

                        <div class="support-block">
                            <button type="button" class="support-link" id="supportToggle">
                                –ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="support-contacts" id="supportContacts">
                                <div class="support-item">
                                    <span class="support-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                                    <span class="support-value">+7 (800) 123-45-67</span>
                                </div>
                                <div class="support-item">
                                    <span class="support-label">Email</span>
                                    <span class="support-value">support@utor.example</span>
                                </div>
                                <div class="support-item">
                                    <span class="support-label">Telegram</span>
                                    <span class="support-value">@utor_support</span>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="theme-toggle-container">
                            <span class="theme-label">–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</span>
                            <button class="theme-toggle-btn" id="themeSwitch" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                                <svg class="theme-icon sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                                <svg class="theme-icon moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="dropdown-actions">
                            <a href="{{ url_for('auth.logout') }}" class="logout-btn">–í—ã–π—Ç–∏</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="admin-main">
            <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
            <aside class="admin-sidebar">
                <nav class="sidebar-nav">
                    <a href="{{ url_for('admin_employees.list_employees') }}" class="nav-item {% if section == 'employees' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                    </a>
                    <a href="{{ url_for('admin_equipment.list_equipment') }}" class="nav-item {% if section == 'equipment' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="8" rx="2"></rect>
                            <rect x="6" y="6" width="6" height="5" rx="1"></rect>
                            <path d="M12 11V6h5l2 3" />
                            <circle cx="8" cy="19" r="1.5"></circle>
                            <circle cx="16" cy="19" r="1.5"></circle>
                        </svg>
                        <span>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</span>
                    </a>
                    <a href="{{ url_for('admin_warehouse.list_warehouse') }}" class="nav-item {% if section == 'warehouse' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        <span>–°–∫–ª–∞–¥</span>
                    </a>
                    <a href="{{ url_for('admin_pto.list_pto') }}" class="nav-item {% if section == 'pto' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                        <span>–ü–¢–û</span>
                    </a>
                    <a href="{{ url_for('admin_tasks.list_tasks') }}" class="nav-item {% if section == 'tasks' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <span>–ó–∞–¥–∞—á–∏</span>
                    </a>
                    <a href="{{ url_for('admin_statistics.list_statistics') }}" class="nav-item {% if section == 'statistics' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                    </a>
                </nav>
            </aside>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
            <main class="admin-content">
                {% if section == 'employees' %}
                    <div class="content-header">
                        <h2>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="employeeSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="filterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                –§–∏–ª—å—Ç—Ä
                            </button>
                            <div class="filter-dropdown" id="filterDropdown">
                                <div class="filter-group">
                                    <label for="roleFilter">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="roleFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for role in role_options %}
                                                <button type="button" class="filter-option" data-value="{{ role }}">{{ role_labels.get(role) or role }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="roleFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="roleFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for role in role_options %}
                                        <option value="{{ role }}">{{ get_role_translation(role) }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="departmentFilter">–û—Ç–¥–µ–ª</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="departmentFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for dept in department_options %}
                                                <button type="button" class="filter-option" data-value="{{ dept }}">{{ dept }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="departmentFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="departmentFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for dept in department_options %}
                                        <option value="{{ dept }}">{{ dept }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="facilityFilter">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="facilityFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for fac in facility_options %}
                                                <button type="button" class="filter-option" data-value="{{ fac }}">{{ fac }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="facilityFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="facilityFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for fac in facility_options %}
                                        <option value="{{ fac }}">{{ fac }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="sortColumnFilter">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="sortColumnFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</button>
                                                <button type="button" class="filter-option" data-value="1">–§–∞–º–∏–ª–∏—è</button>
                                                <button type="button" class="filter-option" data-value="2">–ò–º—è</button>
                                                <button type="button" class="filter-option" data-value="3">–û—Ç—á–µ—Å—Ç–≤–æ</button>
                                                <button type="button" class="filter-option" data-value="4">–î–æ–ª–∂–Ω–æ—Å—Ç—å</button>
                                                <button type="button" class="filter-option" data-value="6">Email</button>
                                                <button type="button" class="filter-option" data-value="7">–û—Ç–¥–µ–ª</button>
                                                <button type="button" class="filter-option" data-value="8">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</button>
                                                <button type="button" class="filter-option" data-value="9">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</button>
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="sortColumnFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="sortColumnFilter" class="filter-native-select">
                                        <option value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</option>
                                        <option value="1">–§–∞–º–∏–ª–∏—è</option>
                                        <option value="2">–ò–º—è</option>
                                        <option value="3">–û—Ç—á–µ—Å—Ç–≤–æ</option>
                                        <option value="4">–î–æ–ª–∂–Ω–æ—Å—Ç—å</option>
                                        <option value="6">Email</option>
                                        <option value="7">–û—Ç–¥–µ–ª</option>
                                        <option value="8">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                        <option value="9">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="sortDirectionFilter">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="sortDirectionFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>
                                                <button type="button" class="filter-option" data-value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</button>
                                            </div>
                                        </div>
                                    </div>
                                    <select id="sortDirectionFilter" class="filter-native-select">
                                        <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                                        <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="resetFilters">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="number-column">‚Ññ</th>
                                    <th>–§–∞–º–∏–ª–∏—è</th>
                                    <th>–ò–º—è</th>
                                    <th>–û—Ç—á–µ—Å—Ç–≤–æ</th>
                                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>Email</th>
                                    <th>–û—Ç–¥–µ–ª</th>
                                    <th>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</th>
                                    <th>–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</th>
                                    <th>–õ–æ–≥–∏–Ω</th>
                                    <th>–ü–∞—Ä–æ–ª—å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in employees %}
                                <tr data-employee-id="{{ emp.id }}" data-role="{{ emp.role or '' }}" data-department="{{ emp.department or '' }}" data-facility="{{ emp.facility or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="last_name">{{ emp.last_name or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="first_name">{{ emp.first_name or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="patronymic">{{ emp.patronymic or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="post">{{ emp.post or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="phone">{{ format_phone(emp.phone) or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="email">{{ emp.email or '' }}</td>
                                    <td class="department-cell" tabindex="0" data-field="department_id" data-department-id="{{ emp.department_id or '' }}" data-facility-name="{{ emp.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ emp.department or '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="facility-cell" tabindex="0" data-field="facility" data-facility-value="{{ emp.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ emp.facility or '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="role-cell" tabindex="0" data-field="role" data-role-value="{{ emp.role or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ role_labels.get(emp.role) if emp.role else '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="login">{{ emp.login or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="password">{{ emp.password or '' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="tableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addEmployeeBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        </button>
                    </div>
                {% elif section == 'equipment' %}
                    <div class="content-header">
                        <h2>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="equipmentSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="equipmentFilterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                –§–∏–ª—å—Ç—Ä
                            </button>
                            <div class="filter-dropdown" id="equipmentFilterDropdown">
                                <div class="filter-group">
                                    <label for="typeFilter">–¢–∏–ø</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="typeFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for type in type_options %}
                                                <button type="button" class="filter-option" data-value="{{ type }}">{{ type }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="typeFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="typeFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for type in type_options %}
                                        <option value="{{ type }}">{{ type }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="statusFilter">–°—Ç–∞—Ç—É—Å</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="statusFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for status in status_options %}
                                                <button type="button" class="filter-option" data-value="{{ status }}">{{ status }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="statusFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="statusFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for status in status_options %}
                                        <option value="{{ status }}">{{ status }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="locationFilter">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="locationFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for location in location_options %}
                                                <button type="button" class="filter-option" data-value="{{ location }}">{{ location }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="locationFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="locationFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for location in location_options %}
                                        <option value="{{ location }}">{{ location }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="equipmentSortColumnFilter">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="equipmentSortColumnFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</button>
                                                <button type="button" class="filter-option" data-value="1">–ù–∞–∑–≤–∞–Ω–∏–µ</button>
                                                <button type="button" class="filter-option" data-value="2">–¢–∏–ø</button>
                                                <button type="button" class="filter-option" data-value="3">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</button>
                                                <button type="button" class="filter-option" data-value="4">–û—Ç–¥–µ–ª</button>
                                                <button type="button" class="filter-option" data-value="5">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="equipmentSortColumnFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="equipmentSortColumnFilter" class="filter-native-select">
                                        <option value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</option>
                                        <option value="1">–ù–∞–∑–≤–∞–Ω–∏–µ</option>
                                        <option value="2">–¢–∏–ø</option>
                                        <option value="3">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                        <option value="4">–û—Ç–¥–µ–ª</option>
                                        <option value="5">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="equipmentSortDirectionFilter">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="equipmentSortDirectionFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>
                                                <button type="button" class="filter-option" data-value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</button>
                                            </div>
                                        </div>
                                    </div>
                                    <select id="equipmentSortDirectionFilter" class="filter-native-select">
                                        <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                                        <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="resetEquipmentFilters">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="equipmentTable">
                            <thead>
                                <tr>
                                    <th class="number-column">‚Ññ</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</th>
                                    <th>–û—Ç–¥–µ–ª</th>
                                    <th>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment %}
                                <tr data-equipment-id="{{ eq.id }}" data-equipment-assignment-id="{{ eq.equipment_assignment_id or '' }}" data-type="{{ eq.equipment_type or '' }}" data-status="{{ eq.equipment_status or '' }}" data-location="{{ eq.location or '' }}" data-department="{{ eq.department or '' }}" data-facility="{{ eq.facility or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="equipment_name">{{ eq.equipment_name or '' }}</td>
                                    <td class="role-cell" tabindex="0" data-field="equipment_type" data-type-value="{{ eq.equipment_type or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ eq.equipment_type or '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="facility-cell" tabindex="0" data-field="facility" data-facility-value="{{ eq.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ eq.facility or '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="department-cell" tabindex="0" data-field="department_id" data-department-id="{{ eq.department_id or '' }}" data-facility-name="{{ eq.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ eq.department or '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="location">{{ eq.location or '' }}</td>
                                    <td>
                                        {% if eq.equipment_status %}
                                            {% if eq.equipment_status == '–í —Ä–∞–±–æ—Ç–µ' %}
                                            <span class="status-badge status-in-work">{{ eq.equipment_status }}</span>
                                            {% elif eq.equipment_status == '–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ' or eq.equipment_status == '–í —Ä–µ–º–æ–Ω—Ç–µ' %}
                                            <span class="status-badge status-in-repair">{{ eq.equipment_status }}</span>
                                            {% elif eq.equipment_status == '–ù–∞ –ü–¢–û' %}
                                            <span class="status-badge status-in-pto">{{ eq.equipment_status }}</span>
                                            {% else %}
                                            <span class="status-badge">{{ eq.equipment_status }}</span>
                                            {% endif %}
                                        {% else %}
                                        <span class="status-badge">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="equipmentTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addEquipmentBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                        </button>
                    </div>
                {% elif section == 'equipment_passport' %}
                    <div class="content-header">
                        <button type="button" class="back-btn" onclick="window.location.href='{{ url_for('admin_equipment.list_equipment') }}'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            <span class="back-btn-text"></span>
                        </button>
                        <h2>–ü–∞—Å–ø–æ—Ä—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>
                    </div>
                    <div class="equipment-passport-container">
                        <div class="equipment-passport-window">
                            <div class="passport-tabs">
                                <button class="passport-tab active" data-tab="main-info" role="tab" aria-selected="true" aria-controls="tab-panel-main-info">
                                    <span class="tab-icon">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                    </span>
                                    <span class="tab-label">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                                </button>
                                <button class="passport-tab" data-tab="movement-history" role="tab" aria-selected="false" aria-controls="tab-panel-movement-history">
                                    <span class="tab-icon">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                        </svg>
                                    </span>
                                    <span class="tab-label">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π</span>
                                </button>
                                <button class="passport-tab" data-tab="required-parts" role="tab" aria-selected="false" aria-controls="tab-panel-required-parts">
                                    <span class="tab-icon">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="9" cy="21" r="1"></circle>
                                            <circle cx="20" cy="21" r="1"></circle>
                                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                        </svg>
                                    </span>
                                    <span class="tab-label">–°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–µ—Ç–∞–ª–µ–π</span>
                                </button>
                            </div>
                            
                            <div class="passport-content">
                                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                <div class="tab-panel active" id="tab-panel-main-info" role="tabpanel" aria-labelledby="tab-main-info">
                                    <div class="equipment-main-info">
                                        <div class="equipment-image-section">
                                            <div class="equipment-image-container" id="equipmentImageContainer" onclick="document.getElementById('equipmentImageInput').click()">
                                                {% if equipment.image_path %}
                                                    <img src="{{ url_for('static', filename=equipment.image_path) }}" alt="{{ equipment.equipment_name }}" class="equipment-image" id="equipmentImage">
                                                {% else %}
                                                    <div class="equipment-image-placeholder" id="equipmentImagePlaceholder">
                                                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                            <polyline points="21 15 16 10 5 21"></polyline>
                                                        </svg>
                                                        <span>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                                                    </div>
                                                {% endif %}
                                                <div class="equipment-image-overlay">
                                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                        <polyline points="17 8 12 3 7 8"></polyline>
                                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                                    </svg>
                                                    <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                                                </div>
                                            </div>
                                            <input type="file" id="equipmentImageInput" accept="image/*" style="display: none;" data-equipment-id="{{ equipment.id }}">
                                        </div>
                                        <div class="equipment-details-section">
                                            <div class="detail-item">
                                                <span class="detail-label">–ü–æ–ª–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span>
                                                <span class="detail-value">{{ equipment.equipment_name or '‚Äî' }}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</span>
                                                <span class="detail-value">{{ equipment.equipment_type or '‚Äî' }}</span>
                                            </div>
                                            {% if equipment.acquisition_date %}
                                            <div class="detail-item">
                                                <span class="detail-label">–î–∞—Ç–∞ –≤–≤–æ–¥–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é:</span>
                                                <span class="detail-value">{{ format_date(equipment.acquisition_date) or '‚Äî' }}</span>
                                            </div>
                                            {% endif %}
                                            {% if equipment.warranty_expiration %}
                                            <div class="detail-item">
                                                <span class="detail-label">–ò—Å—Ç–µ—á–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏:</span>
                                                <span class="detail-value">{{ format_date(equipment.warranty_expiration) or '‚Äî' }}</span>
                                            </div>
                                            {% endif %}
                                            {% if equipment.maintenance_frequency_text %}
                                            <div class="detail-item">
                                                <span class="detail-label">–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –¢–û:</span>
                                                <span class="detail-value">{{ equipment.maintenance_frequency_text }}</span>
                                            </div>
                                            {% endif %}
                                            {% if equipment.characteristics %}
                                            <div class="detail-item detail-item-full">
                                                <span class="detail-label">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</span>
                                                <div class="detail-value characteristics-text">{{ format_characteristics(equipment.characteristics)|safe }}</div>
                                            </div>
                                            {% endif %}
                                            {% if equipment.location %}
                                            <div class="detail-item">
                                                <span class="detail-label">–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</span>
                                                <span class="detail-value">{{ equipment.location }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π -->
                                <div class="tab-panel" id="tab-panel-movement-history" role="tabpanel" aria-labelledby="tab-movement-history" hidden>
                                    <div class="movement-history-container">
                                        <div class="table-controls">
                                            <div class="search-box">
                                                <input type="text" id="movementHistorySearch" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞">
                                                <button type="button" class="search-button" tabindex="-1">
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="11" cy="11" r="8"></circle>
                                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                </svg>
                                                </button>
                                            </div>
                                            <div class="table-actions">
                                                <button type="button" class="filter-btn" id="movementHistoryFilterToggle" aria-expanded="false" aria-haspopup="true">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                                </svg>
                                                –§–∏–ª—å—Ç—Ä
                                            </button>
                                                <div class="filter-dropdown" id="movementHistoryFilterDropdown">
                                                    <div class="filter-group">
                                                        <label for="movementFromLocationFilter">–û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</label>
                                                        <div class="filter-select-wrapper">
                                                            <div class="filter-select" data-target="movementFromLocationFilter">
                                                                <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                                    <span class="filter-select-label">–í—Å–µ</span>
                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                                    </svg>
                                                                </button>
                                                                <div class="filter-options-list" role="listbox">
                                                                    <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                                    {% for location in from_location_options %}
                                                                    <button type="button" class="filter-option" data-value="{{ location }}">{{ location }}</button>
                                                                    {% endfor %}
                                        </div>
                                                            </div>
                                                            <button type="button" class="filter-reset-btn" data-target="movementFromLocationFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <select id="movementFromLocationFilter" class="filter-native-select">
                                                            <option value="">–í—Å–µ</option>
                                                            {% for location in from_location_options %}
                                                            <option value="{{ location }}">{{ location }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="filter-group">
                                                        <label for="movementToLocationFilter">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</label>
                                                        <div class="filter-select-wrapper">
                                                            <div class="filter-select" data-target="movementToLocationFilter">
                                                                <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                                    <span class="filter-select-label">–í—Å–µ</span>
                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                                    </svg>
                                                                </button>
                                                                <div class="filter-options-list" role="listbox">
                                                                    <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                                    {% for location in to_location_options %}
                                                                    <button type="button" class="filter-option" data-value="{{ location }}">{{ location }}</button>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                            <button type="button" class="filter-reset-btn" data-target="movementToLocationFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <select id="movementToLocationFilter" class="filter-native-select">
                                                            <option value="">–í—Å–µ</option>
                                                            {% for location in to_location_options %}
                                                            <option value="{{ location }}">{{ location }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="filter-group">
                                                        <label for="movementDateFilter">–î–∞—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</label>
                                                <input type="text" id="movementDateFilter" placeholder="–î–∞—Ç–∞" class="filter-input">
                                            </div>
                                                    <div class="filter-group">
                                                        <label for="movementSortColumnFilter">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                                                        <div class="filter-select-wrapper">
                                                            <div class="filter-select" data-target="movementSortColumnFilter">
                                                                <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                                    <span class="filter-select-label">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span>
                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                                    </svg>
                                                                </button>
                                                                <div class="filter-options-list" role="listbox">
                                                                    <button type="button" class="filter-option" data-value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</button>
                                                                    <button type="button" class="filter-option" data-value="from">–û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</button>
                                                                    <button type="button" class="filter-option" data-value="to">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</button>
                                                                    <button type="button" class="filter-option" data-value="date">–î–∞—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</button>
                                            </div>
                                        </div>
                                                            <button type="button" class="filter-reset-btn" data-target="movementSortColumnFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <select id="movementSortColumnFilter" class="filter-native-select">
                                                            <option value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</option>
                                                            <option value="from">–û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</option>
                                                            <option value="to">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</option>
                                                            <option value="date">–î–∞—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</option>
                                                        </select>
                                                    </div>
                                                    <div class="filter-group">
                                                        <label for="movementSortDirectionFilter">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                                                        <div class="filter-select-wrapper">
                                                            <div class="filter-select" data-target="movementSortDirectionFilter">
                                                                <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                                    <span class="filter-select-label">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</span>
                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                                    </svg>
                                                                </button>
                                                                <div class="filter-options-list" role="listbox">
                                                                    <button type="button" class="filter-option" data-value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>
                                                                    <button type="button" class="filter-option" data-value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <select id="movementSortDirectionFilter" class="filter-native-select">
                                                            <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                                                            <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                                        </select>
                                                    </div>
                                                    <button type="button" class="reset-filter-btn" id="resetMovementHistoryFilters">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="movementHistoryTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                                        <div class="table-container">
                                            <table class="data-table" id="movementHistoryTable">
                                                <thead>
                                                    <tr>
                                                        <th class="number-column">‚Ññ</th>
                                                        <th>–û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</th>
                                                        <th>–õ–æ–∫–∞—Ü–∏—è (–æ—Ç–∫—É–¥–∞)</th>
                                                        <th>–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</th>
                                                        <th>–õ–æ–∫–∞—Ü–∏—è (–∫—É–¥–∞)</th>
                                                        <th>–î–∞—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for movement in movement_history %}
                                                    <tr data-movement-id="{{ movement.id }}" 
                                                        data-from-location="{{ movement.from_location }}" 
                                                        data-to-location="{{ movement.to_location }}" 
                                                        data-from-location-detail="{{ movement.from_location_detail or '' }}"
                                                        data-to-location-detail="{{ movement.to_location_detail or '' }}"
                                                        data-from-department-id="{{ movement.from_department_id or '' }}"
                                                        data-to-department-id="{{ movement.to_department_id or '' }}"
                                                        data-move-date="{{ movement.move_date or '' }}">
                                                        <td class="number-column">{{ loop.index }}</td>
                                                        <td class="facility-cell" tabindex="0" data-field="from_department_id" data-department-id="{{ movement.from_department_id or '' }}" data-facility-name="{{ movement.from_facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                                            <div class="role-cell-content">
                                                                <span class="role-cell-label">{{ movement.from_location }}</span>
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                                </svg>
                                                            </div>
                                                        </td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="from_location">{{ movement.from_location_detail or '‚Äî' }}</td>
                                                        <td class="facility-cell" tabindex="0" data-field="to_department_id" data-department-id="{{ movement.to_department_id or '' }}" data-facility-name="{{ movement.to_facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                                            <div class="role-cell-content">
                                                                <span class="role-cell-label">{{ movement.to_location }}</span>
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                                </svg>
                                                            </div>
                                                        </td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="to_location">{{ movement.to_location_detail or '‚Äî' }}</td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="move_date">{{ format_date(movement.move_date) or '‚Äî' }}</td>
                                                    </tr>
                                                    {% else %}
                                                    <tr>
                                                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è—Ö</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="table-footer-actions">
                                            <button type="button" class="add-employee-btn" id="addMovementBtn">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–µ—Ç–∞–ª–µ–π -->
                                <div class="tab-panel" id="tab-panel-required-parts" role="tabpanel" aria-labelledby="tab-required-parts" hidden>
                                    <div class="required-parts-container">
                                        <div class="table-controls">
                                            <div class="search-box">
                                                <input type="text" id="sparePartsSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞">
                                                <button type="button" class="search-button" tabindex="-1">
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="11" cy="11" r="8"></circle>
                                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                            </svg>
                                                </button>
                                        </div>
                                            <div class="table-actions" style="position: relative;">
                                                <button type="button" class="filter-btn" id="sparePartsFilterToggle" aria-expanded="false" aria-haspopup="true">
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                                    </svg>
                                                    –§–∏–ª—å—Ç—Ä
                                                </button>
                                                <div class="filter-dropdown" id="sparePartsFilterDropdown">
                                                    <div class="filter-group">
                                                        <label for="sparePartsTypeFilter">–¢–∏–ø –¥–µ—Ç–∞–ª–∏</label>
                                                        <div class="filter-select-wrapper">
                                                            <div class="filter-select" data-target="sparePartsTypeFilter">
                                                                <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                                    <span class="filter-select-label">–í—Å–µ</span>
                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                                    </svg>
                                                                </button>
                                                                <div class="filter-options-list" role="listbox">
                                                                    <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                                    {% for type in spare_part_types %}
                                                                    <button type="button" class="filter-option" data-value="{{ type }}">{{ type }}</button>
                                                                    {% endfor %}
                                    </div>
                                </div>
                                                            <button type="button" class="filter-reset-btn" data-target="sparePartsTypeFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                </svg>
                                                            </button>
                            </div>
                                                        <select id="sparePartsTypeFilter" class="filter-native-select">
                                                            <option value="">–í—Å–µ</option>
                                                            {% for type in spare_part_types %}
                                                            <option value="{{ type }}">{{ type }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="filter-group">
                                                        <label for="sparePartsSortColumnFilter">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                                                        <div class="filter-select-wrapper">
                                                            <div class="filter-select" data-target="sparePartsSortColumnFilter">
                                                                <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                                    <span class="filter-select-label">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span>
                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                                    </svg>
                                                                </button>
                                                                <div class="filter-options-list" role="listbox">
                                                                    <button type="button" class="filter-option" data-value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</button>
                                                                    <button type="button" class="filter-option" data-value="name">–ù–∞–∑–≤–∞–Ω–∏–µ</button>
                                                                    <button type="button" class="filter-option" data-value="type">–¢–∏–ø</button>
                                                                </div>
                                                            </div>
                                                            <button type="button" class="filter-reset-btn" data-target="sparePartsSortColumnFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <select id="sparePartsSortColumnFilter" class="filter-native-select">
                                                            <option value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</option>
                                                            <option value="name">–ù–∞–∑–≤–∞–Ω–∏–µ</option>
                                                            <option value="type">–¢–∏–ø</option>
                                                        </select>
                                                    </div>
                                                    <div class="filter-group">
                                                        <label for="sparePartsSortDirectionFilter">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                                                        <div class="filter-select-wrapper">
                                                            <div class="filter-select" data-target="sparePartsSortDirectionFilter">
                                                                <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                                    <span class="filter-select-label">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</span>
                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                                    </svg>
                                                                </button>
                                                                <div class="filter-options-list" role="listbox">
                                                                    <button type="button" class="filter-option" data-value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>
                                                                    <button type="button" class="filter-option" data-value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <select id="sparePartsSortDirectionFilter" class="filter-native-select">
                                                            <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                                                            <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                                        </select>
                                                    </div>
                                                    <button type="button" class="reset-filter-btn" id="resetSparePartsFilters">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="sparePartsTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                                        <div class="table-container">
                                            <table class="data-table" id="sparePartsTable">
                                                <thead>
                                                    <tr>
                                                        <th class="number-column">‚Ññ</th>
                                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</th>
                                                        <th>–¢–∏–ø –¥–µ—Ç–∞–ª–∏</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for part in spare_parts %}
                                                    <tr data-spare-part-id="{{ part.id }}" data-part-name="{{ part.name }}" data-part-type="{{ part.type }}">
                                                        <td class="number-column">{{ loop.index }}</td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="name">{{ part.name }}</td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="type">{{ part.type }}</td>
                                                    </tr>
                                                    {% else %}
                                                    <tr>
                                                        <td colspan="3" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –¥–µ—Ç–∞–ª—è—Ö</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="table-footer-actions">
                                            <button type="button" class="add-employee-btn" id="addSparePartBtn">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% elif section == 'warehouse' %}
                    <div class="content-header">
                        <h2>–°–∫–ª–∞–¥ –∑–∞–ø—á–∞—Å—Ç–µ–π</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="warehouseSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="warehouseFilterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                –§–∏–ª—å—Ç—Ä
                            </button>
                            <div class="filter-dropdown" id="warehouseFilterDropdown">
                                <div class="filter-group">
                                    <label for="facilityWarehouseFilter">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="facilityWarehouseFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for fac in facility_options %}
                                                <button type="button" class="filter-option" data-value="{{ fac }}">{{ fac }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="facilityWarehouseFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="facilityWarehouseFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for fac in facility_options %}
                                        <option value="{{ fac }}">{{ fac }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="warehouseAddressFilter">–°–∫–ª–∞–¥</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="warehouseAddressFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for wh in warehouse_options %}
                                                <button type="button" class="filter-option" data-value="{{ wh }}">{{ wh }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="warehouseAddressFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="warehouseAddressFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for wh in warehouse_options %}
                                        <option value="{{ wh }}">{{ wh }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="sparePartFilter">–î–µ—Ç–∞–ª—å</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="sparePartFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–í—Å–µ</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–í—Å–µ</button>
                                                {% for sp in spare_part_options %}
                                                <button type="button" class="filter-option" data-value="{{ sp }}">{{ sp }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="sparePartFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="sparePartFilter" class="filter-native-select">
                                        <option value="">–í—Å–µ</option>
                                        {% for sp in spare_part_options %}
                                        <option value="{{ sp }}">{{ sp }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="warehouseSortColumnFilter">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="warehouseSortColumnFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</button>
                                                <button type="button" class="filter-option" data-value="1">–î–µ—Ç–∞–ª—å</button>
                                                <button type="button" class="filter-option" data-value="2">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</button>
                                                <button type="button" class="filter-option" data-value="3">–°–∫–ª–∞–¥</button>
                                                <button type="button" class="filter-option" data-value="4">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</button>
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="warehouseSortColumnFilter" aria-label="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="warehouseSortColumnFilter" class="filter-native-select">
                                        <option value="">–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</option>
                                        <option value="1">–î–µ—Ç–∞–ª—å</option>
                                        <option value="2">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                        <option value="3">–°–∫–ª–∞–¥</option>
                                        <option value="4">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="warehouseSortDirectionFilter">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="warehouseSortDirectionFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>
                                                <button type="button" class="filter-option" data-value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</button>
                                            </div>
                                        </div>
                                    </div>
                                    <select id="warehouseSortDirectionFilter" class="filter-native-select">
                                        <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                                        <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="warehouseResetFilters">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="number-column">‚Ññ</th>
                                    <th class="warehouse-part-column">–î–µ—Ç–∞–ª—å</th>
                                    <th class="warehouse-type-column">–¢–∏–ø –¥–µ—Ç–∞–ª–∏</th>
                                    <th class="warehouse-facility-column">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</th>
                                    <th class="warehouse-warehouse-column">–°–∫–ª–∞–¥</th>
                                    <th class="warehouse-quantity-column">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part in parts %}
                                <tr data-part-id="{{ part.id }}" data-facility="{{ part.facility_name or '' }}" data-warehouse="{{ part.department_name or '' }}" data-spare-part="{{ part.spare_part_name or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="spare_part_name">{{ part.spare_part_name or '‚Äî' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="spare_part_type">{{ part.spare_part_type or '‚Äî' }}</td>
                                    <td class="facility-cell" tabindex="0" data-field="facility" data-facility-value="{{ part.facility_name or '' }}" data-facility-id="{{ part.facility_id or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ part.facility_name or '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="warehouse-cell" tabindex="0" data-field="warehouse_id" data-warehouse-id="{{ part.warehouse_id or '' }}" data-facility-name="{{ part.facility_name or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ part.department_name or '‚Äî' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="quantity">{{ part.quantity or '‚Äî' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="warehouseTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addPartBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å
                        </button>
                    </div>
                {% elif section == 'pto' %}
                    <div class="content-header">
                        <h2>–ü–¢–û</h2>
                    </div>
                    <div class="pto-container">
                        <div class="pto-calendar-section">
                            <div class="pto-calendar-header">
                                <button type="button" class="pto-month-nav-btn" id="ptoPrevMonth" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg>
                                </button>
                                <div class="pto-month-selector">
                                    <select id="ptoMonthSelect" class="pto-month-select">
                                        <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
                                        <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
                                        <option value="3">–ú–∞—Ä—Ç</option>
                                        <option value="4">–ê–ø—Ä–µ–ª—å</option>
                                        <option value="5">–ú–∞–π</option>
                                        <option value="6">–ò—é–Ω—å</option>
                                        <option value="7">–ò—é–ª—å</option>
                                        <option value="8">–ê–≤–≥—É—Å—Ç</option>
                                        <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
                                        <option value="10">–û–∫—Ç—è–±—Ä—å</option>
                                        <option value="11">–ù–æ—è–±—Ä—å</option>
                                        <option value="12">–î–µ–∫–∞–±—Ä—å</option>
                                    </select>
                                    <select id="ptoYearSelect" class="pto-year-select">
                                    </select>
                                </div>
                                <button type="button" class="pto-month-nav-btn" id="ptoNextMonth" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                            <div class="pto-calendar-wrapper">
                                <div class="pto-calendar-weekdays">
                                    <div class="pto-weekday">–ü–Ω</div>
                                    <div class="pto-weekday">–í—Ç</div>
                                    <div class="pto-weekday">–°—Ä</div>
                                    <div class="pto-weekday">–ß—Ç</div>
                                    <div class="pto-weekday">–ü—Ç</div>
                                    <div class="pto-weekday">–°–±</div>
                                    <div class="pto-weekday">–í—Å</div>
                                </div>
                                <div class="pto-calendar-grid" id="ptoCalendarGrid">
                                    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="pto-table-section">
                            <div class="pto-table-header">
                                <h3 id="ptoTableDate">–°–µ–≥–æ–¥–Ω—è</h3>
                            </div>
                            <div class="pto-table-container">
                                <table class="data-table" id="ptoDataTable">
                                    <thead>
                                        <tr>
                                            <th>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                                            <th>–û—Ç–¥–µ–ª</th>
                                            <th>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ptoTableBody">
                                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% elif section == 'tasks' %}
                    <div class="content-header">
                        <h2>–ó–∞–¥–∞—á–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="tasksSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button type="button" class="filter-btn" id="tasksFilterBtn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                –§–∏–ª—å—Ç—Ä
                            </button>
                            <div class="filter-dropdown" id="tasksFilterDropdown">
                                <div class="filter-group">
                                    <label>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏</label>
                                    <select id="tasksStatusFilter">
                                        <option value="">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
                                        <option value="active">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                                        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="tasksResetFilters">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="tasksTable">
                            <thead>
                                <tr>
                                    <th class="number-column">‚Ññ</th>
                                    <th>–¢–µ–º–∞ –∑–∞–¥–∞—á–∏</th>
                                    <th>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                                    <th>–û—Ç–¥–µ–ª</th>
                                    <th>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks %}
                                <tr class="task-row" data-task-id="{{ task.id }}" data-status="{{ 'completed' if task.status in ['–ó–∞–≤–µ—Ä—à–µ–Ω–æ', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'] else 'active' }}" data-facility-id="{{ task.facility_id or '' }}" style="cursor: pointer;">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td>{{ task.heading or '‚Äî' }}</td>
                                    <td>{{ task.equipment_name or '‚Äî' }}</td>
                                    <td>{{ task.department_name or '‚Äî' }}</td>
                                    <td>{{ task.facility_name or '‚Äî' }}</td>
                                    <td>
                                        {% if task.status == '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' %}
                                        <span class="status-badge status-completed">{{ task.status }}</span>
                                        {% elif task.status == '–û–∂–∏–¥–∞—é—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è' %}
                                        <span class="status-badge status-pending">{{ task.status }}</span>
                                        {% elif task.status == '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' %}
                                        <span class="status-badge status-in-progress">{{ task.status }}</span>
                                        {% elif task.status == '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' %}
                                        <span class="status-badge status-finished">{{ task.status }}</span>
                                        {% else %}
                                        <span class="status-badge status-in-progress">{{ task.status or '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —Ä–µ–º–æ–Ω—Ç</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="createTaskBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                        </button>
                    </div>
                {% elif section == 'statistics' %}
                    <div class="content-header">
                        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    </div>
                    <div class="statistics-dashboard">
                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <div id="statisticsLoading" class="statistics-loading">
                            <div class="loading-spinner"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
                        </div>

                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ -->
                        <div class="stats-cards-grid" id="statsCards" style="display: none;">
                            <div class="stat-card">
                                <div class="stat-card-icon pto">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                        <line x1="3" y1="9" x2="21" y2="9"></line>
                                    </svg>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-label">–í—Å–µ–≥–æ –ü–¢–û</div>
                                    <div class="stat-card-value" id="ptoTotal">0</div>
                                    <div class="stat-card-detail" id="ptoDetail"></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon tasks">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                    </svg>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                                    <div class="stat-card-value" id="tasksTotal">0</div>
                                    <div class="stat-card-detail" id="tasksDetail"></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon employees">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                                    <div class="stat-card-value" id="employeesTotal">0</div>
                                    <div class="stat-card-detail" id="employeesDetail"></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon parts">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="8" width="18" height="4" rx="1"></rect>
                                        <path d="M12 8v13"></path>
                                        <path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"></path>
                                        <path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"></path>
                                    </svg>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-label">–ó–∞–ø—á–∞—Å—Ç–µ–π</div>
                                    <div class="stat-card-value" id="partsTotal">0</div>
                                    <div class="stat-card-detail" id="partsDetail"></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon equipment">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-label">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>
                                    <div class="stat-card-value" id="equipmentTotal">0</div>
                                    <div class="stat-card-detail" id="equipmentDetail"></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon completed">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞–¥–∞—á</div>
                                    <div class="stat-card-value" id="completedTasks">0</div>
                                    <div class="stat-card-detail" id="completedTasksDetail"></div>
                                </div>
                            </div>
                        </div>

                        <!-- –î–∏–∞–≥—Ä–∞–º–º—ã -->
                        <div class="charts-grid">
                            <!-- –¢–æ–ø —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è) - —Ä–∞—Å—Ç—è–Ω—É—Ç –¥–æ –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è -->
                            <div class="chart-container chart-employees">
                                <div class="chart-header">
                                    <h3>–¢–æ–ø —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–¥–∞—á</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="topEmployeesChart"></canvas>
                                </div>
                            </div>

                            <!-- –ü–¢–û –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–∫—Ä—É–≥–æ–≤–∞—è) -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>–ü–¢–û –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="ptoStatusChart"></canvas>
                                </div>
                            </div>

                            <!-- –ó–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–∫—Ä—É–≥–æ–≤–∞—è) -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>–ó–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="tasksStatusChart"></canvas>
                                </div>
                            </div>

                            <!-- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–∫—Ä—É–≥–æ–≤–∞—è) -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="equipmentStatusChart"></canvas>
                                </div>
                            </div>

                            <!-- –ü–¢–û –ø–æ –º–µ—Å—è—Ü–∞–º (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è) - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ -->
                            <div class="chart-container chart-wide">
                                <div class="chart-header">
                                    <h3>–ü–¢–û –ø–æ –º–µ—Å—è—Ü–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="ptoMonthlyChart"></canvas>
                                </div>
                            </div>

                            <!-- –ó–∞–¥–∞—á–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è) -->
                            <div class="chart-container chart-wide">
                                <div class="chart-header">
                                    <h3>–ó–∞–¥–∞—á–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="tasksMonthlyChart"></canvas>
                                </div>
                            </div>

                            <!-- –ó–∞–ø—á–∞—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º (–∫—Ä—É–≥–æ–≤–∞—è) -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>–ó–∞–ø—á–∞—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="partsTypeChart"></canvas>
                                </div>
                            </div>

                            <!-- –¢–æ–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—á–∞—Å—Ç–µ–π (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è) -->
                            <div class="chart-container chart-parts-top">
                                <div class="chart-header">
                                    <h3>–¢–æ–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—á–∞—Å—Ç–µ–π</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="topPartsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </main>
        </div>
        <div class="decor-line"></div>
    </div>

    <div class="modal-overlay" id="employeeModal" aria-hidden="true">
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="employeeModalTitle">
            <div class="modal-header">
                <h3 id="employeeModalTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
                <button type="button" class="modal-close-btn" id="employeeModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form class="modal-form" id="employeeForm">
                <div class="modal-section">
                    <h4 class="modal-section-title">–î–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h4>
                    <div class="modal-row modal-row--thirds">
                        <label class="modal-field">
                            <span data-required="*">–§–∞–º–∏–ª–∏—è</span>
                            <input type="text" name="last_name" required>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">–ò–º—è</span>
                            <input type="text" name="first_name" required>
                        </label>
                        <label class="modal-field">
                            <span data-required="">–û—Ç—á–µ—Å—Ç–≤–æ</span>
                            <input type="text" name="patronymic">
                        </label>
                    </div>
                    <div class="modal-row modal-row--thirds">
                        <label class="modal-field">
                            <span data-required="*">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="facility_id" id="employeeFacilitySelect" required style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">–û—Ç–¥–µ–ª</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalDepartmentBtn" data-field="department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="department_id" id="employeeDepartment" required disabled style="display: none;">
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">–î–æ–ª–∂–Ω–æ—Å—Ç—å</span>
                            <input type="text" name="post" required>
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                            <input type="text" name="phone" id="employeePhone" placeholder="+7 (___) ___-__-__">
                        </label>
                        <label class="modal-field">
                            <span data-required="">Email</span>
                            <input type="email" name="email" placeholder="example@company.ru">
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">–î–æ—Å—Ç—É–ø –∫ –£–¢–û–†</h4>
                    <div class="modal-row modal-row--credentials">
                        <label class="modal-field">
                            <span data-required="*">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalRoleBtn" data-field="role" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="role" id="employeeRoleSelect" required style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                                    {% for role in role_options %}
                                    <option value="{{ role }}">{{ role_labels.get(role) or role }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field login-field">
                            <span data-required="*">–õ–æ–≥–∏–Ω</span>
                            <input type="text" name="login" id="employeeLogin" required>
                        </label>
                        <label class="modal-field password-field">
                            <span data-required="*">–ü–∞—Ä–æ–ª—å</span>
                            <div class="password-input-wrapper">
                                <input type="text" name="password" id="employeePassword" required>
                                <button type="button" class="dice-btn" id="generateCredentialsBtn" aria-label="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å" title="–°–ª—É—á–∞–π–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                        <circle cx="7.5" cy="7.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="16.5" cy="7.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="7.5" cy="16.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="16.5" cy="16.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="12" cy="12" r="1.2" fill="currentColor"></circle>
                                    </svg>
                                </button>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="modal-error" id="employeeFormError"></div>
                    <div class="modal-actions">
                        <button type="button" class="secondary-btn" id="employeeModalCancel">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="primary-btn" id="employeeFormSubmit" data-default-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
    <div class="modal-overlay" id="deleteEmployeeModal" aria-hidden="true">
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteEmployeeModalTitle">
            <div class="modal-header">
                <h3 id="deleteEmployeeModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
                <button type="button" class="modal-close-btn" id="deleteEmployeeModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p id="deleteEmployeeMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em></p>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="deleteEmployeeCancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="primary-btn danger-btn" id="deleteEmployeeConfirm">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏ –Ω–∞ —Å–∫–ª–∞–¥ -->
<div class="modal-overlay" id="partModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="partModalTitle">
        <div class="modal-header">
            <h3 id="partModalTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</h3>
            <button type="button" class="modal-close-btn" id="partModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="partForm">
            <div class="modal-section">
                <h4 class="modal-section-title">–î–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏</h4>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</span>
                        <input type="text" name="spare_part_name" id="partSparePartName" required>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">–¢–∏–ø –¥–µ—Ç–∞–ª–∏</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalPartTypeBtn" data-field="spare_part_type" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="spare_part_type" id="partTypeSelect" style="display: none;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                {% for type in spare_part_types %}
                                <option value="{{ type }}">{{ type }}</option>
                                {% endfor %}
                                <option value="__custom__">–î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                    </label>
                </div>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                        <div class="number-input-wrapper">
                            <input type="number" name="quantity" id="partQuantity" min="1" required>
                            <div class="number-input-buttons">
                                <button type="button" class="number-input-btn number-input-btn-up" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å" tabindex="-1">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                </button>
                                <button type="button" class="number-input-btn number-input-btn-down" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å" tabindex="-1">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </label>
                    <label class="modal-field" id="customPartTypeRow" style="display: none;">
                        <span>–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏</span>
                        <input type="text" id="customPartType" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏" style="width: 100%; padding: 10px 12px; border: 1px solid #dcdcdc; border-radius: 10px; font-size: 14px;">
                    </label>
                </div>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalPartFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="facility_id" id="partFacilitySelect" required style="display: none;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                {% for fac in facility_choices %}
                                <option value="{{ fac.id }}">{{ fac.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">–°–∫–ª–∞–¥</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalPartWarehouseBtn" data-field="warehouse_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="warehouse_id" id="partWarehouseSelect" required disabled style="display: none;">
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                            </select>
                        </div>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="partFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="partModalCancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="primary-btn" id="partFormSubmit" data-default-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Å–æ —Å–∫–ª–∞–¥–∞ -->
<div class="modal-overlay" id="deleteWarehouseModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteWarehouseModalTitle">
        <div class="modal-header">
            <h3 id="deleteWarehouseModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <button type="button" class="modal-close-btn" id="deleteWarehouseModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteWarehouseMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em></p>
        </div>
        <div class="modal-actions">
            <button type="button" class="secondary-btn" id="deleteWarehouseCancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="primary-btn danger-btn" id="deleteWarehouseConfirm">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
<div class="modal-overlay" id="deleteEquipmentModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteEquipmentModalTitle">
        <div class="modal-header">
            <h3 id="deleteEquipmentModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <button type="button" class="modal-close-btn" id="deleteEquipmentModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteEquipmentMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em></p>
        </div>
        <div class="modal-actions">
            <button type="button" class="secondary-btn" id="deleteEquipmentCancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="primary-btn danger-btn" id="deleteEquipmentConfirm">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è -->
<div class="modal-overlay" id="deleteMovementModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteMovementModalTitle">
        <div class="modal-header">
            <h3 id="deleteMovementModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <button type="button" class="modal-close-btn" id="deleteMovementModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteMovementMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em></p>
        </div>
        <div class="modal-actions">
            <button type="button" class="secondary-btn" id="deleteMovementCancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="primary-btn danger-btn" id="deleteMovementConfirm">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
<div class="modal-overlay" id="addMovementModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="addMovementModalTitle">
        <div class="modal-header">
            <h3 id="addMovementModalTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</h3>
            <button type="button" class="modal-close-btn" id="addMovementModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="movementForm">
            <div class="modal-section">
                <h4 class="modal-section-title">–î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</h4>
                <div class="movement-container">
                    <div class="movement-from-section">
                        <label class="modal-field">
                            <span data-required="*">–û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="movementFromFacilityBtn" data-field="from_facility_id" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="from_facility_id" id="movementFromFacilitySelect" style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="modal-select-wrapper" style="margin-top: 12px;">
                                <button type="button" class="modal-select-btn" id="movementFromDepartmentBtn" data-field="from_department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="from_department_id" id="movementFromDepartmentSelect" disabled style="display: none;">
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                </select>
                            </div>
                        </label>
                    </div>
                    <div class="movement-arrow">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </div>
                    <div class="movement-to-section">
                        <label class="modal-field">
                            <span data-required="*">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="movementToFacilityBtn" data-field="to_facility_id" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="to_facility_id" id="movementToFacilitySelect" style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="modal-select-wrapper" style="margin-top: 12px;">
                                <button type="button" class="modal-select-btn" id="movementToDepartmentBtn" data-field="to_department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="to_department_id" id="movementToDepartmentSelect" disabled style="display: none;">
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                </select>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="movement-container" style="margin-top: 24px;">
                    <div class="movement-from-section">
                        <label class="modal-field">
                            <span>–õ–æ–∫–∞—Ü–∏—è (–æ—Ç–∫—É–¥–∞)</span>
                            <input type="text" name="from_location" id="movementFromLocationInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ª–æ–∫–∞—Ü–∏—é">
                        </label>
                    </div>
                    <div class="movement-arrow">
                    </div>
                    <div class="movement-to-section">
                        <label class="modal-field">
                            <span>–õ–æ–∫–∞—Ü–∏—è (–∫—É–¥–∞)</span>
                            <input type="text" name="to_location" id="movementToLocationInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ª–æ–∫–∞—Ü–∏—é">
                        </label>
                    </div>
                </div>
                <div class="modal-row" style="margin-top: 24px;">
                    <label class="modal-field">
                        <span data-required="*">–î–∞—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</span>
                        <input type="date" name="move_date" id="movementDateInput" required>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-error" id="movementFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="addMovementModalCancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="primary-btn" id="movementFormSubmit" data-default-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏ -->
<div class="modal-overlay" id="addSparePartModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="addSparePartModalTitle">
        <div class="modal-header">
            <h3 id="addSparePartModalTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</h3>
            <button type="button" class="modal-close-btn" id="addSparePartModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="sparePartForm">
            <div class="modal-section">
                <h4 class="modal-section-title">–î–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏</h4>
                <div class="modal-row">
                    <label class="modal-field" style="width: 100%;">
                        <span data-required="*">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</span>
                        <input type="text" name="spare_part_name" id="sparePartNameInput" required style="width: 100%;">
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field" style="width: 100%;">
                        <span data-required="*">–¢–∏–ø –¥–µ—Ç–∞–ª–∏</span>
                        <div class="modal-select-wrapper" style="width: 100%;">
                            <button type="button" class="modal-select-btn" id="sparePartTypeBtn" data-field="spare_part_type" aria-haspopup="listbox" aria-expanded="false" style="width: 100%;">
                                <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="spare_part_type" id="sparePartTypeSelect" required style="display: none; width: 100%;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                {% for type in spare_part_types %}
                                <option value="{{ type }}">{{ type }}</option>
                                {% endfor %}
                                <option value="__custom__">–î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div id="customSparePartTypeRow" style="display: none; margin-top: 8px;">
                            <input type="text" name="custom_spare_part_type" id="customSparePartType" class="custom-input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏–ø –¥–µ—Ç–∞–ª–∏">
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-error" id="sparePartFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="addSparePartModalCancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="primary-btn" id="sparePartFormSubmit" data-default-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏ -->
<div class="modal-overlay" id="deleteSparePartModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteSparePartModalTitle">
        <div class="modal-header">
            <h3 id="deleteSparePartModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <button type="button" class="modal-close-btn" id="deleteSparePartModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteSparePartMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–µ—Ç–∞–ª—å?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em></p>
        </div>
        <div class="modal-actions">
            <button type="button" class="secondary-btn" id="deleteSparePartCancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="primary-btn danger-btn" id="deleteSparePartConfirm">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
<div class="modal-overlay" id="equipmentModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="equipmentModalTitle">
        <div class="modal-header">
            <h3 id="equipmentModalTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h3>
            <button type="button" class="modal-close-btn" id="equipmentModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="equipmentForm" enctype="multipart/form-data">
            <!-- –†–µ–∂–∏–º: –Ω–æ–≤–æ–µ –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ -->
            <div class="modal-section" id="equipmentSearchSection">
                <h4 class="modal-section-title">–ü–æ–∏—Å–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h4>
                <div class="modal-row" style="position: relative;">
                    <label class="modal-field" style="width: 100%;">
                        <span data-required="*">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</span>
                        <input type="text" name="equipment_name" id="equipmentNameInput" required autocomplete="off" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ...">
                        <div id="equipmentModeIndicator" style="margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 13px; display: none;"></div>
                    </label>
                    <div id="equipmentSearchResults" class="equipment-search-results" style="display: none;"></div>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
            <div id="newEquipmentForm" style="display: none;">
                <div class="modal-section">
                    <h4 class="modal-section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="">–¢–∏–ø</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentTypeBtn" data-field="equipment_type" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="equipment_type" id="equipmentTypeSelect" style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                    {% for eq_type in equipment_types %}
                                    <option value="{{ eq_type }}">{{ eq_type }}</option>
                                    {% endfor %}
                                    <option value="__custom__">–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                            <div id="customEquipmentTypeRow" style="display: none; margin-top: 8px;">
                                <input type="text" name="custom_equipment_type" id="customEquipmentType" class="custom-input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è">
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="">–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –¢–û</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentMaintenanceBtn" data-field="maintenance_frequency" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="maintenance_frequency" id="equipmentMaintenanceSelect" style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å</option>
                                    <option value="7">–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é (7 –¥–Ω–µ–π)</option>
                                    <option value="30">–†–∞–∑ –≤ –º–µ—Å—è—Ü (30 –¥–Ω–µ–π)</option>
                                    <option value="90">–†–∞–∑ –≤ –∫–≤–∞—Ä—Ç–∞–ª (90 –¥–Ω–µ–π)</option>
                                    <option value="365">–†–∞–∑ –≤ –≥–æ–¥ (365 –¥–Ω–µ–π)</option>
                                    <option value="custom">–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                            <div id="customMaintenanceRow" style="display: none; margin-top: 8px;">
                                <input type="text" name="custom_maintenance_frequency" id="customMaintenanceFrequency" class="custom-input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π">
                    </div>
                        </label>
                    </div>
                    <div class="modal-row">
                        <label class="modal-field">
                            <span data-required="">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                            <input type="file" name="equipment_image" id="equipmentImageInput" accept="image/*" style="padding: 8px; border: 1px solid #dcdcdc; border-radius: 10px; width: 100%;">
                            <div id="equipmentImagePreview" style="margin-top: 8px; display: none; position: relative; width: fit-content;">
                                <img id="equipmentImagePreviewImg" src="" alt="–ü—Ä–µ–≤—å—é" style="max-width: 200px; max-height: 200px; border-radius: 8px; display: block;">
                                <button type="button" id="removeEquipmentImageBtn" style="position: absolute; top: 4px; right: 4px; background: rgba(0, 0, 0, 0.7); border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: background 0.2s;" aria-label="–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">–û–ø–∏—Å–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</h4>
                    <div class="modal-row">
                        <label class="modal-field" style="width: 100%;">
                            <span data-required="">–û–ø–∏—Å–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</span>
                            <textarea name="characteristics" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" style="width: 100%; resize: vertical; min-height: 150px;"></textarea>
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="">–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</span>
                            <input type="date" name="acquisition_date">
                        </label>
                        <label class="modal-field">
                            <span data-required="">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≥–∞—Ä–∞–Ω—Ç–∏–∏</span>
                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                <input type="number" name="warranty_period_value" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" style="flex: 1;" id="warrantyPeriodValue">
                                <div class="modal-select-wrapper" style="flex: 0 0 140px;">
                                    <button type="button" class="modal-select-btn" id="warrantyPeriodUnitBtn" data-field="warranty_period_unit" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="modal-select-label">–ú–µ—Å—è—Ü–µ–≤</span>
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    </button>
                                    <select name="warranty_period_unit" id="warrantyPeriodUnit" style="display: none;">
                                        <option value="days">–î–Ω–µ–π</option>
                                        <option value="months" selected>–ú–µ—Å—è—Ü–µ–≤</option>
                                        <option value="years">–õ–µ—Ç</option>
                                    </select>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="modal-row">
                        <label class="modal-field">
                            <span data-required="">–¢–∏–ø—ã –¥–µ—Ç–∞–ª–µ–π</span>
                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                <div class="modal-select-wrapper" style="flex: 1;">
                                    <button type="button" class="modal-select-btn" id="equipmentSparePartTypeBtn" data-field="spare_part_type" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏</span>
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    </button>
                                    <select name="spare_part_type" id="equipmentSparePartTypeSelect" style="display: none;">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏</option>
                                        {% for spare_type in spare_part_types %}
                                        <option value="{{ spare_type }}">{{ spare_type }}</option>
                                        {% endfor %}
                                        <option value="__custom__">–î—Ä—É–≥–æ–µ</option>
                                    </select>
                                </div>
                                <button type="button" class="primary-btn" id="addSparePartTypeBtn" style="padding: 10px 16px; min-width: auto; white-space: nowrap;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px; vertical-align: middle;">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                            <div id="equipmentCustomSparePartTypeRow" style="display: none; margin-top: 8px;">
                                <input type="text" name="custom_spare_part_type" id="equipmentCustomSparePartType" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏–ø –¥–µ—Ç–∞–ª–∏" style="width: 100%; padding: 10px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm);">
                            </div>
                            <div id="sparePartTypesList" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; padding: 4px;"></div>
                        </label>
                    </div>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="*">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentFacilityBtnNew" data-field="facility_id_new" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="facility_id_new" id="equipmentFacilitySelectNew" style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">–û—Ç–¥–µ–ª</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentDepartmentBtnNew" data-field="department_id_new" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="department_id_new" id="equipmentDepartmentSelectNew" disabled style="display: none;">
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
                            <input type="text" name="location" id="equipmentLocationInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è">
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
            <div id="existingEquipmentForm" style="display: none;">
                <div class="modal-section">
                    <h4 class="modal-section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="*">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="facility_id" id="equipmentFacilitySelect" style="display: none;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">–û—Ç–¥–µ–ª</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentDepartmentBtn" data-field="department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="department_id" id="equipmentDepartmentSelect" disabled style="display: none;">
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                </select>
                            </div>
                        </label>
                    </div>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="*">–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</span>
                            <input type="date" name="acquisition_date">
                        </label>
                        <label class="modal-field">
                            <span data-required="">–õ–æ–∫–∞—Ü–∏—è</span>
                            <input type="text" name="location" placeholder="–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ">
                        </label>
                    </div>
                    <input type="hidden" name="existing_equipment_id" id="existingEquipmentId">
                    <input type="hidden" name="equipment_status" value="–í —Ä–∞–±–æ—Ç–µ">
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="equipmentFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="equipmentModalCancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="primary-btn" id="equipmentFormSubmit" data-default-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div class="modal-overlay" id="createTaskModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="createTaskModalTitle">
        <div class="modal-header">
            <h3 id="createTaskModalTitle">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h3>
            <button type="button" class="modal-close-btn" id="createTaskModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="createTaskForm">
            <div class="modal-section">
                <h4 class="modal-section-title">–î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h4>
                <div class="modal-row modal-row--thirds">
                    <label class="modal-field">
                        <span data-required="*">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                        <input type="text" id="taskFacilityDisplay" readonly style="display: none;">
                        <div class="modal-select-wrapper" id="taskFacilitySelectWrapper">
                            <button type="button" class="modal-select-btn" id="modalTaskFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="facility_id" id="taskFacilitySelect" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; font-size: 16px;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                                {% for fac in facility_choices %}
                                <option value="{{ fac.id }}">{{ fac.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">–û—Ç–¥–µ–ª</span>
                        <input type="text" id="taskDepartmentDisplay" readonly style="display: none;">
                        <div class="modal-select-wrapper" id="taskDepartmentSelectWrapper">
                            <button type="button" class="modal-select-btn" id="modalTaskDepartmentBtn" data-field="department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="department_id" id="taskDepartmentSelect" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; font-size: 16px;" disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>
                            </select>
                        </div>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</span>
                        <input type="text" id="taskEquipmentDisplayReadonly" readonly style="display: none;">
                        <div class="modal-select-wrapper" id="taskEquipmentSelectWrapper">
                            <button type="button" class="modal-select-btn" id="modalTaskEquipmentBtn" data-field="equipment_assignment_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                <span class="modal-select-label">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="equipment_assignment_id" id="taskEquipmentSelect" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; font-size: 16px;" disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
                            </select>
                        </div>
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span data-required="*">–¢–µ–º–∞</span>
                        <input type="text" name="heading" id="taskHeading" required>
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span data-required="*">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</span>
                        <textarea name="repair_task_description" id="taskDescription" rows="6" required></textarea>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="createTaskFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="createTaskModalCancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="primary-btn" id="createTaskFormSubmit">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏ -->
<div class="modal-overlay" id="taskDetailsModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="taskDetailsModalTitle">
        <div class="modal-header">
            <h3 id="taskDetailsModalTitle">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h3>
            <button type="button" class="modal-close-btn" id="taskDetailsModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <div class="task-details-list">
                    <div class="detail-item">
                        <div class="detail-label">–¢–µ–º–∞ –∑–∞–¥–∞—á–∏</div>
                        <div class="detail-value" id="taskDetailsHeading">‚Äî</div>
                    </div>
                    <div class="detail-item detail-item-full">
                        <div class="detail-label">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</div>
                        <div class="detail-value" id="taskDetailsDescription">‚Äî</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</div>
                        <div class="detail-value" id="taskDetailsFacility">‚Äî</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–û—Ç–¥–µ–ª</div>
                        <div class="detail-value" id="taskDetailsDepartment">‚Äî</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</div>
                        <div class="detail-value" id="taskDetailsEquipment">‚Äî</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
                        <div class="detail-value" id="taskDetailsCreationDate">‚Äî</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</div>
                        <div class="detail-value" id="taskDetailsEndDate">‚Äî</div>
                    </div>
                </div>
            </div>
            <div class="modal-section">
                <div class="detail-label" style="margin-bottom: var(--spacing-md);">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div>
                <div id="taskAssignedEmployees" style="margin-bottom: var(--spacing-md);">
                    <div style="color: var(--text-medium); font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div>
                    <button type="button" class="btn-primary" id="assignEmployeesBtn" style="width: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-error" id="taskDetailsFormError"></div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="taskDetailsModalCancel">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –∑–∞–¥–∞—á—É -->
<div class="modal-overlay" id="assignEmployeesModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="assignEmployeesModalTitle">
        <div class="modal-header">
            <h3 id="assignEmployeesModalTitle">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
            <button type="button" class="modal-close-btn" id="assignEmployeesModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <div id="assignEmployeesList" style="max-height: 400px; overflow-y: auto;">
                    <div style="color: var(--text-medium); font-size: 14px; text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-error" id="assignEmployeesFormError"></div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="assignEmployeesModalCancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn-primary" id="assignEmployeesSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div class="modal-overlay" id="deleteTaskModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteTaskModalTitle">
        <div class="modal-header">
            <h3 id="deleteTaskModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <button type="button" class="modal-close-btn" id="deleteTaskModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteTaskMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em></p>
        </div>
        <div class="modal-actions">
            <button type="button" class="secondary-btn" id="deleteTaskCancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="primary-btn danger-btn" id="deleteTaskConfirm">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –∑–∞–¥–∞—á—É –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é -->
<div class="modal-overlay assign-employees-modal" id="assignEmployeesTaskModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="assignEmployeesTaskModalTitle">
        <div class="modal-header">
            <h3 id="assignEmployeesTaskModalTitle">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
            <button type="button" class="modal-close-btn" id="assignEmployeesTaskModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <div class="assign-employees-list" id="assignEmployeesTaskList">
                    <div class="assign-employees-loading">
                        <div class="loading-spinner"></div>
                        <div style="color: var(--text-medium); font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-error" id="assignEmployeesTaskFormError"></div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="assignEmployeesTaskModalCancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn-primary" id="assignEmployeesTaskSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div class="modal-overlay" id="completeTaskModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="completeTaskModalTitle">
        <div class="modal-header">
            <h3 id="completeTaskModalTitle">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É</h3>
            <button type="button" class="modal-close-btn" id="completeTaskModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <label for="completeTaskResolution" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç *</label>
                <textarea id="completeTaskResolution" class="form-input" rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ —Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã..." required></textarea>
            </div>
            <div class="modal-section">
                <label class="form-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏</label>
                <div class="complete-task-spare-parts-list" id="completeTaskSparePartsList">
                    <div class="complete-task-spare-parts-loading">
                        <div class="loading-spinner"></div>
                        <div style="color: var(--text-medium); font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-error" id="completeTaskFormError"></div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="completeTaskModalCancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn-primary" id="completeTaskSaveBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

    <script>
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            if (!userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
        function uploadAvatar(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('avatar', input.files[0]);
                
                fetch('{{ url_for("admin.upload_avatar") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                });
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        function toggleTheme() {
            const html = document.documentElement;
            const sunIcon = document.querySelector('#themeSwitch .sun-icon');
            const moonIcon = document.querySelector('#themeSwitch .moon-icon');
            const isDark = html.classList.contains('dark-theme');
            
            if (isDark) {
                html.classList.remove('dark-theme');
                html.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
                if (sunIcon) sunIcon.style.display = 'none';
                if (moonIcon) moonIcon.style.display = 'block';
            } else {
                html.classList.remove('light-theme');
                html.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
                if (sunIcon) sunIcon.style.display = 'block';
                if (moonIcon) moonIcon.style.display = 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (—Ç–µ–º–∞ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –≤ head, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏)
        (function() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark-theme');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–µ–º—ã
            const sunIcon = document.querySelector('#themeSwitch .sun-icon');
            const moonIcon = document.querySelector('#themeSwitch .moon-icon');
            if (isDark) {
                if (sunIcon) sunIcon.style.display = 'block';
                if (moonIcon) moonIcon.style.display = 'none';
            } else {
                if (sunIcon) sunIcon.style.display = 'none';
                if (moonIcon) moonIcon.style.display = 'block';
            }
        })();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö)
        const supportToggle = document.getElementById('supportToggle');
        const supportContacts = document.getElementById('supportContacts');
        if (supportToggle && supportContacts) {
            supportToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                supportContacts.classList.toggle('active');
            });
        }

        // –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü (–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π)
        function sortTable(table, columnIndex, sortDirection) {
            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelector(`thead th:nth-child(${columnIndex + 1})`);
            const headerText = header ? header.textContent.trim().toLowerCase() : '';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç–æ–ª–±–µ—Ü —á–∏—Å–ª–æ–≤—ã–º
            const isNumberColumn = columnIndex === 0 || 
                                   headerText.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') || 
                                   headerText.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') ||
                                   headerText === '‚Ññ';

            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                if (!aCell || !bCell) return 0;

                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
                if (aValue === '‚Äî' || aValue === '') aValue = '';
                if (bValue === '‚Äî' || bValue === '') bValue = '';

                // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ–≤–æ–π —Å—Ç–æ–ª–±–µ—Ü –∏–ª–∏ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è —è–≤–ª—è—é—Ç—Å—è —á–∏—Å–ª–∞–º–∏
                if (isNumberColumn) {
                    const aNum = parseFloat(aValue.replace(/\s/g, '')) || 0;
                    const bNum = parseFloat(bValue.replace(/\s/g, '')) || 0;
                    return sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è—é—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è —á–∏—Å–ª–∞–º–∏ (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è)
                const aIsNum = !isNaN(parseFloat(aValue.replace(/\s/g, ''))) && aValue !== '';
                const bIsNum = !isNaN(parseFloat(bValue.replace(/\s/g, ''))) && bValue !== '';
                
                if (aIsNum && bIsNum) {
                    const aNum = parseFloat(aValue.replace(/\s/g, '')) || 0;
                    const bNum = parseFloat(bValue.replace(/\s/g, '')) || 0;
                    return sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }

                // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º localeCompare –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤
                const comparison = aValue.localeCompare(bValue, 'ru', { 
                    sensitivity: 'base',
                    numeric: true 
                });
                return sortDirection === 'asc' ? comparison : -comparison;
            });

            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ DOM
            rows.forEach(tr => tbody.appendChild(tr));
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyTableSorting(table, columnIndex, sortDirection, filterFunction, rowStripingFunction) {
            if (columnIndex === null || sortDirection === null) {
                return; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É
            sortTable(table, columnIndex, sortDirection);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã (–æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–æ–∫)
            if (filterFunction) {
                filterFunction();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫
            if (rowStripingFunction) {
                rowStripingFunction();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫
            updateRowNumbers(table);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–æ–∫
        function updateRowNumbers(table) {
            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            let visibleIndex = 0;
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(tr => {
                if (tr.style.display !== 'none') {
                    const numberCell = tr.querySelector('.number-column');
                    if (numberCell) {
                        numberCell.textContent = visibleIndex + 1;
                    }
                    visibleIndex++;
                }
            });
        }

        {% if section == 'employees' %}
        // –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
        const roleOptionsMap = {{ role_labels|tojson }};
        const departmentsData = {{ department_choices|tojson }};
        const facilityOptionsMap = {};
        {% for fac in facility_choices %}
        facilityOptionsMap[{{ fac.name|tojson }}] = {{ fac.name|tojson }};
        {% endfor %}
        // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É –æ—Ç–¥–µ–ª–æ–≤ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const departmentsByFacility = {};
        {% for dept in department_choices %}
        const facilityName_{{ loop.index }} = {{ dept.facility_name|tojson }};
        if (facilityName_{{ loop.index }}) {
            if (!departmentsByFacility[facilityName_{{ loop.index }}]) {
                departmentsByFacility[facilityName_{{ loop.index }}] = [];
            }
            departmentsByFacility[facilityName_{{ loop.index }}].push({
                id: {{ dept.id }},
                name: {{ dept.name|tojson }}
            });
        }
        {% endfor %}
        const searchInput = document.getElementById('employeeSearch');
        const filterToggle = document.getElementById('filterToggle');
        const filterDropdown = document.getElementById('filterDropdown');
        const roleFilter = document.getElementById('roleFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const facilityFilter = document.getElementById('facilityFilter');
        const sortColumnFilter = document.getElementById('sortColumnFilter');
        const sortDirectionFilter = document.getElementById('sortDirectionFilter');
        const tableRows = document.querySelectorAll('.data-table tbody tr');
        const employeeTableForSorting = document.querySelector('.data-table');
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const employeeModal = document.getElementById('employeeModal');
        const employeeModalClose = document.getElementById('employeeModalClose');
        const employeeModalCancel = document.getElementById('employeeModalCancel');
        const generateCredentialsBtn = document.getElementById('generateCredentialsBtn');
        const employeeLoginInput = document.getElementById('employeeLogin');
        const employeePasswordInput = document.getElementById('employeePassword');
        const employeeForm = document.getElementById('employeeForm');
        const employeeFacilitySelect = document.getElementById('employeeFacilitySelect');
        const employeeDepartmentSelect = document.getElementById('employeeDepartment');
        const employeeFormError = document.getElementById('employeeFormError');
        const employeeFormSubmit = document.getElementById('employeeFormSubmit');
        const submitDefaultText = employeeFormSubmit ? (employeeFormSubmit.dataset.defaultLabel || employeeFormSubmit.textContent.trim()) : '';
        const filterSelectWrappers = document.querySelectorAll('.filter-select[data-target]');
        const filterSelectControllers = new Map();
        let activeModal = null;

        // –ö–∞—Å—Ç–æ–º–Ω—ã–µ dropdown'—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–æ–±—ä—è–≤–ª—è–µ–º —Ä–∞–Ω—å—à–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ openEmployeeModal)
        const modalDropdown = document.createElement('div');
        modalDropdown.className = 'role-dropdown';
        modalDropdown.id = 'modalDropdown';
        document.body.appendChild(modalDropdown);

        let currentModalSelect = null;
        let modalSelectData = {};

        const facilityDeptMap = departmentsData.reduce((acc, dept) => {
            const facilityId = dept.facility_id ? String(dept.facility_id) : '';
            if (!facilityId) {
                return acc;
            }
            if (!acc[facilityId]) {
                acc[facilityId] = [];
            }
            acc[facilityId].push({
                id: String(dept.id),
                name: dept.name
            });
            return acc;
        }, {});

        Object.keys(facilityDeptMap).forEach(key => {
            facilityDeptMap[key].sort((a, b) => a.name.localeCompare(b.name, 'ru', { sensitivity: 'base' }));
        });

        function populateDepartmentOptions(facilityId) {
            if (!employeeDepartmentSelect) return;
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            const modalDepartmentLabel = modalDepartmentBtn?.querySelector('.modal-select-label');
            
            employeeDepartmentSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
            placeholder.disabled = !facilityId;
            placeholder.selected = true;
            employeeDepartmentSelect.appendChild(placeholder);

            if (!facilityId) {
                employeeDepartmentSelect.disabled = true;
                if (modalDepartmentBtn) {
                    modalDepartmentBtn.disabled = true;
                    if (modalDepartmentLabel) {
                        modalDepartmentLabel.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è dropdown
                if (modalSelectData) {
                    modalSelectData.department = {};
                }
                return;
            }

            const departments = facilityDeptMap[facilityId] || [];
            if (departments.length === 0) {
                placeholder.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤';
                employeeDepartmentSelect.disabled = true;
                if (modalDepartmentBtn) {
                    modalDepartmentBtn.disabled = true;
                    if (modalDepartmentLabel) {
                        modalDepartmentLabel.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤';
                    }
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è dropdown
                if (modalSelectData) {
                    modalSelectData.department = {};
                }
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è dropdown
            if (modalSelectData) {
                modalSelectData.department = {};
                departments.forEach(dept => {
                    modalSelectData.department[dept.id] = dept.name;
                });
            }
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                employeeDepartmentSelect.appendChild(option);
            });
            employeeDepartmentSelect.disabled = false;
            if (modalDepartmentBtn) {
                modalDepartmentBtn.disabled = false;
                if (modalDepartmentLabel) {
                    modalDepartmentLabel.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                }
            }
        }

        function openEmployeeModal() {
            if (!employeeModal) return;
            employeeModal.classList.add('visible');
            employeeModal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            activeModal = employeeModal;
            if (employeeForm) {
                employeeForm.reset();
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ dropdown'—ã
            const modalFacilityBtn = document.getElementById('modalFacilityBtn');
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            const modalRoleBtn = document.getElementById('modalRoleBtn');
            
            if (modalFacilityBtn) {
                const label = modalFacilityBtn.querySelector('.modal-select-label');
                if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                modalFacilityBtn.setAttribute('aria-expanded', 'false');
            }
            if (modalDepartmentBtn) {
                const label = modalDepartmentBtn.querySelector('.modal-select-label');
                if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                modalDepartmentBtn.setAttribute('aria-expanded', 'false');
                modalDepartmentBtn.disabled = true;
            }
            if (modalRoleBtn) {
                const label = modalRoleBtn.querySelector('.modal-select-label');
                if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å';
                modalRoleBtn.setAttribute('aria-expanded', 'false');
            }
            
            closeModalDropdown();
            
            if (employeeFacilitySelect) {
                employeeFacilitySelect.value = '';
                handleFacilityChange();
            } else {
                populateDepartmentOptions('');
            }
            if (employeeFormError) {
                employeeFormError.textContent = '';
            }
            const firstInput = employeeForm ? employeeForm.querySelector('input, .modal-select-btn') : null;
            if (firstInput) {
                firstInput.focus();
            }
        }

        function closeEmployeeModal() {
            if (!employeeModal) return;
            employeeModal.classList.remove('visible');
            employeeModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            activeModal = null;
        }

        function handleFacilityChange() {
            if (!employeeFacilitySelect) return;
            const facilityId = employeeFacilitySelect.value;
            populateDepartmentOptions(facilityId);
            if (employeeDepartmentSelect) {
                employeeDepartmentSelect.value = '';
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –æ—Ç–¥–µ–ª–∞
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            if (modalDepartmentBtn) {
                const label = modalDepartmentBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                }
            }
        }

        function applyRowStriping() {
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ DOM –∫–∞–∂–¥—ã–π —Ä–∞–∑
            const table = document.querySelector('.data-table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            let visibleIndex = 0;
            rows.forEach(row => {
                if (row.style.display === 'none') {
                    row.classList.remove('alt-row');
                    return;
                }
                const isAlt = visibleIndex % 2 === 1;
                row.classList.toggle('alt-row', isAlt);
                visibleIndex += 1;
            });
        }

        function applyTableFilters() {
            const searchValue = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const roleValue = roleFilter ? roleFilter.value : '';
            const departmentValue = departmentFilter ? departmentFilter.value : '';
            const facilityValue = facilityFilter ? facilityFilter.value : '';

            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowRole = (row.dataset.role || '').toLowerCase();
                const rowDept = (row.dataset.department || '').toLowerCase();
                const rowFac = (row.dataset.facility || '').toLowerCase();

                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesRole = roleValue === '' || rowRole === roleValue.toLowerCase();
                const matchesDept = departmentValue === '' || rowDept === departmentValue.toLowerCase();
                const matchesFac = facilityValue === '' || rowFac === facilityValue.toLowerCase();

                row.style.display = (matchesSearch && matchesRole && matchesDept && matchesFac) ? '' : 'none';
            });

            applyRowStriping();
        }

        const resetFiltersBtn = document.getElementById('resetFilters');

        if (searchInput) {
            searchInput.addEventListener('input', applyTableFilters);
        }

        [roleFilter, departmentFilter, facilityFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', applyTableFilters);
            }
        });

        function closeFilterSelectMenus() {
            filterSelectWrappers.forEach(wrapper => {
                wrapper.classList.remove('open');
                const btn = wrapper.querySelector('.filter-select-btn');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (filterToggle && filterDropdown) {
            filterToggle.addEventListener('click', () => {
                filterDropdown.classList.toggle('active');
                filterToggle.classList.toggle('active');
                if (!filterDropdown.classList.contains('active')) {
                    closeFilterSelectMenus();
                }
            });

            document.addEventListener('click', (event) => {
                if (!filterDropdown.contains(event.target) && !filterToggle.contains(event.target)) {
                    filterDropdown.classList.remove('active');
                    filterToggle.classList.remove('active');
                    closeFilterSelectMenus();
                }
            });
        }

        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', () => {
                if (searchInput) searchInput.value = '';
                if (roleFilter) roleFilter.value = '';
                if (departmentFilter) departmentFilter.value = '';
                if (facilityFilter) facilityFilter.value = '';
                if (sortColumnFilter) sortColumnFilter.value = '';
                if (sortDirectionFilter) sortDirectionFilter.value = 'asc';
                applyTableFilters();
                filterSelectControllers.forEach(controller => controller.sync());
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        if (sortColumnFilter) {
            sortColumnFilter.addEventListener('change', () => {
                const columnIndex = sortColumnFilter.value ? parseInt(sortColumnFilter.value) : null;
                const sortDirection = sortDirectionFilter ? sortDirectionFilter.value : 'asc';
                if (columnIndex !== null && employeeTableForSorting) {
                    applyTableSorting(employeeTableForSorting, columnIndex, sortDirection, applyTableFilters, applyRowStriping);
                } else if (columnIndex === null) {
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫", –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    applyTableFilters();
                }
            });
        }

        if (sortDirectionFilter) {
            sortDirectionFilter.addEventListener('change', () => {
                const columnIndex = sortColumnFilter && sortColumnFilter.value ? parseInt(sortColumnFilter.value) : null;
                const sortDirection = sortDirectionFilter.value;
                if (columnIndex !== null && employeeTableForSorting) {
                    applyTableSorting(employeeTableForSorting, columnIndex, sortDirection, applyTableFilters, applyRowStriping);
                }
            });
        }

        if (addEmployeeBtn) {
            addEmployeeBtn.addEventListener('click', () => {
                closeFilterSelectMenus();
                closeRoleDropdown();
                if (typeof closeFacilityDropdown === 'function') {
                    closeFacilityDropdown();
                }
                if (typeof closeDepartmentDropdown === 'function') {
                    closeDepartmentDropdown();
                }
                openEmployeeModal();
            });
        }

        [employeeModalClose, employeeModalCancel].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    closeEmployeeModal();
                });
            }
        });

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è
        if (generateCredentialsBtn) {
            generateCredentialsBtn.addEventListener('click', () => {
                // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∞–º–∏–ª–∏–∏ –∏ –∏–º–µ–Ω–∏
                const lastNameInput = document.querySelector('input[name="last_name"]');
                const firstNameInput = document.querySelector('input[name="first_name"]');
                
                const lastName = lastNameInput ? lastNameInput.value.trim() : '';
                const firstName = firstNameInput ? firstNameInput.value.trim() : '';
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ª–æ–≥–∏–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–º–∏–ª–∏–∏ –∏ –∏–º–µ–Ω–∏
                let login = '';
                if (lastName && firstName) {
                    // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ 3 –±—É–∫–≤—ã —Ñ–∞–º–∏–ª–∏–∏ –∏ –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∏–º–µ–Ω–∏, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
                    const lastPart = lastName.substring(0, 3).toLowerCase();
                    const firstPart = firstName.substring(0, 1).toLowerCase();
                    // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤ –≤ –ª–∞—Ç–∏–Ω–∏—Ü—É
                    const translitMap = {
                        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'e',
                        '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
                        '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
                        '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch',
                        '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya'
                    };
                    
                    const transliterate = (str) => {
                        return str.split('').map(char => {
                            const lower = char.toLowerCase();
                            return translitMap[lower] || lower;
                        }).join('');
                    };
                    
                    const lastPartTranslit = transliterate(lastPart);
                    const firstPartTranslit = transliterate(firstPart);
                    login = lastPartTranslit + firstPartTranslit;
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–º–∏–ª–∏–∏ –∏ –∏–º–µ–Ω–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ª–æ–≥–∏–Ω
                    login = 'user' + Math.floor(Math.random() * 10000);
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å: pass + 4 —Å–ª—É—á–∞–π–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
                const randomDigits = Math.floor(1000 + Math.random() * 9000); // 4-–∑–Ω–∞—á–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 1000 –¥–æ 9999
                const password = 'pass' + randomDigits;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                if (employeeLoginInput) {
                    employeeLoginInput.value = login;
                }
                if (employeePasswordInput) {
                    employeePasswordInput.value = password;
                }
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const employeePhoneInput = document.getElementById('employeePhone');
        if (employeePhoneInput) {
            employeePhoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
                
                // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 7
                if (value.startsWith('8')) {
                    value = '7' + value.substring(1);
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7, –¥–æ–±–∞–≤–ª—è–µ–º 7
                if (value && !value.startsWith('7')) {
                    value = '7' + value;
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É (7 + 10 —Ü–∏—Ñ—Ä = 11)
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä
                let formatted = '';
                if (value.length > 0) {
                    formatted = '+7';
                    if (value.length > 1) {
                        formatted += ' (' + value.substring(1, 4);
                        if (value.length > 4) {
                            formatted += ') ' + value.substring(4, 7);
                            if (value.length > 7) {
                                formatted += '-' + value.substring(7, 9);
                                if (value.length > 9) {
                                    formatted += '-' + value.substring(9, 11);
                                }
                            }
                        } else {
                            formatted += ')';
                        }
                    }
                }
                
                e.target.value = formatted;
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞
            employeePhoneInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const digits = pastedText.replace(/\D/g, '');
                
                if (digits) {
                    let value = digits;
                    if (value.startsWith('8')) {
                        value = '7' + value.substring(1);
                    }
                    if (value && !value.startsWith('7')) {
                        value = '7' + value;
                    }
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    let formatted = '';
                    if (value.length > 0) {
                        formatted = '+7';
                        if (value.length > 1) {
                            formatted += ' (' + value.substring(1, 4);
                            if (value.length > 4) {
                                formatted += ') ' + value.substring(4, 7);
                                if (value.length > 7) {
                                    formatted += '-' + value.substring(7, 9);
                                    if (value.length > 9) {
                                        formatted += '-' + value.substring(9, 11);
                                    }
                                }
                            } else {
                                formatted += ')';
                            }
                        }
                    }
                    
                    this.value = formatted;
                    this.dispatchEvent(new Event('input'));
                }
            });
        }

        if (employeeModal) {
            employeeModal.addEventListener('click', (event) => {
                if (event.target === employeeModal) {
                    closeEmployeeModal();
                }
            });
        }

        if (employeeFacilitySelect) {
            employeeFacilitySelect.addEventListener('change', handleFacilityChange);
        }

        const statusBox = document.getElementById('tableUpdateStatus');
        const editableCells = document.querySelectorAll('.data-table td.editable-cell[data-field]');
        const roleCells = document.querySelectorAll('.role-cell');
        let statusTimeoutId;
        let currentRoleCell = null;

        function showStatus(message, state = 'info') {
            if (!statusBox) return;
            statusBox.textContent = message;
            statusBox.dataset.state = state;
            statusBox.classList.remove('visible');
            if (message) {
                requestAnimationFrame(() => statusBox.classList.add('visible'));
                clearTimeout(statusTimeoutId);
                statusTimeoutId = setTimeout(() => {
                    statusBox.classList.remove('visible');
                }, 5000);
            }
        }

        function revertCell(cell) {
            if (!cell) return;
            if (cell.classList.contains('role-cell')) {
                const label = roleOptionsMap[cell.dataset.originalValue || ''] || '‚Äî';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (labelSpan) labelSpan.textContent = label;
                cell.dataset.roleValue = cell.dataset.originalValue || '';
                return;
            }
            if (cell.classList.contains('facility-cell')) {
                const facilityName = cell.dataset.originalValue || '';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (labelSpan) labelSpan.textContent = facilityName || '‚Äî';
                cell.dataset.facilityValue = facilityName;
                return;
            }
            if (cell.classList.contains('department-cell')) {
                const deptId = cell.dataset.originalValue || '';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (deptId) {
                    const facilityName = cell.dataset.facilityName || '';
                    const departments = departmentsByFacility[facilityName] || [];
                    const dept = departments.find(d => String(d.id) === String(deptId));
                    if (labelSpan) labelSpan.textContent = dept ? dept.name : '‚Äî';
                    cell.dataset.departmentId = deptId;
                } else {
                    if (labelSpan) labelSpan.textContent = '‚Äî';
                    cell.dataset.departmentId = '';
                }
                return;
            }
            cell.textContent = cell.dataset.originalValue || '';
        }

        function updateEmployeeCell(cell, employeeId, field, value) {
            cell.classList.add('saving');
            fetch(`/admin/employees/${employeeId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ field, value })
            })
            .then(async response => {
                const data = await response.json();
                return { ok: response.ok, data };
            })
            .then(({ ok, data }) => {
                cell.classList.remove('saving');
                if (ok && data.success) {
                    if (cell.classList.contains('role-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        const label = roleOptionsMap[data.value || ''] || '‚Äî';
                        if (labelSpan) labelSpan.textContent = label;
                        cell.dataset.roleValue = data.value || '';
                        cell.dataset.originalValue = cell.dataset.roleValue;
                        cell.setAttribute('aria-expanded', 'false');
                    } else if (cell.classList.contains('facility-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        const facilityName = data.value || '';
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (–Ω–µ –ø—Ä–æ—á–µ—Ä–∫, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ)
                        if (labelSpan) labelSpan.textContent = facilityName || '‚Äî';
                        cell.dataset.facilityValue = facilityName;
                        cell.dataset.originalValue = facilityName;
                        cell.setAttribute('aria-expanded', 'false');
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ department –≤ —Å—Ç—Ä–æ–∫–µ
                        const facilityRow = cell.closest('tr');
                        if (facilityRow) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º data-facility –≤ —Å—Ç—Ä–æ–∫–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                            facilityRow.dataset.facility = facilityName || '';
                            const departmentCell = facilityRow.querySelector('.department-cell');
                            if (departmentCell) {
                                const deptLabelSpan = departmentCell.querySelector('.role-cell-label');
                                // –í—Å–µ–≥–¥–∞ —Å—Ç–∞–≤–∏–º –ø—Ä–æ—á–µ—Ä–∫ –≤ –æ—Ç–¥–µ–ª–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
                                if (deptLabelSpan) deptLabelSpan.textContent = '‚Äî';
                                departmentCell.dataset.departmentId = '';
                                // –û–±–Ω–æ–≤–ª—è–µ–º facilityName –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ—Ç–¥–µ–ª–æ–≤
                                departmentCell.dataset.facilityName = facilityName || '';
                                facilityRow.dataset.department = '';
                            }
                        }
                    } else if (cell.classList.contains('department-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        // data.value –¥–ª—è –æ—Ç–¥–µ–ª–∞ - —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞, –∞ –Ω–µ ID
                        const deptName = data.value || '';
                        if (labelSpan) labelSpan.textContent = deptName || '‚Äî';
                        // –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ ID –æ—Ç–¥–µ–ª–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è dataset
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º facility –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ dataset —è—á–µ–π–∫–∏
                        const facilityName = data.facility || cell.dataset.facilityName || '';
                        const departments = departmentsByFacility[facilityName] || [];
                        const dept = departments.find(d => d.name === deptName);
                        if (dept) {
                            cell.dataset.departmentId = String(dept.id);
                        } else {
                            cell.dataset.departmentId = '';
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º facilityName –≤ —è—á–µ–π–∫–µ, –µ—Å–ª–∏ –æ–Ω–æ –ø—Ä–∏—à–ª–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
                        if (data.facility !== undefined) {
                            cell.dataset.facilityName = facilityName || '';
                        }
                        cell.dataset.originalValue = cell.dataset.departmentId;
                        cell.setAttribute('aria-expanded', 'false');
                        // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                        const row = cell.closest('tr');
                        if (row) {
                            row.dataset.department = deptName || '';
                            row.dataset.facility = facilityName || '';
                            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º facility-cell, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                            const facilityCell = row.querySelector('.facility-cell');
                            if (facilityCell && data.facility !== undefined) {
                                const facilityLabelSpan = facilityCell.querySelector('.role-cell-label');
                                if (facilityLabelSpan) {
                                    facilityLabelSpan.textContent = facilityName || '‚Äî';
                                }
                                facilityCell.dataset.facilityValue = facilityName || '';
                            }
                        }
                    } else {
                        cell.textContent = data.value || '';
                        cell.dataset.originalValue = cell.textContent;
                    }
                    showStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                } else {
                    cell.classList.add('error');
                    revertCell(cell);
                    showStatus(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                    setTimeout(() => cell.classList.remove('error'), 1500);
                }
            })
            .catch(() => {
                cell.classList.remove('saving');
                cell.classList.add('error');
                revertCell(cell);
                showStatus('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                setTimeout(() => cell.classList.remove('error'), 1500);
            });
        }

        editableCells.forEach(cell => {
            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
            cell.addEventListener('dblclick', () => {
                cell.contentEditable = 'true';
                cell.dataset.originalValue = cell.textContent.trim();
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º —è—á–µ–π–∫—É –∏ –≤—ã–¥–µ–ª—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç
                cell.focus();
                const range = document.createRange();
                range.selectNodeContents(cell);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            });

            cell.addEventListener('focus', () => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è—á–µ–π–∫–∞ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                if (cell.contentEditable === 'true') {
                    cell.dataset.originalValue = cell.textContent.trim();
                }
            });

            cell.addEventListener('keydown', (event) => {
                if (cell.contentEditable !== 'true') return;
                
                if (event.key === 'Enter') {
                    event.preventDefault();
                    cell.blur();
                }
                if (event.key === 'Escape') {
                    event.preventDefault();
                    revertCell(cell);
                    cell.blur();
                }
            });

            cell.addEventListener('paste', (event) => {
                if (cell.contentEditable !== 'true') return;
                event.preventDefault();
                const text = (event.clipboardData || window.clipboardData).getData('text');
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                if (cell.dataset.field === 'phone') {
                    const digits = text.replace(/\D/g, '');
                    if (digits) {
                        let value = digits;
                        if (value.startsWith('8')) {
                            value = '7' + value.substring(1);
                        }
                        if (value && !value.startsWith('7')) {
                            value = '7' + value;
                        }
                        if (value.length > 11) {
                            value = value.substring(0, 11);
                        }
                        
                        let formatted = '';
                        if (value.length > 0) {
                            formatted = '+7';
                            if (value.length > 1) {
                                formatted += ' (' + value.substring(1, 4);
                                if (value.length > 4) {
                                    formatted += ') ' + value.substring(4, 7);
                                    if (value.length > 7) {
                                        formatted += '-' + value.substring(7, 9);
                                        if (value.length > 9) {
                                            formatted += '-' + value.substring(9, 11);
                                        }
                                    }
                                } else {
                                    formatted += ')';
                                }
                            }
                        }
                        cell.textContent = formatted;
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
                        const range = document.createRange();
                        range.selectNodeContents(cell);
                        range.collapse(false);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                } else {
                    document.execCommand('insertText', false, text);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –¥–ª—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            if (cell.dataset.field === 'phone') {
                cell.addEventListener('input', function(e) {
                    if (cell.contentEditable !== 'true') return;
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ –∏ —Ç–µ–∫—Å—Ç –¥–æ –∫—É—Ä—Å–æ—Ä–∞
                    const selection = window.getSelection();
                    const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                    const cursorOffset = range ? range.startOffset : 0;
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –¥–æ –∫—É—Ä—Å–æ—Ä–∞ –∏ –ø–æ—Å–ª–µ
                    const textBeforeCursor = cell.textContent.substring(0, cursorOffset);
                    const textAfterCursor = cell.textContent.substring(cursorOffset);
                    
                    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä –¥–æ –∫—É—Ä—Å–æ—Ä–∞
                    const digitsBeforeCursor = textBeforeCursor.replace(/\D/g, '').length;
                    
                    let value = cell.textContent.replace(/\D/g, ''); // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
                    
                    // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 7
                    if (value.startsWith('8')) {
                        value = '7' + value.substring(1);
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7, –¥–æ–±–∞–≤–ª—è–µ–º 7
                    if (value && !value.startsWith('7')) {
                        value = '7' + value;
                    }
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É (7 + 10 —Ü–∏—Ñ—Ä = 11)
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä
                    let formatted = '';
                    if (value.length > 0) {
                        formatted = '+7';
                        if (value.length > 1) {
                            formatted += ' (' + value.substring(1, 4);
                            if (value.length > 4) {
                                formatted += ') ' + value.substring(4, 7);
                                if (value.length > 7) {
                                    formatted += '-' + value.substring(7, 9);
                                    if (value.length > 9) {
                                        formatted += '-' + value.substring(9, 11);
                                    }
                                }
                            } else {
                                formatted += ')';
                            }
                        }
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ü–∏—Ñ—Ä
                    let newCursorPosition = formatted.length;
                    if (digitsBeforeCursor > 0) {
                        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –≤ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è N-—è —Ü–∏—Ñ—Ä–∞
                        let digitCount = 0;
                        for (let i = 0; i < formatted.length; i++) {
                            if (/\d/.test(formatted[i])) {
                                digitCount++;
                                if (digitCount === digitsBeforeCursor) {
                                    // –°—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ —ç—Ç–æ–π —Ü–∏—Ñ—Ä—ã
                                    newCursorPosition = i + 1;
                                    break;
                                }
                            }
                        }
                    } else if (digitsBeforeCursor === 0 && value.length > 0) {
                        // –ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –±—ã–ª –≤ –Ω–∞—á–∞–ª–µ, —Å—Ç–∞–≤–∏–º –ø–æ—Å–ª–µ +7
                        newCursorPosition = 2;
                    }
                    
                    cell.textContent = formatted;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
                    if (formatted.length > 0) {
                        requestAnimationFrame(() => {
                            try {
                                const textNode = cell.firstChild;
                                if (textNode) {
                                    const newRange = document.createRange();
                                    const finalPosition = Math.min(newCursorPosition, formatted.length);
                                    newRange.setStart(textNode, finalPosition);
                                    newRange.setEnd(textNode, finalPosition);
                                    selection.removeAllRanges();
                                    selection.addRange(newRange);
                                }
                            } catch (e) {
                                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é, —Å—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
                                const newRange = document.createRange();
                                newRange.selectNodeContents(cell);
                                newRange.collapse(false);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                        });
                    }
                });
            }

            cell.addEventListener('blur', () => {
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                cell.contentEditable = 'false';
                
                const originalValue = cell.dataset.originalValue ?? '';
                const newValue = cell.textContent.trim();
                if (newValue === originalValue) {
                    return;
                }
                const row = cell.closest('tr');
                const employeeId = row ? row.dataset.employeeId : null;
                if (!employeeId) {
                    revertCell(cell);
                    showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.', 'error');
                    return;
                }
                const field = cell.dataset.field;
                if (!field) {
                    revertCell(cell);
                    return;
                }
                updateEmployeeCell(cell, employeeId, field, newValue);
            });
        });

        const roleDropdown = document.createElement('div');
        roleDropdown.className = 'role-dropdown';
        document.body.appendChild(roleDropdown);

        function populateRoleDropdown() {
            roleDropdown.innerHTML = '';
            Object.entries(roleOptionsMap).forEach(([value, label]) => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                if (!value || value.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = value;
                option.textContent = label || value;
                option.addEventListener('click', () => {
                    const targetCell = currentRoleCell;
                    if (!targetCell) return;
                    if (targetCell.dataset.roleValue === value) {
                        closeRoleDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.roleValue || '';
                    updateEmployeeCell(targetCell, employeeId, 'role', value);
                    closeRoleDropdown();
                });
                roleDropdown.appendChild(option);
            });
        }

        function positionRoleDropdown(cell) {
            if (!cell || !roleDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º offsetWidth –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã —è—á–µ–π–∫–∏
            // offsetWidth –≤–∫–ª—é—á–∞–µ—Ç padding –∏ border, —á—Ç–æ –¥–∞—ë—Ç —Ç–æ—á–Ω—É—é —à–∏—Ä–∏–Ω—É
            const cellWidth = cell.offsetWidth;
            
            // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º rect.width –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const rectWidth = rect.width;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
            const finalWidth = Math.max(cellWidth, rectWidth);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É dropdown
            const dropdownHeight = roleDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã, —É—á–∏—Ç—ã–≤–∞–µ–º –µ–≥–æ –≥—Ä–∞–Ω–∏—Ü—ã
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –Ω–∏–∂–µ —è—á–µ–π–∫–∏
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ª–∏ dropdown –≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–≤–µ—Ä—Ö, –µ—Å–ª–∏ –º–µ—Å—Ç–∞ –≤–Ω–∏–∑—É –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏ –º–µ—Å—Ç–∞ –≤–≤–µ—Ä—Ö—É –±–æ–ª—å—à–µ
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
            roleDropdown.style.position = 'fixed';
            if (openUpward) {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–≤–µ—Ä—Ö
                roleDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                roleDropdown.style.top = 'auto';
            } else {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–Ω–∏–∑ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                roleDropdown.style.top = `${rect.bottom + 6}px`;
                roleDropdown.style.bottom = 'auto';
            }
            roleDropdown.style.left = `${rect.left}px`;
            roleDropdown.style.width = `${finalWidth}px`;
            roleDropdown.style.minWidth = `${finalWidth}px`;
            roleDropdown.style.maxWidth = `${finalWidth}px`;
            roleDropdown.style.boxSizing = 'border-box';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã
            roleDropdown.style.flexShrink = '0';
            roleDropdown.style.flexGrow = '0';
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–ø—Ü–∏–∏ –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É
            const options = roleDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.roleValue);
            });
        }

        function openRoleDropdown(cell) {
            currentRoleCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateRoleDropdown();
            roleDropdown.classList.add('visible');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–æ–π–Ω–æ–π requestAnimationFrame –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π DOM
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionRoleDropdown(cell);
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ dropdown –ø–æ–ª—É—á–∏–ª —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É
                    requestAnimationFrame(() => {
                        positionRoleDropdown(cell);
                    });
                });
            });
        }

        function closeRoleDropdown() {
            if (currentRoleCell) {
                currentRoleCell.setAttribute('aria-expanded', 'false');
            }
            currentRoleCell = null;
            roleDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (roleDropdown.contains(event.target)) return;
            if (event.target.closest('.role-cell')) return;
            closeRoleDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentRoleCell) {
                requestAnimationFrame(() => {
                    positionRoleDropdown(currentRoleCell);
                });
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –∑–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
        window.addEventListener('scroll', () => {
            if (currentRoleCell && roleDropdown.classList.contains('visible')) {
                closeRoleDropdown();
            }
        }, true);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ —Ç–∞–±–ª–∏—Ü—ã - –∑–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
            tableContainer.addEventListener('scroll', () => {
                if (currentRoleCell && roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                }
            });
        }

        roleCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentRoleCell === cell && roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                } else {
                    openRoleDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.roleValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openRoleDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeRoleDropdown();
                    cell.blur();
                }
            });
        });

        // –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
        const facilityCells = document.querySelectorAll('.facility-cell');
        const facilityDropdown = document.createElement('div');
        facilityDropdown.className = 'role-dropdown';
        document.body.appendChild(facilityDropdown);
        let currentFacilityCell = null;

        function populateFacilityDropdown() {
            facilityDropdown.innerHTML = '';
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º facilityOptionsMap –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
            Object.keys(facilityOptionsMap).forEach(facilityName => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                if (!facilityName || facilityName.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = facilityName;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–∞–ø—Ä—è–º—É—é
                option.textContent = facilityName;
                option.addEventListener('click', () => {
                    const targetCell = currentFacilityCell;
                    if (!targetCell) return;
                    if (targetCell.dataset.facilityValue === facilityName) {
                        closeFacilityDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.facilityValue || '';
                    updateEmployeeCell(targetCell, employeeId, 'facility', facilityName);
                    closeFacilityDropdown();
                });
                facilityDropdown.appendChild(option);
            });
        }

        function positionFacilityDropdown(cell) {
            if (!cell || !facilityDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            const cellWidth = cell.offsetWidth;
            const rectWidth = rect.width;
            const finalWidth = Math.max(cellWidth, rectWidth);
            const dropdownHeight = facilityDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            facilityDropdown.style.position = 'fixed';
            if (openUpward) {
                facilityDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                facilityDropdown.style.top = 'auto';
            } else {
                facilityDropdown.style.top = `${rect.bottom + 6}px`;
                facilityDropdown.style.bottom = 'auto';
            }
            facilityDropdown.style.left = `${rect.left}px`;
            facilityDropdown.style.width = `${finalWidth}px`;
            facilityDropdown.style.minWidth = `${finalWidth}px`;
            facilityDropdown.style.maxWidth = `${finalWidth}px`;
            facilityDropdown.style.boxSizing = 'border-box';
            facilityDropdown.style.flexShrink = '0';
            facilityDropdown.style.flexGrow = '0';
            
            const options = facilityDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.facilityValue);
            });
        }

        function openFacilityDropdown(cell) {
            currentFacilityCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateFacilityDropdown();
            facilityDropdown.classList.add('visible');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionFacilityDropdown(cell);
                    requestAnimationFrame(() => {
                        positionFacilityDropdown(cell);
                    });
                });
            });
        }

        function closeFacilityDropdown() {
            if (currentFacilityCell) {
                currentFacilityCell.setAttribute('aria-expanded', 'false');
            }
            currentFacilityCell = null;
            facilityDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (facilityDropdown.contains(event.target)) return;
            if (event.target.closest('.facility-cell')) return;
            closeFacilityDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentFacilityCell) {
                requestAnimationFrame(() => {
                    positionFacilityDropdown(currentFacilityCell);
                });
            }
        });

        window.addEventListener('scroll', () => {
            if (currentFacilityCell && facilityDropdown.classList.contains('visible')) {
                closeFacilityDropdown();
            }
        }, true);

        const tableContainerFacility = document.querySelector('.table-container');
        if (tableContainerFacility) {
            tableContainerFacility.addEventListener('scroll', () => {
                if (currentFacilityCell && facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                }
            });
        }

        facilityCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentFacilityCell === cell && facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                } else {
                    openFacilityDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.facilityValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openFacilityDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeFacilityDropdown();
                    cell.blur();
                }
            });
        });

        // –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏")
        // –ò—Å–∫–ª—é—á–∞–µ–º —è—á–µ–π–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        const departmentCells = document.querySelectorAll('.department-cell:not(#equipmentTable .department-cell)');
        const departmentDropdown = document.createElement('div');
        departmentDropdown.className = 'role-dropdown';
        document.body.appendChild(departmentDropdown);
        let currentDepartmentCell = null;

        function populateDepartmentDropdown(cell) {
            departmentDropdown.innerHTML = '';
            const facilityName = cell.dataset.facilityName || '';
            const departments = departmentsByFacility[facilityName] || [];
            
            departments.forEach(dept => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–¥–µ–ª—ã –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
                if (!dept || !dept.name || dept.name.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = dept.id;
                option.textContent = dept.name;
                option.addEventListener('click', () => {
                    const targetCell = currentDepartmentCell;
                    if (!targetCell) return;
                    const currentId = targetCell.dataset.departmentId || '';
                    if (currentId === String(dept.id)) {
                        closeDepartmentDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.departmentId || '';
                    updateEmployeeCell(targetCell, employeeId, 'department_id', dept.id);
                    closeDepartmentDropdown();
                });
                departmentDropdown.appendChild(option);
            });
        }

        function positionDepartmentDropdown(cell) {
            if (!cell || !departmentDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            const cellWidth = cell.offsetWidth;
            const rectWidth = rect.width;
            const finalWidth = Math.max(cellWidth, rectWidth);
            const dropdownHeight = departmentDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            departmentDropdown.style.position = 'fixed';
            if (openUpward) {
                departmentDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                departmentDropdown.style.top = 'auto';
            } else {
                departmentDropdown.style.top = `${rect.bottom + 6}px`;
                departmentDropdown.style.bottom = 'auto';
            }
            departmentDropdown.style.left = `${rect.left}px`;
            departmentDropdown.style.width = `${finalWidth}px`;
            departmentDropdown.style.minWidth = `${finalWidth}px`;
            departmentDropdown.style.maxWidth = `${finalWidth}px`;
            departmentDropdown.style.boxSizing = 'border-box';
            departmentDropdown.style.flexShrink = '0';
            departmentDropdown.style.flexGrow = '0';
            
            const options = departmentDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.departmentId);
            });
        }

        function openDepartmentDropdown(cell) {
            currentDepartmentCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateDepartmentDropdown(cell);
            departmentDropdown.classList.add('visible');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionDepartmentDropdown(cell);
                    requestAnimationFrame(() => {
                        positionDepartmentDropdown(cell);
                    });
                });
            });
        }

        function closeDepartmentDropdown() {
            if (currentDepartmentCell) {
                currentDepartmentCell.setAttribute('aria-expanded', 'false');
            }
            currentDepartmentCell = null;
            departmentDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ dropdown –∏–ª–∏ –Ω–∞ —è—á–µ–π–∫–µ –æ—Ç–¥–µ–ª–∞
            if (departmentDropdown.contains(event.target)) return;
            if (event.target.closest('.department-cell')) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ dropdown (–¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞)
            if (departmentDropdown.classList.contains('visible')) {
                const rect = departmentDropdown.getBoundingClientRect();
                const x = event.clientX;
                const y = event.clientY;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –æ–±–ª–∞—Å—Ç–∏ dropdown (–≤–∫–ª—é—á–∞—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä)
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return;
                }
            }
            
            closeDepartmentDropdown();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ dropdown - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ
        departmentDropdown.addEventListener('wheel', (event) => {
            event.stopPropagation();
        }, { passive: true });

        departmentDropdown.addEventListener('scroll', (event) => {
            event.stopPropagation();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ –≤–Ω—É—Ç—Ä–∏ dropdown - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ
        departmentDropdown.addEventListener('mousedown', (event) => {
            event.stopPropagation();
        });

        departmentDropdown.addEventListener('mouseup', (event) => {
            event.stopPropagation();
        });

        departmentDropdown.addEventListener('click', (event) => {
            event.stopPropagation();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ touch —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        departmentDropdown.addEventListener('touchstart', (event) => {
            event.stopPropagation();
        }, { passive: true });

        departmentDropdown.addEventListener('touchmove', (event) => {
            event.stopPropagation();
        }, { passive: true });

        window.addEventListener('resize', () => {
            if (currentDepartmentCell && departmentDropdown.classList.contains('visible')) {
                requestAnimationFrame(() => {
                    positionDepartmentDropdown(currentDepartmentCell);
                });
            }
        });

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –æ–∫–Ω–∞, –Ω–æ –Ω–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≤–Ω—É—Ç—Ä–∏ dropdown
        window.addEventListener('scroll', (event) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ dropdown
            if (departmentDropdown.contains(event.target)) return;
            if (currentDepartmentCell && departmentDropdown.classList.contains('visible')) {
                closeDepartmentDropdown();
            }
        }, true);

        const tableContainerDepartment = document.querySelector('.table-container');
        if (tableContainerDepartment) {
            tableContainerDepartment.addEventListener('scroll', (event) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ dropdown
                if (departmentDropdown.contains(event.target)) return;
                if (currentDepartmentCell && departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                }
            });
        }

        departmentCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentDepartmentCell === cell && departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                } else {
                    openDepartmentDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.departmentId || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openDepartmentDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeDepartmentDropdown();
                    cell.blur();
                }
            });
        });

        filterSelectWrappers.forEach(wrapper => {
            const targetId = wrapper.dataset.target;
            const selectEl = document.getElementById(targetId);
            if (!selectEl) return;
            const button = wrapper.querySelector('.filter-select-btn');
            const labelEl = wrapper.querySelector('.filter-select-label');
            const optionButtons = wrapper.querySelectorAll('.filter-option');
            const resetBtn = document.querySelector(`.filter-reset-btn[data-target="${targetId}"]`);

            const syncUI = () => {
                const value = selectEl.value || '';
                const matchedOption = Array.from(selectEl.options).find(opt => opt.value === value);
                const labelText = matchedOption ? matchedOption.textContent : optionButtons[0]?.textContent || '–í—Å–µ';
                if (labelEl) labelEl.textContent = labelText;
                optionButtons.forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.value === value);
                });
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
                if (resetBtn) {
                    resetBtn.style.display = value ? 'flex' : 'none';
                }
            };

            optionButtons.forEach(btn => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const value = btn.dataset.value || '';
                    if (selectEl.value !== value) {
                        selectEl.value = value;
                        selectEl.dispatchEvent(new Event('change'));
                    } else {
                        selectEl.dispatchEvent(new Event('change'));
                    }
                    syncUI();
                    closeFilterSelectMenus();
                });
            });

            if (button) {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const isOpen = wrapper.classList.contains('open');
                    closeFilterSelectMenus();
                    if (!isOpen) {
                        wrapper.classList.add('open');
                        button.setAttribute('aria-expanded', 'true');
                    }
                });
            }

            selectEl.addEventListener('change', syncUI);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–±—Ä–æ—Å–∞
            if (resetBtn) {
                resetBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    selectEl.value = '';
                    selectEl.dispatchEvent(new Event('change'));
                    syncUI();
                    closeFilterSelectMenus();
                });
            }

            syncUI();
            filterSelectControllers.set(selectEl, { sync: syncUI });
        });

        document.addEventListener('click', (event) => {
            if (!event.target.closest('.filter-select')) {
                closeFilterSelectMenus();
            }
        });

        if (employeeForm) {
            employeeForm.addEventListener('submit', (event) => {
                event.preventDefault();
                if (employeeFormSubmit) {
                    employeeFormSubmit.disabled = true;
                    employeeFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                }
                if (employeeFormError) {
                    employeeFormError.textContent = '';
                }

                const formData = new FormData(employeeForm);
                const payload = {
                    last_name: formData.get('last_name')?.trim(),
                    first_name: formData.get('first_name')?.trim(),
                    patronymic: formData.get('patronymic')?.trim(),
                    post: formData.get('post')?.trim(),
                    phone: formData.get('phone')?.trim(),
                    email: formData.get('email')?.trim(),
                    facility_id: formData.get('facility_id'),
                    department_id: formData.get('department_id'),
                    role: formData.get('role'),
                    login: formData.get('login')?.trim(),
                    password: formData.get('password')?.trim()
                };

                fetch('/admin/employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        closeEmployeeModal();
                        showStatus('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 600);
                    } else {
                        if (employeeFormError) {
                            employeeFormError.textContent = data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
                        }
                    }
                })
                .catch(() => {
                    if (employeeFormError) {
                        employeeFormError.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                    }
                })
                .finally(() => {
                    if (employeeFormSubmit) {
                        employeeFormSubmit.disabled = false;
                        employeeFormSubmit.textContent = submitDefaultText || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    }
                });
            });
        }

        handleFacilityChange();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è dropdown'–æ–≤
        const modalFacilitySelect = document.getElementById('employeeFacilitySelect');
        const modalRoleSelect = document.getElementById('employeeRoleSelect');
        
        if (modalFacilitySelect) {
            modalSelectData.facility = {};
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ option, –¥–∞–∂–µ –µ—Å–ª–∏ select —Å–∫—Ä—ã—Ç
            const facilityOptions = modalFacilitySelect.options || modalFacilitySelect.querySelectorAll('option');
            Array.from(facilityOptions).forEach(opt => {
                if (opt.value !== '') {
                    modalSelectData.facility[opt.value] = opt.textContent.trim();
                }
            });
        }

        if (modalRoleSelect) {
            modalSelectData.role = {};
            const roleOptions = modalRoleSelect.options || modalRoleSelect.querySelectorAll('option');
            Array.from(roleOptions).forEach(opt => {
                if (opt.value !== '') {
                    modalSelectData.role[opt.value] = opt.textContent.trim();
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–¥–µ–ª–∞ (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è)
        modalSelectData.department = {};

        function populateModalDropdown(field, options) {
            if (!modalDropdown || !options || Object.keys(options).length === 0) {
                return;
            }
            
            modalDropdown.innerHTML = '';
            Object.entries(options).forEach(([value, label]) => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = value;
                option.textContent = label || value || '‚Äî';
                option.addEventListener('click', () => {
                    if (!currentModalSelect) return;
                    const btn = currentModalSelect;
                    const select = btn.parentElement.querySelector('select');
                    const labelSpan = btn.querySelector('.modal-select-label');
                    
                    if (select && labelSpan) {
                        select.value = value;
                        labelSpan.textContent = label;
                        btn.setAttribute('aria-expanded', 'false');
                        
                        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º change —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—ã
                        const btnField = btn.dataset.field;
                        if (btnField === 'facility_id') {
                            handleFacilityChange();
                        }
                    }
                    closeModalDropdown();
                });
                modalDropdown.appendChild(option);
            });
        }

        function positionModalDropdown(btn) {
            if (!btn || !modalDropdown) return;
            const rect = btn.getBoundingClientRect();
            const dropdownHeight = modalDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
            
            modalDropdown.style.position = 'fixed';
            if (openUpward) {
                modalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                modalDropdown.style.top = 'auto';
            } else {
                modalDropdown.style.top = `${rect.bottom + 6}px`;
                modalDropdown.style.bottom = 'auto';
            }
            modalDropdown.style.left = `${rect.left}px`;
            modalDropdown.style.width = `${rect.width}px`;
            modalDropdown.style.minWidth = `${rect.width}px`;
            modalDropdown.style.maxWidth = `${rect.width}px`;
        }

        function openModalDropdown(btn) {
            if (!btn || btn.disabled) return;
            const field = btn.dataset.field;
            if (!field) return;
            
            // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –∫ –∫–ª—é—á–∞–º –≤ modalSelectData
            const fieldMap = {
                'facility_id': 'facility',
                'department_id': 'department',
                'role': 'role'
            };
            
            const dataKey = fieldMap[field] || field;
            if (!dataKey || !modalSelectData || !modalSelectData[dataKey] || Object.keys(modalSelectData[dataKey]).length === 0) {
                return;
            }
            
            currentModalSelect = btn;
            populateModalDropdown(field, modalSelectData[dataKey]);
            
            // –ñ–¥—ë–º, –ø–æ–∫–∞ dropdown –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è, –∑–∞—Ç–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º
            requestAnimationFrame(() => {
                positionModalDropdown(btn);
                modalDropdown.classList.add('visible');
                btn.setAttribute('aria-expanded', 'true');
            });
        }

        function closeModalDropdown() {
            if (!modalDropdown) return;
            modalDropdown.classList.remove('visible');
            if (currentModalSelect) {
                currentModalSelect.setAttribute('aria-expanded', 'false');
                currentModalSelect = null;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ dropdown'–æ–≤
        const modalFacilityBtn = document.getElementById('modalFacilityBtn');
        const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
        const modalRoleBtn = document.getElementById('modalRoleBtn');

        [modalFacilityBtn, modalDepartmentBtn, modalRoleBtn].forEach(btn => {
            if (!btn) return;
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (btn.disabled) return;
                
                if (currentModalSelect === btn) {
                    closeModalDropdown();
                } else {
                    closeModalDropdown();
                    openModalDropdown(btn);
                }
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ dropdown'–∞
        document.addEventListener('click', (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –≤–Ω—É—Ç—Ä–∏ dropdown'–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            if (!modalDropdown.contains(e.target) && 
                !e.target.closest('.modal-select-btn')) {
                closeModalDropdown();
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–∞–∫–∂–µ dropdown –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –∏ –∫–ª–∏–∫ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ
            if (typeof closeEquipmentModalDropdown === 'function') {
                const equipmentModalDropdown = document.getElementById('modalDropdown');
                if (equipmentModalDropdown && equipmentModalDropdown.classList.contains('visible')) {
                    if (!equipmentModalDropdown.contains(e.target) && 
                        !e.target.closest('.modal-select-btn') &&
                        !e.target.closest('#equipmentModal')) {
                        closeEquipmentModalDropdown();
                    }
                }
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalDropdown.classList.contains('visible')) {
                closeModalDropdown();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        const deleteEmployeeModal = document.getElementById('deleteEmployeeModal');
        const deleteEmployeeClose = document.getElementById('deleteEmployeeModalClose');
        const deleteEmployeeCancel = document.getElementById('deleteEmployeeCancel');
        const deleteEmployeeConfirm = document.getElementById('deleteEmployeeConfirm');
        const deleteEmployeeMessage = document.getElementById('deleteEmployeeMessage');
        let employeeToDelete = null;
        let employeeToDeleteRow = null;

        function openDeleteModal(employeeId, employeeRow) {
            if (!deleteEmployeeModal) return;
            
            employeeToDelete = employeeId;
            employeeToDeleteRow = employeeRow;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
            const lastName = employeeRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
            const firstName = employeeRow.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
            const patronymic = employeeRow.querySelector('td:nth-child(4)')?.textContent?.trim() || '';
            
            const fullName = [lastName, firstName, patronymic].filter(Boolean).join(' ') || '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
            if (deleteEmployeeMessage) {
                deleteEmployeeMessage.innerHTML = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${fullName}"?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em>`;
            }
            
            deleteEmployeeModal.setAttribute('aria-hidden', 'false');
            deleteEmployeeModal.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeDeleteModal() {
            if (!deleteEmployeeModal) {
                console.warn('deleteEmployeeModal –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            try {
                deleteEmployeeModal.setAttribute('aria-hidden', 'true');
                deleteEmployeeModal.classList.remove('visible');
                if (document.body) {
                    document.body.classList.remove('modal-open');
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å"
                if (deleteEmployeeConfirm) {
                    deleteEmployeeConfirm.disabled = false;
                    deleteEmployeeConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                }
                
                employeeToDelete = null;
                employeeToDeleteRow = null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error);
            }
        }

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        let employeeContextMenu = null;
        let selectedEmployeeRow = null;
        const employeeTable = document.querySelector('.data-table');

        function createEmployeeContextMenu() {
            if (employeeContextMenu) return employeeContextMenu;
            
            employeeContextMenu = document.createElement('div');
            employeeContextMenu.className = 'context-menu';
            employeeContextMenu.innerHTML = `
                <button type="button" class="context-menu-item danger" id="employeeDeleteBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    –£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                </button>
            `;
            document.body.appendChild(employeeContextMenu);
            
            const deleteBtn = document.getElementById('employeeDeleteBtn');
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    if (selectedEmployeeRow) {
                        const employeeId = selectedEmployeeRow.dataset.employeeId;
                        if (employeeId) {
                            openDeleteModal(parseInt(employeeId), selectedEmployeeRow);
                        }
                    }
                    hideEmployeeContextMenu();
                });
            }
            
            return employeeContextMenu;
        }

        function showEmployeeContextMenu(event, row) {
            event.preventDefault();
            event.stopPropagation();
            
            const menu = createEmployeeContextMenu();
            selectedEmployeeRow = row;
            
            const tableContainer = document.querySelector('.table-container');
            if (!tableContainer) return;
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
            menu.style.display = 'block';
            menu.style.visibility = 'hidden';
            menu.style.left = '0px';
            menu.style.top = '0px';
            
            const containerRect = tableContainer.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
            let left = event.clientX;
            let top = event.clientY;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (left + menuRect.width > containerRect.right) {
                left = containerRect.right - menuRect.width - 10;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ª–µ–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (left < containerRect.left) {
                left = containerRect.left + 10;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (top + menuRect.height > containerRect.bottom) {
                top = containerRect.bottom - menuRect.height - 10;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (top < containerRect.top) {
                top = containerRect.top + 10;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∏ –¥–µ–ª–∞–µ–º –º–µ–Ω—é –≤–∏–¥–∏–º—ã–º
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.visibility = 'visible';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            setTimeout(() => {
                document.addEventListener('click', hideEmployeeContextMenu, { once: true });
            }, 0);
        }

        function hideEmployeeContextMenu() {
            if (employeeContextMenu) {
                employeeContextMenu.style.display = 'none';
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –∏ –ü–ö–ú –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —è—á–µ–µ–∫
        if (employeeTable) {
            const tbody = employeeTable.querySelector('tbody');
            if (tbody) {
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                function getAllEmployeeRows() {
                    return employeeTable ? employeeTable.querySelectorAll('tbody tr') : [];
                }
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –Ω–∞ —è—á–µ–π–∫–∞—Ö)
                function updateSelectedRowBorder() {
                    // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –Ω–∞ —è—á–µ–π–∫–∞—Ö, –ø–æ—ç—Ç–æ–º—É —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞
                }
                
                // –û–¥–∏–Ω–∞—Ä–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                tbody.addEventListener('click', (e) => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º —è—á–µ–π–∫–∞–º
                    if (e.target.closest('.editable-cell[contenteditable="true"]')) {
                        return;
                    }
                    
                    const row = e.target.closest('tr');
                    if (row) {
                        // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞, —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        if (row.classList.contains('selected')) {
                            row.classList.remove('selected');
                        } else {
                            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                            getAllEmployeeRows().forEach(r => r.classList.remove('selected'));
                            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                            row.classList.add('selected');
                        }
                    }
                });
                
                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã
                document.addEventListener('click', (e) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ —Ç–∞–±–ª–∏—Ü–µ –∏ –Ω–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º—É –º–µ–Ω—é
                    if (!employeeTable.contains(e.target) && 
                        !(employeeContextMenu && employeeContextMenu.contains(e.target))) {
                        getAllEmployeeRows().forEach(r => r.classList.remove('selected'));
                    }
                });
                
                // –ü–ö–ú - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø–æ–∫–∞–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                tbody.addEventListener('contextmenu', (e) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ —Å—Ç—Ä–æ–∫–µ, –∞ –Ω–µ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —è—á–µ–π–∫–µ
                    const contextRow = e.target.closest('tr');
                    if (contextRow && !e.target.closest('.editable-cell[contenteditable="true"]')) {
                        e.preventDefault();
                        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                        getAllEmployeeRows().forEach(r => r.classList.remove('selected'));
                        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                        contextRow.classList.add('selected');
                        showEmployeeContextMenu(e, contextRow);
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                window.addEventListener('resize', updateSelectedRowBorder);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        if (deleteEmployeeClose) {
            deleteEmployeeClose.addEventListener('click', closeDeleteModal);
        }
        if (deleteEmployeeCancel) {
            deleteEmployeeCancel.addEventListener('click', closeDeleteModal);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
        if (deleteEmployeeModal) {
            deleteEmployeeModal.addEventListener('click', (event) => {
                if (event.target === deleteEmployeeModal) {
                    closeDeleteModal();
                }
            });
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        if (deleteEmployeeConfirm) {
            deleteEmployeeConfirm.addEventListener('click', async () => {
                if (!employeeToDelete) return;
                
                deleteEmployeeConfirm.disabled = true;
                deleteEmployeeConfirm.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
                
                try {
                    const response = await fetch(`/admin/employees/${employeeToDelete}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞:', parseError);
                        // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        if (!employeeToDeleteRow || !document.contains(employeeToDeleteRow)) {
                            closeDeleteModal();
                            return;
                        }
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    if (data.success) {
                        // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                        if (employeeToDeleteRow && document.contains(employeeToDeleteRow)) {
                            employeeToDeleteRow.remove();
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é —Å—Ç—Ä–æ–∫
                            document.querySelectorAll('.data-table tbody tr').forEach((row, index) => {
                                const numberCell = row.querySelector('.number-column');
                                if (numberCell) {
                                    numberCell.textContent = index + 1;
                                }
                            });
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                            if (typeof showStatus === 'function') {
                                showStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                            }
                        }
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        closeDeleteModal();
                    } else {
                        if (typeof showStatus === 'function') {
                            showStatus(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error');
                        }
                        deleteEmployeeConfirm.disabled = false;
                        deleteEmployeeConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', error);
                    // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    if (!employeeToDeleteRow || !document.contains(employeeToDeleteRow)) {
                        closeDeleteModal();
                        return;
                    }
                    if (typeof showStatus === 'function') {
                        showStatus('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error');
                    }
                    deleteEmployeeConfirm.disabled = false;
                    deleteEmployeeConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (employeeContextMenu && employeeContextMenu.style.display === 'block') {
                    hideEmployeeContextMenu();
                    return;
                }
                if (roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                    return;
                }
                if (facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                    return;
                }
                if (departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                    return;
                }
                if (deleteEmployeeModal && deleteEmployeeModal.classList.contains('visible')) {
                    closeDeleteModal();
                    return;
                }
                if (activeModal) {
                    closeEmployeeModal();
                }
            }
        });

        applyTableFilters();
        {% endif %}

        {% if section == 'warehouse' %}
        // JavaScript –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∫–ª–∞–¥–∞
        const warehouseSearchInput = document.getElementById('warehouseSearch');
        const warehouseFilterToggle = document.getElementById('warehouseFilterToggle');
        const warehouseFilterDropdown = document.getElementById('warehouseFilterDropdown');
        const facilityWarehouseFilter = document.getElementById('facilityWarehouseFilter');
        const warehouseAddressFilter = document.getElementById('warehouseAddressFilter');
        const sparePartFilter = document.getElementById('sparePartFilter');
        const warehouseSortColumnFilter = document.getElementById('warehouseSortColumnFilter');
        const warehouseSortDirectionFilter = document.getElementById('warehouseSortDirectionFilter');
        const warehouseTableRows = document.querySelectorAll('.data-table tbody tr');
        const warehouseResetFiltersBtn = document.getElementById('warehouseResetFilters');
        const addPartBtn = document.getElementById('addPartBtn');
        const partModal = document.getElementById('partModal');
        const partModalClose = document.getElementById('partModalClose');
        const partModalCancel = document.getElementById('partModalCancel');
        const partForm = document.getElementById('partForm');
        const partFormError = document.getElementById('partFormError');
        const partFormSubmit = document.getElementById('partFormSubmit');
        const partFacilitySelect = document.getElementById('partFacilitySelect');
        const partWarehouseSelect = document.getElementById('partWarehouseSelect');
        const modalPartFacilityBtn = document.getElementById('modalPartFacilityBtn');
        const modalPartWarehouseBtn = document.getElementById('modalPartWarehouseBtn');
        const modalPartTypeBtn = document.getElementById('modalPartTypeBtn');
        const partTypeSelect = document.getElementById('partTypeSelect');
        const customPartTypeRow = document.getElementById('customPartTypeRow');
        const customPartType = document.getElementById('customPartType');
        const partQuantityInput = document.getElementById('partQuantity');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        let selectedWarehouseRow = null;
        let warehouseContextMenu = null;
        const warehouseTable = document.querySelector('.data-table');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è
        const deleteWarehouseModal = document.getElementById('deleteWarehouseModal');
        const deleteWarehouseClose = document.getElementById('deleteWarehouseModalClose');
        const deleteWarehouseCancel = document.getElementById('deleteWarehouseCancel');
        const deleteWarehouseConfirm = document.getElementById('deleteWarehouseConfirm');
        const deleteWarehouseMessage = document.getElementById('deleteWarehouseMessage');
        let warehouseToDelete = null;
        let warehouseToDeleteRow = null;
        
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const warehousesData = {{ warehouse_choices|tojson }};
        const warehouseFacilityMap = {};
        warehousesData.forEach(wh => {
            const facilityId = wh.facility_id ? String(wh.facility_id) : '';
            if (facilityId) {
                if (!warehouseFacilityMap[facilityId]) {
                    warehouseFacilityMap[facilityId] = [];
                }
                warehouseFacilityMap[facilityId].push({
                    id: String(wh.id),
                    name: wh.department || wh.type || '‚Äî'
                });
            }
        });

        function applyWarehouseRowStriping() {
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ DOM –∫–∞–∂–¥—ã–π —Ä–∞–∑
            if (!warehouseTable) return;
            const rows = warehouseTable.querySelectorAll('tbody tr');
            let visibleIndex = 0;
            rows.forEach(row => {
                if (row.style.display === 'none') {
                    row.classList.remove('alt-row');
                    return;
                }
                const isAlt = visibleIndex % 2 === 1;
                row.classList.toggle('alt-row', isAlt);
                visibleIndex += 1;
            });
        }

        function applyWarehouseTableFilters() {
            const searchValue = warehouseSearchInput ? warehouseSearchInput.value.toLowerCase().trim() : '';
            const facilityValue = facilityWarehouseFilter ? facilityWarehouseFilter.value.toLowerCase() : '';
            const warehouseValue = warehouseAddressFilter ? warehouseAddressFilter.value.toLowerCase() : '';
            const sparePartValue = sparePartFilter ? sparePartFilter.value.toLowerCase() : '';

            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ DOM –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if (!warehouseTable) return;
            const rows = warehouseTable.querySelectorAll('tbody tr');
            
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å—Ä–∞–∑—É
            if (!searchValue && !facilityValue && !warehouseValue && !sparePartValue) {
                rows.forEach(row => {
                    row.style.display = '';
                });
                applyWarehouseRowStriping();
                return;
            }

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowFacility = (row.dataset.facility || '').toLowerCase();
                const rowWarehouse = (row.dataset.warehouse || '').toLowerCase();
                const rowSparePart = (row.dataset.sparePart || '').toLowerCase();

                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesFacility = facilityValue === '' || rowFacility === facilityValue;
                const matchesWarehouse = warehouseValue === '' || rowWarehouse === warehouseValue;
                const matchesSparePart = sparePartValue === '' || rowSparePart === sparePartValue;

                row.style.display = (matchesSearch && matchesFacility && matchesWarehouse && matchesSparePart) ? '' : 'none';
            });

            applyWarehouseRowStriping();
        }

        // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞ - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        let warehouseSearchTimeout = null;
        if (warehouseSearchInput) {
            warehouseSearchInput.addEventListener('input', () => {
                clearTimeout(warehouseSearchTimeout);
                warehouseSearchTimeout = setTimeout(() => {
                    applyWarehouseTableFilters();
                }, 150); // –ó–∞–¥–µ—Ä–∂–∫–∞ 150ms –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            });
        }

        [facilityWarehouseFilter, warehouseAddressFilter, sparePartFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', applyWarehouseTableFilters);
            }
        });

        const warehouseFilterSelectWrappers = document.querySelectorAll('#warehouseFilterDropdown .filter-select[data-target]');
        const warehouseFilterSelectControllers = new Map();

        function closeWarehouseFilterSelectMenus() {
            warehouseFilterSelectWrappers.forEach(wrapper => {
                wrapper.classList.remove('open');
                const btn = wrapper.querySelector('.filter-select-btn');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (warehouseFilterToggle && warehouseFilterDropdown) {
            warehouseFilterToggle.addEventListener('click', () => {
                warehouseFilterDropdown.classList.toggle('active');
                warehouseFilterToggle.classList.toggle('active');
                if (!warehouseFilterDropdown.classList.contains('active')) {
                    closeWarehouseFilterSelectMenus();
                }
            });

            document.addEventListener('click', (event) => {
                if (!warehouseFilterDropdown.contains(event.target) && !warehouseFilterToggle.contains(event.target)) {
                    warehouseFilterDropdown.classList.remove('active');
                    warehouseFilterToggle.classList.remove('active');
                    closeWarehouseFilterSelectMenus();
                }
            });
        }

        if (warehouseResetFiltersBtn) {
            warehouseResetFiltersBtn.addEventListener('click', () => {
                if (warehouseSearchInput) warehouseSearchInput.value = '';
                if (facilityWarehouseFilter) facilityWarehouseFilter.value = '';
                if (warehouseAddressFilter) warehouseAddressFilter.value = '';
                if (sparePartFilter) sparePartFilter.value = '';
                if (warehouseSortColumnFilter) warehouseSortColumnFilter.value = '';
                if (warehouseSortDirectionFilter) warehouseSortDirectionFilter.value = 'asc';
                applyWarehouseTableFilters();
                warehouseFilterSelectControllers.forEach(controller => controller.sync());
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–∫–ª–∞–¥–∞
        if (warehouseSortColumnFilter) {
            warehouseSortColumnFilter.addEventListener('change', () => {
                const columnIndex = warehouseSortColumnFilter.value ? parseInt(warehouseSortColumnFilter.value) : null;
                const sortDirection = warehouseSortDirectionFilter ? warehouseSortDirectionFilter.value : 'asc';
                if (columnIndex !== null && warehouseTable) {
                    applyTableSorting(warehouseTable, columnIndex, sortDirection, applyWarehouseTableFilters, applyWarehouseRowStriping);
                } else if (columnIndex === null) {
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫", –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    applyWarehouseTableFilters();
                }
            });
        }

        if (warehouseSortDirectionFilter) {
            warehouseSortDirectionFilter.addEventListener('change', () => {
                const columnIndex = warehouseSortColumnFilter && warehouseSortColumnFilter.value ? parseInt(warehouseSortColumnFilter.value) : null;
                const sortDirection = warehouseSortDirectionFilter.value;
                if (columnIndex !== null && warehouseTable) {
                    applyTableSorting(warehouseTable, columnIndex, sortDirection, applyWarehouseTableFilters, applyWarehouseRowStriping);
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Å–∫–ª–∞–¥–∞
        warehouseFilterSelectWrappers.forEach(wrapper => {
            const targetId = wrapper.dataset.target;
            const nativeSelect = document.getElementById(targetId);
            if (!nativeSelect) return;

            const btn = wrapper.querySelector('.filter-select-btn');
            const label = btn?.querySelector('.filter-select-label');
            const optionsList = wrapper.querySelector('.filter-options-list');
            const resetBtn = wrapper.parentElement.querySelector('.filter-reset-btn');

            function syncSelect() {
                const selectedOption = nativeSelect.options[nativeSelect.selectedIndex];
                const selectedValue = nativeSelect.value;
                const selectedText = selectedOption ? selectedOption.textContent : '–í—Å–µ';

                if (label) {
                    label.textContent = selectedText;
                }

                if (resetBtn) {
                    resetBtn.style.display = selectedValue ? '' : 'none';
                }

                if (optionsList) {
                    optionsList.querySelectorAll('.filter-option').forEach(opt => {
                        opt.classList.toggle('selected', opt.dataset.value === selectedValue);
                    });
                }
            }

            function selectOption(value) {
                nativeSelect.value = value;
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                syncSelect();
                closeWarehouseFilterSelectMenus();
            }

            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = wrapper.classList.contains('open');
                    closeWarehouseFilterSelectMenus();
                    if (!isOpen) {
                        wrapper.classList.add('open');
                        btn.setAttribute('aria-expanded', 'true');
                    }
                });
            }

            if (optionsList) {
                optionsList.querySelectorAll('.filter-option').forEach(opt => {
                    opt.addEventListener('click', () => {
                        selectOption(opt.dataset.value);
                    });
                });
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectOption('');
                });
            }

            nativeSelect.addEventListener('change', syncSelect);
            syncSelect();

            warehouseFilterSelectControllers.set(targetId, { sync: syncSelect });
        });

        function openPartModal() {
            if (!partModal) return;
            partModal.classList.add('visible');
            partModal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ dropdown'—ã
            closePartFacilityDropdown();
            closePartWarehouseDropdown();
            if (typeof closePartTypeDropdown === 'function') {
                closePartTypeDropdown();
            }
            
            if (partForm) {
                partForm.reset();
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ dropdown'—ã
            if (modalPartFacilityBtn) {
                const label = modalPartFacilityBtn.querySelector('.modal-select-label');
                if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
            }
            if (modalPartWarehouseBtn) {
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                modalPartWarehouseBtn.disabled = true;
            }
            if (modalPartTypeBtn) {
                const label = modalPartTypeBtn.querySelector('.modal-select-label');
                if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø';
                modalPartTypeBtn.setAttribute('aria-expanded', 'false');
            }
            if (partTypeSelect) {
                partTypeSelect.value = '';
            }
            if (customPartTypeRow) {
                customPartTypeRow.style.display = 'none';
            }
            if (customPartType) {
                customPartType.value = '';
            }
            
            if (partFacilitySelect) {
                partFacilitySelect.value = '';
                populateWarehouseOptions('');
            }
            if (partFormError) {
                partFormError.textContent = '';
            }
            
            const firstInput = partForm ? partForm.querySelector('input, .modal-select-btn') : null;
            if (firstInput) {
                firstInput.focus();
            }
        }

        function closePartModal() {
            if (!partModal) return;
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ dropdown'—ã
            closePartFacilityDropdown();
            closePartWarehouseDropdown();
            if (typeof closePartTypeDropdown === 'function') {
                closePartTypeDropdown();
            }
            partModal.classList.remove('visible');
            partModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }

        function populateWarehouseOptions(facilityId) {
            if (!partWarehouseSelect) return;
            
            partWarehouseSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
            placeholder.disabled = !facilityId;
            placeholder.selected = true;
            partWarehouseSelect.appendChild(placeholder);

            if (!facilityId) {
                partWarehouseSelect.disabled = true;
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.disabled = true;
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                return;
            }

            const warehouses = warehouseFacilityMap[facilityId] || [];
            if (warehouses.length === 0) {
                placeholder.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç —Å–∫–ª–∞–¥–æ–≤';
                partWarehouseSelect.disabled = true;
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.disabled = true;
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç —Å–∫–ª–∞–¥–æ–≤';
                    }
                }
                return;
            }
            
            warehouses.forEach(wh => {
                const option = document.createElement('option');
                option.value = wh.id;
                option.textContent = wh.name;
                partWarehouseSelect.appendChild(option);
            });
            partWarehouseSelect.disabled = false;
            if (modalPartWarehouseBtn) {
                modalPartWarehouseBtn.disabled = false;
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥';
                }
            }
        }

        function handlePartFacilityChange() {
            if (!partFacilitySelect) return;
            const facilityId = partFacilitySelect.value;
            populateWarehouseOptions(facilityId);
            if (partWarehouseSelect) {
                partWarehouseSelect.value = '';
            }
            const modalPartWarehouseBtn = document.getElementById('modalPartWarehouseBtn');
            if (modalPartWarehouseBtn) {
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                }
            }
        }

        if (addPartBtn) {
            addPartBtn.addEventListener('click', () => {
                closeWarehouseFilterSelectMenus();
                openPartModal();
            });
        }

        [partModalClose, partModalCancel].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    closePartModal();
                });
            }
        });

        if (partFacilitySelect) {
            partFacilitySelect.addEventListener('change', handlePartFacilityChange);
        }

        // –°–æ–∑–¥–∞—ë–º –∫–∞—Å—Ç–æ–º–Ω—ã–π dropdown –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const partFacilityDropdown = document.createElement('div');
        partFacilityDropdown.className = 'role-dropdown';
        partFacilityDropdown.style.zIndex = '6000';
        document.body.appendChild(partFacilityDropdown);
        
        let currentPartFacilityBtn = null;

        function populatePartFacilityDropdown() {
            if (!partFacilitySelect || !partFacilityDropdown) return;
            
            partFacilityDropdown.innerHTML = '';
            const facilityOptions = partFacilitySelect.options || partFacilitySelect.querySelectorAll('option');
            
            Array.from(facilityOptions).forEach(opt => {
                if (opt.value === '') return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º placeholder
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = opt.value;
                option.textContent = opt.textContent.trim();
                
                option.addEventListener('click', () => {
                    const value = option.dataset.value;
                    const label = option.textContent;
                    
                    if (partFacilitySelect) {
                        partFacilitySelect.value = value;
                        partFacilitySelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    if (currentPartFacilityBtn) {
                        const labelSpan = currentPartFacilityBtn.querySelector('.modal-select-label');
                        if (labelSpan) {
                            labelSpan.textContent = label;
                        }
                        currentPartFacilityBtn.setAttribute('aria-expanded', 'false');
                    }
                    
                    closePartFacilityDropdown();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤
                    if (handlePartFacilityChange) {
                        handlePartFacilityChange();
                    }
                });
                
                partFacilityDropdown.appendChild(option);
            });
        }

        function openPartFacilityDropdown(btn) {
            if (!btn || !partFacilityDropdown) return;
            
            if (currentPartFacilityBtn === btn && partFacilityDropdown.classList.contains('visible')) {
                closePartFacilityDropdown();
                return;
            }
            
            currentPartFacilityBtn = btn;
            populatePartFacilityDropdown();
            
            const rect = btn.getBoundingClientRect();
            partFacilityDropdown.style.position = 'fixed';
            partFacilityDropdown.style.left = rect.left + 'px';
            partFacilityDropdown.style.top = (rect.bottom + 4) + 'px';
            partFacilityDropdown.style.minWidth = rect.width + 'px';
            partFacilityDropdown.style.maxWidth = '300px';
            partFacilityDropdown.classList.add('visible');
            btn.setAttribute('aria-expanded', 'true');
        }

        function closePartFacilityDropdown() {
            if (!partFacilityDropdown) return;
            partFacilityDropdown.classList.remove('visible');
            if (currentPartFacilityBtn) {
                currentPartFacilityBtn.setAttribute('aria-expanded', 'false');
                currentPartFacilityBtn = null;
            }
        }

        // –ö–∞—Å—Ç–æ–º–Ω—ã–µ dropdown'—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–∫–ª–∞–¥–∞
        if (modalPartFacilityBtn) {
            modalPartFacilityBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                }
                openPartFacilityDropdown(modalPartFacilityBtn);
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modal-select-btn[data-field="facility_id"]') && 
                !partFacilityDropdown.contains(e.target)) {
                closePartFacilityDropdown();
            }
        }, true);

        // –°–æ–∑–¥–∞—ë–º –∫–∞—Å—Ç–æ–º–Ω—ã–π dropdown –¥–ª—è —Å–∫–ª–∞–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const partWarehouseDropdown = document.createElement('div');
        partWarehouseDropdown.className = 'role-dropdown';
        partWarehouseDropdown.style.zIndex = '6000';
        document.body.appendChild(partWarehouseDropdown);
        
        let currentPartWarehouseBtn = null;

        function populatePartWarehouseDropdown() {
            if (!partWarehouseSelect || !partWarehouseDropdown) return;
            
            partWarehouseDropdown.innerHTML = '';
            const warehouseOptions = partWarehouseSelect.options || partWarehouseSelect.querySelectorAll('option');
            
            Array.from(warehouseOptions).forEach(opt => {
                if (opt.value === '' || opt.disabled) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º placeholder –∏ disabled
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = opt.value;
                option.textContent = opt.textContent.trim();
                
                option.addEventListener('click', () => {
                    const value = option.dataset.value;
                    const label = option.textContent;
                    
                    if (partWarehouseSelect) {
                        partWarehouseSelect.value = value;
                        partWarehouseSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    if (currentPartWarehouseBtn) {
                        const labelSpan = currentPartWarehouseBtn.querySelector('.modal-select-label');
                        if (labelSpan) {
                            labelSpan.textContent = label;
                        }
                        currentPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                    }
                    
                    closePartWarehouseDropdown();
                });
                
                partWarehouseDropdown.appendChild(option);
            });
        }

        function openPartWarehouseDropdown(btn) {
            if (!btn || btn.disabled || !partWarehouseDropdown) return;
            
            if (currentPartWarehouseBtn === btn && partWarehouseDropdown.classList.contains('visible')) {
                closePartWarehouseDropdown();
                return;
            }
            
            currentPartWarehouseBtn = btn;
            populatePartWarehouseDropdown();
            
            const rect = btn.getBoundingClientRect();
            partWarehouseDropdown.style.position = 'fixed';
            partWarehouseDropdown.style.left = rect.left + 'px';
            partWarehouseDropdown.style.top = (rect.bottom + 4) + 'px';
            partWarehouseDropdown.style.minWidth = rect.width + 'px';
            partWarehouseDropdown.style.maxWidth = '300px';
            partWarehouseDropdown.classList.add('visible');
            btn.setAttribute('aria-expanded', 'true');
        }

        function closePartWarehouseDropdown() {
            if (!partWarehouseDropdown) return;
            partWarehouseDropdown.classList.remove('visible');
            if (currentPartWarehouseBtn) {
                currentPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                currentPartWarehouseBtn = null;
            }
        }

        if (modalPartWarehouseBtn) {
            modalPartWarehouseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalPartFacilityBtn) {
                    closePartFacilityDropdown();
                }
                openPartWarehouseDropdown(modalPartWarehouseBtn);
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modal-select-btn[data-field="warehouse_id"]') && 
                !partWarehouseDropdown.contains(e.target)) {
                closePartWarehouseDropdown();
            }
        }, true);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫–æ–ª—ë—Å–∏–∫–æ–º –º—ã—à–∏ –¥–ª—è –ø–æ–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        if (partQuantityInput) {
            const quantityWrapper = partQuantityInput.closest('.number-input-wrapper');
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            function handleQuantityWheel(e) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª–µ –≤ —Ñ–æ–∫—É—Å–µ –∏–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞–¥ –ø–æ–ª–µ–º/–æ–±—ë—Ä—Ç–∫–æ–π
                const isOverInput = document.activeElement === partQuantityInput;
                const isOverWrapper = quantityWrapper && quantityWrapper.contains(e.target);
                
                if (isOverInput || isOverWrapper) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const currentValue = parseInt(partQuantityInput.value) || parseInt(partQuantityInput.min) || 1;
                    const minValue = parseInt(partQuantityInput.min) || 1;
                    const step = 1;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                    let newValue;
                    if (e.deltaY < 0) {
                        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
                        newValue = currentValue + step;
                    } else {
                        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ - —É–º–µ–Ω—å—à–∞–µ–º
                        newValue = Math.max(minValue, currentValue - step);
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    partQuantityInput.value = newValue;
                    
                    // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ input –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                    partQuantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∞–º–æ–≥–æ input
            partQuantityInput.addEventListener('wheel', handleQuantityWheel, { passive: false });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±—ë—Ä—Ç–∫–∏ (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–µ–ª–∫–∏)
            if (quantityWrapper) {
                quantityWrapper.addEventListener('wheel', handleQuantityWheel, { passive: false });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–Ω–æ–ø–∫–∏-—Å—Ç—Ä–µ–ª–∫–∏
            if (quantityWrapper) {
                const btnUp = quantityWrapper.querySelector('.number-input-btn-up');
                const btnDown = quantityWrapper.querySelector('.number-input-btn-down');
                
                if (btnUp) {
                    btnUp.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const currentValue = parseInt(partQuantityInput.value) || parseInt(partQuantityInput.min) || 1;
                        const newValue = currentValue + 1;
                        partQuantityInput.value = newValue;
                        partQuantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }
                
                if (btnDown) {
                    btnDown.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const currentValue = parseInt(partQuantityInput.value) || parseInt(partQuantityInput.min) || 1;
                        const minValue = parseInt(partQuantityInput.min) || 1;
                        const newValue = Math.max(minValue, currentValue - 1);
                        partQuantityInput.value = newValue;
                        partQuantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }
            }
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ select
        if (partFacilitySelect) {
            partFacilitySelect.addEventListener('change', () => {
                const selectedOption = partFacilitySelect.options[partFacilitySelect.selectedIndex];
                if (modalPartFacilityBtn) {
                    const label = modalPartFacilityBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                    modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (partWarehouseSelect) {
            partWarehouseSelect.addEventListener('change', () => {
                const selectedOption = partWarehouseSelect.options[partWarehouseSelect.selectedIndex];
                if (modalPartWarehouseBtn) {
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥';
                    }
                    modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –¥–µ—Ç–∞–ª–∏
        if (partTypeSelect) {
            partTypeSelect.addEventListener('change', () => {
                const selectedValue = partTypeSelect.value;
                const selectedOption = partTypeSelect.options[partTypeSelect.selectedIndex];
                
                if (modalPartTypeBtn) {
                    const label = modalPartTypeBtn.querySelector('.modal-select-label');
                    if (label) {
                        if (selectedValue === '__custom__') {
                            label.textContent = '–î—Ä—É–≥–æ–µ';
                            if (customPartTypeRow) customPartTypeRow.style.display = 'flex';
                        } else if (selectedValue) {
                            label.textContent = selectedOption ? selectedOption.textContent : '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø';
                            if (customPartTypeRow) customPartTypeRow.style.display = 'none';
                            if (customPartType) customPartType.value = '';
                        } else {
                            label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø';
                            if (customPartTypeRow) customPartTypeRow.style.display = 'none';
                            if (customPartType) customPartType.value = '';
                        }
                    }
                    modalPartTypeBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // –°–æ–∑–¥–∞—ë–º –∫–∞—Å—Ç–æ–º–Ω—ã–π dropdown –¥–ª—è —Ç–∏–ø–∞ –¥–µ—Ç–∞–ª–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const partTypeDropdown = document.createElement('div');
        partTypeDropdown.className = 'role-dropdown';
        partTypeDropdown.style.zIndex = '6000';
        document.body.appendChild(partTypeDropdown);
        
        let currentPartTypeBtn = null;

        function populatePartTypeDropdown() {
            if (!partTypeSelect || !partTypeDropdown) return;
            
            partTypeDropdown.innerHTML = '';
            const typeOptions = partTypeSelect.options || partTypeSelect.querySelectorAll('option');
            
            Array.from(typeOptions).forEach(opt => {
                if (opt.value === '') return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º placeholder
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = opt.value;
                option.textContent = opt.textContent.trim();
                
                option.addEventListener('click', () => {
                    const value = option.dataset.value;
                    
                    if (partTypeSelect) {
                        partTypeSelect.value = value;
                        partTypeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    closePartTypeDropdown();
                });
                
                partTypeDropdown.appendChild(option);
            });
        }

        function openPartTypeDropdown(btn) {
            if (!btn || !partTypeDropdown) return;
            
            if (currentPartTypeBtn === btn && partTypeDropdown.classList.contains('visible')) {
                closePartTypeDropdown();
                return;
            }
            
            currentPartTypeBtn = btn;
            populatePartTypeDropdown();
            
            const rect = btn.getBoundingClientRect();
            partTypeDropdown.style.position = 'fixed';
            partTypeDropdown.style.left = rect.left + 'px';
            partTypeDropdown.style.top = (rect.bottom + 4) + 'px';
            partTypeDropdown.style.minWidth = rect.width + 'px';
            partTypeDropdown.style.maxWidth = '300px';
            partTypeDropdown.classList.add('visible');
            btn.setAttribute('aria-expanded', 'true');
        }

        function closePartTypeDropdown() {
            if (!partTypeDropdown) return;
            partTypeDropdown.classList.remove('visible');
            if (currentPartTypeBtn) {
                currentPartTypeBtn.setAttribute('aria-expanded', 'false');
                currentPartTypeBtn = null;
            }
        }

        // –ö–∞—Å—Ç–æ–º–Ω—ã–π dropdown –¥–ª—è —Ç–∏–ø–∞ –¥–µ—Ç–∞–ª–∏
        if (modalPartTypeBtn) {
            modalPartTypeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalPartFacilityBtn) {
                    modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
                }
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                }
                openPartTypeDropdown(modalPartTypeBtn);
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modal-select-btn[data-field="spare_part_type"]') && 
                !partTypeDropdown.contains(e.target)) {
                closePartTypeDropdown();
            }
        }, true);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        if (partForm) {
            partForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!partFormSubmit) return;
                partFormSubmit.disabled = true;
                const originalText = partFormSubmit.textContent;
                partFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                
                if (partFormError) {
                    partFormError.textContent = '';
                }

                // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –¥–µ—Ç–∞–ª–∏
                let spare_part_type = partTypeSelect?.value || '';
                if (spare_part_type === '__custom__') {
                    const customTypeInput = document.getElementById('customPartType');
                    spare_part_type = customTypeInput?.value.trim() || '';
                }
                
                const formData = {
                    spare_part_name: document.getElementById('partSparePartName')?.value.trim() || '',
                    spare_part_type: spare_part_type,
                    quantity: document.getElementById('partQuantity')?.value || '',
                    warehouse_id: partWarehouseSelect?.value || ''
                };

                try {
                    const response = await fetch('{{ url_for("admin_warehouse.create_part") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        closePartModal();
                        location.reload();
                    } else {
                        if (partFormError) {
                            partFormError.textContent = data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å';
                        }
                        partFormSubmit.disabled = false;
                        partFormSubmit.textContent = originalText;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏:', error);
                    if (partFormError) {
                        partFormError.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏';
                    }
                    partFormSubmit.disabled = false;
                    partFormSubmit.textContent = originalText;
                }
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        if (partModal) {
            partModal.addEventListener('click', (e) => {
                if (e.target === partModal) {
                    closePartModal();
                }
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ dropdown'—ã
                if (partFacilityDropdown && partFacilityDropdown.classList.contains('visible')) {
                    closePartFacilityDropdown();
                    event.preventDefault();
                    return;
                }
                if (partWarehouseDropdown && partWarehouseDropdown.classList.contains('visible')) {
                    closePartWarehouseDropdown();
                    event.preventDefault();
                    return;
                }
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                if (partModal && partModal.classList.contains('visible')) {
                    closePartModal();
                } else if (deleteWarehouseModal && deleteWarehouseModal.classList.contains('visible')) {
                    closeDeleteWarehouseModal();
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –º–µ–Ω—é
        function createWarehouseContextMenu() {
            if (warehouseContextMenu) return warehouseContextMenu;
            
            warehouseContextMenu = document.createElement('div');
            warehouseContextMenu.className = 'context-menu';
            warehouseContextMenu.innerHTML = `
                <button type="button" class="context-menu-item danger" id="warehouseDeleteBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            `;
            document.body.appendChild(warehouseContextMenu);
            
            const deleteBtn = document.getElementById('warehouseDeleteBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    if (selectedWarehouseRow) {
                        const partId = selectedWarehouseRow.dataset.partId;
                        if (partId) {
                            openDeleteWarehouseModal(parseInt(partId), selectedWarehouseRow);
                        }
                    }
                    hideWarehouseContextMenu();
                });
            }
            
            return warehouseContextMenu;
        }

        function showWarehouseContextMenu(event, row) {
            event.preventDefault();
            event.stopPropagation();
            
            const menu = createWarehouseContextMenu();
            selectedWarehouseRow = row;
            
            const tableContainer = document.querySelector('.table-container');
            if (!tableContainer) return;
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
            menu.style.display = 'block';
            menu.style.visibility = 'hidden';
            menu.style.left = '0px';
            menu.style.top = '0px';
            
            const containerRect = tableContainer.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
            let left = event.clientX;
            let top = event.clientY;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (left + menuRect.width > containerRect.right) {
                left = containerRect.right - menuRect.width - 10;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ª–µ–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (left < containerRect.left) {
                left = containerRect.left + 10;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (top + menuRect.height > containerRect.bottom) {
                top = containerRect.bottom - menuRect.height - 10;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
            if (top < containerRect.top) {
                top = containerRect.top + 10;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
            menu.style.position = 'fixed';
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.visibility = 'visible';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            setTimeout(() => {
                document.addEventListener('click', hideWarehouseContextMenu, { once: true });
            }, 0);
        }

        function hideWarehouseContextMenu() {
            if (warehouseContextMenu) {
                warehouseContextMenu.style.display = 'none';
            }
        }

        function getAllWarehouseRows() {
            return Array.from(document.querySelectorAll('.data-table tbody tr[data-part-id]'));
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        if (warehouseTable) {
            const tbody = warehouseTable.querySelector('tbody');
            if (tbody) {
                // –û–¥–∏–Ω–∞—Ä–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
                tbody.addEventListener('click', (e) => {
                    const target = e.target;
                    // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    if (target.closest('.editable-cell[contenteditable="true"]') ||
                        target.closest('.quantity-input-wrapper') ||
                        target.closest('.quantity-input') ||
                        target.closest('.quantity-input-btn')) {
                        return;
                    }
                    const row = target.closest('tr[data-part-id]');
                    if (!row) return;
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
                    requestAnimationFrame(() => {
                        // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞, —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        if (row.classList.contains('selected')) {
                            row.classList.remove('selected');
                            selectedWarehouseRow = null;
                        } else {
                            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä)
                            if (selectedWarehouseRow && selectedWarehouseRow !== row) {
                                selectedWarehouseRow.classList.remove('selected');
                            }
                            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                            row.classList.add('selected');
                            selectedWarehouseRow = row;
                        }
                    });
                }, { passive: true });
                
                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
                document.addEventListener('click', (e) => {
                    const target = e.target;
                    // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫, –≤—ã—Ö–æ–¥–∏–º
                    if (!selectedWarehouseRow) return;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ —Ç–∞–±–ª–∏—Ü–µ –∏ –Ω–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º—É –º–µ–Ω—é
                    if (!warehouseTable.contains(target) && 
                        !(warehouseContextMenu && warehouseContextMenu.contains(target))) {
                        // –ù–µ —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —è—á–µ–π–∫–µ –∏–ª–∏ quantity input
                        if (target.closest('.editable-cell[contenteditable="true"]') ||
                            target.closest('.quantity-input-wrapper') ||
                            target.closest('.quantity-input') ||
                            target.closest('.quantity-input-btn')) {
                            return;
                        }
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                        requestAnimationFrame(() => {
                            if (selectedWarehouseRow) {
                                selectedWarehouseRow.classList.remove('selected');
                                selectedWarehouseRow = null;
                            }
                        });
                    }
                }, { passive: true });
                
                // –ü–ö–ú - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø–æ–∫–∞–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
                tbody.addEventListener('contextmenu', (e) => {
                    const row = e.target.closest('tr[data-part-id]');
                    if (!row) return;
                    
                    e.preventDefault();
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                    requestAnimationFrame(() => {
                        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                        if (selectedWarehouseRow && selectedWarehouseRow !== row) {
                            selectedWarehouseRow.classList.remove('selected');
                        }
                        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                        row.classList.add('selected');
                        selectedWarehouseRow = row;
                        showWarehouseContextMenu(e, row);
                    });
                });
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && warehouseContextMenu && warehouseContextMenu.style.display === 'block') {
                hideWarehouseContextMenu();
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏—è
        function openDeleteWarehouseModal(partId, partRow) {
            if (!deleteWarehouseModal) return;
            
            warehouseToDelete = partId;
            warehouseToDeleteRow = partRow;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
            const sparePartName = partRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
            const facilityName = partRow.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
            const warehouseName = partRow.querySelector('td:nth-child(4)')?.textContent?.trim() || '';
            const quantity = partRow.querySelector('td:nth-child(5)')?.textContent?.trim() || '';
            
            let message = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?';
            if (sparePartName || warehouseName) {
                const details = [sparePartName, warehouseName].filter(Boolean).join(' (');
                message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å "${details}${details.includes('(') ? ')' : ''}"?`;
            }
            message += '<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em>';
            
            if (deleteWarehouseMessage) {
                deleteWarehouseMessage.innerHTML = message;
            }
            
            deleteWarehouseModal.setAttribute('aria-hidden', 'false');
            deleteWarehouseModal.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeDeleteWarehouseModal() {
            if (!deleteWarehouseModal) return;
            
            deleteWarehouseModal.setAttribute('aria-hidden', 'true');
            deleteWarehouseModal.classList.remove('visible');
            document.body.classList.remove('modal-open');
            warehouseToDelete = null;
            warehouseToDeleteRow = null;
            
            if (deleteWarehouseConfirm) {
                deleteWarehouseConfirm.disabled = false;
                deleteWarehouseConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        if (deleteWarehouseClose) {
            deleteWarehouseClose.addEventListener('click', closeDeleteWarehouseModal);
        }
        if (deleteWarehouseCancel) {
            deleteWarehouseCancel.addEventListener('click', closeDeleteWarehouseModal);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
        if (deleteWarehouseModal) {
            deleteWarehouseModal.addEventListener('click', (event) => {
                if (event.target === deleteWarehouseModal) {
                    closeDeleteWarehouseModal();
                }
            });
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        if (deleteWarehouseConfirm) {
            deleteWarehouseConfirm.addEventListener('click', async () => {
                if (!warehouseToDelete) return;
                
                deleteWarehouseConfirm.disabled = true;
                deleteWarehouseConfirm.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
                
                try {
                    const response = await fetch(`/admin/warehouse/${warehouseToDelete}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞:', parseError);
                        // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        if (!warehouseToDeleteRow || !document.contains(warehouseToDeleteRow)) {
                            closeDeleteWarehouseModal();
                            return;
                        }
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    if (data.success) {
                        // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                        if (warehouseToDeleteRow && document.contains(warehouseToDeleteRow)) {
                            warehouseToDeleteRow.remove();
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é —Å—Ç—Ä–æ–∫
                            document.querySelectorAll('.data-table tbody tr').forEach((row, index) => {
                                const numberCell = row.querySelector('.number-column');
                                if (numberCell) {
                                    numberCell.textContent = index + 1;
                                }
                            });
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫
                            applyWarehouseRowStriping();
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'success');
                                statusBox.textContent = '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞';
                                statusBox.classList.add('visible');
                                setTimeout(() => {
                                    statusBox.classList.remove('visible');
                                }, 3000);
                            }
                        }
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        closeDeleteWarehouseModal();
                    } else {
                        const statusBox = document.getElementById('warehouseTableUpdateStatus');
                        if (statusBox) {
                            statusBox.setAttribute('data-state', 'error');
                            statusBox.textContent = data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å';
                            statusBox.classList.add('visible');
                            setTimeout(() => {
                                statusBox.classList.remove('visible');
                            }, 3000);
                        }
                        deleteWarehouseConfirm.disabled = false;
                        deleteWarehouseConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏:', error);
                    // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    if (!warehouseToDeleteRow || !document.contains(warehouseToDeleteRow)) {
                        closeDeleteWarehouseModal();
                        return;
                    }
                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                    if (statusBox) {
                        statusBox.setAttribute('data-state', 'error');
                        statusBox.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏';
                        statusBox.classList.add('visible');
                        setTimeout(() => {
                            statusBox.classList.remove('visible');
                        }, 3000);
                    }
                    deleteWarehouseConfirm.disabled = false;
                    deleteWarehouseConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                }
            });
        }

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
        const facilityOptionsMap = {};
        {% for fac in facility_choices %}
        facilityOptionsMap[{{ fac.name|tojson }}] = {
            id: {{ fac.id }},
            name: {{ fac.name|tojson }}
        };
        {% endfor %}

        const warehousesByFacility = {};
        const warehousesDataMap = {};
        {% for wh in warehouse_choices %}
        (function() {
            const facilityId = {{ wh.facility_id|tojson }};
            const facilityName = {{ wh.facility|tojson }};
            if (facilityId && facilityName) {
                if (!warehousesByFacility[facilityName]) {
                    warehousesByFacility[facilityName] = [];
                }
                warehousesByFacility[facilityName].push({
                    id: {{ wh.id }},
                    name: {{ wh.department|tojson }} || {{ wh.type|tojson }} || '‚Äî'
                });
            }
            warehousesDataMap[{{ wh.id }}] = {
                id: {{ wh.id }},
                facility_id: facilityId,
                facility_name: facilityName,
                department_name: {{ wh.department|tojson }} || '‚Äî'
            };
        })();
        {% endfor %}

        // –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ
        const facilityCells = document.querySelectorAll('.facility-cell');
        const facilityDropdown = document.createElement('div');
        facilityDropdown.className = 'role-dropdown';
        document.body.appendChild(facilityDropdown);
        let currentFacilityCell = null;

        function populateFacilityDropdown() {
            facilityDropdown.innerHTML = '';
            Object.keys(facilityOptionsMap).forEach(facilityName => {
                if (!facilityName || facilityName.trim() === '' || facilityName === '‚Äî') return;
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.textContent = facilityName;
                
                option.addEventListener('click', async () => {
                    if (!currentFacilityCell) return;
                    
                    const row = currentFacilityCell.closest('tr');
                    const partId = row?.dataset.partId;
                    
                    if (!partId) return;
                    
                    const labelSpan = currentFacilityCell.querySelector('.role-cell-label');
                    const originalValue = currentFacilityCell.dataset.facilityValue || '';
                    
                    if (facilityName === originalValue) {
                        closeFacilityDropdown();
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    if (labelSpan) labelSpan.textContent = facilityName;
                    currentFacilityCell.dataset.facilityValue = facilityName;
                    currentFacilityCell.dataset.facilityId = facilityOptionsMap[facilityName].id;
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∫–ª–∞–¥
                    const warehouseCell = row.querySelector('.warehouse-cell');
                    if (warehouseCell) {
                        const warehouseLabel = warehouseCell.querySelector('.role-cell-label');
                        if (warehouseLabel) warehouseLabel.textContent = '‚Äî';
                        warehouseCell.dataset.warehouseId = '';
                        warehouseCell.dataset.facilityName = facilityName;
                    }
                    
                    closeFacilityDropdown();
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    try {
                        const response = await fetch(`/admin/warehouse/${partId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                field: 'facility',
                                value: facilityName
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫–µ
                            row.dataset.facility = facilityName;
                            if (data.warehouse) {
                                const warehouseCell = row.querySelector('.warehouse-cell');
                                if (warehouseCell) {
                                    const warehouseLabel = warehouseCell.querySelector('.role-cell-label');
                                    if (warehouseLabel) warehouseLabel.textContent = data.warehouse;
                                }
                            }
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'success');
                                statusBox.textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        } else {
                            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                            if (labelSpan) labelSpan.textContent = originalValue || '‚Äî';
                            currentFacilityCell.dataset.facilityValue = originalValue;
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'error');
                                statusBox.textContent = data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:', error);
                        if (labelSpan) labelSpan.textContent = originalValue || '‚Äî';
                        currentFacilityCell.dataset.facilityValue = originalValue;
                    }
                });
                
                facilityDropdown.appendChild(option);
            });
        }

        function openFacilityDropdown(cell) {
            if (currentFacilityCell === cell && facilityDropdown.classList.contains('visible')) {
                closeFacilityDropdown();
                return;
            }
            
            currentFacilityCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateFacilityDropdown();
            
            const rect = cell.getBoundingClientRect();
            facilityDropdown.style.position = 'fixed';
            facilityDropdown.style.left = rect.left + 'px';
            facilityDropdown.style.top = (rect.bottom + 4) + 'px';
            facilityDropdown.style.minWidth = rect.width + 'px';
            facilityDropdown.style.maxWidth = '300px';
            facilityDropdown.classList.add('visible');
        }

        function closeFacilityDropdown() {
            if (currentFacilityCell) {
                currentFacilityCell.setAttribute('aria-expanded', 'false');
                currentFacilityCell = null;
            }
            facilityDropdown.classList.remove('visible');
        }

        facilityCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                openFacilityDropdown(cell);
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.facilityValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openFacilityDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeFacilityDropdown();
                    cell.blur();
                }
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.facility-cell') && !facilityDropdown.contains(e.target)) {
                closeFacilityDropdown();
            }
        }, true);

        // –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è —Å–∫–ª–∞–¥–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
        const warehouseCells = document.querySelectorAll('.warehouse-cell');
        const warehouseDropdown = document.createElement('div');
        warehouseDropdown.className = 'role-dropdown';
        document.body.appendChild(warehouseDropdown);
        let currentWarehouseCell = null;

        function populateWarehouseDropdown(cell) {
            warehouseDropdown.innerHTML = '';
            const facilityName = cell.dataset.facilityName || '';
            const warehouses = warehousesByFacility[facilityName] || [];
            
            if (warehouses.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'role-dropdown-option';
                emptyMsg.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤';
                emptyMsg.style.cursor = 'default';
                emptyMsg.style.opacity = '0.6';
                warehouseDropdown.appendChild(emptyMsg);
                return;
            }
            
            warehouses.forEach(warehouse => {
                if (!warehouse || !warehouse.name || warehouse.name.trim() === '' || warehouse.name === '‚Äî') return;
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.textContent = warehouse.name;
                
                option.addEventListener('click', async () => {
                    if (!currentWarehouseCell) return;
                    
                    const row = currentWarehouseCell.closest('tr');
                    const partId = row?.dataset.partId;
                    
                    if (!partId) return;
                    
                    const labelSpan = currentWarehouseCell.querySelector('.role-cell-label');
                    const originalValue = currentWarehouseCell.dataset.warehouseId || '';
                    
                    if (String(warehouse.id) === originalValue) {
                        closeWarehouseDropdown();
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    if (labelSpan) labelSpan.textContent = warehouse.name;
                    currentWarehouseCell.dataset.warehouseId = warehouse.id;
                    
                    closeWarehouseDropdown();
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    try {
                        const response = await fetch(`/admin/warehouse/${partId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                field: 'warehouse_id',
                                value: warehouse.id
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫–µ
                            row.dataset.warehouse = warehouse.name;
                            if (data.facility) {
                                const facilityCell = row.querySelector('.facility-cell');
                                if (facilityCell) {
                                    const facilityLabel = facilityCell.querySelector('.role-cell-label');
                                    if (facilityLabel) facilityLabel.textContent = data.facility;
                                    facilityCell.dataset.facilityValue = data.facility;
                                }
                            }
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'success');
                                statusBox.textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        } else {
                            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                            if (labelSpan) labelSpan.textContent = '‚Äî';
                            currentWarehouseCell.dataset.warehouseId = '';
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'error');
                                statusBox.textContent = data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞:', error);
                        if (labelSpan) labelSpan.textContent = '‚Äî';
                        currentWarehouseCell.dataset.warehouseId = '';
                    }
                });
                
                warehouseDropdown.appendChild(option);
            });
        }

        function openWarehouseDropdown(cell) {
            if (currentWarehouseCell === cell && warehouseDropdown.classList.contains('visible')) {
                closeWarehouseDropdown();
                return;
            }
            
            const facilityName = cell.dataset.facilityName || '';
            if (!facilityName || facilityName === '‚Äî') {
                const statusBox = document.getElementById('warehouseTableUpdateStatus');
                if (statusBox) {
                    statusBox.setAttribute('data-state', 'error');
                    statusBox.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    statusBox.classList.add('visible');
                    setTimeout(() => statusBox.classList.remove('visible'), 3000);
                }
                return;
            }
            
            currentWarehouseCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateWarehouseDropdown(cell);
            
            const rect = cell.getBoundingClientRect();
            warehouseDropdown.style.position = 'fixed';
            warehouseDropdown.style.left = rect.left + 'px';
            warehouseDropdown.style.top = (rect.bottom + 4) + 'px';
            warehouseDropdown.style.minWidth = rect.width + 'px';
            warehouseDropdown.style.maxWidth = '300px';
            warehouseDropdown.classList.add('visible');
        }

        function closeWarehouseDropdown() {
            if (currentWarehouseCell) {
                currentWarehouseCell.setAttribute('aria-expanded', 'false');
                currentWarehouseCell = null;
            }
            warehouseDropdown.classList.remove('visible');
        }

        warehouseCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                openWarehouseDropdown(cell);
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.warehouseId || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openWarehouseDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeWarehouseDropdown();
                    cell.blur();
                }
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.warehouse-cell') && !warehouseDropdown.contains(e.target)) {
                closeWarehouseDropdown();
            }
        }, true);

        applyWarehouseTableFilters();


        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞
        function revertWarehouseCell(cell) {
            if (!cell) return;
            cell.textContent = cell.dataset.originalValue || '';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞
        function updateWarehouseCell(cell, partId, field, value) {
            cell.classList.add('saving');
            fetch(`/admin/warehouse/${partId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ field, value })
            })
            .then(async response => {
                const data = await response.json();
                return { ok: response.ok, data };
            })
            .then(({ ok, data }) => {
                cell.classList.remove('saving');
                if (ok && data.success) {
                    // –£–¥–∞–ª—è–µ–º quantity input wrapper, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    const wrapper = cell.querySelector('.quantity-input-wrapper');
                    if (wrapper) {
                        wrapper.remove();
                    }
                    
                    // –î–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —á–∏—Å–ª–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    if (field === 'quantity') {
                        const quantityValue = parseInt(data.value) || 0;
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫ –¥–ª—è 0, –∏–Ω–∞—á–µ —á–∏—Å–ª–æ
                        cell.textContent = quantityValue === 0 ? '‚Äî' : quantityValue.toString();
                    } else {
                        // –î–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ—á–µ—Ä–∫
                        cell.textContent = data.value || '‚Äî';
                    }
                    cell.dataset.originalValue = cell.textContent;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                    const row = cell.closest('tr');
                    if (row && field === 'spare_part_name') {
                        row.dataset.sparePart = data.value || '';
                    }
                    
                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                    if (statusBox) {
                        statusBox.setAttribute('data-state', 'success');
                        statusBox.textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
                        statusBox.classList.add('visible');
                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                    }
                } else {
                    cell.classList.add('error');
                    revertWarehouseCell(cell);
                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                    if (statusBox) {
                        statusBox.setAttribute('data-state', 'error');
                        statusBox.textContent = data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
                        statusBox.classList.add('visible');
                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                    }
                    setTimeout(() => cell.classList.remove('error'), 1500);
                }
            })
            .catch(() => {
                cell.classList.remove('saving');
                cell.classList.add('error');
                revertWarehouseCell(cell);
                const statusBox = document.getElementById('warehouseTableUpdateStatus');
                if (statusBox) {
                    statusBox.setAttribute('data-state', 'error');
                    statusBox.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                    statusBox.classList.add('visible');
                    setTimeout(() => statusBox.classList.remove('visible'), 3000);
                }
                setTimeout(() => cell.classList.remove('error'), 1500);
            });
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞
        function setupWarehouseEditableCells() {
            const editableWarehouseCells = warehouseTable ? warehouseTable.querySelectorAll('td.editable-cell[data-field]') : [];
            editableWarehouseCells.forEach(cell => {
                const field = cell.dataset.field;
                
                // –î–ª—è —è—á–µ–π–∫–∏ "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" –∏—Å–ø–æ–ª—å–∑—É–µ–º number input —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Å—Ç—Ä–µ–ª–∫–∞–º–∏
                if (field === 'quantity') {
                    let quantityInput = null;
                    let quantityWrapper = null;
                    let quantityButtons = null;
                    
                    cell.addEventListener('dblclick', () => {
                        // –ï—Å–ª–∏ —É–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è, –Ω–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ
                        if (cell.querySelector('.quantity-input-wrapper')) return;
                        
                        const originalText = cell.textContent.trim();
                        const originalValue = originalText === '‚Äî' ? '0' : originalText;
                        cell.dataset.originalValue = originalValue;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        const currentValue = originalText === '‚Äî' ? '0' : originalText;
                        
                        // –°–æ–∑–¥–∞—ë–º –æ–±—ë—Ä—Ç–∫—É
                        quantityWrapper = document.createElement('div');
                        quantityWrapper.className = 'quantity-input-wrapper';
                        
                        // –°–æ–∑–¥–∞—ë–º input
                        quantityInput = document.createElement('input');
                        quantityInput.type = 'number';
                        quantityInput.min = '0';
                        quantityInput.value = currentValue;
                        quantityInput.className = 'quantity-input';
                        
                        // –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏-—Å—Ç—Ä–µ–ª–∫–∏
                        quantityButtons = document.createElement('div');
                        quantityButtons.className = 'quantity-input-buttons';
                        
                        const btnUp = document.createElement('button');
                        btnUp.type = 'button';
                        btnUp.className = 'quantity-input-btn quantity-input-btn-up';
                        btnUp.setAttribute('aria-label', '–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
                        btnUp.setAttribute('tabindex', '-1');
                        btnUp.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>';
                        
                        const btnDown = document.createElement('button');
                        btnDown.type = 'button';
                        btnDown.className = 'quantity-input-btn quantity-input-btn-down';
                        btnDown.setAttribute('aria-label', '–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
                        btnDown.setAttribute('tabindex', '-1');
                        btnDown.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                        
                        quantityButtons.appendChild(btnUp);
                        quantityButtons.appendChild(btnDown);
                        
                        quantityWrapper.appendChild(quantityInput);
                        quantityWrapper.appendChild(quantityButtons);
                        
                        // –û—á–∏—â–∞–µ–º —è—á–µ–π–∫—É –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –æ–±—ë—Ä—Ç–∫—É
                        cell.textContent = '';
                        cell.appendChild(quantityWrapper);
                        
                        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ input –∏ –≤—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç
                        quantityInput.focus();
                        quantityInput.select();
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º mousedown, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å blur
                        btnUp.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const current = parseInt(quantityInput.value) || 0;
                            quantityInput.value = Math.max(0, current + 1).toString();
                            quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ input
                            quantityInput.focus();
                        });
                        
                        btnDown.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const current = parseInt(quantityInput.value) || 0;
                            quantityInput.value = Math.max(0, current - 1).toString();
                            quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ input
                            quantityInput.focus();
                        });
                        
                        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º blur –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏
                        btnUp.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                        
                        btnDown.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–ª–µ—Å–∏–∫–∞ –º—ã—à–∏
                        quantityWrapper.addEventListener('wheel', (e) => {
                            if (document.activeElement === quantityInput) {
                                e.preventDefault();
                                const delta = e.deltaY > 0 ? -1 : 1;
                                const current = parseInt(quantityInput.value) || 0;
                                quantityInput.value = Math.max(0, current + delta).toString();
                                quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }, { passive: false });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                        quantityInput.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                quantityInput.blur();
                            }
                            if (event.key === 'Escape') {
                                event.preventDefault();
                                revertWarehouseQuantityCell(cell, originalValue);
                            }
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è blur - —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
                        quantityInput.addEventListener('blur', () => {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –±—ã–ª –ª–∏ —ç—Ç–æ –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É
                            setTimeout(() => {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ input –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–µ –±—ã–ª —É–¥–∞–ª—ë–Ω)
                                if (!cell.querySelector('.quantity-input-wrapper')) return;
                                
                                // –ï—Å–ª–∏ —Ñ–æ–∫—É—Å –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ input, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –±—ã–ª –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É
                                if (document.activeElement === quantityInput) {
                                    return;
                                }
                                
                                // –ï—Å–ª–∏ blur –ø—Ä–æ–∏–∑–æ—à—ë–ª –Ω–µ –∏–∑-–∑–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                                const newValue = quantityInput.value.trim();
                                const numValue = parseInt(newValue);
                                
                                if (isNaN(numValue) || numValue < 0) {
                                    revertWarehouseQuantityCell(cell, originalValue);
                                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                                    if (statusBox) {
                                        statusBox.setAttribute('data-state', 'error');
                                        statusBox.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ';
                                        statusBox.classList.add('visible');
                                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                                    }
                                    return;
                                }
                                
                                const normalizedOriginal = originalValue === '‚Äî' ? '0' : originalValue;
                                const normalizedNew = numValue.toString();
                                
                                if (normalizedNew === normalizedOriginal) {
                                    revertWarehouseQuantityCell(cell, originalValue);
                                    return;
                                }
                                
                                const row = cell.closest('tr');
                                const partId = row ? row.dataset.partId : null;
                                if (!partId) {
                                    revertWarehouseQuantityCell(cell, originalValue);
                                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                                    if (statusBox) {
                                        statusBox.setAttribute('data-state', 'error');
                                        statusBox.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.';
                                        statusBox.classList.add('visible');
                                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                                    }
                                    return;
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —á–µ—Ä–µ–∑ updateWarehouseCell
                                updateWarehouseCell(cell, partId, 'quantity', normalizedNew);
                            }, 50);
                        });
                    });
                } else {
                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —è—á–µ–µ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–î–µ—Ç–∞–ª—å") –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π contenteditable
                    cell.addEventListener('dblclick', () => {
                        cell.contentEditable = 'true';
                        cell.dataset.originalValue = cell.textContent.trim();
                        cell.focus();
                        const range = document.createRange();
                        range.selectNodeContents(cell);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    });

                    cell.addEventListener('keydown', (event) => {
                        if (cell.contentEditable !== 'true') return;
                        
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            cell.blur();
                        }
                        if (event.key === 'Escape') {
                            event.preventDefault();
                            revertWarehouseCell(cell);
                            cell.blur();
                        }
                    });

                    cell.addEventListener('blur', () => {
                        cell.contentEditable = 'false';
                        
                        const originalValue = cell.dataset.originalValue ?? '';
                        let newValue = cell.textContent.trim();
                        
                        // –î–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –ø—É—Å—Ç–æ–µ
                        if (cell.dataset.field === 'spare_part_name') {
                            if (!newValue || newValue.trim() === '') {
                                revertWarehouseCell(cell);
                                const statusBox = document.getElementById('warehouseTableUpdateStatus');
                                if (statusBox) {
                                    statusBox.setAttribute('data-state', 'error');
                                    statusBox.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                                    statusBox.classList.add('visible');
                                    setTimeout(() => statusBox.classList.remove('visible'), 3000);
                                }
                                return;
                            }
                        }
                        
                        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                        const normalizedOriginal = originalValue === '‚Äî' ? '' : originalValue;
                        const normalizedNew = newValue === '‚Äî' ? '' : newValue;
                        if (normalizedNew === normalizedOriginal) {
                            return;
                        }
                        
                        const row = cell.closest('tr');
                        const partId = row ? row.dataset.partId : null;
                        if (!partId) {
                            revertWarehouseCell(cell);
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'error');
                                statusBox.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                            return;
                        }
                        const field = cell.dataset.field;
                        if (!field) {
                            revertWarehouseCell(cell);
                            return;
                        }
                        updateWarehouseCell(cell, partId, field, newValue);
                    });
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —è—á–µ–π–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        function revertWarehouseQuantityCell(cell, originalValue) {
            const wrapper = cell.querySelector('.quantity-input-wrapper');
            if (wrapper) {
                wrapper.remove();
            }
            const displayValue = originalValue === '0' || originalValue === '' ? '‚Äî' : originalValue;
            cell.textContent = displayValue;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫
        setupWarehouseEditableCells();

        {% endif %}
    </script>

    {% if section == 'equipment' %}
    <script>
        // JavaScript –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        (function() {
            'use strict';
            
            try {
            const equipmentSearch = document.getElementById('equipmentSearch');
            const equipmentFilterToggle = document.getElementById('equipmentFilterToggle');
            const equipmentFilterDropdown = document.getElementById('equipmentFilterDropdown');
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const locationFilter = document.getElementById('locationFilter');
            const resetEquipmentFilters = document.getElementById('resetEquipmentFilters');
            const equipmentSortColumnFilter = document.getElementById('equipmentSortColumnFilter');
            const equipmentSortDirectionFilter = document.getElementById('equipmentSortDirectionFilter');
            const equipmentTable = document.getElementById('equipmentTable');
            const equipmentStatusBox = document.getElementById('equipmentTableUpdateStatus');
            const addEquipmentBtn = document.getElementById('addEquipmentBtn');
            const equipmentModal = document.getElementById('equipmentModal');
            const equipmentModalClose = document.getElementById('equipmentModalClose');
            const equipmentModalCancel = document.getElementById('equipmentModalCancel');
            const deleteEquipmentModal = document.getElementById('deleteEquipmentModal');
            const deleteEquipmentClose = document.getElementById('deleteEquipmentModalClose');
            const deleteEquipmentCancel = document.getElementById('deleteEquipmentCancel');
            const deleteEquipmentConfirm = document.getElementById('deleteEquipmentConfirm');
            const deleteEquipmentMessage = document.getElementById('deleteEquipmentMessage');

            let equipmentToDelete = null;
            let equipmentToDeleteRow = null;
            let selectedEquipmentRow = null;
            let equipmentContextMenu = null;

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            function createContextMenu() {
                console.log('createContextMenu –≤—ã–∑–≤–∞–Ω–∞');
                if (equipmentContextMenu) {
                    console.log('–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ');
                    return equipmentContextMenu;
                }
                
                console.log('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é');
                equipmentContextMenu = document.createElement('div');
                equipmentContextMenu.className = 'context-menu';
                equipmentContextMenu.innerHTML = `
                    <button type="button" class="context-menu-item" id="equipmentPassportBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        –ü–∞—Å–ø–æ—Ä—Ç
                    </button>
                    <button type="button" class="context-menu-item" id="equipmentMoveBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å
                    </button>
                    <button type="button" class="context-menu-item" id="equipmentCreateTaskBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç
                    </button>
                    <button type="button" class="context-menu-item danger" id="equipmentDeleteBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                `;
                document.body.appendChild(equipmentContextMenu);
                
                const passportBtn = document.getElementById('equipmentPassportBtn');
                const moveBtn = document.getElementById('equipmentMoveBtn');
                const createTaskBtn = document.getElementById('equipmentCreateTaskBtn');
                const deleteBtn = document.getElementById('equipmentDeleteBtn');
                
                console.log('–ö–Ω–æ–ø–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é:', {
                    passportBtn: !!passportBtn,
                    moveBtn: !!moveBtn,
                    createTaskBtn: !!createTaskBtn,
                    deleteBtn: !!deleteBtn
                });
                
                if (passportBtn) {
                    passportBtn.addEventListener('click', () => {
                        if (selectedEquipmentRow) {
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            if (equipmentId) {
                                window.location.href = `/admin/equipment/passport/${equipmentId}`;
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                if (moveBtn) {
                    moveBtn.addEventListener('click', () => {
                        if (selectedEquipmentRow) {
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            const equipmentAssignmentId = selectedEquipmentRow.dataset.equipmentAssignmentId;
                            const departmentCell = selectedEquipmentRow.querySelector('.department-cell');
                            const departmentId = departmentCell?.dataset.departmentId;
                            const facilityName = departmentCell?.dataset.facilityName;
                            
                            if (equipmentId && equipmentAssignmentId && departmentId) {
                                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                                const addMovementModal = document.getElementById('addMovementModal');
                                if (!addMovementModal) {
                                    showEquipmentStatus('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                                    hideContextMenu();
                                    return;
                                }
                                
                                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                                const departmentsData = {{ department_choices|tojson }};
                                const movementFacilityDeptMap = {};
                                
                                departmentsData.forEach(dept => {
                                    const facilityId = dept.facility_id ? String(dept.facility_id) : '';
                                    if (!facilityId) return;
                                    
                                    if (!movementFacilityDeptMap[facilityId]) {
                                        movementFacilityDeptMap[facilityId] = [];
                                    }
                                    movementFacilityDeptMap[facilityId].push({
                                        id: dept.id,
                                        name: dept.name
                                    });
                                });
                                
                                // –ù–∞—Ö–æ–¥–∏–º –æ—Ç–¥–µ–ª –∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ
                                const dept = departmentsData.find(d => String(d.id) === String(departmentId));
                                if (dept && dept.facility_id) {
                                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                                    addMovementModal.classList.add('visible');
                                    document.body.classList.add('modal-open');
                                    setTimeout(() => {
                                        addMovementModal.setAttribute('aria-hidden', 'false');
                                    }, 0);
                                    
                                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                                    const movementFormReset = document.getElementById('movementForm');
                                    if (movementFormReset) movementFormReset.reset();
                                    
                                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
                                    const movementDateInput = document.getElementById('movementDateInput');
                                    if (movementDateInput) {
                                        const today = new Date();
                                        const year = today.getFullYear();
                                        const month = String(today.getMonth() + 1).padStart(2, '0');
                                        const day = String(today.getDate()).padStart(2, '0');
                                        movementDateInput.value = `${year}-${month}-${day}`;
                                    }
                                    
                                    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º "–û—Ç–∫—É–¥–∞"
                                    const movementFromFacilitySelect = document.getElementById('movementFromFacilitySelect');
                                    const movementFromDepartmentSelect = document.getElementById('movementFromDepartmentSelect');
                                    const movementFromFacilityBtn = document.getElementById('movementFromFacilityBtn');
                                    const movementFromDepartmentBtn = document.getElementById('movementFromDepartmentBtn');
                                    
                                    if (movementFromFacilitySelect) {
                                        movementFromFacilitySelect.value = String(dept.facility_id);
                                        const facilityOption = Array.from(movementFromFacilitySelect.options).find(opt => opt.value === String(dept.facility_id));
                                        if (facilityOption && movementFromFacilityBtn) {
                                            movementFromFacilityBtn.querySelector('.modal-select-label').textContent = facilityOption.textContent;
                                        }
                                        
                                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã
                                        const departments = movementFacilityDeptMap[String(dept.facility_id)] || [];
                                        if (movementFromDepartmentSelect) {
                                            movementFromDepartmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                                            departments.forEach(d => {
                                                const option = document.createElement('option');
                                                option.value = d.id;
                                                option.textContent = d.name;
                                                movementFromDepartmentSelect.appendChild(option);
                                            });
                                            movementFromDepartmentSelect.value = String(departmentId);
                                            movementFromDepartmentSelect.disabled = departments.length === 0;
                                            
                                            if (movementFromDepartmentBtn) {
                                                movementFromDepartmentBtn.disabled = departments.length === 0;
                                                const deptOption = departments.find(d => String(d.id) === String(departmentId));
                                                if (deptOption) {
                                                    movementFromDepartmentBtn.querySelector('.modal-select-label').textContent = deptOption.name;
                                                }
                                            }
                                        }
                                    }
                                    
                                    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –ª–æ–∫–∞—Ü–∏—é "–û—Ç–∫—É–¥–∞" –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (equipment_assignment.location)
                                    const currentLocation = selectedEquipmentRow.dataset.location || '';
                                    const movementFromLocationInput = document.getElementById('movementFromLocationInput');
                                    if (movementFromLocationInput && currentLocation && currentLocation !== '‚Äî') {
                                        // –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –∏–∑ –ª–æ–∫–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–æ —Ç–∞–º –µ—Å—Ç—å
                                        let cleanLocation = currentLocation.trim();
                                        if (facilityName && cleanLocation.includes(facilityName)) {
                                            // –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –∏–∑ –Ω–∞—á–∞–ª–∞ –∏–ª–∏ —Å–µ—Ä–µ–¥–∏–Ω—ã —Å—Ç—Ä–æ–∫–∏
                                            cleanLocation = cleanLocation.replace(new RegExp(facilityName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), '').trim();
                                            // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                                            cleanLocation = cleanLocation.replace(/^[\s"\'\-]+|[\s"\'\-]+$/g, '').trim();
                                        }
                                        movementFromLocationInput.value = cleanLocation || '';
                                    }
                                    
                                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                                    window.currentMovementEquipmentId = equipmentId;
                                    window.currentMovementEquipmentAssignmentId = equipmentAssignmentId;
                                    
                                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º "–ö—É–¥–∞"
                                    const movementToDepartmentSelect = document.getElementById('movementToDepartmentSelect');
                                    const movementToDepartmentBtn = document.getElementById('movementToDepartmentBtn');
                                    if (movementToDepartmentSelect) {
                                        movementToDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                                        movementToDepartmentSelect.disabled = true;
                                        if (movementToDepartmentBtn) {
                                            movementToDepartmentBtn.disabled = true;
                                            movementToDepartmentBtn.querySelector('.modal-select-label').textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                                        }
                                    }
                                    
                                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                                    let movementModalDropdown = document.getElementById('modalDropdown');
                                    if (!movementModalDropdown) {
                                        movementModalDropdown = document.createElement('div');
                                        movementModalDropdown.className = 'role-dropdown';
                                        movementModalDropdown.id = 'modalDropdown';
                                        document.body.appendChild(movementModalDropdown);
                                    }
                                    
                                    let currentMovementModalSelect = null;
                                    const movementModalSelectData = {
                                        from_facility_id: {},
                                        to_facility_id: {},
                                        from_department_id: {},
                                        to_department_id: {}
                                    };
                                    
                                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
                                    {% for fac in facility_choices %}
                                    movementModalSelectData.from_facility_id['{{ fac.id }}'] = {{ fac.name|tojson }};
                                    movementModalSelectData.to_facility_id['{{ fac.id }}'] = {{ fac.name|tojson }};
                                    {% endfor %}
                                    
                                    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                                    function openMovementModalDropdown(btn) {
                                        if (!btn || btn.disabled) return;
                                        const field = btn.dataset.field;
                                        if (!field) return;
                                        
                                        let options = {};
                                        
                                        // –î–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º movementModalSelectData
                                        if (field === 'from_facility_id' || field === 'to_facility_id') {
                                            options = movementModalSelectData[field] || {};
                                        }
                                        // –î–ª—è –æ—Ç–¥–µ–ª–æ–≤ –ø–æ–ª—É—á–∞–µ–º –∏–∑ movementFacilityDeptMap
                                        else if (field === 'from_department_id') {
                                            const fromFacilitySelect = document.getElementById('movementFromFacilitySelect');
                                            const facilityId = fromFacilitySelect?.value;
                                            if (facilityId) {
                                                const departments = movementFacilityDeptMap[facilityId] || [];
                                                departments.forEach(dept => {
                                                    options[dept.id] = dept.name;
                                                });
                                            }
                                        }
                                        else if (field === 'to_department_id') {
                                            const toFacilitySelect = document.getElementById('movementToFacilitySelect');
                                            const facilityId = toFacilitySelect?.value;
                                            if (facilityId) {
                                                const departments = movementFacilityDeptMap[facilityId] || [];
                                                departments.forEach(dept => {
                                                    options[dept.id] = dept.name;
                                                });
                                            }
                                        }
                                        
                                        if (!movementModalDropdown || Object.keys(options).length === 0) {
                                            return;
                                        }
                                        
                                        movementModalDropdown.innerHTML = '';
                                        Object.entries(options).forEach(([value, label]) => {
                                            const option = document.createElement('button');
                                            option.type = 'button';
                                            option.className = 'role-dropdown-option';
                                            option.dataset.value = value;
                                            option.textContent = label || value || '‚Äî';
                                            option.addEventListener('click', () => {
                                                if (!currentMovementModalSelect) return;
                                                const selectBtn = currentMovementModalSelect;
                                                const select = selectBtn.parentElement.querySelector('select');
                                                const labelSpan = selectBtn.querySelector('.modal-select-label');
                                                
                                                if (select && labelSpan) {
                                                    select.value = value;
                                                    labelSpan.textContent = label;
                                                    select.dispatchEvent(new Event('change', { bubbles: true }));
                                                }
                                                
                                                closeMovementModalDropdown();
                                            });
                                            movementModalDropdown.appendChild(option);
                                        });
                                        
                                        const rect = btn.getBoundingClientRect();
                                        const viewportHeight = window.innerHeight;
                                        const spaceBelow = viewportHeight - rect.bottom;
                                        const spaceAbove = rect.top;
                                        const dropdownHeight = 300;
                                        const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
                                        
                                        movementModalDropdown.style.position = 'fixed';
                                        if (openUpward) {
                                            movementModalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                                            movementModalDropdown.style.top = 'auto';
                                        } else {
                                            movementModalDropdown.style.top = `${rect.bottom + 6}px`;
                                            movementModalDropdown.style.bottom = 'auto';
                                        }
                                        movementModalDropdown.style.left = `${rect.left}px`;
                                        movementModalDropdown.style.width = `${rect.width}px`;
                                        movementModalDropdown.style.minWidth = `${rect.width}px`;
                                        movementModalDropdown.style.maxWidth = `${rect.width}px`;
                                        
                                        currentMovementModalSelect = btn;
                                        movementModalDropdown.classList.add('visible');
                                        btn.setAttribute('aria-expanded', 'true');
                                    }
                                    
                                    function closeMovementModalDropdown() {
                                        if (!movementModalDropdown) return;
                                        
                                        // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                                        const addMovementModal = document.getElementById('addMovementModal');
                                        if (addMovementModal) {
                                            const allButtons = addMovementModal.querySelectorAll('.modal-select-btn');
                                            allButtons.forEach(btn => {
                                                btn.removeAttribute('aria-expanded');
                                                btn.setAttribute('aria-expanded', 'false');
                                                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
                                                const svg = btn.querySelector('svg');
                                                if (svg) {
                                                    svg.style.transform = '';
                                                }
                                            });
                                        }
                                        
                                        // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ ID –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                                        const buttonIds = [
                                            'movementFromFacilityBtn',
                                            'movementToFacilityBtn',
                                            'movementFromDepartmentBtn',
                                            'movementToDepartmentBtn'
                                        ];
                                        
                                        buttonIds.forEach(btnId => {
                                            const btn = document.getElementById(btnId);
                                            if (btn) {
                                                btn.removeAttribute('aria-expanded');
                                                btn.setAttribute('aria-expanded', 'false');
                                                const svg = btn.querySelector('svg');
                                                if (svg) {
                                                    svg.style.transform = '';
                                                }
                                            }
                                        });
                                        
                                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                                        movementModalDropdown.classList.remove('visible');
                                        currentMovementModalSelect = null;
                                    }
                                    
                                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                                    function setupMovementDropdownHandlers() {
                                        const buttonIds = [
                                            'movementFromFacilityBtn',
                                            'movementToFacilityBtn',
                                            'movementFromDepartmentBtn',
                                            'movementToDepartmentBtn'
                                        ];
                                        
                                        buttonIds.forEach(btnId => {
                                            const btn = document.getElementById(btnId);
                                            if (!btn) return;
                                            
                                            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                            const newBtn = btn.cloneNode(true);
                                            btn.parentNode.replaceChild(newBtn, btn);
                                            
                                            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                                            newBtn.addEventListener('click', (e) => {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                
                                                const currentDropdown = document.getElementById('modalDropdown');
                                                if (currentDropdown && currentDropdown.classList.contains('visible') && currentMovementModalSelect === newBtn) {
                                                    closeMovementModalDropdown();
                                                } else {
                                                    closeMovementModalDropdown();
                                                    openMovementModalDropdown(newBtn);
                                                }
                                            });
                                        });
                                    }
                                    
                                    setupMovementDropdownHandlers();
                                    
                                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è "–û—Ç–∫—É–¥–∞"
                                    function setupMovementFromFacilityHandler() {
                                        const fromFacilitySelect = document.getElementById('movementFromFacilitySelect');
                                        if (!fromFacilitySelect) return;
                                        
                                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                        const newSelect = fromFacilitySelect.cloneNode(true);
                                        fromFacilitySelect.parentNode.replaceChild(newSelect, fromFacilitySelect);
                                        
                                        newSelect.addEventListener('change', (e) => {
                                            const facilityId = e.target.value;
                                            const departments = movementFacilityDeptMap[facilityId] || [];
                                            
                                            const currentFromDepartmentSelect = document.getElementById('movementFromDepartmentSelect');
                                            const currentFromDepartmentBtn = document.getElementById('movementFromDepartmentBtn');
                                            
                                            if (currentFromDepartmentSelect) {
                                                currentFromDepartmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                                                departments.forEach(dept => {
                                                    const option = document.createElement('option');
                                                    option.value = dept.id;
                                                    option.textContent = dept.name;
                                                    currentFromDepartmentSelect.appendChild(option);
                                                });
                                                currentFromDepartmentSelect.disabled = departments.length === 0;
                                            }
                                            
                                            if (currentFromDepartmentBtn) {
                                                currentFromDepartmentBtn.disabled = departments.length === 0;
                                                const label = currentFromDepartmentBtn.querySelector('.modal-select-label');
                                                if (label) {
                                                    label.textContent = departments.length === 0 ? '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤' : '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                                                }
                                            }
                                            
                                            // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è DOM
                                            setupMovementDropdownHandlers();
                                        });
                                    }
                                    
                                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è "–ö—É–¥–∞"
                                    function setupMovementToFacilityHandler() {
                                        const toFacilitySelect = document.getElementById('movementToFacilitySelect');
                                        if (!toFacilitySelect) return;
                                        
                                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                        const newSelect = toFacilitySelect.cloneNode(true);
                                        toFacilitySelect.parentNode.replaceChild(newSelect, toFacilitySelect);
                                        
                                        newSelect.addEventListener('change', (e) => {
                                            const facilityId = e.target.value;
                                            const departments = movementFacilityDeptMap[facilityId] || [];
                                            
                                            const currentToDepartmentSelect = document.getElementById('movementToDepartmentSelect');
                                            const currentToDepartmentBtn = document.getElementById('movementToDepartmentBtn');
                                            
                                            if (currentToDepartmentSelect) {
                                                currentToDepartmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                                                departments.forEach(dept => {
                                                    const option = document.createElement('option');
                                                    option.value = dept.id;
                                                    option.textContent = dept.name;
                                                    currentToDepartmentSelect.appendChild(option);
                                                });
                                                currentToDepartmentSelect.disabled = departments.length === 0;
                                            }
                                            
                                            if (currentToDepartmentBtn) {
                                                currentToDepartmentBtn.disabled = departments.length === 0;
                                                const label = currentToDepartmentBtn.querySelector('.modal-select-label');
                                                if (label) {
                                                    label.textContent = departments.length === 0 ? '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤' : '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                                                }
                                            }
                                            
                                            // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è DOM
                                            setupMovementDropdownHandlers();
                                        });
                                    }
                                    
                                    setupMovementFromFacilityHandler();
                                    setupMovementToFacilityHandler();
                                    
                                    // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã
                                    if (document.body) {
                                        document.body.addEventListener('click', function movementModalClickHandlerFromContext(e) {
                                            if (!movementModalDropdown) return;
                                            
                                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                                            if (!movementModalDropdown.classList.contains('visible')) return;
                                            
                                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                                            const addMovementModal = document.getElementById('addMovementModal');
                                            if (!addMovementModal || !addMovementModal.classList.contains('visible')) return;
                                            
                                            // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∏ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–Ω–æ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ)
                                            if (!movementModalDropdown.contains(e.target) && 
                                                !e.target.closest('.modal-select-btn')) {
                                                closeMovementModalDropdown();
                                            }
                                        }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
                                    }
                                    
                                    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                                    const escapeHandler = (e) => {
                                        if (e.key === 'Escape' && movementModalDropdown.classList.contains('visible')) {
                                            closeMovementModalDropdown();
                                        }
                                    };
                                    document.removeEventListener('keydown', escapeHandler);
                                    document.addEventListener('keydown', escapeHandler);
                                    
                                    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                                    function closeAddMovementModalFromContext() {
                                        if (!addMovementModal) return;
                                        addMovementModal.classList.remove('visible');
                                        document.body.classList.remove('modal-open');
                                        setTimeout(() => {
                                            addMovementModal.setAttribute('aria-hidden', 'true');
                                        }, 0);
                                        
                                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
                                        closeMovementModalDropdown();
                                        
                                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                                        const formToReset = document.getElementById('movementForm');
                                        if (formToReset) formToReset.reset();
                                        
                                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                                        const movementFormSubmit = document.getElementById('movementFormSubmit');
                                        if (movementFormSubmit) {
                                            movementFormSubmit.disabled = false;
                                            const defaultLabel = movementFormSubmit.dataset.defaultLabel || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                                            movementFormSubmit.textContent = defaultLabel;
                                        }
                                        
                                        // –û—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                                        window.currentMovementEquipmentId = null;
                                        window.currentMovementEquipmentAssignmentId = null;
                                    }
                                    
                                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –∏ –æ—Ç–º–µ–Ω—ã
                                    const addMovementModalClose = document.getElementById('addMovementModalClose');
                                    const addMovementModalCancel = document.getElementById('addMovementModalCancel');
                                    
                                    [addMovementModalClose, addMovementModalCancel].forEach(btn => {
                                        if (!btn) return;
                                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                        const newBtn = btn.cloneNode(true);
                                        btn.parentNode.replaceChild(newBtn, btn);
                                        
                                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                                        newBtn.addEventListener('click', (e) => {
                                            e.preventDefault();
                                            closeAddMovementModalFromContext();
                                        });
                                    });
                                    
                                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                                    const movementForm = document.getElementById('movementForm');
                                    if (movementForm && !movementForm.dataset.equipmentHandlerSet) {
                                        movementForm.dataset.equipmentHandlerSet = 'true';
                                        
                                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                                        movementForm.addEventListener('submit', async (e) => {
                                            e.preventDefault();
                                            
                                            const movementFormSubmit = document.getElementById('movementFormSubmit');
                                            const movementFormError = document.getElementById('movementFormError');
                                            
                                            if (!movementFormSubmit) return;
                                            movementFormSubmit.disabled = true;
                                            const originalText = movementFormSubmit.textContent;
                                            movementFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                                            
                                            if (movementFormError) movementFormError.textContent = '';
                                            
                                            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö select —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                                            const fromDepartmentSelect = document.getElementById('movementFromDepartmentSelect');
                                            const toDepartmentSelect = document.getElementById('movementToDepartmentSelect');
                                            const moveDateInput = document.getElementById('movementDateInput');
                                            const fromLocationInput = document.getElementById('movementFromLocationInput');
                                            const toLocationInput = document.getElementById('movementToLocationInput');
                                            
                                            const fromDepartmentId = fromDepartmentSelect ? fromDepartmentSelect.value : null;
                                            const toDepartmentId = toDepartmentSelect ? toDepartmentSelect.value : null;
                                            const moveDate = moveDateInput ? moveDateInput.value : null;
                                            const fromLocation = fromLocationInput ? fromLocationInput.value.trim() : '';
                                            const toLocation = toLocationInput ? toLocationInput.value.trim() : '';
                                            
                                            const data = {
                                                from_department_id: fromDepartmentId,
                                                to_department_id: toDepartmentId,
                                                move_date: moveDate,
                                                from_location: fromLocation,
                                                to_location: toLocation
                                            };
                                            
                                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                                            if (!data.from_department_id || !data.to_department_id || !data.move_date) {
                                                if (movementFormError) {
                                                    movementFormError.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
                                                }
                                                movementFormSubmit.disabled = false;
                                                movementFormSubmit.textContent = originalText;
                                                return;
                                            }
                                            
                                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                                            const equipmentId = window.currentMovementEquipmentId;
                                            const equipmentAssignmentId = window.currentMovementEquipmentAssignmentId;
                                            
                                            if (!equipmentId) {
                                                if (movementFormError) {
                                                    movementFormError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
                                                }
                                                movementFormSubmit.disabled = false;
                                                movementFormSubmit.textContent = originalText;
                                                return;
                                            }
                                            
                                            try {
                                                const response = await fetch(`/admin/equipment/${equipmentId}/movement`, {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json'
                                                    },
                                                    body: JSON.stringify(data)
                                                });
                                                
                                                const result = await response.json();
                                                
                                                if (response.ok && result.success) {
                                                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
                                                    movementFormSubmit.disabled = false;
                                                    movementFormSubmit.textContent = originalText;
                                                    
                                                    if (result.location_updated) {
                                                        window.location.reload();
                                                    } else {
                                                        closeAddMovementModalFromContext();
                                                        showEquipmentStatus('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É.', 'info');
                                                    }
                                                } else {
                                                    if (movementFormError) {
                                                        movementFormError.textContent = result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ';
                                                    }
                                                    movementFormSubmit.disabled = false;
                                                    movementFormSubmit.textContent = originalText;
                                                }
                                            } catch (error) {
                                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:', error);
                                                if (movementFormError) {
                                                    movementFormError.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è';
                                                }
                                                movementFormSubmit.disabled = false;
                                                movementFormSubmit.textContent = originalText;
                                            }
                                        });
                                        
                                        // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã
                                        setupMovementDropdownHandlers();
                                        setupMovementFromFacilityHandler();
                                        setupMovementToFacilityHandler();
                                    }
                                } else {
                                    showEquipmentStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–∫—É—â–µ–º –æ—Ç–¥–µ–ª–µ', 'error');
                                }
                            } else {
                                showEquipmentStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', 'error');
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                if (createTaskBtn) {
                    console.log('–ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫ –∫–Ω–æ–ø–∫–µ createTaskBtn');
                    createTaskBtn.addEventListener('click', (e) => {
                        console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç"');
                        e.preventDefault();
                        e.stopPropagation();
                        if (selectedEquipmentRow) {
                            console.log('selectedEquipmentRow –Ω–∞–π–¥–µ–Ω:', selectedEquipmentRow);
                            const equipmentAssignmentId = selectedEquipmentRow.dataset.equipmentAssignmentId;
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            const departmentCell = selectedEquipmentRow.querySelector('.department-cell');
                            const facilityCell = selectedEquipmentRow.querySelector('.facility-cell');
                            const departmentId = departmentCell?.dataset.departmentId;
                            const facilityId = departmentCell?.dataset.facilityId;
                            const facilityName = facilityCell?.querySelector('.role-cell-label')?.textContent.trim() || 
                                                departmentCell?.dataset.facilityName || 
                                                selectedEquipmentRow.dataset.facility || '';
                            
                            console.log('–î–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', {
                                equipmentAssignmentId,
                                equipmentId,
                                departmentId,
                                facilityId,
                                facilityName
                            });
                            
                            if (equipmentAssignmentId && departmentId) {
                                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
                                const createTaskModal = document.getElementById('createTaskModal');
                                if (!createTaskModal) {
                                    showEquipmentStatus('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                                    hideContextMenu();
                                    return;
                                }
                                
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
                                createTaskModal.dataset.equipmentAssignmentId = equipmentAssignmentId;
                                createTaskModal.dataset.equipmentId = equipmentId;
                                createTaskModal.dataset.departmentId = departmentId;
                                createTaskModal.dataset.facilityId = facilityId || '';
                                
                                console.log('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ dataset –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', {
                                    equipmentAssignmentId: createTaskModal.dataset.equipmentAssignmentId,
                                    equipmentId: createTaskModal.dataset.equipmentId,
                                    departmentId: createTaskModal.dataset.departmentId,
                                    facilityId: createTaskModal.dataset.facilityId
                                });
                                
                                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                                const taskForm = document.getElementById('createTaskForm');
                                if (taskForm) taskForm.reset();
                                
                                // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
                                const taskDepartmentDisplay = document.getElementById('taskDepartmentDisplay');
                                const taskDepartmentSelectWrapper = document.getElementById('taskDepartmentSelectWrapper');
                                const taskFacilityDisplay = document.getElementById('taskFacilityDisplay');
                                const taskFacilitySelectWrapper = document.getElementById('taskFacilitySelectWrapper');
                                const taskEquipmentDisplay = document.getElementById('taskEquipmentDisplay');
                                const taskEquipmentSelectWrapper = document.getElementById('taskEquipmentSelectWrapper');
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª –≤ —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
                                if (taskDepartmentDisplay && departmentCell) {
                                    const deptLabel = departmentCell.querySelector('.role-cell-label');
                                    taskDepartmentDisplay.value = deptLabel ? deptLabel.textContent.trim() : departmentCell.textContent.trim();
                                    taskDepartmentDisplay.style.display = 'block';
                                }
                                
                                if (taskDepartmentSelectWrapper) {
                                    taskDepartmentSelectWrapper.style.display = 'none';
                                }
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –≤ —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
                                if (taskFacilityDisplay && facilityName) {
                                    taskFacilityDisplay.value = facilityName;
                                    taskFacilityDisplay.style.display = 'block';
                                }
                                
                                if (taskFacilitySelectWrapper) {
                                    taskFacilitySelectWrapper.style.display = 'none';
                                }
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
                                const equipmentNameCell = selectedEquipmentRow.querySelector('td:nth-child(2)');
                                const taskEquipmentDisplayReadonly = document.getElementById('taskEquipmentDisplayReadonly');
                                if (taskEquipmentDisplayReadonly && equipmentNameCell) {
                                    taskEquipmentDisplayReadonly.value = equipmentNameCell.textContent.trim();
                                    taskEquipmentDisplayReadonly.style.display = 'block';
                                }
                                
                                if (taskEquipmentSelectWrapper) {
                                    taskEquipmentSelectWrapper.style.display = 'none';
                                }
                                
                                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                                const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
                                if (taskDepartmentSelect) {
                                    taskDepartmentSelect.value = departmentId;
                                }
                                
                                const taskEquipmentSelect = document.getElementById('taskEquipmentSelect');
                                if (taskEquipmentSelect) {
                                    taskEquipmentSelect.value = equipmentAssignmentId;
                                }
                                
                                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                                createTaskModal.classList.add('visible');
                                document.body.classList.add('modal-open');
                                
                                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                                setTimeout(() => {
                                    createTaskModal.setAttribute('aria-hidden', 'false');
                                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ
                                    const firstInput = taskForm ? taskForm.querySelector('input:not([readonly]), textarea') : null;
                                    if (firstInput) {
                                        firstInput.focus();
                                    }
                                }, 0);
                            } else {
                                showEquipmentStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ—Ç–¥–µ–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏', 'error');
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (selectedEquipmentRow) {
                            const equipmentAssignmentId = selectedEquipmentRow.dataset.equipmentAssignmentId;
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ assignment_id (–Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –∏ –Ω–µ undefined)
                            if (equipmentAssignmentId && equipmentAssignmentId.trim() !== '') {
                                openDeleteEquipmentModal(parseInt(equipmentAssignmentId), selectedEquipmentRow, 'assignment');
                            } else if (equipmentId && equipmentId.trim() !== '') {
                                // –ï—Å–ª–∏ –Ω–µ—Ç assignment_id, –Ω–æ –µ—Å—Ç—å equipment_id, —É–¥–∞–ª—è–µ–º —Å–∞–º–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                                openDeleteEquipmentModal(parseInt(equipmentId), selectedEquipmentRow, 'equipment');
                            } else {
                                showEquipmentStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                return equipmentContextMenu;
            }

            function showContextMenu(event, row) {
                console.log('showContextMenu –≤—ã–∑–≤–∞–Ω–∞', { event, row });
                event.preventDefault();
                event.stopPropagation();
                
                const menu = createContextMenu();
                selectedEquipmentRow = row;
                console.log('selectedEquipmentRow —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', selectedEquipmentRow);
                
                const tableContainer = document.querySelector('.table-container');
                if (!tableContainer) return;
                
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
                menu.style.display = 'block';
                menu.style.visibility = 'hidden';
                menu.style.left = '0px';
                menu.style.top = '0px';
                
                const containerRect = tableContainer.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                let left = event.clientX;
                let top = event.clientY;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                if (left + menuRect.width > containerRect.right) {
                    left = containerRect.right - menuRect.width - 10;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ª–µ–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                if (left < containerRect.left) {
                    left = containerRect.left + 10;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                if (top + menuRect.height > containerRect.bottom) {
                    top = containerRect.bottom - menuRect.height - 10;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                if (top < containerRect.top) {
                    top = containerRect.top + 10;
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                menu.style.position = 'fixed';
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                menu.style.visibility = 'visible';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                setTimeout(() => {
                    document.addEventListener('click', hideContextMenu, { once: true });
                }, 0);
            }

            function hideContextMenu() {
                if (equipmentContextMenu) {
                    equipmentContextMenu.style.display = 'none';
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            function getAllEquipmentRows() {
                return equipmentTable ? equipmentTable.querySelectorAll('tbody tr') : [];
            }

            // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –æ–¥–∏–Ω–∞—Ä–Ω–æ–º –∫–ª–∏–∫–µ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            function setupRowHandlers() {
                const tbody = equipmentTable ? equipmentTable.querySelector('tbody') : null;
                if (!tbody) return;

                // –û–¥–∏–Ω–∞—Ä–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                tbody.addEventListener('click', (e) => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º —è—á–µ–π–∫–∞–º
                    if (e.target.closest('.editable-cell[contenteditable="true"]')) {
                        return;
                    }
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —è—á–µ–π–∫–∞–º —Ç–∏–ø–∞ (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
                    if (e.target.closest('.role-cell[data-field="equipment_type"]')) {
                        return;
                    }
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —è—á–µ–π–∫–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏ –æ—Ç–¥–µ–ª–æ–≤ (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
                    if (e.target.closest('.facility-cell') || e.target.closest('.department-cell')) {
                        return;
                    }
                    
                    const row = e.target.closest('tr');
                    if (row) {
                        // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞, —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        if (row.classList.contains('selected')) {
                            row.classList.remove('selected');
                            selectedEquipmentRow = null;
                        } else {
                            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                            getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                            row.classList.add('selected');
                            selectedEquipmentRow = row;
                        }
                    }
                });
                
                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã
                document.addEventListener('click', (e) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ —Ç–∞–±–ª–∏—Ü–µ –∏ –Ω–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º—É –º–µ–Ω—é
                    if (!equipmentTable.contains(e.target) && 
                        !(equipmentContextMenu && equipmentContextMenu.contains(e.target))) {
                        getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                        selectedEquipmentRow = null;
                    }
                });
                
                // –ü–ö–ú - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø–æ–∫–∞–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                tbody.addEventListener('contextmenu', (e) => {
                    console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ contextmenu –≤—ã–∑–≤–∞–Ω –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ —Å—Ç—Ä–æ–∫–µ, –∞ –Ω–µ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —è—á–µ–π–∫–µ
                    const contextRow = e.target.closest('tr');
                    console.log('contextRow:', contextRow);
                    if (contextRow && !e.target.closest('.editable-cell[contenteditable="true"]')) {
                        console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é');
                        e.preventDefault();
                        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                        getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                        contextRow.classList.add('selected');
                        selectedEquipmentRow = contextRow;
                        showContextMenu(e, contextRow);
                    } else {
                        console.log('–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–µ –ø–æ–∫–∞–∑–∞–Ω–æ:', {
                            hasContextRow: !!contextRow,
                            isEditableCell: !!e.target.closest('.editable-cell[contenteditable="true"]')
                        });
                    }
                });
            }

            setupRowHandlers();

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
            function showEquipmentStatus(message, state = 'info') {
                if (!equipmentStatusBox) return;
                equipmentStatusBox.textContent = message;
                equipmentStatusBox.dataset.state = state;
                equipmentStatusBox.classList.remove('visible');
                if (message) {
                    requestAnimationFrame(() => equipmentStatusBox.classList.add('visible'));
                    setTimeout(() => {
                        equipmentStatusBox.classList.remove('visible');
                    }, 5000);
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞ —è—á–µ–π–∫–∏
            function revertEquipmentCell(cell) {
                if (!cell) return;
                if (cell.classList.contains('role-cell')) {
                    const typeValue = cell.dataset.originalValue || '';
                    const labelSpan = cell.querySelector('.role-cell-label');
                    if (labelSpan) labelSpan.textContent = typeValue || '‚Äî';
                    cell.dataset.typeValue = typeValue;
                    return;
                }
                cell.textContent = cell.dataset.originalValue || '';
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            function updateEquipmentCell(cell, equipmentId, field, value, equipmentAssignmentId = null) {
                cell.classList.add('saving');
                const payload = { field, value };
                if (equipmentAssignmentId) {
                    payload.equipment_assignment_id = equipmentAssignmentId;
                }
                fetch(`/admin/equipment/${equipmentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    cell.classList.remove('saving');
                    if (ok && data.success) {
                        if (cell.classList.contains('role-cell')) {
                            const labelSpan = cell.querySelector('.role-cell-label');
                            const value = data.value || '';
                            if (labelSpan) labelSpan.textContent = value || '‚Äî';
                            if (cell.dataset.field === 'equipment_type') {
                                cell.dataset.typeValue = value;
                                const typeRow = cell.closest('tr');
                                if (typeRow) {
                                    typeRow.dataset.type = value;
                                }
                            } else if (cell.dataset.field === 'department_id') {
                                cell.dataset.departmentId = value || '';
                                const deptRow = cell.closest('tr');
                                if (deptRow) {
                                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞ –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ
                                    deptRow.dataset.department = value || '';
                                }
                            }
                            cell.dataset.originalValue = value;
                            cell.setAttribute('aria-expanded', 'false');
                        } else if (cell.classList.contains('department-cell')) {
                            const labelSpan = cell.querySelector('.role-cell-label');
                            const value = data.value || '';
                            if (labelSpan) labelSpan.textContent = value || '‚Äî';
                            const deptCellRow = cell.closest('tr');
                            if (deptCellRow) {
                                deptCellRow.dataset.department = value || '';
                                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ facility_name –Ω–µ –ø—É—Å—Ç–æ–µ)
                                if (data.facility_name !== undefined && data.facility_name !== null && data.facility_name !== '') {
                                    const facilityCell = deptCellRow.querySelector('.facility-cell');
                                    if (facilityCell) {
                                        const facilityLabel = facilityCell.querySelector('.role-cell-label');
                                        if (facilityLabel) {
                                            facilityLabel.textContent = data.facility_name;
                                        }
                                        facilityCell.dataset.facilityValue = data.facility_name;
                                    }
                                    deptCellRow.dataset.facility = data.facility_name;
                                    // –û–±–Ω–æ–≤–ª—è–µ–º facilityName –≤ —è—á–µ–π–∫–µ –æ—Ç–¥–µ–ª–∞
                                    cell.dataset.facilityName = data.facility_name;
                                }
                                // –û–±–Ω–æ–≤–ª—è–µ–º departmentId –≤ —è—á–µ–π–∫–µ –æ—Ç–¥–µ–ª–∞
                                if (value === '' || value === '‚Äî') {
                                    cell.dataset.departmentId = '';
                                } else {
                                    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ, –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ ID –æ—Ç–¥–µ–ª–∞
                                    const facilityName = cell.dataset.facilityName || '';
                                    const departments = equipmentDepartmentsByFacility[facilityName] || [];
                                    const dept = departments.find(d => d.name === value);
                                    if (dept) {
                                        cell.dataset.departmentId = String(dept.id);
                                    }
                                }
                            }
                            cell.dataset.originalValue = cell.dataset.departmentId || '';
                        } else {
                            cell.textContent = data.value || '';
                            cell.dataset.originalValue = cell.textContent;
                        }
                        showEquipmentStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                    } else {
                        cell.classList.add('error');
                        revertEquipmentCell(cell);
                        showEquipmentStatus(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                        setTimeout(() => cell.classList.remove('error'), 1500);
                    }
                })
                .catch(() => {
                    cell.classList.remove('saving');
                    cell.classList.add('error');
                    revertEquipmentCell(cell);
                    showEquipmentStatus('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                    setTimeout(() => cell.classList.remove('error'), 1500);
                });
            }

            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–µ–∫
            function setupEditableCells() {
                const editableEquipmentCells = equipmentTable ? equipmentTable.querySelectorAll('td.editable-cell[data-field]') : [];
                editableEquipmentCells.forEach(cell => {
                // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
                cell.addEventListener('dblclick', () => {
                    cell.contentEditable = 'true';
                    cell.dataset.originalValue = cell.textContent.trim();
                    cell.focus();
                    const range = document.createRange();
                    range.selectNodeContents(cell);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                cell.addEventListener('keydown', (event) => {
                    if (cell.contentEditable !== 'true') return;
                    
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        cell.blur();
                    }
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        revertEquipmentCell(cell);
                        cell.blur();
                    }
                });

                cell.addEventListener('blur', () => {
                    cell.contentEditable = 'false';
                    
                    const originalValue = cell.dataset.originalValue ?? '';
                    const newValue = cell.textContent.trim();
                    if (newValue === originalValue) {
                        return;
                    }
                    const row = cell.closest('tr');
                    const equipmentId = row ? row.dataset.equipmentId : null;
                    if (!equipmentId) {
                        revertEquipmentCell(cell);
                        showEquipmentStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.', 'error');
                        return;
                    }
                    const field = cell.dataset.field;
                    if (!field) {
                        revertEquipmentCell(cell);
                        return;
                    }
                    updateEquipmentCell(cell, equipmentId, field, newValue);
                });
            });
            }

            setupEditableCells();

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏ –æ—Ç–¥–µ–ª–æ–≤
            const equipmentDepartmentsData = {{ department_choices|tojson }};
            const equipmentFacilityOptionsMap = {};
            {% for fac in facility_choices %}
            equipmentFacilityOptionsMap[{{ fac.name|tojson }}] = {{ fac.name|tojson }};
            {% endfor %}
            const equipmentDepartmentsByFacility = {};
            {% for dept in department_choices %}
            const equipmentFacilityName_{{ loop.index }} = {{ dept.facility_name|tojson }};
            if (equipmentFacilityName_{{ loop.index }}) {
                if (!equipmentDepartmentsByFacility[equipmentFacilityName_{{ loop.index }}]) {
                    equipmentDepartmentsByFacility[equipmentFacilityName_{{ loop.index }}] = [];
                }
                equipmentDepartmentsByFacility[equipmentFacilityName_{{ loop.index }}].push({
                    id: {{ dept.id }},
                    name: {{ dept.name|tojson }}
                });
            }
            {% endfor %}

            // –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            const equipmentTypeOptions = {{ equipment_types|tojson }};
            const typeDropdown = document.createElement('div');
            typeDropdown.className = 'role-dropdown';
            document.body.appendChild(typeDropdown);

            let currentTypeCell = null;

            function populateTypeDropdown() {
                typeDropdown.innerHTML = '';
                
                equipmentTypeOptions.forEach(type => {
                    if (!type || type.trim() === '') return;
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = type;
                    option.textContent = type;
                    option.addEventListener('click', () => {
                        const targetCell = currentTypeCell;
                        if (!targetCell) return;
                        if (targetCell.dataset.typeValue === type) {
                            closeTypeDropdown();
                            return;
                        }
                        const row = targetCell.closest('tr');
                        if (!row) return;
                        const equipmentId = row.dataset.equipmentId;
                        if (!equipmentId) return;
                        targetCell.dataset.originalValue = targetCell.dataset.typeValue || '';
                        updateEquipmentCell(targetCell, equipmentId, 'equipment_type', type);
                        closeTypeDropdown();
                    });
                    typeDropdown.appendChild(option);
                });
            }

            function positionTypeDropdown(cell) {
                if (!cell || !typeDropdown) return;
                
                const rect = cell.getBoundingClientRect();
                const cellWidth = cell.offsetWidth;
                const rectWidth = rect.width;
                const finalWidth = Math.max(cellWidth, rectWidth);
                
                const viewportHeight = window.innerHeight;
                const maxDropdownHeight = 300; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                
                const tableContainer = document.querySelector('.table-container');
                let containerRect = null;
                if (tableContainer) {
                    containerRect = tableContainer.getBoundingClientRect();
                }
                
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                
                let availableSpaceBelow = spaceBelow;
                let availableSpaceAbove = spaceAbove;
                
                if (containerRect) {
                    const containerBottom = containerRect.bottom;
                    const containerTop = containerRect.top;
                    availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                    availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
                let calculatedHeight = maxDropdownHeight;
                if (availableSpaceBelow < maxDropdownHeight && availableSpaceAbove > availableSpaceBelow) {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–≤–µ—Ä—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Å–≤–µ—Ä—Ö—É
                    calculatedHeight = Math.min(maxDropdownHeight, availableSpaceAbove - 10);
                } else {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–Ω–∏–∑, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Å–Ω–∏–∑—É
                    calculatedHeight = Math.min(maxDropdownHeight, availableSpaceBelow - 10);
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É
                typeDropdown.style.maxHeight = `${calculatedHeight}px`;
                
                const openUpward = availableSpaceBelow < calculatedHeight && availableSpaceAbove > availableSpaceBelow;
                
                typeDropdown.style.position = 'fixed';
                if (openUpward) {
                    typeDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    typeDropdown.style.top = 'auto';
                    typeDropdown.style.maxHeight = `${Math.min(calculatedHeight, availableSpaceAbove - 10)}px`;
                } else {
                    typeDropdown.style.top = `${rect.bottom + 6}px`;
                    typeDropdown.style.bottom = 'auto';
                    typeDropdown.style.maxHeight = `${Math.min(calculatedHeight, availableSpaceBelow - 10)}px`;
                }
                typeDropdown.style.left = `${rect.left}px`;
                typeDropdown.style.width = `${finalWidth}px`;
                typeDropdown.style.minWidth = `${finalWidth}px`;
                typeDropdown.style.maxWidth = `${finalWidth}px`;
                typeDropdown.style.boxSizing = 'border-box';
                typeDropdown.style.flexShrink = '0';
                typeDropdown.style.flexGrow = '0';
                
                const options = typeDropdown.querySelectorAll('.role-dropdown-option');
                options.forEach(opt => {
                    opt.style.width = '100%';
                    opt.style.minWidth = '100%';
                    opt.style.maxWidth = '100%';
                    opt.style.boxSizing = 'border-box';
                    opt.classList.toggle('selected', opt.dataset.value === cell.dataset.typeValue);
                });
            }

            function openTypeDropdown(cell) {
                currentTypeCell = cell;
                cell.setAttribute('aria-expanded', 'true');
                populateTypeDropdown();
                typeDropdown.classList.add('visible');
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ wheel —Å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
                const wheelHandler = (event) => {
                    if (typeDropdown.classList.contains('visible')) {
                        const rect = typeDropdown.getBoundingClientRect();
                        const isOverDropdown = event.clientX >= rect.left && 
                                              event.clientX <= rect.right &&
                                              event.clientY >= rect.top && 
                                              event.clientY <= rect.bottom;
                        
                        if (isOverDropdown) {
                            event.stopPropagation();
                            event.stopImmediatePropagation();
                            isScrollingDropdown = true;
                            
                            const scrollTop = typeDropdown.scrollTop;
                            const scrollHeight = typeDropdown.scrollHeight;
                            const height = typeDropdown.clientHeight;
                            const delta = event.deltaY;
                            
                            if ((scrollTop === 0 && delta < 0) || (scrollTop + height >= scrollHeight && delta > 0)) {
                                event.preventDefault();
                            }
                            
                            setTimeout(() => {
                                isScrollingDropdown = false;
                            }, 100);
                        }
                    }
                };
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                typeDropdown.removeEventListener('wheel', wheelHandler, { capture: true });
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                typeDropdown.addEventListener('wheel', wheelHandler, { passive: false, capture: true });
                
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        positionTypeDropdown(cell);
                        requestAnimationFrame(() => {
                            positionTypeDropdown(cell);
                        });
                    });
                });
            }

            function closeTypeDropdown() {
                if (currentTypeCell) {
                    currentTypeCell.setAttribute('aria-expanded', 'false');
                }
                currentTypeCell = null;
                typeDropdown.classList.remove('visible');
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —è—á–µ–µ–∫ —Ç–∏–ø–æ–≤
            function setupTypeCellHandlers() {
                const typeCells = equipmentTable ? equipmentTable.querySelectorAll('td.role-cell[data-field="equipment_type"]') : [];
                typeCells.forEach(cell => {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    const newCell = cell.cloneNode(true);
                    cell.parentNode.replaceChild(newCell, cell);
                    
                    newCell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        if (currentTypeCell === newCell && typeDropdown.classList.contains('visible')) {
                            closeTypeDropdown();
                        } else {
                            closeTypeDropdown();
                            openTypeDropdown(newCell);
                        }
                    });

                    newCell.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            e.stopPropagation();
                            if (currentTypeCell === newCell && typeDropdown.classList.contains('visible')) {
                                closeTypeDropdown();
                            } else {
                                closeTypeDropdown();
                                openTypeDropdown(newCell);
                            }
                        } else if (e.key === 'Escape') {
                            closeTypeDropdown();
                        }
                    });
                });
            }
            
            setupTypeCellHandlers();

            // –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
            const equipmentFacilityDropdown = document.createElement('div');
            equipmentFacilityDropdown.className = 'role-dropdown';
            document.body.appendChild(equipmentFacilityDropdown);
            let currentEquipmentFacilityCell = null;
            
            // –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª–æ–≤
            const equipmentDepartmentDropdown = document.createElement('div');
            equipmentDepartmentDropdown.className = 'role-dropdown';
            equipmentDepartmentDropdown.setAttribute('data-equipment-department', 'true');
            document.body.appendChild(equipmentDepartmentDropdown);
            let currentEquipmentDepartmentCell = null;

            function populateEquipmentFacilityDropdown() {
                equipmentFacilityDropdown.innerHTML = '';
                Object.keys(equipmentFacilityOptionsMap).forEach(facilityName => {
                    if (!facilityName || facilityName.trim() === '') return;
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = facilityName;
                    option.textContent = facilityName;
                    option.addEventListener('click', () => {
                        const targetCell = currentEquipmentFacilityCell;
                        if (!targetCell) return;
                        if (targetCell.dataset.facilityValue === facilityName) {
                            closeEquipmentFacilityDropdown();
                            return;
                        }
                        const row = targetCell.closest('tr');
                        if (!row) return;
                        const equipmentId = row.dataset.equipmentId;
                        const equipmentAssignmentId = row.dataset.equipmentAssignmentId;
                        if (!equipmentId) return;
                        targetCell.dataset.originalValue = targetCell.dataset.facilityValue || '';
                        // –û–±–Ω–æ–≤–ª—è–µ–º facility –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ —Å—Ç—Ä–æ–∫–∏
                        row.dataset.facility = facilityName;
                        // –î–ª—è facility –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ
                        const labelSpan = targetCell.querySelector('.role-cell-label');
                        if (labelSpan) labelSpan.textContent = facilityName || '‚Äî';
                        targetCell.dataset.facilityValue = facilityName;
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
                        const departmentCell = row.querySelector('.department-cell');
                        if (departmentCell) {
                            const deptLabelSpan = departmentCell.querySelector('.role-cell-label');
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫ –≤ –æ—Ç–¥–µ–ª–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
                            if (deptLabelSpan) deptLabelSpan.textContent = '‚Äî';
                            departmentCell.dataset.departmentId = '';
                            // –û–±–Ω–æ–≤–ª—è–µ–º facilityName –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ—Ç–¥–µ–ª–æ–≤
                            departmentCell.dataset.facilityName = facilityName || '';
                            row.dataset.department = '';
                            
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                            if (equipmentAssignmentId) {
                                updateEquipmentCell(departmentCell, equipmentId, 'department_id', '', parseInt(equipmentAssignmentId));
                            }
                        }
                        
                        closeEquipmentFacilityDropdown();
                    });
                    equipmentFacilityDropdown.appendChild(option);
                });
            }

            function positionEquipmentFacilityDropdown(cell) {
                if (!cell || !equipmentFacilityDropdown) return;
                
                const rect = cell.getBoundingClientRect();
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±–∏—Ä–∞–µ–º inset, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç left
                equipmentDepartmentDropdown.style.removeProperty('inset');
                equipmentDepartmentDropdown.style.setProperty('inset', 'unset', 'important');
                // –¢–∞–∫–∂–µ —É–±–∏—Ä–∞–µ–º top, bottom, right, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∏
                equipmentDepartmentDropdown.style.removeProperty('top');
                equipmentDepartmentDropdown.style.removeProperty('bottom');
                equipmentDepartmentDropdown.style.removeProperty('right');
                equipmentDepartmentDropdown.style.removeProperty('left');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º offsetWidth –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã —è—á–µ–π–∫–∏
                // offsetWidth –≤–∫–ª—é—á–∞–µ—Ç padding –∏ border, —á—Ç–æ –¥–∞—ë—Ç —Ç–æ—á–Ω—É—é —à–∏—Ä–∏–Ω—É
                const cellWidth = cell.offsetWidth;
                // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º rect.width –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                const rectWidth = rect.width;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
                const finalWidth = Math.max(cellWidth, rectWidth);
                const dropdownHeight = equipmentFacilityDropdown.offsetHeight || 200;
                const viewportHeight = window.innerHeight;
                
                const tableContainer = document.querySelector('.table-container');
                let containerRect = null;
                if (tableContainer) {
                    containerRect = tableContainer.getBoundingClientRect();
                }
                
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                
                let availableSpaceBelow = spaceBelow;
                let availableSpaceAbove = spaceAbove;
                
                if (containerRect) {
                    const containerBottom = containerRect.bottom;
                    const containerTop = containerRect.top;
                    availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                    availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
                }
                
                const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
                
                equipmentFacilityDropdown.style.position = 'fixed';
                equipmentFacilityDropdown.style.zIndex = '10000';
                if (openUpward) {
                    equipmentFacilityDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    equipmentFacilityDropdown.style.top = 'auto';
                } else {
                    equipmentFacilityDropdown.style.top = `${rect.bottom + 6}px`;
                    equipmentFacilityDropdown.style.bottom = 'auto';
                }
                equipmentFacilityDropdown.style.left = `${rect.left}px`;
                equipmentFacilityDropdown.style.width = `${finalWidth}px`;
                equipmentFacilityDropdown.style.minWidth = `${finalWidth}px`;
                equipmentFacilityDropdown.style.maxWidth = `${finalWidth}px`;
                equipmentFacilityDropdown.style.boxSizing = 'border-box';
                equipmentFacilityDropdown.style.flexShrink = '0';
                equipmentFacilityDropdown.style.flexGrow = '0';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã
                equipmentFacilityDropdown.style.setProperty('width', `${finalWidth}px`, 'important');
                equipmentFacilityDropdown.style.setProperty('min-width', `${finalWidth}px`, 'important');
                equipmentFacilityDropdown.style.setProperty('max-width', `${finalWidth}px`, 'important');
                
                const options = equipmentFacilityDropdown.querySelectorAll('.role-dropdown-option');
                options.forEach(opt => {
                    opt.style.width = '100%';
                    opt.style.minWidth = '100%';
                    opt.style.maxWidth = '100%';
                    opt.style.boxSizing = 'border-box';
                    opt.classList.toggle('selected', opt.dataset.value === cell.dataset.facilityValue);
                });
            }

            function openEquipmentFacilityDropdown(cell) {
                currentEquipmentFacilityCell = cell;
                cell.setAttribute('aria-expanded', 'true');
                populateEquipmentFacilityDropdown();
                equipmentFacilityDropdown.classList.add('visible');
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        positionEquipmentFacilityDropdown(cell);
                        requestAnimationFrame(() => {
                            positionEquipmentFacilityDropdown(cell);
                        });
                    });
                });
            }

            function closeEquipmentFacilityDropdown() {
                if (currentEquipmentFacilityCell) {
                    currentEquipmentFacilityCell.setAttribute('aria-expanded', 'false');
                }
                currentEquipmentFacilityCell = null;
                equipmentFacilityDropdown.classList.remove('visible');
            }

            function populateEquipmentDepartmentDropdown(cell) {
                equipmentDepartmentDropdown.innerHTML = '';
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –∏–∑ —è—á–µ–π–∫–∏ –æ—Ç–¥–µ–ª–∞ –∏–ª–∏ –∏–∑ —è—á–µ–π–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏
                let facilityName = cell.dataset.facilityName || '';
                const row = cell.closest('tr');
                if (row) {
                    const facilityCell = row.querySelector('.facility-cell');
                    if (facilityCell && facilityCell.dataset.facilityValue) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –∏–∑ —è—á–µ–π–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
                        facilityName = facilityCell.dataset.facilityValue;
                        // –û–±–Ω–æ–≤–ª—è–µ–º facilityName –≤ —è—á–µ–π–∫–µ –æ—Ç–¥–µ–ª–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
                        cell.dataset.facilityName = facilityName;
                    }
                }
                const departments = equipmentDepartmentsByFacility[facilityName] || [];
                
                departments.forEach(dept => {
                    if (!dept || !dept.name || dept.name.trim() === '') return;
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = dept.id;
                    option.textContent = dept.name;
                    option.addEventListener('click', () => {
                        const targetCell = currentEquipmentDepartmentCell;
                        if (!targetCell) return;
                        const currentId = targetCell.dataset.departmentId || '';
                        if (currentId === String(dept.id)) {
                            closeEquipmentDepartmentDropdown();
                            return;
                        }
                        const row = targetCell.closest('tr');
                        if (!row) return;
                        const equipmentId = row.dataset.equipmentId;
                        const equipmentAssignmentId = row.dataset.equipmentAssignmentId;
                        if (!equipmentId || !equipmentAssignmentId) return;
                        targetCell.dataset.originalValue = targetCell.dataset.departmentId || '';
                        updateEquipmentCell(targetCell, equipmentId, 'department_id', dept.id, parseInt(equipmentAssignmentId));
                        closeEquipmentDepartmentDropdown();
                    });
                    equipmentDepartmentDropdown.appendChild(option);
                });
            }

            function positionEquipmentDepartmentDropdown(cell) {
                if (!cell || !equipmentDepartmentDropdown) return;
                
                const rect = cell.getBoundingClientRect();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º offsetWidth –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã —è—á–µ–π–∫–∏
                // offsetWidth –≤–∫–ª—é—á–∞–µ—Ç padding –∏ border, —á—Ç–æ –¥–∞—ë—Ç —Ç–æ—á–Ω—É—é —à–∏—Ä–∏–Ω—É
                const cellWidth = cell.offsetWidth;
                // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º rect.width –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                const rectWidth = rect.width;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
                const finalWidth = Math.max(cellWidth, rectWidth);
                const dropdownHeight = equipmentDepartmentDropdown.offsetHeight || 200;
                const viewportHeight = window.innerHeight;
                
                const tableContainer = document.querySelector('.table-container');
                let containerRect = null;
                if (tableContainer) {
                    containerRect = tableContainer.getBoundingClientRect();
                }
                
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                
                let availableSpaceBelow = spaceBelow;
                let availableSpaceAbove = spaceAbove;
                
                if (containerRect) {
                    const containerBottom = containerRect.bottom;
                    const containerTop = containerRect.top;
                    availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                    availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
                }
                
                const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
                
                equipmentDepartmentDropdown.style.position = 'fixed';
                equipmentDepartmentDropdown.style.zIndex = '10000';
                if (openUpward) {
                    equipmentDepartmentDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    equipmentDepartmentDropdown.style.top = 'auto';
                } else {
                    equipmentDepartmentDropdown.style.top = `${rect.bottom + 6}px`;
                    equipmentDepartmentDropdown.style.bottom = 'auto';
                }
                equipmentDepartmentDropdown.style.left = `${rect.left}px`;
                equipmentDepartmentDropdown.style.width = `${finalWidth}px`;
                equipmentDepartmentDropdown.style.minWidth = `${finalWidth}px`;
                equipmentDepartmentDropdown.style.maxWidth = `${finalWidth}px`;
                equipmentDepartmentDropdown.style.boxSizing = 'border-box';
                equipmentDepartmentDropdown.style.flexShrink = '0';
                equipmentDepartmentDropdown.style.flexGrow = '0';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã
                equipmentDepartmentDropdown.style.setProperty('width', `${finalWidth}px`, 'important');
                equipmentDepartmentDropdown.style.setProperty('min-width', `${finalWidth}px`, 'important');
                equipmentDepartmentDropdown.style.setProperty('max-width', `${finalWidth}px`, 'important');
                
                const options = equipmentDepartmentDropdown.querySelectorAll('.role-dropdown-option');
                options.forEach(opt => {
                    opt.style.width = '100%';
                    opt.style.minWidth = '100%';
                    opt.style.maxWidth = '100%';
                    opt.style.boxSizing = 'border-box';
                    opt.classList.toggle('selected', opt.dataset.value === cell.dataset.departmentId);
                });
            }

            function openEquipmentDepartmentDropdown(cell) {
                currentEquipmentDepartmentCell = cell;
                cell.setAttribute('aria-expanded', 'true');
                populateEquipmentDepartmentDropdown(cell);
                equipmentDepartmentDropdown.classList.add('visible');
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É–∂–µ –µ—Å—Ç—å requestAnimationFrame)
                positionEquipmentDepartmentDropdown(cell);
            }

            function closeEquipmentDepartmentDropdown() {
                if (currentEquipmentDepartmentCell) {
                    currentEquipmentDepartmentCell.setAttribute('aria-expanded', 'false');
                }
                currentEquipmentDepartmentCell = null;
                equipmentDepartmentDropdown.classList.remove('visible');
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —è—á–µ–µ–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏ –æ—Ç–¥–µ–ª–æ–≤
            function setupEquipmentFacilityDepartmentHandlers() {
                const facilityCells = equipmentTable ? equipmentTable.querySelectorAll('td.facility-cell') : [];
                const departmentCells = equipmentTable ? equipmentTable.querySelectorAll('td.department-cell') : [];
                
                facilityCells.forEach(cell => {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                    const newCell = cell.cloneNode(true);
                    cell.parentNode.replaceChild(newCell, cell);
                    
                    newCell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        closeEquipmentDepartmentDropdown();
                        closeTypeDropdown();
                        if (currentEquipmentFacilityCell === newCell && equipmentFacilityDropdown.classList.contains('visible')) {
                            closeEquipmentFacilityDropdown();
                        } else {
                            closeEquipmentFacilityDropdown();
                            openEquipmentFacilityDropdown(newCell);
                        }
                    });
                    newCell.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            e.stopPropagation();
                            closeEquipmentDepartmentDropdown();
                            closeTypeDropdown();
                            if (currentEquipmentFacilityCell === newCell && equipmentFacilityDropdown.classList.contains('visible')) {
                                closeEquipmentFacilityDropdown();
                            } else {
                                closeEquipmentFacilityDropdown();
                                openEquipmentFacilityDropdown(newCell);
                            }
                        } else if (e.key === 'Escape') {
                            closeEquipmentFacilityDropdown();
                        }
                    });
                });
                
                departmentCells.forEach(cell => {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                    const newCell = cell.cloneNode(true);
                    cell.parentNode.replaceChild(newCell, cell);
                    
                    newCell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        closeEquipmentFacilityDropdown();
                        closeTypeDropdown();
                        if (currentEquipmentDepartmentCell === newCell && equipmentDepartmentDropdown.classList.contains('visible')) {
                            closeEquipmentDepartmentDropdown();
                        } else {
                            closeEquipmentDepartmentDropdown();
                            openEquipmentDepartmentDropdown(newCell);
                        }
                    });
                    newCell.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            e.stopPropagation();
                            closeEquipmentFacilityDropdown();
                            closeTypeDropdown();
                            if (currentEquipmentDepartmentCell === newCell && equipmentDepartmentDropdown.classList.contains('visible')) {
                                closeEquipmentDepartmentDropdown();
                            } else {
                                closeEquipmentDepartmentDropdown();
                                openEquipmentDepartmentDropdown(newCell);
                            }
                        } else if (e.key === 'Escape') {
                            closeEquipmentDepartmentDropdown();
                        }
                    });
                });
            }
            
            setupEquipmentFacilityDepartmentHandlers();

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', (e) => {
                if (!equipmentFacilityDropdown.contains(e.target) && !e.target.closest('.facility-cell')) {
                    closeEquipmentFacilityDropdown();
                }
                if (!equipmentDepartmentDropdown.contains(e.target) && !e.target.closest('.department-cell')) {
                    closeEquipmentDepartmentDropdown();
                }
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            function isPointInDropdown(x, y) {
                if (!typeDropdown.classList.contains('visible')) return false;
                const rect = typeDropdown.getBoundingClientRect();
                return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
            }
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ wheel –Ω–∞ document —Å capture: true (—Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–º)
            document.addEventListener('wheel', (event) => {
                if (isPointInDropdown(event.clientX, event.clientY)) {
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    isScrollingDropdown = true;
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    const scrollTop = typeDropdown.scrollTop;
                    const scrollHeight = typeDropdown.scrollHeight;
                    const height = typeDropdown.clientHeight;
                    const delta = event.deltaY;
                    
                    // –ï—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ—Å—Ç–∏–≥–ª–∞ –≥—Ä–∞–Ω–∏—Ü, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    if ((scrollTop === 0 && delta < 0) || (scrollTop + height >= scrollHeight && delta > 0)) {
                        event.preventDefault();
                    }
                    
                    setTimeout(() => {
                        isScrollingDropdown = false;
                    }, 300);
                    return;
                }
            }, { capture: true, passive: false });
            
            // –§–ª–∞–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–æ–º
            let isDraggingScrollbar = false;
            let mousedownInDropdown = false;
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mousedown –Ω–∞ document —Å capture: true
            document.addEventListener('mousedown', (event) => {
                if (isPointInDropdown(event.clientX, event.clientY)) {
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    mousedownInDropdown = true;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –º—ã –Ω–∞ —Å–∫—Ä–æ–ª–ª–±–∞—Ä (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–∞)
                    const rect = typeDropdown.getBoundingClientRect();
                    const scrollbarWidth = 12; // –®–∏—Ä–∏–Ω–∞ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ —Å –Ω–µ–±–æ–ª—å—à–∏–º –∑–∞–ø–∞—Å–æ–º
                    const isOnScrollbar = event.clientX >= rect.right - scrollbarWidth;
                    
                    if (isOnScrollbar) {
                        isDraggingScrollbar = true;
                        isScrollingDropdown = true;
                    } else {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º —Å–æ–±—ã—Ç–∏–∏ scroll
                        isScrollingDropdown = true;
                        setTimeout(() => {
                            isScrollingDropdown = false;
                        }, 300);
                    }
                    return;
                } else {
                    mousedownInDropdown = false;
                }
            }, { capture: true });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseup –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–ª–∞–≥–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            document.addEventListener('mouseup', (event) => {
                if (isDraggingScrollbar) {
                    isDraggingScrollbar = false;
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º —Ñ–ª–∞–≥–∞, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ click —É—Å–ø–µ–ª –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                    setTimeout(() => {
                        isScrollingDropdown = false;
                    }, 300);
                }
                if (isPointInDropdown(event.clientX, event.clientY) || mousedownInDropdown) {
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    mousedownInDropdown = false;
                }
            }, { capture: true });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mousemove –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞
            document.addEventListener('mousemove', (event) => {
                if (isDraggingScrollbar) {
                    isScrollingDropdown = true;
                }
            }, { capture: true });
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ click –Ω–∞ document (—Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–º)
            document.addEventListener('click', (event) => {
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –Ω–µ –≤–∏–¥–∏–º
                if (!typeDropdown.classList.contains('visible')) return;
                
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –∏–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
                if (isDraggingScrollbar || isScrollingDropdown) {
                    return;
                }
                
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                if (typeDropdown.contains(event.target)) return;
                
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ —è—á–µ–π–∫–µ —Ç–∏–ø–∞
                if (event.target.closest('.role-cell[data-field="equipment_type"]')) return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–µ
                if (isPointInDropdown(event.clientX, event.clientY)) {
                    return;
                }
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–±—ã—Ç–∏—è mousedown/mouseup
                setTimeout(() => {
                    // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                    if (!isDraggingScrollbar && !isScrollingDropdown && !mousedownInDropdown && typeDropdown.classList.contains('visible')) {
                        closeTypeDropdown();
                    }
                }, 150);
            }, { capture: false });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ —Å–∞–º–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã
            typeDropdown.addEventListener('mousedown', (event) => {
                event.stopPropagation();
                event.stopImmediatePropagation();
            }, { capture: true });
            
            typeDropdown.addEventListener('click', (event) => {
                event.stopPropagation();
                event.stopImmediatePropagation();
            }, { capture: true });
            
            typeDropdown.addEventListener('wheel', (event) => {
                event.stopPropagation();
                event.stopImmediatePropagation();
            }, { capture: true, passive: false });

            window.addEventListener('resize', () => {
                if (currentTypeCell) {
                    requestAnimationFrame(() => {
                        positionTypeDropdown(currentTypeCell);
                    });
                }
            });

            // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            let isScrollingDropdown = false;
            let dropdownScrollTimeout = null;
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            typeDropdown.addEventListener('scroll', (event) => {
                if (typeDropdown.classList.contains('visible')) {
                    isScrollingDropdown = true;
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
                    if (dropdownScrollTimeout) {
                        clearTimeout(dropdownScrollTimeout);
                    }
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
                    dropdownScrollTimeout = setTimeout(() => {
                        isScrollingDropdown = false;
                    }, 200);
                }
            });
            
            window.addEventListener('scroll', (event) => {
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                if (isScrollingDropdown) return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–µ –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
                // –î–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞–¥ –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–æ–º
                if (currentTypeCell && typeDropdown.classList.contains('visible')) {
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
                    // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ scroll –±—ã–ª–æ –≤—ã–∑–≤–∞–Ω–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º
                    if (isScrollingDropdown) return;
                    
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ scroll –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
                    setTimeout(() => {
                        if (!isScrollingDropdown && typeDropdown.classList.contains('visible')) {
                            closeTypeDropdown();
                        }
                    }, 100);
                }
            }, true);

            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.addEventListener('scroll', () => {
                    // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                    if (isScrollingDropdown) return;
                    if (currentTypeCell && typeDropdown.classList.contains('visible')) {
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ scroll –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
                        setTimeout(() => {
                            if (!isScrollingDropdown && typeDropdown.classList.contains('visible')) {
                                closeTypeDropdown();
                            }
                        }, 50);
                    }
                });
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —Å—Ç—Ä–æ–∫
            function applyEquipmentRowStriping() {
                // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ DOM –∫–∞–∂–¥—ã–π —Ä–∞–∑
                if (!equipmentTable) return;
                const rows = equipmentTable.querySelectorAll('tbody tr');
                let visibleIndex = 0;
                rows.forEach(row => {
                    if (row.style.display === 'none') {
                        row.classList.remove('alt-row');
                        return;
                    }
                    const isAlt = visibleIndex % 2 === 1;
                    row.classList.toggle('alt-row', isAlt);
                    visibleIndex += 1;
                });
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
            function applyEquipmentFilters() {
                const searchValue = equipmentSearch ? equipmentSearch.value.toLowerCase().trim() : '';
                const typeValue = typeFilter ? typeFilter.value : '';
                const statusValue = statusFilter ? statusFilter.value : '';
                const locationValue = locationFilter ? locationFilter.value : '';

                getAllEquipmentRows().forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const rowType = (row.dataset.type || '').toLowerCase();
                    const rowStatus = (row.dataset.status || '').toLowerCase();
                    const rowLocation = (row.dataset.location || '').toLowerCase();

                    const matchesSearch = searchValue === '' || text.includes(searchValue);
                    const matchesType = typeValue === '' || rowType === typeValue.toLowerCase();
                    const matchesStatus = statusValue === '' || rowStatus === statusValue.toLowerCase();
                    const matchesLocation = locationValue === '' || rowLocation === locationValue.toLowerCase();

                    if (matchesSearch && matchesType && matchesStatus && matchesLocation) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                let visibleIndex = 0;
                getAllEquipmentRows().forEach(row => {
                    if (row.style.display !== 'none') {
                        const numberCell = row.querySelector('.number-column');
                        if (numberCell) {
                            numberCell.textContent = visibleIndex + 1;
                        }
                        visibleIndex++;
                    }
                });

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤
                applyEquipmentRowStriping();
            }

            // –ü–æ–∏—Å–∫
            if (equipmentSearch) {
                equipmentSearch.addEventListener('input', applyEquipmentFilters);
            } else {
                console.error('equipmentSearch –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }

            // –§–∏–ª—å—Ç—Ä—ã
            const equipmentFilterSelectWrappers = document.querySelectorAll('#equipmentFilterDropdown .filter-select[data-target]');
            const equipmentFilterSelectControllers = new Map();

            function closeEquipmentFilterSelectMenus() {
                equipmentFilterSelectWrappers.forEach(wrapper => {
                    wrapper.classList.remove('open');
                    const btn = wrapper.querySelector('.filter-select-btn');
                    if (btn) {
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            if (equipmentFilterToggle && equipmentFilterDropdown) {
                equipmentFilterToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    equipmentFilterDropdown.classList.toggle('active');
                    equipmentFilterToggle.classList.toggle('active');
                    if (!equipmentFilterDropdown.classList.contains('active')) {
                        closeEquipmentFilterSelectMenus();
                    }
                });

                [typeFilter, statusFilter, locationFilter].forEach(filter => {
                    if (filter) {
                        filter.addEventListener('change', applyEquipmentFilters);
                    }
                });

                if (resetEquipmentFilters) {
                    resetEquipmentFilters.addEventListener('click', () => {
                        if (equipmentSearch) equipmentSearch.value = '';
                        if (typeFilter) typeFilter.value = '';
                        if (statusFilter) statusFilter.value = '';
                        if (locationFilter) locationFilter.value = '';
                        if (equipmentSortColumnFilter) equipmentSortColumnFilter.value = '';
                        if (equipmentSortDirectionFilter) equipmentSortDirectionFilter.value = 'asc';
                        applyEquipmentFilters();
                        equipmentFilterSelectControllers.forEach(controller => controller.sync());
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                if (equipmentSortColumnFilter) {
                    equipmentSortColumnFilter.addEventListener('change', () => {
                        const columnIndex = equipmentSortColumnFilter.value ? parseInt(equipmentSortColumnFilter.value) : null;
                        const sortDirection = equipmentSortDirectionFilter ? equipmentSortDirectionFilter.value : 'asc';
                        if (columnIndex !== null && equipmentTable) {
                            applyTableSorting(equipmentTable, columnIndex, sortDirection, applyEquipmentFilters, applyEquipmentRowStriping);
                        } else if (columnIndex === null) {
                            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫", –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                            applyEquipmentFilters();
                        }
                    });
                }

                if (equipmentSortDirectionFilter) {
                    equipmentSortDirectionFilter.addEventListener('change', () => {
                        const columnIndex = equipmentSortColumnFilter && equipmentSortColumnFilter.value ? parseInt(equipmentSortColumnFilter.value) : null;
                        const sortDirection = equipmentSortDirectionFilter.value;
                        if (columnIndex !== null && equipmentTable) {
                            applyTableSorting(equipmentTable, columnIndex, sortDirection, applyEquipmentFilters, applyEquipmentRowStriping);
                        }
                    });
                }

                document.addEventListener('click', (event) => {
                    if (!equipmentFilterDropdown.contains(event.target) && !equipmentFilterToggle.contains(event.target)) {
                        equipmentFilterDropdown.classList.remove('active');
                        equipmentFilterToggle.classList.remove('active');
                        closeEquipmentFilterSelectMenus();
                    }
                });
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            equipmentFilterSelectWrappers.forEach(wrapper => {
                const targetId = wrapper.dataset.target;
                const selectEl = document.getElementById(targetId);
                if (!selectEl) return;

                const button = wrapper.querySelector('.filter-select-btn');
                const label = button ? button.querySelector('.filter-select-label') : null;
                const optionButtons = wrapper.querySelectorAll('.filter-option');
                const resetBtn = wrapper.parentElement.querySelector('.filter-reset-btn[data-target="' + targetId + '"]');

                function syncUI() {
                    const value = selectEl.value || '';
                    const selectedOption = Array.from(selectEl.options).find(opt => opt.value === value);
                    const displayText = selectedOption ? selectedOption.textContent.trim() : '–í—Å–µ';
                    if (label) {
                        label.textContent = displayText;
                    }
                    if (resetBtn) {
                        resetBtn.style.display = value ? '' : 'none';
                    }
                }

                optionButtons.forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const value = btn.dataset.value || '';
                        if (selectEl.value !== value) {
                            selectEl.value = value;
                            selectEl.dispatchEvent(new Event('change'));
                        } else {
                            selectEl.dispatchEvent(new Event('change'));
                        }
                        syncUI();
                        closeEquipmentFilterSelectMenus();
                    });
                });

                if (button) {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const isOpen = wrapper.classList.contains('open');
                        closeEquipmentFilterSelectMenus();
                        if (!isOpen) {
                            wrapper.classList.add('open');
                            button.setAttribute('aria-expanded', 'true');
                        }
                    });
                }

                selectEl.addEventListener('change', syncUI);

                if (resetBtn) {
                    resetBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        selectEl.value = '';
                        selectEl.dispatchEvent(new Event('change'));
                        syncUI();
                        closeEquipmentFilterSelectMenus();
                    });
                }

                syncUI();
                equipmentFilterSelectControllers.set(selectEl, { sync: syncUI });
            });

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            const equipmentForm = document.getElementById('equipmentForm');
            const equipmentFormSubmit = document.getElementById('equipmentFormSubmit');
            const equipmentFormError = document.getElementById('equipmentFormError');
            const sparePartTypesList = document.getElementById('sparePartTypesList');
            const addSparePartTypeBtn = document.getElementById('addSparePartTypeBtn');
            const sparePartTypeSelect = document.getElementById('equipmentSparePartTypeSelect');
            let selectedSparePartTypes = [];

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –î–û –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            const equipmentTypeBtn = document.getElementById('equipmentTypeBtn');
            const equipmentMaintenanceBtn = document.getElementById('equipmentMaintenanceBtn');
            const equipmentDepartmentBtn = document.getElementById('equipmentDepartmentBtn');
            const equipmentDepartmentBtnNew = document.getElementById('equipmentDepartmentBtnNew');
            const sparePartTypeBtn = document.getElementById('equipmentSparePartTypeBtn');

            // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ä–µ–∂–∏–º–æ–≤
            const equipmentNameInput = document.getElementById('equipmentNameInput');
            const equipmentSearchResults = document.getElementById('equipmentSearchResults');
            const equipmentModeIndicator = document.getElementById('equipmentModeIndicator');
            const newEquipmentForm = document.getElementById('newEquipmentForm');
            const existingEquipmentForm = document.getElementById('existingEquipmentForm');
            const existingEquipmentId = document.getElementById('existingEquipmentId');
            let searchTimeout = null;
            let selectedExistingEquipment = null;
            
            function openEquipmentModal() {
                if (!equipmentModal) return;
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                initializeEquipmentModalSelectData();
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
                if (typeof closeModalDropdown === 'function') {
                    closeModalDropdown();
                }
                equipmentModal.classList.add('visible');
                document.body.classList.add('modal-open');
                // –£–±–∏—Ä–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                setTimeout(() => {
                    equipmentModal.setAttribute('aria-hidden', 'false');
                }, 100);
                // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                if (equipmentForm) {
                    equipmentForm.reset();
                    selectedSparePartTypes = [];
                    selectedExistingEquipment = null;
                    if (sparePartTypesList) {
                        sparePartTypesList.innerHTML = '';
                    }
                    // –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–æ–≤
                    if (newEquipmentForm) newEquipmentForm.style.display = 'none';
                    if (existingEquipmentForm) existingEquipmentForm.style.display = 'none';
                    if (equipmentModeIndicator) equipmentModeIndicator.style.display = 'none';
                    if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                    if (equipmentNameInput) equipmentNameInput.value = '';
                    if (existingEquipmentId) existingEquipmentId.value = '';
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                const customEquipmentTypeRow = document.getElementById('customEquipmentTypeRow');
                const customMaintenanceRow = document.getElementById('customMaintenanceRow');
                const customEquipmentType = document.getElementById('customEquipmentType');
                const customMaintenanceFrequency = document.getElementById('customMaintenanceFrequency');
                
                if (customEquipmentTypeRow) {
                    customEquipmentTypeRow.style.display = 'none';
                }
                if (customMaintenanceRow) {
                    customMaintenanceRow.style.display = 'none';
                }
                if (customEquipmentType) {
                    customEquipmentType.value = '';
                    customEquipmentType.removeAttribute('required');
                }
                if (customMaintenanceFrequency) {
                    customMaintenanceFrequency.value = '';
                    customMaintenanceFrequency.removeAttribute('required');
                }
                // –°–±—Ä–æ—Å –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                closeEquipmentModalDropdown();
                const equipmentFacilityBtn = document.getElementById('equipmentFacilityBtn');
                const equipmentFacilityBtnNew = document.getElementById('equipmentFacilityBtnNew');
                const warrantyPeriodUnitBtn = document.getElementById('warrantyPeriodUnitBtn');
                const equipmentBtns = [equipmentTypeBtn, equipmentMaintenanceBtn, equipmentFacilityBtn, equipmentFacilityBtnNew, equipmentDepartmentBtn, equipmentDepartmentBtnNew, sparePartTypeBtn, warrantyPeriodUnitBtn];
                equipmentBtns.forEach(btn => {
                    if (btn) {
                        const label = btn.querySelector('.modal-select-label');
                        if (label) {
                            const defaultTexts = {
                                'equipmentTypeBtn': '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø',
                                'equipmentMaintenanceBtn': '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å',
                                'equipmentFacilityBtn': '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ',
                                'equipmentDepartmentBtn': '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ',
                                'equipmentDepartmentBtnNew': '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª',
                                'sparePartTypeBtn': '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏',
                                'warrantyPeriodUnitBtn': '–ú–µ—Å—è—Ü–µ–≤'
                            };
                            label.textContent = defaultTexts[btn.id] || '–í—ã–±–µ—Ä–∏—Ç–µ...';
                        }
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
                const warrantyPeriodUnitSelect = document.getElementById('warrantyPeriodUnit');
                if (warrantyPeriodUnitBtn && warrantyPeriodUnitSelect) {
                    const label = warrantyPeriodUnitBtn.querySelector('.modal-select-label');
                    const selectedOption = warrantyPeriodUnitSelect.options[warrantyPeriodUnitSelect.selectedIndex];
                    if (label && selectedOption) {
                        label.textContent = selectedOption.textContent;
                    }
                }
                // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –∏ –æ—Ç–¥–µ–ª–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                const acquisitionDateInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="acquisition_date"]') : null;
                
                // –£–±–∏—Ä–∞–µ–º required —Å –ø–æ–ª–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if (equipmentFacilitySelect) {
                    equipmentFacilitySelect.value = '';
                    equipmentFacilitySelect.removeAttribute('required');
                    handleEquipmentFacilityChange();
                }
                if (equipmentDepartmentSelect) {
                    equipmentDepartmentSelect.removeAttribute('required');
                }
                if (acquisitionDateInput) {
                    acquisitionDateInput.removeAttribute('required');
                }
                
                if (equipmentFormError) {
                    equipmentFormError.textContent = '';
                }
                // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è
                if (equipmentNameInput) {
                    setTimeout(() => equipmentNameInput.focus(), 100);
                }
            }
            
            // –ü–æ–∏—Å–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            if (equipmentNameInput) {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
                equipmentNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                        if (equipmentSearchResults && equipmentSearchResults.style.display !== 'none') {
                            return;
                        }
                        // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –≤–∏–¥–Ω–∞, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                        const isNewFormVisible = newEquipmentForm && newEquipmentForm.style.display !== 'none';
                        const isExistingFormVisible = existingEquipmentForm && existingEquipmentForm.style.display !== 'none';
                        if (!isNewFormVisible && !isExistingFormVisible) {
                            return;
                        }
                    }
                });
                
                equipmentNameInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã, –Ω–æ –Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (–æ–Ω–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã)
                    if (equipmentModeIndicator) equipmentModeIndicator.style.display = 'none';
                    if (newEquipmentForm) newEquipmentForm.style.display = 'none';
                    if (existingEquipmentForm) existingEquipmentForm.style.display = 'none';
                    selectedExistingEquipment = null;
                    if (existingEquipmentId) existingEquipmentId.value = '';
                    
                    // –£–±–∏—Ä–∞–µ–º required —Å –ø–æ–ª–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏
                    const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                    const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                    const acquisitionDateInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="acquisition_date"]') : null;
                    if (equipmentFacilitySelect) equipmentFacilitySelect.removeAttribute('required');
                    if (equipmentDepartmentSelect) equipmentDepartmentSelect.removeAttribute('required');
                    if (acquisitionDateInput) acquisitionDateInput.removeAttribute('required');
                    
                    if (query.length < 2) {
                        // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
                        if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                        return;
                    }
                    
                    // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º
                    searchTimeout = setTimeout(() => {
                        console.log('–í—ã–ø–æ–ª–Ω—è—é –ø–æ–∏—Å–∫ –¥–ª—è:', query);
                        fetch(`/admin/equipment/search?q=${encodeURIComponent(query)}`)
                            .then(response => {
                                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, status:', response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∞:', data);
                                if (data.success && data.results !== undefined) {
                                    displaySearchResults(data.results, query);
                                } else {
                                    console.warn('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:', data);
                                }
                            })
                            .catch(err => {
                                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
                            });
                    }, 300);
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
                document.addEventListener('click', (e) => {
                    const searchRow = equipmentNameInput ? equipmentNameInput.closest('.modal-row') : null;
                    if (equipmentSearchResults && 
                        !equipmentNameInput.contains(e.target) && 
                        !equipmentSearchResults.contains(e.target) &&
                        !(searchRow && searchRow.contains(e.target) && e.target !== equipmentNameInput)) {
                        equipmentSearchResults.style.display = 'none';
                    }
                });
            }
            
            function displaySearchResults(results, query) {
                console.log('displaySearchResults called with:', results.length, 'results, query:', query);
                if (!equipmentSearchResults) {
                    console.error('equipmentSearchResults element not found!');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é input –ø–æ–ª—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const inputRect = equipmentNameInput ? equipmentNameInput.getBoundingClientRect() : null;
                const searchRow = equipmentNameInput ? equipmentNameInput.closest('.modal-row') : null;
                const rowRect = searchRow ? searchRow.getBoundingClientRect() : null;
                
                console.log('equipmentSearchResults found, clearing innerHTML');
                equipmentSearchResults.innerHTML = '';
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ input –ø–æ–ª—è
                if (inputRect && rowRect) {
                    equipmentSearchResults.style.top = `${inputRect.bottom - rowRect.top + 4}px`;
                    equipmentSearchResults.style.left = `${inputRect.left - rowRect.left}px`;
                    equipmentSearchResults.style.width = `${inputRect.width}px`;
                }
                
                if (results.length === 0) {
                    console.log('No results, showing "add new" message');
                    // –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ
                    const noResultsContainer = document.createElement('div');
                    noResultsContainer.className = 'equipment-search-no-results';
                    
                    const message = document.createElement('div');
                    message.className = 'equipment-search-no-results-message';
                    message.textContent = `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ "${query}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.`;
                    
                    const actionButton = document.createElement('button');
                    actionButton.type = 'button';
                    actionButton.className = 'primary-btn';
                    actionButton.style.cssText = 'width: 100%; padding: 10px 16px; font-size: 14px;';
                    actionButton.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
                    actionButton.addEventListener('click', () => {
                        setEquipmentMode('new', null);
                        if (equipmentNameInput) equipmentNameInput.value = query;
                        if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                    });
                    
                    noResultsContainer.appendChild(message);
                    noResultsContainer.appendChild(actionButton);
                    equipmentSearchResults.appendChild(noResultsContainer);
                    equipmentSearchResults.style.display = 'block';
                    
                    const rect = equipmentSearchResults.getBoundingClientRect();
                    const computed = window.getComputedStyle(equipmentSearchResults);
                    console.log('No results container displayed');
                    console.log('  display:', computed.display);
                    console.log('  visibility:', computed.visibility);
                    console.log('  opacity:', computed.opacity);
                    console.log('  z-index:', computed.zIndex);
                    console.log('  position:', computed.position);
                    console.log('  top:', computed.top, 'left:', computed.left);
                    console.log('  width:', rect.width, 'height:', rect.height);
                    console.log('  boundingRect:', rect);
                    console.log('  children count:', equipmentSearchResults.children.length);
                    console.log('  parent overflow:', window.getComputedStyle(equipmentSearchResults.parentElement).overflow);
                    return;
                }
                
                // –ï—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                console.log('Has results, showing results container');
                const queryLower = query.toLowerCase().trim();
                const exactMatch = results.find(eq => 
                    eq.equipment_name.toLowerCase().trim() === queryLower || eq.is_exact_match
                );
                const bestMatch = exactMatch || results[0];
                const hasMultipleResults = results.length > 1;
                
                // –í—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
                let selectedEquipment = bestMatch;
                
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'equipment-search-results-container';
                if (exactMatch) {
                    resultsContainer.classList.add('exact-match');
                }
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º
                const header = document.createElement('div');
                header.className = 'equipment-search-header';
                if (exactMatch) {
                    header.classList.add('exact-match');
                }
                
                const headerText = document.createElement('div');
                headerText.className = 'equipment-search-header-text';
                
                if (exactMatch) {
                    headerText.textContent = `–ù–∞–π–¥–µ–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ "${bestMatch.equipment_name}" –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.`;
                } else if (hasMultipleResults) {
                    headerText.textContent = `–ù–∞–π–¥–µ–Ω–æ ${results.length} –ø–æ—Ö–æ–∂–∏—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞:`;
                } else {
                    headerText.textContent = `–ù–∞–π–¥–µ–Ω–æ –ø–æ—Ö–æ–∂–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ "${bestMatch.equipment_name}".`;
                }
                
                const headerSubtext = document.createElement('div');
                headerSubtext.className = 'equipment-search-header-subtext';
                headerSubtext.textContent = exactMatch ? '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª?' : '–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ:';
                
                header.appendChild(headerText);
                header.appendChild(headerSubtext);
                resultsContainer.appendChild(header);
                
                // –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è)
                if (hasMultipleResults || !exactMatch) {
                    const resultsList = document.createElement('div');
                    resultsList.className = 'equipment-search-list';
                    
                    results.forEach((equipment) => {
                        const item = document.createElement('div');
                        const isBest = equipment.id === bestMatch.id;
                        const isExact = equipment.equipment_name.toLowerCase().trim() === queryLower || equipment.is_exact_match;
                        const isSelected = equipment.id === selectedEquipment.id;
                        
                        item.className = 'equipment-search-item';
                        if (isExact) {
                            item.classList.add('exact-match-item');
                        }
                        if (isSelected) {
                            item.classList.add('selected');
                        }
                        item.dataset.equipmentId = equipment.id;
                        
                        const itemName = document.createElement('div');
                        itemName.className = 'equipment-search-item-name';
                        itemName.textContent = equipment.equipment_name;
                        
                        item.appendChild(itemName);
                        
                        if (equipment.equipment_type) {
                            const itemType = document.createElement('div');
                            itemType.className = 'equipment-search-item-type';
                            itemType.textContent = equipment.equipment_type;
                            item.appendChild(itemType);
                        }
                        
                        // –ü—Ä–∏ –∫–ª–∏–∫–µ —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                        item.addEventListener('click', () => {
                            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            resultsList.querySelectorAll('.equipment-search-item').forEach(el => {
                                el.classList.remove('selected');
                            });
                            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
                            item.classList.add('selected');
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                            selectedEquipment = equipment;
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                            addPlacementBtn.textContent = `–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ "${equipment.equipment_name}"`;
                        });
                        resultsList.appendChild(item);
                    });
                    resultsContainer.appendChild(resultsList);
                }
                
                // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
                const actionContainer = document.createElement('div');
                actionContainer.className = 'equipment-search-actions';
                
                const addPlacementBtn = document.createElement('button');
                addPlacementBtn.type = 'button';
                addPlacementBtn.className = 'primary-btn';
                addPlacementBtn.style.cssText = 'flex: 1; padding: 10px 16px; font-size: 14px;';
                addPlacementBtn.textContent = exactMatch ? `–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ "${bestMatch.equipment_name}"` : `–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ "${selectedEquipment.equipment_name}"`;
                // –¢–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª—è–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                addPlacementBtn.addEventListener('click', () => {
                    selectExistingEquipment(selectedEquipment);
                });
                
                const addNewBtn = document.createElement('button');
                addNewBtn.type = 'button';
                addNewBtn.className = 'secondary-btn';
                addNewBtn.style.cssText = 'flex: 1; padding: 10px 16px; font-size: 14px;';
                addNewBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ';
                addNewBtn.addEventListener('click', () => {
                    setEquipmentMode('new', null);
                    if (equipmentNameInput) equipmentNameInput.value = query;
                    if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                });
                
                actionContainer.appendChild(addPlacementBtn);
                actionContainer.appendChild(addNewBtn);
                resultsContainer.appendChild(actionContainer);
                
                equipmentSearchResults.appendChild(resultsContainer);
                equipmentSearchResults.style.display = 'block';
                
                const rect = equipmentSearchResults.getBoundingClientRect();
                const computed = window.getComputedStyle(equipmentSearchResults);
                console.log('Results container displayed');
                console.log('  display:', computed.display);
                console.log('  visibility:', computed.visibility);
                console.log('  opacity:', computed.opacity);
                console.log('  z-index:', computed.zIndex);
                console.log('  position:', computed.position);
                console.log('  top:', computed.top, 'left:', computed.left);
                console.log('  width:', rect.width, 'height:', rect.height);
                console.log('  boundingRect:', rect);
                console.log('  children count:', equipmentSearchResults.children.length);
                console.log('  parent:', equipmentSearchResults.parentElement);
                console.log('  parent overflow:', window.getComputedStyle(equipmentSearchResults.parentElement).overflow);
            }
            
            function selectExistingEquipment(equipment) {
                selectedExistingEquipment = equipment;
                if (existingEquipmentId) existingEquipmentId.value = equipment.id;
                if (equipmentNameInput) equipmentNameInput.value = equipment.equipment_name;
                if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                setEquipmentMode('existing', equipment);
            }
            
            function setEquipmentMode(mode, equipment) {
                // –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                const transitionDuration = 300;
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ required –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                const acquisitionDateInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="acquisition_date"]') : null;
                
                if (mode === 'new') {
                    // –£–±–∏—Ä–∞–µ–º required —Å –ø–æ–ª–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                    if (equipmentFacilitySelect) equipmentFacilitySelect.removeAttribute('required');
                    if (equipmentDepartmentSelect) equipmentDepartmentSelect.removeAttribute('required');
                    if (acquisitionDateInput) acquisitionDateInput.removeAttribute('required');
                    
                    if (existingEquipmentForm) {
                        existingEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-out`;
                        existingEquipmentForm.style.opacity = '0';
                        setTimeout(() => {
                            existingEquipmentForm.style.display = 'none';
                        }, transitionDuration);
                    }
                    if (newEquipmentForm) {
                        newEquipmentForm.style.display = 'block';
                        newEquipmentForm.style.opacity = '0';
                        newEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        requestAnimationFrame(() => {
                            newEquipmentForm.style.opacity = '1';
                        });
                    }
                    if (equipmentModeIndicator) {
                        equipmentModeIndicator.style.display = 'block';
                        equipmentModeIndicator.style.background = '#e3f2fd';
                        equipmentModeIndicator.style.color = '#1976d2';
                        equipmentModeIndicator.style.border = '1px solid #90caf9';
                        equipmentModeIndicator.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        equipmentModeIndicator.style.opacity = '0';
                        equipmentModeIndicator.textContent = '‚úì –†–µ–∂–∏–º: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
                        requestAnimationFrame(() => {
                            equipmentModeIndicator.style.opacity = '1';
                        });
                    }
                } else if (mode === 'existing' && equipment) {
                    // –î–æ–±–∞–≤–ª—è–µ–º required –∫ –ø–æ–ª—è–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                    if (equipmentFacilitySelect) equipmentFacilitySelect.setAttribute('required', 'required');
                    if (equipmentDepartmentSelect) equipmentDepartmentSelect.setAttribute('required', 'required');
                    if (acquisitionDateInput) acquisitionDateInput.setAttribute('required', 'required');
                    
                    if (newEquipmentForm) {
                        newEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-out`;
                        newEquipmentForm.style.opacity = '0';
                        setTimeout(() => {
                            newEquipmentForm.style.display = 'none';
                        }, transitionDuration);
                    }
                    if (existingEquipmentForm) {
                        existingEquipmentForm.style.display = 'block';
                        existingEquipmentForm.style.opacity = '0';
                        existingEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        requestAnimationFrame(() => {
                            existingEquipmentForm.style.opacity = '1';
                        });
                    }
                    if (equipmentModeIndicator) {
                        equipmentModeIndicator.style.display = 'block';
                        equipmentModeIndicator.style.background = '#fff3e0';
                        equipmentModeIndicator.style.color = '#f57c00';
                        equipmentModeIndicator.style.border = '1px solid #ffb74d';
                        equipmentModeIndicator.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        equipmentModeIndicator.style.opacity = '0';
                        equipmentModeIndicator.innerHTML = `‚úì –†–µ–∂–∏–º: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è<br><small>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: ${equipment.equipment_name}${equipment.equipment_type ? ` (${equipment.equipment_type})` : ''}</small>`;
                        requestAnimationFrame(() => {
                            equipmentModeIndicator.style.opacity = '1';
                        });
                    }
                }
            }

            function closeEquipmentModal() {
                if (!equipmentModal) return;
                
                // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π aria-hidden
                const activeElement = document.activeElement;
                if (activeElement && equipmentModal.contains(activeElement)) {
                    activeElement.blur();
                }
                
                equipmentModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                closeEquipmentModalDropdown();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å —É—Å–ø–µ–ª —É–±—Ä–∞—Ç—å—Å—è
                setTimeout(() => {
                    equipmentModal.setAttribute('aria-hidden', 'true');
                }, 0);
                
                // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                if (equipmentForm) {
                    equipmentForm.reset();
                    selectedSparePartTypes = [];
                    if (sparePartTypesList) {
                        sparePartTypesList.innerHTML = '';
                    }
                }
                if (equipmentFormError) {
                    equipmentFormError.textContent = '';
                }
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–µ—Ç–∞–ª–∏
            if (addSparePartTypeBtn && sparePartTypeSelect) {
                addSparePartTypeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const selectedType = sparePartTypeSelect.value;
                    let typeToAdd = null;
                    
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–î—Ä—É–≥–æ–µ", –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
                    if (selectedType === '__custom__') {
                        const customInput = document.getElementById('equipmentCustomSparePartType');
                        if (customInput && customInput.value.trim()) {
                            typeToAdd = customInput.value.trim();
                            customInput.value = '';
                            const customRow = document.getElementById('equipmentCustomSparePartTypeRow');
                            if (customRow) customRow.style.display = 'none';
                        }
                    } else if (selectedType && selectedType.trim()) {
                        typeToAdd = selectedType.trim();
                    }
                    
                    if (typeToAdd && !selectedSparePartTypes.includes(typeToAdd)) {
                        selectedSparePartTypes.push(typeToAdd);
                        updateSparePartTypesList();
                        sparePartTypeSelect.value = '';
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                        const btn = document.getElementById('equipmentSparePartTypeBtn');
                        if (btn) {
                            const label = btn.querySelector('.modal-select-label');
                            if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏';
                        }
                        closeEquipmentModalDropdown();
                    }
                });
            }
            

            function updateSparePartTypesList() {
                if (!sparePartTypesList) return;
                sparePartTypesList.innerHTML = '';
                selectedSparePartTypes.forEach((type, index) => {
                    const tag = document.createElement('div');
                    tag.className = 'spare-part-type-tag';
                    tag.innerHTML = `
                        <span>${type}</span>
                        <button type="button" class="remove-tag-btn" data-index="${index}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;
                    const removeBtn = tag.querySelector('.remove-tag-btn');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            selectedSparePartTypes.splice(index, 1);
                            updateSparePartTypesList();
                        });
                    }
                    sparePartTypesList.appendChild(tag);
                });
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            const equipmentModalSelectData = {};
            
            function initializeEquipmentModalSelectData() {
                // –¢–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                const equipmentTypeSelect = document.getElementById('equipmentTypeSelect');
                if (equipmentTypeSelect) {
                    equipmentModalSelectData.equipment_type = {};
                    Array.from(equipmentTypeSelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.equipment_type[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized equipment_type:', Object.keys(equipmentModalSelectData.equipment_type).length, 'options');
                }
                
                // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const equipmentImageSelect = document.getElementById('equipmentImageSelect');
                if (equipmentImageSelect) {
                    equipmentModalSelectData.image_path = {};
                    Array.from(equipmentImageSelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.image_path[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized image_path:', Object.keys(equipmentModalSelectData.image_path).length, 'options');
                }
                
                // –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –¢–û (–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
                const equipmentMaintenanceSelect = document.getElementById('equipmentMaintenanceSelect');
                if (equipmentMaintenanceSelect) {
                    equipmentModalSelectData.maintenance_frequency = {
                        '7': '–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é (7 –¥–Ω–µ–π)',
                        '30': '–†–∞–∑ –≤ –º–µ—Å—è—Ü (30 –¥–Ω–µ–π)',
                        '90': '–†–∞–∑ –≤ –∫–≤–∞—Ä—Ç–∞–ª (90 –¥–Ω–µ–π)',
                        '365': '–†–∞–∑ –≤ –≥–æ–¥ (365 –¥–Ω–µ–π)',
                        'custom': '–î—Ä—É–≥–æ–µ'
                    };
                    console.log('Initialized maintenance_frequency:', Object.keys(equipmentModalSelectData.maintenance_frequency).length, 'options');
                }
                
                // –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏
                equipmentModalSelectData.warranty_period_unit = {
                    'days': '–î–Ω–µ–π',
                    'months': '–ú–µ—Å—è—Ü–µ–≤',
                    'years': '–õ–µ—Ç'
                };
                console.log('Initialized warranty_period_unit:', Object.keys(equipmentModalSelectData.warranty_period_unit).length, 'options');
                
                // –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (–¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è)
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                if (equipmentFacilitySelect) {
                    equipmentModalSelectData.facility_id = {};
                    Array.from(equipmentFacilitySelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.facility_id[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized facility_id:', Object.keys(equipmentModalSelectData.facility_id).length, 'options');
                }
                
                // –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (–¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è) - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ
                const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
                if (equipmentFacilitySelectNew) {
                    if (!equipmentModalSelectData.facility_id) {
                        equipmentModalSelectData.facility_id = {};
                    }
                    Array.from(equipmentFacilitySelectNew.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.facility_id[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized facility_id (new):', Object.keys(equipmentModalSelectData.facility_id).length, 'options');
                }
                
                // –û—Ç–¥–µ–ª—ã (–¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è) - –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
                equipmentModalSelectData.department_id = {};
                
                // –û—Ç–¥–µ–ª—ã (–¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è)
                const equipmentDepartmentSelectNew = document.getElementById('equipmentDepartmentSelectNew');
                if (equipmentDepartmentSelectNew) {
                    if (!equipmentModalSelectData.department_id_new) {
                        equipmentModalSelectData.department_id_new = {};
                    }
                    Array.from(equipmentDepartmentSelectNew.options).forEach(opt => {
                        if (opt.value !== '') {
                            const deptName = opt.textContent.trim();
                            equipmentModalSelectData.department_id_new[opt.value] = deptName;
                        }
                    });
                }
                
                // –¢–∏–ø—ã –¥–µ—Ç–∞–ª–µ–π (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤—ã—à–µ)
                if (sparePartTypeSelect) {
                    equipmentModalSelectData.spare_part_type = {};
                    Array.from(sparePartTypeSelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.spare_part_type[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized spare_part_type:', Object.keys(equipmentModalSelectData.spare_part_type).length, 'options');
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
            initializeEquipmentModalSelectData();

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ modalDropdown, —á—Ç–æ –∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            let equipmentModalDropdown = document.getElementById('modalDropdown');
            // –ï—Å–ª–∏ dropdown –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
            if (!equipmentModalDropdown) {
                equipmentModalDropdown = document.createElement('div');
                equipmentModalDropdown.className = 'role-dropdown';
                equipmentModalDropdown.id = 'modalDropdown';
                document.body.appendChild(equipmentModalDropdown);
            }
            let currentEquipmentModalSelect = null;
            
            // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É –æ—Ç–¥–µ–ª–æ–≤ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º –¥–ª—è —Ñ–æ—Ä–º—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            const equipmentFacilityDeptMap = {};
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é equipmentDepartmentsData
            if (typeof equipmentDepartmentsData !== 'undefined' && Array.isArray(equipmentDepartmentsData)) {
                equipmentDepartmentsData.forEach(dept => {
                    const facilityId = dept.facility_id ? String(dept.facility_id) : '';
                    if (!facilityId) return;
                    if (!equipmentFacilityDeptMap[facilityId]) {
                        equipmentFacilityDeptMap[facilityId] = [];
                    }
                    equipmentFacilityDeptMap[facilityId].push({
                        id: String(dept.id),
                        name: dept.name
                    });
                });
                Object.keys(equipmentFacilityDeptMap).forEach(key => {
                    equipmentFacilityDeptMap[key].sort((a, b) => a.name.localeCompare(b.name, 'ru', { sensitivity: 'base' }));
                });
                console.log('equipmentFacilityDeptMap created:', Object.keys(equipmentFacilityDeptMap).length, 'facilities');
                Object.keys(equipmentFacilityDeptMap).forEach(facilityId => {
                    console.log(`Facility ${facilityId}: ${equipmentFacilityDeptMap[facilityId].length} departments`);
                });
            } else {
                console.warn('equipmentDepartmentsData is not available or not an array');
            }
            
            function populateEquipmentDepartmentOptions(facilityId) {
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                if (!equipmentDepartmentSelect) return;
                
                const equipmentDepartmentBtn = document.getElementById('equipmentDepartmentBtn');
                const equipmentDepartmentLabel = equipmentDepartmentBtn?.querySelector('.modal-select-label');
                
                equipmentDepartmentSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                placeholder.disabled = !facilityId;
                placeholder.selected = true;
                equipmentDepartmentSelect.appendChild(placeholder);
                
                if (!facilityId) {
                    equipmentDepartmentSelect.disabled = true;
                    if (equipmentDepartmentBtn) {
                        equipmentDepartmentBtn.disabled = true;
                        if (equipmentDepartmentLabel) {
                            equipmentDepartmentLabel.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                        }
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è dropdown
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id = {};
                    }
                    return;
                }
                
                const departments = equipmentFacilityDeptMap[facilityId] || [];
                console.log('populateEquipmentDepartmentOptions - facilityId:', facilityId, 'departments:', departments.length);
                console.log('equipmentFacilityDeptMap keys:', Object.keys(equipmentFacilityDeptMap));
                if (departments.length === 0) {
                    console.warn('No departments found for facilityId:', facilityId);
                    placeholder.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤';
                    equipmentDepartmentSelect.disabled = true;
                    if (equipmentDepartmentBtn) {
                        equipmentDepartmentBtn.disabled = true;
                        if (equipmentDepartmentLabel) {
                            equipmentDepartmentLabel.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤';
                        }
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è dropdown
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id = {};
                    }
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è dropdown
                if (equipmentModalSelectData) {
                    equipmentModalSelectData.department_id = {};
                    departments.forEach(dept => {
                        equipmentModalSelectData.department_id[dept.id] = dept.name;
                    });
                }
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    equipmentDepartmentSelect.appendChild(option);
                });
                equipmentDepartmentSelect.disabled = false;
                if (equipmentDepartmentBtn) {
                    equipmentDepartmentBtn.disabled = false;
                    if (equipmentDepartmentLabel) {
                        equipmentDepartmentLabel.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                    console.log('Department button enabled, departments count:', departments.length);
                    console.log('Department data updated:', equipmentModalSelectData.department_id);
                }
            }
            
            function handleEquipmentFacilityChange() {
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                if (!equipmentFacilitySelect) return;
                const facilityId = equipmentFacilitySelect.value;
                console.log('handleEquipmentFacilityChange called with facilityId:', facilityId);
                
                // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –æ—Ç–¥–µ–ª–æ–≤
                populateEquipmentDepartmentOptions(facilityId);
                
                // –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∏ select
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                if (equipmentDepartmentSelect) {
                    equipmentDepartmentSelect.value = '';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –æ—Ç–¥–µ–ª–∞
                const equipmentDepartmentBtn = document.getElementById('equipmentDepartmentBtn');
                if (equipmentDepartmentBtn) {
                    const label = equipmentDepartmentBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—ã
                    if (facilityId) {
                        const departments = equipmentFacilityDeptMap[facilityId] || [];
                        if (departments.length > 0) {
                            equipmentDepartmentBtn.disabled = false;
                            console.log('Department button enabled, facilityId:', facilityId, 'departments:', departments.length);
                        } else {
                            equipmentDepartmentBtn.disabled = true;
                            console.log('Department button disabled, no departments for facilityId:', facilityId);
                        }
                    } else {
                        equipmentDepartmentBtn.disabled = true;
                    }
                }
            }
            
            function populateEquipmentDepartmentOptionsNew(facilityId) {
                const equipmentDepartmentSelectNew = document.getElementById('equipmentDepartmentSelectNew');
                if (!equipmentDepartmentSelectNew) return;
                
                const equipmentDepartmentBtnNew = document.getElementById('equipmentDepartmentBtnNew');
                const equipmentDepartmentLabelNew = equipmentDepartmentBtnNew?.querySelector('.modal-select-label');
                
                equipmentDepartmentSelectNew.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                placeholder.disabled = !facilityId;
                placeholder.selected = true;
                equipmentDepartmentSelectNew.appendChild(placeholder);
                
                if (!facilityId) {
                    equipmentDepartmentSelectNew.disabled = true;
                    if (equipmentDepartmentBtnNew) {
                        equipmentDepartmentBtnNew.disabled = true;
                        if (equipmentDepartmentLabelNew) {
                            equipmentDepartmentLabelNew.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                        }
                    }
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id_new = {};
                    }
                    return;
                }
                
                const departments = equipmentFacilityDeptMap[facilityId] || [];
                if (departments.length === 0) {
                    placeholder.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤';
                    equipmentDepartmentSelectNew.disabled = true;
                    if (equipmentDepartmentBtnNew) {
                        equipmentDepartmentBtnNew.disabled = true;
                        if (equipmentDepartmentLabelNew) {
                            equipmentDepartmentLabelNew.textContent = '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤';
                        }
                    }
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id_new = {};
                    }
                    return;
                }
                
                if (equipmentModalSelectData) {
                    equipmentModalSelectData.department_id_new = {};
                    departments.forEach(dept => {
                        equipmentModalSelectData.department_id_new[dept.id] = dept.name;
                    });
                }
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    equipmentDepartmentSelectNew.appendChild(option);
                });
                equipmentDepartmentSelectNew.disabled = false;
                if (equipmentDepartmentBtnNew) {
                    equipmentDepartmentBtnNew.disabled = false;
                    if (equipmentDepartmentLabelNew) {
                        equipmentDepartmentLabelNew.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                }
            }
            
            function handleEquipmentFacilityChangeNew() {
                const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
                if (!equipmentFacilitySelectNew) return;
                const facilityId = equipmentFacilitySelectNew.value;
                
                populateEquipmentDepartmentOptionsNew(facilityId);
                
                const equipmentDepartmentSelectNew = document.getElementById('equipmentDepartmentSelectNew');
                if (equipmentDepartmentSelectNew) {
                    equipmentDepartmentSelectNew.value = '';
                }
                
                const equipmentDepartmentBtnNew = document.getElementById('equipmentDepartmentBtnNew');
                if (equipmentDepartmentBtnNew) {
                    const label = equipmentDepartmentBtnNew.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = facilityId ? '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                    if (facilityId) {
                        const departments = equipmentFacilityDeptMap[facilityId] || [];
                        if (departments.length > 0) {
                            equipmentDepartmentBtnNew.disabled = false;
                        } else {
                            equipmentDepartmentBtnNew.disabled = true;
                        }
                    } else {
                        equipmentDepartmentBtnNew.disabled = true;
                    }
                }
            }
            
            function populateEquipmentModalDropdown(field, options) {
                if (!equipmentModalDropdown || !options || Object.keys(options).length === 0) {
                    return;
                }
                
                equipmentModalDropdown.innerHTML = '';
                Object.entries(options).forEach(([value, label]) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = value;
                    option.textContent = label || value || '‚Äî';
                    option.addEventListener('click', () => {
                        if (!currentEquipmentModalSelect) return;
                        const btn = currentEquipmentModalSelect;
                        const select = btn.parentElement.querySelector('select');
                        const labelSpan = btn.querySelector('.modal-select-label');
                        
                        if (select && labelSpan) {
                            select.value = value;
                            
                            // –û–±—Ä–∞–±–æ—Ç–∫–∞ "–î—Ä—É–≥–æ–µ" –¥–ª—è —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                            if (field === 'equipment_type' && value === '__custom__') {
                                const customRow = document.getElementById('customEquipmentTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'block';
                                    const customInput = document.getElementById('customEquipmentType');
                                    if (customInput) {
                                        customInput.focus();
                                        customInput.setAttribute('required', 'required');
                                    }
                                }
                                labelSpan.textContent = '–î—Ä—É–≥–æ–µ';
                            } else if (field === 'equipment_type') {
                                const customRow = document.getElementById('customEquipmentTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'none';
                                    const customInput = document.getElementById('customEquipmentType');
                                    if (customInput) {
                                        customInput.removeAttribute('required');
                                        customInput.value = '';
                                    }
                                }
                                labelSpan.textContent = label;
                            }
                            // –û–±—Ä–∞–±–æ—Ç–∫–∞ "–î—Ä—É–≥–æ–µ" –¥–ª—è —Ç–∏–ø–æ–≤ –¥–µ—Ç–∞–ª–µ–π
                            else if (field === 'spare_part_type' && value === '__custom__') {
                                const customRow = document.getElementById('equipmentCustomSparePartTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'block';
                                    const customInput = document.getElementById('equipmentCustomSparePartType');
                                    if (customInput) {
                                        customInput.focus();
                                        customInput.value = '';
                                    }
                                }
                                labelSpan.textContent = '–î—Ä—É–≥–æ–µ';
                                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º dropdown –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                                closeEquipmentModalDropdown();
                                return;
                            } else if (field === 'spare_part_type' && value && value !== '__custom__') {
                                const customRow = document.getElementById('equipmentCustomSparePartTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'none';
                                    const customInput = document.getElementById('equipmentCustomSparePartType');
                                    if (customInput) {
                                        customInput.value = '';
                                    }
                                }
                                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø
                                if (!selectedSparePartTypes.includes(value)) {
                                    selectedSparePartTypes.push(value);
                                    updateSparePartTypesList();
                                    select.value = '';
                                    labelSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏';
                                }
                            } else {
                                labelSpan.textContent = label;
                            }
                            
                            btn.setAttribute('aria-expanded', 'false');
                            
                            // –î–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –≤—ã–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
                            if (field === 'facility_id' || field === 'facility_id_new') {
                                requestAnimationFrame(() => {
                                    if (field === 'facility_id') {
                                        handleEquipmentFacilityChange();
                                    } else if (field === 'facility_id_new') {
                                        handleEquipmentFacilityChangeNew();
                                    }
                                });
                            } else if (field !== 'spare_part_type' || value === '__custom__') {
                                select.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                        closeEquipmentModalDropdown();
                    });
                    equipmentModalDropdown.appendChild(option);
                });
            }

            function positionEquipmentModalDropdown(btn) {
                if (!btn || !equipmentModalDropdown) return;
                const rect = btn.getBoundingClientRect();
                const dropdownHeight = equipmentModalDropdown.offsetHeight || 200;
                const viewportHeight = window.innerHeight;
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
                
                equipmentModalDropdown.style.position = 'fixed';
                if (openUpward) {
                    equipmentModalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    equipmentModalDropdown.style.top = 'auto';
                } else {
                    equipmentModalDropdown.style.top = `${rect.bottom + 6}px`;
                    equipmentModalDropdown.style.bottom = 'auto';
                }
                equipmentModalDropdown.style.left = `${rect.left}px`;
                equipmentModalDropdown.style.width = `${rect.width}px`;
                equipmentModalDropdown.style.minWidth = `${rect.width}px`;
                equipmentModalDropdown.style.maxWidth = `${rect.width}px`;
            }

            function openEquipmentModalDropdown(btn) {
                if (!btn || btn.disabled) return;
                const field = btn.dataset.field;
                if (!field) return;
                
                // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –∫ –∫–ª—é—á–∞–º –≤ equipmentModalSelectData
                const fieldMap = {
                    'equipment_type': 'equipment_type',
                    'maintenance_frequency': 'maintenance_frequency',
                    'facility_id': 'facility_id',
                    'facility_id_new': 'facility_id',
                    'department_id': 'department_id',
                    'department_id_new': 'department_id_new',
                    'spare_part_type': 'spare_part_type',
                    'warranty_period_unit': 'warranty_period_unit'
                };
                
                const dataKey = fieldMap[field] || field;
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è facility_id_new - –∏—Å–ø–æ–ª—å–∑—É–µ–º facility_id
                if (field === 'facility_id_new') {
                    const actualDataKey = 'facility_id';
                    if (!equipmentModalSelectData || !equipmentModalSelectData[actualDataKey] || Object.keys(equipmentModalSelectData[actualDataKey]).length === 0) {
                        console.warn('No facility_id data found, re-initializing...');
                        initializeEquipmentModalSelectData();
                        if (!equipmentModalSelectData || !equipmentModalSelectData[actualDataKey] || Object.keys(equipmentModalSelectData[actualDataKey]).length === 0) {
                            console.warn('Still no facility_id data after re-initialization');
                            return;
                        }
                    }
                    const options = equipmentModalSelectData[actualDataKey];
                    currentEquipmentModalSelect = btn;
                    populateEquipmentModalDropdown(field, options);
                    requestAnimationFrame(() => {
                        positionEquipmentModalDropdown(btn);
                        if (equipmentModalDropdown) {
                            equipmentModalDropdown.classList.add('visible');
                        }
                        btn.setAttribute('aria-expanded', 'true');
                    });
                    return;
                }
                
                if (!equipmentModalSelectData || !equipmentModalSelectData[dataKey]) {
                    console.warn('No data key found:', dataKey, 'Available keys:', Object.keys(equipmentModalSelectData || {}));
                    // –î–ª—è –æ—Ç–¥–µ–ª–∞, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–æ –≤—ã–±—Ä–∞–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, –ø–æ–ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    if (field === 'department_id') {
                        const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                        if (equipmentFacilitySelect && equipmentFacilitySelect.value) {
                            console.log('Trying to refresh department data for facility:', equipmentFacilitySelect.value);
                            populateEquipmentDepartmentOptions(equipmentFacilitySelect.value);
                            // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
                            if (!equipmentModalSelectData || !equipmentModalSelectData[dataKey] || Object.keys(equipmentModalSelectData[dataKey]).length === 0) {
                                console.warn('Still no department data after refresh');
                                return;
                            }
                        } else {
                            console.warn('No facility selected for department dropdown');
                            return;
                        }
                    } else if (field === 'department_id_new') {
                        const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
                        if (equipmentFacilitySelectNew && equipmentFacilitySelectNew.value) {
                            console.log('Trying to refresh department data for facility (new):', equipmentFacilitySelectNew.value);
                            populateEquipmentDepartmentOptionsNew(equipmentFacilitySelectNew.value);
                            // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
                            if (!equipmentModalSelectData || !equipmentModalSelectData[dataKey] || Object.keys(equipmentModalSelectData[dataKey]).length === 0) {
                                console.warn('Still no department data after refresh (new)');
                                return;
                            }
                        } else {
                            console.warn('No facility selected for department dropdown (new)');
                            return;
                        }
                    } else {
                        return;
                    }
                }
                
                const options = equipmentModalSelectData[dataKey];
                if (!options || Object.keys(options).length === 0) {
                    console.warn('No options for field:', field, 'dataKey:', dataKey);
                    return;
                }
                
                currentEquipmentModalSelect = btn;
                populateEquipmentModalDropdown(field, options);
                
                requestAnimationFrame(() => {
                    positionEquipmentModalDropdown(btn);
                    if (equipmentModalDropdown) {
                        equipmentModalDropdown.classList.add('visible');
                        console.log('Dropdown opened, classes:', equipmentModalDropdown.className, 'visible:', equipmentModalDropdown.classList.contains('visible'));
                    } else {
                        console.error('equipmentModalDropdown is null!');
                    }
                    btn.setAttribute('aria-expanded', 'true');
                });
            }

            function closeEquipmentModalDropdown() {
                if (!equipmentModalDropdown) return;
                equipmentModalDropdown.classList.remove('visible');
                if (currentEquipmentModalSelect) {
                    currentEquipmentModalSelect.setAttribute('aria-expanded', 'false');
                    currentEquipmentModalSelect = null;
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤—ã—à–µ)
            const equipmentFacilityBtn = document.getElementById('equipmentFacilityBtn');
            const equipmentFacilityBtnNew = document.getElementById('equipmentFacilityBtnNew');
            const warrantyPeriodUnitBtn = document.getElementById('warrantyPeriodUnitBtn');
            const allEquipmentBtns = [equipmentTypeBtn, equipmentMaintenanceBtn, equipmentFacilityBtn, equipmentFacilityBtnNew, equipmentDepartmentBtn, equipmentDepartmentBtnNew, sparePartTypeBtn, warrantyPeriodUnitBtn].filter(btn => btn !== null);
            allEquipmentBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (btn.disabled) return;
                    
                    if (currentEquipmentModalSelect === btn) {
                        closeEquipmentModalDropdown();
                    } else {
                        closeEquipmentModalDropdown();
                        openEquipmentModalDropdown(btn);
                    }
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
            const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
            if (equipmentFacilitySelect) {
                equipmentFacilitySelect.addEventListener('change', handleEquipmentFacilityChange);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
            if (equipmentFacilitySelectNew) {
                equipmentFacilitySelectNew.addEventListener('change', handleEquipmentFacilityChangeNew);
            }

            // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ —Å—Ç–æ—Ä–æ–Ω—É (–≤–Ω–µ dropdown)
            document.addEventListener('click', (e) => {
                if (equipmentModalDropdown && equipmentModalDropdown.classList.contains('visible')) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –∏ –Ω–µ –ø–æ dropdown
                    const clickedBtn = e.target.closest('.modal-select-btn');
                    const clickedDropdown = e.target.closest('.role-dropdown');
                    if (!clickedBtn && !clickedDropdown) {
                        closeEquipmentModalDropdown();
                    }
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && equipmentModalDropdown && equipmentModalDropdown.classList.contains('visible') && 
                    equipmentModal && equipmentModal.classList.contains('visible')) {
                    closeEquipmentModalDropdown();
                }
            });
            
            // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
            if (equipmentForm) {
                const dateInputs = equipmentForm.querySelectorAll('input[type="date"]');
                dateInputs.forEach(input => {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                    input.classList.add('styled-date-input');
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã
                    input.addEventListener('change', function() {
                        if (this.value) {
                            this.classList.add('has-value');
                        } else {
                            this.classList.remove('has-value');
                        }
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    if (input.value) {
                        input.classList.add('has-value');
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ "–î—Ä—É–≥–æ–µ" –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏ –¢–û
            const equipmentMaintenanceSelect = document.getElementById('equipmentMaintenanceSelect');
            const customMaintenanceRow = document.getElementById('customMaintenanceRow');
            const customMaintenanceFrequency = document.getElementById('customMaintenanceFrequency');
            
            if (equipmentMaintenanceSelect) {
                equipmentMaintenanceSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        if (customMaintenanceRow) customMaintenanceRow.style.display = 'block';
                        if (customMaintenanceFrequency) {
                            customMaintenanceFrequency.required = true;
                            customMaintenanceFrequency.focus();
                        }
                    } else {
                        if (customMaintenanceRow) customMaintenanceRow.style.display = 'none';
                        if (customMaintenanceFrequency) {
                            customMaintenanceFrequency.required = false;
                            customMaintenanceFrequency.value = '';
                        }
                    }
                });
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏ –¢–û - —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞
            if (customMaintenanceFrequency) {
                customMaintenanceFrequency.addEventListener('input', (e) => {
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
                
                customMaintenanceFrequency.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const paste = (e.clipboardData || window.clipboardData).getData('text');
                    const numbersOnly = paste.replace(/\D/g, '');
                    e.target.value = numbersOnly;
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const equipmentImageInput = document.getElementById('equipmentImageInput');
            const equipmentImagePreview = document.getElementById('equipmentImagePreview');
            const equipmentImagePreviewImg = document.getElementById('equipmentImagePreviewImg');
            
            if (equipmentImageInput) {
                equipmentImageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë');
                            e.target.value = '';
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            if (equipmentImagePreviewImg) {
                                equipmentImagePreviewImg.src = event.target.result;
                            }
                            if (equipmentImagePreview) {
                                equipmentImagePreview.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        if (equipmentImagePreview) equipmentImagePreview.style.display = 'none';
                    }
                });
            }
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const removeEquipmentImageBtn = document.getElementById('removeEquipmentImageBtn');
            if (removeEquipmentImageBtn) {
                removeEquipmentImageBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (equipmentImagePreview) {
                        equipmentImagePreview.style.display = 'none';
                    }
                    if (equipmentImagePreviewImg) {
                        equipmentImagePreviewImg.src = '';
                    }
                    if (equipmentImageInput) {
                        equipmentImageInput.value = '';
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            if (equipmentForm) {
                equipmentForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º (–Ω–æ–≤–∞—è –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ–æ—Ä–º–∞ –≤–∏–¥–Ω–∞)
                    const isNewFormVisible = newEquipmentForm && newEquipmentForm.style.display !== 'none';
                    const isExistingFormVisible = existingEquipmentForm && existingEquipmentForm.style.display !== 'none';
                    
                    if (!isNewFormVisible && !isExistingFormVisible) {
                        if (equipmentFormError) {
                            equipmentFormError.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.';
                        }
                        return;
                    }
                    
                    if (equipmentFormSubmit) {
                        equipmentFormSubmit.disabled = true;
                        equipmentFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                    }
                    if (equipmentFormError) {
                        equipmentFormError.textContent = '';
                    }

                    const formData = new FormData(equipmentForm);
                    const isExisting = selectedExistingEquipment !== null;
                    
                    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞:', { isExisting, selectedExistingEquipment, isExistingFormVisible });
                    
                    if (isExisting) {
                        // –†–µ–∂–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                        const acquisitionDateInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="acquisition_date"]') : null;
                        const locationInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="location"]') : null;
                        const departmentSelect = existingEquipmentForm ? existingEquipmentForm.querySelector('select[name="department_id"]') : null;
                        
                        const acquisitionDate = acquisitionDateInput ? acquisitionDateInput.value.trim() : '';
                        const location = locationInput ? locationInput.value.trim() : '';
                        const departmentId = departmentSelect ? departmentSelect.value : null;
                        
                        const existingEquipmentIdValue = existingEquipmentId ? existingEquipmentId.value : formData.get('existing_equipment_id');
                        const equipmentStatusValue = formData.get('equipment_status') || '–í —Ä–∞–±–æ—Ç–µ';
                        
                        const payload = {
                            existing_equipment_id: existingEquipmentIdValue,
                            acquisition_date: acquisitionDate || null,
                            location: location || null,
                            department_id: departmentId || null,
                            equipment_status: equipmentStatusValue
                        };
                        
                        // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
                        console.log('=== –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –†–ê–ó–ú–ï–©–ï–ù–ò–Ø ===');
                        console.log('Payload:', JSON.stringify(payload, null, 2));
                        console.log('–ó–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã:', {
                            acquisitionDateInput: acquisitionDateInput?.value,
                            locationInput: locationInput?.value,
                            departmentSelect: departmentSelect?.value,
                            existingEquipmentId: existingEquipmentIdValue
                        });
                        console.log('===================================');
                        
                        fetch('/admin/equipment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        })
                        .then(async response => {
                            const data = await response.json();
                            return { ok: response.ok, data };
                        })
                        .then(({ ok, data }) => {
                            if (ok && data.success) {
                                closeEquipmentModal();
                                showEquipmentStatus('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 600);
                            } else {
                                if (equipmentFormError) {
                                    equipmentFormError.textContent = data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
                                }
                            }
                        })
                        .catch(() => {
                            if (equipmentFormError) {
                                equipmentFormError.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                            }
                        })
                        .finally(() => {
                            if (equipmentFormSubmit) {
                                equipmentFormSubmit.disabled = false;
                                equipmentFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                            }
                        });
                    } else {
                        // –†–µ–∂–∏–º –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è - —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
                        const imageFile = formData.get('equipment_image');
                        let imagePath = null;
                        
                        if (imageFile && imageFile.size > 0) {
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            const imageFormData = new FormData();
                            imageFormData.append('equipment_image', imageFile);
                            
                            fetch('/admin/equipment/upload-image', {
                                method: 'POST',
                                body: imageFormData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    imagePath = data.image_path;
                                    submitNewEquipment(formData, imagePath);
                                } else {
                                    if (equipmentFormError) {
                                        equipmentFormError.textContent = data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
                                    }
                                    if (equipmentFormSubmit) {
                                        equipmentFormSubmit.disabled = false;
                                        equipmentFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                                    }
                                }
                            })
                            .catch(() => {
                                if (equipmentFormError) {
                                    equipmentFormError.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
                                }
                                if (equipmentFormSubmit) {
                                    equipmentFormSubmit.disabled = false;
                                    equipmentFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                                }
                            });
                        } else {
                            submitNewEquipment(formData, null);
                        }
                    }
                });
            }
            
            function submitNewEquipment(formData, imagePath) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –¢–û
                let maintenanceFrequency = formData.get('maintenance_frequency');
                if (maintenanceFrequency === 'custom') {
                    maintenanceFrequency = formData.get('custom_maintenance_frequency');
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–µ—Ä–∏–æ–¥ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≤ –¥–Ω–∏
                let warrantyPeriodDays = null;
                const warrantyValue = formData.get('warranty_period_value');
                const warrantyUnit = formData.get('warranty_period_unit');
                if (warrantyValue && warrantyUnit) {
                    const value = parseInt(warrantyValue);
                    if (!isNaN(value) && value > 0) {
                        switch (warrantyUnit) {
                            case 'days':
                                warrantyPeriodDays = value;
                                break;
                            case 'months':
                                warrantyPeriodDays = value * 30; // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ 30 –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
                                break;
                            case 'years':
                                warrantyPeriodDays = value * 365; // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ 365 –¥–Ω–µ–π –≤ –≥–æ–¥—É
                                break;
                        }
                    }
                }
                
                const payload = {
                    equipment_name: formData.get('equipment_name')?.trim(),
                    equipment_type: (formData.get('equipment_type') === '__custom__' 
                        ? formData.get('custom_equipment_type')?.trim() 
                        : formData.get('equipment_type')?.trim()) || null,
                    image_path: imagePath,
                    characteristics: formData.get('characteristics')?.trim() || null,
                    acquisition_date: formData.get('acquisition_date') || null,
                    warranty_period: warrantyPeriodDays,
                    maintenance_frequency: maintenanceFrequency || null,
                    department_id: formData.get('department_id_new') || formData.get('department_id') || null,
                    location: formData.get('location')?.trim() || null,
                    spare_part_types: selectedSparePartTypes
                };

                fetch('/admin/equipment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        closeEquipmentModal();
                        showEquipmentStatus('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 600);
                    } else {
                        if (equipmentFormError) {
                            equipmentFormError.textContent = data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
                        }
                    }
                })
                .catch(() => {
                    if (equipmentFormError) {
                        equipmentFormError.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                    }
                })
                .finally(() => {
                    if (equipmentFormSubmit) {
                        equipmentFormSubmit.disabled = false;
                        equipmentFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    }
                });
            }

            if (addEquipmentBtn) {
                addEquipmentBtn.addEventListener('click', openEquipmentModal);
            } else {
                console.error('addEquipmentBtn –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }

            [equipmentModalClose, equipmentModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeEquipmentModal);
                }
            });

            if (equipmentModal) {
                equipmentModal.addEventListener('click', (event) => {
                    if (event.target === equipmentModal) {
                        closeEquipmentModal();
                    }
                });
            }

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è
            let deleteType = 'assignment'; // 'assignment' –∏–ª–∏ 'equipment'
            
            function openDeleteEquipmentModal(id, equipmentRow, type = 'assignment') {
                if (!deleteEquipmentModal) return;
                
                equipmentToDelete = id;
                equipmentToDeleteRow = equipmentRow;
                deleteType = type;
                
                const equipmentName = equipmentRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
                const location = equipmentRow.querySelector('td:nth-child(6)')?.textContent?.trim() || '';
                const equipmentText = equipmentName || '–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
                const locationText = location ? ` (${location})` : '';
                
                if (deleteEquipmentMessage) {
                    if (type === 'assignment') {
                        deleteEquipmentMessage.innerHTML = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è "${equipmentText}${locationText}"?<br>–°–∞–º–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ —ç—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ.<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em>`;
                    } else {
                        deleteEquipmentMessage.innerHTML = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ "${equipmentText}${locationText}"?<br>–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —ç—Ç–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ —Å–∞–º–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em>`;
                    }
                }
                
                deleteEquipmentModal.setAttribute('aria-hidden', 'false');
                deleteEquipmentModal.classList.add('visible');
                document.body.classList.add('modal-open');
            }

            function closeDeleteEquipmentModal() {
                if (!deleteEquipmentModal) return;
                
                // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π aria-hidden
                const activeElement = document.activeElement;
                if (activeElement && deleteEquipmentModal.contains(activeElement)) {
                    activeElement.blur();
                }
                
                deleteEquipmentModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å —É—Å–ø–µ–ª —É–±—Ä–∞—Ç—å—Å—è
                setTimeout(() => {
                    deleteEquipmentModal.setAttribute('aria-hidden', 'true');
                }, 0);
                
                if (deleteEquipmentConfirm) {
                    deleteEquipmentConfirm.disabled = false;
                    deleteEquipmentConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                }
                
                equipmentToDelete = null;
                equipmentToDeleteRow = null;
                deleteType = 'assignment';
            }

            [deleteEquipmentClose, deleteEquipmentCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeDeleteEquipmentModal);
                }
            });

            if (deleteEquipmentModal) {
                deleteEquipmentModal.addEventListener('click', (event) => {
                    if (event.target === deleteEquipmentModal) {
                        closeDeleteEquipmentModal();
                    }
                });
            }

            if (deleteEquipmentConfirm) {
                deleteEquipmentConfirm.addEventListener('click', async () => {
                    if (!equipmentToDelete) return;
                    
                    deleteEquipmentConfirm.disabled = true;
                    deleteEquipmentConfirm.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
                    
                    try {
                        // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É–¥–∞–ª–µ–Ω–∏—è
                        const url = deleteType === 'assignment' 
                            ? `/admin/equipment/assignment/${equipmentToDelete}`
                            : `/admin/equipment/${equipmentToDelete}`;
                        
                        const response = await fetch(url, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            if (equipmentToDeleteRow && document.contains(equipmentToDeleteRow)) {
                                equipmentToDeleteRow.remove();
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                                let visibleIndex = 0;
                                getAllEquipmentRows().forEach(row => {
                                    if (row.style.display !== 'none') {
                                        const numberCell = row.querySelector('.number-column');
                                        if (numberCell) {
                                            numberCell.textContent = visibleIndex + 1;
                                        }
                                        visibleIndex++;
                                    }
                                });
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ç—Ä–æ–∫
                                setupRowHandlers();
                                setupEditableCells();
                                setupEquipmentFacilityDepartmentHandlers();
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                                applyEquipmentRowStriping();
                                
                                const message = deleteType === 'assignment' 
                                    ? '–†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–æ'
                                    : '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
                                showEquipmentStatus(message, 'success');
                            }
                            closeDeleteEquipmentModal();
                        } else {
                            const errorMessage = deleteType === 'assignment'
                                ? (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è')
                                : (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ');
                            showEquipmentStatus(errorMessage, 'error');
                            deleteEquipmentConfirm.disabled = false;
                            deleteEquipmentConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
                        const errorMessage = deleteType === 'assignment'
                            ? '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è'
                            : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
                        showEquipmentStatus(errorMessage, 'error');
                        deleteEquipmentConfirm.disabled = false;
                        deleteEquipmentConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                    }
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (equipmentContextMenu && equipmentContextMenu.style.display === 'block') {
                        hideContextMenu();
                    }
                    if (deleteEquipmentModal && deleteEquipmentModal.classList.contains('visible')) {
                        closeDeleteEquipmentModal();
                    }
                    if (equipmentModal && equipmentModal.classList.contains('visible')) {
                        closeEquipmentModal();
                    }
                }
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            applyEquipmentFilters();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
            }
        })();
    </script>
    {% endif %}

    {% if section == 'equipment_passport' %}
    <script>
        // JavaScript –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        (function() {
            'use strict';
            
            try {
                // –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π - –æ–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ
                const movementHistorySearch = document.getElementById('movementHistorySearch');
                const movementHistoryFilterToggle = document.getElementById('movementHistoryFilterToggle');
                const movementHistoryFilterDropdown = document.getElementById('movementHistoryFilterDropdown');
                const movementHistoryTable = document.getElementById('movementHistoryTable');
                const resetMovementHistoryFilters = document.getElementById('resetMovementHistoryFilters');
                const movementDateFilter = document.getElementById('movementDateFilter');
                const movementFromLocationFilter = document.getElementById('movementFromLocationFilter');
                const movementToLocationFilter = document.getElementById('movementToLocationFilter');
                const movementSortColumnFilter = document.getElementById('movementSortColumnFilter');
                const movementSortDirectionFilter = document.getElementById('movementSortDirectionFilter');

                // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —Å—Ç—Ä–æ–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                function applyMovementHistoryRowStriping() {
                    if (!movementHistoryTable) return;
                    const rows = movementHistoryTable.querySelectorAll('tbody tr');
                    let visibleIndex = 0;
                    rows.forEach(row => {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"
                        if (row.querySelector('td[colspan]')) {
                            row.classList.remove('alt-row');
                            return;
                        }
                        // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏
                        if (row.style.display === 'none') {
                            row.classList.remove('alt-row');
                            return;
                        }
                        const isAlt = visibleIndex % 2 === 1;
                        row.classList.toggle('alt-row', isAlt);
                        visibleIndex += 1;
                    });
                }

                function applyMovementHistoryFilters() {
                    if (!movementHistoryTable) return;

                    const searchTerm = (movementHistorySearch?.value || '').toLowerCase().trim();
                    const dateFilterValue = (movementDateFilter?.value || '').toLowerCase().trim();
                    const fromLocationValue = (movementFromLocationFilter?.value || '').trim();
                    const toLocationValue = (movementToLocationFilter?.value || '').trim();
                    const sortColumn = (movementSortColumnFilter?.value || '').trim();
                    const sortDirection = (movementSortDirectionFilter?.value || 'asc').trim();

                    const rows = Array.from(movementHistoryTable.querySelectorAll('tbody tr'));
                    
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                    const filteredRows = rows.filter(tr => {
                        if (tr.querySelector('td[colspan]')) {
                            return false; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"
                        }

                        const fromLocation = (tr.dataset.fromLocation || '').toLowerCase();
                        const toLocation = (tr.dataset.toLocation || '').toLowerCase();
                        const moveDateRaw = tr.dataset.moveDate || '';

                        // –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–∑ —è—á–µ–π–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (6-–π —Å—Ç–æ–ª–±–µ—Ü: –î–∞—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è)
                        const dateCell = tr.querySelector('td:nth-child(6)');
                        const moveDateFormatted = dateCell ? dateCell.textContent.trim().toLowerCase() : '';

                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞
                        const matchesSearch = !searchTerm ||
                            fromLocation.includes(searchTerm) ||
                            toLocation.includes(searchTerm) ||
                            moveDateRaw.toLowerCase().includes(searchTerm) ||
                            moveDateFormatted.includes(searchTerm);

                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ
                        const matchesDateFilter = !dateFilterValue ||
                            moveDateRaw.toLowerCase().includes(dateFilterValue) ||
                            moveDateFormatted.includes(dateFilterValue);

                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ "–û—Ç–∫—É–¥–∞"
                        const matchesFromLocation = !fromLocationValue ||
                            tr.dataset.fromLocation === fromLocationValue;

                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ "–ö—É–¥–∞"
                        const matchesToLocation = !toLocationValue ||
                            tr.dataset.toLocation === toLocationValue;

                        return matchesSearch && matchesDateFilter && matchesFromLocation && matchesToLocation;
                    });

                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                    if (sortColumn && filteredRows.length > 0) {
                        filteredRows.sort((a, b) => {
                            let aValue, bValue;
                            let compareResult = 0;

                            switch (sortColumn) {
                                case 'from':
                                    aValue = (a.dataset.fromLocation || '').toLowerCase();
                                    bValue = (b.dataset.fromLocation || '').toLowerCase();
                                    compareResult = aValue.localeCompare(bValue, 'ru', { numeric: true });
                                    break;
                                case 'to':
                                    aValue = (a.dataset.toLocation || '').toLowerCase();
                                    bValue = (b.dataset.toLocation || '').toLowerCase();
                                    compareResult = aValue.localeCompare(bValue, 'ru', { numeric: true });
                                    break;
                                case 'date':
                                    // –î–ª—è –¥–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç, –∞ –Ω–µ —Å—Ç—Ä–æ–∫
                                    const aDateStr = a.dataset.moveDate || '';
                                    const bDateStr = b.dataset.moveDate || '';
                                    
                                    if (!aDateStr && !bDateStr) {
                                        compareResult = 0;
                                    } else if (!aDateStr) {
                                        compareResult = 1; // –ü—É—Å—Ç—ã–µ –¥–∞—Ç—ã –≤ –∫–æ–Ω–µ—Ü
                                    } else if (!bDateStr) {
                                        compareResult = -1; // –ü—É—Å—Ç—ã–µ –¥–∞—Ç—ã –≤ –∫–æ–Ω–µ—Ü
                                    } else {
                                        const aDate = new Date(aDateStr);
                                        const bDate = new Date(bDateStr);
                                        
                                        if (isNaN(aDate.getTime()) && isNaN(bDate.getTime())) {
                                            compareResult = 0;
                                        } else if (isNaN(aDate.getTime())) {
                                            compareResult = 1;
                                        } else if (isNaN(bDate.getTime())) {
                                            compareResult = -1;
                                        } else {
                                            compareResult = aDate.getTime() - bDate.getTime();
                                        }
                                    }
                                    break;
                                default:
                                    return 0;
                            }

                            if (sortDirection === 'desc') {
                                return -compareResult;
                            } else {
                                return compareResult;
                            }
                        });
                    }

                    // –ü–æ–ª—É—á–∞–µ–º tbody –¥–ª—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫
                    const tbody = movementHistoryTable.querySelector('tbody');
                    if (!tbody) return;

                    // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π" –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    const noDataRow = tbody.querySelector('tr[colspan]') || tbody.querySelector('tr:has(td[colspan])');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏ —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π" –∏–∑ DOM
                    rows.forEach(tr => {
                        tr.style.display = 'none';
                    });
                    
                    if (noDataRow) {
                        noDataRow.remove();
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    if (filteredRows.length === 0) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è—Ö</td>';
                        tbody.appendChild(emptyRow);
                    } else {
                        // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ DOM –≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                        filteredRows.forEach((tr, index) => {
                            tr.style.display = '';
                            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü tbody (–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
                            tbody.appendChild(tr);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                            const numberCell = tr.querySelector('.number-column');
                            if (numberCell) {
                                numberCell.textContent = index + 1;
                            }
                        });
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Å—Ç—Ä–æ–∫
                    applyMovementHistoryRowStriping();
                    
                    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —è—á–µ–π–∫–∏, –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
                    setTimeout(() => {
                        if (typeof setupMovementHistoryEditableCells === 'function') {
                            setupMovementHistoryEditableCells();
                        }
                        if (typeof setupMovementHistoryDropdowns === 'function') {
                            setupMovementHistoryDropdowns();
                        }
                        if (typeof setupMovementHistoryRowSelection === 'function') {
                            setupMovementHistoryRowSelection();
                        }
                    }, 50);
                }

                const passportTabs = document.querySelectorAll('.passport-tab');
                const tabPanels = document.querySelectorAll('.tab-panel');
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
                passportTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
                        passportTabs.forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
                        this.classList.add('active');
                        this.setAttribute('aria-selected', 'true');
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏
                        tabPanels.forEach(panel => {
                            panel.classList.remove('active');
                            panel.hidden = true;
                        });
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
                        const targetPanel = document.getElementById(`tab-panel-${targetTab}`);
                        if (targetPanel) {
                            targetPanel.classList.add('active');
                            targetPanel.hidden = false;
                            
                            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π", –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
                            if (targetTab === 'movement-history' && typeof applyMovementHistoryFilters === 'function') {
                                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –æ–±–Ω–æ–≤–ª–µ–Ω
                                setTimeout(() => {
                                    if (typeof initMovementHistoryFilterSelects === 'function') {
                                        initMovementHistoryFilterSelects();
                                    }
                                    applyMovementHistoryFilters();
                                    if (typeof setupMovementHistoryEditableCells === 'function') {
                                        setupMovementHistoryEditableCells();
                                    }
                                    if (typeof setupMovementHistoryDropdowns === 'function') {
                                        setupMovementHistoryDropdowns();
                                    }
                                    if (typeof setupMovementHistoryRowSelection === 'function') {
                                        setupMovementHistoryRowSelection();
                                    }
                                }, 50);
                            }
                            
                            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ "–°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–µ—Ç–∞–ª–µ–π", –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                            if (targetTab === 'required-parts') {
                                setTimeout(() => {
                                    if (typeof initSparePartsFilterSelects === 'function') {
                                        initSparePartsFilterSelects();
                                    }
                                    if (typeof applySparePartsFilters === 'function') {
                                        applySparePartsFilters();
                                    }
                                    if (typeof setupSparePartsEditableCells === 'function') {
                                        setupSparePartsEditableCells();
                                    }
                                    if (typeof setupSparePartsRowSelection === 'function') {
                                        setupSparePartsRowSelection();
                                    }
                                }, 50);
                            }
                        }
                    });
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
                const activeTab = document.querySelector('.passport-tab.active');
                if (activeTab) {
                    const targetTab = activeTab.getAttribute('data-tab');
                    const targetPanel = document.getElementById(`tab-panel-${targetTab}`);
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        targetPanel.hidden = false;
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                        if (targetTab === 'movement-history') {
                            setTimeout(() => {
                                if (typeof initMovementHistoryFilterSelects === 'function') {
                                    initMovementHistoryFilterSelects();
                                }
                                if (typeof applyMovementHistoryFilters === 'function') {
                                    applyMovementHistoryFilters();
                                }
                                if (typeof setupMovementHistoryEditableCells === 'function') {
                                    setupMovementHistoryEditableCells();
                                }
                                if (typeof setupMovementHistoryDropdowns === 'function') {
                                    setupMovementHistoryDropdowns();
                                }
                                if (typeof setupMovementHistoryRowSelection === 'function') {
                                    setupMovementHistoryRowSelection();
                                }
                                if (typeof applyMovementHistoryRowStriping === 'function') {
                                    applyMovementHistoryRowStriping();
                                }
                            }, 100);
                        } else if (targetTab === 'required-parts') {
                            setTimeout(() => {
                                if (typeof initSparePartsFilterSelects === 'function') {
                                    initSparePartsFilterSelects();
                                }
                                if (typeof applySparePartsFilters === 'function') {
                                    applySparePartsFilters();
                                }
                                if (typeof setupSparePartsEditableCells === 'function') {
                                    setupSparePartsEditableCells();
                                }
                                if (typeof setupSparePartsRowSelection === 'function') {
                                    setupSparePartsRowSelection();
                                }
                                if (typeof applySparePartsRowStriping === 'function') {
                                    applySparePartsRowStriping();
                                }
                            }, 100);
                        }
                    }
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const equipmentImageInput = document.getElementById('equipmentImageInput');
                const equipmentImageContainer = document.getElementById('equipmentImageContainer');
                
                if (equipmentImageInput) {
                    equipmentImageInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                        if (!file.type.match('image.*')) {
                            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                            return;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å. 16MB)
                        if (file.size > 16 * 1024 * 1024) {
                            alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 16MB');
                            return;
                        }
                        
                        const equipmentId = equipmentImageInput.getAttribute('data-equipment-id');
                        if (!equipmentId) return;
                        
                        // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                        const formData = new FormData();
                        formData.append('image', file);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        const container = equipmentImageContainer;
                        const originalContent = container.innerHTML;
                        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; min-height: 400px; color: var(--text-medium);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                        container.style.pointerEvents = 'none';
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        fetch(`/admin/equipment/passport/${equipmentId}/upload-image`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                const imageUrl = `/static/${data.image_path}?t=${new Date().getTime()}`;
                                const placeholder = document.getElementById('equipmentImagePlaceholder');
                                const existingImage = document.getElementById('equipmentImage');
                                
                                if (placeholder) {
                                    placeholder.remove();
                                }
                                
                                if (existingImage) {
                                    existingImage.src = imageUrl;
                                } else {
                                    const img = document.createElement('img');
                                    img.src = imageUrl;
                                    img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
                                    img.className = 'equipment-image';
                                    img.id = 'equipmentImage';
                                    container.innerHTML = '';
                                    container.appendChild(img);
                                    container.innerHTML += '<div class="equipment-image-overlay"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span></div>';
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞
                                setTimeout(() => {
                                    window.location.reload();
                                }, 500);
                            } else {
                                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                                container.innerHTML = originalContent;
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                            container.innerHTML = originalContent;
                        })
                        .finally(() => {
                            container.style.pointerEvents = '';
                            equipmentImageInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
                        });
                    });
                }
                
                // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                function showMovementHistoryStatus(message, state = 'info') {
                    const movementHistoryStatusBox = document.getElementById('movementHistoryTableUpdateStatus');
                    if (!movementHistoryStatusBox) return;
                    movementHistoryStatusBox.textContent = message;
                    movementHistoryStatusBox.dataset.state = state;
                    movementHistoryStatusBox.classList.remove('visible');
                    if (message) {
                        requestAnimationFrame(() => movementHistoryStatusBox.classList.add('visible'));
                        setTimeout(() => {
                            movementHistoryStatusBox.classList.remove('visible');
                        }, 5000);
                    }
                }
                
                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                const deleteMovementModal = document.getElementById('deleteMovementModal');
                const deleteMovementClose = document.getElementById('deleteMovementModalClose');
                const deleteMovementCancel = document.getElementById('deleteMovementCancel');
                const deleteMovementConfirm = document.getElementById('deleteMovementConfirm');
                const deleteMovementMessage = document.getElementById('deleteMovementMessage');
                
                let movementToDelete = null;
                let movementToDeleteRow = null;
                
                function openDeleteMovementModal(movementId, movementRow) {
                    if (!deleteMovementModal) return;
                    
                    movementToDelete = movementId;
                    movementToDeleteRow = movementRow;
                    
                    const fromLocation = movementRow.dataset.fromLocation || '';
                    const toLocation = movementRow.dataset.toLocation || '';
                    const moveDate = movementRow.dataset.moveDate || '';
                    
                    const dateStr = moveDate ? new Date(moveDate).toLocaleDateString('ru-RU') : '';
                    const locationText = fromLocation && toLocation 
                        ? ` –∏–∑ "${fromLocation}" –≤ "${toLocation}"${dateStr ? ` (${dateStr})` : ''}`
                        : '';
                    
                    if (deleteMovementMessage) {
                        deleteMovementMessage.innerHTML = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ${locationText}?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em>`;
                    }
                    
                    deleteMovementModal.setAttribute('aria-hidden', 'false');
                    deleteMovementModal.classList.add('visible');
                    document.body.classList.add('modal-open');
                }
                
                function closeDeleteMovementModal() {
                    if (!deleteMovementModal) return;
                    
                    const activeElement = document.activeElement;
                    if (activeElement && deleteMovementModal.contains(activeElement)) {
                        activeElement.blur();
                    }
                    
                    deleteMovementModal.classList.remove('visible');
                    document.body.classList.remove('modal-open');
                    
                    setTimeout(() => {
                        deleteMovementModal.setAttribute('aria-hidden', 'true');
                    }, 0);
                    
                    if (deleteMovementConfirm) {
                        deleteMovementConfirm.disabled = false;
                        deleteMovementConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                    }
                    
                    movementToDelete = null;
                    movementToDeleteRow = null;
                }
                
                [deleteMovementClose, deleteMovementCancel].forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', closeDeleteMovementModal);
                    }
                });
                
                if (deleteMovementModal) {
                    deleteMovementModal.addEventListener('click', (event) => {
                        if (event.target === deleteMovementModal) {
                            closeDeleteMovementModal();
                        }
                    });
                }
                
                if (deleteMovementConfirm) {
                    deleteMovementConfirm.addEventListener('click', async () => {
                        if (!movementToDelete) return;
                        
                        deleteMovementConfirm.disabled = true;
                        deleteMovementConfirm.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
                        
                        try {
                            const response = await fetch(`/admin/equipment/movement/${movementToDelete}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok && result.success) {
                                if (movementToDeleteRow && document.contains(movementToDeleteRow)) {
                                    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                                    movementToDeleteRow.remove();
                                    
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Å—Ç—Ä–æ–∫–∏
                                    const tbody = movementHistoryTable.querySelector('tbody');
                                    if (tbody) {
                                        const remainingRows = tbody.querySelectorAll('tr');
                                        if (remainingRows.length === 0) {
                                            const emptyRow = document.createElement('tr');
                                            emptyRow.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è—Ö</td>';
                                            tbody.appendChild(emptyRow);
                                        } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                                            remainingRows.forEach((tr, index) => {
                                                if (!tr.querySelector('td[colspan]')) {
                                                    const numberCell = tr.querySelector('.number-column');
                            if (numberCell) {
                                                        numberCell.textContent = index + 1;
                                                    }
                                                }
                                            });
                                        }
                                    }
                                    
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                                    showMovementHistoryStatus('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
                                }
                                closeDeleteMovementModal();
                            } else {
                                showMovementHistoryStatus(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ', 'error');
                                deleteMovementConfirm.disabled = false;
                                deleteMovementConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:', error);
                            showMovementHistoryStatus('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è', 'error');
                            deleteMovementConfirm.disabled = false;
                            deleteMovementConfirm.textContent = '–£–¥–∞–ª–∏—Ç—å';
                        }
                    });
                }
                
                // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                let movementHistoryContextMenu = null;
                let selectedMovementRow = null;
                
                function createMovementHistoryContextMenu() {
                    if (movementHistoryContextMenu) return movementHistoryContextMenu;
                    
                    movementHistoryContextMenu = document.createElement('div');
                    movementHistoryContextMenu.className = 'context-menu';
                    movementHistoryContextMenu.innerHTML = `
                        <button type="button" class="context-menu-item danger" id="movementHistoryDeleteBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                        </button>
                    `;
                    document.body.appendChild(movementHistoryContextMenu);
                    
                    const deleteBtn = document.getElementById('movementHistoryDeleteBtn');
                    
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => {
                            if (selectedMovementRow) {
                                const movementId = selectedMovementRow.dataset.movementId;
                                if (movementId) {
                                    openDeleteMovementModal(parseInt(movementId), selectedMovementRow);
                                }
                            }
                            hideMovementHistoryContextMenu();
                        });
                    }
                    
                    return movementHistoryContextMenu;
                }
                
                function showMovementHistoryContextMenu(event, row) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const menu = createMovementHistoryContextMenu();
                    selectedMovementRow = row;
                    
                    const tableContainer = movementHistoryTable?.closest('.table-container');
                    if (!tableContainer) return;
                    
                    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
                    menu.style.display = 'block';
                    menu.style.visibility = 'hidden';
                    menu.style.left = '0px';
                    menu.style.top = '0px';
                    
                    const containerRect = tableContainer.getBoundingClientRect();
                    const menuRect = menu.getBoundingClientRect();
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                    let left = event.clientX;
                    let top = event.clientY;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                    if (left + menuRect.width > containerRect.right) {
                        left = containerRect.right - menuRect.width - 10;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –ª–µ–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                    if (left < containerRect.left) {
                        left = containerRect.left + 10;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                    if (top + menuRect.height > containerRect.bottom) {
                        top = containerRect.bottom - menuRect.height - 10;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–±–ª–∏—Ü—ã
                    if (top < containerRect.top) {
                        top = containerRect.top + 10;
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                    menu.style.position = 'fixed';
                    menu.style.left = left + 'px';
                    menu.style.top = top + 'px';
                    menu.style.visibility = 'visible';
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                    setTimeout(() => {
                        document.addEventListener('click', hideMovementHistoryContextMenu, { once: true });
                    }, 0);
                }
                
                function hideMovementHistoryContextMenu() {
                    if (movementHistoryContextMenu) {
                        movementHistoryContextMenu.style.display = 'none';
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ü–ö–ú –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                if (movementHistoryTable) {
                    const tbody = movementHistoryTable.querySelector('tbody');
                    if (tbody) {
                        tbody.addEventListener('contextmenu', (e) => {
                            const row = e.target.closest('tr[data-movement-id]');
                            if (row && !row.querySelector('td[colspan]')) {
                                e.preventDefault();
                                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                                const allRows = tbody.querySelectorAll('tr[data-movement-id]');
                                allRows.forEach(r => r.classList.remove('selected'));
                                // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                                row.classList.add('selected');
                                selectedMovementRow = row;
                                showMovementHistoryContextMenu(e, row);
                            }
                        });
                    }
                }
                
                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                const addMovementModal = document.getElementById('addMovementModal');
                const addMovementModalClose = document.getElementById('addMovementModalClose');
                const addMovementModalCancel = document.getElementById('addMovementModalCancel');
                const movementForm = document.getElementById('movementForm');
                const movementFormSubmit = document.getElementById('movementFormSubmit');
                const movementFormError = document.getElementById('movementFormError');
                
                // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
                const movementFromFacilityBtn = document.getElementById('movementFromFacilityBtn');
                const movementFromFacilitySelect = document.getElementById('movementFromFacilitySelect');
                const movementFromDepartmentBtn = document.getElementById('movementFromDepartmentBtn');
                const movementFromDepartmentSelect = document.getElementById('movementFromDepartmentSelect');
                const movementToFacilityBtn = document.getElementById('movementToFacilityBtn');
                const movementToFacilitySelect = document.getElementById('movementToFacilitySelect');
                const movementToDepartmentBtn = document.getElementById('movementToDepartmentBtn');
                const movementToDepartmentSelect = document.getElementById('movementToDepartmentSelect');
                const movementDateInput = document.getElementById('movementDateInput');
                
                // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                const departmentsData = {{ department_choices|tojson }};
                const movementFacilityDeptMap = {};
                
                departmentsData.forEach(dept => {
                    const facilityId = dept.facility_id ? String(dept.facility_id) : '';
                    if (!facilityId) return;
                    
                    if (!movementFacilityDeptMap[facilityId]) {
                        movementFacilityDeptMap[facilityId] = [];
                    }
                    movementFacilityDeptMap[facilityId].push({
                        id: dept.id,
                        name: dept.name
                    });
                });
                
                // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–∫—É—â–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                let currentMovementEquipmentId = null;
                let currentMovementEquipmentAssignmentId = null;
                
                // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                function openAddMovementModal() {
                    currentMovementEquipmentId = null;
                    currentMovementEquipmentAssignmentId = null;
                    
                    if (!addMovementModal) return;
                    addMovementModal.classList.add('visible');
                    document.body.classList.add('modal-open');
                    setTimeout(() => {
                        addMovementModal.setAttribute('aria-hidden', 'false');
                    }, 0);
                    
                    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                    if (movementForm) movementForm.reset();
                    if (movementFormError) movementFormError.textContent = '';
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (movementDateInput) {
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const day = String(today.getDate()).padStart(2, '0');
                        movementDateInput.value = `${year}-${month}-${day}`;
                    }
                    
                    // –°–±—Ä–æ—Å –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                    if (movementFromDepartmentSelect) {
                        movementFromDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                        movementFromDepartmentSelect.disabled = true;
                        if (movementFromDepartmentBtn) {
                            movementFromDepartmentBtn.disabled = true;
                            movementFromDepartmentBtn.querySelector('.modal-select-label').textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                        }
                    }
                    if (movementToDepartmentSelect) {
                        movementToDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                        movementToDepartmentSelect.disabled = true;
                        if (movementToDepartmentBtn) {
                            movementToDepartmentBtn.disabled = true;
                            movementToDepartmentBtn.querySelector('.modal-select-label').textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                        }
                    }
                }
                
                // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                function openMovementModalFromContext(equipmentId, equipmentAssignmentId, departmentId, facilityName) {
                    currentMovementEquipmentId = equipmentId;
                    currentMovementEquipmentAssignmentId = equipmentAssignmentId;
                    
                    if (!addMovementModal) return;
                    addMovementModal.classList.add('visible');
                    document.body.classList.add('modal-open');
                    setTimeout(() => {
                        addMovementModal.setAttribute('aria-hidden', 'false');
                    }, 0);
                    
                    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                    if (movementForm) movementForm.reset();
                    if (movementFormError) movementFormError.textContent = '';
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (movementDateInput) {
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const day = String(today.getDate()).padStart(2, '0');
                        movementDateInput.value = `${year}-${month}-${day}`;
                    }
                    
                    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö "–û—Ç–∫—É–¥–∞"
                    if (departmentId && departmentsData) {
                        const dept = departmentsData.find(d => String(d.id) === String(departmentId));
                        if (dept && dept.facility_id) {
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ
                            if (movementFromFacilitySelect) {
                                movementFromFacilitySelect.value = String(dept.facility_id);
                                const facilityOption = Array.from(movementFromFacilitySelect.options).find(opt => opt.value === String(dept.facility_id));
                                if (facilityOption && movementFromFacilityBtn) {
                                    movementFromFacilityBtn.querySelector('.modal-select-label').textContent = facilityOption.textContent;
                                }
                                
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
                                const departments = movementFacilityDeptMap[String(dept.facility_id)] || [];
                                if (movementFromDepartmentSelect) {
                                    movementFromDepartmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                                    departments.forEach(d => {
                                        const option = document.createElement('option');
                                        option.value = d.id;
                                        option.textContent = d.name;
                                        movementFromDepartmentSelect.appendChild(option);
                                    });
                                    movementFromDepartmentSelect.value = String(departmentId);
                                    movementFromDepartmentSelect.disabled = departments.length === 0;
                                    
                                    if (movementFromDepartmentBtn) {
                                        movementFromDepartmentBtn.disabled = departments.length === 0;
                                        const deptOption = departments.find(d => String(d.id) === String(departmentId));
                                        if (deptOption) {
                                            movementFromDepartmentBtn.querySelector('.modal-select-label').textContent = deptOption.name;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // –°–±—Ä–æ—Å –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ "–ö—É–¥–∞"
                    if (movementToDepartmentSelect) {
                        movementToDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                        movementToDepartmentSelect.disabled = true;
                        if (movementToDepartmentBtn) {
                            movementToDepartmentBtn.disabled = true;
                            movementToDepartmentBtn.querySelector('.modal-select-label').textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                        }
                    }
                    
                    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –ª–æ–∫–∞—Ü–∏—é "–û—Ç–∫—É–¥–∞" –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                    // –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ data-location –∞—Ç—Ä–∏–±—É—Ç
                    // –≠—Ç–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
                }
                
                // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                function closeAddMovementModal() {
                    if (!addMovementModal) return;
                    addMovementModal.classList.remove('visible');
                    document.body.classList.remove('modal-open');
                    setTimeout(() => {
                        addMovementModal.setAttribute('aria-hidden', 'true');
                    }, 0);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    const movementFormSubmit = document.getElementById('movementFormSubmit');
                    if (movementFormSubmit) {
                        movementFormSubmit.disabled = false;
                        const defaultLabel = movementFormSubmit.dataset.defaultLabel || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        movementFormSubmit.textContent = defaultLabel;
                    }
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è
                if (addMovementBtn) {
                    addMovementBtn.addEventListener('click', openAddMovementModal);
                }
                
                [addMovementModalClose, addMovementModalCancel].forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', closeAddMovementModal);
                    }
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
                if (addMovementModal) {
                    addMovementModal.addEventListener('click', (e) => {
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –∏–º–µ–Ω–Ω–æ –Ω–∞ overlay, –∞ –Ω–µ –Ω–∞ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                        if (e.target === addMovementModal) {
                            e.stopPropagation();
                            closeAddMovementModal();
                        }
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è "–û—Ç–∫—É–¥–∞"
                if (movementFromFacilitySelect) {
                    movementFromFacilitySelect.addEventListener('change', (e) => {
                        const facilityId = e.target.value;
                        const departments = movementFacilityDeptMap[facilityId] || [];
                        
                        if (movementFromDepartmentSelect) {
                            movementFromDepartmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                            departments.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.id;
                                option.textContent = dept.name;
                                movementFromDepartmentSelect.appendChild(option);
                            });
                            movementFromDepartmentSelect.disabled = departments.length === 0;
                        }
                        
                        if (movementFromDepartmentBtn) {
                            movementFromDepartmentBtn.disabled = departments.length === 0;
                            const label = movementFromDepartmentBtn.querySelector('.modal-select-label');
                            if (label) {
                                label.textContent = departments.length === 0 ? '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤' : '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                            }
                        }
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è "–ö—É–¥–∞"
                if (movementToFacilitySelect) {
                    movementToFacilitySelect.addEventListener('change', (e) => {
                        const facilityId = e.target.value;
                        const departments = movementFacilityDeptMap[facilityId] || [];
                        
                        if (movementToDepartmentSelect) {
                            movementToDepartmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                            departments.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.id;
                                option.textContent = dept.name;
                                movementToDepartmentSelect.appendChild(option);
                            });
                            movementToDepartmentSelect.disabled = departments.length === 0;
                        }
                        
                        if (movementToDepartmentBtn) {
                            movementToDepartmentBtn.disabled = departments.length === 0;
                            const label = movementToDepartmentBtn.querySelector('.modal-select-label');
                            if (label) {
                                label.textContent = departments.length === 0 ? '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–µ—Ç –æ—Ç–¥–µ–ª–æ–≤' : '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                            }
                        }
                    });
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                let movementModalDropdown = document.getElementById('modalDropdown');
                if (!movementModalDropdown) {
                    movementModalDropdown = document.createElement('div');
                    movementModalDropdown.className = 'role-dropdown';
                    movementModalDropdown.id = 'modalDropdown';
                    document.body.appendChild(movementModalDropdown);
                }
                
                let currentMovementModalSelect = null;
                const movementModalSelectData = {
                    from_facility_id: {},
                    to_facility_id: {},
                    from_department_id: {},
                    to_department_id: {}
                };
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                {% for fac in facility_choices %}
                movementModalSelectData.from_facility_id['{{ fac.id }}'] = {{ fac.name|tojson }};
                movementModalSelectData.to_facility_id['{{ fac.id }}'] = {{ fac.name|tojson }};
                {% endfor %}
                
                // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                function openMovementModalDropdown(btn) {
                    if (!btn || btn.disabled) return;
                    const field = btn.dataset.field;
                    if (!field) return;
                    
                    let options = {};
                    
                    // –î–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º movementModalSelectData
                    if (field === 'from_facility_id' || field === 'to_facility_id') {
                        options = movementModalSelectData[field] || {};
                    }
                    // –î–ª—è –æ—Ç–¥–µ–ª–æ–≤ –ø–æ–ª—É—á–∞–µ–º –∏–∑ movementFacilityDeptMap
                    else if (field === 'from_department_id') {
                        const fromFacilitySelect = document.getElementById('movementFromFacilitySelect');
                        const facilityId = fromFacilitySelect?.value;
                        if (facilityId) {
                            const departments = movementFacilityDeptMap[facilityId] || [];
                            departments.forEach(dept => {
                                options[dept.id] = dept.name;
                            });
                        }
                    }
                    else if (field === 'to_department_id') {
                        const toFacilitySelect = document.getElementById('movementToFacilitySelect');
                        const facilityId = toFacilitySelect?.value;
                        if (facilityId) {
                            const departments = movementFacilityDeptMap[facilityId] || [];
                            departments.forEach(dept => {
                                options[dept.id] = dept.name;
                            });
                        }
                    }
                    
                    if (!movementModalDropdown || Object.keys(options).length === 0) {
                        return;
                    }
                    
                    movementModalDropdown.innerHTML = '';
                    Object.entries(options).forEach(([value, label]) => {
                        const option = document.createElement('button');
                        option.type = 'button';
                        option.className = 'role-dropdown-option';
                        option.dataset.value = value;
                        option.textContent = label || value || '‚Äî';
                        option.addEventListener('click', () => {
                            if (!currentMovementModalSelect) return;
                            const selectBtn = currentMovementModalSelect;
                            const select = selectBtn.parentElement.querySelector('select');
                            const labelSpan = selectBtn.querySelector('.modal-select-label');
                            
                            if (select && labelSpan) {
                                select.value = value;
                                labelSpan.textContent = label;
                                select.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                            
                            closeMovementModalDropdown();
                        });
                        movementModalDropdown.appendChild(option);
                    });
                    
                    const rect = btn.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const spaceBelow = viewportHeight - rect.bottom;
                    const spaceAbove = rect.top;
                    const dropdownHeight = 300;
                    const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
                    
                    movementModalDropdown.style.position = 'fixed';
                    if (openUpward) {
                        movementModalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                        movementModalDropdown.style.top = 'auto';
                    } else {
                        movementModalDropdown.style.top = `${rect.bottom + 6}px`;
                        movementModalDropdown.style.bottom = 'auto';
                    }
                    movementModalDropdown.style.left = `${rect.left}px`;
                    movementModalDropdown.style.width = `${rect.width}px`;
                    movementModalDropdown.style.minWidth = `${rect.width}px`;
                    movementModalDropdown.style.maxWidth = `${rect.width}px`;
                    
                    currentMovementModalSelect = btn;
                    movementModalDropdown.classList.add('visible');
                    btn.setAttribute('aria-expanded', 'true');
                }
                
                function closeMovementModalDropdown() {
                    if (!movementModalDropdown) return;
                    
                    // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                    const addMovementModal = document.getElementById('addMovementModal');
                    if (addMovementModal) {
                        const allButtons = addMovementModal.querySelectorAll('.modal-select-btn');
                        allButtons.forEach(btn => {
                            btn.removeAttribute('aria-expanded');
                            btn.setAttribute('aria-expanded', 'false');
                            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
                            const svg = btn.querySelector('svg');
                            if (svg) {
                                svg.style.transform = '';
                            }
                        });
                    }
                    
                    // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ ID –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    const buttonIds = [
                        'movementFromFacilityBtn',
                        'movementToFacilityBtn',
                        'movementFromDepartmentBtn',
                        'movementToDepartmentBtn'
                    ];
                    
                    buttonIds.forEach(btnId => {
                        const btn = document.getElementById(btnId);
                        if (btn) {
                            btn.removeAttribute('aria-expanded');
                            btn.setAttribute('aria-expanded', 'false');
                            const svg = btn.querySelector('svg');
                            if (svg) {
                                svg.style.transform = '';
                            }
                        }
                    });
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                    movementModalDropdown.classList.remove('visible');
                    currentMovementModalSelect = null;
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                [movementFromFacilityBtn, movementToFacilityBtn, movementFromDepartmentBtn, movementToDepartmentBtn].forEach(btn => {
                    if (!btn) return;
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (movementModalDropdown.classList.contains('visible') && currentMovementModalSelect === btn) {
                            closeMovementModalDropdown();
                        } else {
                            closeMovementModalDropdown();
                            openMovementModalDropdown(btn);
                        }
                    });
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã
                if (document.body) {
                    document.body.addEventListener('click', function movementModalClickHandler(e) {
                        if (!movementModalDropdown) return;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                        if (!movementModalDropdown.classList.contains('visible')) return;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                        const addMovementModal = document.getElementById('addMovementModal');
                        if (!addMovementModal || !addMovementModal.classList.contains('visible')) return;
                        
                        // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∏ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–Ω–æ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ)
                        if (!movementModalDropdown.contains(e.target) && 
                            !e.target.closest('.modal-select-btn')) {
                            closeMovementModalDropdown();
                        }
                    }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
                }
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && movementModalDropdown.classList.contains('visible')) {
                        closeMovementModalDropdown();
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                if (movementForm) {
                    movementForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        if (!movementFormSubmit) return;
                        movementFormSubmit.disabled = true;
                        const originalText = movementFormSubmit.textContent;
                        movementFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                        
                        if (movementFormError) movementFormError.textContent = '';
                        
                        const formData = new FormData(movementForm);
                        const fromLocationInput = document.getElementById('movementFromLocationInput');
                        const toLocationInput = document.getElementById('movementToLocationInput');
                        const data = {
                            from_department_id: formData.get('from_department_id'),
                            to_department_id: formData.get('to_department_id'),
                            move_date: formData.get('move_date'),
                            from_location: fromLocationInput ? fromLocationInput.value.trim() : '',
                            to_location: toLocationInput ? toLocationInput.value.trim() : ''
                        };
                        
                        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é, –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏
                        if (currentMovementEquipmentId && currentMovementEquipmentAssignmentId) {
                            data.equipment_id = currentMovementEquipmentId;
                            data.equipment_assignment_id = currentMovementEquipmentAssignmentId;
                        }
                        
                        try {
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º endpoint –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –æ—Ç–∫—É–¥–∞ –æ—Ç–∫—Ä—ã—Ç–æ –æ–∫–Ω–æ
                            let equipmentId;
                            let endpoint;
                            
                            if (currentMovementEquipmentId) {
                                // –û—Ç–∫—Ä—ã—Ç–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                                equipmentId = currentMovementEquipmentId;
                                endpoint = `/admin/equipment/${equipmentId}/movement`;
                            } else {
                                // –û—Ç–∫—Ä—ã—Ç–æ –∏–∑ –ø–∞—Å–ø–æ—Ä—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                                {% if equipment %}
                                equipmentId = {{ equipment.id }};
                                {% else %}
                                equipmentId = null;
                                {% endif %}
                                endpoint = `/admin/equipment/passport/${equipmentId}/movement`;
                            }
                            
                            if (!equipmentId) {
                                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
                            }
                            
                            const response = await fetch(endpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data)
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok && result.success) {
                                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –∏ –¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                                if (currentMovementEquipmentId && result.location_updated) {
                                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                                    window.location.reload();
                                } else if (currentMovementEquipmentId) {
                                    // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
                                    closeAddMovementModal();
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                                    if (typeof showEquipmentStatus === 'function') {
                                        showEquipmentStatus('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É.', 'info');
                                    } else {
                                        alert('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É.');
                                    }
                                } else {
                                    // –û—Ç–∫—Ä—ã—Ç–æ –∏–∑ –ø–∞—Å–ø–æ—Ä—Ç–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                                    if (result.movement_history && movementHistoryTable) {
                                        const tbody = movementHistoryTable.querySelector('tbody');
                                        if (tbody) {
                                            tbody.innerHTML = '';
                                            
                                            if (result.movement_history.length === 0) {
                                                const emptyRow = document.createElement('tr');
                                                emptyRow.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è—Ö</td>';
                                                tbody.appendChild(emptyRow);
                                            } else {
                                                result.movement_history.forEach((movement, index) => {
                                                    const row = document.createElement('tr');
                                                    row.dataset.movementId = movement.id;
                                                    row.dataset.fromLocation = movement.from_location || '';
                                                    row.dataset.toLocation = movement.to_location || '';
                                                    row.dataset.fromLocationDetail = movement.from_location_detail || '';
                                                    row.dataset.toLocationDetail = movement.to_location_detail || '';
                                                    row.dataset.fromDepartmentId = movement.from_department_id || '';
                                                    row.dataset.toDepartmentId = movement.to_department_id || '';
                                                    row.dataset.moveDate = movement.move_date || '';
                                                    
                                                    const dateStr = movement.move_date ? new Date(movement.move_date).toLocaleDateString('ru-RU') : '‚Äî';
                                                    const fromFacilityName = movement.from_facility || '';
                                                    const toFacilityName = movement.to_facility || '';
                                                    
                                                    row.innerHTML = `
                                                        <td class="number-column">${index + 1}</td>
                                                        <td class="facility-cell" tabindex="0" data-field="from_department_id" data-department-id="${movement.from_department_id || ''}" data-facility-name="${fromFacilityName}" aria-haspopup="listbox" aria-expanded="false">
                                                            <div class="role-cell-content">
                                                                <span class="role-cell-label">${movement.from_location || '‚Äî'}</span>
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                                </svg>
                                                            </div>
                                                        </td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="from_location">${movement.from_location_detail || '‚Äî'}</td>
                                                        <td class="facility-cell" tabindex="0" data-field="to_department_id" data-department-id="${movement.to_department_id || ''}" data-facility-name="${toFacilityName}" aria-haspopup="listbox" aria-expanded="false">
                                                            <div class="role-cell-content">
                                                                <span class="role-cell-label">${movement.to_location || '‚Äî'}</span>
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                                </svg>
                                                            </div>
                                                        </td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="to_location">${movement.to_location_detail || '‚Äî'}</td>
                                                        <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="move_date">${dateStr}</td>
                                                    `;
                                                    tbody.appendChild(row);
                                                });
                                                
                                                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —è—á–µ–π–∫–∏
                                                setTimeout(() => {
                                                    if (typeof setupMovementHistoryEditableCells === 'function') {
                                                        setupMovementHistoryEditableCells();
                                                    }
                                                    if (typeof setupMovementHistoryDropdowns === 'function') {
                                                        setupMovementHistoryDropdowns();
                                                    }
                                                    if (typeof setupMovementHistoryRowSelection === 'function') {
                                                        setupMovementHistoryRowSelection();
                                                    }
                                                }, 100);
                                            }
                                            
                                            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
                                            applyMovementHistoryFilters();
                                        }
                                    }
                                    
                                    closeAddMovementModal();
                                }
                            } else {
                                if (movementFormError) {
                                    movementFormError.textContent = result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ';
                                }
                                movementFormSubmit.disabled = false;
                                movementFormSubmit.textContent = originalText;
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:', error);
                            if (movementFormError) {
                                movementFormError.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è';
                            }
                            movementFormSubmit.disabled = false;
                            movementFormSubmit.textContent = originalText;
                        }
                    });
                }
                
                if (addMovementBtn) {
                    addMovementBtn.addEventListener('click', openAddMovementModal);
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                function initMovementHistoryFilterSelects() {
                    const filterSelects = document.querySelectorAll('#movementHistoryFilterDropdown .filter-select');
                    
                    filterSelects.forEach(filterSelect => {
                        const btn = filterSelect.querySelector('.filter-select-btn');
                        const optionsList = filterSelect.querySelector('.filter-options-list');
                        const nativeSelect = document.getElementById(filterSelect.dataset.target);
                        const resetBtn = filterSelect.parentElement.querySelector('.filter-reset-btn');
                        
                        if (!btn || !optionsList || !nativeSelect) return;
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–ø–∏—Å–∫–∏
                            filterSelects.forEach(otherSelect => {
                                if (otherSelect !== filterSelect) {
                                    otherSelect.classList.remove('open');
                                    const otherBtn = otherSelect.querySelector('.filter-select-btn');
                                    if (otherBtn) {
                                        otherBtn.setAttribute('aria-expanded', 'false');
                                    }
                                }
                            });
                            
                            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
                            const isOpen = filterSelect.classList.contains('open');
                            if (isOpen) {
                                filterSelect.classList.remove('open');
                                btn.setAttribute('aria-expanded', 'false');
                            } else {
                                filterSelect.classList.add('open');
                                btn.setAttribute('aria-expanded', 'true');
                            }
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –æ–ø—Ü–∏–∏
                        const options = optionsList.querySelectorAll('.filter-option');
                        options.forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                const value = option.dataset.value || '';
                                const label = option.textContent.trim();
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π select
                                nativeSelect.value = value;
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ
                                const labelSpan = btn.querySelector('.filter-select-label');
                                if (labelSpan) {
                                    labelSpan.textContent = label;
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ü–∏–π
                                options.forEach(opt => opt.classList.remove('selected'));
                                option.classList.add('selected');
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
                                if (resetBtn) {
                                    if (value && value !== '') {
                                        resetBtn.style.display = 'flex';
                                    } else {
                                        resetBtn.style.display = 'none';
                                    }
                                }
                                
                                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                                filterSelect.classList.remove('open');
                                btn.setAttribute('aria-expanded', 'false');
                                
                                // –¢—Ä–∏–≥–≥–µ—Ä–∏–º change —Å–æ–±—ã—Ç–∏–µ
                                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                                applyMovementHistoryFilters();
                            });
                        });
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –Ω–∞—Ç–∏–≤–Ω—ã–º select
                        nativeSelect.addEventListener('change', () => {
                            const selectedValue = nativeSelect.value;
                            const selectedOption = nativeSelect.options[nativeSelect.selectedIndex];
                            const label = selectedOption ? selectedOption.textContent.trim() : '';
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ
                            const labelSpan = btn.querySelector('.filter-select-label');
                            if (labelSpan) {
                                labelSpan.textContent = label;
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ü–∏–π
                            options.forEach(opt => {
                                if (opt.dataset.value === selectedValue) {
                                    opt.classList.add('selected');
                                } else {
                                    opt.classList.remove('selected');
                                }
                            });
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
                            if (resetBtn) {
                                if (selectedValue && selectedValue !== '') {
                                    resetBtn.style.display = 'flex';
                                } else {
                                    resetBtn.style.display = 'none';
                                }
                            }
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞
                        if (resetBtn) {
                            resetBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                nativeSelect.value = '';
                                const labelSpan = btn.querySelector('.filter-select-label');
                                if (labelSpan) {
                                    labelSpan.textContent = nativeSelect.options[0] ? nativeSelect.options[0].textContent.trim() : '–í—Å–µ';
                                }
                                
                                options.forEach(opt => opt.classList.remove('selected'));
                                if (options[0]) {
                                    options[0].classList.add('selected');
                                }
                                
                                resetBtn.style.display = 'none';
                                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                                applyMovementHistoryFilters();
                            });
                        }
                        
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        const initialValue = nativeSelect.value;
                        options.forEach(opt => {
                            if (opt.dataset.value === initialValue) {
                                opt.classList.add('selected');
                            }
                        });
                        
                        if (resetBtn) {
                            if (initialValue && initialValue !== '') {
                                resetBtn.style.display = 'flex';
                            } else {
                                resetBtn.style.display = 'none';
                            }
                        }
                    });
                    
                    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.filter-select') && !e.target.closest('.filter-options-list')) {
                            filterSelects.forEach(filterSelect => {
                                filterSelect.classList.remove('open');
                                const btn = filterSelect.querySelector('.filter-select-btn');
                                if (btn) {
                                    btn.setAttribute('aria-expanded', 'false');
                                }
                            });
                        }
                    });
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
                initMovementHistoryFilterSelects();
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                if (movementHistorySearch) {
                    movementHistorySearch.addEventListener('input', applyMovementHistoryFilters);
                    movementHistorySearch.addEventListener('keyup', applyMovementHistoryFilters);
                }

                if (movementDateFilter) {
                    movementDateFilter.addEventListener('input', applyMovementHistoryFilters);
                    movementDateFilter.addEventListener('keyup', applyMovementHistoryFilters);
                }

                if (movementFromLocationFilter) {
                    movementFromLocationFilter.addEventListener('change', applyMovementHistoryFilters);
                }

                if (movementToLocationFilter) {
                    movementToLocationFilter.addEventListener('change', applyMovementHistoryFilters);
                }

                if (movementSortColumnFilter) {
                    movementSortColumnFilter.addEventListener('change', applyMovementHistoryFilters);
                }

                if (movementSortDirectionFilter) {
                    movementSortDirectionFilter.addEventListener('change', applyMovementHistoryFilters);
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', function(e) {
                    const toggle = document.getElementById('movementHistoryFilterToggle');
                    const dropdown = document.getElementById('movementHistoryFilterDropdown');

                    if (!toggle || !dropdown) return;

                    const clickedOnToggle = toggle.contains(e.target) || e.target === toggle;

                    if (clickedOnToggle) {
                        e.stopPropagation();
                        e.preventDefault();
                        dropdown.classList.toggle('active');
                        toggle.classList.toggle('active');
                        const isExpanded = dropdown.classList.contains('active');
                        toggle.setAttribute('aria-expanded', isExpanded);
                    } else if (dropdown.classList.contains('active')) {
                        if (!dropdown.contains(e.target)) {
                            dropdown.classList.remove('active');
                            toggle.classList.remove('active');
                            toggle.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
                
                if (resetMovementHistoryFilters) {
                    resetMovementHistoryFilters.addEventListener('click', () => {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
                        if (movementHistorySearch) movementHistorySearch.value = '';
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                        if (movementDateFilter) movementDateFilter.value = '';
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ select —ç–ª–µ–º–µ–Ω—Ç—ã
                        if (movementFromLocationFilter) {
                            movementFromLocationFilter.value = '';
                            movementFromLocationFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (movementToLocationFilter) {
                            movementToLocationFilter.value = '';
                            movementToLocationFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (movementSortColumnFilter) {
                            movementSortColumnFilter.value = '';
                            movementSortColumnFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (movementSortDirectionFilter) {
                            movementSortDirectionFilter.value = 'asc';
                            movementSortDirectionFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                        const filterSelects = document.querySelectorAll('#movementHistoryFilterDropdown .filter-select');
                        filterSelects.forEach(filterSelect => {
                            const nativeSelect = document.getElementById(filterSelect.dataset.target);
                            const btn = filterSelect.querySelector('.filter-select-btn');
                            const optionsList = filterSelect.querySelector('.filter-options-list');
                            const resetBtn = filterSelect.parentElement.querySelector('.filter-reset-btn');
                            
                            if (nativeSelect && btn && optionsList) {
                                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ select –≤ –ø–µ—Ä–≤–æ–µ (–ø—É—Å—Ç–æ–µ) –∑–Ω–∞—á–µ–Ω–∏–µ
                                if (nativeSelect.options.length > 0) {
                                    nativeSelect.value = nativeSelect.options[0].value;
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ
                                const labelSpan = btn.querySelector('.filter-select-label');
                                if (labelSpan && nativeSelect.options[0]) {
                                    labelSpan.textContent = nativeSelect.options[0].textContent.trim();
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ü–∏–π
                                const options = optionsList.querySelectorAll('.filter-option');
                                options.forEach(opt => opt.classList.remove('selected'));
                                if (options[0]) {
                                    options[0].classList.add('selected');
                                }
                                
                                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
                                if (resetBtn) {
                                    resetBtn.style.display = 'none';
                                }
                            }
                        });
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                        applyMovementHistoryFilters();
                    });
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö)
                if (movementHistoryTable) {
                    applyMovementHistoryFilters();
                }

                // –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π —Å–ø–∏—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–µ—Ç–∞–ª–µ–π
                const sparePartsSearch = document.getElementById('sparePartsSearch');
                const sparePartsFilterToggle = document.getElementById('sparePartsFilterToggle');
                const sparePartsFilterDropdown = document.getElementById('sparePartsFilterDropdown');
                const sparePartsTable = document.getElementById('sparePartsTable');
                const sparePartsTypeFilter = document.getElementById('sparePartsTypeFilter');
                const sparePartsSortColumnFilter = document.getElementById('sparePartsSortColumnFilter');
                const sparePartsSortDirectionFilter = document.getElementById('sparePartsSortDirectionFilter');
                const resetSparePartsFilters = document.getElementById('resetSparePartsFilters');
                const addSparePartBtn = document.getElementById('addSparePartBtn');
                const addSparePartModal = document.getElementById('addSparePartModal');
                const addSparePartModalClose = document.getElementById('addSparePartModalClose');
                const addSparePartModalCancel = document.getElementById('addSparePartModalCancel');
                const sparePartForm = document.getElementById('sparePartForm');
                const sparePartFormError = document.getElementById('sparePartFormError');
                const sparePartFormSubmit = document.getElementById('sparePartFormSubmit');
                const sparePartNameInput = document.getElementById('sparePartNameInput');
                const sparePartTypeBtn = document.getElementById('sparePartTypeBtn');
                const sparePartTypeSelect = document.getElementById('sparePartTypeSelect');

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–µ—Ç–∞–ª–µ–π
                function applySparePartsRowStriping() {
                    if (!sparePartsTable) return;
                    const rows = sparePartsTable.querySelectorAll('tbody tr');
                    let visibleIndex = 0;
                    rows.forEach(row => {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"
                        if (row.querySelector('td[colspan]')) {
                            row.classList.remove('alt-row');
                            return;
                        }
                        // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏
                        if (row.style.display === 'none') {
                            row.classList.remove('alt-row');
                            return;
                        }
                        const isAlt = visibleIndex % 2 === 1;
                        row.classList.toggle('alt-row', isAlt);
                        visibleIndex += 1;
                    });
                }

                // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π
                function applySparePartsFilters() {
                    if (!sparePartsTable) return;

                    const searchTerm = (sparePartsSearch?.value || '').toLowerCase().trim();
                    const typeFilterValue = (sparePartsTypeFilter?.value || '').trim();
                    const sortColumn = (sparePartsSortColumnFilter?.value || '').trim();
                    const sortDirection = (sparePartsSortDirectionFilter?.value || 'asc').trim();

                    const rows = Array.from(sparePartsTable.querySelectorAll('tbody tr'));
                    
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                    const filteredRows = rows.filter(tr => {
                        if (tr.querySelector('td[colspan]')) {
                            return false; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"
                        }

                        const partName = (tr.dataset.partName || '').toLowerCase();
                        const partType = (tr.dataset.partType || '').toLowerCase();

                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞
                        const matchesSearch = !searchTerm ||
                            partName.includes(searchTerm) ||
                            partType.includes(searchTerm);

                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ç–∏–ø—É
                        const matchesTypeFilter = !typeFilterValue ||
                            tr.dataset.partType === typeFilterValue;

                        return matchesSearch && matchesTypeFilter;
                    });

                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                    if (sortColumn && filteredRows.length > 0) {
                        filteredRows.sort((a, b) => {
                            let aValue, bValue;
                            let compareResult = 0;

                            switch (sortColumn) {
                                case 'name':
                                    aValue = (a.dataset.partName || '').toLowerCase();
                                    bValue = (b.dataset.partName || '').toLowerCase();
                                    compareResult = aValue.localeCompare(bValue, 'ru', { numeric: true });
                                    break;
                                case 'type':
                                    aValue = (a.dataset.partType || '').toLowerCase();
                                    bValue = (b.dataset.partType || '').toLowerCase();
                                    compareResult = aValue.localeCompare(bValue, 'ru', { numeric: true });
                                    break;
                                default:
                                    return 0;
                            }

                            if (sortDirection === 'desc') {
                                return -compareResult;
                            } else {
                                return compareResult;
                            }
                        });
                    }

                    // –ü–æ–ª—É—á–∞–µ–º tbody –¥–ª—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫
                    const tbody = sparePartsTable.querySelector('tbody');
                    if (!tbody) return;

                    // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π" –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    const noDataRow = tbody.querySelector('tr[colspan]') || tbody.querySelector('tr:has(td[colspan])');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏ —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π" –∏–∑ DOM
                    rows.forEach(tr => {
                        tr.style.display = 'none';
                    });
                    
                    if (noDataRow) {
                        noDataRow.remove();
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    if (filteredRows.length === 0) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = '<td colspan="3" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –¥–µ—Ç–∞–ª—è—Ö</td>';
                        tbody.appendChild(emptyRow);
                    } else {
                        // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ DOM –≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                        filteredRows.forEach((tr, index) => {
                            tr.style.display = '';
                            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü tbody (–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
                            tbody.appendChild(tr);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                            const numberCell = tr.querySelector('.number-column');
                            if (numberCell) {
                                numberCell.textContent = index + 1;
                            }
                        });
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Å—Ç—Ä–æ–∫
                    applySparePartsRowStriping();
                    
                    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —è—á–µ–π–∫–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
                    setTimeout(() => {
                        if (typeof setupSparePartsEditableCells === 'function') {
                            setupSparePartsEditableCells();
                        }
                        if (typeof setupSparePartsRowSelection === 'function') {
                            setupSparePartsRowSelection();
                        }
                    }, 50);
                }
                
                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏
                const originalApplySparePartsFilters = applySparePartsFilters;
                applySparePartsFilters = function() {
                    originalApplySparePartsFilters();
                    setTimeout(() => {
                        if (typeof setupSparePartsRowSelection === 'function') {
                            setupSparePartsRowSelection();
                        }
                    }, 50);
                };

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
                function initSparePartsFilterSelects() {
                    const filterSelects = document.querySelectorAll('#sparePartsFilterDropdown .filter-select');
                    
                    filterSelects.forEach(filterSelect => {
                        const btn = filterSelect.querySelector('.filter-select-btn');
                        const optionsList = filterSelect.querySelector('.filter-options-list');
                        const nativeSelect = document.getElementById(filterSelect.dataset.target);
                        const resetBtn = filterSelect.parentElement.querySelector('.filter-reset-btn');
                        
                        if (!btn || !optionsList || !nativeSelect) return;
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–ø–∏—Å–∫–∏
                            filterSelects.forEach(otherSelect => {
                                if (otherSelect !== filterSelect) {
                                    otherSelect.classList.remove('open');
                                    const otherBtn = otherSelect.querySelector('.filter-select-btn');
                                    if (otherBtn) {
                                        otherBtn.setAttribute('aria-expanded', 'false');
                                    }
                                }
                            });
                            
                            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
                            const isOpen = filterSelect.classList.contains('open');
                            if (isOpen) {
                                filterSelect.classList.remove('open');
                                btn.setAttribute('aria-expanded', 'false');
                            } else {
                                filterSelect.classList.add('open');
                                btn.setAttribute('aria-expanded', 'true');
                            }
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –æ–ø—Ü–∏–∏
                        const options = optionsList.querySelectorAll('.filter-option');
                        options.forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                const value = option.dataset.value || '';
                                const label = option.textContent.trim();
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π select
                                nativeSelect.value = value;
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ
                                const labelSpan = btn.querySelector('.filter-select-label');
                                if (labelSpan) {
                                    labelSpan.textContent = label;
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ü–∏–π
                                options.forEach(opt => opt.classList.remove('selected'));
                                option.classList.add('selected');
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
                                if (resetBtn) {
                                    if (value && value !== '') {
                                        resetBtn.style.display = 'flex';
                                    } else {
                                        resetBtn.style.display = 'none';
                                    }
                                }
                                
                                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                                filterSelect.classList.remove('open');
                                btn.setAttribute('aria-expanded', 'false');
                                
                                // –¢—Ä–∏–≥–≥–µ—Ä–∏–º change —Å–æ–±—ã—Ç–∏–µ
                                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                                applySparePartsFilters();
                            });
                        });
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –Ω–∞—Ç–∏–≤–Ω—ã–º select
                        nativeSelect.addEventListener('change', () => {
                            const selectedValue = nativeSelect.value;
                            const selectedOption = nativeSelect.options[nativeSelect.selectedIndex];
                            const label = selectedOption ? selectedOption.textContent.trim() : '';
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ
                            const labelSpan = btn.querySelector('.filter-select-label');
                            if (labelSpan) {
                                labelSpan.textContent = label;
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ü–∏–π
                            options.forEach(opt => {
                                if (opt.dataset.value === selectedValue) {
                                    opt.classList.add('selected');
                                } else {
                                    opt.classList.remove('selected');
                                }
                            });
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
                            if (resetBtn) {
                                if (selectedValue && selectedValue !== '') {
                                    resetBtn.style.display = 'flex';
                                } else {
                                    resetBtn.style.display = 'none';
                                }
                            }
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞
                        if (resetBtn) {
                            resetBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                nativeSelect.value = '';
                                const labelSpan = btn.querySelector('.filter-select-label');
                                if (labelSpan) {
                                    labelSpan.textContent = nativeSelect.options[0] ? nativeSelect.options[0].textContent.trim() : '–í—Å–µ';
                                }
                                
                                options.forEach(opt => opt.classList.remove('selected'));
                                if (options[0]) {
                                    options[0].classList.add('selected');
                                }
                                
                                resetBtn.style.display = 'none';
                                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                                applySparePartsFilters();
                            });
                        }
                        
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        const initialValue = nativeSelect.value;
                        options.forEach(opt => {
                            if (opt.dataset.value === initialValue) {
                                opt.classList.add('selected');
                            }
                        });
                        
                        if (resetBtn) {
                            if (initialValue && initialValue !== '') {
                                resetBtn.style.display = 'flex';
                            } else {
                                resetBtn.style.display = 'none';
                            }
                        }
                    });
                    
                    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.filter-select') && !e.target.closest('.filter-options-list')) {
                            filterSelects.forEach(filterSelect => {
                                filterSelect.classList.remove('open');
                                const btn = filterSelect.querySelector('.filter-select-btn');
                                if (btn) {
                                    btn.setAttribute('aria-expanded', 'false');
                                }
                            });
                        }
                    });
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
                initSparePartsFilterSelects();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                if (sparePartsSearch) {
                    sparePartsSearch.addEventListener('input', applySparePartsFilters);
                    sparePartsSearch.addEventListener('keyup', applySparePartsFilters);
                }

                if (sparePartsTypeFilter) {
                    sparePartsTypeFilter.addEventListener('change', applySparePartsFilters);
                }

                if (sparePartsSortColumnFilter) {
                    sparePartsSortColumnFilter.addEventListener('change', applySparePartsFilters);
                }

                if (sparePartsSortDirectionFilter) {
                    sparePartsSortDirectionFilter.addEventListener('change', applySparePartsFilters);
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', function(e) {
                    const toggle = document.getElementById('sparePartsFilterToggle');
                    const dropdown = document.getElementById('sparePartsFilterDropdown');

                    if (!toggle || !dropdown) return;

                    const clickedOnToggle = toggle.contains(e.target) || e.target === toggle;

                    if (clickedOnToggle) {
                        e.stopPropagation();
                        e.preventDefault();
                        dropdown.classList.toggle('active');
                        toggle.classList.toggle('active');
                        const isExpanded = dropdown.classList.contains('active');
                        toggle.setAttribute('aria-expanded', isExpanded);
                    } else if (dropdown.classList.contains('active')) {
                        if (!dropdown.contains(e.target)) {
                            dropdown.classList.remove('active');
                            toggle.classList.remove('active');
                            toggle.setAttribute('aria-expanded', 'false');
                        }
                    }
                });

                if (resetSparePartsFilters) {
                    resetSparePartsFilters.addEventListener('click', () => {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
                        if (sparePartsSearch) sparePartsSearch.value = '';
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ select —ç–ª–µ–º–µ–Ω—Ç—ã
                        if (sparePartsTypeFilter) {
                            sparePartsTypeFilter.value = '';
                            sparePartsTypeFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (sparePartsSortColumnFilter) {
                            sparePartsSortColumnFilter.value = '';
                            sparePartsSortColumnFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (sparePartsSortDirectionFilter) {
                            sparePartsSortDirectionFilter.value = 'asc';
                            sparePartsSortDirectionFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                        const filterSelects = document.querySelectorAll('#sparePartsFilterDropdown .filter-select');
                        filterSelects.forEach(filterSelect => {
                            const nativeSelect = document.getElementById(filterSelect.dataset.target);
                            const btn = filterSelect.querySelector('.filter-select-btn');
                            const optionsList = filterSelect.querySelector('.filter-options-list');
                            const resetBtn = filterSelect.parentElement.querySelector('.filter-reset-btn');
                            
                            if (nativeSelect && btn && optionsList) {
                                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ select –≤ –ø–µ—Ä–≤–æ–µ (–ø—É—Å—Ç–æ–µ) –∑–Ω–∞—á–µ–Ω–∏–µ
                                if (nativeSelect.options.length > 0) {
                                    nativeSelect.value = nativeSelect.options[0].value;
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ
                                const labelSpan = btn.querySelector('.filter-select-label');
                                if (labelSpan && nativeSelect.options[0]) {
                                    labelSpan.textContent = nativeSelect.options[0].textContent.trim();
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ü–∏–π
                                const options = optionsList.querySelectorAll('.filter-option');
                                options.forEach(opt => opt.classList.remove('selected'));
                                if (options[0]) {
                                    options[0].classList.add('selected');
                                }
                                
                                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
                                if (resetBtn) {
                                    resetBtn.style.display = 'none';
                                }
                            }
                        });
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                        applySparePartsFilters();
                    });
                }

                // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
                function showSparePartsStatus(message, state = 'info') {
                    const statusBox = document.getElementById('sparePartsTableUpdateStatus');
                    if (!statusBox) return;
                    statusBox.textContent = message;
                    statusBox.dataset.state = state;
                    statusBox.classList.remove('visible');
                    if (message) {
                        requestAnimationFrame(() => statusBox.classList.add('visible'));
                        setTimeout(() => {
                            statusBox.classList.remove('visible');
                        }, 5000);
                    }
                }

                // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π
                let sparePartsContextMenu = null;
                let selectedSparePartRow = null;

                function createSparePartsContextMenu() {
                    if (sparePartsContextMenu) {
                        return sparePartsContextMenu;
                    }

                    sparePartsContextMenu = document.createElement('div');
                    sparePartsContextMenu.className = 'context-menu';
                    sparePartsContextMenu.id = 'sparePartsContextMenu';
                    sparePartsContextMenu.style.display = 'none';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'context-menu-item danger';
                    deleteBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        –£–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å
                    `;
                    
                    deleteBtn.addEventListener('click', () => {
                        if (selectedSparePartRow) {
                            const sparePartId = selectedSparePartRow.dataset.sparePartId;
                            if (sparePartId) {
                                openDeleteSparePartModal(parseInt(sparePartId), selectedSparePartRow);
                            }
                        }
                        hideSparePartsContextMenu();
                    });
                    
                    sparePartsContextMenu.appendChild(deleteBtn);
                    document.body.appendChild(sparePartsContextMenu);
                    
                    return sparePartsContextMenu;
                }

                function showSparePartsContextMenu(event, row) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const menu = createSparePartsContextMenu();
                    selectedSparePartRow = row;
                    
                    const tableContainer = sparePartsTable.closest('.table-container');
                    if (!tableContainer) return;
                    
                    menu.style.display = 'block';
                    menu.style.visibility = 'hidden';
                    menu.style.left = '0px';
                    menu.style.top = '0px';
                    
                    const containerRect = tableContainer.getBoundingClientRect();
                    const menuRect = menu.getBoundingClientRect();
                    
                    let left = event.clientX;
                    let top = event.clientY;
                    
                    if (left + menuRect.width > containerRect.right) {
                        left = containerRect.right - menuRect.width - 10;
                    }
                    if (left < containerRect.left) {
                        left = containerRect.left + 10;
                    }
                    if (top + menuRect.height > containerRect.bottom) {
                        top = containerRect.bottom - menuRect.height - 10;
                    }
                    if (top < containerRect.top) {
                        top = containerRect.top + 10;
                    }
                    
                    menu.style.position = 'fixed';
                    menu.style.left = left + 'px';
                    menu.style.top = top + 'px';
                    menu.style.visibility = 'visible';
                    
                    setTimeout(() => {
                        document.addEventListener('click', hideSparePartsContextMenu, { once: true });
                    }, 0);
                }

                function hideSparePartsContextMenu() {
                    if (sparePartsContextMenu) {
                        sparePartsContextMenu.style.display = 'none';
                    }
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π
                if (sparePartsTable) {
                    const tbody = sparePartsTable.querySelector('tbody');
                    if (tbody) {
                        tbody.addEventListener('contextmenu', (e) => {
                            const row = e.target.closest('tr');
                            if (row && !row.querySelector('td[colspan]')) {
                                e.preventDefault();
                                showSparePartsContextMenu(e, row);
                            }
                        });
                    }
                }

                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏
                const deleteSparePartModal = document.getElementById('deleteSparePartModal');
                const deleteSparePartClose = document.getElementById('deleteSparePartModalClose');
                const deleteSparePartCancel = document.getElementById('deleteSparePartCancel');
                const deleteSparePartConfirm = document.getElementById('deleteSparePartConfirm');
                const deleteSparePartMessage = document.getElementById('deleteSparePartMessage');
                let sparePartToDelete = null;
                let sparePartToDeleteRow = null;

                function openDeleteSparePartModal(sparePartId, sparePartRow) {
                    if (!deleteSparePartModal) return;
                    
                    sparePartToDelete = sparePartId;
                    sparePartToDeleteRow = sparePartRow;
                    
                    const partName = sparePartRow.dataset.partName || '–¥–µ—Ç–∞–ª—å';
                    if (deleteSparePartMessage) {
                        deleteSparePartMessage.innerHTML = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å "${partName}"?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em>`;
                    }
                    
                    deleteSparePartModal.setAttribute('aria-hidden', 'false');
                    deleteSparePartModal.classList.add('visible');
                    document.body.classList.add('modal-open');
                }

                function closeDeleteSparePartModal() {
                    if (!deleteSparePartModal) return;
                    deleteSparePartModal.classList.remove('visible');
                    document.body.classList.remove('modal-open');
                    setTimeout(() => {
                        deleteSparePartModal.setAttribute('aria-hidden', 'true');
                    }, 0);
                    sparePartToDelete = null;
                    sparePartToDeleteRow = null;
                }

                if (deleteSparePartClose) {
                    deleteSparePartClose.addEventListener('click', closeDeleteSparePartModal);
                }
                if (deleteSparePartCancel) {
                    deleteSparePartCancel.addEventListener('click', closeDeleteSparePartModal);
                }
                if (deleteSparePartModal) {
                    deleteSparePartModal.addEventListener('click', (e) => {
                        if (e.target === deleteSparePartModal) {
                            closeDeleteSparePartModal();
                        }
                    });
                }

                if (deleteSparePartConfirm) {
                    deleteSparePartConfirm.addEventListener('click', async () => {
                        if (!sparePartToDelete) return;
                        
                        deleteSparePartConfirm.disabled = true;
                        const originalText = deleteSparePartConfirm.textContent;
                        deleteSparePartConfirm.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
                        
                        try {
                            const response = await fetch(`/admin/equipment/spare-part/${sparePartToDelete}`, {
                                method: 'DELETE'
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                if (sparePartToDeleteRow && document.contains(sparePartToDeleteRow)) {
                                    sparePartToDeleteRow.remove();
                                    
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Å—Ç—Ä–æ–∫–∏
                                    const tbody = sparePartsTable.querySelector('tbody');
                                    if (tbody && tbody.querySelectorAll('tr').length === 0) {
                                        const emptyRow = document.createElement('tr');
                                        emptyRow.innerHTML = '<td colspan="3" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –¥–µ—Ç–∞–ª—è—Ö</td>';
                                        tbody.appendChild(emptyRow);
                                    }
                                    
                                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏
                                    applySparePartsFilters();
                                }
                                
                                showSparePartsStatus('–î–µ—Ç–∞–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
                                closeDeleteSparePartModal();
                            } else {
                                showSparePartsStatus(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å', 'error');
                                deleteSparePartConfirm.disabled = false;
                                deleteSparePartConfirm.textContent = originalText;
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏:', error);
                            showSparePartsStatus('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏', 'error');
                            deleteSparePartConfirm.disabled = false;
                            deleteSparePartConfirm.textContent = originalText;
                        }
                    });
                }

                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏
                function openAddSparePartModal() {
                    if (!addSparePartModal) return;
                    addSparePartModal.classList.add('visible');
                    addSparePartModal.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('modal-open');
                    
                    if (sparePartForm) {
                        sparePartForm.reset();
                    }
                    if (sparePartFormError) {
                        sparePartFormError.textContent = '';
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–∞
                    if (sparePartTypeSelect) {
                        sparePartTypeSelect.value = '';
                    }
                    if (sparePartTypeBtn) {
                        const labelSpan = sparePartTypeBtn.querySelector('.modal-select-label');
                        if (labelSpan) {
                            labelSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø';
                        }
                    }
                }

                function closeAddSparePartModal() {
                    if (!addSparePartModal) return;
                    addSparePartModal.classList.remove('visible');
                    document.body.classList.remove('modal-open');
                    setTimeout(() => {
                        addSparePartModal.setAttribute('aria-hidden', 'true');
                    }, 0);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    if (sparePartFormSubmit) {
                        sparePartFormSubmit.disabled = false;
                        const defaultLabel = sparePartFormSubmit.dataset.defaultLabel || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        sparePartFormSubmit.textContent = defaultLabel;
                    }
                }

                if (addSparePartBtn) {
                    addSparePartBtn.addEventListener('click', openAddSparePartModal);
                }

                [addSparePartModalClose, addSparePartModalCancel].forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', closeAddSparePartModal);
                    }
                });

                if (addSparePartModal) {
                    addSparePartModal.addEventListener('click', (e) => {
                        if (e.target === addSparePartModal) {
                            closeAddSparePartModal();
                        }
                    });
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–∞ –¥–µ—Ç–∞–ª–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                if (sparePartTypeBtn && sparePartTypeSelect) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ modalDropdown, —á—Ç–æ –∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                    let sparePartModalDropdown = document.getElementById('modalDropdown');
                    if (!sparePartModalDropdown) {
                        sparePartModalDropdown = document.createElement('div');
                        sparePartModalDropdown.className = 'role-dropdown';
                        sparePartModalDropdown.id = 'modalDropdown';
                        document.body.appendChild(sparePartModalDropdown);
                    }
                    
                    let currentSparePartModalSelect = null;
                    
                    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                    const sparePartTypeData = {};
                    {% for type in spare_part_types %}
                    sparePartTypeData['{{ type }}'] = '{{ type }}';
                    {% endfor %}
                    sparePartTypeData['__custom__'] = '–î—Ä—É–≥–æ–µ';
                    
                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—è "–î—Ä—É–≥–æ–µ"
                    const customSparePartTypeRow = document.getElementById('customSparePartTypeRow');
                    const customSparePartType = document.getElementById('customSparePartType');
                    
                    function updateCustomSparePartTypeVisibility() {
                        if (customSparePartTypeRow && sparePartTypeSelect) {
                            if (sparePartTypeSelect.value === '__custom__') {
                                customSparePartTypeRow.style.display = 'block';
                                if (customSparePartType) {
                                    customSparePartType.required = true;
                                }
                            } else {
                                customSparePartTypeRow.style.display = 'none';
                                if (customSparePartType) {
                                    customSparePartType.required = false;
                                    customSparePartType.value = '';
                                }
                            }
                        }
                    }
                    
                    sparePartTypeBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (currentSparePartModalSelect === sparePartTypeBtn) {
                            sparePartModalDropdown.classList.remove('visible');
                            currentSparePartModalSelect = null;
                            sparePartTypeBtn.setAttribute('aria-expanded', 'false');
                        } else {
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–ø–∏—Å–∫–∏
                            if (currentSparePartModalSelect) {
                                sparePartModalDropdown.classList.remove('visible');
                            }
                            
                            // –ó–∞–ø–æ–ª–Ω—è–µ–º dropdown
                            sparePartModalDropdown.innerHTML = '';
                            Object.entries(sparePartTypeData).forEach(([value, label]) => {
                                const option = document.createElement('button');
                                option.type = 'button';
                                option.className = 'role-dropdown-option';
                                option.dataset.value = value;
                                option.textContent = label;
                                option.addEventListener('click', () => {
                                    sparePartTypeSelect.value = value;
                                    const labelSpan = sparePartTypeBtn.querySelector('.modal-select-label');
                                    if (labelSpan) {
                                        labelSpan.textContent = label;
                                    }
                                    updateCustomSparePartTypeVisibility();
                                    sparePartTypeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                                    sparePartModalDropdown.classList.remove('visible');
                                    sparePartTypeBtn.setAttribute('aria-expanded', 'false');
                                    currentSparePartModalSelect = null;
                                });
                                sparePartModalDropdown.appendChild(option);
                            });
                            
                            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º dropdown
                            const rect = sparePartTypeBtn.getBoundingClientRect();
                            const viewportHeight = window.innerHeight;
                            const spaceBelow = viewportHeight - rect.bottom;
                            const spaceAbove = rect.top;
                            const dropdownHeight = 300;
                            const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
                            
                            sparePartModalDropdown.style.position = 'fixed';
                            if (openUpward) {
                                sparePartModalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                                sparePartModalDropdown.style.top = 'auto';
                            } else {
                                sparePartModalDropdown.style.top = `${rect.bottom + 6}px`;
                                sparePartModalDropdown.style.bottom = 'auto';
                            }
                            sparePartModalDropdown.style.left = `${rect.left}px`;
                            sparePartModalDropdown.style.width = `${rect.width}px`;
                            sparePartModalDropdown.style.minWidth = `${rect.width}px`;
                            sparePartModalDropdown.style.maxWidth = `${rect.width}px`;
                            
                            currentSparePartModalSelect = sparePartTypeBtn;
                            sparePartModalDropdown.classList.add('visible');
                            sparePartTypeBtn.setAttribute('aria-expanded', 'true');
                        }
                    });
                    
                    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ dropdown
                    document.addEventListener('click', (e) => {
                        if (sparePartModalDropdown.classList.contains('visible') && 
                            !sparePartModalDropdown.contains(e.target) && 
                            !sparePartTypeBtn.contains(e.target)) {
                            sparePartModalDropdown.classList.remove('visible');
                            sparePartTypeBtn.setAttribute('aria-expanded', 'false');
                            currentSparePartModalSelect = null;
                        }
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è select
                    sparePartTypeSelect.addEventListener('change', () => {
                        updateCustomSparePartTypeVisibility();
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏
                if (sparePartForm) {
                    sparePartForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        if (!sparePartFormSubmit) return;
                        sparePartFormSubmit.disabled = true;
                        const originalText = sparePartFormSubmit.textContent;
                        sparePartFormSubmit.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                        
                        if (sparePartFormError) sparePartFormError.textContent = '';
                        
                        const sparePartName = sparePartNameInput?.value.trim() || '';
                        let sparePartType = sparePartTypeSelect?.value.trim() || '';
                        
                        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–î—Ä—É–≥–æ–µ", –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—è
                        if (sparePartType === '__custom__') {
                            const customSparePartType = document.getElementById('customSparePartType');
                            sparePartType = customSparePartType?.value.trim() || '';
                        }
                        
                        if (!sparePartName) {
                            if (sparePartFormError) {
                                sparePartFormError.textContent = '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏';
                            }
                            sparePartFormSubmit.disabled = false;
                            sparePartFormSubmit.textContent = originalText;
                            return;
                        }
                        
                        if (!sparePartType) {
                            if (sparePartFormError) {
                                sparePartFormError.textContent = sparePartTypeSelect?.value === '__custom__' 
                                    ? '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏' 
                                    : '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏';
                            }
                            sparePartFormSubmit.disabled = false;
                            sparePartFormSubmit.textContent = originalText;
                            return;
                        }
                        
                        try {
                            {% if equipment %}
                            const equipmentId = {{ equipment.id }};
                            {% else %}
                            const equipmentId = null;
                            {% endif %}
                            
                            if (!equipmentId) {
                                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
                            }
                            
                            const response = await fetch(`/admin/equipment/passport/${equipmentId}/spare-part`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    spare_part_name: sparePartName,
                                    spare_part_type: sparePartType
                                })
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok && result.success) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                                if (result.spare_parts && sparePartsTable) {
                                    const tbody = sparePartsTable.querySelector('tbody');
                                    if (tbody) {
                                        tbody.innerHTML = '';
                                        
                                        if (result.spare_parts.length === 0) {
                                            const emptySparePartRow = document.createElement('tr');
                                            emptySparePartRow.innerHTML = '<td colspan="3" style="text-align: center; padding: 20px; color: var(--text-medium);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –¥–µ—Ç–∞–ª—è—Ö</td>';
                                            tbody.appendChild(emptySparePartRow);
                                        } else {
                                            result.spare_parts.forEach((part, index) => {
                                                const row = document.createElement('tr');
                                                row.dataset.sparePartId = part.id;
                                                row.dataset.partName = part.name;
                                                row.dataset.partType = part.type;
                                                
                                                row.innerHTML = `
                                                    <td class="number-column">${index + 1}</td>
                                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="name">${part.name || '‚Äî'}</td>
                                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="type">${part.type || '‚Äî'}</td>
                                                `;
                                                tbody.appendChild(row);
                                            });
                                        }
                                        
                                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
                                        applySparePartsFilters();
                                        
                                        // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —è—á–µ–π–∫–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
                                        setTimeout(() => {
                                            if (typeof setupSparePartsEditableCells === 'function') {
                                                setupSparePartsEditableCells();
                                            }
                                            if (typeof setupSparePartsRowSelection === 'function') {
                                                setupSparePartsRowSelection();
                                            }
                                        }, 100);
                                    }
                                }
                                
                                showSparePartsStatus('–î–µ—Ç–∞–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                                
                                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                                sparePartFormSubmit.disabled = false;
                                sparePartFormSubmit.textContent = originalText;
                                
                                closeAddSparePartModal();
                            } else {
                                if (sparePartFormError) {
                                    sparePartFormError.textContent = result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å';
                                }
                                sparePartFormSubmit.disabled = false;
                                sparePartFormSubmit.textContent = originalText;
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏:', error);
                            if (sparePartFormError) {
                                sparePartFormError.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏';
                            }
                            sparePartFormSubmit.disabled = false;
                            sparePartFormSubmit.textContent = originalText;
                        }
                    });
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                if (sparePartsTable) {
                    applySparePartsFilters();
                }

                // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–µ–∫
                function revertSparePartCell(cell) {
                    const originalValue = cell.dataset.originalValue ?? '';
                    cell.textContent = originalValue;
                    cell.classList.remove('saving', 'error');
                }

                function updateSparePartCell(cell, sparePartId, field, value) {
                    cell.classList.add('saving');
                    fetch(`/admin/equipment/spare-part/${sparePartId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ field, value })
                    })
                    .then(async response => {
                        const data = await response.json();
                        return { ok: response.ok, data };
                    })
                    .then(({ ok, data }) => {
                        cell.classList.remove('saving');
                        if (ok && data.success) {
                            cell.textContent = data.value || '';
                            cell.dataset.originalValue = cell.textContent;
                            // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                            const row = cell.closest('tr');
                            if (row) {
                                if (field === 'name') {
                                    row.dataset.partName = data.value || '';
                                } else if (field === 'type') {
                                    row.dataset.partType = data.value || '';
                                }
                            }
                            showSparePartsStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                        } else {
                            cell.classList.add('error');
                            revertSparePartCell(cell);
                            showSparePartsStatus(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                            setTimeout(() => cell.classList.remove('error'), 1500);
                        }
                    })
                    .catch(() => {
                        cell.classList.remove('saving');
                        cell.classList.add('error');
                        revertSparePartCell(cell);
                        showSparePartsStatus('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                        setTimeout(() => cell.classList.remove('error'), 1500);
                    });
                }

                function revertMovementCell(cell) {
                    const originalValue = cell.dataset.originalValue ?? '';
                    cell.textContent = originalValue;
                    cell.classList.remove('saving', 'error');
                }

                function updateMovementCell(cell, movementId, field, value) {
                    cell.classList.add('saving');
                    fetch(`/admin/equipment/movement/${movementId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ field, value })
                    })
                    .then(async response => {
                        const data = await response.json();
                        return { ok: response.ok, data };
                    })
                    .then(({ ok, data }) => {
                        cell.classList.remove('saving');
                        if (ok && data.success) {
                            cell.textContent = data.value || '';
                            cell.dataset.originalValue = cell.textContent;
                            // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                            const row = cell.closest('tr');
                            if (row) {
                                if (field === 'move_date') {
                                    // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è data-move-date
                                    const dateText = data.value || '';
                                    // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ DD.MM.YYYY
                                    const dateMatch = dateText.match(/(\d{2})\.(\d{2})\.(\d{4})/);
                                    if (dateMatch) {
                                        const [, day, month, year] = dateMatch;
                                        row.dataset.moveDate = `${year}-${month}-${day}`;
                                    }
                                } else if (field === 'from_location') {
                                    row.dataset.fromLocationDetail = data.value || '';
                                } else if (field === 'to_location') {
                                    row.dataset.toLocationDetail = data.value || '';
                                }
                            }
                            showEquipmentStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                        } else {
                            cell.classList.add('error');
                            revertMovementCell(cell);
                            showEquipmentStatus(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                            setTimeout(() => cell.classList.remove('error'), 1500);
                        }
                    })
                    .catch(() => {
                        cell.classList.remove('saving');
                        cell.classList.add('error');
                        revertMovementCell(cell);
                        showEquipmentStatus('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                        setTimeout(() => cell.classList.remove('error'), 1500);
                    });
                }

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π
                function setupSparePartsEditableCells() {
                    if (!sparePartsTable) return;
                    const editableCells = sparePartsTable.querySelectorAll('td.editable-cell[data-field]');
                    editableCells.forEach(cell => {
                        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
                        cell.addEventListener('dblclick', () => {
                            cell.contentEditable = 'true';
                            cell.dataset.originalValue = cell.textContent.trim();
                            cell.focus();
                            const range = document.createRange();
                            range.selectNodeContents(cell);
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                        });

                        cell.addEventListener('keydown', (event) => {
                            if (cell.contentEditable !== 'true') return;
                            
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                cell.blur();
                            }
                            if (event.key === 'Escape') {
                                event.preventDefault();
                                revertSparePartCell(cell);
                                cell.blur();
                            }
                        });

                        cell.addEventListener('blur', () => {
                            cell.contentEditable = 'false';
                            
                            const originalValue = cell.dataset.originalValue ?? '';
                            const newValue = cell.textContent.trim();
                            if (newValue === originalValue) {
                                return;
                            }
                            const row = cell.closest('tr');
                            const sparePartId = row ? row.dataset.sparePartId : null;
                            if (!sparePartId) {
                                revertSparePartCell(cell);
                                showSparePartsStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å.', 'error');
                                return;
                            }
                            const field = cell.dataset.field;
                            if (!field) {
                                revertSparePartCell(cell);
                                return;
                            }
                            updateSparePartCell(cell, sparePartId, field, newValue);
                        });
                    });
                }

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π/–æ—Ç–¥–µ–ª–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                function setupMovementHistoryDropdowns() {
                    if (!movementHistoryTable) return;
                    
                    // –°–æ–∑–¥–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                    let movementHistoryDropdown = document.getElementById('movementHistoryDropdown');
                    if (!movementHistoryDropdown) {
                        movementHistoryDropdown = document.createElement('div');
                        movementHistoryDropdown.className = 'role-dropdown';
                        movementHistoryDropdown.id = 'movementHistoryDropdown';
                        document.body.appendChild(movementHistoryDropdown);
                    }
                    
                    const facilityCells = movementHistoryTable.querySelectorAll('td.facility-cell[data-field]');
                    let currentMovementHistoryCell = null;
                    
                    const departmentsData = {{ department_choices|tojson }};
                    const facilityDeptMap = {};
                    departmentsData.forEach(dept => {
                        const facilityId = dept.facility_id ? String(dept.facility_id) : '';
                        if (!facilityId) return;
                        if (!facilityDeptMap[facilityId]) {
                            facilityDeptMap[facilityId] = [];
                        }
                        facilityDeptMap[facilityId].push({
                            id: dept.id,
                            name: dept.name,
                            facility_name: dept.facility_name || ''
                        });
                    });
                    
                    function populateMovementHistoryDropdown(cell) {
                        if (!movementHistoryDropdown) return;
                        movementHistoryDropdown.innerHTML = '';
                        
                        const field = cell.dataset.field;
                        const currentDeptId = cell.dataset.departmentId;
                        const currentFacilityName = cell.dataset.facilityName || '';
                        
                        // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –ø–æ department_id
                        let currentFacilityId = null;
                        if (currentDeptId) {
                            const dept = departmentsData.find(d => String(d.id) === String(currentDeptId));
                            if (dept && dept.facility_id) {
                                currentFacilityId = String(dept.facility_id);
                            }
                        }
                        
                        // –ï—Å–ª–∏ –ø–æ–ª–µ - from_department_id –∏–ª–∏ to_department_id, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
                        if (field === 'from_department_id' || field === 'to_department_id') {
                            const facilities = {{ facility_choices|tojson }};
                            facilities.forEach(fac => {
                                const option = document.createElement('button');
                                option.type = 'button';
                                option.className = 'role-dropdown-option';
                                option.dataset.facilityId = fac.id;
                                option.textContent = fac.name;
                                option.addEventListener('click', () => {
                                    const targetCell = currentMovementHistoryCell;
                                    if (!targetCell) return;
                                    
                                    const row = targetCell.closest('tr');
                                    if (!row) return;
                                    const movementId = row.dataset.movementId;
                                    if (!movementId) return;
                                    
                                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ
                                    targetCell.dataset.facilityName = fac.name;
                                    const labelSpan = targetCell.querySelector('.role-cell-label');
                                    if (labelSpan) {
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, –æ—Ç–¥–µ–ª –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω –æ—Ç–¥–µ–ª—å–Ω–æ
                                        labelSpan.textContent = fac.name;
                                    }
                                    
                                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
                                    const departments = facilityDeptMap[String(fac.id)] || [];
                                    if (departments.length > 0) {
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—ã
                                        movementHistoryDropdown.innerHTML = '';
                                        departments.forEach(dept => {
                                            const deptOption = document.createElement('button');
                                            deptOption.type = 'button';
                                            deptOption.className = 'role-dropdown-option';
                                            deptOption.dataset.departmentId = dept.id;
                                            deptOption.textContent = dept.name;
                                            deptOption.addEventListener('click', () => {
                                                updateMovementDepartment(targetCell, movementId, field, dept.id, fac.name, dept.name);
                                                closeMovementHistoryDropdown();
                                            });
                                            movementHistoryDropdown.appendChild(deptOption);
                                        });
                                    } else {
                                        closeMovementHistoryDropdown();
                                    }
                                });
                                movementHistoryDropdown.appendChild(option);
                            });
                        }
                    }
                    
                    function updateMovementDepartment(cell, movementId, field, departmentId, facilityName, departmentName) {
                        cell.classList.add('saving');
                        fetch(`/admin/equipment/movement/${movementId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ field, value: departmentId })
                        })
                        .then(async response => {
                            const data = await response.json();
                            return { ok: response.ok, data };
                        })
                        .then(({ ok, data }) => {
                            cell.classList.remove('saving');
                            if (ok && data.success) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                const labelSpan = cell.querySelector('.role-cell-label');
                                if (labelSpan) {
                                    labelSpan.textContent = `${facilityName} - ${departmentName}`;
                                }
                                cell.dataset.departmentId = departmentId;
                                cell.dataset.facilityName = facilityName;
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                                const movementRow = cell.closest('tr');
                                if (movementRow) {
                                    if (field === 'from_department_id') {
                                        movementRow.dataset.fromLocation = `${facilityName} - ${departmentName}`;
                                        movementRow.dataset.fromDepartmentId = departmentId;
                                    } else if (field === 'to_department_id') {
                                        movementRow.dataset.toLocation = `${facilityName} - ${departmentName}`;
                                        movementRow.dataset.toDepartmentId = departmentId;
                                    }
                                }
                                
                                showEquipmentStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                                
                                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
                                setTimeout(() => {
                                    if (typeof setupMovementHistoryDropdowns === 'function') {
                                        setupMovementHistoryDropdowns();
                                    }
                                }, 50);
                            } else {
                                cell.classList.add('error');
                                showEquipmentStatus(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                                setTimeout(() => cell.classList.remove('error'), 1500);
                            }
                        })
                        .catch(() => {
                            cell.classList.remove('saving');
                            cell.classList.add('error');
                            showEquipmentStatus('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                            setTimeout(() => cell.classList.remove('error'), 1500);
                        });
                    }
                    
                    function positionMovementHistoryDropdown(cell) {
                        if (!movementHistoryDropdown) return;
                        const rect = cell.getBoundingClientRect();
                        movementHistoryDropdown.style.top = `${rect.bottom + window.scrollY}px`;
                        movementHistoryDropdown.style.left = `${rect.left + window.scrollX}px`;
                        movementHistoryDropdown.style.minWidth = `${rect.width}px`;
                    }
                    
                    function openMovementHistoryDropdown(cell) {
                        currentMovementHistoryCell = cell;
                        cell.setAttribute('aria-expanded', 'true');
                        populateMovementHistoryDropdown(cell);
                        movementHistoryDropdown.classList.add('visible');
                        requestAnimationFrame(() => {
                            positionMovementHistoryDropdown(cell);
                        });
                    }
                    
                    function closeMovementHistoryDropdown() {
                        if (currentMovementHistoryCell) {
                            currentMovementHistoryCell.setAttribute('aria-expanded', 'false');
                        }
                        currentMovementHistoryCell = null;
                        if (movementHistoryDropdown) {
                            movementHistoryDropdown.classList.remove('visible');
                        }
                    }
                    
                    facilityCells.forEach(cell => {
                        cell.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (currentMovementHistoryCell === cell && movementHistoryDropdown.classList.contains('visible')) {
                                closeMovementHistoryDropdown();
                            } else {
                                openMovementHistoryDropdown(cell);
                            }
                        });
                        
                        cell.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                openMovementHistoryDropdown(cell);
                            }
                            if (event.key === 'Escape') {
                                closeMovementHistoryDropdown();
                                cell.blur();
                            }
                        });
                    });
                    
                    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
                    document.addEventListener('click', (e) => {
                        if (!movementHistoryTable.contains(e.target) && 
                            !movementHistoryDropdown.contains(e.target) &&
                            !e.target.closest('.facility-cell')) {
                            closeMovementHistoryDropdown();
                        }
                    });
                }

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                function setupMovementHistoryEditableCells() {
                    if (!movementHistoryTable) return;
                    const editableCells = movementHistoryTable.querySelectorAll('td.editable-cell[data-field]');
                    editableCells.forEach(cell => {
                        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
                        cell.addEventListener('dblclick', () => {
                            cell.contentEditable = 'true';
                            cell.dataset.originalValue = cell.textContent.trim();
                            cell.focus();
                            const range = document.createRange();
                            range.selectNodeContents(cell);
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                        });

                        cell.addEventListener('keydown', (event) => {
                            if (cell.contentEditable !== 'true') return;
                            
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                cell.blur();
                            }
                            if (event.key === 'Escape') {
                                event.preventDefault();
                                revertMovementCell(cell);
                                cell.blur();
                            }
                        });

                        cell.addEventListener('blur', () => {
                            cell.contentEditable = 'false';
                            
                            const originalValue = cell.dataset.originalValue ?? '';
                            const newValue = cell.textContent.trim();
                            if (newValue === originalValue) {
                                return;
                            }
                            const row = cell.closest('tr');
                            const movementId = row ? row.dataset.movementId : null;
                            if (!movementId) {
                                revertMovementCell(cell);
                                showEquipmentStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ.', 'error');
                                return;
                            }
                            const field = cell.dataset.field;
                            if (!field) {
                                revertMovementCell(cell);
                                return;
                            }
                            updateMovementCell(cell, movementId, field, newValue);
                        });
                    });
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫ –∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                setupSparePartsEditableCells();
                setupMovementHistoryEditableCells();
                setupMovementHistoryDropdowns();

                // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫
                let sparePartsRowSelectionHandler = null;
                let sparePartsDocumentClickHandler = null;
                
                function setupSparePartsRowSelection() {
                    if (!sparePartsTable) return;
                    const tbody = sparePartsTable.querySelector('tbody');
                    if (!tbody) return;

                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (sparePartsRowSelectionHandler) {
                        tbody.removeEventListener('click', sparePartsRowSelectionHandler);
                    }
                    if (sparePartsDocumentClickHandler) {
                        document.removeEventListener('click', sparePartsDocumentClickHandler);
                    }

                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π
                    function getAllSparePartsRows() {
                        return sparePartsTable ? sparePartsTable.querySelectorAll('tbody tr') : [];
                    }

                    // –û–¥–∏–Ω–∞—Ä–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                    sparePartsRowSelectionHandler = (e) => {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º —è—á–µ–π–∫–∞–º –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        if (e.target.closest('.editable-cell[contenteditable="true"]')) {
                            return;
                        }
                        
                        const row = e.target.closest('tr');
                        if (row && !row.querySelector('td[colspan]')) {
                            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞, —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                            if (row.classList.contains('selected')) {
                                row.classList.remove('selected');
                            } else {
                                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                                getAllSparePartsRows().forEach(r => r.classList.remove('selected'));
                                // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                                row.classList.add('selected');
                            }
                        }
                    };
                    
                    tbody.addEventListener('click', sparePartsRowSelectionHandler);

                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã
                    sparePartsDocumentClickHandler = (e) => {
                        if (!sparePartsTable.contains(e.target)) {
                            getAllSparePartsRows().forEach(r => r.classList.remove('selected'));
                        }
                    };
                    
                    document.addEventListener('click', sparePartsDocumentClickHandler);
                }

                let movementHistoryRowSelectionHandler = null;
                let movementHistoryDocumentClickHandler = null;
                
                function setupMovementHistoryRowSelection() {
                    if (!movementHistoryTable) return;
                    const tbody = movementHistoryTable.querySelector('tbody');
                    if (!tbody) return;

                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (movementHistoryRowSelectionHandler) {
                        tbody.removeEventListener('click', movementHistoryRowSelectionHandler);
                    }
                    if (movementHistoryDocumentClickHandler) {
                        document.removeEventListener('click', movementHistoryDocumentClickHandler);
                    }

                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
                    function getAllMovementHistoryRows() {
                        return movementHistoryTable ? movementHistoryTable.querySelectorAll('tbody tr') : [];
                    }

                    // –û–¥–∏–Ω–∞—Ä–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                    movementHistoryRowSelectionHandler = (e) => {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º —è—á–µ–π–∫–∞–º –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        if (e.target.closest('.editable-cell[contenteditable="true"]')) {
                            return;
                        }
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–∞–º
                        if (e.target.closest('.facility-cell') || e.target.closest('.department-cell')) {
                            return;
                        }
                        
                        const row = e.target.closest('tr');
                        if (row && !row.querySelector('td[colspan]')) {
                            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞, —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                            if (row.classList.contains('selected')) {
                                row.classList.remove('selected');
                            } else {
                                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
                                getAllMovementHistoryRows().forEach(r => r.classList.remove('selected'));
                                // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                                row.classList.add('selected');
                            }
                        }
                    };
                    
                    tbody.addEventListener('click', movementHistoryRowSelectionHandler);

                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã
                    movementHistoryDocumentClickHandler = (e) => {
                        if (!movementHistoryTable.contains(e.target)) {
                            getAllMovementHistoryRows().forEach(r => r.classList.remove('selected'));
                        }
                    };
                    
                    document.addEventListener('click', movementHistoryDocumentClickHandler);
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫
                setupSparePartsRowSelection();
                setupMovementHistoryRowSelection();

                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
                passportTabs.forEach(tab => {
                    const existingClickHandler = tab.onclick;
                    tab.addEventListener('click', function() {
                        if (existingClickHandler) existingClickHandler.call(this);
                        setTimeout(() => {
                            setupSparePartsRowSelection();
                            setupMovementHistoryRowSelection();
                        }, 100);
                    });
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ –ø–∞—Å–ø–æ—Ä—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
            }
        })();
    </script>
    {% endif %}

    {% if section == 'pto' %}
    <script>
        // JavaScript –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º –ü–¢–û
        (function() {
            'use strict';
            
            try {
                const calendarGrid = document.getElementById('ptoCalendarGrid');
                const monthSelect = document.getElementById('ptoMonthSelect');
                const yearSelect = document.getElementById('ptoYearSelect');
                const prevMonthBtn = document.getElementById('ptoPrevMonth');
                const nextMonthBtn = document.getElementById('ptoNextMonth');
                const tableBody = document.getElementById('ptoTableBody');
                const tableDateHeader = document.getElementById('ptoTableDate');
                
                let currentDate = new Date();
                let selectedDate = new Date();
                let maintenanceData = {};
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–¥–∞ –≤ —Å–µ–ª–µ–∫—Ç–µ
                function initYearSelect() {
                    const currentYear = currentDate.getFullYear();
                    yearSelect.innerHTML = '';
                    for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === currentYear) {
                            option.selected = true;
                        }
                        yearSelect.appendChild(option);
                    }
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                function formatDate(date) {
                    const months = ['–Ø–Ω–≤–∞—Ä—è', '–§–µ–≤—Ä–∞–ª—è', '–ú–∞—Ä—Ç–∞', '–ê–ø—Ä–µ–ª—è', '–ú–∞—è', '–ò—é–Ω—è',
                                   '–ò—é–ª—è', '–ê–≤–≥—É—Å—Ç–∞', '–°–µ–Ω—Ç—è–±—Ä—è', '–û–∫—Ç—è–±—Ä—è', '–ù–æ—è–±—Ä—è', '–î–µ–∫–∞–±—Ä—è'];
                    return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è API
                function formatDateForAPI(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                async function loadCalendarData() {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth() + 1;
                    
                    try {
                        const response = await fetch(`/admin/pto/api/calendar?year=${year}&month=${month}`);
                        if (!response.ok) {
                            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                        }
                        maintenanceData = await response.json();
                        renderCalendar();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
                    }
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
                async function loadTableData(date) {
                    const dateStr = formatDateForAPI(date);
                    
                    try {
                        const response = await fetch(`/admin/pto/api/date?date=${dateStr}`);
                        if (!response.ok) {
                            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                        }
                        const data = await response.json();
                        renderTable(data);
                        tableDateHeader.textContent = formatDate(date);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã:', error);
                        tableBody.innerHTML = '<tr><td colspan="4" class="pto-table-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                    }
                }
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                function renderCalendar() {
                    if (!calendarGrid) return;
                    
                    calendarGrid.innerHTML = '';
                    
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    
                    // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    
                    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∫ 0 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
                    let startDay = firstDay.getDay();
                    startDay = startDay === 0 ? 6 : startDay - 1;
                    
                    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
                    const daysInMonth = lastDay.getDate();
                    
                    // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                    const prevMonthLastDay = new Date(year, month, 0).getDate();
                    for (let i = startDay - 1; i >= 0; i--) {
                        const day = prevMonthLastDay - i;
                        const date = new Date(year, month - 1, day);
                        const dayElement = createDayElement(date, true);
                        calendarGrid.appendChild(dayElement);
                    }
                    
                    // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const isToday = date.getTime() === today.getTime();
                        const isSelected = date.getTime() === selectedDate.getTime();
                        const dayElement = createDayElement(date, false, isToday, isSelected);
                        calendarGrid.appendChild(dayElement);
                    }
                    
                    // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏
                    const totalCells = calendarGrid.children.length;
                    const remainingCells = 42 - totalCells; // 6 –Ω–µ–¥–µ–ª—å * 7 –¥–Ω–µ–π
                    for (let day = 1; day <= remainingCells; day++) {
                        const date = new Date(year, month + 1, day);
                        const dayElement = createDayElement(date, true);
                        calendarGrid.appendChild(dayElement);
                    }
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–Ω—è
                function createDayElement(date, isOtherMonth, isToday = false, isSelected = false) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'pto-calendar-day';
                    
                    if (isOtherMonth) {
                        dayElement.classList.add('other-month');
                    }
                    if (isToday) {
                        dayElement.classList.add('today');
                    }
                    if (isSelected) {
                        dayElement.classList.add('selected');
                    }
                    
                    const dateStr = formatDateForAPI(date);
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'pto-day-number';
                    dayNumber.textContent = date.getDate();
                    dayElement.appendChild(dayNumber);
                    
                    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ü–¢–û
                    if (maintenanceData[dateStr] && maintenanceData[dateStr].length > 0) {
                        const indicators = document.createElement('div');
                        indicators.className = 'pto-day-indicators';
                        
                        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ü–≤–µ—Ç–∞–º
                        const grouped = {
                            green: [],
                            red: [],
                            yellow: [],
                            blue: []
                        };
                        
                        maintenanceData[dateStr].forEach(item => {
                            grouped[item.indicator_color].push(item);
                        });
                        
                        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                        Object.keys(grouped).forEach(color => {
                            if (grouped[color].length > 0) {
                                const indicator = document.createElement('div');
                                indicator.className = `pto-indicator ${color}`;
                                if (grouped[color].length > 1) {
                                    indicator.classList.add('multiple');
                                    indicator.textContent = grouped[color].length;
                                }
                                indicators.appendChild(indicator);
                            }
                        });
                        
                        dayElement.appendChild(indicators);
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω–∞—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞
                    dayElement.addEventListener('click', () => {
                        if (!isOtherMonth) {
                            selectedDate = new Date(date);
                            loadTableData(selectedDate);
                            renderCalendar(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
                        }
                    });
                    
                    return dayElement;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –¥–∞—Ç–µ
                function getStatusIndicatorColor(status, maintenanceDate) {
                    const statusLower = (status || '').toLowerCase();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –ø—Ä–æ—à–µ–¥—à–µ–π
                    let isPastDate = false;
                    if (maintenanceDate) {
                        const maintDate = new Date(maintenanceDate);
                        maintDate.setHours(0, 0, 0, 0);
                        isPastDate = maintDate < today;
                    }
                    
                    if (statusLower.includes('–≤—ã–ø–æ–ª–Ω–µ–Ω–æ') || statusLower.includes('–∑–∞–≤–µ—Ä—à–µ–Ω–æ') || 
                        statusLower.includes('completed') || statusLower.includes('success')) {
                        return 'green';
                    } else if (statusLower.includes('–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ') || statusLower.includes('in_progress') || 
                               statusLower.includes('in process')) {
                        return 'blue';
                    } else if (statusLower.includes('–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ') || statusLower.includes('–ø—Ä–æ–≤–∞–ª') || 
                               statusLower.includes('failed') || statusLower.includes('error')) {
                        return 'red';
                    } else if (statusLower.includes('–æ–∂–∏–¥–∞–µ—Ç') && isPastDate) {
                        // –ü—Ä–æ—à–ª—ã–µ –∑–∞–¥–∞—á–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–û–∂–∏–¥–∞–µ—Ç –ü–¢–û" - –∫—Ä–∞—Å–Ω—ã–π
                        return 'red';
                    } else {
                        return 'yellow';
                    }
                }
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
                function renderTable(data) {
                    if (!tableBody) return;
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="pto-table-empty">–ù–∞ —ç—Ç—É –¥–∞—Ç—É –ü–¢–û –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</td></tr>';
                        return;
                    }
                    
                    tableBody.innerHTML = data.map(item => {
                        const status = item.status || '–û–∂–∏–¥–∞–µ—Ç –ü–¢–û';
                        const maintenanceDate = item.maintenance_date || formatDateForAPI(selectedDate);
                        const indicatorColor = getStatusIndicatorColor(status, maintenanceDate);
                        return `
                        <tr class="pto-table-row" 
                            data-equipment-id="${item.equipment_id}" 
                            data-equipment-assignment-id="${item.equipment_assignment_id}"
                            data-maintenance-date="${maintenanceDate}"
                            data-current-status="${escapeHtml(status)}">
                            <td>${escapeHtml(item.equipment_name)}</td>
                            <td>${escapeHtml(item.department_name)}</td>
                            <td>${escapeHtml(item.location)}</td>
                            <td class="pto-status-cell">
                                <span class="pto-table-status-indicator ${indicatorColor}"></span>
                                <span class="pto-status-text">${escapeHtml(status)}</span>
                            </td>
                        </tr>
                    `;
                    }).join('');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                    const rows = tableBody.querySelectorAll('.pto-table-row');
                    rows.forEach(row => {
                        row.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showPTOContextMenu(e, row);
                        });
                    });
                }
                
                // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ü–¢–û
                let ptoContextMenu = null;
                
                function showPTOContextMenu(event, row) {
                    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–µ–Ω—é, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (ptoContextMenu) {
                        ptoContextMenu.remove();
                        ptoContextMenu = null;
                    }
                    
                    const currentStatus = row.dataset.currentStatus || '';
                    const statusMap = {
                        '–í –ø—Ä–æ—Ü–µ—Å—Å–µ': 'in_progress',
                        '–í—ã–ø–æ–ª–Ω–µ–Ω–æ': 'completed',
                        '–û–∂–∏–¥–∞–µ—Ç –ü–¢–û': 'pending',
                        '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ': 'pending'
                    };
                    const currentStatusKey = statusMap[currentStatus] || '';
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
                    ptoContextMenu = document.createElement('div');
                    ptoContextMenu.className = 'pto-context-menu';
                    ptoContextMenu.innerHTML = `
                        <div class="pto-context-menu-item ${currentStatusKey === 'in_progress' ? 'active' : ''}" data-status="in_progress">
                            <span class="pto-status-indicator blue"></span>
                            –í –ø—Ä–æ—Ü–µ—Å—Å–µ
                        </div>
                        <div class="pto-context-menu-item ${currentStatusKey === 'completed' ? 'active' : ''}" data-status="completed">
                            <span class="pto-status-indicator green"></span>
                            –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                        </div>
                        <div class="pto-context-menu-item ${currentStatusKey === 'pending' ? 'active' : ''}" data-status="pending">
                            <span class="pto-status-indicator yellow"></span>
                            –û–∂–∏–¥–∞–µ—Ç –ü–¢–û
                        </div>
                    `;
                    
                    document.body.appendChild(ptoContextMenu);
                    
                    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é
                    const rect = row.getBoundingClientRect();
                    const menuRect = ptoContextMenu.getBoundingClientRect();
                    let top = rect.bottom + window.scrollY;
                    let left = rect.left + window.scrollX;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
                    if (top + menuRect.height > window.innerHeight + window.scrollY) {
                        top = rect.top + window.scrollY - menuRect.height;
                    }
                    if (left + menuRect.width > window.innerWidth + window.scrollX) {
                        left = rect.right + window.scrollX - menuRect.width;
                    }
                    
                    ptoContextMenu.style.top = `${top}px`;
                    ptoContextMenu.style.left = `${left}px`;
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
                    const menuItems = ptoContextMenu.querySelectorAll('.pto-context-menu-item');
                    menuItems.forEach(item => {
                        item.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const status = item.dataset.status;
                            await updatePTOStatus(row, status);
                            hidePTOContextMenu();
                        });
                    });
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                    setTimeout(() => {
                        document.addEventListener('click', hidePTOContextMenu, { once: true });
                    }, 0);
                }
                
                function hidePTOContextMenu() {
                    if (ptoContextMenu) {
                        ptoContextMenu.remove();
                        ptoContextMenu = null;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ü–¢–û
                async function updatePTOStatus(row, status) {
                    const equipmentId = row.dataset.equipmentId;
                    const maintenanceDate = row.dataset.maintenanceDate;
                    
                    const statusMap = {
                        'in_progress': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
                        'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
                        'pending': '–û–∂–∏–¥–∞–µ—Ç –ü–¢–û'
                    };
                    
                    const statusText = statusMap[status] || status;
                    
                    try {
                        const response = await fetch('/admin/pto/api/update-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                equipment_id: parseInt(equipmentId),
                                maintenance_date: maintenanceDate,
                                status: statusText
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        const statusCell = row.querySelector('.pto-status-cell');
                        if (statusCell) {
                            const maintenanceDate = row.dataset.maintenanceDate;
                            const indicatorColor = getStatusIndicatorColor(statusText, maintenanceDate);
                            statusCell.innerHTML = `
                                <span class="pto-table-status-indicator ${indicatorColor}"></span>
                                <span class="pto-status-text">${escapeHtml(statusText)}</span>
                            `;
                        }
                        row.dataset.currentStatus = statusText;
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                        loadCalendarData();
                        
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ü–¢–û:', error);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ü–¢–û');
                    }
                }
                
                // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞
                function changeMonth(delta) {
                    currentDate.setMonth(currentDate.getMonth() + delta);
                    monthSelect.value = currentDate.getMonth() + 1;
                    yearSelect.value = currentDate.getFullYear();
                    loadCalendarData();
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', () => changeMonth(-1));
                }
                
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', () => changeMonth(1));
                }
                
                if (monthSelect) {
                    monthSelect.addEventListener('change', () => {
                        currentDate.setMonth(parseInt(monthSelect.value) - 1);
                        loadCalendarData();
                    });
                }
                
                if (yearSelect) {
                    yearSelect.addEventListener('change', () => {
                        currentDate.setFullYear(parseInt(yearSelect.value));
                        loadCalendarData();
                    });
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                initYearSelect();
                monthSelect.value = currentDate.getMonth() + 1;
                yearSelect.value = currentDate.getFullYear();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                loadCalendarData();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
                loadTableData(selectedDate);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ –ü–¢–û:', error);
            }
        })();
    </script>
    {% endif %}

    {% if section == 'tasks' %}
    <script>
        (function() {
            const createTaskBtn = document.getElementById('createTaskBtn');
            const createTaskModal = document.getElementById('createTaskModal');
            const createTaskModalClose = document.getElementById('createTaskModalClose');
            const createTaskModalCancel = document.getElementById('createTaskModalCancel');
            const createTaskForm = document.getElementById('createTaskForm');
            const createTaskFormError = document.getElementById('createTaskFormError');
            const taskDetailsModal = document.getElementById('taskDetailsModal');
            const taskDetailsModalClose = document.getElementById('taskDetailsModalClose');
            const taskDetailsModalCancel = document.getElementById('taskDetailsModalCancel');
            const taskStatusToggle = document.getElementById('taskStatusToggle');
            const taskStatusLabel = document.getElementById('taskStatusLabel');
            let currentTaskId = null;

            // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
            if (createTaskBtn) {
                createTaskBtn.addEventListener('click', () => {
                    if (createTaskModal) {
                        // –û—á–∏—â–∞–µ–º dataset –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–∑ –∫–Ω–æ–ø–∫–∏ (–Ω–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é)
                        delete createTaskModal.dataset.equipmentAssignmentId;
                        delete createTaskModal.dataset.equipmentId;
                        delete createTaskModal.dataset.departmentId;
                        delete createTaskModal.dataset.facilityId;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
                        const taskDepartmentDisplay = document.getElementById('taskDepartmentDisplay');
                        const taskDepartmentSelectWrapper = document.getElementById('taskDepartmentSelectWrapper');
                        const taskFacilitySelectWrapper = document.getElementById('taskFacilitySelectWrapper');
                        const taskFacilityDisplay = document.getElementById('taskFacilityDisplay');
                        const taskEquipmentDisplay = document.getElementById('taskEquipmentDisplay');
                        const taskEquipmentSelectWrapper = document.getElementById('taskEquipmentSelectWrapper');
                        if (taskDepartmentDisplay) {
                            taskDepartmentDisplay.style.display = 'none';
                        }
                        
                        if (taskDepartmentSelectWrapper) {
                            taskDepartmentSelectWrapper.style.display = 'block';
                        }
                        
                        if (taskFacilityDisplay) {
                            taskFacilityDisplay.style.display = 'none';
                        }
                        
                        if (taskFacilitySelectWrapper) {
                            taskFacilitySelectWrapper.style.display = 'block';
                        }
                        
                        if (taskEquipmentDisplay) {
                            taskEquipmentDisplay.style.display = 'none';
                        }
                        
                        if (taskEquipmentSelectWrapper) {
                            taskEquipmentSelectWrapper.style.display = 'block';
                        }
                        
                        if (taskEquipmentDisplayReadonly) {
                            taskEquipmentDisplayReadonly.style.display = 'none';
                        }
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                        if (createTaskForm) {
                            createTaskForm.reset();
                            
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                            const taskFacilitySelect = document.getElementById('taskFacilitySelect');
                            const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
                            const taskEquipmentSelect = document.getElementById('taskEquipmentSelect');
                            
                            if (taskFacilitySelect) {
                                taskFacilitySelect.value = '';
                                const modalTaskFacilityBtn = document.getElementById('modalTaskFacilityBtn');
                                if (modalTaskFacilityBtn) {
                                    const label = modalTaskFacilityBtn.querySelector('.modal-select-label');
                                    if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                                }
                            }
                            
                            if (taskDepartmentSelect) {
                                taskDepartmentSelect.value = '';
                                taskDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                                taskDepartmentSelect.disabled = true;
                                const modalTaskDepartmentBtn = document.getElementById('modalTaskDepartmentBtn');
                                if (modalTaskDepartmentBtn) {
                                    modalTaskDepartmentBtn.disabled = true;
                                    const label = modalTaskDepartmentBtn.querySelector('.modal-select-label');
                                    if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                                }
                            }
                            
                            if (taskEquipmentSelect) {
                                taskEquipmentSelect.value = '';
                                taskEquipmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                                taskEquipmentSelect.disabled = true;
                                const modalTaskEquipmentBtn = document.getElementById('modalTaskEquipmentBtn');
                                if (modalTaskEquipmentBtn) {
                                    modalTaskEquipmentBtn.disabled = true;
                                    const label = modalTaskEquipmentBtn.querySelector('.modal-select-label');
                                    if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                                }
                            }
                        }
                        
                        createTaskModal.classList.add('visible');
                        document.body.classList.add('modal-open');
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                        setTimeout(() => {
                            createTaskModal.setAttribute('aria-hidden', 'false');
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ
                            const firstInput = createTaskForm ? createTaskForm.querySelector('input:not([readonly]), textarea, .modal-select-btn') : null;
                            if (firstInput) {
                                firstInput.focus();
                            }
                        }, 0);
                        
                        if (createTaskFormError) {
                            createTaskFormError.textContent = '';
                        }
                    }
                });
            }

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
            function closeCreateTaskModal() {
                if (!createTaskModal) return;
                
                // –û—á–∏—â–∞–µ–º dataset –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                delete createTaskModal.dataset.equipmentAssignmentId;
                delete createTaskModal.dataset.equipmentId;
                delete createTaskModal.dataset.departmentId;
                delete createTaskModal.dataset.facilityId;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                const taskDepartmentDisplay = document.getElementById('taskDepartmentDisplay');
                const taskDepartmentSelectWrapper = document.getElementById('taskDepartmentSelectWrapper');
                const taskFacilityDisplay = document.getElementById('taskFacilityDisplay');
                const taskFacilitySelectWrapper = document.getElementById('taskFacilitySelectWrapper');
                if (taskDepartmentDisplay) {
                    taskDepartmentDisplay.style.display = 'none';
                }
                
                if (taskDepartmentSelectWrapper) {
                    taskDepartmentSelectWrapper.style.display = 'block';
                }
                
                if (taskFacilityDisplay) {
                    taskFacilityDisplay.style.display = 'none';
                }
                
                if (taskFacilitySelectWrapper) {
                    taskFacilitySelectWrapper.style.display = 'block';
                }
                
                if (taskEquipmentDisplayReadonly) {
                    taskEquipmentDisplayReadonly.style.display = 'none';
                }
                
                const taskEquipmentDisplay = document.getElementById('taskEquipmentDisplay');
                const taskEquipmentSelectWrapper = document.getElementById('taskEquipmentSelectWrapper');
                
                if (taskEquipmentDisplay) {
                    taskEquipmentDisplay.style.display = 'none';
                }
                
                if (taskEquipmentSelectWrapper) {
                    taskEquipmentSelectWrapper.style.display = 'block';
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                const taskFacilitySelect = document.getElementById('taskFacilitySelect');
                const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
                const taskEquipmentSelect = document.getElementById('taskEquipmentSelect');
                
                if (taskFacilitySelect) {
                    taskFacilitySelect.value = '';
                    const modalTaskFacilityBtn = document.getElementById('modalTaskFacilityBtn');
                    if (modalTaskFacilityBtn) {
                        const label = modalTaskFacilityBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                
                if (taskDepartmentSelect) {
                    taskDepartmentSelect.value = '';
                    taskDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                    taskDepartmentSelect.disabled = true;
                    const modalTaskDepartmentBtn = document.getElementById('modalTaskDepartmentBtn');
                    if (modalTaskDepartmentBtn) {
                        modalTaskDepartmentBtn.disabled = true;
                        const label = modalTaskDepartmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                
                if (taskEquipmentSelect) {
                    taskEquipmentSelect.value = '';
                    taskEquipmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                    taskEquipmentSelect.disabled = true;
                    const modalTaskEquipmentBtn = document.getElementById('modalTaskEquipmentBtn');
                    if (modalTaskEquipmentBtn) {
                        modalTaskEquipmentBtn.disabled = true;
                        const label = modalTaskEquipmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                }
                
                // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π aria-hidden
                const activeElement = document.activeElement;
                if (activeElement && createTaskModal.contains(activeElement)) {
                    activeElement.blur();
                }
                
                createTaskModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                setTimeout(() => {
                    createTaskModal.setAttribute('aria-hidden', 'true');
                }, 0);
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É –∏ –∫–Ω–æ–ø–∫–µ "–û—Ç–º–µ–Ω–∞"
            [createTaskModalClose, createTaskModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        closeCreateTaskModal();
                    });
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (createTaskModal) {
                createTaskModal.addEventListener('click', (e) => {
                    if (e.target === createTaskModal) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeCreateTaskModal();
                    }
                });
            }


            // –ö–∞—Å—Ç–æ–º–Ω—ã–µ dropdown'—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
            let taskModalDropdown = document.getElementById('modalDropdown');
            if (!taskModalDropdown) {
                taskModalDropdown = document.createElement('div');
                taskModalDropdown.className = 'role-dropdown';
                taskModalDropdown.id = 'modalDropdown';
                document.body.appendChild(taskModalDropdown);
            }
            
            let currentTaskModalSelect = null;
            let taskDropdownJustOpened = false;
            let taskModalSelectData = {
                facility: {},
                department: {},
                equipment: {}
            };
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
            const facilityChoices = {{ facility_choices | tojson }};
            facilityChoices.forEach(fac => {
                taskModalSelectData.facility[fac.id] = fac.name;
            });
            
            // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è dropdown –¥–ª—è –∑–∞–¥–∞—á
            function populateTaskModalDropdown(field, options) {
                if (!taskModalDropdown || !options || Object.keys(options).length === 0) {
                    return;
                }
                
                taskModalDropdown.innerHTML = '';
                Object.entries(options).forEach(([value, label]) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = value;
                    option.textContent = label || value || '‚Äî';
                    option.addEventListener('click', () => {
                        if (!currentTaskModalSelect) return;
                        const btn = currentTaskModalSelect;
                        const select = btn.parentElement.querySelector('select');
                        const labelSpan = btn.querySelector('.modal-select-label');
                        
                        if (select && labelSpan) {
                            select.value = value;
                            labelSpan.textContent = label;
                            btn.setAttribute('aria-expanded', 'false');
                            
                            // –¢—Ä–∏–≥–≥–µ—Ä–∏–º change —Å–æ–±—ã—Ç–∏–µ
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        closeTaskModalDropdown();
                    });
                    taskModalDropdown.appendChild(option);
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è dropdown –¥–ª—è –∑–∞–¥–∞—á
            function positionTaskModalDropdown(btn) {
                if (!btn || !taskModalDropdown) return;
                const rect = btn.getBoundingClientRect();
                const dropdownHeight = taskModalDropdown.offsetHeight || 200;
                const viewportHeight = window.innerHeight;
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
                
                taskModalDropdown.style.position = 'fixed';
                if (openUpward) {
                    taskModalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    taskModalDropdown.style.top = 'auto';
                } else {
                    taskModalDropdown.style.top = `${rect.bottom + 6}px`;
                    taskModalDropdown.style.bottom = 'auto';
                }
                taskModalDropdown.style.left = `${rect.left}px`;
                taskModalDropdown.style.width = `${rect.width}px`;
                taskModalDropdown.style.minWidth = `${rect.width}px`;
                taskModalDropdown.style.maxWidth = `${rect.width}px`;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è dropdown –¥–ª—è –∑–∞–¥–∞—á
            function openTaskModalDropdown(btn) {
                if (!btn || btn.disabled) return;
                const field = btn.dataset.field;
                if (!field) return;
                
                let options = {};
                
                if (field === 'facility_id') {
                    options = taskModalSelectData.facility;
                } else if (field === 'department_id') {
                    const facilityId = taskFacilitySelect?.value;
                    if (facilityId) {
                        const departments = {{ department_choices | tojson }};
                        const facilityDepartments = departments.filter(d => d.facility_id == facilityId);
                        facilityDepartments.forEach(dept => {
                            options[dept.id] = dept.name;
                        });
                    }
                } else if (field === 'equipment_assignment_id') {
                    // –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API
                    return;
                }
                
                if (Object.keys(options).length === 0) {
                    return;
                }
                
                currentTaskModalSelect = btn;
                populateTaskModalDropdown(field, options);
                
                requestAnimationFrame(() => {
                    positionTaskModalDropdown(btn);
                    taskModalDropdown.classList.add('visible');
                    btn.setAttribute('aria-expanded', 'true');
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã—Ç—å dropdown —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
                    taskDropdownJustOpened = true;
                    setTimeout(() => {
                        taskDropdownJustOpened = false;
                    }, 100);
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è dropdown –¥–ª—è –∑–∞–¥–∞—á
            function closeTaskModalDropdown() {
                if (!taskModalDropdown) return;
                taskModalDropdown.classList.remove('visible');
                if (currentTaskModalSelect) {
                    currentTaskModalSelect.setAttribute('aria-expanded', 'false');
                    currentTaskModalSelect = null;
                }
                taskDropdownJustOpened = false;
            }
            
            // –ö–∞—Å–∫–∞–¥–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞: –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ -> –û—Ç–¥–µ–ª -> –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            const taskFacilitySelect = document.getElementById('taskFacilitySelect');
            const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
            const taskEquipmentSelect = document.getElementById('taskEquipmentSelect');
            const modalTaskFacilityBtn = document.getElementById('modalTaskFacilityBtn');
            const modalTaskDepartmentBtn = document.getElementById('modalTaskDepartmentBtn');
            const modalTaskEquipmentBtn = document.getElementById('modalTaskEquipmentBtn');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –∑–∞–¥–∞—á
            [modalTaskFacilityBtn, modalTaskDepartmentBtn].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (btn.disabled) return;
                        
                        if (currentTaskModalSelect === btn && taskModalDropdown.classList.contains('visible')) {
                            closeTaskModalDropdown();
                        } else {
                            closeTaskModalDropdown();
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ document –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª —Ä–∞–Ω—å—à–µ
                            setTimeout(() => {
                                openTaskModalDropdown(btn);
                            }, 0);
                        }
                    });
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π select, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ API)
            if (modalTaskEquipmentBtn) {
                modalTaskEquipmentBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (modalTaskEquipmentBtn.disabled) return;
                    
                    const select = modalTaskEquipmentBtn.parentElement.querySelector('select');
                    if (!select || select.disabled) return;
                    
                    setTimeout(() => {
                        select.focus();
                        select.click();
                    }, 10);
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            document.addEventListener('click', (e) => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏, –µ—Å–ª–∏ dropdown —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫—Ä—ã–ª—Å—è
                if (taskDropdownJustOpened) {
                    return;
                }
                
                if (taskModalDropdown && taskModalDropdown.classList.contains('visible')) {
                    if (!taskModalDropdown.contains(e.target) && 
                        !e.target.closest('.modal-select-btn[data-field="facility_id"]') &&
                        !e.target.closest('.modal-select-btn[data-field="department_id"]')) {
                        closeTaskModalDropdown();
                    }
                }
            }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
            if (taskFacilitySelect) {
                taskFacilitySelect.addEventListener('change', async () => {
                    const facilityId = taskFacilitySelect.value;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è dropdown –æ—Ç–¥–µ–ª–æ–≤
                    const departments = {{ department_choices | tojson }};
                    const facilityDepartments = departments.filter(d => d.facility_id == facilityId);
                    taskModalSelectData.department = {};
                    facilityDepartments.forEach(dept => {
                        taskModalSelectData.department[dept.id] = dept.name;
                    });
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    taskDepartmentSelect.value = '';
                    taskDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                    taskDepartmentSelect.disabled = true;
                    if (modalTaskDepartmentBtn) {
                        modalTaskDepartmentBtn.disabled = true;
                        const label = modalTaskDepartmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                    
                    taskEquipmentSelect.value = '';
                    taskEquipmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                    taskEquipmentSelect.disabled = true;
                    if (modalTaskEquipmentBtn) {
                        modalTaskEquipmentBtn.disabled = true;
                        const label = modalTaskEquipmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                    
                    if (!facilityId) return;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º select –¥–ª—è —Ñ–æ—Ä–º—ã
                    taskDepartmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                    facilityDepartments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        option.dataset.facilityId = dept.facility_id;
                        taskDepartmentSelect.appendChild(option);
                    });
                    
                    taskDepartmentSelect.disabled = false;
                    if (modalTaskDepartmentBtn) {
                        modalTaskDepartmentBtn.disabled = false;
                    }
                });
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—Ç–¥–µ–ª–∞
            if (taskDepartmentSelect) {
                taskDepartmentSelect.addEventListener('change', async () => {
                    const departmentId = taskDepartmentSelect.value;
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    taskEquipmentSelect.value = '';
                    taskEquipmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                    taskEquipmentSelect.disabled = true;
                    if (modalTaskEquipmentBtn) {
                        modalTaskEquipmentBtn.disabled = true;
                        const label = modalTaskEquipmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                    
                    if (!departmentId) return;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞
                    try {
                        const response = await fetch(`{{ url_for("admin_tasks.get_equipment_by_department", department_id=0) }}`.replace('0', departmentId));
                        const result = await response.json();
                        
                        if (result.success && result.equipment) {
                            taskEquipmentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>';
                            result.equipment.forEach(eq => {
                                const option = document.createElement('option');
                                option.value = eq.equipment_assignment_id;
                                option.textContent = `${eq.equipment_name}${eq.equipment_type ? ' (' + eq.equipment_type + ')' : ''}${eq.location ? ' - ' + eq.location : ''}`;
                                taskEquipmentSelect.appendChild(option);
                            });
                            
                            taskEquipmentSelect.disabled = false;
                            taskEquipmentSelect.style.pointerEvents = 'auto';
                            taskEquipmentSelect.style.cursor = 'pointer';
                            if (modalTaskEquipmentBtn) {
                                modalTaskEquipmentBtn.disabled = false;
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
                    }
                });
            }
            
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ select
            if (taskFacilitySelect && modalTaskFacilityBtn) {
                taskFacilitySelect.addEventListener('change', () => {
                    const selectedOption = taskFacilitySelect.options[taskFacilitySelect.selectedIndex];
                    const label = modalTaskFacilityBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                    modalTaskFacilityBtn.setAttribute('aria-expanded', 'false');
                });
            }
            
            if (taskDepartmentSelect && modalTaskDepartmentBtn) {
                taskDepartmentSelect.addEventListener('change', () => {
                    const selectedOption = taskDepartmentSelect.options[taskDepartmentSelect.selectedIndex];
                    const label = modalTaskDepartmentBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                    modalTaskDepartmentBtn.setAttribute('aria-expanded', 'false');
                });
            }
            
            if (taskEquipmentSelect && modalTaskEquipmentBtn) {
                taskEquipmentSelect.addEventListener('change', () => {
                    const selectedOption = taskEquipmentSelect.options[taskEquipmentSelect.selectedIndex];
                    const label = modalTaskEquipmentBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                    modalTaskEquipmentBtn.setAttribute('aria-expanded', 'false');
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
            // (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö)

            // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –∑–∞–¥–∞—á—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
            const tasksTableForEvents = document.getElementById('tasksTable');
            const taskRowsForEvents = tasksTableForEvents ? Array.from(tasksTableForEvents.querySelectorAll('tbody tr.task-row')) : [];
            taskRowsForEvents.forEach(row => {
                row.addEventListener('dblclick', async () => {
                    const taskId = row.dataset.taskId;
                    if (!taskId) return;

                    try {
                        const response = await fetch(`{{ url_for("admin_tasks.get_task", task_id=0) }}`.replace('0', taskId));
                        const result = await response.json();

                        if (result.success && result.task) {
                            const task = result.task;
                            currentTaskId = task.id;

                            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:', task);

                            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (—Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞)
                            const taskDetailsHeading = document.getElementById('taskDetailsHeading');
                            const taskDetailsDescription = document.getElementById('taskDetailsDescription');
                            const taskDetailsFacility = document.getElementById('taskDetailsFacility');
                            const taskDetailsDepartment = document.getElementById('taskDetailsDepartment');
                            const taskDetailsEquipment = document.getElementById('taskDetailsEquipment');
                            const taskDetailsCreationDate = document.getElementById('taskDetailsCreationDate');
                            const taskDetailsEndDate = document.getElementById('taskDetailsEndDate');

                            if (taskDetailsHeading) taskDetailsHeading.textContent = task.heading || '‚Äî';
                            if (taskDetailsDescription) taskDetailsDescription.textContent = task.description || '‚Äî';
                            if (taskDetailsFacility) taskDetailsFacility.textContent = task.facility_name || '‚Äî';
                            if (taskDetailsDepartment) taskDetailsDepartment.textContent = task.department_name || '‚Äî';
                            if (taskDetailsEquipment) taskDetailsEquipment.textContent = task.equipment_name || '‚Äî';
                            if (taskDetailsCreationDate) taskDetailsCreationDate.textContent = task.creation_date || '‚Äî';
                            if (taskDetailsEndDate) taskDetailsEndDate.textContent = task.end_date || '‚Äî';

                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                            await loadTaskEmployees(task.id, task.facility_id);

                            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            if (taskDetailsModal) {
                                taskDetailsModal.classList.add('visible');
                                document.body.classList.add('modal-open');
                                setTimeout(() => {
                                    taskDetailsModal.setAttribute('aria-hidden', 'false');
                                }, 0);
                            }
                        } else {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏:', result);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏:', error);
                    }
                });
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏
            [taskDetailsModalClose, taskDetailsModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (taskDetailsModal) {
                            taskDetailsModal.classList.remove('visible');
                            taskDetailsModal.setAttribute('aria-hidden', 'true');
                            document.body.classList.remove('modal-open');
                        }
                        currentTaskId = null;
                    });
                }
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            if (taskStatusToggle) {
                taskStatusToggle.addEventListener('change', async () => {
                    if (!currentTaskId) return;

                    const newStatus = taskStatusToggle.checked ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                    
                    try {
                        const response = await fetch(`{{ url_for("admin_tasks.update_task_status", task_id=0) }}`.replace('0', currentTaskId), {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: newStatus })
                        });

                        const result = await response.json();

                        if (result.success) {
                            if (taskStatusLabel) {
                                taskStatusLabel.textContent = newStatus;
                            }
                            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ó–∞–≤–µ—Ä—à–µ–Ω–æ", –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∑–∞–¥–∞—á—É –∏–∑ —Å–ø–∏—Å–∫–∞
                            if (newStatus === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') {
                                setTimeout(() => {
                                    location.reload();
                                }, 500);
                            }
                        } else {
                            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
                            taskStatusToggle.checked = !taskStatusToggle.checked;
                            if (taskStatusLabel) {
                                taskStatusLabel.textContent = taskStatusToggle.checked ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                            }
                            alert(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                        taskStatusToggle.checked = !taskStatusToggle.checked;
                        if (taskStatusLabel) {
                            taskStatusLabel.textContent = taskStatusToggle.checked ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                        }
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                    }
                });
            }

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
            function closeCreateTaskModal() {
                if (!createTaskModal) return;
                
                // –û—á–∏—â–∞–µ–º dataset –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                delete createTaskModal.dataset.equipmentAssignmentId;
                delete createTaskModal.dataset.equipmentId;
                delete createTaskModal.dataset.departmentId;
                delete createTaskModal.dataset.facilityId;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                const taskDepartmentDisplay = document.getElementById('taskDepartmentDisplay');
                const taskDepartmentSelectWrapper = document.getElementById('taskDepartmentSelectWrapper');
                const taskFacilityDisplay = document.getElementById('taskFacilityDisplay');
                const taskFacilitySelectWrapper = document.getElementById('taskFacilitySelectWrapper');
                if (taskDepartmentDisplay) {
                    taskDepartmentDisplay.style.display = 'none';
                }
                
                if (taskDepartmentSelectWrapper) {
                    taskDepartmentSelectWrapper.style.display = 'block';
                }
                
                if (taskFacilityDisplay) {
                    taskFacilityDisplay.style.display = 'none';
                }
                
                if (taskFacilitySelectWrapper) {
                    taskFacilitySelectWrapper.style.display = 'block';
                }
                
                if (taskEquipmentDisplayReadonly) {
                    taskEquipmentDisplayReadonly.style.display = 'none';
                }
                
                const taskEquipmentDisplay = document.getElementById('taskEquipmentDisplay');
                const taskEquipmentSelectWrapper = document.getElementById('taskEquipmentSelectWrapper');
                
                if (taskEquipmentDisplay) {
                    taskEquipmentDisplay.style.display = 'none';
                }
                
                if (taskEquipmentSelectWrapper) {
                    taskEquipmentSelectWrapper.style.display = 'block';
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                const taskFacilitySelect = document.getElementById('taskFacilitySelect');
                const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
                const taskEquipmentSelect = document.getElementById('taskEquipmentSelect');
                
                if (taskFacilitySelect) {
                    taskFacilitySelect.value = '';
                    const modalTaskFacilityBtn = document.getElementById('modalTaskFacilityBtn');
                    if (modalTaskFacilityBtn) {
                        const label = modalTaskFacilityBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                
                if (taskDepartmentSelect) {
                    taskDepartmentSelect.value = '';
                    taskDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                    taskDepartmentSelect.disabled = true;
                    const modalTaskDepartmentBtn = document.getElementById('modalTaskDepartmentBtn');
                    if (modalTaskDepartmentBtn) {
                        modalTaskDepartmentBtn.disabled = true;
                        const label = modalTaskDepartmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                
                if (taskEquipmentSelect) {
                    taskEquipmentSelect.value = '';
                    taskEquipmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                    taskEquipmentSelect.disabled = true;
                    const modalTaskEquipmentBtn = document.getElementById('modalTaskEquipmentBtn');
                    if (modalTaskEquipmentBtn) {
                        modalTaskEquipmentBtn.disabled = true;
                        const label = modalTaskEquipmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                }
                
                // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π aria-hidden
                const activeElement = document.activeElement;
                if (activeElement && createTaskModal.contains(activeElement)) {
                    activeElement.blur();
                }
                
                createTaskModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                setTimeout(() => {
                    createTaskModal.setAttribute('aria-hidden', 'true');
                }, 0);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ 
            // –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –æ–±—â–∏–π —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –≤—Å–µ—Ö —Å–µ–∫—Ü–∏—è—Ö

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (taskDetailsModal) {
                taskDetailsModal.addEventListener('click', (e) => {
                    if (e.target === taskDetailsModal) {
                        // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π aria-hidden
                        const activeElement = document.activeElement;
                        if (activeElement && taskDetailsModal.contains(activeElement)) {
                            activeElement.blur();
                        }
                        
                        taskDetailsModal.classList.remove('visible');
                        document.body.classList.remove('modal-open');
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                        setTimeout(() => {
                            taskDetailsModal.setAttribute('aria-hidden', 'true');
                        }, 0);
                        
                        currentTaskId = null;
                    }
                });
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á
            const tasksSearch = document.getElementById('tasksSearch');
            const tasksStatusFilter = document.getElementById('tasksStatusFilter');
            const tasksFilterBtn = document.getElementById('tasksFilterBtn');
            const tasksFilterDropdown = document.getElementById('tasksFilterDropdown');
            const tasksResetFilters = document.getElementById('tasksResetFilters');
            const tasksTable = document.getElementById('tasksTable');
            const taskRows = tasksTable ? Array.from(tasksTable.querySelectorAll('tbody tr.task-row')) : [];

            function applyTasksFilters() {
                const searchValue = tasksSearch ? tasksSearch.value.toLowerCase().trim() : '';
                const statusValue = tasksStatusFilter ? tasksStatusFilter.value : '';

                taskRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const rowStatus = row.dataset.status || '';

                    const matchesSearch = searchValue === '' || text.includes(searchValue);
                    const matchesStatus = statusValue === '' || rowStatus === statusValue;

                    row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                let visibleIndex = 0;
                taskRows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const numberCell = row.querySelector('.number-column');
                        if (numberCell) {
                            numberCell.textContent = visibleIndex + 1;
                        }
                        visibleIndex++;
                    }
                });
            }

            // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
            window.applyTasksFilters = applyTasksFilters;

            if (tasksSearch) {
                tasksSearch.addEventListener('input', applyTasksFilters);
            }

            if (tasksStatusFilter) {
                tasksStatusFilter.addEventListener('change', () => {
                    applyTasksFilters();
                    // –û–±–Ω–æ–≤–ª—è–µ–º URL –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
                    const url = new URL(window.location);
                    if (tasksStatusFilter.value === 'completed') {
                        url.searchParams.set('include_completed', 'true');
                    } else {
                        url.searchParams.delete('include_completed');
                    }
                    window.history.pushState({}, '', url);
                });
            }

            if (tasksFilterBtn && tasksFilterDropdown) {
                tasksFilterBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    tasksFilterDropdown.classList.toggle('active');
                    tasksFilterBtn.classList.toggle('active');
                });

                document.addEventListener('click', (e) => {
                    if (!tasksFilterDropdown.contains(e.target) && !tasksFilterBtn.contains(e.target)) {
                        tasksFilterDropdown.classList.remove('active');
                        tasksFilterBtn.classList.remove('active');
                    }
                });
            }

            if (tasksResetFilters) {
                tasksResetFilters.addEventListener('click', () => {
                    if (tasksSearch) tasksSearch.value = '';
                    if (tasksStatusFilter) tasksStatusFilter.value = '';
                    applyTasksFilters();
                    const url = new URL(window.location);
                    url.searchParams.delete('include_completed');
                    window.history.pushState({}, '', url);
                });
            }

            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –∑–∞–¥–∞—á
            let selectedTaskRow = null;
            let taskContextMenu = null;

            function createTaskContextMenu() {
                if (taskContextMenu) return taskContextMenu;
                
                taskContextMenu = document.createElement('div');
                taskContextMenu.className = 'context-menu';
                taskContextMenu.innerHTML = `
                    <button type="button" class="context-menu-item" id="taskViewBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                    <button type="button" class="context-menu-item" id="taskAssignEmployeesBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    </button>
                    <button type="button" class="context-menu-item" id="taskCompleteBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                    <button type="button" class="context-menu-item" id="taskReportBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        –°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç
                    </button>
                    <button type="button" class="context-menu-item danger" id="taskDeleteBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                `;
                document.body.appendChild(taskContextMenu);
                
                const viewBtn = document.getElementById('taskViewBtn');
                const assignEmployeesBtn = document.getElementById('taskAssignEmployeesBtn');
                const completeBtn = document.getElementById('taskCompleteBtn');
                const reportBtn = document.getElementById('taskReportBtn');
                const deleteBtn = document.getElementById('taskDeleteBtn');
                
                if (viewBtn) {
                    viewBtn.addEventListener('click', () => {
                        if (selectedTaskRow) {
                            selectedTaskRow.dispatchEvent(new Event('dblclick'));
                        }
                        hideTaskContextMenu();
                    });
                }
                
                if (assignEmployeesBtn) {
                    assignEmployeesBtn.addEventListener('click', async () => {
                        if (selectedTaskRow) {
                            const taskId = selectedTaskRow.dataset.taskId;
                            const facilityId = selectedTaskRow.dataset.facilityId;
                            if (taskId && facilityId) {
                                if (window.openAssignEmployeesModal) {
                                    await window.openAssignEmployeesModal(taskId, facilityId);
                                } else {
                                    console.error('openAssignEmployeesModal –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞');
                                    alert('–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                                }
                            } else {
                                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏–ª–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ');
                            }
                        }
                        hideTaskContextMenu();
                    });
                }
                
                if (completeBtn) {
                    completeBtn.addEventListener('click', async () => {
                        if (selectedTaskRow) {
                            const taskId = selectedTaskRow.dataset.taskId;
                            if (taskId) {
                                if (window.openCompleteTaskModal) {
                                    await window.openCompleteTaskModal(taskId);
                                } else {
                                    console.error('openCompleteTaskModal –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞');
                                    alert('–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                                }
                            } else {
                                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–¥–∞—á—É');
                            }
                        }
                        hideTaskContextMenu();
                    });
                }
                
                if (reportBtn) {
                    reportBtn.addEventListener('click', () => {
                        if (selectedTaskRow) {
                            const taskId = selectedTaskRow.dataset.taskId;
                            if (taskId) {
                                window.location.href = `/admin/tasks/${taskId}/report`;
                            }
                        }
                        hideTaskContextMenu();
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (selectedTaskRow) {
                            const taskId = selectedTaskRow.dataset.taskId;
                            if (taskId) {
                                openDeleteTaskModal(taskId, selectedTaskRow);
                            }
                        }
                        hideTaskContextMenu();
                    });
                }
                
                return taskContextMenu;
            }

            function showTaskContextMenu(event, row) {
                event.preventDefault();
                event.stopPropagation();
                
                const menu = createTaskContextMenu();
                selectedTaskRow = row;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç" —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                const reportBtn = document.getElementById('taskReportBtn');
                if (reportBtn) {
                    const statusText = row.querySelector('.status-badge')?.textContent || '';
                    const isCompleted = row.dataset.status === 'completed' || 
                                       statusText.includes('–ó–∞–≤–µ—Ä—à–µ–Ω–æ') || 
                                       statusText.includes('–ó–∞–≤–µ—Ä—à–µ–Ω–∞');
                    reportBtn.style.display = isCompleted ? 'block' : 'none';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤" —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–¥–∞—á —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–û–∂–∏–¥–∞—é—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
                const assignEmployeesBtn = document.getElementById('taskAssignEmployeesBtn');
                if (assignEmployeesBtn) {
                    const statusText = row.querySelector('.status-badge')?.textContent || '';
                    assignEmployeesBtn.style.display = statusText.includes('–û–∂–∏–¥–∞—é—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è') ? 'block' : 'none';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É" —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–¥–∞—á —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–í –ø—Ä–æ—Ü–µ—Å—Å–µ"
                const completeBtn = document.getElementById('taskCompleteBtn');
                if (completeBtn) {
                    const statusText = row.querySelector('.status-badge')?.textContent || '';
                    completeBtn.style.display = statusText.includes('–í –ø—Ä–æ—Ü–µ—Å—Å–µ') ? 'block' : 'none';
                }
                
                const tableContainer = document.querySelector('.table-container');
                if (!tableContainer) return;
                
                menu.style.display = 'block';
                menu.style.visibility = 'hidden';
                menu.style.left = '0px';
                menu.style.top = '0px';
                
                const containerRect = tableContainer.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();
                
                let left = event.clientX;
                let top = event.clientY;
                
                if (left + menuRect.width > containerRect.right) {
                    left = containerRect.right - menuRect.width - 10;
                }
                if (left < containerRect.left) {
                    left = containerRect.left + 10;
                }
                if (top + menuRect.height > containerRect.bottom) {
                    top = containerRect.bottom - menuRect.height - 10;
                }
                if (top < containerRect.top) {
                    top = containerRect.top + 10;
                }
                
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                menu.style.visibility = 'visible';
            }

            function hideTaskContextMenu() {
                if (taskContextMenu) {
                    taskContextMenu.style.display = 'none';
                }
                selectedTaskRow = null;
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –∑–∞–¥–∞—á
            if (tasksTable) {
                const tbody = tasksTable.querySelector('tbody');
                if (tbody) {
                    tbody.addEventListener('contextmenu', (e) => {
                        const row = e.target.closest('tr.task-row');
                        if (row) {
                            e.preventDefault();
                            showTaskContextMenu(e, row);
                        }
                    });
                }
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –∑–∞–¥–∞—á –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            document.addEventListener('click', (e) => {
                if (taskContextMenu && !taskContextMenu.contains(e.target) && !e.target.closest('tr.task-row')) {
                    hideTaskContextMenu();
                }
            });
        })();
    </script>
    {% endif %}

    <!-- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö) -->
    <script>
        (function() {
            const createTaskModal = document.getElementById('createTaskModal');
            const createTaskModalClose = document.getElementById('createTaskModalClose');
            const createTaskModalCancel = document.getElementById('createTaskModalCancel');

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
            function closeCreateTaskModal() {
                if (!createTaskModal) return;
                
                // –û—á–∏—â–∞–µ–º dataset –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                delete createTaskModal.dataset.equipmentAssignmentId;
                delete createTaskModal.dataset.equipmentId;
                delete createTaskModal.dataset.departmentId;
                delete createTaskModal.dataset.facilityId;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                const taskDepartmentDisplay = document.getElementById('taskDepartmentDisplay');
                const taskDepartmentSelectWrapper = document.getElementById('taskDepartmentSelectWrapper');
                const taskFacilityDisplay = document.getElementById('taskFacilityDisplay');
                const taskFacilitySelectWrapper = document.getElementById('taskFacilitySelectWrapper');
                if (taskDepartmentDisplay) {
                    taskDepartmentDisplay.style.display = 'none';
                }
                
                if (taskDepartmentSelectWrapper) {
                    taskDepartmentSelectWrapper.style.display = 'block';
                }
                
                if (taskFacilityDisplay) {
                    taskFacilityDisplay.style.display = 'none';
                }
                
                if (taskFacilitySelectWrapper) {
                    taskFacilitySelectWrapper.style.display = 'block';
                }
                
                if (taskEquipmentDisplayReadonly) {
                    taskEquipmentDisplayReadonly.style.display = 'none';
                }
                
                const taskEquipmentDisplay = document.getElementById('taskEquipmentDisplay');
                const taskEquipmentSelectWrapper = document.getElementById('taskEquipmentSelectWrapper');
                
                if (taskEquipmentDisplay) {
                    taskEquipmentDisplay.style.display = 'none';
                }
                
                if (taskEquipmentSelectWrapper) {
                    taskEquipmentSelectWrapper.style.display = 'block';
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                const taskFacilitySelect = document.getElementById('taskFacilitySelect');
                const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
                const taskEquipmentSelect = document.getElementById('taskEquipmentSelect');
                
                if (taskFacilitySelect) {
                    taskFacilitySelect.value = '';
                    const modalTaskFacilityBtn = document.getElementById('modalTaskFacilityBtn');
                    if (modalTaskFacilityBtn) {
                        const label = modalTaskFacilityBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                
                if (taskDepartmentSelect) {
                    taskDepartmentSelect.value = '';
                    taskDepartmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option>';
                    taskDepartmentSelect.disabled = true;
                    const modalTaskDepartmentBtn = document.getElementById('modalTaskDepartmentBtn');
                    if (modalTaskDepartmentBtn) {
                        modalTaskDepartmentBtn.disabled = true;
                        const label = modalTaskDepartmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                    }
                }
                
                if (taskEquipmentSelect) {
                    taskEquipmentSelect.value = '';
                    taskEquipmentSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
                    taskEquipmentSelect.disabled = true;
                    const modalTaskEquipmentBtn = document.getElementById('modalTaskEquipmentBtn');
                    if (modalTaskEquipmentBtn) {
                        modalTaskEquipmentBtn.disabled = true;
                        const label = modalTaskEquipmentBtn.querySelector('.modal-select-label');
                        if (label) label.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                    }
                }
                
                // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π aria-hidden
                const activeElement = document.activeElement;
                if (activeElement && createTaskModal.contains(activeElement)) {
                    activeElement.blur();
                }
                
                createTaskModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aria-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                setTimeout(() => {
                    createTaskModal.setAttribute('aria-hidden', 'true');
                }, 0);
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É –∏ –∫–Ω–æ–ø–∫–µ "–û—Ç–º–µ–Ω–∞"
            [createTaskModalClose, createTaskModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        closeCreateTaskModal();
                    });
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (createTaskModal) {
                createTaskModal.addEventListener('click', (e) => {
                    if (e.target === createTaskModal) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeCreateTaskModal();
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö)
            const createTaskForm = document.getElementById('createTaskForm');
            const createTaskFormError = document.getElementById('createTaskFormError');
            const taskFacilitySelect = document.getElementById('taskFacilitySelect');
            const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
            const taskEquipmentSelect = document.getElementById('taskEquipmentSelect');
            
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ submit —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', {
                createTaskForm: !!createTaskForm,
                createTaskFormError: !!createTaskFormError,
                createTaskModal: !!createTaskModal
            });
            
            if (createTaskForm) {
                console.log('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ submit –¥–ª—è createTaskForm');
                createTaskForm.addEventListener('submit', async (e) => {
                    console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ submit –≤—ã–∑–≤–∞–Ω!');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (createTaskFormError) {
                        createTaskFormError.textContent = '';
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ equipment_assignment_id –≤ dataset –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é)
                    const equipmentAssignmentIdFromContext = createTaskModal?.dataset.equipmentAssignmentId;
                    const departmentIdFromContext = createTaskModal?.dataset.departmentId;
                    
                    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é:', {
                        equipmentAssignmentIdFromContext,
                        departmentIdFromContext,
                        createTaskModal: !!createTaskModal
                    });
                    
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                    // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ dataset
                    if (equipmentAssignmentIdFromContext && equipmentAssignmentIdFromContext.trim() !== '') {
                        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é - –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ dataset
                        console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é, –∏—Å–ø–æ–ª—å–∑—É–µ–º equipmentAssignmentIdFromContext:', equipmentAssignmentIdFromContext);
                    } else {
                        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–¥–∞—á - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø–æ–ª—è
                        const facilityId = taskFacilitySelect?.value;
                        const departmentId = taskDepartmentSelect?.value;
                        const equipmentAssignmentId = taskEquipmentSelect?.value;
                        
                        if (!facilityId) {
                            if (createTaskFormError) {
                                createTaskFormError.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                            }
                            return;
                        }
                        
                        if (!departmentId) {
                            if (createTaskFormError) {
                                createTaskFormError.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª';
                            }
                            return;
                        }
                        
                        if (!equipmentAssignmentId) {
                            if (createTaskFormError) {
                                createTaskFormError.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
                            }
                            return;
                        }
                    }
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π equipment_assignment_id
                    let finalEquipmentAssignmentId;
                    if (equipmentAssignmentIdFromContext && equipmentAssignmentIdFromContext.trim() !== '') {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                        finalEquipmentAssignmentId = equipmentAssignmentIdFromContext;
                        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º equipment_assignment_id –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é:', finalEquipmentAssignmentId);
                    } else {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã (—Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–¥–∞—á)
                        finalEquipmentAssignmentId = taskEquipmentSelect?.value;
                        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º equipment_assignment_id –∏–∑ —Ñ–æ—Ä–º—ã:', finalEquipmentAssignmentId);
                    }
                    
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:', {
                        equipmentAssignmentIdFromContext,
                        taskEquipmentSelectValue: taskEquipmentSelect?.value,
                        finalEquipmentAssignmentId,
                        departmentIdFromContext,
                        hasEquipmentAssignmentIdFromContext: !!(equipmentAssignmentIdFromContext && equipmentAssignmentIdFromContext.trim() !== '')
                    });
                    
                    if (!finalEquipmentAssignmentId || finalEquipmentAssignmentId === '' || finalEquipmentAssignmentId === 'undefined') {
                        console.error('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, finalEquipmentAssignmentId:', finalEquipmentAssignmentId);
                        if (createTaskFormError) {
                            createTaskFormError.textContent = '–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
                        }
                        return;
                    }
                    
                    const formData = new FormData(createTaskForm);
                    
                    const heading = formData.get('heading')?.trim();
                    const description = formData.get('repair_task_description')?.trim();
                    
                    console.log('–î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', { heading, description });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                    if (!heading) {
                        console.error('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ç–µ–º–∞');
                        if (createTaskFormError) {
                            createTaskFormError.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∑–∞–¥–∞—á–∏';
                        }
                        return;
                    }
                    
                    if (!description) {
                        console.error('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ');
                        if (createTaskFormError) {
                            createTaskFormError.textContent = '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã';
                        }
                        return;
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º equipment_assignment_id –≤ —á–∏—Å–ª–æ
                    const equipmentAssignmentIdNum = parseInt(finalEquipmentAssignmentId, 10);
                    if (isNaN(equipmentAssignmentIdNum)) {
                        console.error('–û—à–∏–±–∫–∞: equipment_assignment_id –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º:', finalEquipmentAssignmentId);
                        if (createTaskFormError) {
                            createTaskFormError.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
                        }
                        return;
                    }
                    
                    const data = {
                        equipment_assignment_id: equipmentAssignmentIdNum,
                        heading: heading,
                        repair_task_description: description
                    };
                    
                    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', data);

                    try {
                        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...');
                        const url = '{{ url_for("admin_tasks.create_task") }}';
                        console.log('URL:', url);
                        console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (JSON):', JSON.stringify(data));
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω:', {
                            status: response.status,
                            statusText: response.statusText,
                            ok: response.ok
                        });
                        
                        const result = await response.json();
                        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);

                        if (result.success) {
                            console.log('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞:', result.task);
                            // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–¥–∞—á
                            const equipmentAssignmentIdFromContext = createTaskModal?.dataset.equipmentAssignmentId;
                            if (equipmentAssignmentIdFromContext) {
                                console.log('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–¥–∞—á...');
                                window.location.href = '{{ url_for("admin_tasks.list_tasks") }}';
                            } else {
                                // –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–¥–∞—á, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                console.log('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
                                location.reload();
                            }
                        } else {
                            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', result.message);
                            if (createTaskFormError) {
                                createTaskFormError.textContent = result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏';
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
                        if (createTaskFormError) {
                            createTaskFormError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                        }
                    }
                });
            }

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            const assignEmployeesBtn = document.getElementById('assignEmployeesBtn');
            const assignEmployeesModal = document.getElementById('assignEmployeesModal');
            const assignEmployeesModalClose = document.getElementById('assignEmployeesModalClose');
            const assignEmployeesModalCancel = document.getElementById('assignEmployeesModalCancel');
            const assignEmployeesSaveBtn = document.getElementById('assignEmployeesSaveBtn');
            const assignEmployeesList = document.getElementById('assignEmployeesList');
            const assignEmployeesFormError = document.getElementById('assignEmployeesFormError');
            let selectedEmployeeIds = new Set();
            let currentFacilityId = null;

            // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            async function loadTaskEmployees(taskId, facilityId) {
                const taskAssignedEmployees = document.getElementById('taskAssignedEmployees');
                if (!taskAssignedEmployees) return;

                try {
                    const response = await fetch(`{{ url_for("admin_tasks.get_task_employees", task_id=0) }}`.replace('0', taskId));
                    const result = await response.json();

                    if (result.success) {
                        const employees = result.employees || [];
                        if (employees.length === 0) {
                            taskAssignedEmployees.innerHTML = '<div style="color: var(--text-medium); font-size: 14px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>';
                        } else {
                            taskAssignedEmployees.innerHTML = employees.map(emp => `
                                <div style="padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--radius-sm); margin-bottom: var(--spacing-xs);">
                                    <div style="font-weight: 500;">${escapeHtml(emp.full_name || `${emp.last_name || ''} ${emp.first_name || ''} ${emp.patronymic || ''}`.trim())}</div>
                                    ${emp.post ? `<div style="font-size: 13px; color: var(--text-medium);">${escapeHtml(emp.post)}</div>` : ''}
                                </div>
                            `).join('');
                        }
                    }
                    currentFacilityId = facilityId;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                    taskAssignedEmployees.innerHTML = '<div style="color: var(--text-medium); font-size: 14px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            }

            // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            if (assignEmployeesBtn) {
                assignEmployeesBtn.addEventListener('click', async () => {
                    if (!currentTaskId || !currentFacilityId) {
                        if (assignEmployeesFormError) {
                            assignEmployeesFormError.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–¥–∞—á–∞ –∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ';
                        }
                        return;
                    }

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    try {
                        const response = await fetch(`{{ url_for("admin_tasks.get_employees_by_facility", facility_id=0) }}`.replace('0', currentFacilityId));
                        const result = await response.json();

                        if (result.success) {
                            const employees = result.employees || [];
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                            const assignedResponse = await fetch(`{{ url_for("admin_tasks.get_task_employees", task_id=0) }}`.replace('0', currentTaskId));
                            const assignedResult = await assignedResponse.json();
                            const assignedIds = new Set((assignedResult.employees || []).map(e => e.id));
                            selectedEmployeeIds = new Set(assignedIds);

                            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                            if (assignEmployeesList) {
                                if (employees.length === 0) {
                                    assignEmployeesList.innerHTML = '<div style="color: var(--text-medium); font-size: 14px; text-align: center; padding: 20px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>';
                                } else {
                                    assignEmployeesList.innerHTML = employees.map(emp => {
                                        const isSelected = selectedEmployeeIds.has(emp.id);
                                        return `
                                            <label style="display: flex; align-items: center; padding: var(--spacing-sm); border-radius: var(--radius-sm); cursor: pointer; transition: background-color 0.2s; ${isSelected ? 'background: var(--color-primary-light);' : ''}" onmouseover="this.style.background='var(--color-primary-light)'" onmouseout="this.style.background=${isSelected ? "'var(--color-primary-light)'" : "'transparent'"}">
                                                <input type="checkbox" value="${emp.id}" ${isSelected ? 'checked' : ''} style="margin-right: var(--spacing-sm);" onchange="toggleEmployeeSelection(${emp.id}, this.checked)">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 500;">${escapeHtml(emp.full_name || `${emp.last_name || ''} ${emp.first_name || ''} ${emp.patronymic || ''}`.trim())}</div>
                                                    ${emp.post ? `<div style="font-size: 13px; color: var(--text-medium);">${escapeHtml(emp.post)}</div>` : ''}
                                                </div>
                                            </label>
                                        `;
                                    }).join('');
                                }
                            }

                            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            if (assignEmployeesModal) {
                                assignEmployeesModal.classList.add('visible');
                                document.body.classList.add('modal-open');
                                setTimeout(() => {
                                    assignEmployeesModal.setAttribute('aria-hidden', 'false');
                                }, 0);
                            }
                        } else {
                            if (assignEmployeesFormError) {
                                assignEmployeesFormError.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                        if (assignEmployeesFormError) {
                            assignEmployeesFormError.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                        }
                    }
                });
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            window.toggleEmployeeSelection = function(employeeId, isChecked) {
                if (isChecked) {
                    selectedEmployeeIds.add(employeeId);
                } else {
                    selectedEmployeeIds.delete(employeeId);
                }
            };

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            if (assignEmployeesSaveBtn) {
                assignEmployeesSaveBtn.addEventListener('click', async () => {
                    if (!currentTaskId) return;

                    if (assignEmployeesFormError) {
                        assignEmployeesFormError.textContent = '';
                    }

                    try {
                        const employeeIds = Array.from(selectedEmployeeIds);
                        const response = await fetch(`{{ url_for("admin_tasks.assign_employees_to_task", task_id=0) }}`.replace('0', currentTaskId), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ employee_ids: employeeIds })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                            const task = await fetch(`{{ url_for("admin_tasks.get_task", task_id=0) }}`.replace('0', currentTaskId));
                            const taskResult = await task.json();
                            if (taskResult.success && taskResult.task) {
                                await loadTaskEmployees(currentTaskId, taskResult.task.facility_id);
                            }

                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            if (assignEmployeesModal) {
                                assignEmployeesModal.classList.remove('visible');
                                document.body.classList.remove('modal-open');
                                setTimeout(() => {
                                    assignEmployeesModal.setAttribute('aria-hidden', 'true');
                                }, 0);
                            }

                            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                            window.location.reload();
                        } else {
                            if (assignEmployeesFormError) {
                                assignEmployeesFormError.textContent = result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                        if (assignEmployeesFormError) {
                            assignEmployeesFormError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                        }
                    }
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            [assignEmployeesModalClose, assignEmployeesModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (assignEmployeesModal) {
                            assignEmployeesModal.classList.remove('visible');
                            document.body.classList.remove('modal-open');
                            setTimeout(() => {
                                assignEmployeesModal.setAttribute('aria-hidden', 'true');
                            }, 0);
                        }
                        if (assignEmployeesFormError) {
                            assignEmployeesFormError.textContent = '';
                        }
                    });
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (assignEmployeesModal) {
                assignEmployeesModal.addEventListener('click', (e) => {
                    if (e.target === assignEmployeesModal) {
                        assignEmployeesModal.classList.remove('visible');
                        document.body.classList.remove('modal-open');
                        setTimeout(() => {
                            assignEmployeesModal.setAttribute('aria-hidden', 'true');
                        }, 0);
                    }
                });
            }

            // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –∑–∞–¥–∞—á
            const assignEmployeesTaskModal = document.getElementById('assignEmployeesTaskModal');
            const assignEmployeesTaskModalClose = document.getElementById('assignEmployeesTaskModalClose');
            const assignEmployeesTaskModalCancel = document.getElementById('assignEmployeesTaskModalCancel');
            const assignEmployeesTaskSaveBtn = document.getElementById('assignEmployeesTaskSaveBtn');
            const assignEmployeesTaskList = document.getElementById('assignEmployeesTaskList');
            const assignEmployeesTaskFormError = document.getElementById('assignEmployeesTaskFormError');
            
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–¥–µ—Å—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏)
            if (typeof window.selectedTaskEmployeeIds === 'undefined') {
                window.selectedTaskEmployeeIds = new Set();
            }
            if (typeof window.currentTaskIdForAssign === 'undefined') {
                window.currentTaskIdForAssign = null;
            }

            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è)
            window.openAssignEmployeesModal = async function(taskId, facilityId) {
                window.currentTaskIdForAssign = taskId;
                window.selectedTaskEmployeeIds.clear();

                if (assignEmployeesTaskFormError) {
                    assignEmployeesTaskFormError.textContent = '';
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                try {
                    const response = await fetch(`{{ url_for("admin_tasks.get_employees_by_facility", facility_id=0) }}`.replace('0', facilityId));
                    const result = await response.json();

                    if (result.success) {
                        const employees = result.employees || [];
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                        const assignedResponse = await fetch(`{{ url_for("admin_tasks.get_task_employees", task_id=0) }}`.replace('0', taskId));
                        const assignedResult = await assignedResponse.json();
                        const assignedIds = new Set((assignedResult.employees || []).map(e => e.id));
                        window.selectedTaskEmployeeIds = new Set(assignedIds);

                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                        if (assignEmployeesTaskList) {
                            if (employees.length === 0) {
                                assignEmployeesTaskList.innerHTML = '<div class="assign-employees-empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>';
                            } else {
                                assignEmployeesTaskList.innerHTML = employees.map(emp => {
                                    const isSelected = window.selectedTaskEmployeeIds.has(emp.id);
                                    return `
                                        <label class="assign-employee-item ${isSelected ? 'selected' : ''}">
                                            <input type="checkbox" value="${emp.id}" ${isSelected ? 'checked' : ''} onchange="toggleTaskEmployeeSelection(${emp.id}, this.checked)">
                                            <div class="assign-employee-info">
                                                <div class="assign-employee-name">${escapeHtml(emp.full_name || `${emp.last_name || ''} ${emp.first_name || ''} ${emp.patronymic || ''}`.trim())}</div>
                                                ${emp.post ? `<div class="assign-employee-post">${escapeHtml(emp.post)}</div>` : ''}
                                            </div>
                                        </label>
                                    `;
                                }).join('');
                            }
                        }

                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        if (assignEmployeesTaskModal) {
                            assignEmployeesTaskModal.classList.add('visible');
                            document.body.classList.add('modal-open');
                            setTimeout(() => {
                                assignEmployeesTaskModal.setAttribute('aria-hidden', 'false');
                            }, 0);
                        }
                    } else {
                        if (assignEmployeesTaskFormError) {
                            assignEmployeesTaskFormError.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                    if (assignEmployeesTaskFormError) {
                        assignEmployeesTaskFormError.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                    }
                }
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            window.toggleTaskEmployeeSelection = function(employeeId, isChecked) {
                if (isChecked) {
                    window.selectedTaskEmployeeIds.add(employeeId);
                } else {
                    window.selectedTaskEmployeeIds.delete(employeeId);
                }
            };

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            if (assignEmployeesTaskSaveBtn) {
                assignEmployeesTaskSaveBtn.addEventListener('click', async () => {
                    if (!window.currentTaskIdForAssign) return;

                    if (assignEmployeesTaskFormError) {
                        assignEmployeesTaskFormError.textContent = '';
                    }

                    try {
                        const employeeIds = Array.from(window.selectedTaskEmployeeIds);
                        const response = await fetch(`{{ url_for("admin_tasks.assign_employees_to_task", task_id=0) }}`.replace('0', window.currentTaskIdForAssign), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ employee_ids: employeeIds })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            if (assignEmployeesTaskModal) {
                                assignEmployeesTaskModal.classList.remove('visible');
                                document.body.classList.remove('modal-open');
                                setTimeout(() => {
                                    assignEmployeesTaskModal.setAttribute('aria-hidden', 'true');
                                }, 0);
                            }

                            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                            window.location.reload();
                        } else {
                            if (assignEmployeesTaskFormError) {
                                assignEmployeesTaskFormError.textContent = result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                        if (assignEmployeesTaskFormError) {
                            assignEmployeesTaskFormError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                        }
                    }
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            [assignEmployeesTaskModalClose, assignEmployeesTaskModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (assignEmployeesTaskModal) {
                            assignEmployeesTaskModal.classList.remove('visible');
                            document.body.classList.remove('modal-open');
                            setTimeout(() => {
                                assignEmployeesTaskModal.setAttribute('aria-hidden', 'true');
                            }, 0);
                        }
                        if (assignEmployeesTaskFormError) {
                            assignEmployeesTaskFormError.textContent = '';
                        }
                        window.currentTaskIdForAssign = null;
                        window.selectedTaskEmployeeIds.clear();
                    });
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (assignEmployeesTaskModal) {
                assignEmployeesTaskModal.addEventListener('click', (e) => {
                    if (e.target === assignEmployeesTaskModal) {
                        assignEmployeesTaskModal.classList.remove('visible');
                        document.body.classList.remove('modal-open');
                        setTimeout(() => {
                            assignEmployeesTaskModal.setAttribute('aria-hidden', 'true');
                        }, 0);
                        window.currentTaskIdForAssign = null;
                        window.selectedTaskEmployeeIds.clear();
                    }
                });
            }

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
            const deleteTaskModal = document.getElementById('deleteTaskModal');
            const deleteTaskModalClose = document.getElementById('deleteTaskModalClose');
            const deleteTaskCancel = document.getElementById('deleteTaskCancel');
            const deleteTaskConfirm = document.getElementById('deleteTaskConfirm');
            const deleteTaskMessage = document.getElementById('deleteTaskMessage');
            let taskToDelete = null;
            let taskToDeleteRow = null;

            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
            window.openDeleteTaskModal = function(taskId, taskRow) {
                if (!deleteTaskModal) return;
                
                taskToDelete = taskId;
                taskToDeleteRow = taskRow;
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
                const taskHeading = taskRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '–∑–∞–¥–∞—á—É';
                
                if (deleteTaskMessage) {
                    deleteTaskMessage.innerHTML = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É "${taskHeading}"?<br><em>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</em>`;
                }
                
                deleteTaskModal.setAttribute('aria-hidden', 'false');
                deleteTaskModal.classList.add('visible');
                document.body.classList.add('modal-open');
            };

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
            if (deleteTaskConfirm) {
                deleteTaskConfirm.addEventListener('click', async () => {
                    if (!taskToDelete || !taskToDeleteRow) return;
                    
                    try {
                        const response = await fetch(`/admin/tasks/${taskToDelete}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            if (deleteTaskModal) {
                                deleteTaskModal.classList.remove('visible');
                                document.body.classList.remove('modal-open');
                                setTimeout(() => {
                                    deleteTaskModal.setAttribute('aria-hidden', 'true');
                                }, 0);
                            }
                            
                            // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                            if (taskToDeleteRow) {
                                taskToDeleteRow.remove();
                                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                                if (typeof applyTasksFilters === 'function') {
                                    applyTasksFilters();
                                } else if (typeof window.applyTasksFilters === 'function') {
                                    window.applyTasksFilters();
                                }
                            }
                            
                            taskToDelete = null;
                            taskToDeleteRow = null;
                        } else {
                            alert(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                    }
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
            [deleteTaskModalClose, deleteTaskCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (deleteTaskModal) {
                            deleteTaskModal.classList.remove('visible');
                            document.body.classList.remove('modal-open');
                            setTimeout(() => {
                                deleteTaskModal.setAttribute('aria-hidden', 'true');
                            }, 0);
                        }
                        taskToDelete = null;
                        taskToDeleteRow = null;
                    });
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (deleteTaskModal) {
                deleteTaskModal.addEventListener('click', (e) => {
                    if (e.target === deleteTaskModal) {
                        deleteTaskModal.classList.remove('visible');
                        document.body.classList.remove('modal-open');
                        setTimeout(() => {
                            deleteTaskModal.setAttribute('aria-hidden', 'true');
                        }, 0);
                        taskToDelete = null;
                        taskToDeleteRow = null;
                    }
                });
            }

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
            const completeTaskModal = document.getElementById('completeTaskModal');
            const completeTaskModalClose = document.getElementById('completeTaskModalClose');
            const completeTaskModalCancel = document.getElementById('completeTaskModalCancel');
            const completeTaskSaveBtn = document.getElementById('completeTaskSaveBtn');
            const completeTaskResolution = document.getElementById('completeTaskResolution');
            const completeTaskSparePartsList = document.getElementById('completeTaskSparePartsList');
            const completeTaskFormError = document.getElementById('completeTaskFormError');
            let currentTaskIdForComplete = null;
            let sparePartsData = [];

            // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (–ª–æ–∫–∞–ª—å–Ω–∞—è)
            function escapeHtmlLocal(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è)
            window.openCompleteTaskModal = async function(taskId) {
                currentTaskIdForComplete = taskId;
                
                if (completeTaskFormError) {
                    completeTaskFormError.textContent = '';
                }
                
                if (completeTaskResolution) {
                    completeTaskResolution.value = '';
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π
                try {
                    if (completeTaskSparePartsList) {
                        completeTaskSparePartsList.innerHTML = '<div class="complete-task-spare-parts-loading"><div class="loading-spinner"></div><div style="color: var(--text-medium); font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π...</div></div>';
                    }
                    
                    const response = await fetch(`/admin/tasks/${taskId}/spare-parts`);
                    const result = await response.json();

                    if (result.success) {
                        sparePartsData = result.spare_parts || [];
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π
                        if (completeTaskSparePartsList) {
                            if (sparePartsData.length === 0) {
                                completeTaskSparePartsList.innerHTML = '<div class="assign-employees-empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π</div>';
                            } else {
                                completeTaskSparePartsList.innerHTML = sparePartsData.map(part => {
                                    return `
                                        <div class="complete-task-spare-part-item">
                                            <div class="complete-task-spare-part-info">
                                                <div class="complete-task-spare-part-name">${escapeHtmlLocal(part.name)}</div>
                                                <div class="complete-task-spare-part-details">
                                                    <span>–¢–∏–ø: ${escapeHtmlLocal(part.type)}</span>
                                                    <span>–î–æ—Å—Ç—É–ø–Ω–æ: ${part.quantity}</span>
                                                </div>
                                            </div>
                                            <div class="complete-task-spare-part-quantity">
                                                <input type="number" 
                                                       class="form-input" 
                                                       min="0" 
                                                       max="${part.quantity}" 
                                                       value="0" 
                                                       data-part-id="${part.id}"
                                                       style="width: 80px; text-align: center;">
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            }
                        }
                    } else {
                        if (completeTaskSparePartsList) {
                            completeTaskSparePartsList.innerHTML = '<div class="assign-employees-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π</div>';
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:', error);
                    if (completeTaskSparePartsList) {
                        completeTaskSparePartsList.innerHTML = '<div class="assign-employees-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π</div>';
                    }
                }

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                if (completeTaskModal) {
                    completeTaskModal.classList.add('visible');
                    document.body.classList.add('modal-open');
                    setTimeout(() => {
                        completeTaskModal.setAttribute('aria-hidden', 'false');
                    }, 0);
                }
            };

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏
            if (completeTaskSaveBtn) {
                completeTaskSaveBtn.addEventListener('click', async () => {
                    if (!currentTaskIdForComplete) return;

                    if (completeTaskFormError) {
                        completeTaskFormError.textContent = '';
                    }

                    const resolution = completeTaskResolution?.value.trim() || '';
                    if (!resolution) {
                        if (completeTaskFormError) {
                            completeTaskFormError.textContent = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç';
                        }
                        return;
                    }

                    // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
                    const sparePartQuantities = {};
                    if (completeTaskSparePartsList) {
                        const quantityInputs = completeTaskSparePartsList.querySelectorAll('input[type="number"][data-part-id]');
                        quantityInputs.forEach(input => {
                            const partId = input.dataset.partId;
                            const quantity = parseInt(input.value) || 0;
                            if (quantity > 0) {
                                sparePartQuantities[partId] = quantity;
                            }
                        });
                    }

                    try {
                        completeTaskSaveBtn.disabled = true;
                        completeTaskSaveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                        const response = await fetch(`/admin/tasks/${currentTaskIdForComplete}/complete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                resolution: resolution,
                                spare_part_quantities: sparePartQuantities
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—á–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ä–∞–∑—É
                            const taskRow = document.querySelector(`tr.task-row[data-task-id="${currentTaskIdForComplete}"]`);
                            if (taskRow) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Å—Ç—Ä–æ–∫–µ
                                const statusCell = taskRow.querySelector('td:last-child');
                                if (statusCell) {
                                    statusCell.innerHTML = '<span class="status-badge status-finished">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>';
                                }
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º data-status –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                                taskRow.dataset.status = 'completed';
                            }
                            
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            if (completeTaskModal) {
                                completeTaskModal.classList.remove('visible');
                                document.body.classList.remove('modal-open');
                                setTimeout(() => {
                                    completeTaskModal.setAttribute('aria-hidden', 'true');
                                }, 0);
                            }
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                            if (window.applyTasksFilters) {
                                window.applyTasksFilters();
                            }
                            
                            // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                            currentTaskIdForComplete = null;
                            sparePartsData = [];
                        } else {
                            if (completeTaskFormError) {
                                completeTaskFormError.textContent = result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É';
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
                        if (completeTaskFormError) {
                            completeTaskFormError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏';
                        }
                    } finally {
                        completeTaskSaveBtn.disabled = false;
                        completeTaskSaveBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å';
                    }
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            [completeTaskModalClose, completeTaskModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (completeTaskModal) {
                            completeTaskModal.classList.remove('visible');
                            document.body.classList.remove('modal-open');
                            setTimeout(() => {
                                completeTaskModal.setAttribute('aria-hidden', 'true');
                            }, 0);
                        }
                        currentTaskIdForComplete = null;
                        sparePartsData = [];
                    });
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (completeTaskModal) {
                completeTaskModal.addEventListener('click', (e) => {
                    if (e.target === completeTaskModal) {
                        completeTaskModal.classList.remove('visible');
                        document.body.classList.remove('modal-open');
                        setTimeout(() => {
                            completeTaskModal.setAttribute('aria-hidden', 'true');
                        }, 0);
                        currentTaskIdForComplete = null;
                        sparePartsData = [];
                    }
                });
            }
        })();

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        {% if section == 'statistics' %}
        (function() {
            'use strict';
            
            let charts = {};
            
            // –¶–≤–µ—Ç–∞ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
            const colors = {
                primary: '#dd9e00',
                success: '#22c55e',
                danger: '#ef4444',
                warning: '#eab308',
                info: '#3b82f6',
                purple: '#a855f7',
                pink: '#ec4899',
                teal: '#14b8a6',
                orange: '#f97316',
                gray: '#6b7280'
            };
            
            const chartColors = [
                colors.primary,
                colors.success,
                colors.info,
                colors.warning,
                colors.danger,
                colors.purple,
                colors.pink,
                colors.teal,
                colors.orange,
                colors.gray
            ];
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            async function loadStatistics() {
                const loadingEl = document.getElementById('statisticsLoading');
                const cardsEl = document.getElementById('statsCards');
                const chartsEl = document.getElementById('chartsGrid');
                
                try {
                    if (loadingEl) loadingEl.style.display = 'flex';
                    if (cardsEl) cardsEl.style.display = 'none';
                    if (chartsEl) chartsEl.style.display = 'none';
                    
                    const response = await fetch('/admin/statistics/api/data');
                    const result = await response.json();
                    
                    if (result.success) {
                        const data = result.data;
                        updateMetrics(data);
                        createCharts(data);
                        
                        if (loadingEl) loadingEl.style.display = 'none';
                        if (cardsEl) cardsEl.style.display = 'grid';
                        if (chartsEl) chartsEl.style.display = 'grid';
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', result.message);
                        if (loadingEl) {
                            loadingEl.innerHTML = '<p style="color: var(--text-danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                    if (loadingEl) {
                        loadingEl.innerHTML = '<p style="color: var(--text-danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message + '</p>';
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
            function updateMetrics(data) {
                // –ü–¢–û
                const ptoTotal = data.pto?.total || 0;
                document.getElementById('ptoTotal').textContent = ptoTotal;
                const ptoStatus = data.pto?.by_status || {};
                const ptoDetail = Object.entries(ptoStatus).slice(0, 2).map(([k, v]) => `${k}: ${v}`).join(', ');
                document.getElementById('ptoDetail').textContent = ptoDetail || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                // –ó–∞–¥–∞—á–∏
                const tasksTotal = data.tasks?.total || 0;
                document.getElementById('tasksTotal').textContent = tasksTotal;
                const tasksStatus = data.tasks?.by_status || {};
                const tasksDetail = Object.entries(tasksStatus).slice(0, 2).map(([k, v]) => `${k}: ${v}`).join(', ');
                document.getElementById('tasksDetail').textContent = tasksDetail || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                // –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                const employeesTotal = data.employees?.total?.total_employees || 0;
                const employeesTasks = data.employees?.total?.total_tasks || 0;
                document.getElementById('employeesTotal').textContent = employeesTotal;
                document.getElementById('employeesDetail').textContent = `–ó–∞–¥–∞—á: ${employeesTasks}`;
                
                // –ó–∞–ø—á–∞—Å—Ç–∏
                const partsTotal = data.spare_parts?.total?.total_parts || 0;
                const partsQuantity = data.spare_parts?.total?.total_quantity || 0;
                document.getElementById('partsTotal').textContent = partsTotal;
                document.getElementById('partsDetail').textContent = `–í—Å–µ–≥–æ: ${partsQuantity} —à—Ç.`;
                
                // –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                const equipmentTotal = data.equipment?.total || 0;
                document.getElementById('equipmentTotal').textContent = equipmentTotal;
                const equipmentStatus = data.equipment?.by_status || {};
                const equipmentDetail = Object.entries(equipmentStatus).slice(0, 2).map(([k, v]) => `${k}: ${v}`).join(', ');
                document.getElementById('equipmentDetail').textContent = equipmentDetail || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                // –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞–¥–∞—á
                const completedTasks = data.employees?.total?.completed_tasks || 0;
                document.getElementById('completedTasks').textContent = completedTasks;
                const completionRate = tasksTotal > 0 ? Math.round((completedTasks / tasksTotal) * 100) : 0;
                document.getElementById('completedTasksDetail').textContent = `${completionRate}% –æ—Ç –≤—Å–µ—Ö –∑–∞–¥–∞—á`;
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º
            function createCharts(data) {
                // –ü–¢–û –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–∫—Ä—É–≥–æ–≤–∞—è)
                if (data.pto?.by_status) {
                    const ctx = document.getElementById('ptoStatusChart');
                    if (ctx) {
                        if (charts.ptoStatus) charts.ptoStatus.destroy();
                        charts.ptoStatus = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(data.pto.by_status),
                                datasets: [{
                                    data: Object.values(data.pto.by_status),
                                    backgroundColor: chartColors.slice(0, Object.keys(data.pto.by_status).length)
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                }
                
                // –ó–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–∫—Ä—É–≥–æ–≤–∞—è)
                if (data.tasks?.by_status) {
                    const ctx = document.getElementById('tasksStatusChart');
                    if (ctx) {
                        if (charts.tasksStatus) charts.tasksStatus.destroy();
                        charts.tasksStatus = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(data.tasks.by_status),
                                datasets: [{
                                    data: Object.values(data.tasks.by_status),
                                    backgroundColor: chartColors.slice(0, Object.keys(data.tasks.by_status).length)
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                }
                
                // –ü–¢–û –ø–æ –º–µ—Å—è—Ü–∞–º (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è)
                if (data.pto?.by_month) {
                    const ctx = document.getElementById('ptoMonthlyChart');
                    if (ctx) {
                        if (charts.ptoMonthly) charts.ptoMonthly.destroy();
                        charts.ptoMonthly = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(data.pto.by_month),
                                datasets: [{
                                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ü–¢–û',
                                    data: Object.values(data.pto.by_month),
                                    backgroundColor: colors.primary
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }
                
                // –ó–∞–¥–∞—á–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è)
                if (data.tasks?.by_month) {
                    const ctx = document.getElementById('tasksMonthlyChart');
                    if (ctx) {
                        if (charts.tasksMonthly) charts.tasksMonthly.destroy();
                        charts.tasksMonthly = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(data.tasks.by_month),
                                datasets: [{
                                    label: '–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏',
                                    data: Object.values(data.tasks.by_month),
                                    backgroundColor: colors.info
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }
                
                // –¢–æ–ø —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è)
                if (data.employees?.top_employees) {
                    const ctx = document.getElementById('topEmployeesChart');
                    if (ctx) {
                        if (charts.topEmployees) charts.topEmployees.destroy();
                        const employees = data.employees.top_employees.slice(0, 10);
                        charts.topEmployees = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: employees.map(e => e.name),
                                datasets: [{
                                    label: '–í—Å–µ–≥–æ –∑–∞–¥–∞—á',
                                    data: employees.map(e => e.tasks_count),
                                    backgroundColor: colors.success
                                }, {
                                    label: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                                    data: employees.map(e => e.completed_tasks),
                                    backgroundColor: colors.primary
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }
                
                // –ó–∞–ø—á–∞—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º (–∫—Ä—É–≥–æ–≤–∞—è)
                if (data.spare_parts?.by_type) {
                    const ctx = document.getElementById('partsTypeChart');
                    if (ctx) {
                        if (charts.partsType) charts.partsType.destroy();
                        const types = data.spare_parts.by_type.slice(0, 8);
                        charts.partsType = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: types.map(t => t.type),
                                datasets: [{
                                    data: types.map(t => t.total_quantity),
                                    backgroundColor: chartColors.slice(0, types.length)
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                }
                
                // –¢–æ–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—á–∞—Å—Ç–µ–π (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è)
                if (data.spare_parts?.top_used) {
                    const ctx = document.getElementById('topPartsChart');
                    if (ctx) {
                        if (charts.topParts) charts.topParts.destroy();
                        const parts = data.spare_parts.top_used.slice(0, 10);
                        charts.topParts = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: parts.map(p => p.name),
                                datasets: [{
                                    label: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ä–∞–∑',
                                    data: parts.map(p => p.usage_count),
                                    backgroundColor: colors.purple
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }
                
                // –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–∫—Ä—É–≥–æ–≤–∞—è)
                if (data.equipment?.by_status) {
                    const ctx = document.getElementById('equipmentStatusChart');
                    if (ctx) {
                        if (charts.equipmentStatus) charts.equipmentStatus.destroy();
                        charts.equipmentStatus = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(data.equipment.by_status),
                                datasets: [{
                                    data: Object.values(data.equipment.by_status),
                                    backgroundColor: chartColors.slice(0, Object.keys(data.equipment.by_status).length)
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (document.getElementById('ptoStatusChart')) {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –≥–æ—Ç–æ–≤
                setTimeout(() => {
                    loadStatistics();
                }, 100);
            }
        })();
        {% endif %}
    </script>
</body>
</html>

