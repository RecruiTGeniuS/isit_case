<!DOCTYPE html>
<html lang="ru" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>УТОР - Панель администратора</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="admin-page">
    <div class="admin-container">
        <!-- Верхняя панель -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="logo">УТОР</h1>
            </div>
            <div class="header-right">
                <div class="user-menu" id="userMenu">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="avatar-container">
                            {% if user.avatar_path %}
                                <img src="{{ url_for('static', filename=user.avatar_path) }}" alt="Avatar" class="user-avatar" id="userAvatar">
                            {% else %}
                                <div class="user-avatar-empty" id="userAvatar">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                        <span class="user-name">{{ user.last_name }} {{ user.first_name[0] }}.{{ user.patronymic[0] }}.</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-avatar-container">
                            {% if user.avatar_path %}
                                <img src="{{ url_for('static', filename=user.avatar_path) }}" alt="Avatar" class="dropdown-avatar" id="dropdownAvatar" onclick="document.getElementById('avatarInput').click()">
                            {% else %}
                                <div class="dropdown-avatar-empty" id="dropdownAvatar" onclick="document.getElementById('avatarInput').click()">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                    <span class="avatar-hint">Нажмите для загрузки</span>
                                </div>
                            {% endif %}
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                        </div>
                        <div class="user-full-name">
                            {{ user.last_name }} {{ user.first_name }} {{ user.patronymic or '' }}
                        </div>
                        <div class="user-details">
                            <div class="detail-item">
                                <span class="detail-label">Должность:</span>
                                <span class="detail-value">{{ user.post }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Роль:</span>
                                <span class="detail-value">{{ get_role_translation(user.role) }}</span>
                            </div>
                        </div>

                        <div class="support-block">
                            <button type="button" class="support-link" id="supportToggle">
                                Контакты службы поддержки
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="support-contacts" id="supportContacts">
                                <div class="support-item">
                                    <span class="support-label">Телефон</span>
                                    <span class="support-value">+7 (800) 123-45-67</span>
                                </div>
                                <div class="support-item">
                                    <span class="support-label">Email</span>
                                    <span class="support-value">support@utor.example</span>
                                </div>
                                <div class="support-item">
                                    <span class="support-label">Telegram</span>
                                    <span class="support-value">@utor_support</span>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="theme-toggle-container">
                            <span class="theme-label">Тема интерфейса:</span>
                            <button class="theme-toggle-btn" id="themeSwitch" onclick="toggleTheme()" aria-label="Переключить тему">
                                <svg class="theme-icon sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                                <svg class="theme-icon moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="dropdown-actions">
                            <a href="{{ url_for('auth.logout') }}" class="logout-btn">Выйти</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Основной контент -->
        <div class="admin-main">
            <!-- Боковое меню -->
            <aside class="admin-sidebar">
                <nav class="sidebar-nav">
                    <a href="{{ url_for('admin_employees.list_employees') }}" class="nav-item {% if section == 'employees' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>Сотрудники</span>
                    </a>
                    <a href="{{ url_for('admin_equipment.list_equipment') }}" class="nav-item {% if section == 'equipment' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="8" rx="2"></rect>
                            <rect x="6" y="6" width="6" height="5" rx="1"></rect>
                            <path d="M12 11V6h5l2 3" />
                            <circle cx="8" cy="19" r="1.5"></circle>
                            <circle cx="16" cy="19" r="1.5"></circle>
                        </svg>
                        <span>Оборудование</span>
                    </a>
                    <a href="{{ url_for('admin_warehouse.list_warehouse') }}" class="nav-item {% if section == 'warehouse' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        <span>Склад</span>
                    </a>
                    <a href="{{ url_for('admin_pto.list_pto') }}" class="nav-item {% if section == 'pto' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                        <span>ПТО</span>
                    </a>
                    <a href="{{ url_for('admin_statistics.list_statistics') }}" class="nav-item {% if section == 'statistics' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        <span>Статистика</span>
                    </a>
                </nav>
            </aside>

            <!-- Контентная область -->
            <main class="admin-content">
                {% if section == 'employees' %}
                    <div class="content-header">
                        <h2>Сотрудники</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="employeeSearch" placeholder="Введите текст для поиска">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="filterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                Фильтр
                            </button>
                            <div class="filter-dropdown" id="filterDropdown">
                                <div class="filter-group">
                                    <label for="roleFilter">Права доступа</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="roleFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for role in role_options %}
                                                <button type="button" class="filter-option" data-value="{{ role }}">{{ role_labels.get(role) or role }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="roleFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="roleFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for role in role_options %}
                                        <option value="{{ role }}">{{ get_role_translation(role) }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="departmentFilter">Отдел</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="departmentFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for dept in department_options %}
                                                <button type="button" class="filter-option" data-value="{{ dept }}">{{ dept }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="departmentFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="departmentFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for dept in department_options %}
                                        <option value="{{ dept }}">{{ dept }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="facilityFilter">Предприятие</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="facilityFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for fac in facility_options %}
                                                <button type="button" class="filter-option" data-value="{{ fac }}">{{ fac }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="facilityFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="facilityFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for fac in facility_options %}
                                        <option value="{{ fac }}">{{ fac }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="resetFilters">Сбросить все фильтры</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="number-column">№</th>
                                    <th>Фамилия</th>
                                    <th>Имя</th>
                                    <th>Отчество</th>
                                    <th>Должность</th>
                                    <th>Телефон</th>
                                    <th>Email</th>
                                    <th>Отдел</th>
                                    <th>Предприятие</th>
                                    <th>Права доступа</th>
                                    <th>Логин</th>
                                    <th>Пароль</th>
                                    <th class="actions-column">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="Корзина">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in employees %}
                                <tr data-employee-id="{{ emp.id }}" data-role="{{ emp.role or '' }}" data-department="{{ emp.department or '' }}" data-facility="{{ emp.facility or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="last_name">{{ emp.last_name or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="first_name">{{ emp.first_name or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="patronymic">{{ emp.patronymic or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="post">{{ emp.post or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="phone">{{ format_phone(emp.phone) or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="email">{{ emp.email or '' }}</td>
                                    <td class="department-cell" tabindex="0" data-field="department_id" data-department-id="{{ emp.department_id or '' }}" data-facility-name="{{ emp.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ emp.department or '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="facility-cell" tabindex="0" data-field="facility" data-facility-value="{{ emp.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ emp.facility or '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="role-cell" tabindex="0" data-field="role" data-role-value="{{ emp.role or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ role_labels.get(emp.role) if emp.role else '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="login">{{ emp.login or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="password">{{ emp.password or '' }}</td>
                                    <td class="actions-column">
                                        <button type="button" class="delete-employee-btn" data-employee-id="{{ emp.id }}" aria-label="Удалить сотрудника" title="Удалить сотрудника">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="tableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addEmployeeBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Добавить сотрудника
                        </button>
                    </div>
                {% elif section == 'equipment' %}
                    <div class="content-header">
                        <h2>Оборудование</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="equipmentSearch" placeholder="Введите текст для поиска">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="equipmentFilterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                Фильтр
                            </button>
                            <div class="filter-dropdown" id="equipmentFilterDropdown">
                                <div class="filter-group">
                                    <label for="typeFilter">Тип</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="typeFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for type in type_options %}
                                                <button type="button" class="filter-option" data-value="{{ type }}">{{ type }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="typeFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="typeFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for type in type_options %}
                                        <option value="{{ type }}">{{ type }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="statusFilter">Статус</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="statusFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for status in status_options %}
                                                <button type="button" class="filter-option" data-value="{{ status }}">{{ status }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="statusFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="statusFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for status in status_options %}
                                        <option value="{{ status }}">{{ status }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="locationFilter">Расположение</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="locationFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for location in location_options %}
                                                <button type="button" class="filter-option" data-value="{{ location }}">{{ location }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="locationFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="locationFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for location in location_options %}
                                        <option value="{{ location }}">{{ location }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="resetEquipmentFilters">Сбросить все фильтры</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="equipmentTable">
                            <thead>
                                <tr>
                                    <th class="number-column">№</th>
                                    <th>Название</th>
                                    <th>Тип</th>
                                    <th>Расположение</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment %}
                                <tr data-equipment-id="{{ eq.id }}" data-type="{{ eq.equipment_type or '' }}" data-status="{{ eq.equipment_status or '' }}" data-location="{{ eq.location or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="equipment_name">{{ eq.equipment_name or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="equipment_type">{{ eq.equipment_type or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="location">{{ eq.location or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="equipment_status">{{ eq.equipment_status or '' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="equipmentTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addEquipmentBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Добавить оборудование
                        </button>
                    </div>
                {% elif section == 'equipment_passport' %}
                    <div class="content-header">
                        <button type="button" class="back-btn" onclick="window.location.href='{{ url_for('admin_equipment.list_equipment') }}'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Назад
                        </button>
                        <h2>Паспорт оборудования</h2>
                    </div>
                    <div class="content-placeholder">
                        <div class="placeholder-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                            </svg>
                        </div>
                        <h3>Раздел в разработке</h3>
                        <p>Функционал паспорта оборудования находится в разработке и будет доступен в ближайшее время.</p>
                    </div>
                {% elif section == 'warehouse' %}
                    <div class="content-header">
                        <h2>Склад запчастей</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="warehouseSearch" placeholder="Введите текст для поиска">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="warehouseFilterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                Фильтр
                            </button>
                            <div class="filter-dropdown" id="warehouseFilterDropdown">
                                <div class="filter-group">
                                    <label for="facilityWarehouseFilter">Предприятие</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="facilityWarehouseFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for fac in facility_options %}
                                                <button type="button" class="filter-option" data-value="{{ fac }}">{{ fac }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="facilityWarehouseFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="facilityWarehouseFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for fac in facility_options %}
                                        <option value="{{ fac }}">{{ fac }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="warehouseAddressFilter">Склад</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="warehouseAddressFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for wh in warehouse_options %}
                                                <button type="button" class="filter-option" data-value="{{ wh }}">{{ wh }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="warehouseAddressFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="warehouseAddressFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for wh in warehouse_options %}
                                        <option value="{{ wh }}">{{ wh }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="sparePartFilter">Деталь</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="sparePartFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for sp in spare_part_options %}
                                                <button type="button" class="filter-option" data-value="{{ sp }}">{{ sp }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="sparePartFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="sparePartFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for sp in spare_part_options %}
                                        <option value="{{ sp }}">{{ sp }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="warehouseResetFilters">Сбросить все фильтры</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="number-column">№</th>
                                    <th>Деталь</th>
                                    <th>Предприятие</th>
                                    <th>Склад</th>
                                    <th>Кол-во</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part in parts %}
                                <tr data-part-id="{{ part.id }}" data-facility="{{ part.facility_name or '' }}" data-warehouse="{{ part.department_name or '' }}" data-spare-part="{{ part.spare_part_name or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td>{{ part.spare_part_name or '—' }}</td>
                                    <td>{{ part.facility_name or '—' }}</td>
                                    <td>{{ part.department_name or '—' }}</td>
                                    <td>{{ part.quantity or '—' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="warehouseTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addPartBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Добавить деталь
                        </button>
                    </div>
                {% elif section == 'pto' %}
                    <div class="content-header">
                        <h2>ПТО</h2>
                    </div>
                    <div class="content-placeholder">
                        <div class="placeholder-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                            </svg>
                        </div>
                        <h3>Раздел в разработке</h3>
                        <p>Функционал производственно-технического отдела находится в разработке и будет доступен в ближайшее время.</p>
                    </div>
                {% elif section == 'statistics' %}
                    <div class="content-header">
                        <h2>Статистика</h2>
                    </div>
                    <div class="content-placeholder">
                        <div class="placeholder-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>
                        </div>
                        <h3>Раздел в разработке</h3>
                        <p>Функционал статистики и аналитики находится в разработке и будет доступен в ближайшее время.</p>
                    </div>
                {% endif %}
            </main>
        </div>
        <div class="decor-line"></div>
    </div>

    <div class="modal-overlay" id="employeeModal" aria-hidden="true">
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="employeeModalTitle">
            <div class="modal-header">
                <h3 id="employeeModalTitle">Добавление сотрудника</h3>
                <button type="button" class="modal-close-btn" id="employeeModalClose" aria-label="Закрыть">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form class="modal-form" id="employeeForm">
                <div class="modal-section">
                    <h4 class="modal-section-title">Данные сотрудника</h4>
                    <div class="modal-row modal-row--thirds">
                        <label class="modal-field">
                            <span data-required="*">Фамилия</span>
                            <input type="text" name="last_name" required>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Имя</span>
                            <input type="text" name="first_name" required>
                        </label>
                        <label class="modal-field">
                            <span data-required="">Отчество</span>
                            <input type="text" name="patronymic">
                        </label>
                    </div>
                    <div class="modal-row modal-row--thirds">
                        <label class="modal-field">
                            <span data-required="*">Предприятие</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="facility_id" id="employeeFacilitySelect" required style="display: none;">
                                    <option value="">Выберите предприятие</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Отдел</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalDepartmentBtn" data-field="department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">Сначала выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="department_id" id="employeeDepartment" required disabled style="display: none;">
                                    <option value="">Сначала выберите предприятие</option>
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Должность</span>
                            <input type="text" name="post" required>
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">Контактная информация</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="">Телефон</span>
                            <input type="text" name="phone" id="employeePhone" placeholder="+7 (___) ___-__-__">
                        </label>
                        <label class="modal-field">
                            <span data-required="">Email</span>
                            <input type="email" name="email" placeholder="example@company.ru">
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">Доступ к УТОР</h4>
                    <div class="modal-row modal-row--credentials">
                        <label class="modal-field">
                            <span data-required="*">Права доступа</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalRoleBtn" data-field="role" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите роль</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="role" id="employeeRoleSelect" required style="display: none;">
                                    <option value="">Выберите роль</option>
                                    {% for role in role_options %}
                                    <option value="{{ role }}">{{ role_labels.get(role) or role }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field login-field">
                            <span data-required="*">Логин</span>
                            <input type="text" name="login" id="employeeLogin" required>
                        </label>
                        <label class="modal-field password-field">
                            <span data-required="*">Пароль</span>
                            <div class="password-input-wrapper">
                                <input type="text" name="password" id="employeePassword" required>
                                <button type="button" class="dice-btn" id="generateCredentialsBtn" aria-label="Сгенерировать логин и пароль" title="Случайная генерация логина и пароля">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                        <circle cx="7.5" cy="7.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="16.5" cy="7.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="7.5" cy="16.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="16.5" cy="16.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="12" cy="12" r="1.2" fill="currentColor"></circle>
                                    </svg>
                                </button>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="modal-error" id="employeeFormError"></div>
                    <div class="modal-actions">
                        <button type="button" class="secondary-btn" id="employeeModalCancel">Отмена</button>
                        <button type="submit" class="primary-btn" id="employeeFormSubmit" data-default-label="Сохранить">
                            Сохранить
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления сотрудника -->
    <div class="modal-overlay" id="deleteEmployeeModal" aria-hidden="true">
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteEmployeeModalTitle">
            <div class="modal-header">
                <h3 id="deleteEmployeeModalTitle">Подтверждение удаления</h3>
                <button type="button" class="modal-close-btn" id="deleteEmployeeModalClose" aria-label="Закрыть">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p id="deleteEmployeeMessage">Вы уверены, что хотите удалить этого сотрудника? Это действие нельзя будет отменить.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="deleteEmployeeCancel">Отмена</button>
                <button type="button" class="primary-btn danger-btn" id="deleteEmployeeConfirm">Удалить</button>
            </div>
        </div>
    </div>
<!-- Модальное окно добавления детали на склад -->
<div class="modal-overlay" id="partModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="partModalTitle">
        <div class="modal-header">
            <h3 id="partModalTitle">Добавление детали</h3>
            <button type="button" class="modal-close-btn" id="partModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="partForm">
            <div class="modal-section">
                <h4 class="modal-section-title">Данные детали</h4>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">Название детали</span>
                        <input type="text" name="spare_part_name" id="partSparePartName" required>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">Кол-во</span>
                        <input type="number" name="quantity" id="partQuantity" min="1" required>
                    </label>
                </div>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">Предприятие</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalPartFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">Выберите предприятие</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="facility_id" id="partFacilitySelect" required style="display: none;">
                                <option value="">Выберите предприятие</option>
                                {% for fac in facility_choices %}
                                <option value="{{ fac.id }}">{{ fac.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">Склад</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalPartWarehouseBtn" data-field="warehouse_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                <span class="modal-select-label">Сначала выберите предприятие</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="warehouse_id" id="partWarehouseSelect" required disabled style="display: none;">
                                <option value="">Сначала выберите предприятие</option>
                            </select>
                        </div>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="partFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="partModalCancel">Отмена</button>
                    <button type="submit" class="primary-btn" id="partFormSubmit" data-default-label="Сохранить">
                        Сохранить
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно подтверждения удаления оборудования -->
<div class="modal-overlay" id="deleteEquipmentModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteEquipmentModalTitle">
        <div class="modal-header">
            <h3 id="deleteEquipmentModalTitle">Подтверждение удаления</h3>
            <button type="button" class="modal-close-btn" id="deleteEquipmentModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteEquipmentMessage">Вы уверены, что хотите удалить это оборудование?<br>Это действие нельзя будет отменить.</p>
        </div>
        <div class="modal-footer">
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="deleteEquipmentCancel">Отмена</button>
                <button type="button" class="primary-btn danger" id="deleteEquipmentConfirm">Удалить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления оборудования -->
<div class="modal-overlay" id="equipmentModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="equipmentModalTitle">
        <div class="modal-header">
            <h3 id="equipmentModalTitle">Добавление оборудования</h3>
            <button type="button" class="modal-close-btn" id="equipmentModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="equipmentForm">
            <div class="modal-section">
                <h4 class="modal-section-title">Основная информация</h4>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">Название оборудования</span>
                        <input type="text" name="equipment_name" required>
                    </label>
                    <label class="modal-field">
                        <span data-required="">Тип</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="equipmentTypeBtn" data-field="equipment_type" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">Выберите тип</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="equipment_type" id="equipmentTypeSelect" style="display: none;">
                                <option value="">Выберите тип</option>
                                {% for eq_type in equipment_types %}
                                <option value="{{ eq_type }}">{{ eq_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                </div>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="">Изображение</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="equipmentImageBtn" data-field="image_path" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">Выберите изображение</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="image_path" id="equipmentImageSelect" style="display: none;">
                                <option value="">Выберите изображение</option>
                                {% for img_path in image_paths %}
                                <option value="{{ img_path }}">{{ img_path }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                    <label class="modal-field">
                        <span data-required="">Периодичность ТО</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="equipmentMaintenanceBtn" data-field="maintenance_frequency" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">Выберите периодичность</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="maintenance_frequency" id="equipmentMaintenanceSelect" style="display: none;">
                                <option value="">Выберите периодичность</option>
                                {% for freq in maintenance_frequencies %}
                                <option value="{{ freq }}">{{ freq }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                </div>
            </div>

            <div class="modal-section">
                <h4 class="modal-section-title">Описание характеристик</h4>
                <div class="modal-row">
                    <label class="modal-field">
                        <span data-required="">Описание характеристик</span>
                        <textarea name="characteristics" rows="4" placeholder="Введите описание характеристик оборудования"></textarea>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="equipmentFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="equipmentModalCancel">Отмена</button>
                    <button type="submit" class="primary-btn" id="equipmentFormSubmit" data-default-label="Сохранить">
                        Сохранить
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>


    <script>
        // Переключение меню пользователя
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Закрытие меню при клике вне его
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            if (!userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // Загрузка аватара
        function uploadAvatar(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('avatar', input.files[0]);
                
                fetch('{{ url_for("admin.upload_avatar") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки:', error);
                });
            }
        }

        // Переключение темы
        function toggleTheme() {
            const html = document.documentElement;
            const sunIcon = document.querySelector('#themeSwitch .sun-icon');
            const moonIcon = document.querySelector('#themeSwitch .moon-icon');
            const isDark = html.classList.contains('dark-theme');
            
            if (isDark) {
                html.classList.remove('dark-theme');
                html.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
                if (sunIcon) sunIcon.style.display = 'none';
                if (moonIcon) moonIcon.style.display = 'block';
            } else {
                html.classList.remove('light-theme');
                html.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
                if (sunIcon) sunIcon.style.display = 'block';
                if (moonIcon) moonIcon.style.display = 'none';
            }
        }

        // Инициализация темы при загрузке
        (function() {
            const savedTheme = localStorage.getItem('theme');
            let theme = savedTheme;
            
            if (!theme) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = 'dark';
                } else {
                    theme = 'light';
                }
            }
            
            document.documentElement.classList.add(theme + '-theme');
            
            // Обновляем иконки переключателя темы
            const sunIcon = document.querySelector('#themeSwitch .sun-icon');
            const moonIcon = document.querySelector('#themeSwitch .moon-icon');
            if (theme === 'dark') {
                if (sunIcon) sunIcon.style.display = 'block';
                if (moonIcon) moonIcon.style.display = 'none';
            } else {
                if (sunIcon) sunIcon.style.display = 'none';
                if (moonIcon) moonIcon.style.display = 'block';
            }
        })();

        {% if section == 'employees' %}
        // Поиск и фильтрация таблицы
        const roleOptionsMap = {{ role_labels|tojson }};
        const departmentsData = {{ department_choices|tojson }};
        const facilityOptionsMap = {};
        {% for fac in facility_choices %}
        facilityOptionsMap[{{ fac.name|tojson }}] = {{ fac.name|tojson }};
        {% endfor %}
        // Создаём карту отделов по предприятиям для фильтрации
        const departmentsByFacility = {};
        {% for dept in department_choices %}
        const facilityName_{{ loop.index }} = {{ dept.facility_name|tojson }};
        if (facilityName_{{ loop.index }}) {
            if (!departmentsByFacility[facilityName_{{ loop.index }}]) {
                departmentsByFacility[facilityName_{{ loop.index }}] = [];
            }
            departmentsByFacility[facilityName_{{ loop.index }}].push({
                id: {{ dept.id }},
                name: {{ dept.name|tojson }}
            });
        }
        {% endfor %}
        const searchInput = document.getElementById('employeeSearch');
        const filterToggle = document.getElementById('filterToggle');
        const filterDropdown = document.getElementById('filterDropdown');
        const roleFilter = document.getElementById('roleFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const facilityFilter = document.getElementById('facilityFilter');
        const tableRows = document.querySelectorAll('.data-table tbody tr');
        const supportToggle = document.getElementById('supportToggle');
        const supportContacts = document.getElementById('supportContacts');
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const employeeModal = document.getElementById('employeeModal');
        const employeeModalClose = document.getElementById('employeeModalClose');
        const employeeModalCancel = document.getElementById('employeeModalCancel');
        const generateCredentialsBtn = document.getElementById('generateCredentialsBtn');
        const employeeLoginInput = document.getElementById('employeeLogin');
        const employeePasswordInput = document.getElementById('employeePassword');
        const employeeForm = document.getElementById('employeeForm');
        const employeeFacilitySelect = document.getElementById('employeeFacilitySelect');
        const employeeDepartmentSelect = document.getElementById('employeeDepartment');
        const employeeFormError = document.getElementById('employeeFormError');
        const employeeFormSubmit = document.getElementById('employeeFormSubmit');
        const submitDefaultText = employeeFormSubmit ? (employeeFormSubmit.dataset.defaultLabel || employeeFormSubmit.textContent.trim()) : '';
        const filterSelectWrappers = document.querySelectorAll('.filter-select[data-target]');
        const filterSelectControllers = new Map();
        let activeModal = null;

        // Кастомные dropdown'ы для модального окна (объявляем раньше, чтобы использовать в openEmployeeModal)
        const modalDropdown = document.createElement('div');
        modalDropdown.className = 'role-dropdown';
        modalDropdown.id = 'modalDropdown';
        document.body.appendChild(modalDropdown);

        let currentModalSelect = null;
        let modalSelectData = {};

        const facilityDeptMap = departmentsData.reduce((acc, dept) => {
            const facilityId = dept.facility_id ? String(dept.facility_id) : '';
            if (!facilityId) {
                return acc;
            }
            if (!acc[facilityId]) {
                acc[facilityId] = [];
            }
            acc[facilityId].push({
                id: String(dept.id),
                name: dept.name
            });
            return acc;
        }, {});

        Object.keys(facilityDeptMap).forEach(key => {
            facilityDeptMap[key].sort((a, b) => a.name.localeCompare(b.name, 'ru', { sensitivity: 'base' }));
        });

        function populateDepartmentOptions(facilityId) {
            if (!employeeDepartmentSelect) return;
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            const modalDepartmentLabel = modalDepartmentBtn?.querySelector('.modal-select-label');
            
            employeeDepartmentSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
            placeholder.disabled = !facilityId;
            placeholder.selected = true;
            employeeDepartmentSelect.appendChild(placeholder);

            if (!facilityId) {
                employeeDepartmentSelect.disabled = true;
                if (modalDepartmentBtn) {
                    modalDepartmentBtn.disabled = true;
                    if (modalDepartmentLabel) {
                        modalDepartmentLabel.textContent = 'Сначала выберите предприятие';
                    }
                }
                // Обновляем данные для dropdown
                if (modalSelectData) {
                    modalSelectData.department = {};
                }
                return;
            }

            const departments = facilityDeptMap[facilityId] || [];
            if (departments.length === 0) {
                placeholder.textContent = 'Для выбранного предприятия нет отделов';
                employeeDepartmentSelect.disabled = true;
                if (modalDepartmentBtn) {
                    modalDepartmentBtn.disabled = true;
                    if (modalDepartmentLabel) {
                        modalDepartmentLabel.textContent = 'Для выбранного предприятия нет отделов';
                    }
                }
                // Обновляем данные для dropdown
                if (modalSelectData) {
                    modalSelectData.department = {};
                }
                return;
            }
            
            // Обновляем данные для dropdown
            if (modalSelectData) {
                modalSelectData.department = {};
                departments.forEach(dept => {
                    modalSelectData.department[dept.id] = dept.name;
                });
            }
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                employeeDepartmentSelect.appendChild(option);
            });
            employeeDepartmentSelect.disabled = false;
            if (modalDepartmentBtn) {
                modalDepartmentBtn.disabled = false;
                if (modalDepartmentLabel) {
                    modalDepartmentLabel.textContent = 'Выберите отдел';
                }
            }
        }

        function openEmployeeModal() {
            if (!employeeModal) return;
            employeeModal.classList.add('visible');
            employeeModal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            activeModal = employeeModal;
            if (employeeForm) {
                employeeForm.reset();
            }
            
            // Сбрасываем кастомные dropdown'ы
            const modalFacilityBtn = document.getElementById('modalFacilityBtn');
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            const modalRoleBtn = document.getElementById('modalRoleBtn');
            
            if (modalFacilityBtn) {
                const label = modalFacilityBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Выберите предприятие';
                modalFacilityBtn.setAttribute('aria-expanded', 'false');
            }
            if (modalDepartmentBtn) {
                const label = modalDepartmentBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Сначала выберите предприятие';
                modalDepartmentBtn.setAttribute('aria-expanded', 'false');
                modalDepartmentBtn.disabled = true;
            }
            if (modalRoleBtn) {
                const label = modalRoleBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Выберите роль';
                modalRoleBtn.setAttribute('aria-expanded', 'false');
            }
            
            closeModalDropdown();
            
            if (employeeFacilitySelect) {
                employeeFacilitySelect.value = '';
                handleFacilityChange();
            } else {
                populateDepartmentOptions('');
            }
            if (employeeFormError) {
                employeeFormError.textContent = '';
            }
            const firstInput = employeeForm ? employeeForm.querySelector('input, .modal-select-btn') : null;
            if (firstInput) {
                firstInput.focus();
            }
        }

        function closeEmployeeModal() {
            if (!employeeModal) return;
            employeeModal.classList.remove('visible');
            employeeModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            activeModal = null;
        }

        function handleFacilityChange() {
            if (!employeeFacilitySelect) return;
            const facilityId = employeeFacilitySelect.value;
            populateDepartmentOptions(facilityId);
            if (employeeDepartmentSelect) {
                employeeDepartmentSelect.value = '';
            }
            // Обновляем кастомную кнопку отдела
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            if (modalDepartmentBtn) {
                const label = modalDepartmentBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
                }
            }
        }

        function applyRowStriping() {
            let visibleIndex = 0;
            tableRows.forEach(row => {
                if (row.style.display === 'none') {
                    row.classList.remove('alt-row');
                    return;
                }
                const isAlt = visibleIndex % 2 === 1;
                row.classList.toggle('alt-row', isAlt);
                visibleIndex += 1;
            });
        }

        function applyTableFilters() {
            const searchValue = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const roleValue = roleFilter ? roleFilter.value : '';
            const departmentValue = departmentFilter ? departmentFilter.value : '';
            const facilityValue = facilityFilter ? facilityFilter.value : '';

            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowRole = (row.dataset.role || '').toLowerCase();
                const rowDept = (row.dataset.department || '').toLowerCase();
                const rowFac = (row.dataset.facility || '').toLowerCase();

                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesRole = roleValue === '' || rowRole === roleValue.toLowerCase();
                const matchesDept = departmentValue === '' || rowDept === departmentValue.toLowerCase();
                const matchesFac = facilityValue === '' || rowFac === facilityValue.toLowerCase();

                row.style.display = (matchesSearch && matchesRole && matchesDept && matchesFac) ? '' : 'none';
            });

            applyRowStriping();
        }

        const resetFiltersBtn = document.getElementById('resetFilters');

        if (searchInput) {
            searchInput.addEventListener('input', applyTableFilters);
        }

        [roleFilter, departmentFilter, facilityFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', applyTableFilters);
            }
        });

        function closeFilterSelectMenus() {
            filterSelectWrappers.forEach(wrapper => {
                wrapper.classList.remove('open');
                const btn = wrapper.querySelector('.filter-select-btn');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (filterToggle && filterDropdown) {
            filterToggle.addEventListener('click', () => {
                filterDropdown.classList.toggle('active');
                filterToggle.classList.toggle('active');
                if (!filterDropdown.classList.contains('active')) {
                    closeFilterSelectMenus();
                }
            });

            document.addEventListener('click', (event) => {
                if (!filterDropdown.contains(event.target) && !filterToggle.contains(event.target)) {
                    filterDropdown.classList.remove('active');
                    filterToggle.classList.remove('active');
                    closeFilterSelectMenus();
                }
            });
        }

        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', () => {
                if (searchInput) searchInput.value = '';
                if (roleFilter) roleFilter.value = '';
                if (departmentFilter) departmentFilter.value = '';
                if (facilityFilter) facilityFilter.value = '';
                applyTableFilters();
                filterSelectControllers.forEach(controller => controller.sync());
            });
        }

        if (supportToggle && supportContacts) {
            supportToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                supportContacts.classList.toggle('active');
            });
        }

        if (addEmployeeBtn) {
            addEmployeeBtn.addEventListener('click', () => {
                closeFilterSelectMenus();
                closeRoleDropdown();
                if (typeof closeFacilityDropdown === 'function') {
                    closeFacilityDropdown();
                }
                if (typeof closeDepartmentDropdown === 'function') {
                    closeDepartmentDropdown();
                }
                openEmployeeModal();
            });
        }

        [employeeModalClose, employeeModalCancel].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    closeEmployeeModal();
                });
            }
        });

        // Генерация логина и пароля
        if (generateCredentialsBtn) {
            generateCredentialsBtn.addEventListener('click', () => {
                // Получаем значения фамилии и имени
                const lastNameInput = document.querySelector('input[name="last_name"]');
                const firstNameInput = document.querySelector('input[name="first_name"]');
                
                const lastName = lastNameInput ? lastNameInput.value.trim() : '';
                const firstName = firstNameInput ? firstNameInput.value.trim() : '';
                
                // Генерируем логин на основе фамилии и имени
                let login = '';
                if (lastName && firstName) {
                    // Берём первые 3 буквы фамилии и первую букву имени, приводим к нижнему регистру
                    const lastPart = lastName.substring(0, 3).toLowerCase();
                    const firstPart = firstName.substring(0, 1).toLowerCase();
                    // Транслитерация русских букв в латиницу
                    const translitMap = {
                        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'e',
                        'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
                        'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
                        'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
                        'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
                    };
                    
                    const transliterate = (str) => {
                        return str.split('').map(char => {
                            const lower = char.toLowerCase();
                            return translitMap[lower] || lower;
                        }).join('');
                    };
                    
                    const lastPartTranslit = transliterate(lastPart);
                    const firstPartTranslit = transliterate(firstPart);
                    login = lastPartTranslit + firstPartTranslit;
                } else {
                    // Если нет фамилии и имени, генерируем случайный логин
                    login = 'user' + Math.floor(Math.random() * 10000);
                }
                
                // Генерируем пароль: pass + 4 случайные цифры
                const randomDigits = Math.floor(1000 + Math.random() * 9000); // 4-значное число от 1000 до 9999
                const password = 'pass' + randomDigits;
                
                // Заполняем поля
                if (employeeLoginInput) {
                    employeeLoginInput.value = login;
                }
                if (employeePasswordInput) {
                    employeePasswordInput.value = password;
                }
            });
        }

        // Автоматическое форматирование номера телефона
        const employeePhoneInput = document.getElementById('employeePhone');
        if (employeePhoneInput) {
            employeePhoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Убираем все нецифровые символы
                
                // Если начинается с 8, заменяем на 7
                if (value.startsWith('8')) {
                    value = '7' + value.substring(1);
                }
                
                // Если не начинается с 7, добавляем 7
                if (value && !value.startsWith('7')) {
                    value = '7' + value;
                }
                
                // Ограничиваем длину (7 + 10 цифр = 11)
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                // Форматируем номер
                let formatted = '';
                if (value.length > 0) {
                    formatted = '+7';
                    if (value.length > 1) {
                        formatted += ' (' + value.substring(1, 4);
                        if (value.length > 4) {
                            formatted += ') ' + value.substring(4, 7);
                            if (value.length > 7) {
                                formatted += '-' + value.substring(7, 9);
                                if (value.length > 9) {
                                    formatted += '-' + value.substring(9, 11);
                                }
                            }
                        } else {
                            formatted += ')';
                        }
                    }
                }
                
                e.target.value = formatted;
            });
            
            // Обработка вставки текста
            employeePhoneInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const digits = pastedText.replace(/\D/g, '');
                
                if (digits) {
                    let value = digits;
                    if (value.startsWith('8')) {
                        value = '7' + value.substring(1);
                    }
                    if (value && !value.startsWith('7')) {
                        value = '7' + value;
                    }
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    let formatted = '';
                    if (value.length > 0) {
                        formatted = '+7';
                        if (value.length > 1) {
                            formatted += ' (' + value.substring(1, 4);
                            if (value.length > 4) {
                                formatted += ') ' + value.substring(4, 7);
                                if (value.length > 7) {
                                    formatted += '-' + value.substring(7, 9);
                                    if (value.length > 9) {
                                        formatted += '-' + value.substring(9, 11);
                                    }
                                }
                            } else {
                                formatted += ')';
                            }
                        }
                    }
                    
                    this.value = formatted;
                    this.dispatchEvent(new Event('input'));
                }
            });
        }

        if (employeeModal) {
            employeeModal.addEventListener('click', (event) => {
                if (event.target === employeeModal) {
                    closeEmployeeModal();
                }
            });
        }

        if (employeeFacilitySelect) {
            employeeFacilitySelect.addEventListener('change', handleFacilityChange);
        }

        const statusBox = document.getElementById('tableUpdateStatus');
        const editableCells = document.querySelectorAll('.data-table td.editable-cell[data-field]');
        const roleCells = document.querySelectorAll('.role-cell');
        let statusTimeoutId;
        let currentRoleCell = null;

        function showStatus(message, state = 'info') {
            if (!statusBox) return;
            statusBox.textContent = message;
            statusBox.dataset.state = state;
            statusBox.classList.remove('visible');
            if (message) {
                requestAnimationFrame(() => statusBox.classList.add('visible'));
                clearTimeout(statusTimeoutId);
                statusTimeoutId = setTimeout(() => {
                    statusBox.classList.remove('visible');
                }, 5000);
            }
        }

        function revertCell(cell) {
            if (!cell) return;
            if (cell.classList.contains('role-cell')) {
                const label = roleOptionsMap[cell.dataset.originalValue || ''] || '—';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (labelSpan) labelSpan.textContent = label;
                cell.dataset.roleValue = cell.dataset.originalValue || '';
                return;
            }
            if (cell.classList.contains('facility-cell')) {
                const facilityName = cell.dataset.originalValue || '';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (labelSpan) labelSpan.textContent = facilityName || '—';
                cell.dataset.facilityValue = facilityName;
                return;
            }
            if (cell.classList.contains('department-cell')) {
                const deptId = cell.dataset.originalValue || '';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (deptId) {
                    const facilityName = cell.dataset.facilityName || '';
                    const departments = departmentsByFacility[facilityName] || [];
                    const dept = departments.find(d => String(d.id) === String(deptId));
                    if (labelSpan) labelSpan.textContent = dept ? dept.name : '—';
                    cell.dataset.departmentId = deptId;
                } else {
                    if (labelSpan) labelSpan.textContent = '—';
                    cell.dataset.departmentId = '';
                }
                return;
            }
            cell.textContent = cell.dataset.originalValue || '';
        }

        function updateEmployeeCell(cell, employeeId, field, value) {
            cell.classList.add('saving');
            fetch(`/admin/employees/${employeeId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ field, value })
            })
            .then(async response => {
                const data = await response.json();
                return { ok: response.ok, data };
            })
            .then(({ ok, data }) => {
                cell.classList.remove('saving');
                if (ok && data.success) {
                    if (cell.classList.contains('role-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        const label = roleOptionsMap[data.value || ''] || '—';
                        if (labelSpan) labelSpan.textContent = label;
                        cell.dataset.roleValue = data.value || '';
                        cell.dataset.originalValue = cell.dataset.roleValue;
                        cell.setAttribute('aria-expanded', 'false');
                    } else if (cell.classList.contains('facility-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        const facilityName = data.value || '';
                        // Отображаем название предприятия (не прочерк, если есть значение)
                        if (labelSpan) labelSpan.textContent = facilityName || '—';
                        cell.dataset.facilityValue = facilityName;
                        cell.dataset.originalValue = facilityName;
                        cell.setAttribute('aria-expanded', 'false');
                        // Обновляем также department в строке
                        const row = cell.closest('tr');
                        if (row) {
                            const departmentCell = row.querySelector('.department-cell');
                            if (departmentCell) {
                                const deptLabelSpan = departmentCell.querySelector('.role-cell-label');
                                // Всегда ставим прочерк в отделе при смене предприятия
                                if (deptLabelSpan) deptLabelSpan.textContent = '—';
                                departmentCell.dataset.departmentId = '';
                                // Обновляем facilityName для правильного отображения списка отделов
                                departmentCell.dataset.facilityName = facilityName || '';
                                row.dataset.department = '';
                            }
                        }
                    } else if (cell.classList.contains('department-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        // data.value для отдела - это название отдела, а не ID
                        const deptName = data.value || '';
                        if (labelSpan) labelSpan.textContent = deptName || '—';
                        // Нужно найти ID отдела по названию для обновления dataset
                        const facilityName = cell.dataset.facilityName || '';
                        const departments = departmentsByFacility[facilityName] || [];
                        const dept = departments.find(d => d.name === deptName);
                        if (dept) {
                            cell.dataset.departmentId = String(dept.id);
                        } else {
                            cell.dataset.departmentId = '';
                        }
                        cell.dataset.originalValue = cell.dataset.departmentId;
                        cell.setAttribute('aria-expanded', 'false');
                    } else {
                        cell.textContent = data.value || '';
                        cell.dataset.originalValue = cell.textContent;
                    }
                    showStatus('Изменения сохранены', 'success');
                } else {
                    cell.classList.add('error');
                    revertCell(cell);
                    showStatus(data.message || 'Ошибка сохранения', 'error');
                    setTimeout(() => cell.classList.remove('error'), 1500);
                }
            })
            .catch(() => {
                cell.classList.remove('saving');
                cell.classList.add('error');
                revertCell(cell);
                showStatus('Сеть недоступна. Попробуйте позже.', 'error');
                setTimeout(() => cell.classList.remove('error'), 1500);
            });
        }

        editableCells.forEach(cell => {
            // Активация редактирования по двойному клику
            cell.addEventListener('dblclick', () => {
                cell.contentEditable = 'true';
                cell.dataset.originalValue = cell.textContent.trim();
                // Фокусируем ячейку и выделяем весь текст
                cell.focus();
                const range = document.createRange();
                range.selectNodeContents(cell);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            });

            cell.addEventListener('focus', () => {
                // Сохраняем оригинальное значение только если ячейка уже в режиме редактирования
                if (cell.contentEditable === 'true') {
                    cell.dataset.originalValue = cell.textContent.trim();
                }
            });

            cell.addEventListener('keydown', (event) => {
                if (cell.contentEditable !== 'true') return;
                
                if (event.key === 'Enter') {
                    event.preventDefault();
                    cell.blur();
                }
                if (event.key === 'Escape') {
                    event.preventDefault();
                    revertCell(cell);
                    cell.blur();
                }
            });

            cell.addEventListener('paste', (event) => {
                if (cell.contentEditable !== 'true') return;
                event.preventDefault();
                const text = (event.clipboardData || window.clipboardData).getData('text');
                
                // Специальная обработка для поля телефона
                if (cell.dataset.field === 'phone') {
                    const digits = text.replace(/\D/g, '');
                    if (digits) {
                        let value = digits;
                        if (value.startsWith('8')) {
                            value = '7' + value.substring(1);
                        }
                        if (value && !value.startsWith('7')) {
                            value = '7' + value;
                        }
                        if (value.length > 11) {
                            value = value.substring(0, 11);
                        }
                        
                        let formatted = '';
                        if (value.length > 0) {
                            formatted = '+7';
                            if (value.length > 1) {
                                formatted += ' (' + value.substring(1, 4);
                                if (value.length > 4) {
                                    formatted += ') ' + value.substring(4, 7);
                                    if (value.length > 7) {
                                        formatted += '-' + value.substring(7, 9);
                                        if (value.length > 9) {
                                            formatted += '-' + value.substring(9, 11);
                                        }
                                    }
                                } else {
                                    formatted += ')';
                                }
                            }
                        }
                        cell.textContent = formatted;
                        // Устанавливаем курсор в конец
                        const range = document.createRange();
                        range.selectNodeContents(cell);
                        range.collapse(false);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                } else {
                    document.execCommand('insertText', false, text);
                }
            });
            
            // Обработка ввода для поля телефона
            if (cell.dataset.field === 'phone') {
                cell.addEventListener('input', function(e) {
                    if (cell.contentEditable !== 'true') return;
                    
                    // Получаем текущую позицию курсора и текст до курсора
                    const selection = window.getSelection();
                    const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                    const cursorOffset = range ? range.startOffset : 0;
                    
                    // Получаем текст до курсора и после
                    const textBeforeCursor = cell.textContent.substring(0, cursorOffset);
                    const textAfterCursor = cell.textContent.substring(cursorOffset);
                    
                    // Подсчитываем количество цифр до курсора
                    const digitsBeforeCursor = textBeforeCursor.replace(/\D/g, '').length;
                    
                    let value = cell.textContent.replace(/\D/g, ''); // Убираем все нецифровые символы
                    
                    // Если начинается с 8, заменяем на 7
                    if (value.startsWith('8')) {
                        value = '7' + value.substring(1);
                    }
                    
                    // Если не начинается с 7, добавляем 7
                    if (value && !value.startsWith('7')) {
                        value = '7' + value;
                    }
                    
                    // Ограничиваем длину (7 + 10 цифр = 11)
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    // Форматируем номер
                    let formatted = '';
                    if (value.length > 0) {
                        formatted = '+7';
                        if (value.length > 1) {
                            formatted += ' (' + value.substring(1, 4);
                            if (value.length > 4) {
                                formatted += ') ' + value.substring(4, 7);
                                if (value.length > 7) {
                                    formatted += '-' + value.substring(7, 9);
                                    if (value.length > 9) {
                                        formatted += '-' + value.substring(9, 11);
                                    }
                                }
                            } else {
                                formatted += ')';
                            }
                        }
                    }
                    
                    // Вычисляем новую позицию курсора на основе количества цифр
                    let newCursorPosition = formatted.length;
                    if (digitsBeforeCursor > 0) {
                        // Находим позицию в отформатированной строке, где находится N-я цифра
                        let digitCount = 0;
                        for (let i = 0; i < formatted.length; i++) {
                            if (/\d/.test(formatted[i])) {
                                digitCount++;
                                if (digitCount === digitsBeforeCursor) {
                                    // Ставим курсор после этой цифры
                                    newCursorPosition = i + 1;
                                    break;
                                }
                            }
                        }
                    } else if (digitsBeforeCursor === 0 && value.length > 0) {
                        // Если курсор был в начале, ставим после +7
                        newCursorPosition = 2;
                    }
                    
                    cell.textContent = formatted;
                    
                    // Восстанавливаем позицию курсора
                    if (formatted.length > 0) {
                        requestAnimationFrame(() => {
                            try {
                                const textNode = cell.firstChild;
                                if (textNode) {
                                    const newRange = document.createRange();
                                    const finalPosition = Math.min(newCursorPosition, formatted.length);
                                    newRange.setStart(textNode, finalPosition);
                                    newRange.setEnd(textNode, finalPosition);
                                    selection.removeAllRanges();
                                    selection.addRange(newRange);
                                }
                            } catch (e) {
                                // Если не удалось восстановить позицию, ставим курсор в конец
                                const newRange = document.createRange();
                                newRange.selectNodeContents(cell);
                                newRange.collapse(false);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                        });
                    }
                });
            }

            cell.addEventListener('blur', () => {
                // Деактивируем редактирование
                cell.contentEditable = 'false';
                
                const originalValue = cell.dataset.originalValue ?? '';
                const newValue = cell.textContent.trim();
                if (newValue === originalValue) {
                    return;
                }
                const row = cell.closest('tr');
                const employeeId = row ? row.dataset.employeeId : null;
                if (!employeeId) {
                    revertCell(cell);
                    showStatus('Не удалось определить сотрудника.', 'error');
                    return;
                }
                const field = cell.dataset.field;
                if (!field) {
                    revertCell(cell);
                    return;
                }
                updateEmployeeCell(cell, employeeId, field, newValue);
            });
        });

        const roleDropdown = document.createElement('div');
        roleDropdown.className = 'role-dropdown';
        document.body.appendChild(roleDropdown);

        function populateRoleDropdown() {
            roleDropdown.innerHTML = '';
            Object.entries(roleOptionsMap).forEach(([value, label]) => {
                // Пропускаем пустые значения
                if (!value || value.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = value;
                option.textContent = label || value;
                option.addEventListener('click', () => {
                    const targetCell = currentRoleCell;
                    if (!targetCell) return;
                    if (targetCell.dataset.roleValue === value) {
                        closeRoleDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.roleValue || '';
                    updateEmployeeCell(targetCell, employeeId, 'role', value);
                    closeRoleDropdown();
                });
                roleDropdown.appendChild(option);
            });
        }

        function positionRoleDropdown(cell) {
            if (!cell || !roleDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            
            // Используем offsetWidth для получения реальной ширины ячейки
            // offsetWidth включает padding и border, что даёт точную ширину
            const cellWidth = cell.offsetWidth;
            
            // Также проверяем rect.width для сравнения
            const rectWidth = rect.width;
            
            // Используем максимальное значение для надёжности
            const finalWidth = Math.max(cellWidth, rectWidth);
            
            // Получаем реальную высоту dropdown
            const dropdownHeight = roleDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            // Проверяем границы контейнера таблицы
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            // Вычисляем доступное пространство
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Если есть контейнер таблицы, учитываем его границы
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                // Проверяем, сколько места есть в контейнере ниже ячейки
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            // Определяем, открывать ли dropdown вверх или вниз
            // Открываем вверх, если места внизу недостаточно и места вверху больше
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            // Позиционируем относительно viewport
            roleDropdown.style.position = 'fixed';
            if (openUpward) {
                // Открываем вверх
                roleDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                roleDropdown.style.top = 'auto';
            } else {
                // Открываем вниз (по умолчанию)
                roleDropdown.style.top = `${rect.bottom + 6}px`;
                roleDropdown.style.bottom = 'auto';
            }
            roleDropdown.style.left = `${rect.left}px`;
            roleDropdown.style.width = `${finalWidth}px`;
            roleDropdown.style.minWidth = `${finalWidth}px`;
            roleDropdown.style.maxWidth = `${finalWidth}px`;
            roleDropdown.style.boxSizing = 'border-box';
            
            // Сбрасываем любые ограничения ширины
            roleDropdown.style.flexShrink = '0';
            roleDropdown.style.flexGrow = '0';
            
            // Убеждаемся, что опции занимают всю ширину
            const options = roleDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.roleValue);
            });
        }

        function openRoleDropdown(cell) {
            currentRoleCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateRoleDropdown();
            roleDropdown.classList.add('visible');
            // Используем двойной requestAnimationFrame для точного позиционирования после всех изменений DOM
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionRoleDropdown(cell);
                    // Пересчитываем позицию после того, как dropdown получил реальную высоту
                    requestAnimationFrame(() => {
                        positionRoleDropdown(cell);
                    });
                });
            });
        }

        function closeRoleDropdown() {
            if (currentRoleCell) {
                currentRoleCell.setAttribute('aria-expanded', 'false');
            }
            currentRoleCell = null;
            roleDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (roleDropdown.contains(event.target)) return;
            if (event.target.closest('.role-cell')) return;
            closeRoleDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentRoleCell) {
                requestAnimationFrame(() => {
                    positionRoleDropdown(currentRoleCell);
                });
            }
        });

        // Обработчик скролла страницы - закрываем dropdown при прокрутке
        window.addEventListener('scroll', () => {
            if (currentRoleCell && roleDropdown.classList.contains('visible')) {
                closeRoleDropdown();
            }
        }, true);

        // Обработчик скролла таблицы - закрываем dropdown при прокрутке
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
            tableContainer.addEventListener('scroll', () => {
                if (currentRoleCell && roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                }
            });
        }

        roleCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentRoleCell === cell && roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                } else {
                    openRoleDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.roleValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openRoleDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeRoleDropdown();
                    cell.blur();
                }
            });
        });

        // Выпадающие списки для предприятий
        const facilityCells = document.querySelectorAll('.facility-cell');
        const facilityDropdown = document.createElement('div');
        facilityDropdown.className = 'role-dropdown';
        document.body.appendChild(facilityDropdown);
        let currentFacilityCell = null;

        function populateFacilityDropdown() {
            facilityDropdown.innerHTML = '';
            // Используем facilityOptionsMap для предприятий
            Object.keys(facilityOptionsMap).forEach(facilityName => {
                // Пропускаем пустые значения
                if (!facilityName || facilityName.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = facilityName;
                // Используем название предприятия напрямую
                option.textContent = facilityName;
                option.addEventListener('click', () => {
                    const targetCell = currentFacilityCell;
                    if (!targetCell) return;
                    if (targetCell.dataset.facilityValue === facilityName) {
                        closeFacilityDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.facilityValue || '';
                    updateEmployeeCell(targetCell, employeeId, 'facility', facilityName);
                    closeFacilityDropdown();
                });
                facilityDropdown.appendChild(option);
            });
        }

        function positionFacilityDropdown(cell) {
            if (!cell || !facilityDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            const cellWidth = cell.offsetWidth;
            const rectWidth = rect.width;
            const finalWidth = Math.max(cellWidth, rectWidth);
            const dropdownHeight = facilityDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            facilityDropdown.style.position = 'fixed';
            if (openUpward) {
                facilityDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                facilityDropdown.style.top = 'auto';
            } else {
                facilityDropdown.style.top = `${rect.bottom + 6}px`;
                facilityDropdown.style.bottom = 'auto';
            }
            facilityDropdown.style.left = `${rect.left}px`;
            facilityDropdown.style.width = `${finalWidth}px`;
            facilityDropdown.style.minWidth = `${finalWidth}px`;
            facilityDropdown.style.maxWidth = `${finalWidth}px`;
            facilityDropdown.style.boxSizing = 'border-box';
            facilityDropdown.style.flexShrink = '0';
            facilityDropdown.style.flexGrow = '0';
            
            const options = facilityDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.facilityValue);
            });
        }

        function openFacilityDropdown(cell) {
            currentFacilityCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateFacilityDropdown();
            facilityDropdown.classList.add('visible');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionFacilityDropdown(cell);
                    requestAnimationFrame(() => {
                        positionFacilityDropdown(cell);
                    });
                });
            });
        }

        function closeFacilityDropdown() {
            if (currentFacilityCell) {
                currentFacilityCell.setAttribute('aria-expanded', 'false');
            }
            currentFacilityCell = null;
            facilityDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (facilityDropdown.contains(event.target)) return;
            if (event.target.closest('.facility-cell')) return;
            closeFacilityDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentFacilityCell) {
                requestAnimationFrame(() => {
                    positionFacilityDropdown(currentFacilityCell);
                });
            }
        });

        window.addEventListener('scroll', () => {
            if (currentFacilityCell && facilityDropdown.classList.contains('visible')) {
                closeFacilityDropdown();
            }
        }, true);

        const tableContainerFacility = document.querySelector('.table-container');
        if (tableContainerFacility) {
            tableContainerFacility.addEventListener('scroll', () => {
                if (currentFacilityCell && facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                }
            });
        }

        facilityCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentFacilityCell === cell && facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                } else {
                    openFacilityDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.facilityValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openFacilityDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeFacilityDropdown();
                    cell.blur();
                }
            });
        });

        // Выпадающие списки для отделов
        const departmentCells = document.querySelectorAll('.department-cell');
        const departmentDropdown = document.createElement('div');
        departmentDropdown.className = 'role-dropdown';
        document.body.appendChild(departmentDropdown);
        let currentDepartmentCell = null;

        function populateDepartmentDropdown(cell) {
            departmentDropdown.innerHTML = '';
            const facilityName = cell.dataset.facilityName || '';
            const departments = departmentsByFacility[facilityName] || [];
            
            departments.forEach(dept => {
                // Пропускаем отделы без названия
                if (!dept || !dept.name || dept.name.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = dept.id;
                option.textContent = dept.name;
                option.addEventListener('click', () => {
                    const targetCell = currentDepartmentCell;
                    if (!targetCell) return;
                    const currentId = targetCell.dataset.departmentId || '';
                    if (currentId === String(dept.id)) {
                        closeDepartmentDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.departmentId || '';
                    updateEmployeeCell(targetCell, employeeId, 'department_id', dept.id);
                    closeDepartmentDropdown();
                });
                departmentDropdown.appendChild(option);
            });
        }

        function positionDepartmentDropdown(cell) {
            if (!cell || !departmentDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            const cellWidth = cell.offsetWidth;
            const rectWidth = rect.width;
            const finalWidth = Math.max(cellWidth, rectWidth);
            const dropdownHeight = departmentDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            departmentDropdown.style.position = 'fixed';
            if (openUpward) {
                departmentDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                departmentDropdown.style.top = 'auto';
            } else {
                departmentDropdown.style.top = `${rect.bottom + 6}px`;
                departmentDropdown.style.bottom = 'auto';
            }
            departmentDropdown.style.left = `${rect.left}px`;
            departmentDropdown.style.width = `${finalWidth}px`;
            departmentDropdown.style.minWidth = `${finalWidth}px`;
            departmentDropdown.style.maxWidth = `${finalWidth}px`;
            departmentDropdown.style.boxSizing = 'border-box';
            departmentDropdown.style.flexShrink = '0';
            departmentDropdown.style.flexGrow = '0';
            
            const options = departmentDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.departmentId);
            });
        }

        function openDepartmentDropdown(cell) {
            currentDepartmentCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateDepartmentDropdown(cell);
            departmentDropdown.classList.add('visible');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionDepartmentDropdown(cell);
                    requestAnimationFrame(() => {
                        positionDepartmentDropdown(cell);
                    });
                });
            });
        }

        function closeDepartmentDropdown() {
            if (currentDepartmentCell) {
                currentDepartmentCell.setAttribute('aria-expanded', 'false');
            }
            currentDepartmentCell = null;
            departmentDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (departmentDropdown.contains(event.target)) return;
            if (event.target.closest('.department-cell')) return;
            closeDepartmentDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentDepartmentCell) {
                requestAnimationFrame(() => {
                    positionDepartmentDropdown(currentDepartmentCell);
                });
            }
        });

        window.addEventListener('scroll', () => {
            if (currentDepartmentCell && departmentDropdown.classList.contains('visible')) {
                closeDepartmentDropdown();
            }
        }, true);

        const tableContainerDepartment = document.querySelector('.table-container');
        if (tableContainerDepartment) {
            tableContainerDepartment.addEventListener('scroll', () => {
                if (currentDepartmentCell && departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                }
            });
        }

        departmentCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentDepartmentCell === cell && departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                } else {
                    openDepartmentDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.departmentId || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openDepartmentDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeDepartmentDropdown();
                    cell.blur();
                }
            });
        });

        filterSelectWrappers.forEach(wrapper => {
            const targetId = wrapper.dataset.target;
            const selectEl = document.getElementById(targetId);
            if (!selectEl) return;
            const button = wrapper.querySelector('.filter-select-btn');
            const labelEl = wrapper.querySelector('.filter-select-label');
            const optionButtons = wrapper.querySelectorAll('.filter-option');
            const resetBtn = document.querySelector(`.filter-reset-btn[data-target="${targetId}"]`);

            const syncUI = () => {
                const value = selectEl.value || '';
                const matchedOption = Array.from(selectEl.options).find(opt => opt.value === value);
                const labelText = matchedOption ? matchedOption.textContent : optionButtons[0]?.textContent || 'Все';
                if (labelEl) labelEl.textContent = labelText;
                optionButtons.forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.value === value);
                });
                // Показываем/скрываем кнопку сброса
                if (resetBtn) {
                    resetBtn.style.display = value ? 'flex' : 'none';
                }
            };

            optionButtons.forEach(btn => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const value = btn.dataset.value || '';
                    if (selectEl.value !== value) {
                        selectEl.value = value;
                        selectEl.dispatchEvent(new Event('change'));
                    } else {
                        selectEl.dispatchEvent(new Event('change'));
                    }
                    syncUI();
                    closeFilterSelectMenus();
                });
            });

            if (button) {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const isOpen = wrapper.classList.contains('open');
                    closeFilterSelectMenus();
                    if (!isOpen) {
                        wrapper.classList.add('open');
                        button.setAttribute('aria-expanded', 'true');
                    }
                });
            }

            selectEl.addEventListener('change', syncUI);

            // Обработчик клика по кнопке сброса
            if (resetBtn) {
                resetBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    selectEl.value = '';
                    selectEl.dispatchEvent(new Event('change'));
                    syncUI();
                    closeFilterSelectMenus();
                });
            }

            syncUI();
            filterSelectControllers.set(selectEl, { sync: syncUI });
        });

        document.addEventListener('click', (event) => {
            if (!event.target.closest('.filter-select')) {
                closeFilterSelectMenus();
            }
        });

        if (employeeForm) {
            employeeForm.addEventListener('submit', (event) => {
                event.preventDefault();
                if (employeeFormSubmit) {
                    employeeFormSubmit.disabled = true;
                    employeeFormSubmit.textContent = 'Сохранение...';
                }
                if (employeeFormError) {
                    employeeFormError.textContent = '';
                }

                const formData = new FormData(employeeForm);
                const payload = {
                    last_name: formData.get('last_name')?.trim(),
                    first_name: formData.get('first_name')?.trim(),
                    patronymic: formData.get('patronymic')?.trim(),
                    post: formData.get('post')?.trim(),
                    phone: formData.get('phone')?.trim(),
                    email: formData.get('email')?.trim(),
                    facility_id: formData.get('facility_id'),
                    department_id: formData.get('department_id'),
                    role: formData.get('role'),
                    login: formData.get('login')?.trim(),
                    password: formData.get('password')?.trim()
                };

                fetch('/admin/employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        closeEmployeeModal();
                        showStatus('Сотрудник добавлен', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 600);
                    } else {
                        if (employeeFormError) {
                            employeeFormError.textContent = data.message || 'Ошибка сохранения.';
                        }
                    }
                })
                .catch(() => {
                    if (employeeFormError) {
                        employeeFormError.textContent = 'Сеть недоступна. Попробуйте позже.';
                    }
                })
                .finally(() => {
                    if (employeeFormSubmit) {
                        employeeFormSubmit.disabled = false;
                        employeeFormSubmit.textContent = submitDefaultText || 'Сохранить';
                    }
                });
            });
        }

        handleFacilityChange();

        // Инициализация данных для dropdown'ов
        const modalFacilitySelect = document.getElementById('employeeFacilitySelect');
        const modalRoleSelect = document.getElementById('employeeRoleSelect');
        
        if (modalFacilitySelect) {
            modalSelectData.facility = {};
            // Получаем все option, даже если select скрыт
            const facilityOptions = modalFacilitySelect.options || modalFacilitySelect.querySelectorAll('option');
            Array.from(facilityOptions).forEach(opt => {
                if (opt.value !== '') {
                    modalSelectData.facility[opt.value] = opt.textContent.trim();
                }
            });
        }

        if (modalRoleSelect) {
            modalSelectData.role = {};
            const roleOptions = modalRoleSelect.options || modalRoleSelect.querySelectorAll('option');
            Array.from(roleOptions).forEach(opt => {
                if (opt.value !== '') {
                    modalSelectData.role[opt.value] = opt.textContent.trim();
                }
            });
        }

        // Инициализация данных для отдела (будет обновляться при выборе предприятия)
        modalSelectData.department = {};

        function populateModalDropdown(field, options) {
            if (!modalDropdown || !options || Object.keys(options).length === 0) {
                return;
            }
            
            modalDropdown.innerHTML = '';
            Object.entries(options).forEach(([value, label]) => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = value;
                option.textContent = label || value || '—';
                option.addEventListener('click', () => {
                    if (!currentModalSelect) return;
                    const btn = currentModalSelect;
                    const select = btn.parentElement.querySelector('select');
                    const labelSpan = btn.querySelector('.modal-select-label');
                    
                    if (select && labelSpan) {
                        select.value = value;
                        labelSpan.textContent = label;
                        btn.setAttribute('aria-expanded', 'false');
                        
                        // Триггерим change событие для совместимости с существующим кодом
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        // Если выбрано предприятие, обновляем отделы
                        const btnField = btn.dataset.field;
                        if (btnField === 'facility_id') {
                            handleFacilityChange();
                        }
                    }
                    closeModalDropdown();
                });
                modalDropdown.appendChild(option);
            });
        }

        function positionModalDropdown(btn) {
            if (!btn || !modalDropdown) return;
            const rect = btn.getBoundingClientRect();
            const dropdownHeight = modalDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
            
            modalDropdown.style.position = 'fixed';
            if (openUpward) {
                modalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                modalDropdown.style.top = 'auto';
            } else {
                modalDropdown.style.top = `${rect.bottom + 6}px`;
                modalDropdown.style.bottom = 'auto';
            }
            modalDropdown.style.left = `${rect.left}px`;
            modalDropdown.style.width = `${rect.width}px`;
            modalDropdown.style.minWidth = `${rect.width}px`;
            modalDropdown.style.maxWidth = `${rect.width}px`;
        }

        function openModalDropdown(btn) {
            if (!btn || btn.disabled) return;
            const field = btn.dataset.field;
            if (!field) return;
            
            // Маппинг полей к ключам в modalSelectData
            const fieldMap = {
                'facility_id': 'facility',
                'department_id': 'department',
                'role': 'role'
            };
            
            const dataKey = fieldMap[field] || field;
            if (!dataKey || !modalSelectData || !modalSelectData[dataKey] || Object.keys(modalSelectData[dataKey]).length === 0) {
                return;
            }
            
            currentModalSelect = btn;
            populateModalDropdown(field, modalSelectData[dataKey]);
            
            // Ждём, пока dropdown заполнится, затем позиционируем
            requestAnimationFrame(() => {
                positionModalDropdown(btn);
                modalDropdown.classList.add('visible');
                btn.setAttribute('aria-expanded', 'true');
            });
        }

        function closeModalDropdown() {
            if (!modalDropdown) return;
            modalDropdown.classList.remove('visible');
            if (currentModalSelect) {
                currentModalSelect.setAttribute('aria-expanded', 'false');
                currentModalSelect = null;
            }
        }

        // Обработчики для кнопок dropdown'ов
        const modalFacilityBtn = document.getElementById('modalFacilityBtn');
        const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
        const modalRoleBtn = document.getElementById('modalRoleBtn');

        [modalFacilityBtn, modalDepartmentBtn, modalRoleBtn].forEach(btn => {
            if (!btn) return;
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (btn.disabled) return;
                
                if (currentModalSelect === btn) {
                    closeModalDropdown();
                } else {
                    closeModalDropdown();
                    openModalDropdown(btn);
                }
            });
        });

        // Закрытие при клике вне dropdown'а
        document.addEventListener('click', (e) => {
            if (!modalDropdown.contains(e.target) && 
                !e.target.closest('.modal-select-btn')) {
                closeModalDropdown();
                // Закрываем также dropdown оборудования, если открыт
                if (typeof closeEquipmentModalDropdown === 'function') {
                    closeEquipmentModalDropdown();
                }
            }
        });

        // Закрытие по Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalDropdown.classList.contains('visible')) {
                closeModalDropdown();
            }
        });

        // Обработка удаления сотрудника
        const deleteEmployeeModal = document.getElementById('deleteEmployeeModal');
        const deleteEmployeeClose = document.getElementById('deleteEmployeeModalClose');
        const deleteEmployeeCancel = document.getElementById('deleteEmployeeCancel');
        const deleteEmployeeConfirm = document.getElementById('deleteEmployeeConfirm');
        const deleteEmployeeMessage = document.getElementById('deleteEmployeeMessage');
        let employeeToDelete = null;
        let employeeToDeleteRow = null;

        function openDeleteModal(employeeId, employeeRow) {
            if (!deleteEmployeeModal) return;
            
            employeeToDelete = employeeId;
            employeeToDeleteRow = employeeRow;
            
            // Получаем данные сотрудника для отображения в сообщении
            const lastName = employeeRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
            const firstName = employeeRow.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
            const patronymic = employeeRow.querySelector('td:nth-child(4)')?.textContent?.trim() || '';
            
            const fullName = [lastName, firstName, patronymic].filter(Boolean).join(' ') || 'сотрудника';
            if (deleteEmployeeMessage) {
                deleteEmployeeMessage.innerHTML = `Вы уверены, что хотите удалить сотрудника "${fullName}"?<br>Это действие нельзя будет отменить.`;
            }
            
            deleteEmployeeModal.setAttribute('aria-hidden', 'false');
            deleteEmployeeModal.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeDeleteModal() {
            if (!deleteEmployeeModal) {
                console.warn('deleteEmployeeModal не найден');
                return;
            }
            
            try {
                deleteEmployeeModal.setAttribute('aria-hidden', 'true');
                deleteEmployeeModal.classList.remove('visible');
                if (document.body) {
                    document.body.classList.remove('modal-open');
                }
                
                // Сбрасываем состояние кнопки "Удалить"
                if (deleteEmployeeConfirm) {
                    deleteEmployeeConfirm.disabled = false;
                    deleteEmployeeConfirm.textContent = 'Удалить';
                }
                
                employeeToDelete = null;
                employeeToDeleteRow = null;
            } catch (error) {
                console.error('Ошибка при закрытии модального окна:', error);
            }
        }

        // Обработчики открытия модального окна (делегирование событий)
        document.addEventListener('click', (event) => {
            // Проверяем, был ли клик по кнопке удаления или её содержимому (SVG)
            const deleteBtn = event.target.closest('.delete-employee-btn');
            if (deleteBtn) {
                event.preventDefault();
                event.stopPropagation();
                const employeeId = deleteBtn.getAttribute('data-employee-id');
                if (!employeeId) return;
                
                const row = deleteBtn.closest('tr');
                if (row && employeeId) {
                    openDeleteModal(parseInt(employeeId), row);
                }
            }
        });

        // Обработчики закрытия модального окна
        if (deleteEmployeeClose) {
            deleteEmployeeClose.addEventListener('click', closeDeleteModal);
        }
        if (deleteEmployeeCancel) {
            deleteEmployeeCancel.addEventListener('click', closeDeleteModal);
        }

        // Закрытие по клику на overlay
        if (deleteEmployeeModal) {
            deleteEmployeeModal.addEventListener('click', (event) => {
                if (event.target === deleteEmployeeModal) {
                    closeDeleteModal();
                }
            });
        }

        // Подтверждение удаления
        if (deleteEmployeeConfirm) {
            deleteEmployeeConfirm.addEventListener('click', async () => {
                if (!employeeToDelete) return;
                
                deleteEmployeeConfirm.disabled = true;
                deleteEmployeeConfirm.textContent = 'Удаление...';
                
                try {
                    const response = await fetch(`/admin/employees/${employeeToDelete}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.error('Ошибка парсинга ответа:', parseError);
                        // Если запись уже удалена из таблицы, закрываем модальное окно
                        if (!employeeToDeleteRow || !document.contains(employeeToDeleteRow)) {
                            closeDeleteModal();
                            return;
                        }
                        throw new Error('Не удалось обработать ответ сервера');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    if (data.success) {
                        // Удаляем строку из таблицы
                        if (employeeToDeleteRow && document.contains(employeeToDeleteRow)) {
                            employeeToDeleteRow.remove();
                            
                            // Обновляем нумерацию строк
                            document.querySelectorAll('.data-table tbody tr').forEach((row, index) => {
                                const numberCell = row.querySelector('.number-column');
                                if (numberCell) {
                                    numberCell.textContent = index + 1;
                                }
                            });
                            
                            // Показываем уведомление об успехе
                            if (typeof showStatus === 'function') {
                                showStatus('Изменения сохранены', 'success');
                            }
                        }
                        // Закрываем модальное окно
                        closeDeleteModal();
                    } else {
                        if (typeof showStatus === 'function') {
                            showStatus(data.message || 'Не удалось удалить сотрудника', 'error');
                        }
                        deleteEmployeeConfirm.disabled = false;
                        deleteEmployeeConfirm.textContent = 'Удалить';
                    }
                } catch (error) {
                    console.error('Ошибка при удалении сотрудника:', error);
                    // Если запись уже удалена из таблицы, закрываем модальное окно
                    if (!employeeToDeleteRow || !document.contains(employeeToDeleteRow)) {
                        closeDeleteModal();
                        return;
                    }
                    if (typeof showStatus === 'function') {
                        showStatus('Произошла ошибка при удалении сотрудника', 'error');
                    }
                    deleteEmployeeConfirm.disabled = false;
                    deleteEmployeeConfirm.textContent = 'Удалить';
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                    return;
                }
                if (facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                    return;
                }
                if (departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                    return;
                }
                if (deleteEmployeeModal && deleteEmployeeModal.classList.contains('visible')) {
                    closeDeleteModal();
                    return;
                }
                if (activeModal) {
                    closeEmployeeModal();
                }
            }
        });

        applyTableFilters();
        {% endif %}

        {% if section == 'warehouse' %}
        // JavaScript для страницы склада
        const warehouseSearchInput = document.getElementById('warehouseSearch');
        const warehouseFilterToggle = document.getElementById('warehouseFilterToggle');
        const warehouseFilterDropdown = document.getElementById('warehouseFilterDropdown');
        const facilityWarehouseFilter = document.getElementById('facilityWarehouseFilter');
        const warehouseAddressFilter = document.getElementById('warehouseAddressFilter');
        const sparePartFilter = document.getElementById('sparePartFilter');
        const warehouseTableRows = document.querySelectorAll('.data-table tbody tr');
        const warehouseResetFiltersBtn = document.getElementById('warehouseResetFilters');
        const addPartBtn = document.getElementById('addPartBtn');
        const partModal = document.getElementById('partModal');
        const partModalClose = document.getElementById('partModalClose');
        const partModalCancel = document.getElementById('partModalCancel');
        const partForm = document.getElementById('partForm');
        const partFormError = document.getElementById('partFormError');
        const partFormSubmit = document.getElementById('partFormSubmit');
        const partFacilitySelect = document.getElementById('partFacilitySelect');
        const partWarehouseSelect = document.getElementById('partWarehouseSelect');
        const modalPartFacilityBtn = document.getElementById('modalPartFacilityBtn');
        const modalPartWarehouseBtn = document.getElementById('modalPartWarehouseBtn');
        
        // Данные для модального окна
        const warehousesData = {{ warehouse_choices|tojson }};
        const warehouseFacilityMap = {};
        warehousesData.forEach(wh => {
            const facilityId = wh.facility_id ? String(wh.facility_id) : '';
            if (facilityId) {
                if (!warehouseFacilityMap[facilityId]) {
                    warehouseFacilityMap[facilityId] = [];
                }
                warehouseFacilityMap[facilityId].push({
                    id: String(wh.id),
                    name: wh.department || wh.type || '—'
                });
            }
        });

        function applyWarehouseRowStriping() {
            let visibleIndex = 0;
            warehouseTableRows.forEach(row => {
                if (row.style.display === 'none') {
                    row.classList.remove('alt-row');
                    return;
                }
                const isAlt = visibleIndex % 2 === 1;
                row.classList.toggle('alt-row', isAlt);
                visibleIndex += 1;
            });
        }

        function applyWarehouseTableFilters() {
            const searchValue = warehouseSearchInput ? warehouseSearchInput.value.toLowerCase().trim() : '';
            const facilityValue = facilityWarehouseFilter ? facilityWarehouseFilter.value : '';
            const warehouseValue = warehouseAddressFilter ? warehouseAddressFilter.value : '';
            const sparePartValue = sparePartFilter ? sparePartFilter.value : '';

            warehouseTableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowFacility = (row.dataset.facility || '').toLowerCase();
                const rowWarehouse = (row.dataset.warehouse || '').toLowerCase();
                const rowSparePart = (row.dataset.sparePart || '').toLowerCase();

                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesFacility = facilityValue === '' || rowFacility === facilityValue.toLowerCase();
                const matchesWarehouse = warehouseValue === '' || rowWarehouse === warehouseValue.toLowerCase();
                const matchesSparePart = sparePartValue === '' || rowSparePart === sparePartValue.toLowerCase();

                row.style.display = (matchesSearch && matchesFacility && matchesWarehouse && matchesSparePart) ? '' : 'none';
            });

            applyWarehouseRowStriping();
        }

        if (warehouseSearchInput) {
            warehouseSearchInput.addEventListener('input', applyWarehouseTableFilters);
        }

        [facilityWarehouseFilter, warehouseAddressFilter, sparePartFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', applyWarehouseTableFilters);
            }
        });

        const warehouseFilterSelectWrappers = document.querySelectorAll('#warehouseFilterDropdown .filter-select[data-target]');
        const warehouseFilterSelectControllers = new Map();

        function closeWarehouseFilterSelectMenus() {
            warehouseFilterSelectWrappers.forEach(wrapper => {
                wrapper.classList.remove('open');
                const btn = wrapper.querySelector('.filter-select-btn');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (warehouseFilterToggle && warehouseFilterDropdown) {
            warehouseFilterToggle.addEventListener('click', () => {
                warehouseFilterDropdown.classList.toggle('active');
                warehouseFilterToggle.classList.toggle('active');
                if (!warehouseFilterDropdown.classList.contains('active')) {
                    closeWarehouseFilterSelectMenus();
                }
            });

            document.addEventListener('click', (event) => {
                if (!warehouseFilterDropdown.contains(event.target) && !warehouseFilterToggle.contains(event.target)) {
                    warehouseFilterDropdown.classList.remove('active');
                    warehouseFilterToggle.classList.remove('active');
                    closeWarehouseFilterSelectMenus();
                }
            });
        }

        if (warehouseResetFiltersBtn) {
            warehouseResetFiltersBtn.addEventListener('click', () => {
                if (warehouseSearchInput) warehouseSearchInput.value = '';
                if (facilityWarehouseFilter) facilityWarehouseFilter.value = '';
                if (warehouseAddressFilter) warehouseAddressFilter.value = '';
                if (sparePartFilter) sparePartFilter.value = '';
                applyWarehouseTableFilters();
                warehouseFilterSelectControllers.forEach(controller => controller.sync());
            });
        }

        // Инициализация кастомных фильтров для склада
        warehouseFilterSelectWrappers.forEach(wrapper => {
            const targetId = wrapper.dataset.target;
            const nativeSelect = document.getElementById(targetId);
            if (!nativeSelect) return;

            const btn = wrapper.querySelector('.filter-select-btn');
            const label = btn?.querySelector('.filter-select-label');
            const optionsList = wrapper.querySelector('.filter-options-list');
            const resetBtn = wrapper.parentElement.querySelector('.filter-reset-btn');

            function syncSelect() {
                const selectedOption = nativeSelect.options[nativeSelect.selectedIndex];
                const selectedValue = nativeSelect.value;
                const selectedText = selectedOption ? selectedOption.textContent : 'Все';

                if (label) {
                    label.textContent = selectedText;
                }

                if (resetBtn) {
                    resetBtn.style.display = selectedValue ? '' : 'none';
                }

                if (optionsList) {
                    optionsList.querySelectorAll('.filter-option').forEach(opt => {
                        opt.classList.toggle('selected', opt.dataset.value === selectedValue);
                    });
                }
            }

            function selectOption(value) {
                nativeSelect.value = value;
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                syncSelect();
                closeWarehouseFilterSelectMenus();
            }

            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = wrapper.classList.contains('open');
                    closeWarehouseFilterSelectMenus();
                    if (!isOpen) {
                        wrapper.classList.add('open');
                        btn.setAttribute('aria-expanded', 'true');
                    }
                });
            }

            if (optionsList) {
                optionsList.querySelectorAll('.filter-option').forEach(opt => {
                    opt.addEventListener('click', () => {
                        selectOption(opt.dataset.value);
                    });
                });
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectOption('');
                });
            }

            nativeSelect.addEventListener('change', syncSelect);
            syncSelect();

            warehouseFilterSelectControllers.set(targetId, { sync: syncSelect });
        });

        function openPartModal() {
            if (!partModal) return;
            partModal.classList.add('visible');
            partModal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            
            if (partForm) {
                partForm.reset();
            }
            
            // Сбрасываем кастомные dropdown'ы
            if (modalPartFacilityBtn) {
                const label = modalPartFacilityBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Выберите предприятие';
                modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
            }
            if (modalPartWarehouseBtn) {
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Сначала выберите предприятие';
                modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                modalPartWarehouseBtn.disabled = true;
            }
            
            if (partFacilitySelect) {
                partFacilitySelect.value = '';
                populateWarehouseOptions('');
            }
            if (partFormError) {
                partFormError.textContent = '';
            }
            
            const firstInput = partForm ? partForm.querySelector('input, .modal-select-btn') : null;
            if (firstInput) {
                firstInput.focus();
            }
        }

        function closePartModal() {
            if (!partModal) return;
            partModal.classList.remove('visible');
            partModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }

        function populateWarehouseOptions(facilityId) {
            if (!partWarehouseSelect) return;
            
            partWarehouseSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = facilityId ? 'Выберите склад' : 'Сначала выберите предприятие';
            placeholder.disabled = !facilityId;
            placeholder.selected = true;
            partWarehouseSelect.appendChild(placeholder);

            if (!facilityId) {
                partWarehouseSelect.disabled = true;
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.disabled = true;
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = 'Сначала выберите предприятие';
                    }
                }
                return;
            }

            const warehouses = warehouseFacilityMap[facilityId] || [];
            if (warehouses.length === 0) {
                placeholder.textContent = 'Для выбранного предприятия нет складов';
                partWarehouseSelect.disabled = true;
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.disabled = true;
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = 'Для выбранного предприятия нет складов';
                    }
                }
                return;
            }
            
            warehouses.forEach(wh => {
                const option = document.createElement('option');
                option.value = wh.id;
                option.textContent = wh.name;
                partWarehouseSelect.appendChild(option);
            });
            partWarehouseSelect.disabled = false;
            if (modalPartWarehouseBtn) {
                modalPartWarehouseBtn.disabled = false;
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = 'Выберите склад';
                }
            }
        }

        function handlePartFacilityChange() {
            if (!partFacilitySelect) return;
            const facilityId = partFacilitySelect.value;
            populateWarehouseOptions(facilityId);
            if (partWarehouseSelect) {
                partWarehouseSelect.value = '';
            }
            const modalPartWarehouseBtn = document.getElementById('modalPartWarehouseBtn');
            if (modalPartWarehouseBtn) {
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = facilityId ? 'Выберите склад' : 'Сначала выберите предприятие';
                }
            }
        }

        if (addPartBtn) {
            addPartBtn.addEventListener('click', () => {
                closeWarehouseFilterSelectMenus();
                openPartModal();
            });
        }

        [partModalClose, partModalCancel].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    closePartModal();
                });
            }
        });

        if (partFacilitySelect) {
            partFacilitySelect.addEventListener('change', handlePartFacilityChange);
        }

        // Кастомные dropdown'ы для модального окна склада
        if (modalPartFacilityBtn) {
            modalPartFacilityBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = modalPartFacilityBtn.getAttribute('aria-expanded') === 'true';
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                }
                modalPartFacilityBtn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
                if (!isOpen) {
                    partFacilitySelect.focus();
                }
            });
        }

        if (modalPartWarehouseBtn) {
            modalPartWarehouseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalPartWarehouseBtn.disabled) return;
                const isOpen = modalPartWarehouseBtn.getAttribute('aria-expanded') === 'true';
                if (modalPartFacilityBtn) {
                    modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
                }
                modalPartWarehouseBtn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
                if (!isOpen) {
                    partWarehouseSelect.focus();
                }
            });
        }

        // Синхронизация кастомных кнопок с нативными select
        if (partFacilitySelect) {
            partFacilitySelect.addEventListener('change', () => {
                const selectedOption = partFacilitySelect.options[partFacilitySelect.selectedIndex];
                if (modalPartFacilityBtn) {
                    const label = modalPartFacilityBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : 'Выберите предприятие';
                    }
                    modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (partWarehouseSelect) {
            partWarehouseSelect.addEventListener('change', () => {
                const selectedOption = partWarehouseSelect.options[partWarehouseSelect.selectedIndex];
                if (modalPartWarehouseBtn) {
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : 'Выберите склад';
                    }
                    modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Обработка отправки формы
        if (partForm) {
            partForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!partFormSubmit) return;
                partFormSubmit.disabled = true;
                const originalText = partFormSubmit.textContent;
                partFormSubmit.textContent = 'Сохранение...';
                
                if (partFormError) {
                    partFormError.textContent = '';
                }

                const formData = {
                    spare_part_name: document.getElementById('partSparePartName')?.value.trim() || '',
                    quantity: document.getElementById('partQuantity')?.value || '',
                    warehouse_id: partWarehouseSelect?.value || ''
                };

                try {
                    const response = await fetch('{{ url_for("admin_warehouse.create_part") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        closePartModal();
                        location.reload();
                    } else {
                        if (partFormError) {
                            partFormError.textContent = data.message || 'Не удалось добавить деталь';
                        }
                        partFormSubmit.disabled = false;
                        partFormSubmit.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Ошибка при добавлении детали:', error);
                    if (partFormError) {
                        partFormError.textContent = 'Произошла ошибка при добавлении детали';
                    }
                    partFormSubmit.disabled = false;
                    partFormSubmit.textContent = originalText;
                }
            });
        }

        // Закрытие модального окна по клику вне его
        if (partModal) {
            partModal.addEventListener('click', (e) => {
                if (e.target === partModal) {
                    closePartModal();
                }
            });
        }

        // Закрытие модального окна по Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && partModal && partModal.classList.contains('visible')) {
                closePartModal();
            }
        });

        applyWarehouseTableFilters();
        {% endif %}
    </script>

    {% if section == 'equipment' %}
    <script>
        // JavaScript для работы с таблицей оборудования
        (function() {
            const equipmentSearch = document.getElementById('equipmentSearch');
            const equipmentFilterToggle = document.getElementById('equipmentFilterToggle');
            const equipmentFilterDropdown = document.getElementById('equipmentFilterDropdown');
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const locationFilter = document.getElementById('locationFilter');
            const resetEquipmentFilters = document.getElementById('resetEquipmentFilters');
            const equipmentTable = document.getElementById('equipmentTable');
            const equipmentStatusBox = document.getElementById('equipmentTableUpdateStatus');
            const addEquipmentBtn = document.getElementById('addEquipmentBtn');
            const equipmentModal = document.getElementById('equipmentModal');
            const equipmentModalClose = document.getElementById('equipmentModalClose');
            const equipmentModalCancel = document.getElementById('equipmentModalCancel');
            const deleteEquipmentModal = document.getElementById('deleteEquipmentModal');
            const deleteEquipmentClose = document.getElementById('deleteEquipmentModalClose');
            const deleteEquipmentCancel = document.getElementById('deleteEquipmentCancel');
            const deleteEquipmentConfirm = document.getElementById('deleteEquipmentConfirm');
            const deleteEquipmentMessage = document.getElementById('deleteEquipmentMessage');

            let equipmentToDelete = null;
            let equipmentToDeleteRow = null;
            let selectedEquipmentRow = null;
            let equipmentContextMenu = null;

            // Создаем контекстное меню
            function createContextMenu() {
                if (equipmentContextMenu) return equipmentContextMenu;
                
                equipmentContextMenu = document.createElement('div');
                equipmentContextMenu.className = 'context-menu';
                equipmentContextMenu.innerHTML = `
                    <button type="button" class="context-menu-item" id="equipmentPassportBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Паспорт
                    </button>
                    <button type="button" class="context-menu-item danger" id="equipmentDeleteBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Удалить
                    </button>
                `;
                document.body.appendChild(equipmentContextMenu);
                
                const passportBtn = document.getElementById('equipmentPassportBtn');
                const deleteBtn = document.getElementById('equipmentDeleteBtn');
                
                if (passportBtn) {
                    passportBtn.addEventListener('click', () => {
                        if (selectedEquipmentRow) {
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            if (equipmentId) {
                                window.location.href = `/admin/equipment/passport/${equipmentId}`;
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (selectedEquipmentRow) {
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            if (equipmentId) {
                                openDeleteEquipmentModal(parseInt(equipmentId), selectedEquipmentRow);
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                return equipmentContextMenu;
            }

            function showContextMenu(event, row) {
                event.preventDefault();
                event.stopPropagation();
                
                const menu = createContextMenu();
                selectedEquipmentRow = row;
                
                menu.style.display = 'block';
                menu.style.left = event.pageX + 'px';
                menu.style.top = event.pageY + 'px';
                
                // Закрываем меню при клике вне его
                setTimeout(() => {
                    document.addEventListener('click', hideContextMenu, { once: true });
                }, 0);
            }

            function hideContextMenu() {
                if (equipmentContextMenu) {
                    equipmentContextMenu.style.display = 'none';
                }
            }

            // Функция для получения всех строк таблицы
            function getAllEquipmentRows() {
                return equipmentTable ? equipmentTable.querySelectorAll('tbody tr') : [];
            }

            // Выделение строки при одинарном клике
            function setupRowHandlers() {
                const rows = getAllEquipmentRows();
                rows.forEach(row => {
                    // Удаляем старые обработчики, если они есть
                    const newRow = row.cloneNode(true);
                    row.parentNode.replaceChild(newRow, row);
                    
                    newRow.addEventListener('click', (e) => {
                        // Игнорируем клики по редактируемым ячейкам
                        if (e.target.closest('.editable-cell[contenteditable="true"]')) {
                            return;
                        }
                        
                        // Убираем выделение с других строк
                        getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                        // Выделяем текущую строку
                        newRow.classList.add('selected');
                        selectedEquipmentRow = newRow;
                    });

                    // Контекстное меню при правом клике
                    newRow.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        // Выделяем строку
                        getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                        newRow.classList.add('selected');
                        selectedEquipmentRow = newRow;
                        showContextMenu(e, newRow);
                    });
                });
            }

            setupRowHandlers();

            // Функция показа статуса
            function showEquipmentStatus(message, state = 'info') {
                if (!equipmentStatusBox) return;
                equipmentStatusBox.textContent = message;
                equipmentStatusBox.dataset.state = state;
                equipmentStatusBox.classList.remove('visible');
                if (message) {
                    requestAnimationFrame(() => equipmentStatusBox.classList.add('visible'));
                    setTimeout(() => {
                        equipmentStatusBox.classList.remove('visible');
                    }, 5000);
                }
            }

            // Функция отката ячейки
            function revertEquipmentCell(cell) {
                if (!cell) return;
                cell.textContent = cell.dataset.originalValue || '';
            }

            // Обновление ячейки оборудования
            function updateEquipmentCell(cell, equipmentId, field, value) {
                cell.classList.add('saving');
                fetch(`/admin/equipment/${equipmentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ field, value })
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    cell.classList.remove('saving');
                    if (ok && data.success) {
                        cell.textContent = data.value || '';
                        cell.dataset.originalValue = cell.textContent;
                        showEquipmentStatus('Изменения сохранены', 'success');
                    } else {
                        cell.classList.add('error');
                        revertEquipmentCell(cell);
                        showEquipmentStatus(data.message || 'Ошибка сохранения', 'error');
                        setTimeout(() => cell.classList.remove('error'), 1500);
                    }
                })
                .catch(() => {
                    cell.classList.remove('saving');
                    cell.classList.add('error');
                    revertEquipmentCell(cell);
                    showEquipmentStatus('Сеть недоступна. Попробуйте позже.', 'error');
                    setTimeout(() => cell.classList.remove('error'), 1500);
                });
            }

            // Редактирование ячеек
            function setupEditableCells() {
                const editableEquipmentCells = equipmentTable ? equipmentTable.querySelectorAll('td.editable-cell[data-field]') : [];
                editableEquipmentCells.forEach(cell => {
                // Активация редактирования по двойному клику
                cell.addEventListener('dblclick', () => {
                    cell.contentEditable = 'true';
                    cell.dataset.originalValue = cell.textContent.trim();
                    cell.focus();
                    const range = document.createRange();
                    range.selectNodeContents(cell);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                cell.addEventListener('keydown', (event) => {
                    if (cell.contentEditable !== 'true') return;
                    
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        cell.blur();
                    }
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        revertEquipmentCell(cell);
                        cell.blur();
                    }
                });

                cell.addEventListener('blur', () => {
                    cell.contentEditable = 'false';
                    
                    const originalValue = cell.dataset.originalValue ?? '';
                    const newValue = cell.textContent.trim();
                    if (newValue === originalValue) {
                        return;
                    }
                    const row = cell.closest('tr');
                    const equipmentId = row ? row.dataset.equipmentId : null;
                    if (!equipmentId) {
                        revertEquipmentCell(cell);
                        showEquipmentStatus('Не удалось определить оборудование.', 'error');
                        return;
                    }
                    const field = cell.dataset.field;
                    if (!field) {
                        revertEquipmentCell(cell);
                        return;
                    }
                    updateEquipmentCell(cell, equipmentId, field, newValue);
                });
            });
            }

            setupEditableCells();

            // Фильтрация таблицы
            function applyEquipmentFilters() {
                const searchValue = equipmentSearch ? equipmentSearch.value.toLowerCase().trim() : '';
                const typeValue = typeFilter ? typeFilter.value : '';
                const statusValue = statusFilter ? statusFilter.value : '';
                const locationValue = locationFilter ? locationFilter.value : '';

                getAllEquipmentRows().forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const rowType = (row.dataset.type || '').toLowerCase();
                    const rowStatus = (row.dataset.status || '').toLowerCase();
                    const rowLocation = (row.dataset.location || '').toLowerCase();

                    const matchesSearch = searchValue === '' || text.includes(searchValue);
                    const matchesType = typeValue === '' || rowType === typeValue.toLowerCase();
                    const matchesStatus = statusValue === '' || rowStatus === statusValue.toLowerCase();
                    const matchesLocation = locationValue === '' || rowLocation === locationValue.toLowerCase();

                    if (matchesSearch && matchesType && matchesStatus && matchesLocation) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Обновляем нумерацию
                let visibleIndex = 0;
                getAllEquipmentRows().forEach(row => {
                    if (row.style.display !== 'none') {
                        const numberCell = row.querySelector('.number-column');
                        if (numberCell) {
                            numberCell.textContent = visibleIndex + 1;
                        }
                        visibleIndex++;
                    }
                });
            }

            // Поиск
            if (equipmentSearch) {
                equipmentSearch.addEventListener('input', applyEquipmentFilters);
            }

            // Фильтры
            if (equipmentFilterToggle && equipmentFilterDropdown) {
                equipmentFilterToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    equipmentFilterDropdown.classList.toggle('active');
                    equipmentFilterToggle.classList.toggle('active');
                });

                [typeFilter, statusFilter, locationFilter].forEach(filter => {
                    if (filter) {
                        filter.addEventListener('change', applyEquipmentFilters);
                    }
                });

                if (resetEquipmentFilters) {
                    resetEquipmentFilters.addEventListener('click', () => {
                        if (equipmentSearch) equipmentSearch.value = '';
                        if (typeFilter) typeFilter.value = '';
                        if (statusFilter) statusFilter.value = '';
                        if (locationFilter) locationFilter.value = '';
                        applyEquipmentFilters();
                    });
                }

                document.addEventListener('click', (event) => {
                    if (!equipmentFilterDropdown.contains(event.target) && !equipmentFilterToggle.contains(event.target)) {
                        equipmentFilterDropdown.classList.remove('active');
                        equipmentFilterToggle.classList.remove('active');
                    }
                });
            }

            // Модальное окно добавления
            const equipmentForm = document.getElementById('equipmentForm');
            const equipmentFormSubmit = document.getElementById('equipmentFormSubmit');
            const equipmentFormError = document.getElementById('equipmentFormError');
            const sparePartTypesList = document.getElementById('sparePartTypesList');
            const addSparePartTypeBtn = document.getElementById('addSparePartTypeBtn');
            const sparePartTypeSelect = document.getElementById('sparePartTypeSelect');
            let selectedSparePartTypes = [];

            function openEquipmentModal() {
                if (!equipmentModal) return;
                // Закрываем dropdown сотрудников, если открыт
                if (typeof closeModalDropdown === 'function') {
                    closeModalDropdown();
                }
                equipmentModal.classList.add('visible');
                equipmentModal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('modal-open');
                // Сброс формы
                if (equipmentForm) {
                    equipmentForm.reset();
                    selectedSparePartTypes = [];
                    if (sparePartTypesList) {
                        sparePartTypesList.innerHTML = '';
                    }
                }
                // Сброс выпадающих списков
                closeEquipmentModalDropdown();
                const equipmentBtns = [equipmentTypeBtn, equipmentImageBtn, equipmentMaintenanceBtn, equipmentDepartmentBtn, sparePartTypeBtn];
                equipmentBtns.forEach(btn => {
                    if (btn) {
                        const label = btn.querySelector('.modal-select-label');
                        if (label) {
                            const defaultTexts = {
                                'equipmentTypeBtn': 'Выберите тип',
                                'equipmentImageBtn': 'Выберите изображение',
                                'equipmentMaintenanceBtn': 'Выберите периодичность',
                                'equipmentDepartmentBtn': 'Выберите отдел',
                                'sparePartTypeBtn': 'Выберите тип детали'
                            };
                            label.textContent = defaultTexts[btn.id] || 'Выберите...';
                        }
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
                if (equipmentFormError) {
                    equipmentFormError.textContent = '';
                }
            }

            function closeEquipmentModal() {
                if (!equipmentModal) return;
                equipmentModal.classList.remove('visible');
                equipmentModal.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('modal-open');
                closeEquipmentModalDropdown();
                // Сброс формы
                if (equipmentForm) {
                    equipmentForm.reset();
                    selectedSparePartTypes = [];
                    if (sparePartTypesList) {
                        sparePartTypesList.innerHTML = '';
                    }
                }
                if (equipmentFormError) {
                    equipmentFormError.textContent = '';
                }
            }

            // Добавление типа детали
            if (addSparePartTypeBtn && sparePartTypeSelect) {
                addSparePartTypeBtn.addEventListener('click', () => {
                    const selectedType = sparePartTypeSelect.value;
                    if (selectedType && !selectedSparePartTypes.includes(selectedType)) {
                        selectedSparePartTypes.push(selectedType);
                        updateSparePartTypesList();
                        sparePartTypeSelect.value = '';
                        // Обновляем кнопку выпадающего списка
                        const btn = document.getElementById('sparePartTypeBtn');
                        if (btn) {
                            const label = btn.querySelector('.modal-select-label');
                            if (label) label.textContent = 'Выберите тип детали';
                        }
                    }
                });
            }

            function updateSparePartTypesList() {
                if (!sparePartTypesList) return;
                sparePartTypesList.innerHTML = '';
                selectedSparePartTypes.forEach((type, index) => {
                    const tag = document.createElement('div');
                    tag.className = 'spare-part-type-tag';
                    tag.style.cssText = 'display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f0f0f0; border-radius: 6px; font-size: 14px;';
                    tag.innerHTML = `
                        <span>${type}</span>
                        <button type="button" class="remove-tag-btn" data-index="${index}" style="background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;
                    const removeBtn = tag.querySelector('.remove-tag-btn');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', () => {
                            selectedSparePartTypes.splice(index, 1);
                            updateSparePartTypesList();
                        });
                    }
                    sparePartTypesList.appendChild(tag);
                });
            }

            // Инициализация данных для выпадающих списков оборудования
            const equipmentModalSelectData = {};
            
            // Типы оборудования
            const equipmentTypeSelect = document.getElementById('equipmentTypeSelect');
            if (equipmentTypeSelect) {
                equipmentModalSelectData.equipment_type = {};
                Array.from(equipmentTypeSelect.options).forEach(opt => {
                    if (opt.value !== '') {
                        equipmentModalSelectData.equipment_type[opt.value] = opt.textContent.trim();
                    }
                });
            }
            
            // Изображения
            const equipmentImageSelect = document.getElementById('equipmentImageSelect');
            if (equipmentImageSelect) {
                equipmentModalSelectData.image_path = {};
                Array.from(equipmentImageSelect.options).forEach(opt => {
                    if (opt.value !== '') {
                        equipmentModalSelectData.image_path[opt.value] = opt.textContent.trim();
                    }
                });
            }
            
            // Периодичность ТО
            const equipmentMaintenanceSelect = document.getElementById('equipmentMaintenanceSelect');
            if (equipmentMaintenanceSelect) {
                equipmentModalSelectData.maintenance_frequency = {};
                Array.from(equipmentMaintenanceSelect.options).forEach(opt => {
                    if (opt.value !== '') {
                        equipmentModalSelectData.maintenance_frequency[opt.value] = opt.textContent.trim();
                    }
                });
            }
            
            // Отделы
            const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
            if (equipmentDepartmentSelect) {
                equipmentModalSelectData.department_id = {};
                Array.from(equipmentDepartmentSelect.options).forEach(opt => {
                    if (opt.value !== '') {
                        const deptName = opt.textContent.trim();
                        equipmentModalSelectData.department_id[opt.value] = deptName;
                    }
                });
            }
            
            // Типы деталей
            const sparePartTypeSelect = document.getElementById('sparePartTypeSelect');
            if (sparePartTypeSelect) {
                equipmentModalSelectData.spare_part_type = {};
                Array.from(sparePartTypeSelect.options).forEach(opt => {
                    if (opt.value !== '') {
                        equipmentModalSelectData.spare_part_type[opt.value] = opt.textContent.trim();
                    }
                });
            }

            // Используем тот же modalDropdown, что и для формы сотрудников
            const equipmentModalDropdown = document.getElementById('modalDropdown');
            let currentEquipmentModalSelect = null;

            function populateEquipmentModalDropdown(field, options) {
                if (!equipmentModalDropdown || !options || Object.keys(options).length === 0) {
                    return;
                }
                
                equipmentModalDropdown.innerHTML = '';
                Object.entries(options).forEach(([value, label]) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = value;
                    option.textContent = label || value || '—';
                    option.addEventListener('click', () => {
                        if (!currentEquipmentModalSelect) return;
                        const btn = currentEquipmentModalSelect;
                        const select = btn.parentElement.querySelector('select');
                        const labelSpan = btn.querySelector('.modal-select-label');
                        
                        if (select && labelSpan) {
                            select.value = value;
                            labelSpan.textContent = label;
                            btn.setAttribute('aria-expanded', 'false');
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        closeEquipmentModalDropdown();
                    });
                    equipmentModalDropdown.appendChild(option);
                });
            }

            function positionEquipmentModalDropdown(btn) {
                if (!btn || !equipmentModalDropdown) return;
                const rect = btn.getBoundingClientRect();
                const dropdownHeight = equipmentModalDropdown.offsetHeight || 200;
                const viewportHeight = window.innerHeight;
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
                
                equipmentModalDropdown.style.position = 'fixed';
                if (openUpward) {
                    equipmentModalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    equipmentModalDropdown.style.top = 'auto';
                } else {
                    equipmentModalDropdown.style.top = `${rect.bottom + 6}px`;
                    equipmentModalDropdown.style.bottom = 'auto';
                }
                equipmentModalDropdown.style.left = `${rect.left}px`;
                equipmentModalDropdown.style.width = `${rect.width}px`;
                equipmentModalDropdown.style.minWidth = `${rect.width}px`;
                equipmentModalDropdown.style.maxWidth = `${rect.width}px`;
            }

            function openEquipmentModalDropdown(btn) {
                if (!btn || btn.disabled) return;
                const field = btn.dataset.field;
                if (!field) return;
                
                const dataKey = field;
                if (!dataKey || !equipmentModalSelectData || !equipmentModalSelectData[dataKey] || Object.keys(equipmentModalSelectData[dataKey]).length === 0) {
                    return;
                }
                
                currentEquipmentModalSelect = btn;
                populateEquipmentModalDropdown(field, equipmentModalSelectData[dataKey]);
                
                requestAnimationFrame(() => {
                    positionEquipmentModalDropdown(btn);
                    equipmentModalDropdown.classList.add('visible');
                    btn.setAttribute('aria-expanded', 'true');
                });
            }

            function closeEquipmentModalDropdown() {
                if (!equipmentModalDropdown) return;
                equipmentModalDropdown.classList.remove('visible');
                if (currentEquipmentModalSelect) {
                    currentEquipmentModalSelect.setAttribute('aria-expanded', 'false');
                    currentEquipmentModalSelect = null;
                }
            }

            // Обработчики для кнопок выпадающих списков
            const equipmentTypeBtn = document.getElementById('equipmentTypeBtn');
            const equipmentImageBtn = document.getElementById('equipmentImageBtn');
            const equipmentMaintenanceBtn = document.getElementById('equipmentMaintenanceBtn');
            const equipmentDepartmentBtn = document.getElementById('equipmentDepartmentBtn');
            const sparePartTypeBtn = document.getElementById('sparePartTypeBtn');

            [equipmentTypeBtn, equipmentImageBtn, equipmentMaintenanceBtn, equipmentDepartmentBtn, sparePartTypeBtn].forEach(btn => {
                if (!btn) return;
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (btn.disabled) return;
                    
                    if (currentEquipmentModalSelect === btn) {
                        closeEquipmentModalDropdown();
                    } else {
                        closeEquipmentModalDropdown();
                        openEquipmentModalDropdown(btn);
                    }
                });
            });

            // Закрытие при клике вне dropdown'а обрабатывается в общем обработчике выше
            // Но нужно убедиться, что при открытии модального окна сотрудников закрывается dropdown оборудования

            // Закрытие по Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && equipmentModalDropdown.classList.contains('visible') && 
                    equipmentModal && equipmentModal.classList.contains('visible')) {
                    closeEquipmentModalDropdown();
                }
            });

            // Обработка отправки формы
            if (equipmentForm) {
                equipmentForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    if (equipmentFormSubmit) {
                        equipmentFormSubmit.disabled = true;
                        equipmentFormSubmit.textContent = 'Сохранение...';
                    }
                    if (equipmentFormError) {
                        equipmentFormError.textContent = '';
                    }

                    const formData = new FormData(equipmentForm);
                    const payload = {
                        equipment_name: formData.get('equipment_name')?.trim(),
                        equipment_type: formData.get('equipment_type')?.trim() || null,
                        image_path: formData.get('image_path')?.trim() || null,
                        characteristics: formData.get('characteristics')?.trim() || null,
                        acquisition_date: formData.get('acquisition_date') || null,
                        guarantee_date: formData.get('guarantee_date') || null,
                        maintenance_frequency: formData.get('maintenance_frequency') || null,
                        department_id: formData.get('department_id') || null,
                        spare_part_types: selectedSparePartTypes
                    };

                    fetch('/admin/equipment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(async response => {
                        const data = await response.json();
                        return { ok: response.ok, data };
                    })
                    .then(({ ok, data }) => {
                        if (ok && data.success) {
                            closeEquipmentModal();
                            showEquipmentStatus('Оборудование добавлено', 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 600);
                        } else {
                            if (equipmentFormError) {
                                equipmentFormError.textContent = data.message || 'Ошибка сохранения.';
                            }
                        }
                    })
                    .catch(() => {
                        if (equipmentFormError) {
                            equipmentFormError.textContent = 'Сеть недоступна. Попробуйте позже.';
                        }
                    })
                    .finally(() => {
                        if (equipmentFormSubmit) {
                            equipmentFormSubmit.disabled = false;
                            equipmentFormSubmit.textContent = 'Сохранить';
                        }
                    });
                });
            }

            if (addEquipmentBtn) {
                addEquipmentBtn.addEventListener('click', openEquipmentModal);
            }

            [equipmentModalClose, equipmentModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeEquipmentModal);
                }
            });

            if (equipmentModal) {
                equipmentModal.addEventListener('click', (event) => {
                    if (event.target === equipmentModal) {
                        closeEquipmentModal();
                    }
                });
            }

            // Модальное окно удаления
            function openDeleteEquipmentModal(equipmentId, equipmentRow) {
                if (!deleteEquipmentModal) return;
                
                equipmentToDelete = equipmentId;
                equipmentToDeleteRow = equipmentRow;
                
                const equipmentName = equipmentRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
                if (deleteEquipmentMessage) {
                    deleteEquipmentMessage.innerHTML = `Вы уверены, что хотите удалить оборудование "${equipmentName}"?<br>Это действие нельзя будет отменить.`;
                }
                
                deleteEquipmentModal.setAttribute('aria-hidden', 'false');
                deleteEquipmentModal.classList.add('visible');
                document.body.classList.add('modal-open');
            }

            function closeDeleteEquipmentModal() {
                if (!deleteEquipmentModal) return;
                
                deleteEquipmentModal.setAttribute('aria-hidden', 'true');
                deleteEquipmentModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                
                if (deleteEquipmentConfirm) {
                    deleteEquipmentConfirm.disabled = false;
                    deleteEquipmentConfirm.textContent = 'Удалить';
                }
                
                equipmentToDelete = null;
                equipmentToDeleteRow = null;
            }

            [deleteEquipmentClose, deleteEquipmentCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeDeleteEquipmentModal);
                }
            });

            if (deleteEquipmentModal) {
                deleteEquipmentModal.addEventListener('click', (event) => {
                    if (event.target === deleteEquipmentModal) {
                        closeDeleteEquipmentModal();
                    }
                });
            }

            if (deleteEquipmentConfirm) {
                deleteEquipmentConfirm.addEventListener('click', async () => {
                    if (!equipmentToDelete) return;
                    
                    deleteEquipmentConfirm.disabled = true;
                    deleteEquipmentConfirm.textContent = 'Удаление...';
                    
                    try {
                        const response = await fetch(`/admin/equipment/${equipmentToDelete}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            if (equipmentToDeleteRow && document.contains(equipmentToDeleteRow)) {
                                equipmentToDeleteRow.remove();
                                
                                // Обновляем нумерацию
                                let visibleIndex = 0;
                                getAllEquipmentRows().forEach(row => {
                                    if (row.style.display !== 'none') {
                                        const numberCell = row.querySelector('.number-column');
                                        if (numberCell) {
                                            numberCell.textContent = visibleIndex + 1;
                                        }
                                        visibleIndex++;
                                    }
                                });
                                
                                // Обновляем обработчики строк
                                setupRowHandlers();
                                setupEditableCells();
                                
                                showEquipmentStatus('Оборудование удалено', 'success');
                            }
                            closeDeleteEquipmentModal();
                        } else {
                            showEquipmentStatus(data.message || 'Не удалось удалить оборудование', 'error');
                            deleteEquipmentConfirm.disabled = false;
                            deleteEquipmentConfirm.textContent = 'Удалить';
                        }
                    } catch (error) {
                        console.error('Ошибка при удалении оборудования:', error);
                        showEquipmentStatus('Произошла ошибка при удалении оборудования', 'error');
                        deleteEquipmentConfirm.disabled = false;
                        deleteEquipmentConfirm.textContent = 'Удалить';
                    }
                });
            }

            // Закрытие по Escape
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (equipmentContextMenu && equipmentContextMenu.style.display === 'block') {
                        hideContextMenu();
                    }
                    if (deleteEquipmentModal && deleteEquipmentModal.classList.contains('visible')) {
                        closeDeleteEquipmentModal();
                    }
                    if (equipmentModal && equipmentModal.classList.contains('visible')) {
                        closeEquipmentModal();
                    }
                }
            });

            // Применяем фильтры при загрузке
            applyEquipmentFilters();
        })();
    </script>
    {% endif %}
</body>
</html>

