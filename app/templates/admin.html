<!DOCTYPE html>
<html lang="ru" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>УТОР - Панель администратора</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="admin-page">
    <div class="admin-container">
        <!-- Верхняя панель -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="logo">УТОР</h1>
            </div>
            <div class="header-right">
                <div class="user-menu" id="userMenu">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="avatar-container">
                            {% if user.avatar_path %}
                                <img src="{{ url_for('static', filename=user.avatar_path) }}" alt="Avatar" class="user-avatar" id="userAvatar">
                            {% else %}
                                <div class="user-avatar-empty" id="userAvatar">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                        <span class="user-name">{{ user.last_name }} {{ user.first_name[0] }}.{{ user.patronymic[0] }}.</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-avatar-container">
                            {% if user.avatar_path %}
                                <img src="{{ url_for('static', filename=user.avatar_path) }}" alt="Avatar" class="dropdown-avatar" id="dropdownAvatar" onclick="document.getElementById('avatarInput').click()">
                            {% else %}
                                <div class="dropdown-avatar-empty" id="dropdownAvatar" onclick="document.getElementById('avatarInput').click()">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                    <span class="avatar-hint">Нажмите для загрузки</span>
                                </div>
                            {% endif %}
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                        </div>
                        <div class="user-full-name">
                            {{ user.last_name }} {{ user.first_name }} {{ user.patronymic or '' }}
                        </div>
                        <div class="user-details">
                            <div class="detail-item">
                                <span class="detail-label">Должность:</span>
                                <span class="detail-value">{{ user.post }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Роль:</span>
                                <span class="detail-value">{{ get_role_translation(user.role) }}</span>
                            </div>
                        </div>

                        <div class="support-block">
                            <button type="button" class="support-link" id="supportToggle">
                                Контакты службы поддержки
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="support-contacts" id="supportContacts">
                                <div class="support-item">
                                    <span class="support-label">Телефон</span>
                                    <span class="support-value">+7 (800) 123-45-67</span>
                                </div>
                                <div class="support-item">
                                    <span class="support-label">Email</span>
                                    <span class="support-value">support@utor.example</span>
                                </div>
                                <div class="support-item">
                                    <span class="support-label">Telegram</span>
                                    <span class="support-value">@utor_support</span>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="theme-toggle-container">
                            <span class="theme-label">Тема интерфейса:</span>
                            <button class="theme-toggle-btn" id="themeSwitch" onclick="toggleTheme()" aria-label="Переключить тему">
                                <svg class="theme-icon sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                                <svg class="theme-icon moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="dropdown-actions">
                            <a href="{{ url_for('auth.logout') }}" class="logout-btn">Выйти</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Основной контент -->
        <div class="admin-main">
            <!-- Боковое меню -->
            <aside class="admin-sidebar">
                <nav class="sidebar-nav">
                    <a href="{{ url_for('admin_employees.list_employees') }}" class="nav-item {% if section == 'employees' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>Сотрудники</span>
                    </a>
                    <a href="{{ url_for('admin_equipment.list_equipment') }}" class="nav-item {% if section == 'equipment' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="8" rx="2"></rect>
                            <rect x="6" y="6" width="6" height="5" rx="1"></rect>
                            <path d="M12 11V6h5l2 3" />
                            <circle cx="8" cy="19" r="1.5"></circle>
                            <circle cx="16" cy="19" r="1.5"></circle>
                        </svg>
                        <span>Оборудование</span>
                    </a>
                    <a href="{{ url_for('admin_warehouse.list_warehouse') }}" class="nav-item {% if section == 'warehouse' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        <span>Склад</span>
                    </a>
                    <a href="{{ url_for('admin_pto.list_pto') }}" class="nav-item {% if section == 'pto' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                        <span>ПТО</span>
                    </a>
                    <a href="{{ url_for('admin_tasks.list_tasks') }}" class="nav-item {% if section == 'tasks' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <span>Задачи</span>
                    </a>
                    <a href="{{ url_for('admin_statistics.list_statistics') }}" class="nav-item {% if section == 'statistics' %}active{% endif %}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        <span>Статистика</span>
                    </a>
                </nav>
            </aside>

            <!-- Контентная область -->
            <main class="admin-content">
                {% if section == 'employees' %}
                    <div class="content-header">
                        <h2>Сотрудники</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="employeeSearch" placeholder="Введите текст для поиска">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="filterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                Фильтр
                            </button>
                            <div class="filter-dropdown" id="filterDropdown">
                                <div class="filter-group">
                                    <label for="roleFilter">Права доступа</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="roleFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for role in role_options %}
                                                <button type="button" class="filter-option" data-value="{{ role }}">{{ role_labels.get(role) or role }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="roleFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="roleFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for role in role_options %}
                                        <option value="{{ role }}">{{ get_role_translation(role) }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="departmentFilter">Отдел</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="departmentFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for dept in department_options %}
                                                <button type="button" class="filter-option" data-value="{{ dept }}">{{ dept }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="departmentFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="departmentFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for dept in department_options %}
                                        <option value="{{ dept }}">{{ dept }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="facilityFilter">Предприятие</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="facilityFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for fac in facility_options %}
                                                <button type="button" class="filter-option" data-value="{{ fac }}">{{ fac }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="facilityFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="facilityFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for fac in facility_options %}
                                        <option value="{{ fac }}">{{ fac }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="resetFilters">Сбросить все фильтры</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="number-column">№</th>
                                    <th>Фамилия</th>
                                    <th>Имя</th>
                                    <th>Отчество</th>
                                    <th>Должность</th>
                                    <th>Телефон</th>
                                    <th>Email</th>
                                    <th>Отдел</th>
                                    <th>Предприятие</th>
                                    <th>Права доступа</th>
                                    <th>Логин</th>
                                    <th>Пароль</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in employees %}
                                <tr data-employee-id="{{ emp.id }}" data-role="{{ emp.role or '' }}" data-department="{{ emp.department or '' }}" data-facility="{{ emp.facility or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="last_name">{{ emp.last_name or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="first_name">{{ emp.first_name or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="patronymic">{{ emp.patronymic or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="post">{{ emp.post or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="phone">{{ format_phone(emp.phone) or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="email">{{ emp.email or '' }}</td>
                                    <td class="department-cell" tabindex="0" data-field="department_id" data-department-id="{{ emp.department_id or '' }}" data-facility-name="{{ emp.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ emp.department or '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="facility-cell" tabindex="0" data-field="facility" data-facility-value="{{ emp.facility or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ emp.facility or '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="role-cell" tabindex="0" data-field="role" data-role-value="{{ emp.role or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ role_labels.get(emp.role) if emp.role else '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="login">{{ emp.login or '' }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="password">{{ emp.password or '' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="tableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addEmployeeBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Добавить сотрудника
                        </button>
                    </div>
                {% elif section == 'equipment' %}
                    <div class="content-header">
                        <h2>Оборудование</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="equipmentSearch" placeholder="Введите текст для поиска">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="equipmentFilterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                Фильтр
                            </button>
                            <div class="filter-dropdown" id="equipmentFilterDropdown">
                                <div class="filter-group">
                                    <label for="typeFilter">Тип</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="typeFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for type in type_options %}
                                                <button type="button" class="filter-option" data-value="{{ type }}">{{ type }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="typeFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="typeFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for type in type_options %}
                                        <option value="{{ type }}">{{ type }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="statusFilter">Статус</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="statusFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for status in status_options %}
                                                <button type="button" class="filter-option" data-value="{{ status }}">{{ status }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="statusFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="statusFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for status in status_options %}
                                        <option value="{{ status }}">{{ status }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="locationFilter">Расположение</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="locationFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for location in location_options %}
                                                <button type="button" class="filter-option" data-value="{{ location }}">{{ location }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="locationFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="locationFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for location in location_options %}
                                        <option value="{{ location }}">{{ location }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="resetEquipmentFilters">Сбросить все фильтры</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="equipmentTable">
                            <thead>
                                <tr>
                                    <th class="number-column">№</th>
                                    <th>Название</th>
                                    <th>Тип</th>
                                    <th>Расположение</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment %}
                                <tr data-equipment-id="{{ eq.id }}" data-type="{{ eq.equipment_type or '' }}" data-status="{{ eq.equipment_status or '' }}" data-location="{{ eq.location or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="equipment_name">{{ eq.equipment_name or '' }}</td>
                                    <td class="role-cell" tabindex="0" data-field="equipment_type" data-type-value="{{ eq.equipment_type or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ eq.equipment_type or '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="location">{{ eq.location or '' }}</td>
                                    <td>
                                        {% if eq.equipment_status %}
                                            {% if eq.equipment_status == 'В работе' %}
                                            <span class="status-badge status-in-work">{{ eq.equipment_status }}</span>
                                            {% elif eq.equipment_status == 'На ремонте' %}
                                            <span class="status-badge status-in-repair">{{ eq.equipment_status }}</span>
                                            {% elif eq.equipment_status == 'На ПТО' %}
                                            <span class="status-badge status-in-pto">{{ eq.equipment_status }}</span>
                                            {% else %}
                                            <span class="status-badge">{{ eq.equipment_status }}</span>
                                            {% endif %}
                                        {% else %}
                                        <span class="status-badge">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="equipmentTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addEquipmentBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Добавить оборудование
                        </button>
                    </div>
                {% elif section == 'equipment_passport' %}
                    <div class="content-header">
                        <button type="button" class="back-btn" onclick="window.location.href='{{ url_for('admin_equipment.list_equipment') }}'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Назад
                        </button>
                        <h2>Паспорт оборудования</h2>
                    </div>
                    <div class="equipment-passport-container">
                        <div class="equipment-passport-window">
                            <div class="passport-tabs">
                                <button class="passport-tab active" data-tab="main-info" role="tab" aria-selected="true" aria-controls="tab-panel-main-info">
                                    <span class="tab-icon">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                    </span>
                                    <span class="tab-label">Основная информация</span>
                                </button>
                                <button class="passport-tab" data-tab="movement-history" role="tab" aria-selected="false" aria-controls="tab-panel-movement-history">
                                    <span class="tab-icon">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                        </svg>
                                    </span>
                                    <span class="tab-label">История перемещений</span>
                                </button>
                                <button class="passport-tab" data-tab="required-parts" role="tab" aria-selected="false" aria-controls="tab-panel-required-parts">
                                    <span class="tab-icon">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="9" cy="21" r="1"></circle>
                                            <circle cx="20" cy="21" r="1"></circle>
                                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                        </svg>
                                    </span>
                                    <span class="tab-label">Список необходимых деталей</span>
                                </button>
                            </div>
                            
                            <div class="passport-content">
                                <!-- Основная информация -->
                                <div class="tab-panel active" id="tab-panel-main-info" role="tabpanel" aria-labelledby="tab-main-info">
                                    <div class="equipment-main-info">
                                        <div class="equipment-image-section">
                                            <div class="equipment-image-container" id="equipmentImageContainer" onclick="document.getElementById('equipmentImageInput').click()">
                                                {% if equipment.image_path %}
                                                    <img src="{{ url_for('static', filename=equipment.image_path) }}" alt="{{ equipment.equipment_name }}" class="equipment-image" id="equipmentImage">
                                                {% else %}
                                                    <div class="equipment-image-placeholder" id="equipmentImagePlaceholder">
                                                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                            <polyline points="21 15 16 10 5 21"></polyline>
                                                        </svg>
                                                        <span>Нажмите для загрузки изображения</span>
                                                    </div>
                                                {% endif %}
                                                <div class="equipment-image-overlay">
                                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                        <polyline points="17 8 12 3 7 8"></polyline>
                                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                                    </svg>
                                                    <span>Загрузить изображение</span>
                                                </div>
                                            </div>
                                            <input type="file" id="equipmentImageInput" accept="image/*" style="display: none;" data-equipment-id="{{ equipment.id }}">
                                        </div>
                                        <div class="equipment-details-section">
                                            <div class="detail-item">
                                                <span class="detail-label">Полное именование:</span>
                                                <span class="detail-value">{{ equipment.equipment_name or '—' }}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Тип оборудования:</span>
                                                <span class="detail-value">{{ equipment.equipment_type or '—' }}</span>
                                            </div>
                                            {% if equipment.acquisition_date %}
                                            <div class="detail-item">
                                                <span class="detail-label">Дата ввода в эксплуатацию:</span>
                                                <span class="detail-value">{{ format_date(equipment.acquisition_date) or '—' }}</span>
                                            </div>
                                            {% endif %}
                                            {% if equipment.warranty_expiration %}
                                            <div class="detail-item">
                                                <span class="detail-label">Истечение гарантии:</span>
                                                <span class="detail-value">{{ format_date(equipment.warranty_expiration) or '—' }}</span>
                                            </div>
                                            {% endif %}
                                            {% if equipment.maintenance_frequency_text %}
                                            <div class="detail-item">
                                                <span class="detail-label">Периодичность ТО:</span>
                                                <span class="detail-value">{{ equipment.maintenance_frequency_text }}</span>
                                            </div>
                                            {% endif %}
                                            {% if equipment.characteristics %}
                                            <div class="detail-item detail-item-full">
                                                <span class="detail-label">Характеристики:</span>
                                                <div class="detail-value characteristics-text">{{ format_characteristics(equipment.characteristics)|safe }}</div>
                                            </div>
                                            {% endif %}
                                            {% if equipment.location %}
                                            <div class="detail-item">
                                                <span class="detail-label">Текущее местоположение:</span>
                                                <span class="detail-value">{{ equipment.location }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- История перемещений -->
                                <div class="tab-panel" id="tab-panel-movement-history" role="tabpanel" aria-labelledby="tab-movement-history" hidden>
                                    <div class="movement-history-container">
                                        <div class="table-controls">
                                            <div class="table-search">
                                                <input type="text" id="movementHistorySearch" placeholder="Поиск..." class="search-input">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                                                    <circle cx="11" cy="11" r="8"></circle>
                                                    <path d="m21 21-4.35-4.35"></path>
                                                </svg>
                                            </div>
                                            <button type="button" class="filter-toggle-btn" id="movementHistoryFilterToggle" aria-expanded="false" aria-haspopup="true">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                                </svg>
                                                Фильтр
                                            </button>
                                        </div>
                                        <div class="filter-dropdown" id="movementHistoryFilterDropdown" style="display: none;">
                                            <div class="filter-row">
                                                <label class="filter-label">Дата перемещения:</label>
                                                <input type="text" id="movementDateFilter" placeholder="Дата" class="filter-input">
                                            </div>
                                            <div class="filter-actions">
                                                <button type="button" class="secondary-btn" id="resetMovementHistoryFilters">Сбросить</button>
                                            </div>
                                        </div>
                                        <div class="table-container">
                                            <table class="data-table" id="movementHistoryTable">
                                                <thead>
                                                    <tr>
                                                        <th class="number-column">№</th>
                                                        <th>Откуда перемещено</th>
                                                        <th>Куда перемещено</th>
                                                        <th>Дата перемещения</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for movement in movement_history %}
                                                    <tr data-movement-id="{{ movement.id }}" data-from-location="{{ movement.from_location }}" data-to-location="{{ movement.to_location }}" data-move-date="{{ movement.move_date or '' }}">
                                                        <td class="number-column">{{ loop.index }}</td>
                                                        <td>{{ movement.from_location }}</td>
                                                        <td>{{ movement.to_location }}</td>
                                                        <td>{{ format_date(movement.move_date) or '—' }}</td>
                                                    </tr>
                                                    {% else %}
                                                    <tr>
                                                        <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-medium);">Нет записей о перемещениях</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="table-footer-actions">
                                            <button type="button" class="add-employee-btn" id="addMovementBtn">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                Добавить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Список необходимых деталей -->
                                <div class="tab-panel" id="tab-panel-required-parts" role="tabpanel" aria-labelledby="tab-required-parts" hidden>
                                    <div class="passport-placeholder">
                                        <div class="placeholder-icon">
                                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="9" cy="21" r="1"></circle>
                                                <circle cx="20" cy="21" r="1"></circle>
                                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                            </svg>
                                        </div>
                                        <h3>Раздел в разработке</h3>
                                        <p>Список необходимых деталей находится в стадии разработки и будет доступен в ближайшее время.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% elif section == 'warehouse' %}
                    <div class="content-header">
                        <h2>Склад запчастей</h2>
                    </div>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="warehouseSearch" placeholder="Введите текст для поиска">
                            <button type="button" class="search-button" tabindex="-1">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="table-actions">
                            <button class="filter-btn" id="warehouseFilterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="3 4 21 4 14 14 14 20 10 22 10 14 3 4"></polygon>
                                </svg>
                                Фильтр
                            </button>
                            <div class="filter-dropdown" id="warehouseFilterDropdown">
                                <div class="filter-group">
                                    <label for="facilityWarehouseFilter">Предприятие</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="facilityWarehouseFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for fac in facility_options %}
                                                <button type="button" class="filter-option" data-value="{{ fac }}">{{ fac }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="facilityWarehouseFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="facilityWarehouseFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for fac in facility_options %}
                                        <option value="{{ fac }}">{{ fac }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="warehouseAddressFilter">Склад</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="warehouseAddressFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for wh in warehouse_options %}
                                                <button type="button" class="filter-option" data-value="{{ wh }}">{{ wh }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="warehouseAddressFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="warehouseAddressFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for wh in warehouse_options %}
                                        <option value="{{ wh }}">{{ wh }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="sparePartFilter">Деталь</label>
                                    <div class="filter-select-wrapper">
                                        <div class="filter-select" data-target="sparePartFilter">
                                            <button type="button" class="filter-select-btn" aria-haspopup="listbox" aria-expanded="false">
                                                <span class="filter-select-label">Все</span>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="filter-options-list" role="listbox">
                                                <button type="button" class="filter-option" data-value="">Все</button>
                                                {% for sp in spare_part_options %}
                                                <button type="button" class="filter-option" data-value="{{ sp }}">{{ sp }}</button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="filter-reset-btn" data-target="sparePartFilter" aria-label="Сбросить фильтр" title="Сбросить фильтр" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <select id="sparePartFilter" class="filter-native-select">
                                        <option value="">Все</option>
                                        {% for sp in spare_part_options %}
                                        <option value="{{ sp }}">{{ sp }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="reset-filter-btn" id="warehouseResetFilters">Сбросить все фильтры</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="number-column">№</th>
                                    <th class="warehouse-part-column">Деталь</th>
                                    <th class="warehouse-facility-column">Предприятие</th>
                                    <th class="warehouse-warehouse-column">Склад</th>
                                    <th class="warehouse-quantity-column">Количество</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part in parts %}
                                <tr data-part-id="{{ part.id }}" data-facility="{{ part.facility_name or '' }}" data-warehouse="{{ part.department_name or '' }}" data-spare-part="{{ part.spare_part_name or '' }}">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="spare_part_name">{{ part.spare_part_name or '—' }}</td>
                                    <td class="facility-cell" tabindex="0" data-field="facility" data-facility-value="{{ part.facility_name or '' }}" data-facility-id="{{ part.facility_id or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ part.facility_name or '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="warehouse-cell" tabindex="0" data-field="warehouse_id" data-warehouse-id="{{ part.warehouse_id or '' }}" data-facility-name="{{ part.facility_name or '' }}" aria-haspopup="listbox" aria-expanded="false">
                                        <div class="role-cell-content">
                                            <span class="role-cell-label">{{ part.department_name or '—' }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="editable-cell" contenteditable="false" spellcheck="false" data-field="quantity">{{ part.quantity or '—' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="warehouseTableUpdateStatus" class="table-update-status" role="status" aria-live="polite"></div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="addPartBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Добавить деталь
                        </button>
                    </div>
                {% elif section == 'pto' %}
                    <div class="content-header">
                        <h2>ПТО</h2>
                    </div>
                    <div class="pto-container">
                        <div class="pto-calendar-section">
                            <div class="pto-calendar-header">
                                <button type="button" class="pto-month-nav-btn" id="ptoPrevMonth" aria-label="Предыдущий месяц">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg>
                                </button>
                                <div class="pto-month-selector">
                                    <select id="ptoMonthSelect" class="pto-month-select">
                                        <option value="1">Январь</option>
                                        <option value="2">Февраль</option>
                                        <option value="3">Март</option>
                                        <option value="4">Апрель</option>
                                        <option value="5">Май</option>
                                        <option value="6">Июнь</option>
                                        <option value="7">Июль</option>
                                        <option value="8">Август</option>
                                        <option value="9">Сентябрь</option>
                                        <option value="10">Октябрь</option>
                                        <option value="11">Ноябрь</option>
                                        <option value="12">Декабрь</option>
                                    </select>
                                    <select id="ptoYearSelect" class="pto-year-select">
                                    </select>
                                </div>
                                <button type="button" class="pto-month-nav-btn" id="ptoNextMonth" aria-label="Следующий месяц">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                            <div class="pto-calendar-wrapper">
                                <div class="pto-calendar-weekdays">
                                    <div class="pto-weekday">Пн</div>
                                    <div class="pto-weekday">Вт</div>
                                    <div class="pto-weekday">Ср</div>
                                    <div class="pto-weekday">Чт</div>
                                    <div class="pto-weekday">Пт</div>
                                    <div class="pto-weekday">Сб</div>
                                    <div class="pto-weekday">Вс</div>
                                </div>
                                <div class="pto-calendar-grid" id="ptoCalendarGrid">
                                    <!-- Календарь будет заполнен через JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="pto-table-section">
                            <div class="pto-table-header">
                                <h3 id="ptoTableDate">Сегодня</h3>
                            </div>
                            <div class="pto-table-container">
                                <table class="data-table" id="ptoDataTable">
                                    <thead>
                                        <tr>
                                            <th>Оборудование</th>
                                            <th>Отдел</th>
                                            <th>Местоположение</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ptoTableBody">
                                        <!-- Данные будут загружены через JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% elif section == 'tasks' %}
                    <div class="content-header">
                        <h2>Задачи на ремонт</h2>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="tasksTable">
                            <thead>
                                <tr>
                                    <th class="number-column">№</th>
                                    <th>Тема задачи</th>
                                    <th>Номер задачи</th>
                                    <th>Дедлайн</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks %}
                                <tr class="task-row" data-task-id="{{ task.id }}" style="cursor: pointer;">
                                    <td class="number-column">{{ loop.index }}</td>
                                    <td>{{ task.heading or '—' }}</td>
                                    <td>{{ task.id }}</td>
                                    <td>{{ task.end_date or '—' }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-medium);">Нет задач на ремонт</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer-actions">
                        <button type="button" class="add-employee-btn" id="createTaskBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Создать задачу
                        </button>
                    </div>
                {% elif section == 'statistics' %}
                    <div class="content-header">
                        <h2>Статистика</h2>
                    </div>
                    <div class="content-placeholder">
                        <div class="placeholder-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>
                        </div>
                        <h3>Раздел в разработке</h3>
                        <p>Функционал статистики и аналитики находится в разработке и будет доступен в ближайшее время.</p>
                    </div>
                {% endif %}
            </main>
        </div>
        <div class="decor-line"></div>
    </div>

    <div class="modal-overlay" id="employeeModal" aria-hidden="true">
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="employeeModalTitle">
            <div class="modal-header">
                <h3 id="employeeModalTitle">Добавление сотрудника</h3>
                <button type="button" class="modal-close-btn" id="employeeModalClose" aria-label="Закрыть">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form class="modal-form" id="employeeForm">
                <div class="modal-section">
                    <h4 class="modal-section-title">Данные сотрудника</h4>
                    <div class="modal-row modal-row--thirds">
                        <label class="modal-field">
                            <span data-required="*">Фамилия</span>
                            <input type="text" name="last_name" required>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Имя</span>
                            <input type="text" name="first_name" required>
                        </label>
                        <label class="modal-field">
                            <span data-required="">Отчество</span>
                            <input type="text" name="patronymic">
                        </label>
                    </div>
                    <div class="modal-row modal-row--thirds">
                        <label class="modal-field">
                            <span data-required="*">Предприятие</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="facility_id" id="employeeFacilitySelect" required style="display: none;">
                                    <option value="">Выберите предприятие</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Отдел</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalDepartmentBtn" data-field="department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">Сначала выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="department_id" id="employeeDepartment" required disabled style="display: none;">
                                    <option value="">Сначала выберите предприятие</option>
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Должность</span>
                            <input type="text" name="post" required>
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">Контактная информация</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="">Телефон</span>
                            <input type="text" name="phone" id="employeePhone" placeholder="+7 (___) ___-__-__">
                        </label>
                        <label class="modal-field">
                            <span data-required="">Email</span>
                            <input type="email" name="email" placeholder="example@company.ru">
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">Доступ к УТОР</h4>
                    <div class="modal-row modal-row--credentials">
                        <label class="modal-field">
                            <span data-required="*">Права доступа</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="modalRoleBtn" data-field="role" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите роль</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="role" id="employeeRoleSelect" required style="display: none;">
                                    <option value="">Выберите роль</option>
                                    {% for role in role_options %}
                                    <option value="{{ role }}">{{ role_labels.get(role) or role }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field login-field">
                            <span data-required="*">Логин</span>
                            <input type="text" name="login" id="employeeLogin" required>
                        </label>
                        <label class="modal-field password-field">
                            <span data-required="*">Пароль</span>
                            <div class="password-input-wrapper">
                                <input type="text" name="password" id="employeePassword" required>
                                <button type="button" class="dice-btn" id="generateCredentialsBtn" aria-label="Сгенерировать логин и пароль" title="Случайная генерация логина и пароля">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                        <circle cx="7.5" cy="7.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="16.5" cy="7.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="7.5" cy="16.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="16.5" cy="16.5" r="1.2" fill="currentColor"></circle>
                                        <circle cx="12" cy="12" r="1.2" fill="currentColor"></circle>
                                    </svg>
                                </button>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="modal-error" id="employeeFormError"></div>
                    <div class="modal-actions">
                        <button type="button" class="secondary-btn" id="employeeModalCancel">Отмена</button>
                        <button type="submit" class="primary-btn" id="employeeFormSubmit" data-default-label="Сохранить">
                            Сохранить
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления сотрудника -->
    <div class="modal-overlay" id="deleteEmployeeModal" aria-hidden="true">
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteEmployeeModalTitle">
            <div class="modal-header">
                <h3 id="deleteEmployeeModalTitle">Подтверждение удаления</h3>
                <button type="button" class="modal-close-btn" id="deleteEmployeeModalClose" aria-label="Закрыть">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p id="deleteEmployeeMessage">Вы уверены, что хотите удалить этого сотрудника? Это действие нельзя будет отменить.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="deleteEmployeeCancel">Отмена</button>
                <button type="button" class="primary-btn danger-btn" id="deleteEmployeeConfirm">Удалить</button>
            </div>
        </div>
    </div>
<!-- Модальное окно добавления детали на склад -->
<div class="modal-overlay" id="partModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="partModalTitle">
        <div class="modal-header">
            <h3 id="partModalTitle">Добавление детали</h3>
            <button type="button" class="modal-close-btn" id="partModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="partForm">
            <div class="modal-section">
                <h4 class="modal-section-title">Данные детали</h4>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">Название детали</span>
                        <input type="text" name="spare_part_name" id="partSparePartName" required>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">Количество</span>
                        <div class="number-input-wrapper">
                            <input type="number" name="quantity" id="partQuantity" min="1" required>
                            <div class="number-input-buttons">
                                <button type="button" class="number-input-btn number-input-btn-up" aria-label="Увеличить" tabindex="-1">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                </button>
                                <button type="button" class="number-input-btn number-input-btn-down" aria-label="Уменьшить" tabindex="-1">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </label>
                </div>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">Предприятие</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalPartFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">Выберите предприятие</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="facility_id" id="partFacilitySelect" required style="display: none;">
                                <option value="">Выберите предприятие</option>
                                {% for fac in facility_choices %}
                                <option value="{{ fac.id }}">{{ fac.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">Склад</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalPartWarehouseBtn" data-field="warehouse_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                <span class="modal-select-label">Сначала выберите предприятие</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="warehouse_id" id="partWarehouseSelect" required disabled style="display: none;">
                                <option value="">Сначала выберите предприятие</option>
                            </select>
                        </div>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="partFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="partModalCancel">Отмена</button>
                    <button type="submit" class="primary-btn" id="partFormSubmit" data-default-label="Сохранить">
                        Сохранить
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно подтверждения удаления записи со склада -->
<div class="modal-overlay" id="deleteWarehouseModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteWarehouseModalTitle">
        <div class="modal-header">
            <h3 id="deleteWarehouseModalTitle">Подтверждение удаления</h3>
            <button type="button" class="modal-close-btn" id="deleteWarehouseModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteWarehouseMessage">Вы уверены, что хотите удалить эту запись? Это действие нельзя будет отменить.</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="secondary-btn" id="deleteWarehouseCancel">Отмена</button>
            <button type="button" class="primary-btn danger-btn" id="deleteWarehouseConfirm">Удалить</button>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления оборудования -->
<div class="modal-overlay" id="deleteEquipmentModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="deleteEquipmentModalTitle">
        <div class="modal-header">
            <h3 id="deleteEquipmentModalTitle">Подтверждение удаления</h3>
            <button type="button" class="modal-close-btn" id="deleteEquipmentModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteEquipmentMessage">Вы уверены, что хотите удалить это оборудование? Это действие нельзя будет отменить.</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="secondary-btn" id="deleteEquipmentCancel">Отмена</button>
            <button type="button" class="primary-btn danger-btn" id="deleteEquipmentConfirm">Удалить</button>
        </div>
    </div>
</div>

<!-- Модальное окно добавления оборудования -->
<div class="modal-overlay" id="equipmentModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="equipmentModalTitle">
        <div class="modal-header">
            <h3 id="equipmentModalTitle">Добавление оборудования</h3>
            <button type="button" class="modal-close-btn" id="equipmentModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="equipmentForm" enctype="multipart/form-data">
            <!-- Режим: новое или существующее оборудование -->
            <div class="modal-section" id="equipmentSearchSection">
                <h4 class="modal-section-title">Поиск оборудования</h4>
                <div class="modal-row" style="position: relative;">
                    <label class="modal-field" style="width: 100%;">
                        <span data-required="*">Название оборудования</span>
                        <input type="text" name="equipment_name" id="equipmentNameInput" required autocomplete="off" placeholder="Начните вводить название...">
                        <div id="equipmentModeIndicator" style="margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 13px; display: none;"></div>
                    </label>
                    <div id="equipmentSearchResults" class="equipment-search-results" style="display: none;"></div>
                </div>
            </div>
            
            <!-- Форма для нового оборудования -->
            <div id="newEquipmentForm" style="display: none;">
                <div class="modal-section">
                    <h4 class="modal-section-title">Основная информация</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="">Тип</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentTypeBtn" data-field="equipment_type" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите тип</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="equipment_type" id="equipmentTypeSelect" style="display: none;">
                                    <option value="">Выберите тип</option>
                                    {% for eq_type in equipment_types %}
                                    <option value="{{ eq_type }}">{{ eq_type }}</option>
                                    {% endfor %}
                                    <option value="__custom__">Другое</option>
                                </select>
                            </div>
                            <div id="customEquipmentTypeRow" style="display: none; margin-top: 8px;">
                                <input type="text" name="custom_equipment_type" id="customEquipmentType" placeholder="Введите новый тип оборудования" style="width: 100%; padding: 10px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm);">
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="">Периодичность ТО</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentMaintenanceBtn" data-field="maintenance_frequency" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите периодичность</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="maintenance_frequency" id="equipmentMaintenanceSelect" style="display: none;">
                                    <option value="">Выберите периодичность</option>
                                    <option value="7">Раз в неделю (7 дней)</option>
                                    <option value="30">Раз в месяц (30 дней)</option>
                                    <option value="90">Раз в квартал (90 дней)</option>
                                    <option value="365">Раз в год (365 дней)</option>
                                    <option value="custom">Другое</option>
                                </select>
                            </div>
                        </label>
                    </div>
                    <div class="modal-row" id="customMaintenanceRow" style="display: none;">
                        <label class="modal-field">
                            <span data-required="">Количество дней периодичности</span>
                            <input type="number" name="custom_maintenance_frequency" id="customMaintenanceFrequency" min="1" placeholder="Введите количество дней">
                        </label>
                    </div>
                    <div class="modal-row">
                        <label class="modal-field">
                            <span data-required="">Изображение</span>
                            <input type="file" name="equipment_image" id="equipmentImageInput" accept="image/*" style="padding: 8px; border: 1px solid #dcdcdc; border-radius: 10px; width: 100%;">
                            <div id="equipmentImagePreview" style="margin-top: 8px; display: none; position: relative; width: fit-content;">
                                <img id="equipmentImagePreviewImg" src="" alt="Превью" style="max-width: 200px; max-height: 200px; border-radius: 8px; display: block;">
                                <button type="button" id="removeEquipmentImageBtn" style="position: absolute; top: 4px; right: 4px; background: rgba(0, 0, 0, 0.7); border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: background 0.2s;" aria-label="Удалить изображение">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">Описание характеристик</h4>
                    <div class="modal-row">
                        <label class="modal-field" style="width: 100%;">
                            <span data-required="">Описание характеристик</span>
                            <textarea name="characteristics" rows="8" placeholder="Введите описание характеристик оборудования" style="width: 100%; resize: vertical; min-height: 150px;"></textarea>
                        </label>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">Дополнительная информация</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="">Дата поступления на производство</span>
                            <input type="date" name="acquisition_date">
                        </label>
                        <label class="modal-field">
                            <span data-required="">Срок действия гарантии</span>
                            <input type="date" name="guarantee_date">
                        </label>
                    </div>
                    <div class="modal-row">
                        <label class="modal-field">
                            <span data-required="">Типы деталей</span>
                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                <div class="modal-select-wrapper" style="flex: 1;">
                                    <button type="button" class="modal-select-btn" id="sparePartTypeBtn" data-field="spare_part_type" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="modal-select-label">Выберите тип детали</span>
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    </button>
                                    <select name="spare_part_type" id="sparePartTypeSelect" style="display: none;">
                                        <option value="">Выберите тип детали</option>
                                        {% for spare_type in spare_part_types %}
                                        <option value="{{ spare_type }}">{{ spare_type }}</option>
                                        {% endfor %}
                                        <option value="__custom__">Другое</option>
                                    </select>
                                </div>
                                <button type="button" class="primary-btn" id="addSparePartTypeBtn" style="padding: 10px 16px; min-width: auto; white-space: nowrap;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px; vertical-align: middle;">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Добавить
                                </button>
                            </div>
                            <div id="customSparePartTypeRow" style="display: none; margin-top: 8px;">
                                <input type="text" name="custom_spare_part_type" id="customSparePartType" placeholder="Введите новый тип детали" style="width: 100%; padding: 10px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm);">
                            </div>
                            <div id="sparePartTypesList" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; padding: 4px;"></div>
                        </label>
                    </div>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="*">Предприятие</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentFacilityBtnNew" data-field="facility_id_new" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="facility_id_new" id="equipmentFacilitySelectNew" style="display: none;">
                                    <option value="">Выберите предприятие</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Отдел</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentDepartmentBtnNew" data-field="department_id_new" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">Сначала выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="department_id_new" id="equipmentDepartmentSelectNew" disabled style="display: none;">
                                    <option value="">Сначала выберите предприятие</option>
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="">Расположение</span>
                            <input type="text" name="location" id="equipmentLocationInput" placeholder="Введите расположение оборудования">
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Форма для существующего оборудования -->
            <div id="existingEquipmentForm" style="display: none;">
                <div class="modal-section">
                    <h4 class="modal-section-title">Информация о размещении</h4>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="*">Предприятие</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="modal-select-label">Выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="facility_id" id="equipmentFacilitySelect" style="display: none;">
                                    <option value="">Выберите предприятие</option>
                                    {% for fac in facility_choices %}
                                    <option value="{{ fac.id }}">{{ fac.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </label>
                        <label class="modal-field">
                            <span data-required="*">Отдел</span>
                            <div class="modal-select-wrapper">
                                <button type="button" class="modal-select-btn" id="equipmentDepartmentBtn" data-field="department_id" aria-haspopup="listbox" aria-expanded="false" disabled>
                                    <span class="modal-select-label">Сначала выберите предприятие</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <select name="department_id" id="equipmentDepartmentSelect" disabled style="display: none;">
                                    <option value="">Сначала выберите предприятие</option>
                                </select>
                            </div>
                        </label>
                    </div>
                    <div class="modal-row modal-row--halves">
                        <label class="modal-field">
                            <span data-required="*">Дата поступления на производство</span>
                            <input type="date" name="acquisition_date">
                        </label>
                        <label class="modal-field">
                            <span data-required="">Локация</span>
                            <input type="text" name="location" placeholder="Укажите местонахождение">
                        </label>
                    </div>
                    <input type="hidden" name="existing_equipment_id" id="existingEquipmentId">
                    <input type="hidden" name="equipment_status" value="В работе">
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="equipmentFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="equipmentModalCancel">Отмена</button>
                    <button type="submit" class="primary-btn" id="equipmentFormSubmit" data-default-label="Сохранить">
                        Сохранить
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно создания задачи -->
<div class="modal-overlay" id="createTaskModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="createTaskModalTitle">
        <div class="modal-header">
            <h3 id="createTaskModalTitle">Создание задачи</h3>
            <button type="button" class="modal-close-btn" id="createTaskModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form class="modal-form" id="createTaskForm">
            <div class="modal-section">
                <h4 class="modal-section-title">Данные задачи</h4>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span data-required="*">Назначить на Отдел</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalTaskDepartmentBtn" data-field="department_id" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">Выберите отдел</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="department_id" id="taskDepartmentSelect" required style="display: none;">
                                <option value="">Выберите отдел</option>
                                {% for dept in department_choices %}
                                <option value="{{ dept.id }}" data-facility-id="{{ dept.facility_id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                    <label class="modal-field">
                        <span data-required="*">Предприятие</span>
                        <div class="modal-select-wrapper">
                            <button type="button" class="modal-select-btn" id="modalTaskFacilityBtn" data-field="facility_id" aria-haspopup="listbox" aria-expanded="false">
                                <span class="modal-select-label">Выберите предприятие</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <select name="facility_id" id="taskFacilitySelect" required style="display: none;">
                                <option value="">Выберите предприятие</option>
                                {% for fac in facility_choices %}
                                <option value="{{ fac.id }}">{{ fac.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span data-required="*">Тема</span>
                        <input type="text" name="heading" id="taskHeading" required>
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span data-required="*">Сообщение</span>
                        <textarea name="repair_task_description" id="taskDescription" rows="6" required></textarea>
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span data-required="">Дедлайн</span>
                        <input type="date" name="repair_task_end_date" id="taskEndDate">
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-error" id="createTaskFormError"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" id="createTaskModalCancel">Отмена</button>
                    <button type="submit" class="primary-btn" id="createTaskFormSubmit">Создать</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно просмотра деталей задачи -->
<div class="modal-overlay" id="taskDetailsModal" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="taskDetailsModalTitle">
        <div class="modal-header">
            <h3 id="taskDetailsModalTitle">Детали задачи</h3>
            <button type="button" class="modal-close-btn" id="taskDetailsModalClose" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <div class="modal-row">
                    <label class="modal-field">
                        <span>Номер задачи</span>
                        <input type="text" id="taskDetailsId" readonly style="background: #f5f5f5;">
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span>Тема задачи</span>
                        <input type="text" id="taskDetailsHeading" readonly style="background: #f5f5f5;">
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span>Сообщение</span>
                        <textarea id="taskDetailsDescription" rows="6" readonly style="background: #f5f5f5;"></textarea>
                    </label>
                </div>
                <div class="modal-row modal-row--halves">
                    <label class="modal-field">
                        <span>Дедлайн</span>
                        <input type="text" id="taskDetailsEndDate" readonly style="background: #f5f5f5;">
                    </label>
                    <label class="modal-field">
                        <span>Предприятие</span>
                        <input type="text" id="taskDetailsFacility" readonly style="background: #f5f5f5;">
                    </label>
                </div>
                <div class="modal-row">
                    <label class="modal-field">
                        <span>Статус задачи</span>
                        <div class="status-toggle-wrapper">
                            <label class="status-toggle">
                                <input type="checkbox" id="taskStatusToggle">
                                <span class="status-toggle-slider"></span>
                                <span class="status-toggle-label" id="taskStatusLabel">В процессе</span>
                            </label>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-error" id="taskDetailsFormError"></div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" id="taskDetailsModalCancel">Закрыть</button>
            </div>
        </div>
    </div>
</div>

    <script>
        // Переключение меню пользователя
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Закрытие меню при клике вне его
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            if (!userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // Загрузка аватара
        function uploadAvatar(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('avatar', input.files[0]);
                
                fetch('{{ url_for("admin.upload_avatar") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки:', error);
                });
            }
        }

        // Переключение темы
        function toggleTheme() {
            const html = document.documentElement;
            const sunIcon = document.querySelector('#themeSwitch .sun-icon');
            const moonIcon = document.querySelector('#themeSwitch .moon-icon');
            const isDark = html.classList.contains('dark-theme');
            
            if (isDark) {
                html.classList.remove('dark-theme');
                html.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
                if (sunIcon) sunIcon.style.display = 'none';
                if (moonIcon) moonIcon.style.display = 'block';
            } else {
                html.classList.remove('light-theme');
                html.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
                if (sunIcon) sunIcon.style.display = 'block';
                if (moonIcon) moonIcon.style.display = 'none';
            }
        }

        // Инициализация темы при загрузке
        (function() {
            const savedTheme = localStorage.getItem('theme');
            let theme = savedTheme;
            
            if (!theme) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = 'dark';
                } else {
                    theme = 'light';
                }
            }
            
            document.documentElement.classList.add(theme + '-theme');
            
            // Обновляем иконки переключателя темы
            const sunIcon = document.querySelector('#themeSwitch .sun-icon');
            const moonIcon = document.querySelector('#themeSwitch .moon-icon');
            if (theme === 'dark') {
                if (sunIcon) sunIcon.style.display = 'block';
                if (moonIcon) moonIcon.style.display = 'none';
            } else {
                if (sunIcon) sunIcon.style.display = 'none';
                if (moonIcon) moonIcon.style.display = 'block';
            }
        })();

        // Обработчик для контактов службы поддержки (работает на всех страницах)
        const supportToggle = document.getElementById('supportToggle');
        const supportContacts = document.getElementById('supportContacts');
        if (supportToggle && supportContacts) {
            supportToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                supportContacts.classList.toggle('active');
            });
        }

        {% if section == 'employees' %}
        // Поиск и фильтрация таблицы
        const roleOptionsMap = {{ role_labels|tojson }};
        const departmentsData = {{ department_choices|tojson }};
        const facilityOptionsMap = {};
        {% for fac in facility_choices %}
        facilityOptionsMap[{{ fac.name|tojson }}] = {{ fac.name|tojson }};
        {% endfor %}
        // Создаём карту отделов по предприятиям для фильтрации
        const departmentsByFacility = {};
        {% for dept in department_choices %}
        const facilityName_{{ loop.index }} = {{ dept.facility_name|tojson }};
        if (facilityName_{{ loop.index }}) {
            if (!departmentsByFacility[facilityName_{{ loop.index }}]) {
                departmentsByFacility[facilityName_{{ loop.index }}] = [];
            }
            departmentsByFacility[facilityName_{{ loop.index }}].push({
                id: {{ dept.id }},
                name: {{ dept.name|tojson }}
            });
        }
        {% endfor %}
        const searchInput = document.getElementById('employeeSearch');
        const filterToggle = document.getElementById('filterToggle');
        const filterDropdown = document.getElementById('filterDropdown');
        const roleFilter = document.getElementById('roleFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const facilityFilter = document.getElementById('facilityFilter');
        const tableRows = document.querySelectorAll('.data-table tbody tr');
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const employeeModal = document.getElementById('employeeModal');
        const employeeModalClose = document.getElementById('employeeModalClose');
        const employeeModalCancel = document.getElementById('employeeModalCancel');
        const generateCredentialsBtn = document.getElementById('generateCredentialsBtn');
        const employeeLoginInput = document.getElementById('employeeLogin');
        const employeePasswordInput = document.getElementById('employeePassword');
        const employeeForm = document.getElementById('employeeForm');
        const employeeFacilitySelect = document.getElementById('employeeFacilitySelect');
        const employeeDepartmentSelect = document.getElementById('employeeDepartment');
        const employeeFormError = document.getElementById('employeeFormError');
        const employeeFormSubmit = document.getElementById('employeeFormSubmit');
        const submitDefaultText = employeeFormSubmit ? (employeeFormSubmit.dataset.defaultLabel || employeeFormSubmit.textContent.trim()) : '';
        const filterSelectWrappers = document.querySelectorAll('.filter-select[data-target]');
        const filterSelectControllers = new Map();
        let activeModal = null;

        // Кастомные dropdown'ы для модального окна (объявляем раньше, чтобы использовать в openEmployeeModal)
        const modalDropdown = document.createElement('div');
        modalDropdown.className = 'role-dropdown';
        modalDropdown.id = 'modalDropdown';
        document.body.appendChild(modalDropdown);

        let currentModalSelect = null;
        let modalSelectData = {};

        const facilityDeptMap = departmentsData.reduce((acc, dept) => {
            const facilityId = dept.facility_id ? String(dept.facility_id) : '';
            if (!facilityId) {
                return acc;
            }
            if (!acc[facilityId]) {
                acc[facilityId] = [];
            }
            acc[facilityId].push({
                id: String(dept.id),
                name: dept.name
            });
            return acc;
        }, {});

        Object.keys(facilityDeptMap).forEach(key => {
            facilityDeptMap[key].sort((a, b) => a.name.localeCompare(b.name, 'ru', { sensitivity: 'base' }));
        });

        function populateDepartmentOptions(facilityId) {
            if (!employeeDepartmentSelect) return;
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            const modalDepartmentLabel = modalDepartmentBtn?.querySelector('.modal-select-label');
            
            employeeDepartmentSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
            placeholder.disabled = !facilityId;
            placeholder.selected = true;
            employeeDepartmentSelect.appendChild(placeholder);

            if (!facilityId) {
                employeeDepartmentSelect.disabled = true;
                if (modalDepartmentBtn) {
                    modalDepartmentBtn.disabled = true;
                    if (modalDepartmentLabel) {
                        modalDepartmentLabel.textContent = 'Сначала выберите предприятие';
                    }
                }
                // Обновляем данные для dropdown
                if (modalSelectData) {
                    modalSelectData.department = {};
                }
                return;
            }

            const departments = facilityDeptMap[facilityId] || [];
            if (departments.length === 0) {
                placeholder.textContent = 'Для выбранного предприятия нет отделов';
                employeeDepartmentSelect.disabled = true;
                if (modalDepartmentBtn) {
                    modalDepartmentBtn.disabled = true;
                    if (modalDepartmentLabel) {
                        modalDepartmentLabel.textContent = 'Для выбранного предприятия нет отделов';
                    }
                }
                // Обновляем данные для dropdown
                if (modalSelectData) {
                    modalSelectData.department = {};
                }
                return;
            }
            
            // Обновляем данные для dropdown
            if (modalSelectData) {
                modalSelectData.department = {};
                departments.forEach(dept => {
                    modalSelectData.department[dept.id] = dept.name;
                });
            }
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                employeeDepartmentSelect.appendChild(option);
            });
            employeeDepartmentSelect.disabled = false;
            if (modalDepartmentBtn) {
                modalDepartmentBtn.disabled = false;
                if (modalDepartmentLabel) {
                    modalDepartmentLabel.textContent = 'Выберите отдел';
                }
            }
        }

        function openEmployeeModal() {
            if (!employeeModal) return;
            employeeModal.classList.add('visible');
            employeeModal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            activeModal = employeeModal;
            if (employeeForm) {
                employeeForm.reset();
            }
            
            // Сбрасываем кастомные dropdown'ы
            const modalFacilityBtn = document.getElementById('modalFacilityBtn');
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            const modalRoleBtn = document.getElementById('modalRoleBtn');
            
            if (modalFacilityBtn) {
                const label = modalFacilityBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Выберите предприятие';
                modalFacilityBtn.setAttribute('aria-expanded', 'false');
            }
            if (modalDepartmentBtn) {
                const label = modalDepartmentBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Сначала выберите предприятие';
                modalDepartmentBtn.setAttribute('aria-expanded', 'false');
                modalDepartmentBtn.disabled = true;
            }
            if (modalRoleBtn) {
                const label = modalRoleBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Выберите роль';
                modalRoleBtn.setAttribute('aria-expanded', 'false');
            }
            
            closeModalDropdown();
            
            if (employeeFacilitySelect) {
                employeeFacilitySelect.value = '';
                handleFacilityChange();
            } else {
                populateDepartmentOptions('');
            }
            if (employeeFormError) {
                employeeFormError.textContent = '';
            }
            const firstInput = employeeForm ? employeeForm.querySelector('input, .modal-select-btn') : null;
            if (firstInput) {
                firstInput.focus();
            }
        }

        function closeEmployeeModal() {
            if (!employeeModal) return;
            employeeModal.classList.remove('visible');
            employeeModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            activeModal = null;
        }

        function handleFacilityChange() {
            if (!employeeFacilitySelect) return;
            const facilityId = employeeFacilitySelect.value;
            populateDepartmentOptions(facilityId);
            if (employeeDepartmentSelect) {
                employeeDepartmentSelect.value = '';
            }
            // Обновляем кастомную кнопку отдела
            const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
            if (modalDepartmentBtn) {
                const label = modalDepartmentBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
                }
            }
        }

        function applyRowStriping() {
            let visibleIndex = 0;
            tableRows.forEach(row => {
                if (row.style.display === 'none') {
                    row.classList.remove('alt-row');
                    return;
                }
                const isAlt = visibleIndex % 2 === 1;
                row.classList.toggle('alt-row', isAlt);
                visibleIndex += 1;
            });
        }

        function applyTableFilters() {
            const searchValue = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const roleValue = roleFilter ? roleFilter.value : '';
            const departmentValue = departmentFilter ? departmentFilter.value : '';
            const facilityValue = facilityFilter ? facilityFilter.value : '';

            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowRole = (row.dataset.role || '').toLowerCase();
                const rowDept = (row.dataset.department || '').toLowerCase();
                const rowFac = (row.dataset.facility || '').toLowerCase();

                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesRole = roleValue === '' || rowRole === roleValue.toLowerCase();
                const matchesDept = departmentValue === '' || rowDept === departmentValue.toLowerCase();
                const matchesFac = facilityValue === '' || rowFac === facilityValue.toLowerCase();

                row.style.display = (matchesSearch && matchesRole && matchesDept && matchesFac) ? '' : 'none';
            });

            applyRowStriping();
        }

        const resetFiltersBtn = document.getElementById('resetFilters');

        if (searchInput) {
            searchInput.addEventListener('input', applyTableFilters);
        }

        [roleFilter, departmentFilter, facilityFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', applyTableFilters);
            }
        });

        function closeFilterSelectMenus() {
            filterSelectWrappers.forEach(wrapper => {
                wrapper.classList.remove('open');
                const btn = wrapper.querySelector('.filter-select-btn');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (filterToggle && filterDropdown) {
            filterToggle.addEventListener('click', () => {
                filterDropdown.classList.toggle('active');
                filterToggle.classList.toggle('active');
                if (!filterDropdown.classList.contains('active')) {
                    closeFilterSelectMenus();
                }
            });

            document.addEventListener('click', (event) => {
                if (!filterDropdown.contains(event.target) && !filterToggle.contains(event.target)) {
                    filterDropdown.classList.remove('active');
                    filterToggle.classList.remove('active');
                    closeFilterSelectMenus();
                }
            });
        }

        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', () => {
                if (searchInput) searchInput.value = '';
                if (roleFilter) roleFilter.value = '';
                if (departmentFilter) departmentFilter.value = '';
                if (facilityFilter) facilityFilter.value = '';
                applyTableFilters();
                filterSelectControllers.forEach(controller => controller.sync());
            });
        }

        if (addEmployeeBtn) {
            addEmployeeBtn.addEventListener('click', () => {
                closeFilterSelectMenus();
                closeRoleDropdown();
                if (typeof closeFacilityDropdown === 'function') {
                    closeFacilityDropdown();
                }
                if (typeof closeDepartmentDropdown === 'function') {
                    closeDepartmentDropdown();
                }
                openEmployeeModal();
            });
        }

        [employeeModalClose, employeeModalCancel].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    closeEmployeeModal();
                });
            }
        });

        // Генерация логина и пароля
        if (generateCredentialsBtn) {
            generateCredentialsBtn.addEventListener('click', () => {
                // Получаем значения фамилии и имени
                const lastNameInput = document.querySelector('input[name="last_name"]');
                const firstNameInput = document.querySelector('input[name="first_name"]');
                
                const lastName = lastNameInput ? lastNameInput.value.trim() : '';
                const firstName = firstNameInput ? firstNameInput.value.trim() : '';
                
                // Генерируем логин на основе фамилии и имени
                let login = '';
                if (lastName && firstName) {
                    // Берём первые 3 буквы фамилии и первую букву имени, приводим к нижнему регистру
                    const lastPart = lastName.substring(0, 3).toLowerCase();
                    const firstPart = firstName.substring(0, 1).toLowerCase();
                    // Транслитерация русских букв в латиницу
                    const translitMap = {
                        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'e',
                        'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
                        'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
                        'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
                        'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
                    };
                    
                    const transliterate = (str) => {
                        return str.split('').map(char => {
                            const lower = char.toLowerCase();
                            return translitMap[lower] || lower;
                        }).join('');
                    };
                    
                    const lastPartTranslit = transliterate(lastPart);
                    const firstPartTranslit = transliterate(firstPart);
                    login = lastPartTranslit + firstPartTranslit;
                } else {
                    // Если нет фамилии и имени, генерируем случайный логин
                    login = 'user' + Math.floor(Math.random() * 10000);
                }
                
                // Генерируем пароль: pass + 4 случайные цифры
                const randomDigits = Math.floor(1000 + Math.random() * 9000); // 4-значное число от 1000 до 9999
                const password = 'pass' + randomDigits;
                
                // Заполняем поля
                if (employeeLoginInput) {
                    employeeLoginInput.value = login;
                }
                if (employeePasswordInput) {
                    employeePasswordInput.value = password;
                }
            });
        }

        // Автоматическое форматирование номера телефона
        const employeePhoneInput = document.getElementById('employeePhone');
        if (employeePhoneInput) {
            employeePhoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Убираем все нецифровые символы
                
                // Если начинается с 8, заменяем на 7
                if (value.startsWith('8')) {
                    value = '7' + value.substring(1);
                }
                
                // Если не начинается с 7, добавляем 7
                if (value && !value.startsWith('7')) {
                    value = '7' + value;
                }
                
                // Ограничиваем длину (7 + 10 цифр = 11)
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                // Форматируем номер
                let formatted = '';
                if (value.length > 0) {
                    formatted = '+7';
                    if (value.length > 1) {
                        formatted += ' (' + value.substring(1, 4);
                        if (value.length > 4) {
                            formatted += ') ' + value.substring(4, 7);
                            if (value.length > 7) {
                                formatted += '-' + value.substring(7, 9);
                                if (value.length > 9) {
                                    formatted += '-' + value.substring(9, 11);
                                }
                            }
                        } else {
                            formatted += ')';
                        }
                    }
                }
                
                e.target.value = formatted;
            });
            
            // Обработка вставки текста
            employeePhoneInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const digits = pastedText.replace(/\D/g, '');
                
                if (digits) {
                    let value = digits;
                    if (value.startsWith('8')) {
                        value = '7' + value.substring(1);
                    }
                    if (value && !value.startsWith('7')) {
                        value = '7' + value;
                    }
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    let formatted = '';
                    if (value.length > 0) {
                        formatted = '+7';
                        if (value.length > 1) {
                            formatted += ' (' + value.substring(1, 4);
                            if (value.length > 4) {
                                formatted += ') ' + value.substring(4, 7);
                                if (value.length > 7) {
                                    formatted += '-' + value.substring(7, 9);
                                    if (value.length > 9) {
                                        formatted += '-' + value.substring(9, 11);
                                    }
                                }
                            } else {
                                formatted += ')';
                            }
                        }
                    }
                    
                    this.value = formatted;
                    this.dispatchEvent(new Event('input'));
                }
            });
        }

        if (employeeModal) {
            employeeModal.addEventListener('click', (event) => {
                if (event.target === employeeModal) {
                    closeEmployeeModal();
                }
            });
        }

        if (employeeFacilitySelect) {
            employeeFacilitySelect.addEventListener('change', handleFacilityChange);
        }

        const statusBox = document.getElementById('tableUpdateStatus');
        const editableCells = document.querySelectorAll('.data-table td.editable-cell[data-field]');
        const roleCells = document.querySelectorAll('.role-cell');
        let statusTimeoutId;
        let currentRoleCell = null;

        function showStatus(message, state = 'info') {
            if (!statusBox) return;
            statusBox.textContent = message;
            statusBox.dataset.state = state;
            statusBox.classList.remove('visible');
            if (message) {
                requestAnimationFrame(() => statusBox.classList.add('visible'));
                clearTimeout(statusTimeoutId);
                statusTimeoutId = setTimeout(() => {
                    statusBox.classList.remove('visible');
                }, 5000);
            }
        }

        function revertCell(cell) {
            if (!cell) return;
            if (cell.classList.contains('role-cell')) {
                const label = roleOptionsMap[cell.dataset.originalValue || ''] || '—';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (labelSpan) labelSpan.textContent = label;
                cell.dataset.roleValue = cell.dataset.originalValue || '';
                return;
            }
            if (cell.classList.contains('facility-cell')) {
                const facilityName = cell.dataset.originalValue || '';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (labelSpan) labelSpan.textContent = facilityName || '—';
                cell.dataset.facilityValue = facilityName;
                return;
            }
            if (cell.classList.contains('department-cell')) {
                const deptId = cell.dataset.originalValue || '';
                const labelSpan = cell.querySelector('.role-cell-label');
                if (deptId) {
                    const facilityName = cell.dataset.facilityName || '';
                    const departments = departmentsByFacility[facilityName] || [];
                    const dept = departments.find(d => String(d.id) === String(deptId));
                    if (labelSpan) labelSpan.textContent = dept ? dept.name : '—';
                    cell.dataset.departmentId = deptId;
                } else {
                    if (labelSpan) labelSpan.textContent = '—';
                    cell.dataset.departmentId = '';
                }
                return;
            }
            cell.textContent = cell.dataset.originalValue || '';
        }

        function updateEmployeeCell(cell, employeeId, field, value) {
            cell.classList.add('saving');
            fetch(`/admin/employees/${employeeId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ field, value })
            })
            .then(async response => {
                const data = await response.json();
                return { ok: response.ok, data };
            })
            .then(({ ok, data }) => {
                cell.classList.remove('saving');
                if (ok && data.success) {
                    if (cell.classList.contains('role-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        const label = roleOptionsMap[data.value || ''] || '—';
                        if (labelSpan) labelSpan.textContent = label;
                        cell.dataset.roleValue = data.value || '';
                        cell.dataset.originalValue = cell.dataset.roleValue;
                        cell.setAttribute('aria-expanded', 'false');
                    } else if (cell.classList.contains('facility-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        const facilityName = data.value || '';
                        // Отображаем название предприятия (не прочерк, если есть значение)
                        if (labelSpan) labelSpan.textContent = facilityName || '—';
                        cell.dataset.facilityValue = facilityName;
                        cell.dataset.originalValue = facilityName;
                        cell.setAttribute('aria-expanded', 'false');
                        // Обновляем также department в строке
                        const row = cell.closest('tr');
                        if (row) {
                            const departmentCell = row.querySelector('.department-cell');
                            if (departmentCell) {
                                const deptLabelSpan = departmentCell.querySelector('.role-cell-label');
                                // Всегда ставим прочерк в отделе при смене предприятия
                                if (deptLabelSpan) deptLabelSpan.textContent = '—';
                                departmentCell.dataset.departmentId = '';
                                // Обновляем facilityName для правильного отображения списка отделов
                                departmentCell.dataset.facilityName = facilityName || '';
                                row.dataset.department = '';
                            }
                        }
                    } else if (cell.classList.contains('department-cell')) {
                        const labelSpan = cell.querySelector('.role-cell-label');
                        // data.value для отдела - это название отдела, а не ID
                        const deptName = data.value || '';
                        if (labelSpan) labelSpan.textContent = deptName || '—';
                        // Нужно найти ID отдела по названию для обновления dataset
                        const facilityName = cell.dataset.facilityName || '';
                        const departments = departmentsByFacility[facilityName] || [];
                        const dept = departments.find(d => d.name === deptName);
                        if (dept) {
                            cell.dataset.departmentId = String(dept.id);
                        } else {
                            cell.dataset.departmentId = '';
                        }
                        cell.dataset.originalValue = cell.dataset.departmentId;
                        cell.setAttribute('aria-expanded', 'false');
                    } else {
                        cell.textContent = data.value || '';
                        cell.dataset.originalValue = cell.textContent;
                    }
                    showStatus('Изменения сохранены', 'success');
                } else {
                    cell.classList.add('error');
                    revertCell(cell);
                    showStatus(data.message || 'Ошибка сохранения', 'error');
                    setTimeout(() => cell.classList.remove('error'), 1500);
                }
            })
            .catch(() => {
                cell.classList.remove('saving');
                cell.classList.add('error');
                revertCell(cell);
                showStatus('Сеть недоступна. Попробуйте позже.', 'error');
                setTimeout(() => cell.classList.remove('error'), 1500);
            });
        }

        editableCells.forEach(cell => {
            // Активация редактирования по двойному клику
            cell.addEventListener('dblclick', () => {
                cell.contentEditable = 'true';
                cell.dataset.originalValue = cell.textContent.trim();
                // Фокусируем ячейку и выделяем весь текст
                cell.focus();
                const range = document.createRange();
                range.selectNodeContents(cell);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            });

            cell.addEventListener('focus', () => {
                // Сохраняем оригинальное значение только если ячейка уже в режиме редактирования
                if (cell.contentEditable === 'true') {
                    cell.dataset.originalValue = cell.textContent.trim();
                }
            });

            cell.addEventListener('keydown', (event) => {
                if (cell.contentEditable !== 'true') return;
                
                if (event.key === 'Enter') {
                    event.preventDefault();
                    cell.blur();
                }
                if (event.key === 'Escape') {
                    event.preventDefault();
                    revertCell(cell);
                    cell.blur();
                }
            });

            cell.addEventListener('paste', (event) => {
                if (cell.contentEditable !== 'true') return;
                event.preventDefault();
                const text = (event.clipboardData || window.clipboardData).getData('text');
                
                // Специальная обработка для поля телефона
                if (cell.dataset.field === 'phone') {
                    const digits = text.replace(/\D/g, '');
                    if (digits) {
                        let value = digits;
                        if (value.startsWith('8')) {
                            value = '7' + value.substring(1);
                        }
                        if (value && !value.startsWith('7')) {
                            value = '7' + value;
                        }
                        if (value.length > 11) {
                            value = value.substring(0, 11);
                        }
                        
                        let formatted = '';
                        if (value.length > 0) {
                            formatted = '+7';
                            if (value.length > 1) {
                                formatted += ' (' + value.substring(1, 4);
                                if (value.length > 4) {
                                    formatted += ') ' + value.substring(4, 7);
                                    if (value.length > 7) {
                                        formatted += '-' + value.substring(7, 9);
                                        if (value.length > 9) {
                                            formatted += '-' + value.substring(9, 11);
                                        }
                                    }
                                } else {
                                    formatted += ')';
                                }
                            }
                        }
                        cell.textContent = formatted;
                        // Устанавливаем курсор в конец
                        const range = document.createRange();
                        range.selectNodeContents(cell);
                        range.collapse(false);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                } else {
                    document.execCommand('insertText', false, text);
                }
            });
            
            // Обработка ввода для поля телефона
            if (cell.dataset.field === 'phone') {
                cell.addEventListener('input', function(e) {
                    if (cell.contentEditable !== 'true') return;
                    
                    // Получаем текущую позицию курсора и текст до курсора
                    const selection = window.getSelection();
                    const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                    const cursorOffset = range ? range.startOffset : 0;
                    
                    // Получаем текст до курсора и после
                    const textBeforeCursor = cell.textContent.substring(0, cursorOffset);
                    const textAfterCursor = cell.textContent.substring(cursorOffset);
                    
                    // Подсчитываем количество цифр до курсора
                    const digitsBeforeCursor = textBeforeCursor.replace(/\D/g, '').length;
                    
                    let value = cell.textContent.replace(/\D/g, ''); // Убираем все нецифровые символы
                    
                    // Если начинается с 8, заменяем на 7
                    if (value.startsWith('8')) {
                        value = '7' + value.substring(1);
                    }
                    
                    // Если не начинается с 7, добавляем 7
                    if (value && !value.startsWith('7')) {
                        value = '7' + value;
                    }
                    
                    // Ограничиваем длину (7 + 10 цифр = 11)
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    // Форматируем номер
                    let formatted = '';
                    if (value.length > 0) {
                        formatted = '+7';
                        if (value.length > 1) {
                            formatted += ' (' + value.substring(1, 4);
                            if (value.length > 4) {
                                formatted += ') ' + value.substring(4, 7);
                                if (value.length > 7) {
                                    formatted += '-' + value.substring(7, 9);
                                    if (value.length > 9) {
                                        formatted += '-' + value.substring(9, 11);
                                    }
                                }
                            } else {
                                formatted += ')';
                            }
                        }
                    }
                    
                    // Вычисляем новую позицию курсора на основе количества цифр
                    let newCursorPosition = formatted.length;
                    if (digitsBeforeCursor > 0) {
                        // Находим позицию в отформатированной строке, где находится N-я цифра
                        let digitCount = 0;
                        for (let i = 0; i < formatted.length; i++) {
                            if (/\d/.test(formatted[i])) {
                                digitCount++;
                                if (digitCount === digitsBeforeCursor) {
                                    // Ставим курсор после этой цифры
                                    newCursorPosition = i + 1;
                                    break;
                                }
                            }
                        }
                    } else if (digitsBeforeCursor === 0 && value.length > 0) {
                        // Если курсор был в начале, ставим после +7
                        newCursorPosition = 2;
                    }
                    
                    cell.textContent = formatted;
                    
                    // Восстанавливаем позицию курсора
                    if (formatted.length > 0) {
                        requestAnimationFrame(() => {
                            try {
                                const textNode = cell.firstChild;
                                if (textNode) {
                                    const newRange = document.createRange();
                                    const finalPosition = Math.min(newCursorPosition, formatted.length);
                                    newRange.setStart(textNode, finalPosition);
                                    newRange.setEnd(textNode, finalPosition);
                                    selection.removeAllRanges();
                                    selection.addRange(newRange);
                                }
                            } catch (e) {
                                // Если не удалось восстановить позицию, ставим курсор в конец
                                const newRange = document.createRange();
                                newRange.selectNodeContents(cell);
                                newRange.collapse(false);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                        });
                    }
                });
            }

            cell.addEventListener('blur', () => {
                // Деактивируем редактирование
                cell.contentEditable = 'false';
                
                const originalValue = cell.dataset.originalValue ?? '';
                const newValue = cell.textContent.trim();
                if (newValue === originalValue) {
                    return;
                }
                const row = cell.closest('tr');
                const employeeId = row ? row.dataset.employeeId : null;
                if (!employeeId) {
                    revertCell(cell);
                    showStatus('Не удалось определить сотрудника.', 'error');
                    return;
                }
                const field = cell.dataset.field;
                if (!field) {
                    revertCell(cell);
                    return;
                }
                updateEmployeeCell(cell, employeeId, field, newValue);
            });
        });

        const roleDropdown = document.createElement('div');
        roleDropdown.className = 'role-dropdown';
        document.body.appendChild(roleDropdown);

        function populateRoleDropdown() {
            roleDropdown.innerHTML = '';
            Object.entries(roleOptionsMap).forEach(([value, label]) => {
                // Пропускаем пустые значения
                if (!value || value.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = value;
                option.textContent = label || value;
                option.addEventListener('click', () => {
                    const targetCell = currentRoleCell;
                    if (!targetCell) return;
                    if (targetCell.dataset.roleValue === value) {
                        closeRoleDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.roleValue || '';
                    updateEmployeeCell(targetCell, employeeId, 'role', value);
                    closeRoleDropdown();
                });
                roleDropdown.appendChild(option);
            });
        }

        function positionRoleDropdown(cell) {
            if (!cell || !roleDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            
            // Используем offsetWidth для получения реальной ширины ячейки
            // offsetWidth включает padding и border, что даёт точную ширину
            const cellWidth = cell.offsetWidth;
            
            // Также проверяем rect.width для сравнения
            const rectWidth = rect.width;
            
            // Используем максимальное значение для надёжности
            const finalWidth = Math.max(cellWidth, rectWidth);
            
            // Получаем реальную высоту dropdown
            const dropdownHeight = roleDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            // Проверяем границы контейнера таблицы
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            // Вычисляем доступное пространство
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Если есть контейнер таблицы, учитываем его границы
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                // Проверяем, сколько места есть в контейнере ниже ячейки
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            // Определяем, открывать ли dropdown вверх или вниз
            // Открываем вверх, если места внизу недостаточно и места вверху больше
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            // Позиционируем относительно viewport
            roleDropdown.style.position = 'fixed';
            if (openUpward) {
                // Открываем вверх
                roleDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                roleDropdown.style.top = 'auto';
            } else {
                // Открываем вниз (по умолчанию)
                roleDropdown.style.top = `${rect.bottom + 6}px`;
                roleDropdown.style.bottom = 'auto';
            }
            roleDropdown.style.left = `${rect.left}px`;
            roleDropdown.style.width = `${finalWidth}px`;
            roleDropdown.style.minWidth = `${finalWidth}px`;
            roleDropdown.style.maxWidth = `${finalWidth}px`;
            roleDropdown.style.boxSizing = 'border-box';
            
            // Сбрасываем любые ограничения ширины
            roleDropdown.style.flexShrink = '0';
            roleDropdown.style.flexGrow = '0';
            
            // Убеждаемся, что опции занимают всю ширину
            const options = roleDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.roleValue);
            });
        }

        function openRoleDropdown(cell) {
            currentRoleCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateRoleDropdown();
            roleDropdown.classList.add('visible');
            // Используем двойной requestAnimationFrame для точного позиционирования после всех изменений DOM
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionRoleDropdown(cell);
                    // Пересчитываем позицию после того, как dropdown получил реальную высоту
                    requestAnimationFrame(() => {
                        positionRoleDropdown(cell);
                    });
                });
            });
        }

        function closeRoleDropdown() {
            if (currentRoleCell) {
                currentRoleCell.setAttribute('aria-expanded', 'false');
            }
            currentRoleCell = null;
            roleDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (roleDropdown.contains(event.target)) return;
            if (event.target.closest('.role-cell')) return;
            closeRoleDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentRoleCell) {
                requestAnimationFrame(() => {
                    positionRoleDropdown(currentRoleCell);
                });
            }
        });

        // Обработчик скролла страницы - закрываем dropdown при прокрутке
        window.addEventListener('scroll', () => {
            if (currentRoleCell && roleDropdown.classList.contains('visible')) {
                closeRoleDropdown();
            }
        }, true);

        // Обработчик скролла таблицы - закрываем dropdown при прокрутке
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
            tableContainer.addEventListener('scroll', () => {
                if (currentRoleCell && roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                }
            });
        }

        roleCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentRoleCell === cell && roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                } else {
                    openRoleDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.roleValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openRoleDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeRoleDropdown();
                    cell.blur();
                }
            });
        });

        // Выпадающие списки для предприятий
        const facilityCells = document.querySelectorAll('.facility-cell');
        const facilityDropdown = document.createElement('div');
        facilityDropdown.className = 'role-dropdown';
        document.body.appendChild(facilityDropdown);
        let currentFacilityCell = null;

        function populateFacilityDropdown() {
            facilityDropdown.innerHTML = '';
            // Используем facilityOptionsMap для предприятий
            Object.keys(facilityOptionsMap).forEach(facilityName => {
                // Пропускаем пустые значения
                if (!facilityName || facilityName.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = facilityName;
                // Используем название предприятия напрямую
                option.textContent = facilityName;
                option.addEventListener('click', () => {
                    const targetCell = currentFacilityCell;
                    if (!targetCell) return;
                    if (targetCell.dataset.facilityValue === facilityName) {
                        closeFacilityDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.facilityValue || '';
                    updateEmployeeCell(targetCell, employeeId, 'facility', facilityName);
                    closeFacilityDropdown();
                });
                facilityDropdown.appendChild(option);
            });
        }

        function positionFacilityDropdown(cell) {
            if (!cell || !facilityDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            const cellWidth = cell.offsetWidth;
            const rectWidth = rect.width;
            const finalWidth = Math.max(cellWidth, rectWidth);
            const dropdownHeight = facilityDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            facilityDropdown.style.position = 'fixed';
            if (openUpward) {
                facilityDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                facilityDropdown.style.top = 'auto';
            } else {
                facilityDropdown.style.top = `${rect.bottom + 6}px`;
                facilityDropdown.style.bottom = 'auto';
            }
            facilityDropdown.style.left = `${rect.left}px`;
            facilityDropdown.style.width = `${finalWidth}px`;
            facilityDropdown.style.minWidth = `${finalWidth}px`;
            facilityDropdown.style.maxWidth = `${finalWidth}px`;
            facilityDropdown.style.boxSizing = 'border-box';
            facilityDropdown.style.flexShrink = '0';
            facilityDropdown.style.flexGrow = '0';
            
            const options = facilityDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.facilityValue);
            });
        }

        function openFacilityDropdown(cell) {
            currentFacilityCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateFacilityDropdown();
            facilityDropdown.classList.add('visible');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionFacilityDropdown(cell);
                    requestAnimationFrame(() => {
                        positionFacilityDropdown(cell);
                    });
                });
            });
        }

        function closeFacilityDropdown() {
            if (currentFacilityCell) {
                currentFacilityCell.setAttribute('aria-expanded', 'false');
            }
            currentFacilityCell = null;
            facilityDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (facilityDropdown.contains(event.target)) return;
            if (event.target.closest('.facility-cell')) return;
            closeFacilityDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentFacilityCell) {
                requestAnimationFrame(() => {
                    positionFacilityDropdown(currentFacilityCell);
                });
            }
        });

        window.addEventListener('scroll', () => {
            if (currentFacilityCell && facilityDropdown.classList.contains('visible')) {
                closeFacilityDropdown();
            }
        }, true);

        const tableContainerFacility = document.querySelector('.table-container');
        if (tableContainerFacility) {
            tableContainerFacility.addEventListener('scroll', () => {
                if (currentFacilityCell && facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                }
            });
        }

        facilityCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentFacilityCell === cell && facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                } else {
                    openFacilityDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.facilityValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openFacilityDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeFacilityDropdown();
                    cell.blur();
                }
            });
        });

        // Выпадающие списки для отделов
        const departmentCells = document.querySelectorAll('.department-cell');
        const departmentDropdown = document.createElement('div');
        departmentDropdown.className = 'role-dropdown';
        document.body.appendChild(departmentDropdown);
        let currentDepartmentCell = null;

        function populateDepartmentDropdown(cell) {
            departmentDropdown.innerHTML = '';
            const facilityName = cell.dataset.facilityName || '';
            const departments = departmentsByFacility[facilityName] || [];
            
            departments.forEach(dept => {
                // Пропускаем отделы без названия
                if (!dept || !dept.name || dept.name.trim() === '') return;
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = dept.id;
                option.textContent = dept.name;
                option.addEventListener('click', () => {
                    const targetCell = currentDepartmentCell;
                    if (!targetCell) return;
                    const currentId = targetCell.dataset.departmentId || '';
                    if (currentId === String(dept.id)) {
                        closeDepartmentDropdown();
                        return;
                    }
                    const row = targetCell.closest('tr');
                    if (!row) return;
                    const employeeId = row.dataset.employeeId;
                    if (!employeeId) return;
                    targetCell.dataset.originalValue = targetCell.dataset.departmentId || '';
                    updateEmployeeCell(targetCell, employeeId, 'department_id', dept.id);
                    closeDepartmentDropdown();
                });
                departmentDropdown.appendChild(option);
            });
        }

        function positionDepartmentDropdown(cell) {
            if (!cell || !departmentDropdown) return;
            
            const rect = cell.getBoundingClientRect();
            const cellWidth = cell.offsetWidth;
            const rectWidth = rect.width;
            const finalWidth = Math.max(cellWidth, rectWidth);
            const dropdownHeight = departmentDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            
            const tableContainer = document.querySelector('.table-container');
            let containerRect = null;
            if (tableContainer) {
                containerRect = tableContainer.getBoundingClientRect();
            }
            
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            let availableSpaceBelow = spaceBelow;
            let availableSpaceAbove = spaceAbove;
            
            if (containerRect) {
                const containerBottom = containerRect.bottom;
                const containerTop = containerRect.top;
                availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
            }
            
            const openUpward = availableSpaceBelow < dropdownHeight && availableSpaceAbove > availableSpaceBelow;
            
            departmentDropdown.style.position = 'fixed';
            if (openUpward) {
                departmentDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                departmentDropdown.style.top = 'auto';
            } else {
                departmentDropdown.style.top = `${rect.bottom + 6}px`;
                departmentDropdown.style.bottom = 'auto';
            }
            departmentDropdown.style.left = `${rect.left}px`;
            departmentDropdown.style.width = `${finalWidth}px`;
            departmentDropdown.style.minWidth = `${finalWidth}px`;
            departmentDropdown.style.maxWidth = `${finalWidth}px`;
            departmentDropdown.style.boxSizing = 'border-box';
            departmentDropdown.style.flexShrink = '0';
            departmentDropdown.style.flexGrow = '0';
            
            const options = departmentDropdown.querySelectorAll('.role-dropdown-option');
            options.forEach(opt => {
                opt.style.width = '100%';
                opt.style.minWidth = '100%';
                opt.style.maxWidth = '100%';
                opt.style.boxSizing = 'border-box';
                opt.classList.toggle('selected', opt.dataset.value === cell.dataset.departmentId);
            });
        }

        function openDepartmentDropdown(cell) {
            currentDepartmentCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateDepartmentDropdown(cell);
            departmentDropdown.classList.add('visible');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionDepartmentDropdown(cell);
                    requestAnimationFrame(() => {
                        positionDepartmentDropdown(cell);
                    });
                });
            });
        }

        function closeDepartmentDropdown() {
            if (currentDepartmentCell) {
                currentDepartmentCell.setAttribute('aria-expanded', 'false');
            }
            currentDepartmentCell = null;
            departmentDropdown.classList.remove('visible');
        }

        document.addEventListener('click', (event) => {
            if (departmentDropdown.contains(event.target)) return;
            if (event.target.closest('.department-cell')) return;
            closeDepartmentDropdown();
        });

        window.addEventListener('resize', () => {
            if (currentDepartmentCell) {
                requestAnimationFrame(() => {
                    positionDepartmentDropdown(currentDepartmentCell);
                });
            }
        });

        window.addEventListener('scroll', () => {
            if (currentDepartmentCell && departmentDropdown.classList.contains('visible')) {
                closeDepartmentDropdown();
            }
        }, true);

        const tableContainerDepartment = document.querySelector('.table-container');
        if (tableContainerDepartment) {
            tableContainerDepartment.addEventListener('scroll', () => {
                if (currentDepartmentCell && departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                }
            });
        }

        departmentCells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (currentDepartmentCell === cell && departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                } else {
                    openDepartmentDropdown(cell);
                }
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.departmentId || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openDepartmentDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeDepartmentDropdown();
                    cell.blur();
                }
            });
        });

        filterSelectWrappers.forEach(wrapper => {
            const targetId = wrapper.dataset.target;
            const selectEl = document.getElementById(targetId);
            if (!selectEl) return;
            const button = wrapper.querySelector('.filter-select-btn');
            const labelEl = wrapper.querySelector('.filter-select-label');
            const optionButtons = wrapper.querySelectorAll('.filter-option');
            const resetBtn = document.querySelector(`.filter-reset-btn[data-target="${targetId}"]`);

            const syncUI = () => {
                const value = selectEl.value || '';
                const matchedOption = Array.from(selectEl.options).find(opt => opt.value === value);
                const labelText = matchedOption ? matchedOption.textContent : optionButtons[0]?.textContent || 'Все';
                if (labelEl) labelEl.textContent = labelText;
                optionButtons.forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.value === value);
                });
                // Показываем/скрываем кнопку сброса
                if (resetBtn) {
                    resetBtn.style.display = value ? 'flex' : 'none';
                }
            };

            optionButtons.forEach(btn => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const value = btn.dataset.value || '';
                    if (selectEl.value !== value) {
                        selectEl.value = value;
                        selectEl.dispatchEvent(new Event('change'));
                    } else {
                        selectEl.dispatchEvent(new Event('change'));
                    }
                    syncUI();
                    closeFilterSelectMenus();
                });
            });

            if (button) {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const isOpen = wrapper.classList.contains('open');
                    closeFilterSelectMenus();
                    if (!isOpen) {
                        wrapper.classList.add('open');
                        button.setAttribute('aria-expanded', 'true');
                    }
                });
            }

            selectEl.addEventListener('change', syncUI);

            // Обработчик клика по кнопке сброса
            if (resetBtn) {
                resetBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    selectEl.value = '';
                    selectEl.dispatchEvent(new Event('change'));
                    syncUI();
                    closeFilterSelectMenus();
                });
            }

            syncUI();
            filterSelectControllers.set(selectEl, { sync: syncUI });
        });

        document.addEventListener('click', (event) => {
            if (!event.target.closest('.filter-select')) {
                closeFilterSelectMenus();
            }
        });

        if (employeeForm) {
            employeeForm.addEventListener('submit', (event) => {
                event.preventDefault();
                if (employeeFormSubmit) {
                    employeeFormSubmit.disabled = true;
                    employeeFormSubmit.textContent = 'Сохранение...';
                }
                if (employeeFormError) {
                    employeeFormError.textContent = '';
                }

                const formData = new FormData(employeeForm);
                const payload = {
                    last_name: formData.get('last_name')?.trim(),
                    first_name: formData.get('first_name')?.trim(),
                    patronymic: formData.get('patronymic')?.trim(),
                    post: formData.get('post')?.trim(),
                    phone: formData.get('phone')?.trim(),
                    email: formData.get('email')?.trim(),
                    facility_id: formData.get('facility_id'),
                    department_id: formData.get('department_id'),
                    role: formData.get('role'),
                    login: formData.get('login')?.trim(),
                    password: formData.get('password')?.trim()
                };

                fetch('/admin/employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        closeEmployeeModal();
                        showStatus('Сотрудник добавлен', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 600);
                    } else {
                        if (employeeFormError) {
                            employeeFormError.textContent = data.message || 'Ошибка сохранения.';
                        }
                    }
                })
                .catch(() => {
                    if (employeeFormError) {
                        employeeFormError.textContent = 'Сеть недоступна. Попробуйте позже.';
                    }
                })
                .finally(() => {
                    if (employeeFormSubmit) {
                        employeeFormSubmit.disabled = false;
                        employeeFormSubmit.textContent = submitDefaultText || 'Сохранить';
                    }
                });
            });
        }

        handleFacilityChange();

        // Инициализация данных для dropdown'ов
        const modalFacilitySelect = document.getElementById('employeeFacilitySelect');
        const modalRoleSelect = document.getElementById('employeeRoleSelect');
        
        if (modalFacilitySelect) {
            modalSelectData.facility = {};
            // Получаем все option, даже если select скрыт
            const facilityOptions = modalFacilitySelect.options || modalFacilitySelect.querySelectorAll('option');
            Array.from(facilityOptions).forEach(opt => {
                if (opt.value !== '') {
                    modalSelectData.facility[opt.value] = opt.textContent.trim();
                }
            });
        }

        if (modalRoleSelect) {
            modalSelectData.role = {};
            const roleOptions = modalRoleSelect.options || modalRoleSelect.querySelectorAll('option');
            Array.from(roleOptions).forEach(opt => {
                if (opt.value !== '') {
                    modalSelectData.role[opt.value] = opt.textContent.trim();
                }
            });
        }

        // Инициализация данных для отдела (будет обновляться при выборе предприятия)
        modalSelectData.department = {};

        function populateModalDropdown(field, options) {
            if (!modalDropdown || !options || Object.keys(options).length === 0) {
                return;
            }
            
            modalDropdown.innerHTML = '';
            Object.entries(options).forEach(([value, label]) => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = value;
                option.textContent = label || value || '—';
                option.addEventListener('click', () => {
                    if (!currentModalSelect) return;
                    const btn = currentModalSelect;
                    const select = btn.parentElement.querySelector('select');
                    const labelSpan = btn.querySelector('.modal-select-label');
                    
                    if (select && labelSpan) {
                        select.value = value;
                        labelSpan.textContent = label;
                        btn.setAttribute('aria-expanded', 'false');
                        
                        // Триггерим change событие для совместимости с существующим кодом
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        // Если выбрано предприятие, обновляем отделы
                        const btnField = btn.dataset.field;
                        if (btnField === 'facility_id') {
                            handleFacilityChange();
                        }
                    }
                    closeModalDropdown();
                });
                modalDropdown.appendChild(option);
            });
        }

        function positionModalDropdown(btn) {
            if (!btn || !modalDropdown) return;
            const rect = btn.getBoundingClientRect();
            const dropdownHeight = modalDropdown.offsetHeight || 200;
            const viewportHeight = window.innerHeight;
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
            
            modalDropdown.style.position = 'fixed';
            if (openUpward) {
                modalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                modalDropdown.style.top = 'auto';
            } else {
                modalDropdown.style.top = `${rect.bottom + 6}px`;
                modalDropdown.style.bottom = 'auto';
            }
            modalDropdown.style.left = `${rect.left}px`;
            modalDropdown.style.width = `${rect.width}px`;
            modalDropdown.style.minWidth = `${rect.width}px`;
            modalDropdown.style.maxWidth = `${rect.width}px`;
        }

        function openModalDropdown(btn) {
            if (!btn || btn.disabled) return;
            const field = btn.dataset.field;
            if (!field) return;
            
            // Маппинг полей к ключам в modalSelectData
            const fieldMap = {
                'facility_id': 'facility',
                'department_id': 'department',
                'role': 'role'
            };
            
            const dataKey = fieldMap[field] || field;
            if (!dataKey || !modalSelectData || !modalSelectData[dataKey] || Object.keys(modalSelectData[dataKey]).length === 0) {
                return;
            }
            
            currentModalSelect = btn;
            populateModalDropdown(field, modalSelectData[dataKey]);
            
            // Ждём, пока dropdown заполнится, затем позиционируем
            requestAnimationFrame(() => {
                positionModalDropdown(btn);
                modalDropdown.classList.add('visible');
                btn.setAttribute('aria-expanded', 'true');
            });
        }

        function closeModalDropdown() {
            if (!modalDropdown) return;
            modalDropdown.classList.remove('visible');
            if (currentModalSelect) {
                currentModalSelect.setAttribute('aria-expanded', 'false');
                currentModalSelect = null;
            }
        }

        // Обработчики для кнопок dropdown'ов
        const modalFacilityBtn = document.getElementById('modalFacilityBtn');
        const modalDepartmentBtn = document.getElementById('modalDepartmentBtn');
        const modalRoleBtn = document.getElementById('modalRoleBtn');

        [modalFacilityBtn, modalDepartmentBtn, modalRoleBtn].forEach(btn => {
            if (!btn) return;
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (btn.disabled) return;
                
                if (currentModalSelect === btn) {
                    closeModalDropdown();
                } else {
                    closeModalDropdown();
                    openModalDropdown(btn);
                }
            });
        });

        // Закрытие при клике вне dropdown'а
        document.addEventListener('click', (e) => {
            // Проверяем, что клик не внутри dropdown'а сотрудников
            if (!modalDropdown.contains(e.target) && 
                !e.target.closest('.modal-select-btn')) {
                closeModalDropdown();
            }
            // Закрываем также dropdown оборудования, если открыт и клик не внутри него
            if (typeof closeEquipmentModalDropdown === 'function') {
                const equipmentModalDropdown = document.getElementById('modalDropdown');
                if (equipmentModalDropdown && equipmentModalDropdown.classList.contains('visible')) {
                    if (!equipmentModalDropdown.contains(e.target) && 
                        !e.target.closest('.modal-select-btn') &&
                        !e.target.closest('#equipmentModal')) {
                        closeEquipmentModalDropdown();
                    }
                }
            }
        });

        // Закрытие по Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalDropdown.classList.contains('visible')) {
                closeModalDropdown();
            }
        });

        // Обработка удаления сотрудника
        const deleteEmployeeModal = document.getElementById('deleteEmployeeModal');
        const deleteEmployeeClose = document.getElementById('deleteEmployeeModalClose');
        const deleteEmployeeCancel = document.getElementById('deleteEmployeeCancel');
        const deleteEmployeeConfirm = document.getElementById('deleteEmployeeConfirm');
        const deleteEmployeeMessage = document.getElementById('deleteEmployeeMessage');
        let employeeToDelete = null;
        let employeeToDeleteRow = null;

        function openDeleteModal(employeeId, employeeRow) {
            if (!deleteEmployeeModal) return;
            
            employeeToDelete = employeeId;
            employeeToDeleteRow = employeeRow;
            
            // Получаем данные сотрудника для отображения в сообщении
            const lastName = employeeRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
            const firstName = employeeRow.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
            const patronymic = employeeRow.querySelector('td:nth-child(4)')?.textContent?.trim() || '';
            
            const fullName = [lastName, firstName, patronymic].filter(Boolean).join(' ') || 'сотрудника';
            if (deleteEmployeeMessage) {
                deleteEmployeeMessage.innerHTML = `Вы уверены, что хотите удалить сотрудника "${fullName}"?<br>Это действие нельзя будет отменить.`;
            }
            
            deleteEmployeeModal.setAttribute('aria-hidden', 'false');
            deleteEmployeeModal.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeDeleteModal() {
            if (!deleteEmployeeModal) {
                console.warn('deleteEmployeeModal не найден');
                return;
            }
            
            try {
                deleteEmployeeModal.setAttribute('aria-hidden', 'true');
                deleteEmployeeModal.classList.remove('visible');
                if (document.body) {
                    document.body.classList.remove('modal-open');
                }
                
                // Сбрасываем состояние кнопки "Удалить"
                if (deleteEmployeeConfirm) {
                    deleteEmployeeConfirm.disabled = false;
                    deleteEmployeeConfirm.textContent = 'Удалить';
                }
                
                employeeToDelete = null;
                employeeToDeleteRow = null;
            } catch (error) {
                console.error('Ошибка при закрытии модального окна:', error);
            }
        }

        // Контекстное меню для сотрудников
        let employeeContextMenu = null;
        let selectedEmployeeRow = null;
        const employeeTable = document.querySelector('.data-table');

        function createEmployeeContextMenu() {
            if (employeeContextMenu) return employeeContextMenu;
            
            employeeContextMenu = document.createElement('div');
            employeeContextMenu.className = 'context-menu';
            employeeContextMenu.innerHTML = `
                <button type="button" class="context-menu-item danger" id="employeeDeleteBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Удалить сотрудника
                </button>
            `;
            document.body.appendChild(employeeContextMenu);
            
            const deleteBtn = document.getElementById('employeeDeleteBtn');
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    if (selectedEmployeeRow) {
                        const employeeId = selectedEmployeeRow.dataset.employeeId;
                        if (employeeId) {
                            openDeleteModal(parseInt(employeeId), selectedEmployeeRow);
                        }
                    }
                    hideEmployeeContextMenu();
                });
            }
            
            return employeeContextMenu;
        }

        function showEmployeeContextMenu(event, row) {
            event.preventDefault();
            event.stopPropagation();
            
            const menu = createEmployeeContextMenu();
            selectedEmployeeRow = row;
            
            const tableContainer = document.querySelector('.table-container');
            if (!tableContainer) return;
            
            // Сначала показываем меню, чтобы получить его размеры
            menu.style.display = 'block';
            menu.style.visibility = 'hidden';
            menu.style.left = '0px';
            menu.style.top = '0px';
            
            const containerRect = tableContainer.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            
            // Используем координаты клика относительно viewport
            let left = event.clientX;
            let top = event.clientY;
            
            // Проверяем, не выходит ли меню за правую границу таблицы
            if (left + menuRect.width > containerRect.right) {
                left = containerRect.right - menuRect.width - 10;
            }
            
            // Проверяем, не выходит ли меню за левую границу таблицы
            if (left < containerRect.left) {
                left = containerRect.left + 10;
            }
            
            // Проверяем, не выходит ли меню за нижнюю границу таблицы
            if (top + menuRect.height > containerRect.bottom) {
                top = containerRect.bottom - menuRect.height - 10;
            }
            
            // Проверяем, не выходит ли меню за верхнюю границу таблицы
            if (top < containerRect.top) {
                top = containerRect.top + 10;
            }
            
            // Устанавливаем финальную позицию и делаем меню видимым
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.visibility = 'visible';
            
            // Закрываем меню при клике вне его
            setTimeout(() => {
                document.addEventListener('click', hideEmployeeContextMenu, { once: true });
            }, 0);
        }

        function hideEmployeeContextMenu() {
            if (employeeContextMenu) {
                employeeContextMenu.style.display = 'none';
            }
        }

        // Добавляем обработчики клика и ПКМ на строки таблицы сотрудников
        // Используем делегирование событий, чтобы не мешать редактированию ячеек
        if (employeeTable) {
            const tbody = employeeTable.querySelector('tbody');
            if (tbody) {
                // Функция для получения всех строк таблицы сотрудников
                function getAllEmployeeRows() {
                    return employeeTable ? employeeTable.querySelectorAll('tbody tr') : [];
                }
                
                // Функция для обновления выделения (больше не нужна, так как используем границы на ячейках)
                function updateSelectedRowBorder() {
                    // Теперь используем границы на ячейках, поэтому эта функция не нужна
                }
                
                // Одинарный клик - выделение строки
                tbody.addEventListener('click', (e) => {
                    // Игнорируем клики по редактируемым ячейкам
                    if (e.target.closest('.editable-cell[contenteditable="true"]')) {
                        return;
                    }
                    
                    const row = e.target.closest('tr');
                    if (row) {
                        // Если строка уже выделена, убираем выделение
                        if (row.classList.contains('selected')) {
                            row.classList.remove('selected');
                        } else {
                            // Убираем выделение с других строк
                            getAllEmployeeRows().forEach(r => r.classList.remove('selected'));
                            // Выделяем текущую строку
                            row.classList.add('selected');
                        }
                    }
                });
                
                // Убираем выделение при клике вне таблицы
                document.addEventListener('click', (e) => {
                    // Проверяем, что клик был не по таблице и не по контекстному меню
                    if (!employeeTable.contains(e.target) && 
                        !(employeeContextMenu && employeeContextMenu.contains(e.target))) {
                        getAllEmployeeRows().forEach(r => r.classList.remove('selected'));
                    }
                });
                
                // ПКМ - выделение строки и показ контекстного меню
                tbody.addEventListener('contextmenu', (e) => {
                    // Проверяем, что клик был по строке, а не по редактируемой ячейке
                    const row = e.target.closest('tr');
                    if (row && !e.target.closest('.editable-cell[contenteditable="true"]')) {
                        e.preventDefault();
                        // Убираем выделение с других строк
                        getAllEmployeeRows().forEach(r => r.classList.remove('selected'));
                        // Выделяем текущую строку
                        row.classList.add('selected');
                        showEmployeeContextMenu(e, row);
                    }
                });
                
                // Обновляем позицию границы при изменении размера окна
                window.addEventListener('resize', updateSelectedRowBorder);
            }
        }

        // Обработчики закрытия модального окна
        if (deleteEmployeeClose) {
            deleteEmployeeClose.addEventListener('click', closeDeleteModal);
        }
        if (deleteEmployeeCancel) {
            deleteEmployeeCancel.addEventListener('click', closeDeleteModal);
        }

        // Закрытие по клику на overlay
        if (deleteEmployeeModal) {
            deleteEmployeeModal.addEventListener('click', (event) => {
                if (event.target === deleteEmployeeModal) {
                    closeDeleteModal();
                }
            });
        }

        // Подтверждение удаления
        if (deleteEmployeeConfirm) {
            deleteEmployeeConfirm.addEventListener('click', async () => {
                if (!employeeToDelete) return;
                
                deleteEmployeeConfirm.disabled = true;
                deleteEmployeeConfirm.textContent = 'Удаление...';
                
                try {
                    const response = await fetch(`/admin/employees/${employeeToDelete}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.error('Ошибка парсинга ответа:', parseError);
                        // Если запись уже удалена из таблицы, закрываем модальное окно
                        if (!employeeToDeleteRow || !document.contains(employeeToDeleteRow)) {
                            closeDeleteModal();
                            return;
                        }
                        throw new Error('Не удалось обработать ответ сервера');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    if (data.success) {
                        // Удаляем строку из таблицы
                        if (employeeToDeleteRow && document.contains(employeeToDeleteRow)) {
                            employeeToDeleteRow.remove();
                            
                            // Обновляем нумерацию строк
                            document.querySelectorAll('.data-table tbody tr').forEach((row, index) => {
                                const numberCell = row.querySelector('.number-column');
                                if (numberCell) {
                                    numberCell.textContent = index + 1;
                                }
                            });
                            
                            // Показываем уведомление об успехе
                            if (typeof showStatus === 'function') {
                                showStatus('Изменения сохранены', 'success');
                            }
                        }
                        // Закрываем модальное окно
                        closeDeleteModal();
                    } else {
                        if (typeof showStatus === 'function') {
                            showStatus(data.message || 'Не удалось удалить сотрудника', 'error');
                        }
                        deleteEmployeeConfirm.disabled = false;
                        deleteEmployeeConfirm.textContent = 'Удалить';
                    }
                } catch (error) {
                    console.error('Ошибка при удалении сотрудника:', error);
                    // Если запись уже удалена из таблицы, закрываем модальное окно
                    if (!employeeToDeleteRow || !document.contains(employeeToDeleteRow)) {
                        closeDeleteModal();
                        return;
                    }
                    if (typeof showStatus === 'function') {
                        showStatus('Произошла ошибка при удалении сотрудника', 'error');
                    }
                    deleteEmployeeConfirm.disabled = false;
                    deleteEmployeeConfirm.textContent = 'Удалить';
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (employeeContextMenu && employeeContextMenu.style.display === 'block') {
                    hideEmployeeContextMenu();
                    return;
                }
                if (roleDropdown.classList.contains('visible')) {
                    closeRoleDropdown();
                    return;
                }
                if (facilityDropdown.classList.contains('visible')) {
                    closeFacilityDropdown();
                    return;
                }
                if (departmentDropdown.classList.contains('visible')) {
                    closeDepartmentDropdown();
                    return;
                }
                if (deleteEmployeeModal && deleteEmployeeModal.classList.contains('visible')) {
                    closeDeleteModal();
                    return;
                }
                if (activeModal) {
                    closeEmployeeModal();
                }
            }
        });

        applyTableFilters();
        {% endif %}

        {% if section == 'warehouse' %}
        // JavaScript для страницы склада
        const warehouseSearchInput = document.getElementById('warehouseSearch');
        const warehouseFilterToggle = document.getElementById('warehouseFilterToggle');
        const warehouseFilterDropdown = document.getElementById('warehouseFilterDropdown');
        const facilityWarehouseFilter = document.getElementById('facilityWarehouseFilter');
        const warehouseAddressFilter = document.getElementById('warehouseAddressFilter');
        const sparePartFilter = document.getElementById('sparePartFilter');
        const warehouseTableRows = document.querySelectorAll('.data-table tbody tr');
        const warehouseResetFiltersBtn = document.getElementById('warehouseResetFilters');
        const addPartBtn = document.getElementById('addPartBtn');
        const partModal = document.getElementById('partModal');
        const partModalClose = document.getElementById('partModalClose');
        const partModalCancel = document.getElementById('partModalCancel');
        const partForm = document.getElementById('partForm');
        const partFormError = document.getElementById('partFormError');
        const partFormSubmit = document.getElementById('partFormSubmit');
        const partFacilitySelect = document.getElementById('partFacilitySelect');
        const partWarehouseSelect = document.getElementById('partWarehouseSelect');
        const modalPartFacilityBtn = document.getElementById('modalPartFacilityBtn');
        const modalPartWarehouseBtn = document.getElementById('modalPartWarehouseBtn');
        const partQuantityInput = document.getElementById('partQuantity');
        
        // Переменные для выделения строк и контекстного меню
        let selectedWarehouseRow = null;
        let warehouseContextMenu = null;
        const warehouseTable = document.querySelector('.data-table');
        
        // Переменные для модального окна удаления
        const deleteWarehouseModal = document.getElementById('deleteWarehouseModal');
        const deleteWarehouseClose = document.getElementById('deleteWarehouseModalClose');
        const deleteWarehouseCancel = document.getElementById('deleteWarehouseCancel');
        const deleteWarehouseConfirm = document.getElementById('deleteWarehouseConfirm');
        const deleteWarehouseMessage = document.getElementById('deleteWarehouseMessage');
        let warehouseToDelete = null;
        let warehouseToDeleteRow = null;
        
        // Данные для модального окна
        const warehousesData = {{ warehouse_choices|tojson }};
        const warehouseFacilityMap = {};
        warehousesData.forEach(wh => {
            const facilityId = wh.facility_id ? String(wh.facility_id) : '';
            if (facilityId) {
                if (!warehouseFacilityMap[facilityId]) {
                    warehouseFacilityMap[facilityId] = [];
                }
                warehouseFacilityMap[facilityId].push({
                    id: String(wh.id),
                    name: wh.department || wh.type || '—'
                });
            }
        });

        function applyWarehouseRowStriping() {
            let visibleIndex = 0;
            warehouseTableRows.forEach(row => {
                if (row.style.display === 'none') {
                    row.classList.remove('alt-row');
                    return;
                }
                const isAlt = visibleIndex % 2 === 1;
                row.classList.toggle('alt-row', isAlt);
                visibleIndex += 1;
            });
        }

        function applyWarehouseTableFilters() {
            const searchValue = warehouseSearchInput ? warehouseSearchInput.value.toLowerCase().trim() : '';
            const facilityValue = facilityWarehouseFilter ? facilityWarehouseFilter.value : '';
            const warehouseValue = warehouseAddressFilter ? warehouseAddressFilter.value : '';
            const sparePartValue = sparePartFilter ? sparePartFilter.value : '';

            warehouseTableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowFacility = (row.dataset.facility || '').toLowerCase();
                const rowWarehouse = (row.dataset.warehouse || '').toLowerCase();
                const rowSparePart = (row.dataset.sparePart || '').toLowerCase();

                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesFacility = facilityValue === '' || rowFacility === facilityValue.toLowerCase();
                const matchesWarehouse = warehouseValue === '' || rowWarehouse === warehouseValue.toLowerCase();
                const matchesSparePart = sparePartValue === '' || rowSparePart === sparePartValue.toLowerCase();

                row.style.display = (matchesSearch && matchesFacility && matchesWarehouse && matchesSparePart) ? '' : 'none';
            });

            applyWarehouseRowStriping();
        }

        if (warehouseSearchInput) {
            warehouseSearchInput.addEventListener('input', applyWarehouseTableFilters);
        }

        [facilityWarehouseFilter, warehouseAddressFilter, sparePartFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', applyWarehouseTableFilters);
            }
        });

        const warehouseFilterSelectWrappers = document.querySelectorAll('#warehouseFilterDropdown .filter-select[data-target]');
        const warehouseFilterSelectControllers = new Map();

        function closeWarehouseFilterSelectMenus() {
            warehouseFilterSelectWrappers.forEach(wrapper => {
                wrapper.classList.remove('open');
                const btn = wrapper.querySelector('.filter-select-btn');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (warehouseFilterToggle && warehouseFilterDropdown) {
            warehouseFilterToggle.addEventListener('click', () => {
                warehouseFilterDropdown.classList.toggle('active');
                warehouseFilterToggle.classList.toggle('active');
                if (!warehouseFilterDropdown.classList.contains('active')) {
                    closeWarehouseFilterSelectMenus();
                }
            });

            document.addEventListener('click', (event) => {
                if (!warehouseFilterDropdown.contains(event.target) && !warehouseFilterToggle.contains(event.target)) {
                    warehouseFilterDropdown.classList.remove('active');
                    warehouseFilterToggle.classList.remove('active');
                    closeWarehouseFilterSelectMenus();
                }
            });
        }

        if (warehouseResetFiltersBtn) {
            warehouseResetFiltersBtn.addEventListener('click', () => {
                if (warehouseSearchInput) warehouseSearchInput.value = '';
                if (facilityWarehouseFilter) facilityWarehouseFilter.value = '';
                if (warehouseAddressFilter) warehouseAddressFilter.value = '';
                if (sparePartFilter) sparePartFilter.value = '';
                applyWarehouseTableFilters();
                warehouseFilterSelectControllers.forEach(controller => controller.sync());
            });
        }

        // Инициализация кастомных фильтров для склада
        warehouseFilterSelectWrappers.forEach(wrapper => {
            const targetId = wrapper.dataset.target;
            const nativeSelect = document.getElementById(targetId);
            if (!nativeSelect) return;

            const btn = wrapper.querySelector('.filter-select-btn');
            const label = btn?.querySelector('.filter-select-label');
            const optionsList = wrapper.querySelector('.filter-options-list');
            const resetBtn = wrapper.parentElement.querySelector('.filter-reset-btn');

            function syncSelect() {
                const selectedOption = nativeSelect.options[nativeSelect.selectedIndex];
                const selectedValue = nativeSelect.value;
                const selectedText = selectedOption ? selectedOption.textContent : 'Все';

                if (label) {
                    label.textContent = selectedText;
                }

                if (resetBtn) {
                    resetBtn.style.display = selectedValue ? '' : 'none';
                }

                if (optionsList) {
                    optionsList.querySelectorAll('.filter-option').forEach(opt => {
                        opt.classList.toggle('selected', opt.dataset.value === selectedValue);
                    });
                }
            }

            function selectOption(value) {
                nativeSelect.value = value;
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                syncSelect();
                closeWarehouseFilterSelectMenus();
            }

            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = wrapper.classList.contains('open');
                    closeWarehouseFilterSelectMenus();
                    if (!isOpen) {
                        wrapper.classList.add('open');
                        btn.setAttribute('aria-expanded', 'true');
                    }
                });
            }

            if (optionsList) {
                optionsList.querySelectorAll('.filter-option').forEach(opt => {
                    opt.addEventListener('click', () => {
                        selectOption(opt.dataset.value);
                    });
                });
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectOption('');
                });
            }

            nativeSelect.addEventListener('change', syncSelect);
            syncSelect();

            warehouseFilterSelectControllers.set(targetId, { sync: syncSelect });
        });

        function openPartModal() {
            if (!partModal) return;
            partModal.classList.add('visible');
            partModal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            
            // Закрываем все открытые dropdown'ы
            closePartFacilityDropdown();
            closePartWarehouseDropdown();
            
            if (partForm) {
                partForm.reset();
            }
            
            // Сбрасываем кастомные dropdown'ы
            if (modalPartFacilityBtn) {
                const label = modalPartFacilityBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Выберите предприятие';
                modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
            }
            if (modalPartWarehouseBtn) {
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) label.textContent = 'Сначала выберите предприятие';
                modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                modalPartWarehouseBtn.disabled = true;
            }
            
            if (partFacilitySelect) {
                partFacilitySelect.value = '';
                populateWarehouseOptions('');
            }
            if (partFormError) {
                partFormError.textContent = '';
            }
            
            const firstInput = partForm ? partForm.querySelector('input, .modal-select-btn') : null;
            if (firstInput) {
                firstInput.focus();
            }
        }

        function closePartModal() {
            if (!partModal) return;
            // Закрываем все открытые dropdown'ы
            closePartFacilityDropdown();
            closePartWarehouseDropdown();
            partModal.classList.remove('visible');
            partModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }

        function populateWarehouseOptions(facilityId) {
            if (!partWarehouseSelect) return;
            
            partWarehouseSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = facilityId ? 'Выберите склад' : 'Сначала выберите предприятие';
            placeholder.disabled = !facilityId;
            placeholder.selected = true;
            partWarehouseSelect.appendChild(placeholder);

            if (!facilityId) {
                partWarehouseSelect.disabled = true;
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.disabled = true;
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = 'Сначала выберите предприятие';
                    }
                }
                return;
            }

            const warehouses = warehouseFacilityMap[facilityId] || [];
            if (warehouses.length === 0) {
                placeholder.textContent = 'Для выбранного предприятия нет складов';
                partWarehouseSelect.disabled = true;
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.disabled = true;
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = 'Для выбранного предприятия нет складов';
                    }
                }
                return;
            }
            
            warehouses.forEach(wh => {
                const option = document.createElement('option');
                option.value = wh.id;
                option.textContent = wh.name;
                partWarehouseSelect.appendChild(option);
            });
            partWarehouseSelect.disabled = false;
            if (modalPartWarehouseBtn) {
                modalPartWarehouseBtn.disabled = false;
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = 'Выберите склад';
                }
            }
        }

        function handlePartFacilityChange() {
            if (!partFacilitySelect) return;
            const facilityId = partFacilitySelect.value;
            populateWarehouseOptions(facilityId);
            if (partWarehouseSelect) {
                partWarehouseSelect.value = '';
            }
            const modalPartWarehouseBtn = document.getElementById('modalPartWarehouseBtn');
            if (modalPartWarehouseBtn) {
                const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                if (label) {
                    label.textContent = facilityId ? 'Выберите склад' : 'Сначала выберите предприятие';
                }
            }
        }

        if (addPartBtn) {
            addPartBtn.addEventListener('click', () => {
                closeWarehouseFilterSelectMenus();
                openPartModal();
            });
        }

        [partModalClose, partModalCancel].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    closePartModal();
                });
            }
        });

        if (partFacilitySelect) {
            partFacilitySelect.addEventListener('change', handlePartFacilityChange);
        }

        // Создаём кастомный dropdown для предприятия в модальном окне
        const partFacilityDropdown = document.createElement('div');
        partFacilityDropdown.className = 'role-dropdown';
        partFacilityDropdown.style.zIndex = '6000';
        document.body.appendChild(partFacilityDropdown);
        
        let currentPartFacilityBtn = null;

        function populatePartFacilityDropdown() {
            if (!partFacilitySelect || !partFacilityDropdown) return;
            
            partFacilityDropdown.innerHTML = '';
            const facilityOptions = partFacilitySelect.options || partFacilitySelect.querySelectorAll('option');
            
            Array.from(facilityOptions).forEach(opt => {
                if (opt.value === '') return; // Пропускаем placeholder
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = opt.value;
                option.textContent = opt.textContent.trim();
                
                option.addEventListener('click', () => {
                    const value = option.dataset.value;
                    const label = option.textContent;
                    
                    if (partFacilitySelect) {
                        partFacilitySelect.value = value;
                        partFacilitySelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    if (currentPartFacilityBtn) {
                        const labelSpan = currentPartFacilityBtn.querySelector('.modal-select-label');
                        if (labelSpan) {
                            labelSpan.textContent = label;
                        }
                        currentPartFacilityBtn.setAttribute('aria-expanded', 'false');
                    }
                    
                    closePartFacilityDropdown();
                    
                    // Обновляем список складов
                    if (handlePartFacilityChange) {
                        handlePartFacilityChange();
                    }
                });
                
                partFacilityDropdown.appendChild(option);
            });
        }

        function openPartFacilityDropdown(btn) {
            if (!btn || !partFacilityDropdown) return;
            
            if (currentPartFacilityBtn === btn && partFacilityDropdown.classList.contains('visible')) {
                closePartFacilityDropdown();
                return;
            }
            
            currentPartFacilityBtn = btn;
            populatePartFacilityDropdown();
            
            const rect = btn.getBoundingClientRect();
            partFacilityDropdown.style.position = 'fixed';
            partFacilityDropdown.style.left = rect.left + 'px';
            partFacilityDropdown.style.top = (rect.bottom + 4) + 'px';
            partFacilityDropdown.style.minWidth = rect.width + 'px';
            partFacilityDropdown.style.maxWidth = '300px';
            partFacilityDropdown.classList.add('visible');
            btn.setAttribute('aria-expanded', 'true');
        }

        function closePartFacilityDropdown() {
            if (!partFacilityDropdown) return;
            partFacilityDropdown.classList.remove('visible');
            if (currentPartFacilityBtn) {
                currentPartFacilityBtn.setAttribute('aria-expanded', 'false');
                currentPartFacilityBtn = null;
            }
        }

        // Кастомные dropdown'ы для модального окна склада
        if (modalPartFacilityBtn) {
            modalPartFacilityBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalPartWarehouseBtn) {
                    modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                }
                openPartFacilityDropdown(modalPartFacilityBtn);
            });
        }

        // Закрытие dropdown при клике вне его
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modal-select-btn[data-field="facility_id"]') && 
                !partFacilityDropdown.contains(e.target)) {
                closePartFacilityDropdown();
            }
        }, true);

        // Создаём кастомный dropdown для склада в модальном окне
        const partWarehouseDropdown = document.createElement('div');
        partWarehouseDropdown.className = 'role-dropdown';
        partWarehouseDropdown.style.zIndex = '6000';
        document.body.appendChild(partWarehouseDropdown);
        
        let currentPartWarehouseBtn = null;

        function populatePartWarehouseDropdown() {
            if (!partWarehouseSelect || !partWarehouseDropdown) return;
            
            partWarehouseDropdown.innerHTML = '';
            const warehouseOptions = partWarehouseSelect.options || partWarehouseSelect.querySelectorAll('option');
            
            Array.from(warehouseOptions).forEach(opt => {
                if (opt.value === '' || opt.disabled) return; // Пропускаем placeholder и disabled
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.dataset.value = opt.value;
                option.textContent = opt.textContent.trim();
                
                option.addEventListener('click', () => {
                    const value = option.dataset.value;
                    const label = option.textContent;
                    
                    if (partWarehouseSelect) {
                        partWarehouseSelect.value = value;
                        partWarehouseSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    if (currentPartWarehouseBtn) {
                        const labelSpan = currentPartWarehouseBtn.querySelector('.modal-select-label');
                        if (labelSpan) {
                            labelSpan.textContent = label;
                        }
                        currentPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                    }
                    
                    closePartWarehouseDropdown();
                });
                
                partWarehouseDropdown.appendChild(option);
            });
        }

        function openPartWarehouseDropdown(btn) {
            if (!btn || btn.disabled || !partWarehouseDropdown) return;
            
            if (currentPartWarehouseBtn === btn && partWarehouseDropdown.classList.contains('visible')) {
                closePartWarehouseDropdown();
                return;
            }
            
            currentPartWarehouseBtn = btn;
            populatePartWarehouseDropdown();
            
            const rect = btn.getBoundingClientRect();
            partWarehouseDropdown.style.position = 'fixed';
            partWarehouseDropdown.style.left = rect.left + 'px';
            partWarehouseDropdown.style.top = (rect.bottom + 4) + 'px';
            partWarehouseDropdown.style.minWidth = rect.width + 'px';
            partWarehouseDropdown.style.maxWidth = '300px';
            partWarehouseDropdown.classList.add('visible');
            btn.setAttribute('aria-expanded', 'true');
        }

        function closePartWarehouseDropdown() {
            if (!partWarehouseDropdown) return;
            partWarehouseDropdown.classList.remove('visible');
            if (currentPartWarehouseBtn) {
                currentPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                currentPartWarehouseBtn = null;
            }
        }

        if (modalPartWarehouseBtn) {
            modalPartWarehouseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalPartFacilityBtn) {
                    closePartFacilityDropdown();
                }
                openPartWarehouseDropdown(modalPartWarehouseBtn);
            });
        }

        // Закрытие dropdown при клике вне его
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modal-select-btn[data-field="warehouse_id"]') && 
                !partWarehouseDropdown.contains(e.target)) {
                closePartWarehouseDropdown();
            }
        }, true);

        // Обработка прокрутки колёсиком мыши для поля количества
        if (partQuantityInput) {
            const quantityWrapper = partQuantityInput.closest('.number-input-wrapper');
            
            // Функция для обработки прокрутки
            function handleQuantityWheel(e) {
                // Проверяем, что поле в фокусе или курсор над полем/обёрткой
                const isOverInput = document.activeElement === partQuantityInput;
                const isOverWrapper = quantityWrapper && quantityWrapper.contains(e.target);
                
                if (isOverInput || isOverWrapper) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const currentValue = parseInt(partQuantityInput.value) || parseInt(partQuantityInput.min) || 1;
                    const minValue = parseInt(partQuantityInput.min) || 1;
                    const step = 1;
                    
                    // Определяем направление прокрутки
                    let newValue;
                    if (e.deltaY < 0) {
                        // Прокрутка вверх - увеличиваем
                        newValue = currentValue + step;
                    } else {
                        // Прокрутка вниз - уменьшаем
                        newValue = Math.max(minValue, currentValue - step);
                    }
                    
                    // Устанавливаем новое значение
                    partQuantityInput.value = newValue;
                    
                    // Триггерим событие input для валидации
                    partQuantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
            
            // Обработчик для самого input
            partQuantityInput.addEventListener('wheel', handleQuantityWheel, { passive: false });
            
            // Обработчик для обёртки (чтобы работало при наведении на стрелки)
            if (quantityWrapper) {
                quantityWrapper.addEventListener('wheel', handleQuantityWheel, { passive: false });
            }

            // Обработка кликов на кастомные кнопки-стрелки
            if (quantityWrapper) {
                const btnUp = quantityWrapper.querySelector('.number-input-btn-up');
                const btnDown = quantityWrapper.querySelector('.number-input-btn-down');
                
                if (btnUp) {
                    btnUp.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const currentValue = parseInt(partQuantityInput.value) || parseInt(partQuantityInput.min) || 1;
                        const newValue = currentValue + 1;
                        partQuantityInput.value = newValue;
                        partQuantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }
                
                if (btnDown) {
                    btnDown.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const currentValue = parseInt(partQuantityInput.value) || parseInt(partQuantityInput.min) || 1;
                        const minValue = parseInt(partQuantityInput.min) || 1;
                        const newValue = Math.max(minValue, currentValue - 1);
                        partQuantityInput.value = newValue;
                        partQuantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }
            }
        }

        // Синхронизация кастомных кнопок с нативными select
        if (partFacilitySelect) {
            partFacilitySelect.addEventListener('change', () => {
                const selectedOption = partFacilitySelect.options[partFacilitySelect.selectedIndex];
                if (modalPartFacilityBtn) {
                    const label = modalPartFacilityBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : 'Выберите предприятие';
                    }
                    modalPartFacilityBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        if (partWarehouseSelect) {
            partWarehouseSelect.addEventListener('change', () => {
                const selectedOption = partWarehouseSelect.options[partWarehouseSelect.selectedIndex];
                if (modalPartWarehouseBtn) {
                    const label = modalPartWarehouseBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = selectedOption ? selectedOption.textContent : 'Выберите склад';
                    }
                    modalPartWarehouseBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Обработка отправки формы
        if (partForm) {
            partForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!partFormSubmit) return;
                partFormSubmit.disabled = true;
                const originalText = partFormSubmit.textContent;
                partFormSubmit.textContent = 'Сохранение...';
                
                if (partFormError) {
                    partFormError.textContent = '';
                }

                const formData = {
                    spare_part_name: document.getElementById('partSparePartName')?.value.trim() || '',
                    quantity: document.getElementById('partQuantity')?.value || '',
                    warehouse_id: partWarehouseSelect?.value || ''
                };

                try {
                    const response = await fetch('{{ url_for("admin_warehouse.create_part") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        closePartModal();
                        location.reload();
                    } else {
                        if (partFormError) {
                            partFormError.textContent = data.message || 'Не удалось добавить деталь';
                        }
                        partFormSubmit.disabled = false;
                        partFormSubmit.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Ошибка при добавлении детали:', error);
                    if (partFormError) {
                        partFormError.textContent = 'Произошла ошибка при добавлении детали';
                    }
                    partFormSubmit.disabled = false;
                    partFormSubmit.textContent = originalText;
                }
            });
        }

        // Закрытие модального окна по клику вне его
        if (partModal) {
            partModal.addEventListener('click', (e) => {
                if (e.target === partModal) {
                    closePartModal();
                }
            });
        }

        // Закрытие модальных окон по Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // Закрываем открытые dropdown'ы
                if (partFacilityDropdown && partFacilityDropdown.classList.contains('visible')) {
                    closePartFacilityDropdown();
                    event.preventDefault();
                    return;
                }
                if (partWarehouseDropdown && partWarehouseDropdown.classList.contains('visible')) {
                    closePartWarehouseDropdown();
                    event.preventDefault();
                    return;
                }
                // Закрываем модальные окна
                if (partModal && partModal.classList.contains('visible')) {
                    closePartModal();
                } else if (deleteWarehouseModal && deleteWarehouseModal.classList.contains('visible')) {
                    closeDeleteWarehouseModal();
                }
            }
        });

        // Функции для работы с контекстным меню
        function createWarehouseContextMenu() {
            if (warehouseContextMenu) return warehouseContextMenu;
            
            warehouseContextMenu = document.createElement('div');
            warehouseContextMenu.className = 'context-menu';
            warehouseContextMenu.innerHTML = `
                <button type="button" class="context-menu-item danger" id="warehouseDeleteBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Удалить
                </button>
            `;
            document.body.appendChild(warehouseContextMenu);
            
            const deleteBtn = document.getElementById('warehouseDeleteBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    if (selectedWarehouseRow) {
                        const partId = selectedWarehouseRow.dataset.partId;
                        if (partId) {
                            openDeleteWarehouseModal(parseInt(partId), selectedWarehouseRow);
                        }
                    }
                    hideWarehouseContextMenu();
                });
            }
            
            return warehouseContextMenu;
        }

        function showWarehouseContextMenu(event, row) {
            event.preventDefault();
            event.stopPropagation();
            
            const menu = createWarehouseContextMenu();
            selectedWarehouseRow = row;
            
            const tableContainer = document.querySelector('.table-container');
            if (!tableContainer) return;
            
            // Сначала показываем меню, чтобы получить его размеры
            menu.style.display = 'block';
            menu.style.visibility = 'hidden';
            menu.style.left = '0px';
            menu.style.top = '0px';
            
            const containerRect = tableContainer.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            
            // Используем координаты клика относительно viewport
            let left = event.clientX;
            let top = event.clientY;
            
            // Проверяем, не выходит ли меню за правую границу таблицы
            if (left + menuRect.width > containerRect.right) {
                left = containerRect.right - menuRect.width - 10;
            }
            
            // Проверяем, не выходит ли меню за левую границу таблицы
            if (left < containerRect.left) {
                left = containerRect.left + 10;
            }
            
            // Проверяем, не выходит ли меню за нижнюю границу таблицы
            if (top + menuRect.height > containerRect.bottom) {
                top = containerRect.bottom - menuRect.height - 10;
            }
            
            // Проверяем, не выходит ли меню за верхнюю границу таблицы
            if (top < containerRect.top) {
                top = containerRect.top + 10;
            }
            
            // Устанавливаем финальную позицию
            menu.style.position = 'fixed';
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.visibility = 'visible';
            
            // Закрываем меню при клике вне его
            setTimeout(() => {
                document.addEventListener('click', hideWarehouseContextMenu, { once: true });
            }, 0);
        }

        function hideWarehouseContextMenu() {
            if (warehouseContextMenu) {
                warehouseContextMenu.style.display = 'none';
            }
        }

        function getAllWarehouseRows() {
            return Array.from(document.querySelectorAll('.data-table tbody tr[data-part-id]'));
        }

        // Обработка выделения строк и контекстного меню
        if (warehouseTable) {
            const tbody = warehouseTable.querySelector('tbody');
            if (tbody) {
                // Одинарный клик - выделение строки
                tbody.addEventListener('click', (e) => {
                    // Игнорируем клики по редактируемым ячейкам и quantity input
                    if (e.target.closest('.editable-cell[contenteditable="true"]') ||
                        e.target.closest('.quantity-input-wrapper') ||
                        e.target.closest('.quantity-input') ||
                        e.target.closest('.quantity-input-btn')) {
                        return;
                    }
                    const row = e.target.closest('tr[data-part-id]');
                    if (row) {
                        // Если строка уже выделена, убираем выделение
                        if (row.classList.contains('selected')) {
                            row.classList.remove('selected');
                            selectedWarehouseRow = null;
                        } else {
                            // Убираем выделение с других строк
                            getAllWarehouseRows().forEach(r => r.classList.remove('selected'));
                            // Выделяем текущую строку
                            row.classList.add('selected');
                            selectedWarehouseRow = row;
                        }
                    }
                });
                
                // Убираем выделение при клике вне таблицы
                document.addEventListener('click', (e) => {
                    // Проверяем, что клик был не по таблице и не по контекстному меню
                    if (!warehouseTable.contains(e.target) && 
                        !(warehouseContextMenu && warehouseContextMenu.contains(e.target))) {
                        // Не убираем выделение, если клик был по редактируемой ячейке или quantity input
                        if (e.target.closest('.editable-cell[contenteditable="true"]') ||
                            e.target.closest('.quantity-input-wrapper') ||
                            e.target.closest('.quantity-input') ||
                            e.target.closest('.quantity-input-btn')) {
                            return;
                        }
                        getAllWarehouseRows().forEach(r => r.classList.remove('selected'));
                        selectedWarehouseRow = null;
                    }
                });
                
                // ПКМ - выделение строки и показ контекстного меню
                tbody.addEventListener('contextmenu', (e) => {
                    const row = e.target.closest('tr[data-part-id]');
                    if (row) {
                        e.preventDefault();
                        // Убираем выделение с других строк
                        getAllWarehouseRows().forEach(r => r.classList.remove('selected'));
                        // Выделяем текущую строку
                        row.classList.add('selected');
                        selectedWarehouseRow = row;
                        showWarehouseContextMenu(e, row);
                    }
                });
            }
        }

        // Закрытие контекстного меню при нажатии Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && warehouseContextMenu && warehouseContextMenu.style.display === 'block') {
                hideWarehouseContextMenu();
            }
        });

        // Функции для работы с модальным окном удаления
        function openDeleteWarehouseModal(partId, partRow) {
            if (!deleteWarehouseModal) return;
            
            warehouseToDelete = partId;
            warehouseToDeleteRow = partRow;
            
            // Получаем данные записи для отображения в сообщении
            const sparePartName = partRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
            const facilityName = partRow.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
            const warehouseName = partRow.querySelector('td:nth-child(4)')?.textContent?.trim() || '';
            const quantity = partRow.querySelector('td:nth-child(5)')?.textContent?.trim() || '';
            
            let message = 'Вы уверены, что хотите удалить эту запись?';
            if (sparePartName || warehouseName) {
                const details = [sparePartName, warehouseName].filter(Boolean).join(' (');
                message = `Вы уверены, что хотите удалить запись "${details}${details.includes('(') ? ')' : ''}"?`;
            }
            message += '<br>Это действие нельзя будет отменить.';
            
            if (deleteWarehouseMessage) {
                deleteWarehouseMessage.innerHTML = message;
            }
            
            deleteWarehouseModal.setAttribute('aria-hidden', 'false');
            deleteWarehouseModal.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeDeleteWarehouseModal() {
            if (!deleteWarehouseModal) return;
            
            deleteWarehouseModal.setAttribute('aria-hidden', 'true');
            deleteWarehouseModal.classList.remove('visible');
            document.body.classList.remove('modal-open');
            warehouseToDelete = null;
            warehouseToDeleteRow = null;
            
            if (deleteWarehouseConfirm) {
                deleteWarehouseConfirm.disabled = false;
                deleteWarehouseConfirm.textContent = 'Удалить';
            }
        }

        // Обработчики закрытия модального окна
        if (deleteWarehouseClose) {
            deleteWarehouseClose.addEventListener('click', closeDeleteWarehouseModal);
        }
        if (deleteWarehouseCancel) {
            deleteWarehouseCancel.addEventListener('click', closeDeleteWarehouseModal);
        }

        // Закрытие по клику на overlay
        if (deleteWarehouseModal) {
            deleteWarehouseModal.addEventListener('click', (event) => {
                if (event.target === deleteWarehouseModal) {
                    closeDeleteWarehouseModal();
                }
            });
        }

        // Подтверждение удаления
        if (deleteWarehouseConfirm) {
            deleteWarehouseConfirm.addEventListener('click', async () => {
                if (!warehouseToDelete) return;
                
                deleteWarehouseConfirm.disabled = true;
                deleteWarehouseConfirm.textContent = 'Удаление...';
                
                try {
                    const response = await fetch(`/admin/warehouse/${warehouseToDelete}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.error('Ошибка парсинга ответа:', parseError);
                        // Если запись уже удалена из таблицы, закрываем модальное окно
                        if (!warehouseToDeleteRow || !document.contains(warehouseToDeleteRow)) {
                            closeDeleteWarehouseModal();
                            return;
                        }
                        throw new Error('Не удалось обработать ответ сервера');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    if (data.success) {
                        // Удаляем строку из таблицы
                        if (warehouseToDeleteRow && document.contains(warehouseToDeleteRow)) {
                            warehouseToDeleteRow.remove();
                            
                            // Обновляем нумерацию строк
                            document.querySelectorAll('.data-table tbody tr').forEach((row, index) => {
                                const numberCell = row.querySelector('.number-column');
                                if (numberCell) {
                                    numberCell.textContent = index + 1;
                                }
                            });
                            
                            // Обновляем чередование строк
                            applyWarehouseRowStriping();
                            
                            // Показываем уведомление об успехе
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'success');
                                statusBox.textContent = 'Запись успешно удалена';
                                statusBox.classList.add('visible');
                                setTimeout(() => {
                                    statusBox.classList.remove('visible');
                                }, 3000);
                            }
                        }
                        // Закрываем модальное окно
                        closeDeleteWarehouseModal();
                    } else {
                        const statusBox = document.getElementById('warehouseTableUpdateStatus');
                        if (statusBox) {
                            statusBox.setAttribute('data-state', 'error');
                            statusBox.textContent = data.message || 'Не удалось удалить запись';
                            statusBox.classList.add('visible');
                            setTimeout(() => {
                                statusBox.classList.remove('visible');
                            }, 3000);
                        }
                        deleteWarehouseConfirm.disabled = false;
                        deleteWarehouseConfirm.textContent = 'Удалить';
                    }
                } catch (error) {
                    console.error('Ошибка при удалении записи:', error);
                    // Если запись уже удалена из таблицы, закрываем модальное окно
                    if (!warehouseToDeleteRow || !document.contains(warehouseToDeleteRow)) {
                        closeDeleteWarehouseModal();
                        return;
                    }
                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                    if (statusBox) {
                        statusBox.setAttribute('data-state', 'error');
                        statusBox.textContent = 'Произошла ошибка при удалении записи';
                        statusBox.classList.add('visible');
                        setTimeout(() => {
                            statusBox.classList.remove('visible');
                        }, 3000);
                    }
                    deleteWarehouseConfirm.disabled = false;
                    deleteWarehouseConfirm.textContent = 'Удалить';
                }
            });
        }

        // Данные для выпадающих списков в таблице
        const facilityOptionsMap = {};
        {% for fac in facility_choices %}
        facilityOptionsMap[{{ fac.name|tojson }}] = {
            id: {{ fac.id }},
            name: {{ fac.name|tojson }}
        };
        {% endfor %}

        const warehousesByFacility = {};
        const warehousesDataMap = {};
        {% for wh in warehouse_choices %}
        (function() {
            const facilityId = {{ wh.facility_id|tojson }};
            const facilityName = {{ wh.facility|tojson }};
            if (facilityId && facilityName) {
                if (!warehousesByFacility[facilityName]) {
                    warehousesByFacility[facilityName] = [];
                }
                warehousesByFacility[facilityName].push({
                    id: {{ wh.id }},
                    name: {{ wh.department|tojson }} || {{ wh.type|tojson }} || '—'
                });
            }
            warehousesDataMap[{{ wh.id }}] = {
                id: {{ wh.id }},
                facility_id: facilityId,
                facility_name: facilityName,
                department_name: {{ wh.department|tojson }} || '—'
            };
        })();
        {% endfor %}

        // Выпадающие списки для предприятий в таблице
        const facilityCells = document.querySelectorAll('.facility-cell');
        const facilityDropdown = document.createElement('div');
        facilityDropdown.className = 'role-dropdown';
        document.body.appendChild(facilityDropdown);
        let currentFacilityCell = null;

        function populateFacilityDropdown() {
            facilityDropdown.innerHTML = '';
            Object.keys(facilityOptionsMap).forEach(facilityName => {
                if (!facilityName || facilityName.trim() === '' || facilityName === '—') return;
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.textContent = facilityName;
                
                option.addEventListener('click', async () => {
                    if (!currentFacilityCell) return;
                    
                    const row = currentFacilityCell.closest('tr');
                    const partId = row?.dataset.partId;
                    
                    if (!partId) return;
                    
                    const labelSpan = currentFacilityCell.querySelector('.role-cell-label');
                    const originalValue = currentFacilityCell.dataset.facilityValue || '';
                    
                    if (facilityName === originalValue) {
                        closeFacilityDropdown();
                        return;
                    }
                    
                    // Обновляем отображаемое значение
                    if (labelSpan) labelSpan.textContent = facilityName;
                    currentFacilityCell.dataset.facilityValue = facilityName;
                    currentFacilityCell.dataset.facilityId = facilityOptionsMap[facilityName].id;
                    
                    // Сбрасываем склад
                    const warehouseCell = row.querySelector('.warehouse-cell');
                    if (warehouseCell) {
                        const warehouseLabel = warehouseCell.querySelector('.role-cell-label');
                        if (warehouseLabel) warehouseLabel.textContent = '—';
                        warehouseCell.dataset.warehouseId = '';
                        warehouseCell.dataset.facilityName = facilityName;
                    }
                    
                    closeFacilityDropdown();
                    
                    // Отправляем запрос на обновление
                    try {
                        const response = await fetch(`/admin/warehouse/${partId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                field: 'facility',
                                value: facilityName
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Обновляем данные в строке
                            row.dataset.facility = facilityName;
                            if (data.warehouse) {
                                const warehouseCell = row.querySelector('.warehouse-cell');
                                if (warehouseCell) {
                                    const warehouseLabel = warehouseCell.querySelector('.role-cell-label');
                                    if (warehouseLabel) warehouseLabel.textContent = data.warehouse;
                                }
                            }
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'success');
                                statusBox.textContent = 'Изменения сохранены';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        } else {
                            // Откатываем изменение
                            if (labelSpan) labelSpan.textContent = originalValue || '—';
                            currentFacilityCell.dataset.facilityValue = originalValue;
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'error');
                                statusBox.textContent = data.message || 'Не удалось сохранить изменения';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка при обновлении предприятия:', error);
                        if (labelSpan) labelSpan.textContent = originalValue || '—';
                        currentFacilityCell.dataset.facilityValue = originalValue;
                    }
                });
                
                facilityDropdown.appendChild(option);
            });
        }

        function openFacilityDropdown(cell) {
            if (currentFacilityCell === cell && facilityDropdown.classList.contains('visible')) {
                closeFacilityDropdown();
                return;
            }
            
            currentFacilityCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateFacilityDropdown();
            
            const rect = cell.getBoundingClientRect();
            facilityDropdown.style.position = 'fixed';
            facilityDropdown.style.left = rect.left + 'px';
            facilityDropdown.style.top = (rect.bottom + 4) + 'px';
            facilityDropdown.style.minWidth = rect.width + 'px';
            facilityDropdown.style.maxWidth = '300px';
            facilityDropdown.classList.add('visible');
        }

        function closeFacilityDropdown() {
            if (currentFacilityCell) {
                currentFacilityCell.setAttribute('aria-expanded', 'false');
                currentFacilityCell = null;
            }
            facilityDropdown.classList.remove('visible');
        }

        facilityCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                openFacilityDropdown(cell);
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.facilityValue || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openFacilityDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeFacilityDropdown();
                    cell.blur();
                }
            });
        });

        // Закрытие dropdown при клике вне его
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.facility-cell') && !facilityDropdown.contains(e.target)) {
                closeFacilityDropdown();
            }
        }, true);

        // Выпадающие списки для складов в таблице
        const warehouseCells = document.querySelectorAll('.warehouse-cell');
        const warehouseDropdown = document.createElement('div');
        warehouseDropdown.className = 'role-dropdown';
        document.body.appendChild(warehouseDropdown);
        let currentWarehouseCell = null;

        function populateWarehouseDropdown(cell) {
            warehouseDropdown.innerHTML = '';
            const facilityName = cell.dataset.facilityName || '';
            const warehouses = warehousesByFacility[facilityName] || [];
            
            if (warehouses.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'role-dropdown-option';
                emptyMsg.textContent = 'Нет доступных складов';
                emptyMsg.style.cursor = 'default';
                emptyMsg.style.opacity = '0.6';
                warehouseDropdown.appendChild(emptyMsg);
                return;
            }
            
            warehouses.forEach(warehouse => {
                if (!warehouse || !warehouse.name || warehouse.name.trim() === '' || warehouse.name === '—') return;
                
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'role-dropdown-option';
                option.textContent = warehouse.name;
                
                option.addEventListener('click', async () => {
                    if (!currentWarehouseCell) return;
                    
                    const row = currentWarehouseCell.closest('tr');
                    const partId = row?.dataset.partId;
                    
                    if (!partId) return;
                    
                    const labelSpan = currentWarehouseCell.querySelector('.role-cell-label');
                    const originalValue = currentWarehouseCell.dataset.warehouseId || '';
                    
                    if (String(warehouse.id) === originalValue) {
                        closeWarehouseDropdown();
                        return;
                    }
                    
                    // Обновляем отображаемое значение
                    if (labelSpan) labelSpan.textContent = warehouse.name;
                    currentWarehouseCell.dataset.warehouseId = warehouse.id;
                    
                    closeWarehouseDropdown();
                    
                    // Отправляем запрос на обновление
                    try {
                        const response = await fetch(`/admin/warehouse/${partId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                field: 'warehouse_id',
                                value: warehouse.id
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Обновляем данные в строке
                            row.dataset.warehouse = warehouse.name;
                            if (data.facility) {
                                const facilityCell = row.querySelector('.facility-cell');
                                if (facilityCell) {
                                    const facilityLabel = facilityCell.querySelector('.role-cell-label');
                                    if (facilityLabel) facilityLabel.textContent = data.facility;
                                    facilityCell.dataset.facilityValue = data.facility;
                                }
                            }
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'success');
                                statusBox.textContent = 'Изменения сохранены';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        } else {
                            // Откатываем изменение
                            if (labelSpan) labelSpan.textContent = '—';
                            currentWarehouseCell.dataset.warehouseId = '';
                            
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'error');
                                statusBox.textContent = data.message || 'Не удалось сохранить изменения';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка при обновлении склада:', error);
                        if (labelSpan) labelSpan.textContent = '—';
                        currentWarehouseCell.dataset.warehouseId = '';
                    }
                });
                
                warehouseDropdown.appendChild(option);
            });
        }

        function openWarehouseDropdown(cell) {
            if (currentWarehouseCell === cell && warehouseDropdown.classList.contains('visible')) {
                closeWarehouseDropdown();
                return;
            }
            
            const facilityName = cell.dataset.facilityName || '';
            if (!facilityName || facilityName === '—') {
                const statusBox = document.getElementById('warehouseTableUpdateStatus');
                if (statusBox) {
                    statusBox.setAttribute('data-state', 'error');
                    statusBox.textContent = 'Сначала выберите предприятие';
                    statusBox.classList.add('visible');
                    setTimeout(() => statusBox.classList.remove('visible'), 3000);
                }
                return;
            }
            
            currentWarehouseCell = cell;
            cell.setAttribute('aria-expanded', 'true');
            populateWarehouseDropdown(cell);
            
            const rect = cell.getBoundingClientRect();
            warehouseDropdown.style.position = 'fixed';
            warehouseDropdown.style.left = rect.left + 'px';
            warehouseDropdown.style.top = (rect.bottom + 4) + 'px';
            warehouseDropdown.style.minWidth = rect.width + 'px';
            warehouseDropdown.style.maxWidth = '300px';
            warehouseDropdown.classList.add('visible');
        }

        function closeWarehouseDropdown() {
            if (currentWarehouseCell) {
                currentWarehouseCell.setAttribute('aria-expanded', 'false');
                currentWarehouseCell = null;
            }
            warehouseDropdown.classList.remove('visible');
        }

        warehouseCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                openWarehouseDropdown(cell);
            });

            cell.addEventListener('focus', () => {
                cell.dataset.originalValue = cell.dataset.warehouseId || '';
            });

            cell.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openWarehouseDropdown(cell);
                }
                if (event.key === 'Escape') {
                    closeWarehouseDropdown();
                    cell.blur();
                }
            });
        });

        // Закрытие dropdown при клике вне его
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.warehouse-cell') && !warehouseDropdown.contains(e.target)) {
                closeWarehouseDropdown();
            }
        }, true);

        applyWarehouseTableFilters();

        // Функция отката ячейки склада
        function revertWarehouseCell(cell) {
            if (!cell) return;
            cell.textContent = cell.dataset.originalValue || '';
        }

        // Обновление ячейки склада
        function updateWarehouseCell(cell, partId, field, value) {
            cell.classList.add('saving');
            fetch(`/admin/warehouse/${partId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ field, value })
            })
            .then(async response => {
                const data = await response.json();
                return { ok: response.ok, data };
            })
            .then(({ ok, data }) => {
                cell.classList.remove('saving');
                if (ok && data.success) {
                    // Удаляем quantity input wrapper, если он есть
                    const wrapper = cell.querySelector('.quantity-input-wrapper');
                    if (wrapper) {
                        wrapper.remove();
                    }
                    
                    // Для количества преобразуем значение в число для отображения
                    if (field === 'quantity') {
                        const quantityValue = parseInt(data.value) || 0;
                        // Отображаем прочерк для 0, иначе число
                        cell.textContent = quantityValue === 0 ? '—' : quantityValue.toString();
                    } else {
                        // Для названия детали отображаем значение или прочерк
                        cell.textContent = data.value || '—';
                    }
                    cell.dataset.originalValue = cell.textContent;
                    
                    // Обновляем данные в строке для фильтрации
                    const row = cell.closest('tr');
                    if (row && field === 'spare_part_name') {
                        row.dataset.sparePart = data.value || '';
                    }
                    
                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                    if (statusBox) {
                        statusBox.setAttribute('data-state', 'success');
                        statusBox.textContent = 'Изменения сохранены';
                        statusBox.classList.add('visible');
                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                    }
                } else {
                    cell.classList.add('error');
                    revertWarehouseCell(cell);
                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                    if (statusBox) {
                        statusBox.setAttribute('data-state', 'error');
                        statusBox.textContent = data.message || 'Ошибка сохранения';
                        statusBox.classList.add('visible');
                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                    }
                    setTimeout(() => cell.classList.remove('error'), 1500);
                }
            })
            .catch(() => {
                cell.classList.remove('saving');
                cell.classList.add('error');
                revertWarehouseCell(cell);
                const statusBox = document.getElementById('warehouseTableUpdateStatus');
                if (statusBox) {
                    statusBox.setAttribute('data-state', 'error');
                    statusBox.textContent = 'Сеть недоступна. Попробуйте позже.';
                    statusBox.classList.add('visible');
                    setTimeout(() => statusBox.classList.remove('visible'), 3000);
                }
                setTimeout(() => cell.classList.remove('error'), 1500);
            });
        }

        // Редактирование ячеек склада
        function setupWarehouseEditableCells() {
            const editableWarehouseCells = warehouseTable ? warehouseTable.querySelectorAll('td.editable-cell[data-field]') : [];
            editableWarehouseCells.forEach(cell => {
                const field = cell.dataset.field;
                
                // Для ячейки "Количество" используем number input с кастомными стрелками
                if (field === 'quantity') {
                    let quantityInput = null;
                    let quantityWrapper = null;
                    let quantityButtons = null;
                    
                    cell.addEventListener('dblclick', () => {
                        // Если уже редактируется, не делаем ничего
                        if (cell.querySelector('.quantity-input-wrapper')) return;
                        
                        const originalText = cell.textContent.trim();
                        const originalValue = originalText === '—' ? '0' : originalText;
                        cell.dataset.originalValue = originalValue;
                        
                        // Сохраняем текущий текст для отображения
                        const currentValue = originalText === '—' ? '0' : originalText;
                        
                        // Создаём обёртку
                        quantityWrapper = document.createElement('div');
                        quantityWrapper.className = 'quantity-input-wrapper';
                        
                        // Создаём input
                        quantityInput = document.createElement('input');
                        quantityInput.type = 'number';
                        quantityInput.min = '0';
                        quantityInput.value = currentValue;
                        quantityInput.className = 'quantity-input';
                        
                        // Создаём кнопки-стрелки
                        quantityButtons = document.createElement('div');
                        quantityButtons.className = 'quantity-input-buttons';
                        
                        const btnUp = document.createElement('button');
                        btnUp.type = 'button';
                        btnUp.className = 'quantity-input-btn quantity-input-btn-up';
                        btnUp.setAttribute('aria-label', 'Увеличить количество');
                        btnUp.setAttribute('tabindex', '-1');
                        btnUp.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>';
                        
                        const btnDown = document.createElement('button');
                        btnDown.type = 'button';
                        btnDown.className = 'quantity-input-btn quantity-input-btn-down';
                        btnDown.setAttribute('aria-label', 'Уменьшить количество');
                        btnDown.setAttribute('tabindex', '-1');
                        btnDown.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                        
                        quantityButtons.appendChild(btnUp);
                        quantityButtons.appendChild(btnDown);
                        
                        quantityWrapper.appendChild(quantityInput);
                        quantityWrapper.appendChild(quantityButtons);
                        
                        // Очищаем ячейку и вставляем обёртку
                        cell.textContent = '';
                        cell.appendChild(quantityWrapper);
                        
                        // Фокусируемся на input и выделяем текст
                        quantityInput.focus();
                        quantityInput.select();
                        
                        // Обработчики для кнопок - используем mousedown, чтобы предотвратить blur
                        btnUp.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const current = parseInt(quantityInput.value) || 0;
                            quantityInput.value = Math.max(0, current + 1).toString();
                            quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                            // Возвращаем фокус на input
                            quantityInput.focus();
                        });
                        
                        btnDown.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const current = parseInt(quantityInput.value) || 0;
                            quantityInput.value = Math.max(0, current - 1).toString();
                            quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                            // Возвращаем фокус на input
                            quantityInput.focus();
                        });
                        
                        // Предотвращаем blur при клике на кнопки
                        btnUp.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                        
                        btnDown.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                        
                        // Обработчик для колесика мыши
                        quantityWrapper.addEventListener('wheel', (e) => {
                            if (document.activeElement === quantityInput) {
                                e.preventDefault();
                                const delta = e.deltaY > 0 ? -1 : 1;
                                const current = parseInt(quantityInput.value) || 0;
                                quantityInput.value = Math.max(0, current + delta).toString();
                                quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }, { passive: false });
                        
                        // Обработчики для клавиатуры
                        quantityInput.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                quantityInput.blur();
                            }
                            if (event.key === 'Escape') {
                                event.preventDefault();
                                revertWarehouseQuantityCell(cell, originalValue);
                            }
                        });
                        
                        // Обработчик для blur - с задержкой, чтобы проверить, не кликнули ли на кнопку
                        quantityInput.addEventListener('blur', () => {
                            // Используем небольшую задержку, чтобы проверить, не был ли это клик на кнопку
                            setTimeout(() => {
                                // Проверяем, что input всё ещё существует (не был удалён)
                                if (!cell.querySelector('.quantity-input-wrapper')) return;
                                
                                // Если фокус вернулся на input, значит это был клик на кнопку
                                if (document.activeElement === quantityInput) {
                                    return;
                                }
                                
                                // Если blur произошёл не из-за клика на кнопку, обрабатываем сохранение
                                const newValue = quantityInput.value.trim();
                                const numValue = parseInt(newValue);
                                
                                if (isNaN(numValue) || numValue < 0) {
                                    revertWarehouseQuantityCell(cell, originalValue);
                                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                                    if (statusBox) {
                                        statusBox.setAttribute('data-state', 'error');
                                        statusBox.textContent = 'Некорректное количество';
                                        statusBox.classList.add('visible');
                                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                                    }
                                    return;
                                }
                                
                                const normalizedOriginal = originalValue === '—' ? '0' : originalValue;
                                const normalizedNew = numValue.toString();
                                
                                if (normalizedNew === normalizedOriginal) {
                                    revertWarehouseQuantityCell(cell, originalValue);
                                    return;
                                }
                                
                                const row = cell.closest('tr');
                                const partId = row ? row.dataset.partId : null;
                                if (!partId) {
                                    revertWarehouseQuantityCell(cell, originalValue);
                                    const statusBox = document.getElementById('warehouseTableUpdateStatus');
                                    if (statusBox) {
                                        statusBox.setAttribute('data-state', 'error');
                                        statusBox.textContent = 'Не удалось определить запись.';
                                        statusBox.classList.add('visible');
                                        setTimeout(() => statusBox.classList.remove('visible'), 3000);
                                    }
                                    return;
                                }
                                
                                // Обновляем ячейку через updateWarehouseCell
                                updateWarehouseCell(cell, partId, 'quantity', normalizedNew);
                            }, 50);
                        });
                    });
                } else {
                    // Для остальных ячеек (например, "Деталь") используем обычный contenteditable
                    cell.addEventListener('dblclick', () => {
                        cell.contentEditable = 'true';
                        cell.dataset.originalValue = cell.textContent.trim();
                        cell.focus();
                        const range = document.createRange();
                        range.selectNodeContents(cell);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    });

                    cell.addEventListener('keydown', (event) => {
                        if (cell.contentEditable !== 'true') return;
                        
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            cell.blur();
                        }
                        if (event.key === 'Escape') {
                            event.preventDefault();
                            revertWarehouseCell(cell);
                            cell.blur();
                        }
                    });

                    cell.addEventListener('blur', () => {
                        cell.contentEditable = 'false';
                        
                        const originalValue = cell.dataset.originalValue ?? '';
                        let newValue = cell.textContent.trim();
                        
                        // Для названия детали проверяем, что не пустое
                        if (cell.dataset.field === 'spare_part_name') {
                            if (!newValue || newValue.trim() === '') {
                                revertWarehouseCell(cell);
                                const statusBox = document.getElementById('warehouseTableUpdateStatus');
                                if (statusBox) {
                                    statusBox.setAttribute('data-state', 'error');
                                    statusBox.textContent = 'Название детали не может быть пустым';
                                    statusBox.classList.add('visible');
                                    setTimeout(() => statusBox.classList.remove('visible'), 3000);
                                }
                                return;
                            }
                        }
                        
                        // Нормализуем значения для сравнения
                        const normalizedOriginal = originalValue === '—' ? '' : originalValue;
                        const normalizedNew = newValue === '—' ? '' : newValue;
                        if (normalizedNew === normalizedOriginal) {
                            return;
                        }
                        
                        const row = cell.closest('tr');
                        const partId = row ? row.dataset.partId : null;
                        if (!partId) {
                            revertWarehouseCell(cell);
                            const statusBox = document.getElementById('warehouseTableUpdateStatus');
                            if (statusBox) {
                                statusBox.setAttribute('data-state', 'error');
                                statusBox.textContent = 'Не удалось определить запись.';
                                statusBox.classList.add('visible');
                                setTimeout(() => statusBox.classList.remove('visible'), 3000);
                            }
                            return;
                        }
                        const field = cell.dataset.field;
                        if (!field) {
                            revertWarehouseCell(cell);
                            return;
                        }
                        updateWarehouseCell(cell, partId, field, newValue);
                    });
                }
            });
        }
        
        // Функция для восстановления ячейки количества
        function revertWarehouseQuantityCell(cell, originalValue) {
            const wrapper = cell.querySelector('.quantity-input-wrapper');
            if (wrapper) {
                wrapper.remove();
            }
            const displayValue = originalValue === '0' || originalValue === '' ? '—' : originalValue;
            cell.textContent = displayValue;
        }

        // Инициализация редактируемых ячеек
        setupWarehouseEditableCells();

        {% endif %}
    </script>

    {% if section == 'equipment' %}
    <script>
        // JavaScript для работы с таблицей оборудования
        (function() {
            'use strict';
            
            try {
            const equipmentSearch = document.getElementById('equipmentSearch');
            const equipmentFilterToggle = document.getElementById('equipmentFilterToggle');
            const equipmentFilterDropdown = document.getElementById('equipmentFilterDropdown');
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const locationFilter = document.getElementById('locationFilter');
            const resetEquipmentFilters = document.getElementById('resetEquipmentFilters');
            const equipmentTable = document.getElementById('equipmentTable');
            const equipmentStatusBox = document.getElementById('equipmentTableUpdateStatus');
            const addEquipmentBtn = document.getElementById('addEquipmentBtn');
            const equipmentModal = document.getElementById('equipmentModal');
            const equipmentModalClose = document.getElementById('equipmentModalClose');
            const equipmentModalCancel = document.getElementById('equipmentModalCancel');
            const deleteEquipmentModal = document.getElementById('deleteEquipmentModal');
            const deleteEquipmentClose = document.getElementById('deleteEquipmentModalClose');
            const deleteEquipmentCancel = document.getElementById('deleteEquipmentCancel');
            const deleteEquipmentConfirm = document.getElementById('deleteEquipmentConfirm');
            const deleteEquipmentMessage = document.getElementById('deleteEquipmentMessage');

            let equipmentToDelete = null;
            let equipmentToDeleteRow = null;
            let selectedEquipmentRow = null;
            let equipmentContextMenu = null;

            // Создаем контекстное меню
            function createContextMenu() {
                if (equipmentContextMenu) return equipmentContextMenu;
                
                equipmentContextMenu = document.createElement('div');
                equipmentContextMenu.className = 'context-menu';
                equipmentContextMenu.innerHTML = `
                    <button type="button" class="context-menu-item" id="equipmentPassportBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Паспорт
                    </button>
                    <button type="button" class="context-menu-item danger" id="equipmentDeleteBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Удалить
                    </button>
                `;
                document.body.appendChild(equipmentContextMenu);
                
                const passportBtn = document.getElementById('equipmentPassportBtn');
                const deleteBtn = document.getElementById('equipmentDeleteBtn');
                
                if (passportBtn) {
                    passportBtn.addEventListener('click', () => {
                        if (selectedEquipmentRow) {
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            if (equipmentId) {
                                window.location.href = `/admin/equipment/passport/${equipmentId}`;
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (selectedEquipmentRow) {
                            const equipmentId = selectedEquipmentRow.dataset.equipmentId;
                            if (equipmentId) {
                                openDeleteEquipmentModal(parseInt(equipmentId), selectedEquipmentRow);
                            }
                        }
                        hideContextMenu();
                    });
                }
                
                return equipmentContextMenu;
            }

            function showContextMenu(event, row) {
                event.preventDefault();
                event.stopPropagation();
                
                const menu = createContextMenu();
                selectedEquipmentRow = row;
                
                const tableContainer = document.querySelector('.table-container');
                if (!tableContainer) return;
                
                // Сначала показываем меню, чтобы получить его размеры
                menu.style.display = 'block';
                menu.style.visibility = 'hidden';
                menu.style.left = '0px';
                menu.style.top = '0px';
                
                const containerRect = tableContainer.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();
                
                // Используем координаты клика относительно viewport
                let left = event.clientX;
                let top = event.clientY;
                
                // Проверяем, не выходит ли меню за правую границу таблицы
                if (left + menuRect.width > containerRect.right) {
                    left = containerRect.right - menuRect.width - 10;
                }
                
                // Проверяем, не выходит ли меню за левую границу таблицы
                if (left < containerRect.left) {
                    left = containerRect.left + 10;
                }
                
                // Проверяем, не выходит ли меню за нижнюю границу таблицы
                if (top + menuRect.height > containerRect.bottom) {
                    top = containerRect.bottom - menuRect.height - 10;
                }
                
                // Проверяем, не выходит ли меню за верхнюю границу таблицы
                if (top < containerRect.top) {
                    top = containerRect.top + 10;
                }
                
                // Устанавливаем финальную позицию
                menu.style.position = 'fixed';
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                menu.style.visibility = 'visible';
                
                // Закрываем меню при клике вне его
                setTimeout(() => {
                    document.addEventListener('click', hideContextMenu, { once: true });
                }, 0);
            }

            function hideContextMenu() {
                if (equipmentContextMenu) {
                    equipmentContextMenu.style.display = 'none';
                }
            }

            // Функция для получения всех строк таблицы
            function getAllEquipmentRows() {
                return equipmentTable ? equipmentTable.querySelectorAll('tbody tr') : [];
            }

            // Выделение строки при одинарном клике и контекстное меню
            function setupRowHandlers() {
                const tbody = equipmentTable ? equipmentTable.querySelector('tbody') : null;
                if (!tbody) return;

                // Одинарный клик - выделение строки
                tbody.addEventListener('click', (e) => {
                    // Игнорируем клики по редактируемым ячейкам
                    if (e.target.closest('.editable-cell[contenteditable="true"]')) {
                        return;
                    }
                    // Игнорируем клики по ячейкам типа (они обрабатываются отдельно)
                    if (e.target.closest('.role-cell[data-field="equipment_type"]')) {
                        return;
                    }
                    
                    const row = e.target.closest('tr');
                    if (row) {
                        // Если строка уже выделена, убираем выделение
                        if (row.classList.contains('selected')) {
                            row.classList.remove('selected');
                            selectedEquipmentRow = null;
                        } else {
                            // Убираем выделение с других строк
                            getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                            // Выделяем текущую строку
                            row.classList.add('selected');
                            selectedEquipmentRow = row;
                        }
                    }
                });
                
                // Убираем выделение при клике вне таблицы
                document.addEventListener('click', (e) => {
                    // Проверяем, что клик был не по таблице и не по контекстному меню
                    if (!equipmentTable.contains(e.target) && 
                        !(equipmentContextMenu && equipmentContextMenu.contains(e.target))) {
                        getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                        selectedEquipmentRow = null;
                    }
                });
                
                // ПКМ - выделение строки и показ контекстного меню
                tbody.addEventListener('contextmenu', (e) => {
                    // Проверяем, что клик был по строке, а не по редактируемой ячейке
                    const row = e.target.closest('tr');
                    if (row && !e.target.closest('.editable-cell[contenteditable="true"]')) {
                        e.preventDefault();
                        // Убираем выделение с других строк
                        getAllEquipmentRows().forEach(r => r.classList.remove('selected'));
                        // Выделяем текущую строку
                        row.classList.add('selected');
                        selectedEquipmentRow = row;
                        showContextMenu(e, row);
                    }
                });
            }

            setupRowHandlers();

            // Функция показа статуса
            function showEquipmentStatus(message, state = 'info') {
                if (!equipmentStatusBox) return;
                equipmentStatusBox.textContent = message;
                equipmentStatusBox.dataset.state = state;
                equipmentStatusBox.classList.remove('visible');
                if (message) {
                    requestAnimationFrame(() => equipmentStatusBox.classList.add('visible'));
                    setTimeout(() => {
                        equipmentStatusBox.classList.remove('visible');
                    }, 5000);
                }
            }

            // Функция отката ячейки
            function revertEquipmentCell(cell) {
                if (!cell) return;
                if (cell.classList.contains('role-cell')) {
                    const typeValue = cell.dataset.originalValue || '';
                    const labelSpan = cell.querySelector('.role-cell-label');
                    if (labelSpan) labelSpan.textContent = typeValue || '—';
                    cell.dataset.typeValue = typeValue;
                    return;
                }
                cell.textContent = cell.dataset.originalValue || '';
            }

            // Обновление ячейки оборудования
            function updateEquipmentCell(cell, equipmentId, field, value) {
                cell.classList.add('saving');
                fetch(`/admin/equipment/${equipmentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ field, value })
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    cell.classList.remove('saving');
                    if (ok && data.success) {
                        if (cell.classList.contains('role-cell')) {
                            const labelSpan = cell.querySelector('.role-cell-label');
                            const typeValue = data.value || '';
                            if (labelSpan) labelSpan.textContent = typeValue || '—';
                            cell.dataset.typeValue = typeValue;
                            cell.dataset.originalValue = typeValue;
                            cell.setAttribute('aria-expanded', 'false');
                            // Обновляем data-type в строке для фильтрации
                            const row = cell.closest('tr');
                            if (row) {
                                row.dataset.type = typeValue;
                            }
                        } else {
                            cell.textContent = data.value || '';
                            cell.dataset.originalValue = cell.textContent;
                        }
                        showEquipmentStatus('Изменения сохранены', 'success');
                    } else {
                        cell.classList.add('error');
                        revertEquipmentCell(cell);
                        showEquipmentStatus(data.message || 'Ошибка сохранения', 'error');
                        setTimeout(() => cell.classList.remove('error'), 1500);
                    }
                })
                .catch(() => {
                    cell.classList.remove('saving');
                    cell.classList.add('error');
                    revertEquipmentCell(cell);
                    showEquipmentStatus('Сеть недоступна. Попробуйте позже.', 'error');
                    setTimeout(() => cell.classList.remove('error'), 1500);
                });
            }

            // Редактирование ячеек
            function setupEditableCells() {
                const editableEquipmentCells = equipmentTable ? equipmentTable.querySelectorAll('td.editable-cell[data-field]') : [];
                editableEquipmentCells.forEach(cell => {
                // Активация редактирования по двойному клику
                cell.addEventListener('dblclick', () => {
                    cell.contentEditable = 'true';
                    cell.dataset.originalValue = cell.textContent.trim();
                    cell.focus();
                    const range = document.createRange();
                    range.selectNodeContents(cell);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                cell.addEventListener('keydown', (event) => {
                    if (cell.contentEditable !== 'true') return;
                    
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        cell.blur();
                    }
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        revertEquipmentCell(cell);
                        cell.blur();
                    }
                });

                cell.addEventListener('blur', () => {
                    cell.contentEditable = 'false';
                    
                    const originalValue = cell.dataset.originalValue ?? '';
                    const newValue = cell.textContent.trim();
                    if (newValue === originalValue) {
                        return;
                    }
                    const row = cell.closest('tr');
                    const equipmentId = row ? row.dataset.equipmentId : null;
                    if (!equipmentId) {
                        revertEquipmentCell(cell);
                        showEquipmentStatus('Не удалось определить оборудование.', 'error');
                        return;
                    }
                    const field = cell.dataset.field;
                    if (!field) {
                        revertEquipmentCell(cell);
                        return;
                    }
                    updateEquipmentCell(cell, equipmentId, field, newValue);
                });
            });
            }

            setupEditableCells();

            // Выпадающий список типов оборудования
            const equipmentTypeOptions = {{ equipment_types|tojson }};
            const typeDropdown = document.createElement('div');
            typeDropdown.className = 'role-dropdown';
            document.body.appendChild(typeDropdown);

            let currentTypeCell = null;

            function populateTypeDropdown() {
                typeDropdown.innerHTML = '';
                
                equipmentTypeOptions.forEach(type => {
                    if (!type || type.trim() === '') return;
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = type;
                    option.textContent = type;
                    option.addEventListener('click', () => {
                        const targetCell = currentTypeCell;
                        if (!targetCell) return;
                        if (targetCell.dataset.typeValue === type) {
                            closeTypeDropdown();
                            return;
                        }
                        const row = targetCell.closest('tr');
                        if (!row) return;
                        const equipmentId = row.dataset.equipmentId;
                        if (!equipmentId) return;
                        targetCell.dataset.originalValue = targetCell.dataset.typeValue || '';
                        updateEquipmentCell(targetCell, equipmentId, 'equipment_type', type);
                        closeTypeDropdown();
                    });
                    typeDropdown.appendChild(option);
                });
            }

            function positionTypeDropdown(cell) {
                if (!cell || !typeDropdown) return;
                
                const rect = cell.getBoundingClientRect();
                const cellWidth = cell.offsetWidth;
                const rectWidth = rect.width;
                const finalWidth = Math.max(cellWidth, rectWidth);
                
                const viewportHeight = window.innerHeight;
                const maxDropdownHeight = 300; // Максимальная высота выпадающего списка
                
                const tableContainer = document.querySelector('.table-container');
                let containerRect = null;
                if (tableContainer) {
                    containerRect = tableContainer.getBoundingClientRect();
                }
                
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                
                let availableSpaceBelow = spaceBelow;
                let availableSpaceAbove = spaceAbove;
                
                if (containerRect) {
                    const containerBottom = containerRect.bottom;
                    const containerTop = containerRect.top;
                    availableSpaceBelow = Math.min(spaceBelow, containerBottom - rect.bottom);
                    availableSpaceAbove = Math.min(spaceAbove, rect.top - containerTop);
                }
                
                // Вычисляем оптимальную высоту с учетом доступного пространства
                let calculatedHeight = maxDropdownHeight;
                if (availableSpaceBelow < maxDropdownHeight && availableSpaceAbove > availableSpaceBelow) {
                    // Открываем вверх, используем доступное пространство сверху
                    calculatedHeight = Math.min(maxDropdownHeight, availableSpaceAbove - 10);
                } else {
                    // Открываем вниз, используем доступное пространство снизу
                    calculatedHeight = Math.min(maxDropdownHeight, availableSpaceBelow - 10);
                }
                
                // Устанавливаем максимальную высоту
                typeDropdown.style.maxHeight = `${calculatedHeight}px`;
                
                const openUpward = availableSpaceBelow < calculatedHeight && availableSpaceAbove > availableSpaceBelow;
                
                typeDropdown.style.position = 'fixed';
                if (openUpward) {
                    typeDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    typeDropdown.style.top = 'auto';
                    typeDropdown.style.maxHeight = `${Math.min(calculatedHeight, availableSpaceAbove - 10)}px`;
                } else {
                    typeDropdown.style.top = `${rect.bottom + 6}px`;
                    typeDropdown.style.bottom = 'auto';
                    typeDropdown.style.maxHeight = `${Math.min(calculatedHeight, availableSpaceBelow - 10)}px`;
                }
                typeDropdown.style.left = `${rect.left}px`;
                typeDropdown.style.width = `${finalWidth}px`;
                typeDropdown.style.minWidth = `${finalWidth}px`;
                typeDropdown.style.maxWidth = `${finalWidth}px`;
                typeDropdown.style.boxSizing = 'border-box';
                typeDropdown.style.flexShrink = '0';
                typeDropdown.style.flexGrow = '0';
                
                const options = typeDropdown.querySelectorAll('.role-dropdown-option');
                options.forEach(opt => {
                    opt.style.width = '100%';
                    opt.style.minWidth = '100%';
                    opt.style.maxWidth = '100%';
                    opt.style.boxSizing = 'border-box';
                    opt.classList.toggle('selected', opt.dataset.value === cell.dataset.typeValue);
                });
            }

            function openTypeDropdown(cell) {
                currentTypeCell = cell;
                cell.setAttribute('aria-expanded', 'true');
                populateTypeDropdown();
                typeDropdown.classList.add('visible');
                
                // Убеждаемся, что обработчики событий работают
                // Добавляем обработчик wheel с более высоким приоритетом
                const wheelHandler = (event) => {
                    if (typeDropdown.classList.contains('visible')) {
                        const rect = typeDropdown.getBoundingClientRect();
                        const isOverDropdown = event.clientX >= rect.left && 
                                              event.clientX <= rect.right &&
                                              event.clientY >= rect.top && 
                                              event.clientY <= rect.bottom;
                        
                        if (isOverDropdown) {
                            event.stopPropagation();
                            event.stopImmediatePropagation();
                            isScrollingDropdown = true;
                            
                            const scrollTop = typeDropdown.scrollTop;
                            const scrollHeight = typeDropdown.scrollHeight;
                            const height = typeDropdown.clientHeight;
                            const delta = event.deltaY;
                            
                            if ((scrollTop === 0 && delta < 0) || (scrollTop + height >= scrollHeight && delta > 0)) {
                                event.preventDefault();
                            }
                            
                            setTimeout(() => {
                                isScrollingDropdown = false;
                            }, 100);
                        }
                    }
                };
                
                // Удаляем старый обработчик, если есть
                typeDropdown.removeEventListener('wheel', wheelHandler, { capture: true });
                // Добавляем новый обработчик
                typeDropdown.addEventListener('wheel', wheelHandler, { passive: false, capture: true });
                
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        positionTypeDropdown(cell);
                        requestAnimationFrame(() => {
                            positionTypeDropdown(cell);
                        });
                    });
                });
            }

            function closeTypeDropdown() {
                if (currentTypeCell) {
                    currentTypeCell.setAttribute('aria-expanded', 'false');
                }
                currentTypeCell = null;
                typeDropdown.classList.remove('visible');
            }

            // Обработчики для ячеек типов
            function setupTypeCellHandlers() {
                const typeCells = equipmentTable ? equipmentTable.querySelectorAll('td.role-cell[data-field="equipment_type"]') : [];
                typeCells.forEach(cell => {
                    // Удаляем старые обработчики, если они есть
                    const newCell = cell.cloneNode(true);
                    cell.parentNode.replaceChild(newCell, cell);
                    
                    newCell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        if (currentTypeCell === newCell && typeDropdown.classList.contains('visible')) {
                            closeTypeDropdown();
                        } else {
                            closeTypeDropdown();
                            openTypeDropdown(newCell);
                        }
                    });

                    newCell.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            e.stopPropagation();
                            if (currentTypeCell === newCell && typeDropdown.classList.contains('visible')) {
                                closeTypeDropdown();
                            } else {
                                closeTypeDropdown();
                                openTypeDropdown(newCell);
                            }
                        } else if (e.key === 'Escape') {
                            closeTypeDropdown();
                        }
                    });
                });
            }
            
            setupTypeCellHandlers();

            // Функция для проверки, находится ли точка внутри выпадающего списка
            function isPointInDropdown(x, y) {
                if (!typeDropdown.classList.contains('visible')) return false;
                const rect = typeDropdown.getBoundingClientRect();
                return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
            }
            
            // Глобальный обработчик wheel на document с capture: true (срабатывает первым)
            document.addEventListener('wheel', (event) => {
                if (isPointInDropdown(event.clientX, event.clientY)) {
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    isScrollingDropdown = true;
                    
                    // Прокручиваем список вручную, если нужно
                    const scrollTop = typeDropdown.scrollTop;
                    const scrollHeight = typeDropdown.scrollHeight;
                    const height = typeDropdown.clientHeight;
                    const delta = event.deltaY;
                    
                    // Если прокрутка достигла границ, предотвращаем дальнейшую прокрутку страницы
                    if ((scrollTop === 0 && delta < 0) || (scrollTop + height >= scrollHeight && delta > 0)) {
                        event.preventDefault();
                    }
                    
                    setTimeout(() => {
                        isScrollingDropdown = false;
                    }, 300);
                    return;
                }
            }, { capture: true, passive: false });
            
            // Флаги для отслеживания взаимодействия с выпадающим списком
            let isDraggingScrollbar = false;
            let mousedownInDropdown = false;
            
            // Глобальный обработчик mousedown на document с capture: true
            document.addEventListener('mousedown', (event) => {
                if (isPointInDropdown(event.clientX, event.clientY)) {
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    mousedownInDropdown = true;
                    
                    // Проверяем, не кликнули ли мы на скроллбар (правая часть элемента)
                    const rect = typeDropdown.getBoundingClientRect();
                    const scrollbarWidth = 12; // Ширина скроллбара с небольшим запасом
                    const isOnScrollbar = event.clientX >= rect.right - scrollbarWidth;
                    
                    if (isOnScrollbar) {
                        isDraggingScrollbar = true;
                        isScrollingDropdown = true;
                    } else {
                        // Устанавливаем флаг, чтобы предотвратить закрытие при последующем событии scroll
                        isScrollingDropdown = true;
                        setTimeout(() => {
                            isScrollingDropdown = false;
                        }, 300);
                    }
                    return;
                } else {
                    mousedownInDropdown = false;
                }
            }, { capture: true });
            
            // Обработчик mouseup для сброса флага перетаскивания
            document.addEventListener('mouseup', (event) => {
                if (isDraggingScrollbar) {
                    isDraggingScrollbar = false;
                    // Увеличиваем задержку перед сбросом флага, чтобы обработчик click успел проверить
                    setTimeout(() => {
                        isScrollingDropdown = false;
                    }, 300);
                }
                if (isPointInDropdown(event.clientX, event.clientY) || mousedownInDropdown) {
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    mousedownInDropdown = false;
                }
            }, { capture: true });
            
            // Обработчик mousemove для отслеживания перетаскивания скроллбара
            document.addEventListener('mousemove', (event) => {
                if (isDraggingScrollbar) {
                    isScrollingDropdown = true;
                }
            }, { capture: true });
            
            // Глобальный обработчик click на document (срабатывает последним)
            document.addEventListener('click', (event) => {
                // Не закрываем, если список не видим
                if (!typeDropdown.classList.contains('visible')) return;
                
                // Не закрываем, если происходит перетаскивание скроллбара или прокрутка
                if (isDraggingScrollbar || isScrollingDropdown) {
                    return;
                }
                
                // Не закрываем, если клик был внутри выпадающего списка
                if (typeDropdown.contains(event.target)) return;
                
                // Не закрываем, если клик был на ячейке типа
                if (event.target.closest('.role-cell[data-field="equipment_type"]')) return;
                
                // Проверяем координаты на случай, если клик был на скроллбаре
                if (isPointInDropdown(event.clientX, event.clientY)) {
                    return;
                }
                
                // Небольшая задержка перед закрытием, чтобы дать время обработать события mousedown/mouseup
                setTimeout(() => {
                    // Повторно проверяем флаги перед закрытием
                    if (!isDraggingScrollbar && !isScrollingDropdown && !mousedownInDropdown && typeDropdown.classList.contains('visible')) {
                        closeTypeDropdown();
                    }
                }, 150);
            }, { capture: false });
            
            // Обработчики на самом элементе для дополнительной защиты
            typeDropdown.addEventListener('mousedown', (event) => {
                event.stopPropagation();
                event.stopImmediatePropagation();
            }, { capture: true });
            
            typeDropdown.addEventListener('click', (event) => {
                event.stopPropagation();
                event.stopImmediatePropagation();
            }, { capture: true });
            
            typeDropdown.addEventListener('wheel', (event) => {
                event.stopPropagation();
                event.stopImmediatePropagation();
            }, { capture: true, passive: false });

            window.addEventListener('resize', () => {
                if (currentTypeCell) {
                    requestAnimationFrame(() => {
                        positionTypeDropdown(currentTypeCell);
                    });
                }
            });

            // Флаг для отслеживания прокрутки внутри выпадающего списка
            let isScrollingDropdown = false;
            let dropdownScrollTimeout = null;
            
            // Отслеживаем прокрутку внутри выпадающего списка
            typeDropdown.addEventListener('scroll', (event) => {
                if (typeDropdown.classList.contains('visible')) {
                    isScrollingDropdown = true;
                    // Очищаем предыдущий таймаут
                    if (dropdownScrollTimeout) {
                        clearTimeout(dropdownScrollTimeout);
                    }
                    // Сбрасываем флаг через задержку
                    dropdownScrollTimeout = setTimeout(() => {
                        isScrollingDropdown = false;
                    }, 200);
                }
            });
            
            window.addEventListener('scroll', (event) => {
                // Не закрываем, если прокрутка происходит внутри выпадающего списка
                if (isScrollingDropdown) return;
                
                // Проверяем, что прокрутка не была вызвана прокруткой внутри списка
                // Для этого проверяем, не находится ли курсор над выпадающим списком
                if (currentTypeCell && typeDropdown.classList.contains('visible')) {
                    // Получаем текущую позицию курсора (если доступна)
                    // Если событие scroll было вызвано прокруткой внутри списка, не закрываем
                    if (isScrollingDropdown) return;
                    
                    // Небольшая задержка, чтобы дать время обработать событие scroll внутри списка
                    setTimeout(() => {
                        if (!isScrollingDropdown && typeDropdown.classList.contains('visible')) {
                            closeTypeDropdown();
                        }
                    }, 100);
                }
            }, true);

            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.addEventListener('scroll', () => {
                    // Не закрываем, если прокрутка происходит внутри выпадающего списка
                    if (isScrollingDropdown) return;
                    if (currentTypeCell && typeDropdown.classList.contains('visible')) {
                        // Небольшая задержка, чтобы дать время обработать событие scroll внутри списка
                        setTimeout(() => {
                            if (!isScrollingDropdown && typeDropdown.classList.contains('visible')) {
                                closeTypeDropdown();
                            }
                        }, 50);
                    }
                });
            }

            // Функция для чередования цветов строк
            function applyEquipmentRowStriping() {
                let visibleIndex = 0;
                getAllEquipmentRows().forEach(row => {
                    if (row.style.display === 'none') {
                        row.classList.remove('alt-row');
                        return;
                    }
                    const isAlt = visibleIndex % 2 === 1;
                    row.classList.toggle('alt-row', isAlt);
                    visibleIndex += 1;
                });
            }

            // Фильтрация таблицы
            function applyEquipmentFilters() {
                const searchValue = equipmentSearch ? equipmentSearch.value.toLowerCase().trim() : '';
                const typeValue = typeFilter ? typeFilter.value : '';
                const statusValue = statusFilter ? statusFilter.value : '';
                const locationValue = locationFilter ? locationFilter.value : '';

                getAllEquipmentRows().forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const rowType = (row.dataset.type || '').toLowerCase();
                    const rowStatus = (row.dataset.status || '').toLowerCase();
                    const rowLocation = (row.dataset.location || '').toLowerCase();

                    const matchesSearch = searchValue === '' || text.includes(searchValue);
                    const matchesType = typeValue === '' || rowType === typeValue.toLowerCase();
                    const matchesStatus = statusValue === '' || rowStatus === statusValue.toLowerCase();
                    const matchesLocation = locationValue === '' || rowLocation === locationValue.toLowerCase();

                    if (matchesSearch && matchesType && matchesStatus && matchesLocation) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Обновляем нумерацию
                let visibleIndex = 0;
                getAllEquipmentRows().forEach(row => {
                    if (row.style.display !== 'none') {
                        const numberCell = row.querySelector('.number-column');
                        if (numberCell) {
                            numberCell.textContent = visibleIndex + 1;
                        }
                        visibleIndex++;
                    }
                });

                // Применяем чередование цветов
                applyEquipmentRowStriping();
            }

            // Поиск
            if (equipmentSearch) {
                equipmentSearch.addEventListener('input', applyEquipmentFilters);
            } else {
                console.error('equipmentSearch не найден');
            }

            // Фильтры
            const equipmentFilterSelectWrappers = document.querySelectorAll('#equipmentFilterDropdown .filter-select[data-target]');
            const equipmentFilterSelectControllers = new Map();

            function closeEquipmentFilterSelectMenus() {
                equipmentFilterSelectWrappers.forEach(wrapper => {
                    wrapper.classList.remove('open');
                    const btn = wrapper.querySelector('.filter-select-btn');
                    if (btn) {
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            if (equipmentFilterToggle && equipmentFilterDropdown) {
                equipmentFilterToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    equipmentFilterDropdown.classList.toggle('active');
                    equipmentFilterToggle.classList.toggle('active');
                    if (!equipmentFilterDropdown.classList.contains('active')) {
                        closeEquipmentFilterSelectMenus();
                    }
                });

                [typeFilter, statusFilter, locationFilter].forEach(filter => {
                    if (filter) {
                        filter.addEventListener('change', applyEquipmentFilters);
                    }
                });

                if (resetEquipmentFilters) {
                    resetEquipmentFilters.addEventListener('click', () => {
                        if (equipmentSearch) equipmentSearch.value = '';
                        if (typeFilter) typeFilter.value = '';
                        if (statusFilter) statusFilter.value = '';
                        if (locationFilter) locationFilter.value = '';
                        applyEquipmentFilters();
                        equipmentFilterSelectControllers.forEach(controller => controller.sync());
                    });
                }

                document.addEventListener('click', (event) => {
                    if (!equipmentFilterDropdown.contains(event.target) && !equipmentFilterToggle.contains(event.target)) {
                        equipmentFilterDropdown.classList.remove('active');
                        equipmentFilterToggle.classList.remove('active');
                        closeEquipmentFilterSelectMenus();
                    }
                });
            }

            // Инициализация кастомных фильтров
            equipmentFilterSelectWrappers.forEach(wrapper => {
                const targetId = wrapper.dataset.target;
                const selectEl = document.getElementById(targetId);
                if (!selectEl) return;

                const button = wrapper.querySelector('.filter-select-btn');
                const label = button ? button.querySelector('.filter-select-label') : null;
                const optionButtons = wrapper.querySelectorAll('.filter-option');
                const resetBtn = wrapper.parentElement.querySelector('.filter-reset-btn[data-target="' + targetId + '"]');

                function syncUI() {
                    const value = selectEl.value || '';
                    const selectedOption = Array.from(selectEl.options).find(opt => opt.value === value);
                    const displayText = selectedOption ? selectedOption.textContent.trim() : 'Все';
                    if (label) {
                        label.textContent = displayText;
                    }
                    if (resetBtn) {
                        resetBtn.style.display = value ? '' : 'none';
                    }
                }

                optionButtons.forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const value = btn.dataset.value || '';
                        if (selectEl.value !== value) {
                            selectEl.value = value;
                            selectEl.dispatchEvent(new Event('change'));
                        } else {
                            selectEl.dispatchEvent(new Event('change'));
                        }
                        syncUI();
                        closeEquipmentFilterSelectMenus();
                    });
                });

                if (button) {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const isOpen = wrapper.classList.contains('open');
                        closeEquipmentFilterSelectMenus();
                        if (!isOpen) {
                            wrapper.classList.add('open');
                            button.setAttribute('aria-expanded', 'true');
                        }
                    });
                }

                selectEl.addEventListener('change', syncUI);

                if (resetBtn) {
                    resetBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        selectEl.value = '';
                        selectEl.dispatchEvent(new Event('change'));
                        syncUI();
                        closeEquipmentFilterSelectMenus();
                    });
                }

                syncUI();
                equipmentFilterSelectControllers.set(selectEl, { sync: syncUI });
            });

            // Модальное окно добавления
            const equipmentForm = document.getElementById('equipmentForm');
            const equipmentFormSubmit = document.getElementById('equipmentFormSubmit');
            const equipmentFormError = document.getElementById('equipmentFormError');
            const sparePartTypesList = document.getElementById('sparePartTypesList');
            const addSparePartTypeBtn = document.getElementById('addSparePartTypeBtn');
            const sparePartTypeSelect = document.getElementById('sparePartTypeSelect');
            let selectedSparePartTypes = [];

            // Определяем переменные для кнопок выпадающих списков ДО их использования
            const equipmentTypeBtn = document.getElementById('equipmentTypeBtn');
            const equipmentMaintenanceBtn = document.getElementById('equipmentMaintenanceBtn');
            const equipmentDepartmentBtn = document.getElementById('equipmentDepartmentBtn');
            const equipmentDepartmentBtnNew = document.getElementById('equipmentDepartmentBtnNew');
            const sparePartTypeBtn = document.getElementById('sparePartTypeBtn');

            // Элементы для поиска и режимов
            const equipmentNameInput = document.getElementById('equipmentNameInput');
            const equipmentSearchResults = document.getElementById('equipmentSearchResults');
            const equipmentModeIndicator = document.getElementById('equipmentModeIndicator');
            const newEquipmentForm = document.getElementById('newEquipmentForm');
            const existingEquipmentForm = document.getElementById('existingEquipmentForm');
            const existingEquipmentId = document.getElementById('existingEquipmentId');
            let searchTimeout = null;
            let selectedExistingEquipment = null;
            
            function openEquipmentModal() {
                if (!equipmentModal) return;
                // Инициализируем данные выпадающих списков при открытии модального окна
                initializeEquipmentModalSelectData();
                // Закрываем dropdown сотрудников, если открыт
                if (typeof closeModalDropdown === 'function') {
                    closeModalDropdown();
                }
                equipmentModal.classList.add('visible');
                document.body.classList.add('modal-open');
                // Убираем aria-hidden после небольшой задержки, чтобы избежать предупреждения
                setTimeout(() => {
                    equipmentModal.setAttribute('aria-hidden', 'false');
                }, 100);
                // Сброс формы
                if (equipmentForm) {
                    equipmentForm.reset();
                    selectedSparePartTypes = [];
                    selectedExistingEquipment = null;
                    if (sparePartTypesList) {
                        sparePartTypesList.innerHTML = '';
                    }
                    // Сброс режимов
                    if (newEquipmentForm) newEquipmentForm.style.display = 'none';
                    if (existingEquipmentForm) existingEquipmentForm.style.display = 'none';
                    if (equipmentModeIndicator) equipmentModeIndicator.style.display = 'none';
                    if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                    if (equipmentNameInput) equipmentNameInput.value = '';
                    if (existingEquipmentId) existingEquipmentId.value = '';
                }
                // Сброс выпадающих списков
                closeEquipmentModalDropdown();
                const equipmentFacilityBtn = document.getElementById('equipmentFacilityBtn');
                const equipmentFacilityBtnNew = document.getElementById('equipmentFacilityBtnNew');
                const equipmentBtns = [equipmentTypeBtn, equipmentMaintenanceBtn, equipmentFacilityBtn, equipmentFacilityBtnNew, equipmentDepartmentBtn, equipmentDepartmentBtnNew, sparePartTypeBtn];
                equipmentBtns.forEach(btn => {
                    if (btn) {
                        const label = btn.querySelector('.modal-select-label');
                        if (label) {
                            const defaultTexts = {
                                'equipmentTypeBtn': 'Выберите тип',
                                'equipmentMaintenanceBtn': 'Выберите периодичность',
                                'equipmentFacilityBtn': 'Выберите предприятие',
                                'equipmentDepartmentBtn': 'Сначала выберите предприятие',
                                'equipmentDepartmentBtnNew': 'Выберите отдел',
                                'sparePartTypeBtn': 'Выберите тип детали'
                            };
                            label.textContent = defaultTexts[btn.id] || 'Выберите...';
                        }
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
                // Сброс выбора предприятия и отдела для существующего оборудования
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                const acquisitionDateInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="acquisition_date"]') : null;
                
                // Убираем required с полей существующего оборудования при открытии
                if (equipmentFacilitySelect) {
                    equipmentFacilitySelect.value = '';
                    equipmentFacilitySelect.removeAttribute('required');
                    handleEquipmentFacilityChange();
                }
                if (equipmentDepartmentSelect) {
                    equipmentDepartmentSelect.removeAttribute('required');
                }
                if (acquisitionDateInput) {
                    acquisitionDateInput.removeAttribute('required');
                }
                
                if (equipmentFormError) {
                    equipmentFormError.textContent = '';
                }
                // Фокус на поле ввода названия
                if (equipmentNameInput) {
                    setTimeout(() => equipmentNameInput.focus(), 100);
                }
            }
            
            // Поиск оборудования при вводе названия
            if (equipmentNameInput) {
                // Предотвращаем отправку формы при нажатии Enter в поле поиска
                equipmentNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // Если есть результаты поиска, не отправляем форму
                        if (equipmentSearchResults && equipmentSearchResults.style.display !== 'none') {
                            return;
                        }
                        // Если форма не видна, не отправляем
                        const isNewFormVisible = newEquipmentForm && newEquipmentForm.style.display !== 'none';
                        const isExistingFormVisible = existingEquipmentForm && existingEquipmentForm.style.display !== 'none';
                        if (!isNewFormVisible && !isExistingFormVisible) {
                            return;
                        }
                    }
                });
                
                equipmentNameInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    // Очищаем предыдущий таймаут
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    
                    // Скрываем формы, но не результаты поиска (они будут обновлены)
                    if (equipmentModeIndicator) equipmentModeIndicator.style.display = 'none';
                    if (newEquipmentForm) newEquipmentForm.style.display = 'none';
                    if (existingEquipmentForm) existingEquipmentForm.style.display = 'none';
                    selectedExistingEquipment = null;
                    if (existingEquipmentId) existingEquipmentId.value = '';
                    
                    // Убираем required с полей существующего оборудования при скрытии
                    const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                    const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                    const acquisitionDateInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="acquisition_date"]') : null;
                    if (equipmentFacilitySelect) equipmentFacilitySelect.removeAttribute('required');
                    if (equipmentDepartmentSelect) equipmentDepartmentSelect.removeAttribute('required');
                    if (acquisitionDateInput) acquisitionDateInput.removeAttribute('required');
                    
                    if (query.length < 2) {
                        // Скрываем результаты, если запрос слишком короткий
                        if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                        return;
                    }
                    
                    // Задержка перед поиском
                    searchTimeout = setTimeout(() => {
                        console.log('Выполняю поиск для:', query);
                        fetch(`/admin/equipment/search?q=${encodeURIComponent(query)}`)
                            .then(response => {
                                console.log('Ответ получен, status:', response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log('Данные поиска:', data);
                                if (data.success && data.results !== undefined) {
                                    displaySearchResults(data.results, query);
                                } else {
                                    console.warn('Неожиданный формат ответа:', data);
                                }
                            })
                            .catch(err => {
                                console.error('Ошибка поиска:', err);
                            });
                    }, 300);
                });
                
                // Закрытие результатов при клике вне
                document.addEventListener('click', (e) => {
                    const searchRow = equipmentNameInput ? equipmentNameInput.closest('.modal-row') : null;
                    if (equipmentSearchResults && 
                        !equipmentNameInput.contains(e.target) && 
                        !equipmentSearchResults.contains(e.target) &&
                        !(searchRow && searchRow.contains(e.target) && e.target !== equipmentNameInput)) {
                        equipmentSearchResults.style.display = 'none';
                    }
                });
            }
            
            function displaySearchResults(results, query) {
                console.log('displaySearchResults called with:', results.length, 'results, query:', query);
                if (!equipmentSearchResults) {
                    console.error('equipmentSearchResults element not found!');
                    return;
                }
                
                // Получаем позицию input поля для правильного позиционирования результатов
                const inputRect = equipmentNameInput ? equipmentNameInput.getBoundingClientRect() : null;
                const searchRow = equipmentNameInput ? equipmentNameInput.closest('.modal-row') : null;
                const rowRect = searchRow ? searchRow.getBoundingClientRect() : null;
                
                console.log('equipmentSearchResults found, clearing innerHTML');
                equipmentSearchResults.innerHTML = '';
                
                // Позиционируем результаты относительно input поля
                if (inputRect && rowRect) {
                    equipmentSearchResults.style.top = `${inputRect.bottom - rowRect.top + 4}px`;
                    equipmentSearchResults.style.left = `${inputRect.left - rowRect.left}px`;
                    equipmentSearchResults.style.width = `${inputRect.width}px`;
                }
                
                if (results.length === 0) {
                    console.log('No results, showing "add new" message');
                    // Нет результатов - показываем предложение добавить новое
                    const noResultsContainer = document.createElement('div');
                    noResultsContainer.className = 'equipment-search-no-results';
                    
                    const message = document.createElement('div');
                    message.className = 'equipment-search-no-results-message';
                    message.textContent = `Оборудование "${query}" не найдено в базе данных.`;
                    
                    const actionButton = document.createElement('button');
                    actionButton.type = 'button';
                    actionButton.className = 'primary-btn';
                    actionButton.style.cssText = 'width: 100%; padding: 10px 16px; font-size: 14px;';
                    actionButton.textContent = 'Добавить новое оборудование';
                    actionButton.addEventListener('click', () => {
                        setEquipmentMode('new', null);
                        if (equipmentNameInput) equipmentNameInput.value = query;
                        if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                    });
                    
                    noResultsContainer.appendChild(message);
                    noResultsContainer.appendChild(actionButton);
                    equipmentSearchResults.appendChild(noResultsContainer);
                    equipmentSearchResults.style.display = 'block';
                    
                    const rect = equipmentSearchResults.getBoundingClientRect();
                    const computed = window.getComputedStyle(equipmentSearchResults);
                    console.log('No results container displayed');
                    console.log('  display:', computed.display);
                    console.log('  visibility:', computed.visibility);
                    console.log('  opacity:', computed.opacity);
                    console.log('  z-index:', computed.zIndex);
                    console.log('  position:', computed.position);
                    console.log('  top:', computed.top, 'left:', computed.left);
                    console.log('  width:', rect.width, 'height:', rect.height);
                    console.log('  boundingRect:', rect);
                    console.log('  children count:', equipmentSearchResults.children.length);
                    console.log('  parent overflow:', window.getComputedStyle(equipmentSearchResults.parentElement).overflow);
                    return;
                }
                
                // Есть результаты - показываем предложение добавить размещение
                console.log('Has results, showing results container');
                const queryLower = query.toLowerCase().trim();
                const exactMatch = results.find(eq => 
                    eq.equipment_name.toLowerCase().trim() === queryLower || eq.is_exact_match
                );
                const bestMatch = exactMatch || results[0];
                const hasMultipleResults = results.length > 1;
                
                // Выбранное оборудование (по умолчанию - лучшее совпадение)
                let selectedEquipment = bestMatch;
                
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'equipment-search-results-container';
                if (exactMatch) {
                    resultsContainer.classList.add('exact-match');
                }
                
                // Заголовок с предложением
                const header = document.createElement('div');
                header.className = 'equipment-search-header';
                if (exactMatch) {
                    header.classList.add('exact-match');
                }
                
                const headerText = document.createElement('div');
                headerText.className = 'equipment-search-header-text';
                
                if (exactMatch) {
                    headerText.textContent = `Найдено оборудование "${bestMatch.equipment_name}" в базе данных.`;
                } else if (hasMultipleResults) {
                    headerText.textContent = `Найдено ${results.length} похожих. Выберите из списка:`;
                } else {
                    headerText.textContent = `Найдено похожее оборудование "${bestMatch.equipment_name}".`;
                }
                
                const headerSubtext = document.createElement('div');
                headerSubtext.className = 'equipment-search-header-subtext';
                headerSubtext.textContent = exactMatch ? 'Добавить размещение в отдел?' : 'Выберите нужное оборудование из списка ниже:';
                
                header.appendChild(headerText);
                header.appendChild(headerSubtext);
                resultsContainer.appendChild(header);
                
                // Список результатов (показываем всегда, если несколько результатов или нет точного совпадения)
                if (hasMultipleResults || !exactMatch) {
                    const resultsList = document.createElement('div');
                    resultsList.className = 'equipment-search-list';
                    
                    results.forEach((equipment) => {
                        const item = document.createElement('div');
                        const isBest = equipment.id === bestMatch.id;
                        const isExact = equipment.equipment_name.toLowerCase().trim() === queryLower || equipment.is_exact_match;
                        const isSelected = equipment.id === selectedEquipment.id;
                        
                        item.className = 'equipment-search-item';
                        if (isExact) {
                            item.classList.add('exact-match-item');
                        }
                        if (isSelected) {
                            item.classList.add('selected');
                        }
                        item.dataset.equipmentId = equipment.id;
                        
                        const itemName = document.createElement('div');
                        itemName.className = 'equipment-search-item-name';
                        itemName.textContent = equipment.equipment_name;
                        
                        item.appendChild(itemName);
                        
                        if (equipment.equipment_type) {
                            const itemType = document.createElement('div');
                            itemType.className = 'equipment-search-item-type';
                            itemType.textContent = equipment.equipment_type;
                            item.appendChild(itemType);
                        }
                        
                        // При клике только выделяем элемент и обновляем выбранное оборудование
                        item.addEventListener('click', () => {
                            // Убираем выделение со всех элементов
                            resultsList.querySelectorAll('.equipment-search-item').forEach(el => {
                                el.classList.remove('selected');
                            });
                            // Выделяем текущий элемент
                            item.classList.add('selected');
                            // Обновляем выбранное оборудование
                            selectedEquipment = equipment;
                            // Обновляем текст кнопки
                            addPlacementBtn.textContent = `Добавить размещение "${equipment.equipment_name}"`;
                        });
                        resultsList.appendChild(item);
                    });
                    resultsContainer.appendChild(resultsList);
                }
                
                // Кнопка действия
                const actionContainer = document.createElement('div');
                actionContainer.className = 'equipment-search-actions';
                
                const addPlacementBtn = document.createElement('button');
                addPlacementBtn.type = 'button';
                addPlacementBtn.className = 'primary-btn';
                addPlacementBtn.style.cssText = 'flex: 1; padding: 10px 16px; font-size: 14px;';
                addPlacementBtn.textContent = exactMatch ? `Добавить размещение "${bestMatch.equipment_name}"` : `Добавить размещение "${selectedEquipment.equipment_name}"`;
                // Только при нажатии на кнопку добавляем оборудование
                addPlacementBtn.addEventListener('click', () => {
                    selectExistingEquipment(selectedEquipment);
                });
                
                const addNewBtn = document.createElement('button');
                addNewBtn.type = 'button';
                addNewBtn.className = 'secondary-btn';
                addNewBtn.style.cssText = 'flex: 1; padding: 10px 16px; font-size: 14px;';
                addNewBtn.textContent = 'Добавить новое';
                addNewBtn.addEventListener('click', () => {
                    setEquipmentMode('new', null);
                    if (equipmentNameInput) equipmentNameInput.value = query;
                    if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                });
                
                actionContainer.appendChild(addPlacementBtn);
                actionContainer.appendChild(addNewBtn);
                resultsContainer.appendChild(actionContainer);
                
                equipmentSearchResults.appendChild(resultsContainer);
                equipmentSearchResults.style.display = 'block';
                
                const rect = equipmentSearchResults.getBoundingClientRect();
                const computed = window.getComputedStyle(equipmentSearchResults);
                console.log('Results container displayed');
                console.log('  display:', computed.display);
                console.log('  visibility:', computed.visibility);
                console.log('  opacity:', computed.opacity);
                console.log('  z-index:', computed.zIndex);
                console.log('  position:', computed.position);
                console.log('  top:', computed.top, 'left:', computed.left);
                console.log('  width:', rect.width, 'height:', rect.height);
                console.log('  boundingRect:', rect);
                console.log('  children count:', equipmentSearchResults.children.length);
                console.log('  parent:', equipmentSearchResults.parentElement);
                console.log('  parent overflow:', window.getComputedStyle(equipmentSearchResults.parentElement).overflow);
            }
            
            function selectExistingEquipment(equipment) {
                selectedExistingEquipment = equipment;
                if (existingEquipmentId) existingEquipmentId.value = equipment.id;
                if (equipmentNameInput) equipmentNameInput.value = equipment.equipment_name;
                if (equipmentSearchResults) equipmentSearchResults.style.display = 'none';
                setEquipmentMode('existing', equipment);
            }
            
            function setEquipmentMode(mode, equipment) {
                // Плавное переключение с анимацией
                const transitionDuration = 300;
                
                // Управление required атрибутами
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                const acquisitionDateInput = existingEquipmentForm ? existingEquipmentForm.querySelector('input[name="acquisition_date"]') : null;
                
                if (mode === 'new') {
                    // Убираем required с полей существующего оборудования
                    if (equipmentFacilitySelect) equipmentFacilitySelect.removeAttribute('required');
                    if (equipmentDepartmentSelect) equipmentDepartmentSelect.removeAttribute('required');
                    if (acquisitionDateInput) acquisitionDateInput.removeAttribute('required');
                    
                    if (existingEquipmentForm) {
                        existingEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-out`;
                        existingEquipmentForm.style.opacity = '0';
                        setTimeout(() => {
                            existingEquipmentForm.style.display = 'none';
                        }, transitionDuration);
                    }
                    if (newEquipmentForm) {
                        newEquipmentForm.style.display = 'block';
                        newEquipmentForm.style.opacity = '0';
                        newEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        requestAnimationFrame(() => {
                            newEquipmentForm.style.opacity = '1';
                        });
                    }
                    if (equipmentModeIndicator) {
                        equipmentModeIndicator.style.display = 'block';
                        equipmentModeIndicator.style.background = '#e3f2fd';
                        equipmentModeIndicator.style.color = '#1976d2';
                        equipmentModeIndicator.style.border = '1px solid #90caf9';
                        equipmentModeIndicator.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        equipmentModeIndicator.style.opacity = '0';
                        equipmentModeIndicator.textContent = '✓ Режим: Добавление нового оборудования';
                        requestAnimationFrame(() => {
                            equipmentModeIndicator.style.opacity = '1';
                        });
                    }
                } else if (mode === 'existing' && equipment) {
                    // Добавляем required к полям существующего оборудования
                    if (equipmentFacilitySelect) equipmentFacilitySelect.setAttribute('required', 'required');
                    if (equipmentDepartmentSelect) equipmentDepartmentSelect.setAttribute('required', 'required');
                    if (acquisitionDateInput) acquisitionDateInput.setAttribute('required', 'required');
                    
                    if (newEquipmentForm) {
                        newEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-out`;
                        newEquipmentForm.style.opacity = '0';
                        setTimeout(() => {
                            newEquipmentForm.style.display = 'none';
                        }, transitionDuration);
                    }
                    if (existingEquipmentForm) {
                        existingEquipmentForm.style.display = 'block';
                        existingEquipmentForm.style.opacity = '0';
                        existingEquipmentForm.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        requestAnimationFrame(() => {
                            existingEquipmentForm.style.opacity = '1';
                        });
                    }
                    if (equipmentModeIndicator) {
                        equipmentModeIndicator.style.display = 'block';
                        equipmentModeIndicator.style.background = '#fff3e0';
                        equipmentModeIndicator.style.color = '#f57c00';
                        equipmentModeIndicator.style.border = '1px solid #ffb74d';
                        equipmentModeIndicator.style.transition = `opacity ${transitionDuration}ms ease-in`;
                        equipmentModeIndicator.style.opacity = '0';
                        equipmentModeIndicator.innerHTML = `✓ Режим: Добавление размещения оборудования<br><small>Оборудование: ${equipment.equipment_name}${equipment.equipment_type ? ` (${equipment.equipment_type})` : ''}</small>`;
                        requestAnimationFrame(() => {
                            equipmentModeIndicator.style.opacity = '1';
                        });
                    }
                }
            }

            function closeEquipmentModal() {
                if (!equipmentModal) return;
                equipmentModal.classList.remove('visible');
                equipmentModal.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('modal-open');
                closeEquipmentModalDropdown();
                // Сброс формы
                if (equipmentForm) {
                    equipmentForm.reset();
                    selectedSparePartTypes = [];
                    if (sparePartTypesList) {
                        sparePartTypesList.innerHTML = '';
                    }
                }
                if (equipmentFormError) {
                    equipmentFormError.textContent = '';
                }
            }

            // Добавление типа детали
            if (addSparePartTypeBtn && sparePartTypeSelect) {
                addSparePartTypeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const selectedType = sparePartTypeSelect.value;
                    let typeToAdd = null;
                    
                    // Если выбрано "Другое", берем значение из поля ввода
                    if (selectedType === '__custom__') {
                        const customInput = document.getElementById('customSparePartType');
                        if (customInput && customInput.value.trim()) {
                            typeToAdd = customInput.value.trim();
                            customInput.value = '';
                            const customRow = document.getElementById('customSparePartTypeRow');
                            if (customRow) customRow.style.display = 'none';
                        }
                    } else if (selectedType && selectedType.trim()) {
                        typeToAdd = selectedType.trim();
                    }
                    
                    if (typeToAdd && !selectedSparePartTypes.includes(typeToAdd)) {
                        selectedSparePartTypes.push(typeToAdd);
                        updateSparePartTypesList();
                        sparePartTypeSelect.value = '';
                        // Обновляем кнопку выпадающего списка
                        const btn = document.getElementById('sparePartTypeBtn');
                        if (btn) {
                            const label = btn.querySelector('.modal-select-label');
                            if (label) label.textContent = 'Выберите тип детали';
                        }
                        closeEquipmentModalDropdown();
                    }
                });
            }
            

            function updateSparePartTypesList() {
                if (!sparePartTypesList) return;
                sparePartTypesList.innerHTML = '';
                selectedSparePartTypes.forEach((type, index) => {
                    const tag = document.createElement('div');
                    tag.className = 'spare-part-type-tag';
                    tag.innerHTML = `
                        <span>${type}</span>
                        <button type="button" class="remove-tag-btn" data-index="${index}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;
                    const removeBtn = tag.querySelector('.remove-tag-btn');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            selectedSparePartTypes.splice(index, 1);
                            updateSparePartTypesList();
                        });
                    }
                    sparePartTypesList.appendChild(tag);
                });
            }

            // Инициализация данных для выпадающих списков оборудования
            const equipmentModalSelectData = {};
            
            function initializeEquipmentModalSelectData() {
                // Типы оборудования
                const equipmentTypeSelect = document.getElementById('equipmentTypeSelect');
                if (equipmentTypeSelect) {
                    equipmentModalSelectData.equipment_type = {};
                    Array.from(equipmentTypeSelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.equipment_type[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized equipment_type:', Object.keys(equipmentModalSelectData.equipment_type).length, 'options');
                }
                
                // Изображения
                const equipmentImageSelect = document.getElementById('equipmentImageSelect');
                if (equipmentImageSelect) {
                    equipmentModalSelectData.image_path = {};
                    Array.from(equipmentImageSelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.image_path[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized image_path:', Object.keys(equipmentModalSelectData.image_path).length, 'options');
                }
                
                // Периодичность ТО (предустановленные значения)
                const equipmentMaintenanceSelect = document.getElementById('equipmentMaintenanceSelect');
                if (equipmentMaintenanceSelect) {
                    equipmentModalSelectData.maintenance_frequency = {
                        '7': 'Раз в неделю (7 дней)',
                        '30': 'Раз в месяц (30 дней)',
                        '90': 'Раз в квартал (90 дней)',
                        '365': 'Раз в год (365 дней)',
                        'custom': 'Другое'
                    };
                    console.log('Initialized maintenance_frequency:', Object.keys(equipmentModalSelectData.maintenance_frequency).length, 'options');
                }
                
                // Предприятия (для существующего оборудования)
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                if (equipmentFacilitySelect) {
                    equipmentModalSelectData.facility_id = {};
                    Array.from(equipmentFacilitySelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.facility_id[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized facility_id:', Object.keys(equipmentModalSelectData.facility_id).length, 'options');
                }
                
                // Предприятия (для нового оборудования) - используем те же данные
                const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
                if (equipmentFacilitySelectNew) {
                    if (!equipmentModalSelectData.facility_id) {
                        equipmentModalSelectData.facility_id = {};
                    }
                    Array.from(equipmentFacilitySelectNew.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.facility_id[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized facility_id (new):', Object.keys(equipmentModalSelectData.facility_id).length, 'options');
                }
                
                // Отделы (для существующего оборудования) - будет заполняться динамически
                equipmentModalSelectData.department_id = {};
                
                // Отделы (для нового оборудования)
                const equipmentDepartmentSelectNew = document.getElementById('equipmentDepartmentSelectNew');
                if (equipmentDepartmentSelectNew) {
                    if (!equipmentModalSelectData.department_id_new) {
                        equipmentModalSelectData.department_id_new = {};
                    }
                    Array.from(equipmentDepartmentSelectNew.options).forEach(opt => {
                        if (opt.value !== '') {
                            const deptName = opt.textContent.trim();
                            equipmentModalSelectData.department_id_new[opt.value] = deptName;
                        }
                    });
                }
                
                // Типы деталей (переменная уже объявлена выше)
                if (sparePartTypeSelect) {
                    equipmentModalSelectData.spare_part_type = {};
                    Array.from(sparePartTypeSelect.options).forEach(opt => {
                        if (opt.value !== '') {
                            equipmentModalSelectData.spare_part_type[opt.value] = opt.textContent.trim();
                        }
                    });
                    console.log('Initialized spare_part_type:', Object.keys(equipmentModalSelectData.spare_part_type).length, 'options');
                }
            }
            
            // Инициализируем данные сразу
            initializeEquipmentModalSelectData();

            // Используем тот же modalDropdown, что и для формы сотрудников
            let equipmentModalDropdown = document.getElementById('modalDropdown');
            // Если dropdown не существует, создаем его
            if (!equipmentModalDropdown) {
                equipmentModalDropdown = document.createElement('div');
                equipmentModalDropdown.className = 'role-dropdown';
                equipmentModalDropdown.id = 'modalDropdown';
                document.body.appendChild(equipmentModalDropdown);
            }
            let currentEquipmentModalSelect = null;
            
            // Создаём карту отделов по предприятиям для формы оборудования
            const equipmentFacilityDeptMap = {};
            const equipmentDepartmentsData = {{ department_choices|tojson }};
            if (equipmentDepartmentsData && Array.isArray(equipmentDepartmentsData)) {
                equipmentDepartmentsData.forEach(dept => {
                    const facilityId = dept.facility_id ? String(dept.facility_id) : '';
                    if (!facilityId) return;
                    if (!equipmentFacilityDeptMap[facilityId]) {
                        equipmentFacilityDeptMap[facilityId] = [];
                    }
                    equipmentFacilityDeptMap[facilityId].push({
                        id: String(dept.id),
                        name: dept.name
                    });
                });
                Object.keys(equipmentFacilityDeptMap).forEach(key => {
                    equipmentFacilityDeptMap[key].sort((a, b) => a.name.localeCompare(b.name, 'ru', { sensitivity: 'base' }));
                });
                console.log('equipmentFacilityDeptMap created:', Object.keys(equipmentFacilityDeptMap).length, 'facilities');
                Object.keys(equipmentFacilityDeptMap).forEach(facilityId => {
                    console.log(`Facility ${facilityId}: ${equipmentFacilityDeptMap[facilityId].length} departments`);
                });
            } else {
                console.warn('equipmentDepartmentsData is not available or not an array');
            }
            
            function populateEquipmentDepartmentOptions(facilityId) {
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                if (!equipmentDepartmentSelect) return;
                
                const equipmentDepartmentBtn = document.getElementById('equipmentDepartmentBtn');
                const equipmentDepartmentLabel = equipmentDepartmentBtn?.querySelector('.modal-select-label');
                
                equipmentDepartmentSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
                placeholder.disabled = !facilityId;
                placeholder.selected = true;
                equipmentDepartmentSelect.appendChild(placeholder);
                
                if (!facilityId) {
                    equipmentDepartmentSelect.disabled = true;
                    if (equipmentDepartmentBtn) {
                        equipmentDepartmentBtn.disabled = true;
                        if (equipmentDepartmentLabel) {
                            equipmentDepartmentLabel.textContent = 'Сначала выберите предприятие';
                        }
                    }
                    // Обновляем данные для dropdown
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id = {};
                    }
                    return;
                }
                
                const departments = equipmentFacilityDeptMap[facilityId] || [];
                console.log('populateEquipmentDepartmentOptions - facilityId:', facilityId, 'departments:', departments.length);
                console.log('equipmentFacilityDeptMap keys:', Object.keys(equipmentFacilityDeptMap));
                if (departments.length === 0) {
                    console.warn('No departments found for facilityId:', facilityId);
                    placeholder.textContent = 'Для выбранного предприятия нет отделов';
                    equipmentDepartmentSelect.disabled = true;
                    if (equipmentDepartmentBtn) {
                        equipmentDepartmentBtn.disabled = true;
                        if (equipmentDepartmentLabel) {
                            equipmentDepartmentLabel.textContent = 'Для выбранного предприятия нет отделов';
                        }
                    }
                    // Обновляем данные для dropdown
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id = {};
                    }
                    return;
                }
                
                // Обновляем данные для dropdown
                if (equipmentModalSelectData) {
                    equipmentModalSelectData.department_id = {};
                    departments.forEach(dept => {
                        equipmentModalSelectData.department_id[dept.id] = dept.name;
                    });
                }
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    equipmentDepartmentSelect.appendChild(option);
                });
                equipmentDepartmentSelect.disabled = false;
                if (equipmentDepartmentBtn) {
                    equipmentDepartmentBtn.disabled = false;
                    if (equipmentDepartmentLabel) {
                        equipmentDepartmentLabel.textContent = 'Выберите отдел';
                    }
                    console.log('Department button enabled, departments count:', departments.length);
                    console.log('Department data updated:', equipmentModalSelectData.department_id);
                }
            }
            
            function handleEquipmentFacilityChange() {
                const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                if (!equipmentFacilitySelect) return;
                const facilityId = equipmentFacilitySelect.value;
                console.log('handleEquipmentFacilityChange called with facilityId:', facilityId);
                
                // Сначала обновляем опции отделов
                populateEquipmentDepartmentOptions(facilityId);
                
                // Затем обновляем состояние кнопки и select
                const equipmentDepartmentSelect = document.getElementById('equipmentDepartmentSelect');
                if (equipmentDepartmentSelect) {
                    equipmentDepartmentSelect.value = '';
                }
                
                // Обновляем кастомную кнопку отдела
                const equipmentDepartmentBtn = document.getElementById('equipmentDepartmentBtn');
                if (equipmentDepartmentBtn) {
                    const label = equipmentDepartmentBtn.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
                    }
                    // Убеждаемся, что кнопка разблокирована, если выбрано предприятие и есть отделы
                    if (facilityId) {
                        const departments = equipmentFacilityDeptMap[facilityId] || [];
                        if (departments.length > 0) {
                            equipmentDepartmentBtn.disabled = false;
                            console.log('Department button enabled, facilityId:', facilityId, 'departments:', departments.length);
                        } else {
                            equipmentDepartmentBtn.disabled = true;
                            console.log('Department button disabled, no departments for facilityId:', facilityId);
                        }
                    } else {
                        equipmentDepartmentBtn.disabled = true;
                    }
                }
            }
            
            function populateEquipmentDepartmentOptionsNew(facilityId) {
                const equipmentDepartmentSelectNew = document.getElementById('equipmentDepartmentSelectNew');
                if (!equipmentDepartmentSelectNew) return;
                
                const equipmentDepartmentBtnNew = document.getElementById('equipmentDepartmentBtnNew');
                const equipmentDepartmentLabelNew = equipmentDepartmentBtnNew?.querySelector('.modal-select-label');
                
                equipmentDepartmentSelectNew.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
                placeholder.disabled = !facilityId;
                placeholder.selected = true;
                equipmentDepartmentSelectNew.appendChild(placeholder);
                
                if (!facilityId) {
                    equipmentDepartmentSelectNew.disabled = true;
                    if (equipmentDepartmentBtnNew) {
                        equipmentDepartmentBtnNew.disabled = true;
                        if (equipmentDepartmentLabelNew) {
                            equipmentDepartmentLabelNew.textContent = 'Сначала выберите предприятие';
                        }
                    }
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id_new = {};
                    }
                    return;
                }
                
                const departments = equipmentFacilityDeptMap[facilityId] || [];
                if (departments.length === 0) {
                    placeholder.textContent = 'Для выбранного предприятия нет отделов';
                    equipmentDepartmentSelectNew.disabled = true;
                    if (equipmentDepartmentBtnNew) {
                        equipmentDepartmentBtnNew.disabled = true;
                        if (equipmentDepartmentLabelNew) {
                            equipmentDepartmentLabelNew.textContent = 'Для выбранного предприятия нет отделов';
                        }
                    }
                    if (equipmentModalSelectData) {
                        equipmentModalSelectData.department_id_new = {};
                    }
                    return;
                }
                
                if (equipmentModalSelectData) {
                    equipmentModalSelectData.department_id_new = {};
                    departments.forEach(dept => {
                        equipmentModalSelectData.department_id_new[dept.id] = dept.name;
                    });
                }
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    equipmentDepartmentSelectNew.appendChild(option);
                });
                equipmentDepartmentSelectNew.disabled = false;
                if (equipmentDepartmentBtnNew) {
                    equipmentDepartmentBtnNew.disabled = false;
                    if (equipmentDepartmentLabelNew) {
                        equipmentDepartmentLabelNew.textContent = 'Выберите отдел';
                    }
                }
            }
            
            function handleEquipmentFacilityChangeNew() {
                const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
                if (!equipmentFacilitySelectNew) return;
                const facilityId = equipmentFacilitySelectNew.value;
                
                populateEquipmentDepartmentOptionsNew(facilityId);
                
                const equipmentDepartmentSelectNew = document.getElementById('equipmentDepartmentSelectNew');
                if (equipmentDepartmentSelectNew) {
                    equipmentDepartmentSelectNew.value = '';
                }
                
                const equipmentDepartmentBtnNew = document.getElementById('equipmentDepartmentBtnNew');
                if (equipmentDepartmentBtnNew) {
                    const label = equipmentDepartmentBtnNew.querySelector('.modal-select-label');
                    if (label) {
                        label.textContent = facilityId ? 'Выберите отдел' : 'Сначала выберите предприятие';
                    }
                    if (facilityId) {
                        const departments = equipmentFacilityDeptMap[facilityId] || [];
                        if (departments.length > 0) {
                            equipmentDepartmentBtnNew.disabled = false;
                        } else {
                            equipmentDepartmentBtnNew.disabled = true;
                        }
                    } else {
                        equipmentDepartmentBtnNew.disabled = true;
                    }
                }
            }
            
            function populateEquipmentModalDropdown(field, options) {
                if (!equipmentModalDropdown || !options || Object.keys(options).length === 0) {
                    return;
                }
                
                equipmentModalDropdown.innerHTML = '';
                Object.entries(options).forEach(([value, label]) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'role-dropdown-option';
                    option.dataset.value = value;
                    option.textContent = label || value || '—';
                    option.addEventListener('click', () => {
                        if (!currentEquipmentModalSelect) return;
                        const btn = currentEquipmentModalSelect;
                        const select = btn.parentElement.querySelector('select');
                        const labelSpan = btn.querySelector('.modal-select-label');
                        
                        if (select && labelSpan) {
                            select.value = value;
                            
                            // Обработка "Другое" для типа оборудования
                            if (field === 'equipment_type' && value === '__custom__') {
                                const customRow = document.getElementById('customEquipmentTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'block';
                                    const customInput = document.getElementById('customEquipmentType');
                                    if (customInput) {
                                        customInput.focus();
                                        customInput.setAttribute('required', 'required');
                                    }
                                }
                                labelSpan.textContent = 'Другое';
                            } else if (field === 'equipment_type') {
                                const customRow = document.getElementById('customEquipmentTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'none';
                                    const customInput = document.getElementById('customEquipmentType');
                                    if (customInput) {
                                        customInput.removeAttribute('required');
                                        customInput.value = '';
                                    }
                                }
                                labelSpan.textContent = label;
                            }
                            // Обработка "Другое" для типов деталей
                            else if (field === 'spare_part_type' && value === '__custom__') {
                                const customRow = document.getElementById('customSparePartTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'block';
                                    const customInput = document.getElementById('customSparePartType');
                                    if (customInput) {
                                        customInput.focus();
                                        customInput.value = '';
                                    }
                                }
                                labelSpan.textContent = 'Другое';
                                // Не закрываем dropdown и не добавляем автоматически
                                closeEquipmentModalDropdown();
                                return;
                            } else if (field === 'spare_part_type' && value && value !== '__custom__') {
                                const customRow = document.getElementById('customSparePartTypeRow');
                                if (customRow) {
                                    customRow.style.display = 'none';
                                    const customInput = document.getElementById('customSparePartType');
                                    if (customInput) {
                                        customInput.value = '';
                                    }
                                }
                                // Автоматически добавляем выбранный тип
                                if (!selectedSparePartTypes.includes(value)) {
                                    selectedSparePartTypes.push(value);
                                    updateSparePartTypesList();
                                    select.value = '';
                                    labelSpan.textContent = 'Выберите тип детали';
                                }
                            } else {
                                labelSpan.textContent = label;
                            }
                            
                            btn.setAttribute('aria-expanded', 'false');
                            
                            // Для предприятия вызываем специальную обработку
                            if (field === 'facility_id' || field === 'facility_id_new') {
                                requestAnimationFrame(() => {
                                    if (field === 'facility_id') {
                                        handleEquipmentFacilityChange();
                                    } else if (field === 'facility_id_new') {
                                        handleEquipmentFacilityChangeNew();
                                    }
                                });
                            } else if (field !== 'spare_part_type' || value === '__custom__') {
                                select.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                        closeEquipmentModalDropdown();
                    });
                    equipmentModalDropdown.appendChild(option);
                });
            }

            function positionEquipmentModalDropdown(btn) {
                if (!btn || !equipmentModalDropdown) return;
                const rect = btn.getBoundingClientRect();
                const dropdownHeight = equipmentModalDropdown.offsetHeight || 200;
                const viewportHeight = window.innerHeight;
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;
                const openUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
                
                equipmentModalDropdown.style.position = 'fixed';
                if (openUpward) {
                    equipmentModalDropdown.style.bottom = `${viewportHeight - rect.top + 6}px`;
                    equipmentModalDropdown.style.top = 'auto';
                } else {
                    equipmentModalDropdown.style.top = `${rect.bottom + 6}px`;
                    equipmentModalDropdown.style.bottom = 'auto';
                }
                equipmentModalDropdown.style.left = `${rect.left}px`;
                equipmentModalDropdown.style.width = `${rect.width}px`;
                equipmentModalDropdown.style.minWidth = `${rect.width}px`;
                equipmentModalDropdown.style.maxWidth = `${rect.width}px`;
            }

            function openEquipmentModalDropdown(btn) {
                if (!btn || btn.disabled) return;
                const field = btn.dataset.field;
                if (!field) return;
                
                // Маппинг полей к ключам в equipmentModalSelectData
                const fieldMap = {
                    'equipment_type': 'equipment_type',
                    'maintenance_frequency': 'maintenance_frequency',
                    'facility_id': 'facility_id',
                    'facility_id_new': 'facility_id',
                    'department_id': 'department_id',
                    'department_id_new': 'department_id_new',
                    'spare_part_type': 'spare_part_type'
                };
                
                const dataKey = fieldMap[field] || field;
                
                // Специальная обработка для facility_id_new - используем facility_id
                if (field === 'facility_id_new') {
                    const actualDataKey = 'facility_id';
                    if (!equipmentModalSelectData || !equipmentModalSelectData[actualDataKey] || Object.keys(equipmentModalSelectData[actualDataKey]).length === 0) {
                        console.warn('No facility_id data found, re-initializing...');
                        initializeEquipmentModalSelectData();
                        if (!equipmentModalSelectData || !equipmentModalSelectData[actualDataKey] || Object.keys(equipmentModalSelectData[actualDataKey]).length === 0) {
                            console.warn('Still no facility_id data after re-initialization');
                            return;
                        }
                    }
                    const options = equipmentModalSelectData[actualDataKey];
                    currentEquipmentModalSelect = btn;
                    populateEquipmentModalDropdown(field, options);
                    requestAnimationFrame(() => {
                        positionEquipmentModalDropdown(btn);
                        if (equipmentModalDropdown) {
                            equipmentModalDropdown.classList.add('visible');
                        }
                        btn.setAttribute('aria-expanded', 'true');
                    });
                    return;
                }
                
                if (!equipmentModalSelectData || !equipmentModalSelectData[dataKey]) {
                    console.warn('No data key found:', dataKey, 'Available keys:', Object.keys(equipmentModalSelectData || {}));
                    // Для отдела, если данных нет, но выбрано предприятие, попробуем обновить данные
                    if (field === 'department_id') {
                        const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
                        if (equipmentFacilitySelect && equipmentFacilitySelect.value) {
                            console.log('Trying to refresh department data for facility:', equipmentFacilitySelect.value);
                            populateEquipmentDepartmentOptions(equipmentFacilitySelect.value);
                            // Повторно проверяем данные
                            if (!equipmentModalSelectData || !equipmentModalSelectData[dataKey] || Object.keys(equipmentModalSelectData[dataKey]).length === 0) {
                                console.warn('Still no department data after refresh');
                                return;
                            }
                        } else {
                            console.warn('No facility selected for department dropdown');
                            return;
                        }
                    } else if (field === 'department_id_new') {
                        const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
                        if (equipmentFacilitySelectNew && equipmentFacilitySelectNew.value) {
                            console.log('Trying to refresh department data for facility (new):', equipmentFacilitySelectNew.value);
                            populateEquipmentDepartmentOptionsNew(equipmentFacilitySelectNew.value);
                            // Повторно проверяем данные
                            if (!equipmentModalSelectData || !equipmentModalSelectData[dataKey] || Object.keys(equipmentModalSelectData[dataKey]).length === 0) {
                                console.warn('Still no department data after refresh (new)');
                                return;
                            }
                        } else {
                            console.warn('No facility selected for department dropdown (new)');
                            return;
                        }
                    } else {
                        return;
                    }
                }
                
                const options = equipmentModalSelectData[dataKey];
                if (!options || Object.keys(options).length === 0) {
                    console.warn('No options for field:', field, 'dataKey:', dataKey);
                    return;
                }
                
                currentEquipmentModalSelect = btn;
                populateEquipmentModalDropdown(field, options);
                
                requestAnimationFrame(() => {
                    positionEquipmentModalDropdown(btn);
                    if (equipmentModalDropdown) {
                        equipmentModalDropdown.classList.add('visible');
                        console.log('Dropdown opened, classes:', equipmentModalDropdown.className, 'visible:', equipmentModalDropdown.classList.contains('visible'));
                    } else {
                        console.error('equipmentModalDropdown is null!');
                    }
                    btn.setAttribute('aria-expanded', 'true');
                });
            }

            function closeEquipmentModalDropdown() {
                if (!equipmentModalDropdown) return;
                equipmentModalDropdown.classList.remove('visible');
                if (currentEquipmentModalSelect) {
                    currentEquipmentModalSelect.setAttribute('aria-expanded', 'false');
                    currentEquipmentModalSelect = null;
                }
            }

            // Обработчики для кнопок выпадающих списков (переменные уже определены выше)
            const equipmentFacilityBtn = document.getElementById('equipmentFacilityBtn');
            const equipmentFacilityBtnNew = document.getElementById('equipmentFacilityBtnNew');
            const allEquipmentBtns = [equipmentTypeBtn, equipmentMaintenanceBtn, equipmentFacilityBtn, equipmentFacilityBtnNew, equipmentDepartmentBtn, equipmentDepartmentBtnNew, sparePartTypeBtn].filter(btn => btn !== null);
            allEquipmentBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (btn.disabled) return;
                    
                    if (currentEquipmentModalSelect === btn) {
                        closeEquipmentModalDropdown();
                    } else {
                        closeEquipmentModalDropdown();
                        openEquipmentModalDropdown(btn);
                    }
                });
            });
            
            // Обработчик изменения предприятия
            const equipmentFacilitySelect = document.getElementById('equipmentFacilitySelect');
            if (equipmentFacilitySelect) {
                equipmentFacilitySelect.addEventListener('change', handleEquipmentFacilityChange);
            }
            
            // Обработчик изменения предприятия для нового оборудования
            const equipmentFacilitySelectNew = document.getElementById('equipmentFacilitySelectNew');
            if (equipmentFacilitySelectNew) {
                equipmentFacilitySelectNew.addEventListener('change', handleEquipmentFacilityChangeNew);
            }

            // Сворачивание при клике в сторону (вне dropdown)
            document.addEventListener('click', (e) => {
                if (equipmentModalDropdown && equipmentModalDropdown.classList.contains('visible')) {
                    // Проверяем, что клик не по кнопке и не по dropdown
                    const clickedBtn = e.target.closest('.modal-select-btn');
                    const clickedDropdown = e.target.closest('.role-dropdown');
                    if (!clickedBtn && !clickedDropdown) {
                        closeEquipmentModalDropdown();
                    }
                }
            });

            // Закрытие по Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && equipmentModalDropdown && equipmentModalDropdown.classList.contains('visible') && 
                    equipmentModal && equipmentModal.classList.contains('visible')) {
                    closeEquipmentModalDropdown();
                }
            });
            
            // Стилизация календарей
            if (equipmentForm) {
                const dateInputs = equipmentForm.querySelectorAll('input[type="date"]');
                dateInputs.forEach(input => {
                    // Добавляем класс для стилизации
                    input.classList.add('styled-date-input');
                    
                    // Обработка изменения даты
                    input.addEventListener('change', function() {
                        if (this.value) {
                            this.classList.add('has-value');
                        } else {
                            this.classList.remove('has-value');
                        }
                    });
                    
                    // Проверяем начальное значение
                    if (input.value) {
                        input.classList.add('has-value');
                    }
                });
            }

            // Обработка выбора "Другое" для периодичности ТО
            const equipmentMaintenanceSelect = document.getElementById('equipmentMaintenanceSelect');
            const customMaintenanceRow = document.getElementById('customMaintenanceRow');
            const customMaintenanceFrequency = document.getElementById('customMaintenanceFrequency');
            
            if (equipmentMaintenanceSelect) {
                equipmentMaintenanceSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        if (customMaintenanceRow) customMaintenanceRow.style.display = 'block';
                        if (customMaintenanceFrequency) customMaintenanceFrequency.required = true;
                    } else {
                        if (customMaintenanceRow) customMaintenanceRow.style.display = 'none';
                        if (customMaintenanceFrequency) {
                            customMaintenanceFrequency.required = false;
                            customMaintenanceFrequency.value = '';
                        }
                    }
                });
            }
            
            // Обработка загрузки изображения
            const equipmentImageInput = document.getElementById('equipmentImageInput');
            const equipmentImagePreview = document.getElementById('equipmentImagePreview');
            const equipmentImagePreviewImg = document.getElementById('equipmentImagePreviewImg');
            
            if (equipmentImageInput) {
                equipmentImageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Размер файла не должен превышать 5 МБ');
                            e.target.value = '';
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            if (equipmentImagePreviewImg) {
                                equipmentImagePreviewImg.src = event.target.result;
                            }
                            if (equipmentImagePreview) {
                                equipmentImagePreview.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        if (equipmentImagePreview) equipmentImagePreview.style.display = 'none';
                    }
                });
            }
            
            // Удаление изображения
            const removeEquipmentImageBtn = document.getElementById('removeEquipmentImageBtn');
            if (removeEquipmentImageBtn) {
                removeEquipmentImageBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (equipmentImagePreview) {
                        equipmentImagePreview.style.display = 'none';
                    }
                    if (equipmentImagePreviewImg) {
                        equipmentImagePreviewImg.src = '';
                    }
                    if (equipmentImageInput) {
                        equipmentImageInput.value = '';
                    }
                });
            }
            
            // Обработка отправки формы
            if (equipmentForm) {
                equipmentForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    
                    // Проверяем, что выбран режим (новая или существующая форма видна)
                    const isNewFormVisible = newEquipmentForm && newEquipmentForm.style.display !== 'none';
                    const isExistingFormVisible = existingEquipmentForm && existingEquipmentForm.style.display !== 'none';
                    
                    if (!isNewFormVisible && !isExistingFormVisible) {
                        if (equipmentFormError) {
                            equipmentFormError.textContent = 'Сначала выберите режим добавления оборудования.';
                        }
                        return;
                    }
                    
                    if (equipmentFormSubmit) {
                        equipmentFormSubmit.disabled = true;
                        equipmentFormSubmit.textContent = 'Сохранение...';
                    }
                    if (equipmentFormError) {
                        equipmentFormError.textContent = '';
                    }

                    const formData = new FormData(equipmentForm);
                    const isExisting = selectedExistingEquipment !== null;
                    
                    if (isExisting) {
                        // Режим существующего оборудования
                        const payload = {
                            existing_equipment_id: formData.get('existing_equipment_id'),
                            acquisition_date: formData.get('acquisition_date') || null,
                            location: formData.get('location')?.trim() || null,
                            department_id: formData.get('department_id') || null,
                            equipment_status: formData.get('equipment_status') || 'В работе'
                        };
                        
                        fetch('/admin/equipment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        })
                        .then(async response => {
                            const data = await response.json();
                            return { ok: response.ok, data };
                        })
                        .then(({ ok, data }) => {
                            if (ok && data.success) {
                                closeEquipmentModal();
                                showEquipmentStatus('Оборудование добавлено', 'success');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 600);
                            } else {
                                if (equipmentFormError) {
                                    equipmentFormError.textContent = data.message || 'Ошибка сохранения.';
                                }
                            }
                        })
                        .catch(() => {
                            if (equipmentFormError) {
                                equipmentFormError.textContent = 'Сеть недоступна. Попробуйте позже.';
                            }
                        })
                        .finally(() => {
                            if (equipmentFormSubmit) {
                                equipmentFormSubmit.disabled = false;
                                equipmentFormSubmit.textContent = 'Сохранить';
                            }
                        });
                    } else {
                        // Режим нового оборудования - сначала загружаем изображение, если есть
                        const imageFile = formData.get('equipment_image');
                        let imagePath = null;
                        
                        if (imageFile && imageFile.size > 0) {
                            // Загружаем изображение
                            const imageFormData = new FormData();
                            imageFormData.append('equipment_image', imageFile);
                            
                            fetch('/admin/equipment/upload-image', {
                                method: 'POST',
                                body: imageFormData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    imagePath = data.image_path;
                                    submitNewEquipment(formData, imagePath);
                                } else {
                                    if (equipmentFormError) {
                                        equipmentFormError.textContent = data.message || 'Ошибка загрузки изображения.';
                                    }
                                    if (equipmentFormSubmit) {
                                        equipmentFormSubmit.disabled = false;
                                        equipmentFormSubmit.textContent = 'Сохранить';
                                    }
                                }
                            })
                            .catch(() => {
                                if (equipmentFormError) {
                                    equipmentFormError.textContent = 'Ошибка загрузки изображения.';
                                }
                                if (equipmentFormSubmit) {
                                    equipmentFormSubmit.disabled = false;
                                    equipmentFormSubmit.textContent = 'Сохранить';
                                }
                            });
                        } else {
                            submitNewEquipment(formData, null);
                        }
                    }
                });
            }
            
            function submitNewEquipment(formData, imagePath) {
                // Определяем периодичность ТО
                let maintenanceFrequency = formData.get('maintenance_frequency');
                if (maintenanceFrequency === 'custom') {
                    maintenanceFrequency = formData.get('custom_maintenance_frequency');
                }
                
                const payload = {
                    equipment_name: formData.get('equipment_name')?.trim(),
                    equipment_type: (formData.get('equipment_type') === '__custom__' 
                        ? formData.get('custom_equipment_type')?.trim() 
                        : formData.get('equipment_type')?.trim()) || null,
                    image_path: imagePath,
                    characteristics: formData.get('characteristics')?.trim() || null,
                    acquisition_date: formData.get('acquisition_date') || null,
                    guarantee_date: formData.get('guarantee_date') || null,
                    maintenance_frequency: maintenanceFrequency || null,
                    department_id: formData.get('department_id_new') || formData.get('department_id') || null,
                    location: formData.get('location')?.trim() || null,
                    spare_part_types: selectedSparePartTypes
                };

                fetch('/admin/equipment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    const data = await response.json();
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        closeEquipmentModal();
                        showEquipmentStatus('Оборудование добавлено', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 600);
                    } else {
                        if (equipmentFormError) {
                            equipmentFormError.textContent = data.message || 'Ошибка сохранения.';
                        }
                    }
                })
                .catch(() => {
                    if (equipmentFormError) {
                        equipmentFormError.textContent = 'Сеть недоступна. Попробуйте позже.';
                    }
                })
                .finally(() => {
                    if (equipmentFormSubmit) {
                        equipmentFormSubmit.disabled = false;
                        equipmentFormSubmit.textContent = 'Сохранить';
                    }
                });
            }

            if (addEquipmentBtn) {
                addEquipmentBtn.addEventListener('click', openEquipmentModal);
            } else {
                console.error('addEquipmentBtn не найден');
            }

            [equipmentModalClose, equipmentModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeEquipmentModal);
                }
            });

            if (equipmentModal) {
                equipmentModal.addEventListener('click', (event) => {
                    if (event.target === equipmentModal) {
                        closeEquipmentModal();
                    }
                });
            }

            // Модальное окно удаления
            function openDeleteEquipmentModal(equipmentId, equipmentRow) {
                if (!deleteEquipmentModal) return;
                
                equipmentToDelete = equipmentId;
                equipmentToDeleteRow = equipmentRow;
                
                const equipmentName = equipmentRow.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
                const equipmentText = equipmentName || 'оборудование';
                if (deleteEquipmentMessage) {
                    deleteEquipmentMessage.innerHTML = `Вы уверены, что хотите удалить оборудование "${equipmentText}"?<br>Это действие нельзя будет отменить.`;
                }
                
                deleteEquipmentModal.setAttribute('aria-hidden', 'false');
                deleteEquipmentModal.classList.add('visible');
                document.body.classList.add('modal-open');
            }

            function closeDeleteEquipmentModal() {
                if (!deleteEquipmentModal) return;
                
                deleteEquipmentModal.setAttribute('aria-hidden', 'true');
                deleteEquipmentModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                
                if (deleteEquipmentConfirm) {
                    deleteEquipmentConfirm.disabled = false;
                    deleteEquipmentConfirm.textContent = 'Удалить';
                }
                
                equipmentToDelete = null;
                equipmentToDeleteRow = null;
            }

            [deleteEquipmentClose, deleteEquipmentCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeDeleteEquipmentModal);
                }
            });

            if (deleteEquipmentModal) {
                deleteEquipmentModal.addEventListener('click', (event) => {
                    if (event.target === deleteEquipmentModal) {
                        closeDeleteEquipmentModal();
                    }
                });
            }

            if (deleteEquipmentConfirm) {
                deleteEquipmentConfirm.addEventListener('click', async () => {
                    if (!equipmentToDelete) return;
                    
                    deleteEquipmentConfirm.disabled = true;
                    deleteEquipmentConfirm.textContent = 'Удаление...';
                    
                    try {
                        const response = await fetch(`/admin/equipment/${equipmentToDelete}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            if (equipmentToDeleteRow && document.contains(equipmentToDeleteRow)) {
                                equipmentToDeleteRow.remove();
                                
                                // Обновляем нумерацию
                                let visibleIndex = 0;
                                getAllEquipmentRows().forEach(row => {
                                    if (row.style.display !== 'none') {
                                        const numberCell = row.querySelector('.number-column');
                                        if (numberCell) {
                                            numberCell.textContent = visibleIndex + 1;
                                        }
                                        visibleIndex++;
                                    }
                                });
                                
                                // Обновляем обработчики строк
                                setupRowHandlers();
                                setupEditableCells();
                                
                                // Применяем чередование цветов после удаления
                                applyEquipmentRowStriping();
                                
                                showEquipmentStatus('Оборудование удалено', 'success');
                            }
                            closeDeleteEquipmentModal();
                        } else {
                            showEquipmentStatus(data.message || 'Не удалось удалить оборудование', 'error');
                            deleteEquipmentConfirm.disabled = false;
                            deleteEquipmentConfirm.textContent = 'Удалить';
                        }
                    } catch (error) {
                        console.error('Ошибка при удалении оборудования:', error);
                        showEquipmentStatus('Произошла ошибка при удалении оборудования', 'error');
                        deleteEquipmentConfirm.disabled = false;
                        deleteEquipmentConfirm.textContent = 'Удалить';
                    }
                });
            }

            // Закрытие по Escape
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (equipmentContextMenu && equipmentContextMenu.style.display === 'block') {
                        hideContextMenu();
                    }
                    if (deleteEquipmentModal && deleteEquipmentModal.classList.contains('visible')) {
                        closeDeleteEquipmentModal();
                    }
                    if (equipmentModal && equipmentModal.classList.contains('visible')) {
                        closeEquipmentModal();
                    }
                }
            });

            // Применяем фильтры при загрузке
            applyEquipmentFilters();
            } catch (error) {
                console.error('Ошибка при инициализации скрипта оборудования:', error);
            }
        })();
    </script>
    {% endif %}

    {% if section == 'equipment_passport' %}
    <script>
        // JavaScript для работы с паспортом оборудования
        (function() {
            'use strict';
            
            try {
                const passportTabs = document.querySelectorAll('.passport-tab');
                const tabPanels = document.querySelectorAll('.tab-panel');
                
                // Обработчик переключения вкладок
                passportTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        // Убираем активное состояние со всех вкладок
                        passportTabs.forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        
                        // Добавляем активное состояние к выбранной вкладке
                        this.classList.add('active');
                        this.setAttribute('aria-selected', 'true');
                        
                        // Скрываем все панели
                        tabPanels.forEach(panel => {
                            panel.classList.remove('active');
                            panel.hidden = true;
                        });
                        
                        // Показываем выбранную панель
                        const targetPanel = document.getElementById(`tab-panel-${targetTab}`);
                        if (targetPanel) {
                            targetPanel.classList.add('active');
                            targetPanel.hidden = false;
                        }
                    });
                });
                
                // Инициализация - активируем первую вкладку, если она еще не активна
                const activeTab = document.querySelector('.passport-tab.active');
                if (activeTab) {
                    const targetTab = activeTab.getAttribute('data-tab');
                    const targetPanel = document.getElementById(`tab-panel-${targetTab}`);
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        targetPanel.hidden = false;
                    }
                }
                
                // Обработка загрузки изображения
                const equipmentImageInput = document.getElementById('equipmentImageInput');
                const equipmentImageContainer = document.getElementById('equipmentImageContainer');
                
                if (equipmentImageInput) {
                    equipmentImageInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // Проверяем тип файла
                        if (!file.type.match('image.*')) {
                            alert('Пожалуйста, выберите изображение');
                            return;
                        }
                        
                        // Проверяем размер файла (макс. 16MB)
                        if (file.size > 16 * 1024 * 1024) {
                            alert('Размер файла не должен превышать 16MB');
                            return;
                        }
                        
                        const equipmentId = equipmentImageInput.getAttribute('data-equipment-id');
                        if (!equipmentId) return;
                        
                        // Создаем FormData для отправки
                        const formData = new FormData();
                        formData.append('image', file);
                        
                        // Показываем индикатор загрузки
                        const container = equipmentImageContainer;
                        const originalContent = container.innerHTML;
                        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; min-height: 400px; color: var(--text-medium);">Загрузка...</div>';
                        container.style.pointerEvents = 'none';
                        
                        // Отправляем файл на сервер
                        fetch(`/admin/equipment/passport/${equipmentId}/upload-image`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Обновляем изображение
                                const imageUrl = `/static/${data.image_path}?t=${new Date().getTime()}`;
                                const placeholder = document.getElementById('equipmentImagePlaceholder');
                                const existingImage = document.getElementById('equipmentImage');
                                
                                if (placeholder) {
                                    placeholder.remove();
                                }
                                
                                if (existingImage) {
                                    existingImage.src = imageUrl;
                                } else {
                                    const img = document.createElement('img');
                                    img.src = imageUrl;
                                    img.alt = 'Изображение оборудования';
                                    img.className = 'equipment-image';
                                    img.id = 'equipmentImage';
                                    container.innerHTML = '';
                                    container.appendChild(img);
                                    container.innerHTML += '<div class="equipment-image-overlay"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><span>Загрузить изображение</span></div>';
                                }
                                
                                // Обновляем страницу через небольшую задержку для обновления кэша
                                setTimeout(() => {
                                    window.location.reload();
                                }, 500);
                            } else {
                                alert(data.message || 'Ошибка при загрузке изображения');
                                container.innerHTML = originalContent;
                            }
                        })
                        .catch(error => {
                            console.error('Ошибка при загрузке изображения:', error);
                            alert('Ошибка при загрузке изображения');
                            container.innerHTML = originalContent;
                        })
                        .finally(() => {
                            container.style.pointerEvents = '';
                            equipmentImageInput.value = ''; // Сбрасываем input
                        });
                    });
                }
                
                // Работа с таблицей истории перемещений
                const movementHistorySearch = document.getElementById('movementHistorySearch');
                const movementHistoryFilterToggle = document.getElementById('movementHistoryFilterToggle');
                const movementHistoryFilterDropdown = document.getElementById('movementHistoryFilterDropdown');
                const movementHistoryTable = document.getElementById('movementHistoryTable');
                const resetMovementHistoryFilters = document.getElementById('resetMovementHistoryFilters');
                const addMovementBtn = document.getElementById('addMovementBtn');
                
                // Функция фильтрации таблицы истории перемещений
                function applyMovementHistoryFilters() {
                    if (!movementHistoryTable) return;
                    
                    const searchTerm = (movementHistorySearch?.value || '').toLowerCase();
                    const rows = movementHistoryTable.querySelectorAll('tbody tr');
                    
                    rows.forEach(row => {
                        if (row.querySelector('td[colspan]')) {
                            return; // Пропускаем строку с сообщением "Нет записей"
                        }
                        
                        const fromLocation = (row.dataset.fromLocation || '').toLowerCase();
                        const toLocation = (row.dataset.toLocation || '').toLowerCase();
                        const moveDate = (row.dataset.moveDate || '').toLowerCase();
                        
                        const matchesSearch = !searchTerm || 
                            fromLocation.includes(searchTerm) || 
                            toLocation.includes(searchTerm) || 
                            moveDate.includes(searchTerm);
                        
                        row.style.display = matchesSearch ? '' : 'none';
                    });
                    
                    // Обновляем нумерацию
                    let visibleIndex = 0;
                    rows.forEach(row => {
                        if (row.style.display !== 'none' && !row.querySelector('td[colspan]')) {
                            const numberCell = row.querySelector('.number-column');
                            if (numberCell) {
                                numberCell.textContent = visibleIndex + 1;
                            }
                            visibleIndex++;
                        }
                    });
                }
                
                // Обработчики для поиска и фильтров
                if (movementHistorySearch) {
                    movementHistorySearch.addEventListener('input', applyMovementHistoryFilters);
                }
                
                if (movementHistoryFilterToggle && movementHistoryFilterDropdown) {
                    movementHistoryFilterToggle.addEventListener('click', () => {
                        const isExpanded = movementHistoryFilterToggle.getAttribute('aria-expanded') === 'true';
                        movementHistoryFilterDropdown.style.display = isExpanded ? 'none' : 'block';
                        movementHistoryFilterToggle.setAttribute('aria-expanded', !isExpanded);
                    });
                }
                
                if (resetMovementHistoryFilters) {
                    resetMovementHistoryFilters.addEventListener('click', () => {
                        if (movementHistorySearch) movementHistorySearch.value = '';
                        applyMovementHistoryFilters();
                    });
                }
                
                if (addMovementBtn) {
                    addMovementBtn.addEventListener('click', () => {
                        // TODO: Открыть модальное окно для добавления перемещения
                        alert('Функция добавления перемещения будет реализована');
                    });
                }
            } catch (error) {
                console.error('Ошибка при инициализации скрипта паспорта оборудования:', error);
            }
        })();
    </script>
    {% endif %}

    {% if section == 'pto' %}
    <script>
        // JavaScript для работы с календарем ПТО
        (function() {
            'use strict';
            
            try {
                const calendarGrid = document.getElementById('ptoCalendarGrid');
                const monthSelect = document.getElementById('ptoMonthSelect');
                const yearSelect = document.getElementById('ptoYearSelect');
                const prevMonthBtn = document.getElementById('ptoPrevMonth');
                const nextMonthBtn = document.getElementById('ptoNextMonth');
                const tableBody = document.getElementById('ptoTableBody');
                const tableDateHeader = document.getElementById('ptoTableDate');
                
                let currentDate = new Date();
                let selectedDate = new Date();
                let maintenanceData = {};
                
                // Инициализация года в селекте
                function initYearSelect() {
                    const currentYear = currentDate.getFullYear();
                    yearSelect.innerHTML = '';
                    for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === currentYear) {
                            option.selected = true;
                        }
                        yearSelect.appendChild(option);
                    }
                }
                
                // Форматирование даты для отображения
                function formatDate(date) {
                    const months = ['Января', 'Февраля', 'Марта', 'Апреля', 'Мая', 'Июня',
                                   'Июля', 'Августа', 'Сентября', 'Октября', 'Ноября', 'Декабря'];
                    return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
                }
                
                // Форматирование даты для API
                function formatDateForAPI(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // Загрузка данных календаря
                async function loadCalendarData() {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth() + 1;
                    
                    try {
                        const response = await fetch(`/admin/pto/api/calendar?year=${year}&month=${month}`);
                        if (!response.ok) {
                            throw new Error('Ошибка загрузки данных');
                        }
                        maintenanceData = await response.json();
                        renderCalendar();
                    } catch (error) {
                        console.error('Ошибка при загрузке данных календаря:', error);
                    }
                }
                
                // Загрузка данных для таблицы
                async function loadTableData(date) {
                    const dateStr = formatDateForAPI(date);
                    
                    try {
                        const response = await fetch(`/admin/pto/api/date?date=${dateStr}`);
                        if (!response.ok) {
                            throw new Error('Ошибка загрузки данных');
                        }
                        const data = await response.json();
                        renderTable(data);
                        tableDateHeader.textContent = formatDate(date);
                    } catch (error) {
                        console.error('Ошибка при загрузке данных таблицы:', error);
                        tableBody.innerHTML = '<tr><td colspan="4" class="pto-table-empty">Ошибка загрузки данных</td></tr>';
                    }
                }
                
                // Отрисовка календаря
                function renderCalendar() {
                    if (!calendarGrid) return;
                    
                    calendarGrid.innerHTML = '';
                    
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    
                    // Первый день месяца
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    
                    // День недели первого дня (0 = воскресенье, нужно преобразовать к 0 = понедельник)
                    let startDay = firstDay.getDay();
                    startDay = startDay === 0 ? 6 : startDay - 1;
                    
                    // Количество дней в месяце
                    const daysInMonth = lastDay.getDate();
                    
                    // Дни предыдущего месяца
                    const prevMonthLastDay = new Date(year, month, 0).getDate();
                    for (let i = startDay - 1; i >= 0; i--) {
                        const day = prevMonthLastDay - i;
                        const date = new Date(year, month - 1, day);
                        const dayElement = createDayElement(date, true);
                        calendarGrid.appendChild(dayElement);
                    }
                    
                    // Дни текущего месяца
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const isToday = date.getTime() === today.getTime();
                        const isSelected = date.getTime() === selectedDate.getTime();
                        const dayElement = createDayElement(date, false, isToday, isSelected);
                        calendarGrid.appendChild(dayElement);
                    }
                    
                    // Дни следующего месяца для заполнения сетки
                    const totalCells = calendarGrid.children.length;
                    const remainingCells = 42 - totalCells; // 6 недель * 7 дней
                    for (let day = 1; day <= remainingCells; day++) {
                        const date = new Date(year, month + 1, day);
                        const dayElement = createDayElement(date, true);
                        calendarGrid.appendChild(dayElement);
                    }
                }
                
                // Создание элемента дня
                function createDayElement(date, isOtherMonth, isToday = false, isSelected = false) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'pto-calendar-day';
                    
                    if (isOtherMonth) {
                        dayElement.classList.add('other-month');
                    }
                    if (isToday) {
                        dayElement.classList.add('today');
                    }
                    if (isSelected) {
                        dayElement.classList.add('selected');
                    }
                    
                    const dateStr = formatDateForAPI(date);
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'pto-day-number';
                    dayNumber.textContent = date.getDate();
                    dayElement.appendChild(dayNumber);
                    
                    // Индикаторы ПТО
                    if (maintenanceData[dateStr] && maintenanceData[dateStr].length > 0) {
                        const indicators = document.createElement('div');
                        indicators.className = 'pto-day-indicators';
                        
                        // Группируем по цветам
                        const grouped = {
                            green: [],
                            red: [],
                            yellow: []
                        };
                        
                        maintenanceData[dateStr].forEach(item => {
                            grouped[item.indicator_color].push(item);
                        });
                        
                        // Создаем индикаторы
                        Object.keys(grouped).forEach(color => {
                            if (grouped[color].length > 0) {
                                const indicator = document.createElement('div');
                                indicator.className = `pto-indicator ${color}`;
                                if (grouped[color].length > 1) {
                                    indicator.classList.add('multiple');
                                    indicator.textContent = grouped[color].length;
                                }
                                indicators.appendChild(indicator);
                            }
                        });
                        
                        dayElement.appendChild(indicators);
                    }
                    
                    // Обработчик двойного клика
                    dayElement.addEventListener('dblclick', () => {
                        if (!isOtherMonth) {
                            selectedDate = new Date(date);
                            loadTableData(selectedDate);
                            renderCalendar(); // Перерисовываем для обновления выделения
                        }
                    });
                    
                    return dayElement;
                }
                
                // Отрисовка таблицы
                function renderTable(data) {
                    if (!tableBody) return;
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="pto-table-empty">На эту дату ПТО не запланировано</td></tr>';
                        return;
                    }
                    
                    tableBody.innerHTML = data.map(item => `
                        <tr>
                            <td>${escapeHtml(item.equipment_name)}</td>
                            <td>${escapeHtml(item.department_name)}</td>
                            <td>${escapeHtml(item.location)}</td>
                            <td>${escapeHtml(item.status)}</td>
                        </tr>
                    `).join('');
                }
                
                // Экранирование HTML
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // Изменение месяца
                function changeMonth(delta) {
                    currentDate.setMonth(currentDate.getMonth() + delta);
                    monthSelect.value = currentDate.getMonth() + 1;
                    yearSelect.value = currentDate.getFullYear();
                    loadCalendarData();
                }
                
                // Обработчики событий
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', () => changeMonth(-1));
                }
                
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', () => changeMonth(1));
                }
                
                if (monthSelect) {
                    monthSelect.addEventListener('change', () => {
                        currentDate.setMonth(parseInt(monthSelect.value) - 1);
                        loadCalendarData();
                    });
                }
                
                if (yearSelect) {
                    yearSelect.addEventListener('change', () => {
                        currentDate.setFullYear(parseInt(yearSelect.value));
                        loadCalendarData();
                    });
                }
                
                // Инициализация
                initYearSelect();
                monthSelect.value = currentDate.getMonth() + 1;
                yearSelect.value = currentDate.getFullYear();
                
                // Загружаем данные для текущего месяца
                loadCalendarData();
                
                // Загружаем данные для сегодняшней даты
                loadTableData(selectedDate);
                
            } catch (error) {
                console.error('Ошибка при инициализации скрипта ПТО:', error);
            }
        })();
    </script>
    {% endif %}

    {% if section == 'tasks' %}
    <script>
        (function() {
            const createTaskBtn = document.getElementById('createTaskBtn');
            const createTaskModal = document.getElementById('createTaskModal');
            const createTaskModalClose = document.getElementById('createTaskModalClose');
            const createTaskModalCancel = document.getElementById('createTaskModalCancel');
            const createTaskForm = document.getElementById('createTaskForm');
            const createTaskFormError = document.getElementById('createTaskFormError');
            const taskRows = document.querySelectorAll('.task-row');
            const taskDetailsModal = document.getElementById('taskDetailsModal');
            const taskDetailsModalClose = document.getElementById('taskDetailsModalClose');
            const taskDetailsModalCancel = document.getElementById('taskDetailsModalCancel');
            const taskStatusToggle = document.getElementById('taskStatusToggle');
            const taskStatusLabel = document.getElementById('taskStatusLabel');
            let currentTaskId = null;

            // Открытие модального окна создания задачи
            if (createTaskBtn) {
                createTaskBtn.addEventListener('click', () => {
                    if (createTaskModal) {
                        createTaskModal.classList.add('visible');
                        createTaskModal.setAttribute('aria-hidden', 'false');
                        document.body.classList.add('modal-open');
                        if (createTaskForm) {
                            createTaskForm.reset();
                        }
                        if (createTaskFormError) {
                            createTaskFormError.textContent = '';
                        }
                    }
                });
            }

            // Закрытие модального окна создания задачи
            [createTaskModalClose, createTaskModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (createTaskModal) {
                            createTaskModal.classList.remove('visible');
                            createTaskModal.setAttribute('aria-hidden', 'true');
                            document.body.classList.remove('modal-open');
                        }
                    });
                }
            });

            // Синхронизация отдела и предприятия
            const taskDepartmentSelect = document.getElementById('taskDepartmentSelect');
            const taskFacilitySelect = document.getElementById('taskFacilitySelect');
            
            if (taskDepartmentSelect && taskFacilitySelect) {
                taskDepartmentSelect.addEventListener('change', () => {
                    const selectedOption = taskDepartmentSelect.options[taskDepartmentSelect.selectedIndex];
                    const facilityId = selectedOption.dataset.facilityId;
                    if (facilityId) {
                        taskFacilitySelect.value = facilityId;
                        // Обновляем кастомную кнопку предприятия
                        const modalTaskFacilityBtn = document.getElementById('modalTaskFacilityBtn');
                        if (modalTaskFacilityBtn) {
                            const label = modalTaskFacilityBtn.querySelector('.modal-select-label');
                            if (label) {
                                label.textContent = taskFacilitySelect.options[taskFacilitySelect.selectedIndex].text;
                            }
                        }
                    }
                });
            }

            // Обработка отправки формы создания задачи
            if (createTaskForm) {
                createTaskForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (createTaskFormError) {
                        createTaskFormError.textContent = '';
                    }

                    const formData = new FormData(createTaskForm);
                    const departmentId = formData.get('department_id');
                    
                    if (!departmentId) {
                        if (createTaskFormError) {
                            createTaskFormError.textContent = 'Выберите отдел';
                        }
                        return;
                    }
                    
                    const data = {
                        department_id: departmentId,
                        heading: formData.get('heading'),
                        repair_task_description: formData.get('repair_task_description'),
                        repair_task_end_date: formData.get('repair_task_end_date') || null
                    };

                    try {
                        const response = await fetch('{{ url_for("admin_tasks.create_task") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (result.success) {
                            location.reload();
                        } else {
                            if (createTaskFormError) {
                                createTaskFormError.textContent = result.message || 'Ошибка при создании задачи';
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка:', error);
                        if (createTaskFormError) {
                            createTaskFormError.textContent = 'Ошибка при создании задачи';
                        }
                    }
                });
            }

            // Двойной клик на задачу для просмотра деталей
            taskRows.forEach(row => {
                row.addEventListener('dblclick', async () => {
                    const taskId = row.dataset.taskId;
                    if (!taskId) return;

                    try {
                        const response = await fetch(`{{ url_for("admin_tasks.get_task", task_id=0) }}`.replace('0', taskId));
                        const result = await response.json();

                        if (result.success && result.task) {
                            const task = result.task;
                            currentTaskId = task.id;

                            // Заполняем поля модального окна
                            document.getElementById('taskDetailsId').value = task.id || '';
                            document.getElementById('taskDetailsHeading').value = task.heading || '';
                            document.getElementById('taskDetailsDescription').value = task.description || '';
                            document.getElementById('taskDetailsEndDate').value = task.end_date || '—';
                            document.getElementById('taskDetailsFacility').value = task.facility_name || '—';

                            // Устанавливаем статус
                            const isCompleted = task.status === 'Завершено';
                            if (taskStatusToggle) {
                                taskStatusToggle.checked = isCompleted;
                            }
                            if (taskStatusLabel) {
                                taskStatusLabel.textContent = isCompleted ? 'Завершено' : 'В процессе';
                            }

                            // Открываем модальное окно
                            if (taskDetailsModal) {
                                taskDetailsModal.classList.add('visible');
                                taskDetailsModal.setAttribute('aria-hidden', 'false');
                                document.body.classList.add('modal-open');
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка при загрузке задачи:', error);
                    }
                });
            });

            // Закрытие модального окна деталей задачи
            [taskDetailsModalClose, taskDetailsModalCancel].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (taskDetailsModal) {
                            taskDetailsModal.classList.remove('visible');
                            taskDetailsModal.setAttribute('aria-hidden', 'true');
                            document.body.classList.remove('modal-open');
                        }
                        currentTaskId = null;
                    });
                }
            });

            // Обработка переключения статуса
            if (taskStatusToggle) {
                taskStatusToggle.addEventListener('change', async () => {
                    if (!currentTaskId) return;

                    const newStatus = taskStatusToggle.checked ? 'Завершено' : 'В процессе';
                    
                    try {
                        const response = await fetch(`{{ url_for("admin_tasks.update_task_status", task_id=0) }}`.replace('0', currentTaskId), {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: newStatus })
                        });

                        const result = await response.json();

                        if (result.success) {
                            if (taskStatusLabel) {
                                taskStatusLabel.textContent = newStatus;
                            }
                            // Если статус "Завершено", перезагружаем страницу, чтобы убрать задачу из списка
                            if (newStatus === 'Завершено') {
                                setTimeout(() => {
                                    location.reload();
                                }, 500);
                            }
                        } else {
                            // Откатываем изменение, если произошла ошибка
                            taskStatusToggle.checked = !taskStatusToggle.checked;
                            if (taskStatusLabel) {
                                taskStatusLabel.textContent = taskStatusToggle.checked ? 'Завершено' : 'В процессе';
                            }
                            alert(result.message || 'Ошибка при обновлении статуса');
                        }
                    } catch (error) {
                        console.error('Ошибка:', error);
                        // Откатываем изменение
                        taskStatusToggle.checked = !taskStatusToggle.checked;
                        if (taskStatusLabel) {
                            taskStatusLabel.textContent = taskStatusToggle.checked ? 'Завершено' : 'В процессе';
                        }
                        alert('Ошибка при обновлении статуса');
                    }
                });
            }

            // Закрытие модальных окон при клике вне их
            [createTaskModal, taskDetailsModal].forEach(modal => {
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('visible');
                            modal.setAttribute('aria-hidden', 'true');
                            document.body.classList.remove('modal-open');
                            if (modal === taskDetailsModal) {
                                currentTaskId = null;
                            }
                        }
                    });
                }
            });
        })();
    </script>
    {% endif %}
</body>
</html>

